<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="black-white">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

    <title>ä¼ è®¯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/png" sizes="192x192" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<link rel="apple-touch-icon" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Êšð‘³ð‘¶ð‘½ð‘¬Éž">
<meta name="mobile-web-app-capable" content="yes">
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0;
        }

:root {
            --primary-bg: #f9f9f9;
            --secondary-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #7a7a7a;
            --border-color: #ebebeb;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #f0f0f0;
            --message-received-text: #1a1a1a; 
            --header-bg: #ffffff;
            --input-area-bg: #ffffff; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-family: 'Noto Serif SC', serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size: 16px;
            --favorite-color: #ffc107;
            --primary-bg-rgb: 249, 249, 249;
            --secondary-bg-rgb: 255, 255, 255;
            --bubble-style: 'standard';
            --message-font-family: 'Noto Serif SC', serif;
            --message-font-weight: 400;
            --message-line-height: 1.5;
            --in-chat-avatar-size: 36px;
        }

:root[data-color-theme="gold"] {
            --accent-color: #c5a47e;
            --accent-color-dark: #d4af37;
            --accent-color-rgb: 197, 164, 126;
        }
:root[data-color-theme="blue"] {
            --accent-color: #7FA6CD;
            --accent-color-dark: #7FA6CD;
            --accent-color-rgb: 127, 166, 205;
        }
:root[data-color-theme="purple"] {
            --accent-color: #BB9EC7;
            --accent-color-dark: #BB9EC7;
            --accent-color-rgb: 187, 158, 199;
        }
:root[data-color-theme="green"] {
            --accent-color: #7BC8A4;
            --accent-color-dark: #7BC8A4;
            --accent-color-rgb: 123, 200, 164;
        }
:root[data-color-theme="pink"] {
            --accent-color: #F4A6B3;
            --accent-color-dark: #F4A6B3;
            --accent-color-rgb: 244, 166, 179;
        }
:root[data-color-theme="black-white"] {
            --accent-color: #333333;
            --accent-color-dark: #D6D6D6;
            --accent-color-rgb: 51, 51, 51;
        }
:root[data-color-theme="pastel"] {
            --accent-color: #A8D8EA;
            --accent-color-dark: #AA96DA;
            --accent-color-rgb: 168, 216, 234;
        }
:root[data-color-theme="sunset"] {
            --accent-color: #FF9A8B;
            --accent-color-dark: #FF6B6B;
            --accent-color-rgb: 255, 154, 139;
        }
:root[data-color-theme="forest"] {
            --accent-color: #7BA05B;
            --accent-color-dark: #556B2F;
            --accent-color-rgb: 123, 160, 91;
        }
:root[data-color-theme="ocean"] {
            --accent-color: #4A90E2;
            --accent-color-dark: #2E5B9A;
            --accent-color-rgb: 74, 144, 226;
        }

        html[data-theme="dark"] {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-primary: #e5e5e5;
            --text-secondary: #8c8c8c;
            --border-color: #2f2f2f;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #2a2a2a;
            --message-received-text: #e5e5e5; 
            --header-bg: #1e1e1e; 
            --input-area-bg: #1e1e1e; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --favorite-color: #ffd700;

            --primary-bg-rgb: 18, 18, 18;
            --secondary-bg-rgb: 30, 30, 30;
        }

        html[data-theme="dark"][data-color-theme="black-white"] .message-sent {
            color: #121212 !important;
        }

        html[data-theme="dark"][data-color-theme="gold"] .message-sent,
        html[data-theme="dark"][data-color-theme="blue"] .message-sent,
        html[data-theme="dark"][data-color-theme="purple"] .message-sent,
        html[data-theme="dark"][data-color-theme="green"] .message-sent,
        html[data-theme="dark"][data-color-theme="pink"] .message-sent,
        html[data-theme="dark"][data-color-theme="pastel"] .message-sent,
        html[data-theme="dark"][data-color-theme="sunset"] .message-sent,
        html[data-theme="dark"][data-color-theme="forest"] .message-sent,
        html[data-theme="dark"][data-color-theme="ocean"] .message-sent {
            color: #121212;
        }

        .message.rounded {
            border-radius: var(--radius);
        }
        .message.rounded-large {
            border-radius: 24px;
        }
        .message.square {
            border-radius: 8px;
        }
        .message.rounded-sent {
            border-radius: var(--radius) var(--radius) 6px var(--radius);
        }
        .message.rounded-received {
            border-radius: var(--radius) var(--radius) var(--radius) 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
            font-family: var(--font-family);
            font-weight: 400;
            position: relative;

            font-size: var(--font-size);
            opacity: 0;
            animation: delayedShow 0.8s ease 0.2s forwards;
        }
@keyframes delayedShow {
            to {
                opacity: 1;
            }
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background-color: var(--primary-bg);
            background-image: var(--chat-bg-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
        }

        .header {
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            box-shadow: var(--shadow);
            z-index: 10;
            flex-shrink: 0;
            position: relative;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 650px;
            margin: 0 auto;
            padding: 15px 5px;
            width: 100%;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border: 2px solid transparent;
            transition: var(--transition);
            order: 2;
        }
      .header-motto {
position: absolute;
top: 6px;
left: 50%;
transform: translateX(-50%);
z-index: 20;
padding: 6px 28px;
max-width: 80%;
width: auto;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
font-size: 13px;
font-family: 'Inter', 'Noto Serif SC', 'Cormorant Garamond', serif, -apple-system, BlinkMacSystemFont, sans-serif;
font-weight: 350;
letter-spacing: 2.5px;
font-style: normal;
text-transform: uppercase;
color: var(--accent-color);
background: transparent;
border: none;
border-radius: 0;
box-shadow: none;
transition: all 0.5s cubic-bezier(0.25, 0.1, 0.15, 1);
display: flex;
align-items: center;
justify-content: center;
gap: 16px;
opacity: 0.85;
mix-blend-mode: normal;
backdrop-filter: none;
-webkit-backdrop-filter: none;
animation: none;
text-rendering: optimizeLegibility;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
}

.header-motto::before,
.header-motto::after {
content: "";
width: 32px;
height: 1.5px;
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.35;
transition: all 0.5s cubic-bezier(0.25, 0.1, 0.15, 1);
transform-origin: center;
}

.header-motto::before {
margin-right: 10px;
}

.header-motto::after {
margin-left: 10px;
}

.header-motto:hover {
letter-spacing: 4px;
opacity: 1;
cursor: default;
transform: translateX(-50%) scale(1.02);
}

.header-motto:hover::before,
.header-motto:hover::after {
width: 52px;
opacity: 0.8;
background: linear-gradient(90deg, transparent, var(--accent-color), var(--accent-color), transparent);
}

html[data-theme="dark"] .header-motto {
color: var(--accent-color);
opacity: 0.9;
text-shadow: 0 0 20px rgba(var(--accent-color-rgb), 0.3);
font-weight: 300;
backdrop-filter: blur(2px);
-webkit-backdrop-filter: blur(2px);
}

html[data-theme="dark"] .header-motto::before,
html[data-theme="dark"] .header-motto::after {
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.3;
box-shadow: 0 0 10px rgba(var(--accent-color-rgb), 0.2);
}

html[data-theme="dark"] .header-motto:hover {
text-shadow: 0 0 35px rgba(var(--accent-color-rgb), 0.6);
backdrop-filter: blur(4px);
-webkit-backdrop-filter: blur(4px);
}

html[data-theme="dark"] .header-motto:hover::before,
html[data-theme="dark"] .header-motto:hover::after {
opacity: 0.7;
background: linear-gradient(90deg, transparent, var(--accent-color), var(--accent-color), transparent);
box-shadow: 0 0 20px rgba(var(--accent-color-rgb), 0.4);
}

@media (max-width: 480px) {
.header-motto {
top: 4px;
padding: 4px 18px;
font-size: 11px;
letter-spacing: 2px;
max-width: 70%;
gap: 10px;
}
.header-motto::before,
.header-motto::after {
    width: 18px;
    height: 1px;
}

.header-motto:hover::before,
.header-motto:hover::after {
    width: 30px;
}

html[data-theme="dark"] .header-motto {
    backdrop-filter: blur(1px);
    -webkit-backdrop-filter: blur(1px);
}

}
        

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        html[data-theme="dark"] .avatar:hover {
            border-color: var(--accent-color-dark);
        }
        .avatar > img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .username {
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            order: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }
        .username:hover {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .username:hover {
            color: var(--accent-color-dark);
        }
        .status {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            order: 3;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .status:hover {
            background-color: var(--message-received-bg);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: var(--transition);
        }
        .action-btn:hover {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            transform: rotate(15deg) scale(1.1);
        }

        .main-chat-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: background-color 0.5s ease;
            background-color: transparent;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
            width: 0;
        }

        
        .message-wrapper {
            display: flex;
            max-width: 85%;
            margin-bottom: 12px;
            animation: messageAppear 0.4s ease-out forwards;
            opacity: 0;
            position: relative;
            gap: 10px;
            align-items: flex-start;
        }
        .message-avatar {
            width: var(--in-chat-avatar-size);
            height: var(--in-chat-avatar-size);
            border-radius: 50%;
            flex-shrink: 0;
            background-color: var(--border-color);
            transition: all 0.3s ease;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .message-avatar.hidden {
            visibility: hidden;
        }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

@keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(0) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-wrapper.sent .message-content-wrapper {
            align-items: flex-end;
        }
        .message-wrapper.received {
            align-self: flex-start;
            flex-direction: row;
        }
        .message-wrapper.received .message-content-wrapper {
            align-items: flex-start;
        }

        .message {
            padding: 12px 18px;
            border-radius: var(--radius);
            word-wrap: break-word;
            line-height: var(--message-line-height);
            box-shadow: var(--shadow);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            position: relative;
            overflow: hidden;
            min-width: 50px;
            font-family: var(--message-font-family);
            font-weight: var(--message-font-weight);
        }

        .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
            border-bottom-right-radius: 6px;
        }
        html[data-theme="dark"] .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .message-received {
            background-color: var(--message-received-bg);
            color: var(--message-received-text, var(--text-primary));
            border-bottom-left-radius: 6px;
        }

        .message-meta {
            display: flex;
            align-items: center; 
            gap: 8px;
            margin: 6px 10px 0 10px;
            opacity: 0.7;
            font-size: 11px;
            color: var(--text-secondary);
            position: relative;
            height: 20px; 
        }
        .message-meta-actions {
            position: absolute;
            top: -12px;
            background-color: var(--secondary-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            padding: 4px 6px;
            opacity: 0;
            transform: translateY(5px);
            transition: var(--transition);
            z-index: 2;
        }
        .message-content-wrapper:hover .message-meta-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-wrapper.sent .message-meta-actions {
            left: -20px;
        }
        .message-wrapper.received .message-meta-actions {
            right: -20px;
        }

        .meta-action-btn {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none; 
            border: none;   
        }
        
        .meta-action-btn:hover {
            transform: scale(1.2);
            color: var(--text-primary);
            background-color: var(--border-color);
        }
.meta-action-btn.delete-btn:hover {
    color: #ff4757 !important; 
    background-color: rgba(255, 71, 87, 0.1);
}

        .meta-action-btn.favorited {
            color: #ffc107 !important; 
        }
        

        .timestamp {
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .read-receipt {
            font-size: 12px;
        }
        .read-receipt.read {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .read-receipt.read {
            color: var(--accent-color-dark);
        }

        .input-area-wrapper {
            flex-shrink: 0;
            background-color: var(--input-area-bg);
            transition: background-color 0.5s ease;
        }
        .input-area {
            display: flex;
            padding: 12px 15px;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            transition: border-color 0.5s ease;
        }
        .message-input {
            flex: 1;
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 12px 18px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 46px;
            transition: var(--transition);
            font-weight: 500;
            font-family: var(--font-family);
            font-size: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-input:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }
        html[data-theme="dark"] .message-input:focus {
            border-color: var(--accent-color-dark);
        }

        .input-buttons {
            display: flex;
            gap: 8px;
        }
        .input-btn {
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .input-btn:hover {
            transform: scale(1.08) rotate(5deg);
            filter: brightness(1.1);
        }

        .send-btn, .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .send-btn, html[data-theme="dark"] .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .coin-btn, .batch-btn, .continue-btn, .attachment-btn, .poke-btn {
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
        }
        .attachment-btn:hover, .continue-btn:hover, .batch-btn:hover, .coin-btn:hover, .poke-btn:hover {
            color: var(--text-primary);
        }

        #reply-preview-container {
            padding: 0 15px;
        }
        .reply-preview {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
            border-left: 3px solid var(--accent-color);
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .reply-preview-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .reply-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .reply-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .reply-indicator {
            font-style: italic;
            opacity: 0.8;
            border-left: 2px solid var(--accent-color);
            padding: 6px 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            background-color: rgba(var(--primary-bg-rgb), 0.6);
            border-radius: 8px;
        }

        .message-wrapper.sent .reply-indicator {
            background-color: rgba(255, 255, 255, 0.2);
            color: inherit;
            border-left-color: rgba(255, 255, 255, 0.5);
        }
        html[data-theme="dark"] .message-wrapper.sent .reply-indicator {
            background-color: rgba(0, 0, 0, 0.15);
            color: inherit;
            border-left-color: rgba(0, 0, 0, 0.4);
        }
        .modal-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .modal {
            z-index: 2000 !important;
        }

        .modal-content {
            z-index: 2001 !important;
        }

        .message-note {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
        }
        html[data-theme="dark"] .message-note {
            color: var(--text-primary);
        }

        .system-message {
            align-self: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 15px;
            margin: 10px 0;
            box-shadow: none;
        }

        body.with-background .header,
        body.with-background .input-area-wrapper {
            background-color: rgba(var(--secondary-bg-rgb), 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        body.with-background .input-area {
            border-top-color: transparent;
        }
        body.with-background .message-received {
            background-color: rgba(var(--secondary-bg-rgb), 0.95);
        }
        body.with-background .message-input {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
        }
        body.with-background .message-input:focus {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
        }
        body.with-background .batch-preview {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.with-background .message-meta {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: modalBgFadeIn 0.3s ease;
        }
@keyframes modalBgFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalContentSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transition: background-color 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            display: flex;
            flex-direction: column;
        }
        .modal-content::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes modalContentSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.5s ease;
            flex-shrink: 0;
        }
        .modal-title i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .modal-title i {
            color: var(--accent-color-dark);
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }
        html[data-theme="dark"] .modal-input:focus, html[data-theme="dark"] .modal-textarea:focus {
            border-color: var(--accent-color-dark);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .modal-btn-primary {
            background-color: var(--accent-color-dark);
        }
        .modal-btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .modal-btn-secondary {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
        .modal-btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }

        .file-input {
            display: none;
        }
        .typing-indicator, .empty-state {
            position: absolute;
            left: 20px;
            bottom: 20px;
            z-index: 5;
        }
        .empty-state {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
            width: 100%;
            transition: color 0.5s ease;
        }
        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }
        .empty-state p {
            font-size: 16px;
            font-weight: 500;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: var(--message-received-bg);
            padding: 12px 16px;
            border-radius: var(--radius);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
            display: none;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }
        .typing-dots {
            display: flex;
            gap: 5px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
@keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .settings-item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

#appearance-modal .settings-item-list {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
}

#appearance-modal .settings-item {
    display: flex;
    align-items: center;
    justify-content: center; 
    padding: 15px;
    width: 100%;
    margin-bottom: 0; 
    flex-direction: column; 
    gap: 8px;
    text-align: center;
}

#appearance-modal .settings-item i {
    font-size: 20px;
    width: auto;
    height: auto;
    background: none;
    margin: 0;
}

#appearance-modal .settings-item::after {
    display: none;
}

        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background-color: var(--primary-bg);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            position: relative;
        }


        .settings-item:hover {
            background-color: var(--secondary-bg);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }


        .settings-item i {
            font-size: 18px;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .settings-item:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1);
        }


        .settings-item span {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }


        .settings-item::after {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0.5;
            transition: transform 0.3s ease;
        }

        .settings-item:hover::after {
            transform: translateX(3px);
            opacity: 0.8;
            color: var(--accent-color);
        }


        #advanced-modal .settings-item-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        #advanced-modal .settings-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 10px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        #advanced-modal .settings-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            z-index: 1;
        }


        #advanced-modal .settings-item i {
            width: 56px;
            height: 56px;
            font-size: 24px;
            border-radius: 20px;
            margin-bottom: 4px;
        }


        #advanced-modal .settings-item::after {
            display: none;
        }

        #appearance-modal .settings-item-list {
            gap: 8px;
        }


        .import-export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }
        .import-export-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid transparent;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .import-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .import-export-btn.export {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            border-color: rgba(var(--accent-color-rgb), 0.2);
        }
        .import-export-btn.export:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .settings-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }

        #my-status-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font-family);
            text-align: center;
            padding: 2px 6px;
            width: 100px;
        }


:root {
            --welcome-bg: #f0f2f5;
            --welcome-text-main: #2c3e50;
            --welcome-text-sub: #7f8c8d;
            --welcome-star: #bdc3c7;
            --welcome-circle-outer: rgba(0, 0, 0, 0.1);
            --welcome-loader-bg: rgba(0, 0, 0, 0.1);
        }

        html[data-theme="dark"] {

            --welcome-bg: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            --welcome-text-main: #ffffff;
            --welcome-text-sub: var(--accent-color);
            --welcome-star: #ffffff;
            --welcome-circle-outer: rgba(255, 255, 255, 0.1);
            --welcome-loader-bg: rgba(255, 255, 255, 0.1);
        }

        .welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            background: var(--welcome-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            transition: all 0.8s cubic-bezier(0.7, 0, 0.3, 1);
        }

        .welcome-animation.hidden {
            opacity: 0;
            transform: scale(1.1);
            filter: blur(20px);
            pointer-events: none;
        }


        .stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: var(--welcome-star);
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }

@keyframes twinkle {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        .welcome-content-wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }


        .logo-tech-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon-main {
            font-size: 48px;
            color: var(--accent-color);
            z-index: 5;
            filter: drop-shadow(0 0 15px rgba(var(--accent-color-rgb), 0.6));
            animation: floatIcon 3s ease-in-out infinite;
        }

        .logo-circle-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px solid var(--welcome-circle-outer);
            border-radius: 50%;
            animation: pulseRing 2s infinite;
        }

        .logo-circle-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border: 1px dashed rgba(var(--accent-color-rgb), 0.4);
            border-radius: 50%;
            animation: rotateCircle 10s linear infinite;
        }

        .orbit-dot {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: rotateCircle 3s linear infinite;
        }

        .orbit-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 6px;
            height: 6px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--accent-color);
        }


        .text-tech-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 80px;
        }


        .welcome-title-glitch {
            font-family: 'Noto Serif SC', serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            position: relative;


            opacity: 1;


            transition: color 0.5s ease;
        }


        .welcome-title-glitch.playing {
            opacity: 0;
            animation: cinematicFadeIn 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }


        html[data-theme="light"] .welcome-title-glitch {
            color: #2c3e50;
            text-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }


        html[data-theme="dark"] .welcome-title-glitch,
        .welcome-title-glitch {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        }


@keyframes cinematicFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(8px);
                letter-spacing: 0px;
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                letter-spacing: 6px;
            }
        }

        .title-cinematic-enter {
            animation: cinematicIn 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

@keyframes cinematicIn {
            0% {
                opacity: 0;
                letter-spacing: 15px;
                filter: blur(12px);
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                letter-spacing: 4px;
                filter: blur(0);
                transform: scale(1);
            }
        }


        .welcome-subtitle-scramble {
            font-family: monospace;
            font-size: 12px;
            color: var(--welcome-text-sub);
            letter-spacing: 2px;
            opacity: 0.8;
            text-transform: uppercase;
            min-height: 18px;
        }


        .loader-tech {
            width: 160px;
            height: 2px;
            background: var(--welcome-loader-bg);
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }

        .loader-tech-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transition: width 0.2s linear;
        }

@keyframes floatIcon {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

@keyframes rotateCircle {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

@keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
                border-color: rgba(var(--accent-color-rgb), 0.5);
            }
            100% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
        }

@keyframes breath {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.2;
            }
        }
@keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
@keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
        }
@keyframes blink-caret {
            from, to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent-color);
            }
        }

        .batch-preview {
            position: absolute;
            bottom: 85px;
            left: 15px;
            right: 15px;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            z-index: 5;
            transition: all 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            animation: batchPreviewSlideUp 0.3s ease;
        }
        .batch-preview::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes batchPreviewSlideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .batch-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            font-size: 14px;
            transition: background-color 0.5s ease, opacity 0.3s ease;
            user-select: none;
            animation: batchItemAppear 0.2s ease;
        }
@keyframes batchItemAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .batch-preview-text {
            flex-grow: 1;
            cursor: text;
            margin-right: 10px;
        }
        .batch-preview-input {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            border-bottom: 1px solid var(--accent-color);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }
        .batch-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .batch-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }
        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .batch-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .batch-send-btn {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .batch-send-btn {
            background-color: var(--accent-color-dark);
        }
        .batch-cancel-btn {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
.appearance-group {
    display: flex;
    gap: 15px;
    align-items: stretch; 
    margin-bottom: 20px;
}

.theme-editor-entry-btn {
    flex: 1;
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    border-radius: 16px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--message-sent-text);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
    border: none;
    text-align: center;
}

.theme-editor-entry-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(var(--accent-color-rgb), 0.4);
}

.theme-editor-entry-btn i {
    font-size: 24px;
    margin-bottom: 8px;
}

.theme-editor-entry-btn span {
    font-size: 13px;
    font-weight: 600;
}

.preset-colors-container {
    flex: 2;
    background-color: var(--primary-bg);
    border-radius: 16px;
    padding: 15px;
    border: 1px solid var(--border-color);
}

.preset-colors-title {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}

        .theme-picker {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(28px, 1fr)); 
    gap: 8px;
    margin-bottom: 0; 
}


@media (max-width: 480px) {
    .appearance-group {
        flex-direction: column; 
    }
    .theme-editor-entry-btn {
        flex-direction: row;
        gap: 10px;
        padding: 12px;
    }
    .theme-editor-entry-btn i {
        font-size: 18px;
        margin-bottom: 0;
    }
}
        .theme-picker-label {
            font-weight: 500;
            font-size: 14px;
        }
        .theme-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .theme-color-btn:hover {
            transform: scale(1.1);
        }
        .theme-color-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }
        #theme-gold {
            background-color: #c5a47e;
        }
        #theme-blue {
            background-color: #7FA6CD;
        }
        #theme-purple {
            background-color: #BB9EC7;
        }
        #theme-green {
            background-color: #7BC8A4;
        }
        #theme-pink {
            background-color: #F4A6B3;
        }
        #theme-black-white {
            background: linear-gradient(135deg, #000000 50%, #ffffff 50%);
        }
        #theme-pastel {
            background: linear-gradient(135deg, #A8D8EA, #AA96DA);
        }
        #theme-sunset {
            background: linear-gradient(135deg, #FF9A8B, #FF6B6B);
        }
        #theme-forest {
            background: linear-gradient(135deg, #7BA05B, #556B2F);
        }
        #theme-ocean {
            background: linear-gradient(135deg, #4A90E2, #2E5B9A);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .font-size-label {
            font-weight: 500;
            font-size: 14px;
        }
        .font-size-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--message-received-bg);
            outline: none;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .font-size-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .font-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }
        .font-size-value {
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        html[data-theme="dark"] .settings-section-title {
            color: var(--accent-color-dark);
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10001 !important;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: notificationSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid var(--accent-color);
        }
@keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .notification.hiding {
            animation: notificationSlideOut 0.4s ease-in forwards;
        }
@keyframes notificationSlideOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
        .notification i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .notification i {
            color: var(--accent-color-dark);
        }

        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .import-export-btn {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-family);
        }
        .import-export-btn:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        .import-export-btn.export {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .import-export-btn.export {
            background-color: var(--accent-color-dark);
        }

        .date-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }
        .date-divider::before, .date-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--border-color);
        }
        .date-divider span {
            padding: 0 12px;
        }


        .coin-toss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .coin-toss-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .coin-container {
            perspective: 1200px;
            margin-bottom: 40px;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.2));
        }

        .coin {
            width: 180px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            border-radius: 50%;
        }

        .coin.flipping-heads {
            animation: flip-coin-heads 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .coin.flipping-tails {
            animation: flip-coin-tails 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Serif SC', serif;
            border: 8px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .coin-front {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: #333;
            transform: rotateY(0deg);
        }
        .coin-front::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #bdc3c7;
            border-radius: 50%;
        }

        .coin-back {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: #fdfbfb;
            transform: rotateY(180deg);
        }
        .coin-back::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #7f8c8d;
            border-radius: 50%;
        }

        .coin-text-main {
            font-size: 48px;
            font-weight: 400;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }
        .coin-text-sub {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            font-family: sans-serif;
        }


        .coin-result-container {
            min-height: 60px;
            display: flex;
            justify-content: center;
        }

        .coin-result-text {
            font-family: 'Noto Serif SC', serif;
            font-size: 15px;
            color: #fff;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 3px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin-top: 20px;
            text-align: center;
        }


        .coin-toss-overlay.finished .coin-result-text {
            font-size: 28px;
            opacity: 1;
            font-weight: 500;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }


        .coin-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;

            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;


            transition: opacity 0.3s ease, transform 0.3s ease;
        }


        .coin-toss-overlay.finished .coin-confirm-buttons {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;

            transition-delay: 0.3s;
        }

        .coin-btn-action {
            padding: 10px 24px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            backdrop-filter: blur(5px);
        }
        .coin-btn-action:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            transform: translateY(-2px);
        }

        .coin-btn-primary {
            background: #fff;
            color: #000;
            border-color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .coin-btn-primary:hover {
            background: #f0f0f0;
            box-shadow: 0 6px 20px rgba(255,255,255,0.3);
            transform: translateY(-2px) scale(1.02);
        }

@keyframes flip-coin-heads {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2160deg) scale(1);
            }
        }

@keyframes flip-coin-tails {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2340deg) scale(1);
            }
        }

        .settings-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .settings-footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .settings-footer a:hover {
            text-decoration: underline;
        }

        #session-modal .modal-content {
            max-width: 500px;
        }
        .session-list {
            flex: 1;
            overflow-y: auto;
            margin: 0 -10px;
            padding: 0 10px;
            max-height: 50vh;
        }
        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .session-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }
        .session-item.active {
            border-color: var(--accent-color);
            background-color: rgba(var(--accent-color-rgb), 0.1);
            font-weight: 600;
        }
        .session-info {
            cursor: pointer;
            flex-grow: 1;
        }
        .session-name {
            font-size: 15px;
        }
        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }
        .session-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .session-action-btn:hover {
            color: var(--text-primary);
            background-color: var(--border-color);
            transform: scale(1.1);
        }
        .session-action-btn.delete:hover {
            color: #e53935;
        }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }

        .pagination-btn {
            background-color: var(--message-received-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }


        .fortune-card.tarot-style {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }


        .fortune-card.tarot-style::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            pointer-events: none;
        }


        .tarot-header {
            padding: 20px 0 10px;
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }


        .tarot-visual {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            position: relative;
        }


        .tarot-icon-vector {
            font-size: 64px;
            color: var(--text-primary);
            opacity: 0.8;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }


        .tarot-visual.reversed .tarot-icon-vector {
            transform: rotate(180deg);
            opacity: 0.6;
        }


        .tarot-card-name {
            font-family: var(--font-family);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }


        .tarot-position-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .tarot-position-badge.reversed {
            color: #e57373;
            background-color: rgba(229, 115, 115, 0.1);
            border-color: rgba(229, 115, 115, 0.2);
        }


        .tarot-details {
            padding: 0 30px 30px;
            position: relative;
            z-index: 2;
        }

        .tarot-divider {
            height: 1px;
            width: 40px;
            background-color: var(--accent-color);
            margin: 0 auto 15px;
        }

        .tarot-keyword {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .fortune-desc {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            font-style: italic;
        }

        .fortune-tip {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }


        .fortune-card {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
@keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .batch-favorite-mode .message-wrapper {
            cursor: pointer;
        }

        .batch-favorite-mode .message-wrapper:hover .message {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .batch-favorite-mode .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px var(--favorite-color);
        }


        
        .fav-card {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .fav-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
        .fav-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .fav-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fav-sender-name {
            font-weight: 600;
            color: var(--accent-color);
        }
        .fav-bubble {
            background-color: var(--secondary-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border-top-left-radius: 2px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.03);
            word-break: break-all;
        }
        .fav-bubble img {
            max-width: 100%;
            border-radius: 6px;
            display: block;
            margin-top: 5px;
        }
        .fav-action-btn {
            align-self: flex-end;
            font-size: 11px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 4px;
            opacity: 0.6;
            transition: 0.2s;
        }
        .fav-action-btn:hover {
            color: #e53935;
            opacity: 1;
            text-decoration: underline;
        }

        .no-favorites {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .no-favorites i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--border-color);
        }


        .batch-favorite-checkbox {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            background-color: var(--secondary-bg);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }
        .batch-favorite-checkbox.checked {
            background-color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
        }
        .batch-favorite-checkbox.checked::after {
            content: "âœ“";
            font-weight: 900;
            color: #fff;
            font-size: 12px;
        }

        .batch-favorite-mode .message-wrapper {
            transform: translateX(30px);
            transition: transform 0.3s ease;
        }

        .batch-favorite-mode .message-wrapper .batch-favorite-checkbox {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px #ffc107, 0 4px 12px rgba(255, 193, 7, 0.2);
            transform: scale(1.02);
        }

        .batch-favorite-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(128,128,128,0.2);
            border-radius: 50px;
            padding: 8px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 2002;
            animation: floatUpAction 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
@keyframes floatUpAction {
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        .batch-action-btn-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-family);
        }
        .batch-btn-confirm {
            background-color: #ffc107;
            color: #fff;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
        }
        .batch-btn-confirm:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .batch-btn-cancel {
            background-color: transparent;
            color: var(--text-primary);
        }
        .batch-btn-cancel:hover {
            background-color: var(--border-color);
        }



        #custom-replies-modal .modal-content {
            background-color: var(--primary-bg);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            padding: 0;
            height: 90vh; 
            max-height: 90vh; 
        }


        #custom-replies-modal .modal-title {
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            font-size: 18px;
            border-bottom: none;
            flex-shrink: 0; 
        }


        .reply-tabs {
            display: flex;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
        }

        .reply-tab-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 20px;

            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .reply-tab-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .reply-tab-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
            transform: translateY(-1px);
        }


        .reply-toolbar {
            padding: 15px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--primary-bg);
            flex-shrink: 0; 
        }

        .reply-search {
            flex: 1;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .reply-search:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.15);
            transform: translateY(-1px);
        }

        .reply-tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .reply-tool-btn:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.2);
        }

        .custom-replies-list {
            padding: 10px 20px;
            gap: 12px;
            background-color: var(--primary-bg);
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .reply-list-with-buttons {
            padding-bottom: 90px !important; 
        }

        .custom-reply-item {
            background-color: var(--secondary-bg);
            border-radius: 16px;

            padding: 16px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .custom-reply-item:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
.custom-reply-text {
    flex: 1;
    white-space: normal; 
    word-break: break-all; 
    line-height: 1.4;
    padding-right: 10px;
    font-size: 14px;
}


        .custom-reply-item.disabled {
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border-style: dashed;
            opacity: 0.7;
        }
        .custom-reply-item.disabled .custom-reply-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }


        .custom-reply-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .reply-action-mini {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background-color: var(--primary-bg);

            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }


        .reply-action-mini.edit-reply:hover,
        .reply-action-mini.modify-default:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: rotate(10deg);
        }


        .reply-action-mini.delete-reply:hover {
            background-color: #ff4757;
            color: white;
            transform: rotate(-10deg);
        }


        .reply-action-mini.toggle-default:hover {
            background-color: var(--text-secondary);
            color: var(--secondary-bg);
        }

        #custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background-color: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    z-index: 100;
    margin-top: 0;
    flex-shrink: 0;
}

        #add-custom-reply {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            color: var(--message-sent-text);
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #add-custom-reply:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4);
        }


        html[data-theme="dark"] .custom-reply-item {
            background-color: rgba(255,255,255,0.03);
        }
        html[data-theme="dark"] .reply-action-mini {
            background-color: rgba(255,255,255,0.08);
        }


        .stats-dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px 0;
        }


        .stats-card {
            background-color: var(--primary-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }


        .stats-overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background-color: var(--secondary-bg);
            border-radius: 12px;
            text-align: center;
            border: 1px solid transparent;
        }

        .overview-item:hover {
            border-color: var(--border-color);
            background-color: var(--primary-bg);
        }

        .overview-value {
            font-family: 'Georgia', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }

        .overview-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }


        .stats-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rank-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            min-height: 44px;
        }


        .rank-progress-bg {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(var(--accent-color-rgb), 0.12);
            z-index: 0;
            border-radius: 8px;
            transition: width 0.6s ease;
        }


        .rank-info {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }

        .rank-number {
            width: 24px;
            font-weight: 800;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.5;
            flex-shrink: 0;
            text-align: center;
            font-size: 14px;
        }

        .rank-item:nth-child(1) .rank-number {
            color: #FFD700;
            opacity: 1;
            text-shadow: 0 1px 0 rgba(0,0,0,0.1);
            font-size: 16px;
        }
        .rank-item:nth-child(2) .rank-number {
            color: #9EA1A3;
            opacity: 1;
            font-size: 15px;
        }
        .rank-item:nth-child(3) .rank-number {
            color: #CD7F32;
            opacity: 1;
            font-size: 15px;
        }


        .rank-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            white-space: normal;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .rank-count {
            flex-shrink: 0;
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 700;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            min-width: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .rank-count small {
            font-size: 9px;
            opacity: 0.7;
            font-weight: normal;
            margin-top: 2px;
        }

        .stats-empty-state {
            text-align: center;
            padding: 30px 10px;
            color: var(--text-secondary);
        }

        #stats-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            padding: 20px;
            overflow: hidden;
        }

        #stats-modal .modal-title {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        #stats-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
            margin-bottom: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #stats-content::-webkit-scrollbar {
            display: none;
        }

        #stats-modal .modal-buttons {
            flex-shrink: 0;
            margin-top: 0;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }
        
        

#anniversary-modal .modal-content {
    padding: 0;
    background-color: var(--primary-bg);
    display: flex;
    flex-direction: column;
    height: 80vh; 
    max-height: 80vh;
    overflow: hidden;
    position: relative;
}

.ann-header-card {
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    color: var(--message-sent-text);
    padding: 30px 20px;
    text-align: center;
    flex-shrink: 0;
    box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
    z-index: 5;
    position: relative;
}

.ann-header-title {
    font-size: 14px;
    opacity: 0.9;
    letter-spacing: 1px;
    margin-bottom: 5px;
}

.ann-header-days {
    font-size: 48px;
    font-weight: 700;
    font-family: 'Georgia', serif;
    margin: 5px 0;
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.ann-header-date {
    font-size: 12px;
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
    backdrop-filter: blur(5px);
}

.ann-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ann-item-card {
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    position: relative;
    overflow: hidden;
}

.ann-item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    border-color: var(--accent-color);
}

.ann-item-card.type-past { border-left: 4px solid #ff9a9e; }
.ann-item-card.type-future { border-left: 4px solid #764ba2; }

.ann-item-left {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ann-item-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
}

.ann-item-date {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.ann-tag {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 4px;
    background: var(--primary-bg);
    border: 1px solid var(--border-color);
}

.ann-item-right {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.ann-item-days {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-color);
    font-family: var(--font-family);
}

.ann-item-days span {
    font-size: 10px;
    font-weight: normal;
    color: var(--text-secondary);
    margin-left: 2px;
}

.ann-delete-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0,0,0,0.05);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 12px;
    margin-left: 10px;
    transition: all 0.2s;
}

.ann-delete-btn:hover {
    background: #ff4757;
    color: white;
}

.ann-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    opacity: 0.6;
}

.ann-footer {
    padding: 15px 20px;
    background-color: var(--secondary-bg);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    z-index: 10;
}

.ann-editor-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--secondary-bg);
    z-index: 20;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.ann-editor-slide.active {
    transform: translateY(0);
}

.ann-editor-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
}

.ann-back-btn {
    background: none;
    border: none;
    font-size: 18px;
    margin-right: 15px;
    color: var(--text-primary);
    cursor: pointer;
}

.ann-editor-content {
    padding: 20px;
    flex: 1;
}

.ann-form-group {
    margin-bottom: 20px;
}

.ann-label {
    display: block;
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    font-weight: 500;
}

.ann-type-selector {
    display: flex;
    gap: 10px;
}

.ann-type-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    background: var(--primary-bg);
    color: var(--text-primary);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    transition: all 0.2s;
}

.ann-type-btn.active {
    background: var(--accent-color);
    color: var(--message-sent-text);
    border-color: var(--accent-color);
    box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.3);
}

@media (max-width: 768px) {
    .message-input, 
    .modal-input, 
    .modal-textarea,
    .reply-search,
    #my-status-input {
        font-size: 16px !important; 
    }
    .user-info {
        min-width: 45px;
    }
    .avatar {
        width: 48px;
        height: 48px;
    }
    .username {
        font-size: 12px;
        max-width: 55px;
    }
    .status {
        font-size: 10px;
    }
    .header-motto {
        font-size: 9px;
        top: 5px;
    }
    .header-actions {
        gap: 6px;
    }
    .action-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
    .chat-container {
        padding: 20px 10px;
    }
    .message-wrapper {
        max-width: 90%;
    }
    .input-area {
        padding: 10px 12px;
        gap: 8px;
    }
    .input-btn {
        width: 42px;
        height: 42px;
    }
    .message-input {
        min-height: 42px;
        padding: 10px 16px;
    }
    .modal-content {
        width: 95%;
        max-width: none;
    }
    .batch-preview {
        left: 10px;
        right: 10px;
        bottom: 75px;
    }
    .stats-content {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .header-inner {
        padding: 10px 6px;
    }
    .user-info {
        min-width: 40px;
    }
    .avatar {
        width: 40px;
        height: 40px;
    }
    .username {
        font-size: 11px;
        max-width: 45px;
    }
    .status {
        font-size: 9px;
        padding: 1px 4px;
    }
    .header-motto {
        font-size: 8px;
        top: 4px;
    }
    .header-actions {
        gap: 4px;
    }
    .action-btn {
        width: 30px;
        height: 30px;
        font-size: 14px;
    }
    .chat-container {
        padding: 15px 8px;
    }
    .input-area {
        padding: 8px 10px;
        gap: 6px;
    }
    .input-btn {
        width: 38px;
        height: 38px;
    }
    .message-input {
        min-height: 38px;
        padding: 8px 14px;
        font-size: 14px;
    }
    .batch-preview {
        left: 8px;
        right: 8px;
        bottom: 70px;
        max-height: 130px;
    }
    .empty-state i {
        font-size: 48px;
    }
    .empty-state p {
        font-size: 14px;
    }
}

@media (max-width: 360px) {
    .username {
        display: none;
    }
    .user-info {
        gap: 2px;
    }
    .header-inner {
        padding: 8px 5px;
    }
    .input-buttons {
        gap: 5px;
    }
    .input-btn {
        width: 36px;
        height: 36px;
    }
}

.report-card {
    background-color: rgba(255,255,255,0.5);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    animation: slideInUp 0.5s ease forwards;
    opacity: 0;
    transform: translateY(20px);
}

html[data-theme="dark"] .report-card {
    background-color: rgba(30,30,30,0.5);
    border: 1px solid rgba(255,255,255,0.05);
}

.report-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 8px;
}

.report-card .highlight-text {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-color);
    margin: 5px 0;
}

.report-card .sub-text {
    font-size: 12px;
    opacity: 0.7;
    line-height: 1.5;
}

.report-tag {
    display: inline-block;
    background: var(--message-received-bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 2px;
}

@keyframes slideInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 10px 5px;
        }

        .settings-card {
            background-color: var(--primary-bg);
            border-radius: 20px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }


        .settings-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }


        .settings-card i {
            font-size: 28px;
            color: var(--accent-color);
            width: 64px;
            height: 64px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.4s ease;
        }

        html[data-theme="dark"] .settings-card i {
            background-color: rgba(var(--accent-color-rgb), 0.2);
        }


        .settings-card:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.4);
        }

        .settings-card span {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }


        .settings-footer {
            margin-top: 25px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border: 1px dashed var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .settings-footer p {
            margin: 2px 0;
        }

@media (max-width: 480px) {
            .settings-grid {
                gap: 12px;
            }
            .settings-card {
                padding: 20px 10px;
            }
            .settings-card i {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            .settings-card span {
                font-size: 13px;
            }
        }


        .anniversary-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .anniversary-animation.active {
            opacity: 1;
            pointer-events: all;
        }

        .anniversary-animation-content {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 80%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .anniversary-animation.active .anniversary-animation-content {
            transform: scale(1);
            opacity: 1;
        }

        .anniversary-animation-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .anniversary-animation-days {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .anniversary-animation-message {
            font-size: 16px;
            opacity: 0.9;
        }


        .anniversary-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .anniversary-type-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .anniversary-type-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
        }

        .anniversary-type-btn:hover {
            transform: translateY(-2px);
        }
        .player-container {
            position: fixed;
            top: 100px;
            left: 20px;
            width: 320px;
            height: 160px;
            background: rgba(var(--secondary-bg-rgb), 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 24px;
            box-shadow: var(--shadow);
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            border-radius 0.4s ease,
            opacity 0.3s ease, visibility 0.3s ease;
            z-index: 990;
            overflow: hidden;
            cursor: grab;
            border: 1px solid var(--border-color);
            display: none;
            touch-action: none;
        }

        .player-container.visible {
            display: block;
        }

        .player-container:active {
            cursor: grabbing;
        }

        .player-container.collapsed {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 0;
            border-color: transparent;
        }

        .full-view {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease 0.1s;
            padding: 15px 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .player-container.collapsed .full-view {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            position: absolute;
        }

        .mini-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-container.collapsed .mini-view {
            opacity: 1;
            pointer-events: auto;
        }


        .vinyl-record {
            width: 40px;
            height: 40px;
            background-color: #1a1a1a;

            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: spin 4s linear infinite;
            animation-play-state: paused;


            border: 2px solid var(--accent-color);


            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: border-color 0.5s ease;
        }


        .player-container.collapsed.playing .vinyl-record {
            animation-play-state: running;
        }
@keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }


        .vinyl-record::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-color);

            border-radius: 50%;
            position: absolute;
            z-index: 1;
            transition: background-color 0.5s ease;
        }


        .vinyl-record svg {
            width: 14px;
            height: 14px;
            fill: var(--accent-color);

            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .mini-view:hover .vinyl-record svg {
            opacity: 1;
        }


        .vinyl-record.has-cover::after {
            background: rgba(255,255,255,0.25);
            backdrop-filter: blur(2px);
            width: 8px;
            height: 8px;
        }


        .vinyl-record.has-cover svg {
            display: none !important;
        }


        #upload-cover-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .minimize-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 10;
            color: var(--text-secondary);
        }
        .minimize-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        .minimize-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .track-info {
            text-align: center;
            margin-top: 5px;
        }
        .track-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-sub {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.8;
        }


        .progress-wrapper {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
            position: relative;
        }
        .progress-wrapper::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: -6px;
            left: 0;
            right: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);

            border-radius: 2px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -3px;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .progress-wrapper:hover .progress-bar::after {
            opacity: 1;
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn:hover {
            background: var(--message-received-bg);
            color: var(--text-primary);
        }
        .btn-main {
            width: 44px;
            height: 44px;
            background: var(--accent-color);

            color: var(--message-sent-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        html[data-theme="dark"] .btn-main {
            background: var(--accent-color-dark);
        }
        .btn-main:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
            color: var(--message-sent-text);
        }
        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }


        .playlist-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 320px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 980;
    display: flex;
    flex-direction: column;
    height: 400px;
    max-height: 60vh;
    overflow: hidden;
    padding: 0;
}

.playlist-popup.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.playlist-header {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(var(--secondary-bg-rgb), 0.98);
    z-index: 5;
}

.pl-header-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-family);
    letter-spacing: 1px;
}

.pl-header-actions {
    display: flex;
    gap: 8px;
}

.pl-icon-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
}

.pl-icon-btn:hover, .pl-icon-btn.active {
    background-color: var(--primary-bg);
    color: var(--accent-color);
}

.playlist-search-wrapper {
    flex-shrink: 0;
    padding: 0 15px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    border-bottom: 1px solid var(--border-color);
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: all 0.3s ease;
}

.playlist-search-wrapper.active {
    height: 50px;
    opacity: 1;
    padding: 8px 15px;
}

.playlist-search-input {
    width: 100%;
    background-color: var(--primary-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 6px 10px 6px 30px;
    font-size: 12px;
    color: var(--text-primary);
    outline: none;
    transition: all 0.3s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: 12px;
    background-position: 10px center;
}

.playlist-search-input:focus {
    background-color: var(--secondary-bg);
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.1);
}

.playlist-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 10px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.playlist-content::-webkit-scrollbar {
    display: none;
}

.playlist-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
    gap: 10px;
}

.playlist-item:hover {
    background-color: var(--primary-bg);
}

.playlist-item.playing {
    background-color: rgba(var(--accent-color-rgb), 0.08);
}

.song-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.song-title-row {
    font-size: 13px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    font-weight: 500;
}

.song-title-row .highlight {
    color: var(--accent-color);
    font-weight: bold;
}

.playlist-item.playing .song-title-row {
    color: var(--accent-color);
    font-weight: 700;
}

.song-sub-row {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.action-icon-btn.delete {
    font-size: 16px;
    color: var(--text-secondary);
    opacity: 0;
    transition: all 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 100%;
}

.playlist-item:hover .action-icon-btn.delete {
    opacity: 0.6;
}

.action-icon-btn.delete:hover {
    opacity: 1 !important;
    color: #ff4757;
    transform: scale(1.1);
}

.custom-tag {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--accent-color);
    opacity: 0.6;
    box-shadow: 0 0 0 1px rgba(var(--accent-color-rgb), 0.3);
}

.empty-search-result {
    text-align: center;
    padding: 30px 10px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.8;
}

        .pagination {
            display: none !important;
        }


        .chat-container {
            padding-top: 20px;
        }


        .history-loader {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;

        }


        .history-loader.visible {
            opacity: 1;
        }


        .history-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--accent-color-rgb), 0.2);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: history-spin 0.8s linear infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

@keyframes history-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .input-btn:active,
        .action-btn:active,
        .modal-btn:active,
        .batch-action-btn:active,
        .reply-action-mini:active,
        .settings-item:active,
        .session-item:active,
        .coin-btn-action:active,
        .import-export-btn:active {
            transform: scale(0.92) !important;

            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);

        }


        .ripple-effect {
            position: relative;
            overflow: hidden;

            transform: translate3d(0, 0, 0);

        }


        .ripple-wave {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;

            background: rgba(255, 255, 255, 0.4);

            z-index: 99;
        }


        .modal-btn-primary .ripple-wave,
        .send-btn .ripple-wave,
        .batch-send-btn .ripple-wave,
        .theme-color-btn .ripple-wave {
            background: rgba(255, 255, 255, 0.6);
        }


        .modal-btn-secondary .ripple-wave,
        .input-btn:not(.send-btn) .ripple-wave,
        .settings-item .ripple-wave {
            background: rgba(0, 0, 0, 0.1);

        }


@keyframes ripple-anim {
            to {
                transform: scale(4);

                opacity: 0;

            }
        }


        .send-btn:hover {
            box-shadow: 0 6px 15px rgba(var(--accent-color-rgb), 0.4);
            transform: translateY(-2px) scale(1.05);
        }


        .input-btn:not(.send-btn):hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }


        .settings-item {
            transition: all 0.2s ease;
        }
        .settings-item:hover {
            background-color: var(--secondary-bg);
            border-color: rgba(var(--accent-color-rgb), 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(5px) scale(1.01);

        }


        .modal-btn-secondary:hover {
            background-color: #f5f5f5;
            color: #333;
            border-color: #ddd;
        }
        html[data-theme="dark"] .modal-btn-secondary:hover {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }

        .bg-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 15px;
            padding: 15px 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .bg-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; 
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
        }

        .bg-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .bg-item img, .bg-item div.bg-color-block {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .bg-item.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        .bg-item.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: var(--accent-color);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

@keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .bg-add-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            border-radius: 50%; 
            border: 2px dashed var(--border-color);
            gap: 8px;
        }
        
        .bg-add-btn i {
            font-size: 24px;
            opacity: 0.7;
        }
        
        .bg-add-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .bg-add-btn:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .bg-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
            z-index: 5;
        }
        .bg-item:hover .bg-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .bg-delete-btn:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
.tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: none; 
}
.tour-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.tour-highlight-box {
    position: absolute;
    border-radius: 8px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 15px rgba(255, 255, 255, 0.5);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    z-index: 10001;
}

.tour-popover {
    position: absolute;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 16px 20px;
    width: 300px;
    max-width: 90vw;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 10002;
    opacity: 0;
    transform: translateY(15px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-color);
}
.tour-popover.visible {
    opacity: 1;
    transform: translateY(0);
}
.tour-popover-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.tour-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-color);
}
html[data-theme="dark"] .tour-title {
    color: var(--accent-color-dark);
}
.tour-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
    background-color: var(--primary-bg);
    padding: 2px 8px;
    border-radius: 10px;
}
.tour-popover-content {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 16px;
}
.tour-popover-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tour-navigation {
    display: flex;
    gap: 8px;
}
.tour-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tour-btn:hover {
    transform: translateY(-1px);
}
.tour-btn:active {
    transform: scale(0.95) !important;
}
.tour-btn-skip {
    background-color: transparent;
    color: var(--text-secondary);
}
.tour-btn-skip:hover {
    background-color: var(--message-received-bg);
}
.tour-btn-primary {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}
html[data-theme="dark"] .tour-btn-primary {
    background-color: var(--accent-color-dark);
}
.tour-btn-primary:hover {
    filter: brightness(1.1);
}

        #custom-replies-modal .modal-content {
    display: flex !important;
    flex-direction: row !important; 
    height: 85vh !important;       
    max-height: 85vh !important;
    overflow: hidden !important;   
    padding: 0 !important;
    background-color: var(--secondary-bg);
}

        #custom-replies-modal .modal-title {
            flex-shrink: 0;
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            border-bottom: none;
        }

        #custom-replies-modal .reply-tabs {
            flex-shrink: 0;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        #custom-replies-modal .reply-toolbar {
            flex-shrink: 0;
            padding: 15px 20px;
            background-color: var(--primary-bg);
            display: flex;
            gap: 12px;
            align-items: center;
        }
#custom-replies-modal .modal-content {
    flex-direction: column !important; 
    overflow: hidden;
    background-color: var(--secondary-bg);
}

.modal-sidebar {
    width: 100%;
    height: auto;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-direction: row;
    padding: 10px 20px;
    gap: 10px;
    flex-shrink: 0;
    justify-content: center;
}

.sidebar-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 500;
    min-width: 120px;
    justify-content: center;
}

.sidebar-btn i {
    font-size: 18px;
}

.sidebar-btn.active {
    background-color: var(--secondary-bg);
    color: var(--accent-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.modal-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: 100%;
    position: relative;
    overflow: hidden; 
}

.modal-main-view .reply-tabs {
    padding: 15px 20px 10px;
    background-color: var(--secondary-bg);
    white-space: nowrap;
    overflow-x: auto;
    flex-shrink: 0;
}

.modal-main-view .reply-toolbar {
    padding: 10px 20px;
    background-color: var(--secondary-bg);
    border-bottom: 1px solid var(--border-color);
}

.content-list-area {
    flex: 1;
    overflow-y: auto !important; 
    overflow-x: hidden;
    padding: 15px;
    padding-bottom: 80px !important; 
    background-color: var(--primary-bg);
    height: 0; 
    -webkit-overflow-scrolling: touch; 
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)) !important; 
    gap: 12px !important;
    align-content: start; 
}

.content-list-area.list-mode .custom-reply-item {
    margin-bottom: 10px; 
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    height: auto; 
    min-height: 50px;
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    align-content: start;
}

.modal-main-view .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
}

.sticker-item {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; 
    border-radius: 12px;
    border: 2px solid var(--border-color);
    overflow: hidden;
    background-color: var(--secondary-bg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    display: block;
}

.sticker-item:hover {
    border-color: var(--accent-color);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.sticker-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0; 
    transform: scale(0.8);
    transition: all 0.2s ease;
    z-index: 2;
}

.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
    transform: scale(1);
}

.sticker-delete-btn:hover {
    background: #ff4757;
    transform: scale(1.1);
}

        #custom-replies-modal .modal-buttons {
            position: static; 
            flex-shrink: 0; 
            width: 100%;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 0;
            z-index: 10;
        }
#custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 10;
    flex-shrink: 0;
}

.sticker-delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 22px;
    height: 22px;
    background: rgba(0,0,0,0.6);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
}

.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
}

.sticker-delete-btn:hover {
    background: #ff4757;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 10px;
    padding: 15px;
}

.emoji-item {
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    aspect-ratio: 1 / 1;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.emoji-item:hover {
    background-color: var(--border-color);
    transform: scale(1.1);
}

.emoji-item.disabled {
    opacity: 0.4;
    background-color: var(--primary-bg);
    filter: grayscale(100%);
}

.emoji-item.disabled::after {
    content: '\f05e'; 
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    font-size: 14px;
    color: #ff4757;
}

#theme-editor-modal .modal-content {
    max-width: 500px;
}
.theme-editor-toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}
.theme-editor-toolbar select {
    flex-grow: 1;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    color: var(--text-primary);
}
.theme-editor-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    max-height: 50vh;
    overflow-y: auto;
    padding: 5px;
}
.color-picker-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: var(--primary-bg);
    padding: 8px;
    border-radius: 8px;
}
.color-picker-item label {
    font-size: 13px;
    flex-grow: 1;
}
.color-picker-item input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 32px;
    height: 32px;
    background-color: transparent;
    border: none;
    cursor: pointer;
    border-radius: 50%;
    overflow: hidden;
}
.color-picker-item input[type="color"]::-webkit-color-swatch {
    border-radius: 50%;
    border: 1px solid var(--border-color);
}
.color-picker-item input[type="color"]::-moz-color-swatch {
    border-radius: 50%;
    border: 1px solid var(--border-color);
}
.avatar-container {
    position: relative;
    width: 60px;
    height: 60px;
    order: 2;
}

.avatar {
    width: 100% !important;
    height: 100% !important;
    position: relative;
    z-index: 1;
}

.avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none; 
}

.message-avatar {
    position: relative;
}

.message-avatar .avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none;
}
.message-avatar img, .message-avatar i {
    position: absolute; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: calc(var(--in-chat-avatar-size) * 0.5); 
}


.frame-settings-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    padding-top: 10px;
}
.frame-preview-wrapper {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.frame-preview {
    width: 80px;
    height: 80px;
    position: relative;
flex-shrink: 0; 
}
.frame-preview .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
overflow: hidden;
position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color); 
    display: flex;
    align-items: center;
    justify-content: center;

}
.frame-preview .preview-bg-layer {
    width: 100%;
    height: 100%;
    border-radius: 50%; 
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color);
    box-sizing: border-box; 
    -webkit-mask-image: radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    overflow: hidden; 
}
.frame-preview .preview-bg-layer img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
border-radius: 50%; 
    display: block;
    
}
.frame-preview .preview-bg-layer i {
    font-size: 32px;
    color: var(--text-secondary);
position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.frame-preview .preview-avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: var(--text-secondary);
}
.frame-preview .preview-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    pointer-events: none;
    max-width: none; 
    max-height: none;
}
.frame-controls {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.frame-slider-group {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}
.frame-slider-group label {
    width: 40px;
    flex-shrink: 0;
    color: var(--text-secondary);
}
.frame-slider-group input[type="range"] {
    flex-grow: 1;
}

@media (max-width: 768px) {
    .avatar-container {
        width: 48px;
        height: 48px;
    }
}
@media (max-width: 480px) {
    .avatar-container {
        width: 40px;
        height: 40px;
    }
}
#custom-bubble-css {
    background-color: #2b2b2b; 
    color: #f8f8f2; 
    border: 1px solid var(--border-color);
    padding: 10px;
    line-height: 1.4;
    border-radius: 8px;
    resize: vertical;
}

html[data-theme="light"] #custom-bubble-css {
    background-color: #f5f5f5;
    color: #333;
}
.content-list-area.grid-mode {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
    grid-auto-rows: max-content !important; 
    gap: 15px !important;
    align-content: start !important;
    padding-bottom: 120px !important; 
    overflow-y: auto !important;
    height: auto !important;
}

.sticker-item {
    position: relative !important;
    width: 100% !important;
    aspect-ratio: 1 / 1 !important;
    height: auto !important;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    overflow: hidden !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    margin: 0 !important; 
}

.sticker-item img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important; 
    display: block !important;
}

.emoji-grid {
    padding-bottom: 100px !important;
}
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 10px;
}
.current-month-label {
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font-family);
}
.calendar-nav-btn {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px 10px;
}
.calendar-nav-btn:hover {
    color: var(--accent-color);
}
.calendar-weekdays, .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    gap: 2px;
}
.calendar-weekdays div {
    font-size: 12px;
    color: var(--text-secondary);
    padding-bottom: 5px;
}
.calendar-day {
    min-height: 50px; 
    padding: 2px;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    align-items: center;
}

@media (max-width: 480px) {
    .calendar-weekdays div { font-size: 10px; }
    .calendar-day { 
        min-height: 45px; 
        font-size: 10px;
    }
.mood-detail-dot {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 20px !important; 
        height: 20px !important;
        border-radius: 50% !important; 
        padding: 0 !important;
        margin: 1px auto !important; 
        font-size: 12px !important;
        line-height: 1 !important;
        overflow: hidden;
    }
.mood-text-span {
        display: none;
    }
    
 .mood-kaomoji-span {
        display: block;
        transform: scale(0.9);
    }

    .mood-dots-container {
        flex-direction: row !important;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2px;
    }
.mood-detail-dot {
    width: 100%;
    border-radius: 4px;
    padding: 2px;
    font-size: 10px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    transform: scale(0.9); 
}

.mood-detail-dot.partner-mood {
    opacity: 0.9;
    border: 1px dashed rgba(255,255,255,0.5); 
}
.calendar-day:hover {
    background-color: var(--message-received-bg);
}
.calendar-day.today {
    background-color: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    font-weight: bold;
    border-color: var(--accent-color);
}
.calendar-day.empty {
    pointer-events: none;
}
.mood-dots {
    display: flex;
    gap: 2px;
    margin-top: 2px;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
}
.mood-marker {
    font-size: 10px;
    width: 16px; 
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: var(--secondary-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.mood-marker.me { color: var(--accent-color); border: 1px solid rgba(var(--accent-color-rgb), 0.3); }
.mood-marker.partner { color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }

.calendar-footer-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    font-size: 12px;
    color: var(--text-secondary);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-item .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.legend-item .dot.me { background-color: var(--accent-color); }
.legend-item .dot.partner { background-color: #ff6b6b; }

.mood-selector-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2100;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
    border-radius: var(--radius);
}
.mood-selector-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
.mood-selector-card {
    background: var(--secondary-bg);
    padding: 20px;
    border-radius: 16px;
    width: 85%;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.mood-options-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 15px;
}
.mood-option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    background: var(--primary-bg);
    cursor: pointer;
    transition: all 0.2s;
}
.mood-option-btn:hover {
    transform: translateY(-3px);
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}
.mood-kaomoji { font-size: 16px; margin-bottom: 5px; white-space: nowrap; }
.mood-label { font-size: 12px; opacity: 0.8; }

@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
#fortune-modal {
    z-index: 9999 !important; 
}

.tarot-container-3d {
    perspective: 1000px;
    width: 200px;
    height: 320px;
    margin: 0 auto 20px;
    cursor: pointer;
}

.tarot-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s;
    transform-style: preserve-3d;
}

.tarot-container-3d.flipped .tarot-card-inner {
    transform: rotateY(180deg);
}

.tarot-face {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.tarot-front {
    background: linear-gradient(135deg, #2c3e50, #000);
    color: #fff;
    border: 2px solid #bdc3c7;
}

.tarot-pattern {
    font-size: 40px;
    opacity: 0.3;
    animation: pulse 3s infinite;
}

.tarot-back {
    background-color: var(--secondary-bg);
    transform: rotateY(180deg);
    border: 1px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.fortune-result-area {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease 0.5s; 
    padding: 0 20px;
    text-align: center;
}

.fortune-result-area.visible {
    opacity: 1;
    transform: translateY(0);
}
#mood-modal .modal-content {
    background-color: var(--primary-bg);
    max-height: 90vh;
}

.mood-stats-bar {
    height: 12px !important; 
    border-radius: 6px !important;
    background: #eee !important;
    margin: 10px 0 20px 0 !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

html[data-theme="dark"] .mood-stats-bar {
    background: #333 !important;
}

#month-mood-summary {
    font-weight: bold;
    font-size: 13px;
}
.mood-stat-segment { height: 100%; transition: width 0.5s; }

.calendar-day {
    border-radius: 12px;
    background-color: var(--secondary-bg);
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    min-height: 60px; 
    justify-content: flex-start;
    padding: 4px;
    border: 1px solid transparent;
}
.calendar-day span { font-weight: 600; font-size: 12px; margin-bottom: 2px; }

.mood-detail-dot {
    width: 100%;
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 10px;
    margin-top: 2px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
}

.mood-input-wrapper {
    width: 100%;
    margin-top: 15px;
    text-align: left;
}
.mood-note-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--primary-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 13px;
    margin-top: 8px;
}

.day-detail-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: left;
    position: relative;
    border-left: 5px solid var(--accent-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.day-detail-date { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
.day-detail-content { 
    background: var(--primary-bg); 
    padding: 15px; 
    border-radius: 8px; 
    font-size: 14px; 
    line-height: 1.6;
    min-height: 60px;
    white-space: pre-wrap;
}
.user-info .avatar,
.user-info .username {
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.user-info.changing .avatar,
.user-info.changing .username {
    opacity: 0;
    transform: scale(0.9);
}
.message-sender-name {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 2px;
    margin-left: 4px;
    display: none; 
}

body.show-partner-name .message-wrapper.received .message-sender-name {
    display: block;
}

.mood-stats-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.mood-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}

.mood-circles-wrapper {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
}

.mood-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
}

.mood-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: conic-gradient(var(--accent-color) var(--percent), var(--message-received-bg) 0);
    transition: all 0.5s ease;
}

.mood-circle::before {
    content: "";
    position: absolute;
    width: 52px;
    height: 52px;
    background-color: var(--secondary-bg);
    border-radius: 50%;
}

.mood-circle-text {
    position: absolute;
    z-index: 2;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
}

.mood-circle-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

.mood-bar-container {
    height: 8px;
    width: 100%;
    background-color: var(--message-received-bg);
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    margin-top: 5px;
}

.mood-bar-segment {
    height: 100%;
    transition: width 0.6s ease;
}

.dominant-mood-tag {
    background-color: var(--primary-bg);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.mood-view-section {
    display: block;
    animation: fadeIn 0.3s ease;
}
.mood-view-section.hidden-view {
    display: none;
}

.mood-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.view-switch-btn {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
}
.view-switch-btn:hover, .view-switch-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}

.mood-stat-group {
    margin-bottom: 20px;
    background: var(--primary-bg);
    padding: 15px;
    border-radius: 12px;
}
.mood-stat-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* è¡¨æƒ…/æ‹ä¸€æ‹ å¼¹çª—å®¹å™¨ */
.sticker-picker-popover {
    position: absolute;
    bottom: 60px; /* è¾“å…¥æ¡†ä¸Šæ–¹ */
    right: 50px; /* ç¨å¾®é å³ï¼Œå¯¹é½æŒ‰é’® */
    width: 320px;
    height: 350px; /*ç¨å¾®é«˜ä¸€ç‚¹ */
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    z-index: 100;
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: fadeUp 0.2s ease;
}

.sticker-picker-popover.active {
    display: flex;
}

/* é¡¶éƒ¨ Tab æ  */
.combo-tabs-header {
    display: flex;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 12px;
    gap: 10px;
    flex-shrink: 0;
}

.combo-tab-btn {
    flex: 1;
    padding: 8px 0;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
}

.combo-tab-btn:hover {
    background-color: var(--border-color);
}

.combo-tab-btn.active {
    background-color: var(--accent-color);
    color: #fff;
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
}

/* å†…å®¹åŒºåŸŸ */
.combo-content-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    background-color: var(--secondary-bg);
}

/* è¡¨æƒ…åº“ç½‘æ ¼ */
.sticker-grid-view {
    display: grid;
    grid-template-columns: repeat(4, 1fr); /* ä¸€è¡Œ4ä¸ª */
    gap: 10px;
}

.sticker-grid-item {
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-grid-item:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
}

.sticker-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* æ‹ä¸€æ‹åˆ—è¡¨ */
.poke-list-view {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.poke-quick-item {
    padding: 12px;
    background-color: var(--primary-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    font-size: 13px;
    transition: all 0.2s;
    color: var(--text-primary);
}

.poke-quick-item:hover {
    border-color: var(--accent-color);
    transform: translateX(3px);
}

/* è‡ªå®šä¹‰æ‹ä¸€æ‹æŒ‰é’® */
.custom-poke-btn {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.2);
}

.custom-poke-btn:hover {
    filter: brightness(1.1);
}

/* ç©ºçŠ¶æ€æç¤º */
.empty-sticker-tip {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-size: 12px;
    line-height: 1.6;
}
.empty-sticker-tip i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    opacity: 0.5;
}
.sticker-picker-header {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--primary-bg);
}
.sticker-picker-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.picker-item {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
}
.picker-item:hover {
    background-color: var(--primary-bg);
}
.picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}
.picker-item span {
    font-size: 24px;
}

.decision-menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px 0;
}
.decision-option-card {
    background: var(--primary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
.decision-option-card:hover {
    transform: translateY(-5px);
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.2);
}
.decision-option-card i {
    font-size: 40px;
    margin-bottom: 15px;
    color: var(--accent-color);
}
.decision-option-card h3 {
    font-size: 16px;
    margin-bottom: 5px;
}
.decision-option-card p {
    font-size: 12px;
    color: var(--text-secondary);
}

.wheel-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}
.wheel-container {
    position: relative;
    width: 300px;
    height: 300px;
}
.wheel-canvas {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99); 
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
}
.wheel-pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-top: 25px solid var(--accent-color);
    z-index: 10;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}
.wheel-controls {
    width: 100%;
    max-width: 300px;
}
.wheel-options-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 5px;
    margin-bottom: 10px;
    background: var(--primary-bg);
}
.wheel-option-item {
    display: flex;
    gap: 8px;
    padding: 5px;
    align-items: center;
}
.wheel-option-input {
    flex: 1;
    border: none;
    background: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 4px;
    font-size: 14px;
    outline: none;
}
.wheel-option-remove {
    color: #ff4757;
    cursor: pointer;
    padding: 5px;
}
.wheel-result-display {
    text-align: center;
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-color);
    min-height: 36px;
    margin-top: 10px;
    opacity: 0;
    transition: opacity 0.5s;
}
.wheel-result-display.show {
    opacity: 1;
}

    </style>
</head>
<body>
<div id="tour-overlay" class="tour-overlay">
    <div id="tour-highlight-box" class="tour-highlight-box"></div>
    <div id="tour-popover" class="tour-popover">
        <div class="tour-popover-header">
            <span id="tour-title" class="tour-title"></span>
            <span id="tour-step-counter" class="tour-step-counter"></span>
        </div>
        <div id="tour-content" class="tour-popover-content"></div>
        <div class="tour-popover-footer">
            <button id="tour-skip-btn" class="tour-btn tour-btn-skip">è·³è¿‡</button>
            <div class="tour-navigation">
                <button id="tour-prev-btn" class="tour-btn"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button id="tour-next-btn" class="tour-btn tour-btn-primary">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

    <div class="welcome-animation" id="welcome-animation">
        <div class="stars-container" id="stars-container"></div>
        <div class="welcome-content-wrapper">
            <div class="logo-tech-container">
                <div class="logo-circle-outer"></div>
                <div class="logo-circle-inner"></div>
                <div class="logo-icon-main">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="orbit-dot"></div>
            </div>

            <div class="text-tech-container">
                <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="ä¼ è®¯">
                    åŠ è½½å¤±è´¥
                </div>
                <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">
                    è¯·é‡è¯•ï¼æ›´æ¢å¹³å°/æ›´æ¢ç½‘ç»œ
                </div>
            </div>

            <div class="loader-tech">
                <div class="loader-tech-bar" id="loader-tech-bar"></div>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
         <div class="user-info">
                <div id="partner-name" class="username">
                    å¯¹æ–¹
                </div>
                <div id="partner-avatar-container" class="avatar-container">
                    <div class="avatar" id="partner-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="status" id="partner-status">
                    <span>åœ¨çº¿</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="ä¼šè¯ç®¡ç†"><i class="fas fa-comments"></i></button>
                <button id="favorites-btn" class="action-btn" title="æ”¶è—å¤¹"><i class="fas fa-star"></i></button>
                <button id="theme-toggle" class="action-btn" title="åˆ‡æ¢ä¸»é¢˜"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="è®¾ç½®"><i class="fas fa-cog"></i></button>
            </div>
             <div class="user-info">
                <div class="username" id="my-name">
                    æˆ‘
                </div>
               
                <div id="my-avatar-container" class="avatar-container">
                    <div class="avatar" id="my-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
               
                <div class="status" id="my-status-container">
                    <span id="my-status-text">åœ¨çº¿</span>
                </div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">

        <div class="history-loader" id="history-loader">
            <div class="history-spinner"></div>
        </div>

        <div class="chat-container" id="chat-container"></div>
        <div class="empty-state" id="empty-state">
            <i class="far fa-comments"></i><p></p>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div class="batch-preview" id="batch-preview"></div>
    </div>
    <div class="input-area-wrapper">
        <div id="reply-preview-container"></div>
        <div class="input-area">
    <button class="attachment-btn input-btn" id="attachment-btn" title="å‘é€å›¾ç‰‡"><i class="fas fa-image"></i></button>
    
    <!-- è¿™é‡Œçš„ id å¿…é¡»æ˜¯ combo-btn -->
    <button class="combo-btn input-btn" id="combo-btn" title="è¡¨æƒ… & æ‹ä¸€æ‹">
        <i class="fas fa-laugh-beam"></i>
    </button>

    <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
    
    <div class="input-buttons">
        <button class="continue-btn input-btn" id="continue-btn" title="è®©å¯¹æ–¹ç»§ç»­è¯´"><i class="fas fa-ellipsis-h"></i></button>
        <button class="batch-btn input-btn" id="batch-btn" title="æ‰¹é‡å‘é€æ¨¡å¼"><i class="fas fa-layer-group"></i></button>
        <button class="send-btn input-btn" id="send-btn" title="å‘é€æ¶ˆæ¯"><i class="fas fa-paper-plane"></i></button>
        
        <!-- å¼¹çª—ç»“æž„ -->
        <div class="sticker-picker-popover" id="user-sticker-picker">
            <div class="combo-tabs-header">
                <button class="combo-tab-btn active" data-tab="sticker">è¡¨æƒ…åº“</button>
                <button class="combo-tab-btn" data-tab="poke">æ‹ä¸€æ‹</button>
            </div>
            <div class="combo-content-area" id="combo-content-area">
                <!-- å†…å®¹ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    <input type="file" id="image-input" class="file-input" accept="image/*">
</div>
    </div>


    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-user-edit"></i><span id="edit-modal-title">ä¿®æ”¹æ˜µç§°</span>
            </div>
            <input type="text" class="modal-input" id="name-input" placeholder="è¾“å…¥æ–°æ˜µç§°"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-portrait"></i><span id="avatar-modal-title">ä¸Šä¼ å¤´åƒ</span>
            </div>
            <input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-avatar">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-avatar">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-sticky-note"></i><span>ç¼–è¾‘æ³¨é‡Š</span>
            </div>
            <textarea class="modal-textarea" id="note-input" placeholder="ä¸ºè¿™æ¡æ¶ˆæ¯æ·»åŠ æ³¨é‡Š..."></textarea><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-note">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-note">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="poke-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hand-sparkles"></i><span>æ‹ä¸€æ‹</span>
            </div>
            <input type="text" class="modal-input" id="poke-input" placeholder="ä¾‹å¦‚ï¼šæ‹äº†æ‹â€œå¯¹æ–¹â€çš„è‚©è†€"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-poke">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="send-poke">å‘é€</button>
            </div>
        </div>
    </div>
<div class="modal" id="envelope-modal">
    <div class="modal-content">
        <div class="modal-title">
            <i class="fas fa-envelope-open-text"></i><span>å¯„å‡ºä¸€å°é•¿ä¿¡</span>
        </div>
        <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">
            å¯„å‡ºçš„ä¿¡ä»¶éœ€è¦æ¼«é•¿çš„æ—…é€”ã€‚<br>å¯¹æ–¹å°†åœ¨ 10-24 å°æ—¶å†…æ”¶åˆ°å¹¶å›žå¤ä½  8-12 å¥è¯ã€‚
        </p>
        <textarea class="modal-textarea" id="envelope-input" placeholder="äº²çˆ±çš„..." style="height: 150px;"></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-envelope">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" id="send-envelope">å¯„å‡º</button>
        </div>
    </div>
</div>
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i><span>è®¾ç½®</span>
            </div>

            <div class="settings-grid">
                <div class="settings-card" id="appearance-settings">
                    <i class="fas fa-palette"></i>
                    <span>å¤–è§‚è®¾ç½®</span>
                </div>
                <div class="settings-card" id="chat-settings">
                    <i class="fas fa-comments"></i>
                    <span>èŠå¤©è®¾ç½®</span>
                </div>
                <div class="settings-card" id="advanced-settings">
                    <i class="fas fa-tools"></i>
                    <span>é«˜çº§åŠŸèƒ½</span>
                </div>
                <div class="settings-card" id="data-settings">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®ç®¡ç†</span>
                </div>
            </div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="appearance-modal">
        <div class="modal-content">

<div class="modal-title">
    <i class="fas fa-palette"></i><span>å¤–è§‚è®¾ç½®</span>
</div>

<div class="appearance-group">
    <div class="theme-editor-entry-btn" id="open-theme-editor">
        <i class="fas fa-paint-roller"></i>
        <span>è‡ªå®šä¹‰<br>ç¼–è¾‘å™¨</span>
    </div>

    <div class="preset-colors-container">
        <div class="preset-colors-title"><i class="fas fa-swatchbook"></i> å¿«æ·æ¢è‚¤</div>
        <div class="theme-picker">
            <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="é‡‘è‰²"></button>
            <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="è“è‰²"></button>
            <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="ç´«è‰²"></button>
            <button class="theme-color-btn" id="theme-green" data-theme="green" title="ç»¿è‰²"></button>
            <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="ç²‰è‰²"></button>
            <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="é»‘ç™½"></button>
            <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="çº¢è‰²"></button>
            <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="æ©™è‰²"></button>
            <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="æ·±ç»¿"></button>
            <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="æ·±è“"></button>
        </div>
    </div>
</div>

            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-font"></i>å­—ä½“è®¾ç½®
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">å¤§å°:</span>
                    <input type="range" min="12" max="24" value="16" class="font-size-slider" id="font-size-slider">
                    <span class="font-size-value" id="font-size-value">16px</span>
                </div>
                <div style="margin-top: 10px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:5px;">å­—ä½“é“¾æŽ¥ (CSS/TTF):</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="custom-font-url" class="modal-input" style="margin-bottom:0; font-size:12px;" placeholder="https://example.com/font.woff2">
                       <button id="apply-font-btn" class="modal-btn modal-btn-primary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap;">åº”ç”¨</button>
<button id="follow-system-font-btn" class="modal-btn modal-btn-secondary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap; margin-left: 5px;">è·Ÿéšç³»ç»Ÿ</button>
                    </div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; opacity: 0.7;">
                        æç¤º: åº”ç”¨åŽå°†è¦†ç›–é»˜è®¤å­—ä½“ã€‚ç•™ç©ºå¹¶åº”ç”¨å¯æ¢å¤é»˜è®¤ã€‚
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-code"></i>æ°”æ³¡æ ·å¼è‡ªå®šä¹‰ (CSS)
                    </div>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                    åœ¨æ­¤ç¼–å†™ CSS ä»£ç 
                </div>
                <textarea id="custom-bubble-css" class="modal-textarea" style="font-family: monospace; font-size: 12px; height: 120px; white-space: pre;" placeholder=".message-sent {
  border-radius: 20px 20px 0 20px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.message-received {
  border-bottom: 2px solid var(--accent-color);
}"></textarea>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="reset-css-btn" class="modal-btn modal-btn-secondary" style="padding: 6px 12px; font-size: 12px;">æ¸…ç©º</button>
                    <button id="apply-css-btn" class="modal-btn modal-btn-primary" style="padding: 6px 12px; font-size: 12px;">åº”ç”¨ CSS</button>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-user-circle"></i>èŠå¤©å¤´åƒ
                </div>
                <div class="settings-item" id="in-chat-avatar-toggle">
                    <i class="fas fa-toggle-on"></i><span>æ˜¾ç¤ºèŠå¤©å¤´åƒ: å¼€å¯</span>
                </div>
                <div class="font-size-control" id="in-chat-avatar-size-control">
                    <span class="font-size-label">å¤´åƒå°ºå¯¸:</span>
                    <input type="range" min="24" max="48" value="36" class="font-size-slider" id="in-chat-avatar-size-slider">
                    <span class="font-size-value" id="in-chat-avatar-size-value">36px</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-comment"></i>æ°”æ³¡æ ·å¼
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" data-bubble-style="standard">
                        <i class="fas fa-comment"></i><span>æ ‡å‡†</span>
                    </div>
                    <div class="settings-item" data-bubble-style="rounded">
                        <i class="fas fa-comment"></i><span>åœ†è§’</span>
                    </div>
                    <div class="settings-item" data-bubble-style="rounded-large">
                        <i class="fas fa-comment"></i><span>å¤§åœ†è§’</span>
                    </div>
                    <div class="settings-item" data-bubble-style="square">
                        <i class="fas fa-comment"></i><span>æ–¹å½¢</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-image"></i>èŠå¤©èƒŒæ™¯åº“
                    </div>
                    <input type="file" id="bg-gallery-input" accept="image/*" style="display: none;">
                </div>
                <div class="bg-gallery" id="background-gallery-list"></div>
                <div style="text-align: center; margin-top: 10px;">
                    <button class="modal-btn modal-btn-secondary" id="reset-default-bg" style="font-size: 12px; padding: 6px 12px;">
                        <i class="fas fa-undo"></i> 
                    </button>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-appearance">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>èŠå¤©è®¾ç½®</span>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-hourglass-half"></i>å¯¹æ–¹å›žå¤é€Ÿåº¦
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">æœ€å°é—´éš”:</span>
                    <input type="range" min="100" max="5000" step="100" value="800" class="font-size-slider" id="reply-delay-min-slider">
                    <span class="font-size-value" id="reply-delay-min-value">0.8s</span>
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">æœ€å¤§é—´éš”:</span>
                    <input type="range" min="100" max="10000" step="100" value="2500" class="font-size-slider" id="reply-delay-max-slider">
                    <span class="font-size-value" id="reply-delay-max-value">2.5s</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-paper-plane"></i> å¯¹æ–¹ä¸»åŠ¨å‘æ¶ˆæ¯
                </div>
                <div class="settings-item" id="auto-send-toggle">
                    <i class="fas fa-toggle-off"></i><span>ä¸»åŠ¨å‘é€: å…³é—­</span>
                </div>
                <div class="font-size-control" id="auto-send-control" style="display:none; margin-top:10px;">
                    <span class="font-size-label">é—´éš”(ç§’):</span>
                    <input type="range" min="10" max="3600" step="10" value="60" class="font-size-slider" id="auto-send-slider">
                    <span class="font-size-value" id="auto-send-value">60s</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-toggle-on"></i>åŠŸèƒ½å¼€å…³
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="reply-toggle">
                        <i class="fas fa-reply"></i><span>å¼•ç”¨å›žå¤: å¼€å¯</span>
                    </div>
                    <div class="settings-item" id="sound-toggle">
                        <i class="fas fa-volume-up"></i><span>æ¶ˆæ¯éŸ³æ•ˆ: å¼€å¯</span>
                    </div>
                    <div class="settings-item" id="read-receipts-toggle">
                        <i class="fas fa-check-double"></i><span>å·²è¯»å›žæ‰§: å¼€å¯</span>
                    </div>
                    <div class="settings-item" id="read-no-reply-toggle">
                        <i class="fas fa-comment-slash"></i><span>å·²è¯»ä¸å›ž: å…³é—­</span>
                    </div>
                    <div class="settings-item" id="typing-indicator-toggle">
                        <i class="fas fa-keyboard"></i><span>æ­£åœ¨è¾“å…¥: æ˜¾ç¤º</span>
                    </div>
                </div>
            </div>

            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-id-badge"></i>å¤´åƒæ¡†è®¾ç½®
                </div>
                
                <h4 style="font-size: 14px; font-weight: 500; margin: 15px 0 10px;">æˆ‘çš„å¤´åƒæ¡†</h4>
                <div class="frame-settings-container">
                    <div class="frame-preview-wrapper">
                        <div class="frame-preview" id="my-frame-preview"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="modal-btn modal-btn-secondary" id="my-frame-upload-btn" style="padding: 5px 10px; font-size: 12px;">ä¸Šä¼ </button>
                            <button class="modal-btn modal-btn-secondary" id="my-frame-remove-btn" style="padding: 5px 10px; font-size: 12px;">ç§»é™¤</button>
                        </div>
                    </div>
                    <div class="frame-controls">
                        <div class="frame-slider-group">
                            <label for="my-frame-size">å¤§å°</label>
                            <input type="range" id="my-frame-size" min="50" max="200" value="100">
                            <span id="my-frame-size-value" style="width: 40px; text-align: right;">100%</span>
                        </div>
                        <div class="frame-slider-group">
                            <label for="my-frame-offset-x">å·¦å³</label>
                            <input type="range" id="my-frame-offset-x" min="-50" max="50" value="0">
                             <span id="my-frame-offset-x-value" style="width: 40px; text-align: right;">0px</span>
                        </div>
                        <div class="frame-slider-group">
                            <label for="my-frame-offset-y">ä¸Šä¸‹</label>
                            <input type="range" id="my-frame-offset-y" min="-50" max="50" value="0">
                             <span id="my-frame-offset-y-value" style="width: 40px; text-align: right;">0px</span>
                        </div>
                    </div>
                </div>
                <input type="file" id="my-frame-file-input" class="file-input" accept="image/png, image/webp, image/gif">

                <h4 style="font-size: 14px; font-weight: 500; margin: 25px 0 10px; border-top: 1px dashed var(--border-color); padding-top: 15px;">å¯¹æ–¹çš„å¤´åƒæ¡†</h4>
                <div class="frame-settings-container">
                    <div class="frame-preview-wrapper">
                        <div class="frame-preview" id="partner-frame-preview"></div>
                         <div style="display: flex; gap: 8px;">
                            <button class="modal-btn modal-btn-secondary" id="partner-frame-upload-btn" style="padding: 5px 10px; font-size: 12px;">ä¸Šä¼ </button>
                            <button class="modal-btn modal-btn-secondary" id="partner-frame-remove-btn" style="padding: 5px 10px; font-size: 12px;">ç§»é™¤</button>
                        </div>
                    </div>
                    <div class="frame-controls">
                        <div class="frame-slider-group">
                            <label for="partner-frame-size">å¤§å°</label>
                            <input type="range" id="partner-frame-size" min="50" max="200" value="100">
                             <span id="partner-frame-size-value" style="width: 40px; text-align: right;">100%</span>
                        </div>
                        <div class="frame-slider-group">
                            <label for="partner-frame-offset-x">å·¦å³</label>
                            <input type="range" id="partner-frame-offset-x" min="-50" max="50" value="0">
                             <span id="partner-frame-offset-x-value" style="width: 40px; text-align: right;">0px</span>
                        </div>
                        <div class="frame-slider-group">
                            <label for="partner-frame-offset-y">ä¸Šä¸‹</label>
                            <input type="range" id="partner-frame-offset-y" min="-50" max="50" value="0">
                             <span id="partner-frame-offset-y-value" style="width: 40px; text-align: right;">0px</span>
                        </div>
                    </div>
                </div>
                <input type="file" id="partner-frame-file-input" class="file-input" accept="image/png, image/webp, image/gif">
            </div>
            

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-chat">å…³é—­</button>
            </div>
        </div>
    </div>

<div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-tools"></i><span>é«˜çº§åŠŸèƒ½</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-magic"></i>å®žç”¨å·¥å…·
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function">
                        <i class="fas fa-comment-dots"></i><span>è‡ªå®šä¹‰å›žå¤</span>
                    </div>
                    <div class="settings-item" id="music-player-toggle">
                        <i class="fas fa-music"></i><span>æ‚¬æµ®éŸ³ä¹æ’­æ”¾å™¨</span>
                    </div>
                    <div class="settings-item" id="stats-function">
                        <i class="fas fa-chart-bar"></i><span>æ¶ˆæ¯ç»Ÿè®¡</span>
                    </div>
                    <div class="settings-item" id="decision-function">
                        <i class="fas fa-balance-scale"></i> 
                        <span>æŠ‰æ‹©</span> 
                    </div>
                    <div class="settings-item" id="fortune-function">
                        <i class="fas fa-star-and-crescent"></i><span>å¡”ç½—å åœ</span>
                    </div>
                    <div class="settings-item" id="anniversary-function">
                        <i class="fas fa-heart"></i><span>é‡è¦æ—¥</span>
                    </div>
                    <div class="settings-item" id="mood-function">
                        <i class="fas fa-calendar-day"></i><span>å¿ƒæ™´æ‰‹è´¦</span>
                    </div>
                    <div class="settings-item" id="envelope-function">
                        <i class="fas fa-envelope"></i><span>ä¿¡å°æŠ•é€’</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-advanced">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-database"></i><span>æ•°æ®ç®¡ç†</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-file-export"></i>å¯¼å…¥å¯¼å‡º
                </div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>å¯¼å‡ºè®°å½•</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>å¯¼å…¥è®°å½•</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-trash-alt"></i>æ•°æ®æ¸…ç†
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-chat">
                        <i class="fas fa-trash-alt"></i><span>æ¸…ç©ºå½“å‰ä¼šè¯</span>
                    </div>
                    <div class="settings-item" id="clear-storage">
                        <i class="fas fa-server"></i><span>é‡ç½®æ‰€æœ‰æ•°æ®</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-info-circle"></i>å…³äºŽä¸Žå£°æ˜Ž
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="replay-tutorial-btn">
                        <i class="fas fa-question-circle"></i><span>é‡æ”¾æ–°æ‰‹å¼•å¯¼</span>
                    </div>
                    <div class="settings-item" id="open-credits-btn">
                        <i class="fas fa-scroll"></i><span>å£°æ˜Žä¸Žè‡´è°¢</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-data">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="favorites-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-star" style="color: var(--favorite-color);"></i><span>æ”¶è—å¤¹</span>
            </div>
            <div class="modal-buttons" style="justify-content: space-between; margin-bottom: 15px;">
                <button class="modal-btn modal-btn-primary" id="batch-favorite-function"><i class="fas fa-layer-group"></i> æ‰¹é‡æ”¶è—</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-favorites">å…³é—­</button>
            </div>
            <div class="favorites-list" id="favorites-list"></div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-chart-bar"></i><span>æ¶ˆæ¯ç»Ÿè®¡</span>
            </div>
            <div class="stats-content" id="stats-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-stats">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>ä¼šè¯ç®¡ç†</span>
            </div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> æ–°å»ºä¼šè¯</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-star-and-crescent"></i><span>ä»Šæ—¥è¿åŠ¿</span>
            </div>
            <div id="fortune-content"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="share-fortune">åˆ†äº«è¿åŠ¿</button>
                <button class="modal-btn modal-btn-secondary" id="close-fortune">å…³é—­</button>
            </div>
        </div>
    </div> 


    <div class="modal" id="mood-modal">
       <div class="modal-content">
        <div class="mood-header-actions">
            <div class="modal-title" style="margin-bottom:0; border:none; padding:0;">
                <i class="fas fa-book-open"></i><span>å¿ƒæ™´æ‰‹å¸</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="view-switch-btn active" id="btn-view-calendar">
                    <i class="fas fa-calendar-alt"></i> æ—¥åŽ†
                </button>
                <button class="view-switch-btn" id="btn-view-stats">
                    <i class="fas fa-chart-pie"></i> ç»Ÿè®¡
                </button>
            </div>
        </div>
        <div id="mood-calendar-view" class="mood-view-section">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month-label" id="calendar-month-label">--</div>
                <button class="calendar-nav-btn" id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    
        <div id="mood-stats-view" class="mood-view-section hidden-view">
            <div id="mood-stats-container" class="mood-stats-card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            </div>
        </div>
    
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-mood">å…³é—­</button>
        </div>
       </div>
    </div>

    <div class="mood-selector-overlay" id="mood-selector-overlay">
        <div class="mood-selector-card" id="mood-editor-view">
            <h3 id="mood-selector-date">--æœˆ--æ—¥</h3>
            <p style="font-size:12px; opacity:0.7;">ä»Šå¤©è¿‡å¾—æ€Žä¹ˆæ ·ï¼Ÿ</p>
            
            <div class="mood-options-grid" id="mood-options-grid"></div>
            
            <div class="mood-input-wrapper">
                <label style="font-size:12px; font-weight:500;">éšè®°:</label>
                <textarea id="mood-note-input" class="mood-note-input" rows="3" placeholder="è®°å½•ä¸‹ä»Šå¤©å‘ç”Ÿçš„å°äº‹..."></textarea>
            </div>
    
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="modal-btn modal-btn-secondary" id="cancel-mood-edit" style="flex:1;">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" id="confirm-mood-save" style="flex:1;">ä¿å­˜</button>
            </div>
        </div>
    
        <div class="day-detail-card" id="mood-detail-view" style="display:none; width:85%; max-width:320px;">
            <div class="day-detail-date" id="detail-date">--</div>
            <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                <span id="detail-kaomoji" style="font-size:24px;"></span>
                <span id="detail-label" style="font-weight:600;"></span>
            </div>
            <div class="day-detail-content" id="detail-text"></div>
            <div style="margin-top:20px; text-align:right;">
                 <button class="modal-btn modal-btn-secondary" onclick="closeMoodOverlay()" style="font-size:12px; padding:6px 12px;">å…³é—­</button>
                 <button class="modal-btn modal-btn-primary" id="edit-existing-mood" style="font-size:12px; padding:6px 12px;">ä¿®æ”¹</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="theme-editor-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-edit"></i><span>ä¸»é¢˜ç¼–è¾‘å™¨</span></div>
            <div class="theme-editor-toolbar">
                <select id="theme-preset-selector"></select>
                <button id="save-theme-preset-btn" class="modal-btn modal-btn-primary" style="padding: 8px 12px;"><i class="fas fa-save"></i></button>
                <button id="delete-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 12px;"><i class="fas fa-trash"></i></button>
            </div>
            <div id="theme-editor-grid" class="theme-editor-grid">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-theme-editor">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">
            <div class="modal-sidebar">
                <button class="sidebar-btn active" data-major="reply">
                    <i class="fas fa-comment-dots"></i>
                    <span>å›žå¤åº“</span>
                </button>
                <button class="sidebar-btn" data-major="atmosphere">
                    <i class="fas fa-magic"></i>
                    <span>æ°›å›´æ„Ÿ</span>
                </button>
            </div>
    
            <div class="modal-main-view">
                <div class="modal-title" style="padding: 15px 20px; font-size: 16px;">
                    <i class="fas fa-layer-group"></i> <span id="cr-modal-title">å†…å®¹ç®¡ç†</span>
                </div>
    
                <div class="reply-tabs" id="cr-sub-tabs">
                </div>
    
                <div class="reply-toolbar" id="cr-toolbar">
                    <input type="text" class="reply-search" id="reply-search-input" placeholder="æœç´¢...">
                    <button class="reply-tool-btn" id="import-replies-btn" title="å¯¼å…¥"><i class="fas fa-file-import"></i></button>
                    <button class="reply-tool-btn" id="export-replies-btn" title="å¯¼å‡º"><i class="fas fa-file-export"></i></button>
                </div>
    
                <div class="content-list-area" id="custom-replies-list">
                </div>
    
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-primary" id="add-custom-reply" style="flex: 1;">
                        <i class="fas fa-plus"></i> æ–°å¢ž
                    </button>
                    <button class="modal-btn modal-btn-secondary" id="close-custom-replies">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-replies-input" accept=".json" style="display: none;">
    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">
    <input type="file" id="sticker-file-input" class="file-input" accept="image/*">

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">
                <div class="coin-face coin-front">
                    <div class="coin-text-main">æ˜¯</div>
                    <div class="coin-text-sub">YES</div>
                </div>
                <div class="coin-face coin-back">
                    <div class="coin-text-main">å¦</div>
                    <div class="coin-text-sub">NO</div>
                </div>
            </div>
        </div>
        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>
        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">å–æ¶ˆ</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> å†æ¥ä¸€æ¬¡</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">å‘é€ç»“æžœ</button>
        </div>
    </div>

    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-scroll"></i><span>å…³äºŽ & å£°æ˜Ž</span>
            </div>
            <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <h3 style="color: var(--accent-color); margin-bottom: 10px;">ç‰¹åˆ«é¸£è°¢</h3>
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                        <p style="margin: 5px 0; color: var(--text-primary);">
                            å‚è€ƒäº† <strong>Bç«™ @molina-3- çš„ä¼ è®¯ç½‘ç«™</strong>
                        </p>
                        <p style="margin: 5px 0; font-weight: bold; color: #e53935;">
                            å¦‚æžœéœ€è¦æ›´å¥½çš„æ²Ÿé€šä½“éªŒ è¯·æ”¯æŒå“¦ï¼
                        </p>
                    </div>
                    <p>æ„Ÿè°¢ <strong>@è‹é“‚æ½¼</strong></p>
                    <p style="font-size: 12px; opacity: 0.8;">å°çº¢ä¹¦å·ï¼š9568228497</p>
                    <p style="font-size: 12px; margin-top: 5px; font-style: italic;">(èŠå¤©ç»Ÿè®¡éƒ¨åˆ†ä»£ç å‚è€ƒ)</p>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: bold; color: var(--text-primary); text-align: center;">
                        åŽŸåˆ›ï¼šå°çº¢ä¹¦ @milk (1149615009)
                    </p>
                    <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">
                        æ­¤ä»£ç ç»å¯¹ç¦æ­¢å•†ç”¨å’Œç›ˆåˆ©è¡Œä¸ºï¼Œä¸€æ—¦å‘çŽ°è¿½ç©¶åˆ°åº•
                    </p>
                    <p style="text-align: center; margin-bottom: 15px;">æ”¯æŒäºŒæ”¹äºŒä¼ ï¼Œæ„Ÿè°¢ä½¿ç”¨ï¼</p>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>åå¯¹æ€§åˆ«æš´åŠ›</b></li>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>å°Šé‡ä¸è¯¥æ˜¯å¥¢æ±‚,å®‰å…¨å¿…é¡»æ˜¯åº•çº¿</b></li>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="accept-disclaimer" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="anniversary-modal">
        <div class="modal-content">
            <div class="ann-header-card" id="ann-header-card" style="display: none;">
                <div class="ann-header-title" id="ann-header-title">çºªå¿µæ—¥</div>
                <div class="ann-header-days" id="ann-header-days">0</div>
                <div class="ann-header-date" id="ann-header-date">--/--</div>
            </div>
    
            <div class="ann-list-container" id="ann-list-container">
            </div>
    
            <div class="ann-footer">
                <button class="modal-btn modal-btn-secondary" id="close-anniversary-modal">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" id="open-ann-add-btn" style="flex: 1;">
                    <i class="fas fa-plus"></i> æ–°å¢žçºªå¿µæ—¥
                </button>
            </div>
    
            <div class="ann-editor-slide" id="ann-editor-slide">
                <div class="ann-editor-header">
                    <button class="ann-back-btn" id="close-ann-editor"><i class="fas fa-arrow-left"></i></button>
                    <span>æ·»åŠ çºªå¿µæ—¥</span>
                </div>
                
                <div class="ann-editor-content">
                    <div class="ann-form-group">
                        <label class="ann-label">æ ‡é¢˜åç§°</label>
                        <input type="text" class="modal-input" id="ann-input-name" placeholder="ä¾‹å¦‚ï¼šæ‹çˆ±çºªå¿µæ—¥ã€å¯¹æ–¹ç”Ÿæ—¥">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label">é€‰æ‹©æ—¥æœŸ</label>
                        <input type="date" class="modal-input" id="ann-input-date">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label">ç±»åž‹</label>
                        <div class="ann-type-selector">
                            <div class="ann-type-btn active" data-type="anniversary" onclick="switchAnnType('anniversary')">
                                <i class="fas fa-heart"></i> çºªå¿µæ—¥ (è¿‡åŽ»)
                            </div>
                            <div class="ann-type-btn" data-type="countdown" onclick="switchAnnType('countdown')">
                                <i class="fas fa-hourglass-half"></i> å€’æ•°æ—¥ (æœªæ¥)
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; opacity: 0.7;">
                            <span id="ann-type-desc">è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤©</span>
                        </div>
                    </div>
    
                    <button class="modal-btn modal-btn-primary" id="save-ann-btn" style="width: 100%; margin-top: 20px;">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">
                çºªå¿µæ—¥å¿«ä¹ï¼
            </div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">
                0
            </div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">
                æˆ‘ä»¬å·²ç»ç›¸ä¼´äº†è¿™ä¹ˆå¤šå¤©
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="decision-menu-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-balance-scale"></i><span>æŠ‰æ‹©åŠ©æ‰‹</span>
            </div>
            <div class="decision-menu-grid">
                <div class="decision-option-card" id="open-coin-toss">
                    <i class="fas fa-coins"></i>
                    <h3>æŠ›ç¡¬å¸</h3>
                    <p>æ˜¯ / å¦ äºŒå…ƒé€‰æ‹©</p>
                </div>
                <div class="decision-option-card" id="open-wheel">
                    <i class="fas fa-dharmachakra"></i>
                    <h3>é€‰æ‹©è½¬ç›˜</h3>
                    <p>è‡ªå®šä¹‰å¤šé€‰é¡¹éšæœº</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-decision-menu">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="wheel-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-dharmachakra"></i><span>å‘½è¿è½¬ç›˜</span>
            </div>
            
            <div class="wheel-wrapper">
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheel-canvas" width="300" height="300" class="wheel-canvas"></canvas>
                </div>
                
                <div class="wheel-result-display" id="wheel-result"></div>
    
                <div class="wheel-controls">
                    <div class="settings-section-title" style="font-size:14px; margin-bottom:5px;">é€‰é¡¹åˆ—è¡¨ (è‡³å°‘2é¡¹)</div>
                    <div class="wheel-options-list" id="wheel-options-list">
                    </div>
                    <button class="modal-btn modal-btn-secondary" id="add-wheel-option" style="width:100%; margin-bottom:10px; font-size:12px;">
                        <i class="fas fa-plus"></i> æ·»åŠ é€‰é¡¹
                    </button>
                </div>
            </div>
    
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-wheel">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" id="spin-wheel-btn">å¼€å§‹æ—‹è½¬</button>
                <button class="modal-btn modal-btn-primary" id="send-wheel-result" style="display:none;">å‘é€ç»“æžœ</button>
            </div>
        </div>
    </div>

    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="ç‚¹å‡»å±•å¼€">
            <div class="vinyl-record" id="vinyl-record-visual">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z" /></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="æ”¶èµ·">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
            </div>
            <button id="upload-cover-btn" style="position: absolute; top: 12px; left: 15px; background: none; border: 1px dashed var(--border-color); color: var(--text-secondary); cursor: pointer; opacity: 0.7; z-index: 10; width: 24px; height: 24px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px;" title="æ›´æ¢ä¸“è¾‘å°é¢">
                <i class="fas fa-camera"></i>
            </button>
            <input type="file" id="cover-input" accept="image/*" style="display: none;">
            <div class="track-info">
                <div class="track-name" id="music-title">Loading...</div>
                <div class="track-sub" id="music-subtitle">...</div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="åˆ‡æ¢æ¨¡å¼">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" /></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" /></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" /></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>

    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-music"></i><span>æ·»åŠ è‡ªå®šä¹‰æ­Œæ›²</span>
            </div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="æ­Œæ›²åç§° (ä¾‹å¦‚: è¿™é‡Œçš„é£Žæ™¯)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="æ­Œæ‰‹/å¤‡æ³¨ (ä¾‹å¦‚: ä½ çš„åå­—)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="éŸ³é¢‘é“¾æŽ¥ (mp3/m4a é“¾æŽ¥)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">æ·»åŠ æ’­æ”¾</button>
            </div>
        </div>
    </div>

    <script>
        const APP_PREFIX = 'CHAT_APP_V3_';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        const MAX_AVATAR_SIZE = 2 * 1024 * 1024;
        const MESSAGES_PER_PAGE = 50;
        
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.error('Error getting item:', e);
                return null;
            }
        }

        function safeSetItem(key, value) {
            try {
                if (typeof value === 'object') {
                    value = JSON.stringify(value);
                }
                localStorage.setItem(key, value);
            } catch (e) {
                console.error('Error setting item:', e);
            }
        }

        function safeRemoveItem(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Error removing item:', e);
            }
        }

        function cropImageToSquare(file, maxSize = 640) { 
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const minSide = Math.min(img.width, img.height);
                        const sx = (img.width - minSide) / 2;
                        const sy = (img.height - minSide) / 2;

                        const canvas = document.createElement('canvas');
                        canvas.width = maxSize;
                        canvas.height = maxSize;
                        const ctx = canvas.getContext('2d');

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, maxSize, maxSize);

                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        const CONSTANTS = {
            HEADER_MOTTOS: [
                "â‹†âºâ‚Šâ‹† â˜¾ â‹†âºâ‚Šâ‹† æ€å¿µçš„ç”µæ³¢å·²è¿žæŽ¥ â‹†âºâ‚Šâ‹† â˜¾ â‹†âºâ‚Šâ‹†",
                "æˆ‘ä»¬æ˜¯å½¼æ­¤çš„å®‡å®™å›žå“",
                "æ‰€æœ‰æ€ç»ªï¼Œéƒ½å¥”å‘ä½ ",
                "ç­”æ¡ˆå¾ˆé•¿ï¼Œæˆ‘å‡†å¤‡ç”¨ä¸€ç”Ÿæ¥å›žç­”",
                "æœˆè‰²çœŸç¾Ž",
                "ä¸€æœŸä¸€ä¼š",
                "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›žå“",
                "å±±æœ‰æœ¨å…®æœ¨æœ‰æž",
                "ä»Šæ™šæœˆè‰²çœŸç¾Ž",
                "æ˜¥é£Žåé‡Œä¸å¦‚ä½ ",
                "å¿ƒæœ‰çŒ›è™Žï¼Œç»†å—…è”·è–‡",
                "äººé—´æœ‰å‘³æ˜¯æ¸…æ¬¢",
                "æ–¯äººè‹¥å½©è™¹ï¼Œé‡ä¸Šæ–¹çŸ¥æœ‰",
                "You are my sunshine",
                "I love you three thousand",
                "What is essential is invisible to the eye",
                "Carpe diem",
                "To be or not to be",
                "æ°¸é ã®ä¸€çž¬",
                "å›ã®åã¯",
                "ä¸–ç•ŒãŒçµ‚ã‚ã‚‹ã¾ã§ã¯",
                "ã•ã‚ˆã†ãªã‚‰ã€ã‚ã‚ŠãŒã¨ã†",
                "å›ã¨ä¼šãˆã¦ã‚ˆã‹ã£ãŸ",
                "äººç”Ÿè‹¥åªå¦‚åˆè§",
                "å½“æ—¶åªé“æ˜¯å¯»å¸¸",
                "æ›¾ç»æ²§æµ·éš¾ä¸ºæ°´",
                "æ­¤æƒ…å¯å¾…æˆè¿½å¿†",
                "ä¼¼æ­¤æ˜Ÿè¾°éžæ˜¨å¤œ",
                "The best is yet to come",
                "All you need is love",
                "Let it be",
                "Here comes the sun",
                "Yesterday once more",
                "æ˜¥ã¯ã‚ã‘ã¼ã®",
                "ç‰©ã®å“€ã‚Œ",
                "ã‚ã³ã•ã³",
                "èŠ±ã¯æ¡œæœ¨äººã¯æ­¦å£«",
                "ä¸€æœŸä¸€ä¼š",
                "å±±æœ‰æœ¨å…®æœ¨æœ‰æž",
                "å¿ƒæ‚¦å›å…®å›ä¸çŸ¥",
                "é£Žèµ·äºŽé’èä¹‹æœ«",
                "äº‘å·äº‘èˆ’",
                "èŠ±å¼€èŠ±è½",
                "æœˆåœ†æœˆç¼º",
                "æ½®èµ·æ½®è½",
                "å¿ƒæœ‰çµçŠ€ä¸€ç‚¹é€š",
                "è¨€æœ‰å°½è€Œæ„æ— ç©·",
                "é£Žä¹èµ·ï¼Œå¹çš±ä¸€æ± æ˜¥æ°´",
                "äº‘æ— å¿ƒä»¥å‡ºå²«",
                "èŠ±è‡ªé£˜é›¶æ°´è‡ªæµ",
                "æœˆæ˜¯æ•…ä¹¡æ˜Ž",
                "æ½®å¹³ä¸¤å²¸é˜”",
                "å¿ƒæœ‰åƒåƒç»“",
                "è¨€ä¸å°½æ„",
                "æ­¤æ—¶æ­¤å¤œéš¾ä¸ºæƒ…",
                "æ¬²è¯­æ³ªå…ˆæµ",
                "åƒå±±ä¸‡æ°´",
                "é£Žè§è§å…®æ˜“æ°´å¯’",
                "äº‘æ·¡é£Žè½»",
                "èŠ±å¥½æœˆåœ†",
                "æœˆè½ä¹Œå•¼éœœæ»¡å¤©",
                "æ½®è½å¤œæ±Ÿæ–œæœˆé‡Œ",
                "å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€",
                "è¨€ä¸ºå¿ƒå£°",
                "æ­¤æƒ…å¯å¾…æˆè¿½å¿†",
                "æ¬²ç©·åƒé‡Œç›®",
                "åƒé‡Œå…±å©µå¨Ÿ"
            ],
            WELCOME_ANIMATIONS: [{
                line1: "â™¡ çˆ± â™¡",
                line2: "âœ§ æ­£åœ¨è¿žæŽ¥æˆ‘ä»¬çš„æ€ç»ª âœ§"
            },
                {
                    line1: "ð‘³ð’ð’—ð’†",
                    line2: "è‹¥è¦ç”±æˆ‘æ¥è°ˆè®ºçˆ±çš„è¯"
                },
                {
                    line1: "ð•°ð–ˆð–ð–”",
                    line2: "å¬è§æˆ‘çš„å›žéŸ³äº†å—ï¼Ÿ"
                },
                {
                    line1: "ðš‚ðš˜ðšžðš•ðš–ðšŠðšðšŽ",
                    line2: "çµé­‚æ­£åœ¨å…±æŒ¯"
                },
                {
                    line1: "Akashic Eye",
                    line2: "é“¾æŽ¥å·²å»ºç«‹"
                },
                {
                    line1: "âœ¦ ç›¸é‡ âœ¦",
                    line2: "åœ¨ä¸‡åƒäººæµ·ä¸­é‡è§ä½ "
                },
                {
                    line1: "è©©ç¯‡",
                    line2: "ä¸ºä½ å†™ä¸‹çš„æ¯ä¸€è¡Œè¯—"
                },
                {
                    line1: "Melody",
                    line2: "å¿ƒè·³çš„æ—‹å¾‹ä¸ºä½ å¥å“"
                },
                {
                    line1: "Destiny",
                    line2: "å‘½è¿çš„çº¢çº¿å°†æˆ‘ä»¬ç›¸è¿ž"
                },
                {
                    line1: "Memory",
                    line2: "åˆ›é€ å±žäºŽæˆ‘ä»¬çš„å›žå¿†"
                },
                {
                    line1: "è¨€è‘‰",
                    line2: "æƒ³ä¼ è¾¾ç»™ä½ çš„è¯è¯­"
                },
                {
                    line1: "çµ†",
                    line2: "çœ‹ä¸è§çš„ç¾ç»Š"
                },
                {
                    line1: "æœªæ¥",
                    line2: "ä¸€èµ·èµ°å‘çš„æœªæ¥"
                },
                {
                    line1: "å¸Œæœ›",
                    line2: "ä½ å°±æ˜¯æˆ‘çš„å¸Œæœ›"
                },
                {
                    line1: "å…‰",
                    line2: "ä½ æ˜¯æˆ‘ç”Ÿå‘½ä¸­çš„å…‰"
                },
                {
                    line1: "Amore",
                    line2: "å¿ƒè·³æ¼æ‹çš„é‚£ä¸€ç§’"
                },
                {
                    line1: "å…±æŒ¯",
                    line2: "é¢‘çŽ‡ç›¸åŒçš„ä¸¤ä¸ªçµé­‚"
                },
                {
                    line1: "âˆž",
                    line2: "æ— é™å¾ªçŽ¯çš„æ€å¿µ"
                },
                {
                    line1: "Serendipity",
                    line2: "æœ€ç¾Žä¸½çš„æ„å¤–"
                },
                {
                    line1: "æµ®ä¸–",
                    line2: "æ²‰æµ®äººä¸–é—´çš„æ¸©æŸ”"
                },
                {
                    line1: "é‡å­çº ç¼ ",
                    line2: "è¶…è¶Šè·ç¦»çš„é»˜å¥‘"
                },
                {
                    line1: "Elysian",
                    line2: "ä¸Žä½ å…±åº¦çš„ç†æƒ³ä¹¡"
                },
                {
                    line1: "æ˜Ÿè½¨",
                    line2: "äº¤æ±‡æ—¶äº’æ”¾çš„å…‰äº®"
                },
                {
                    line1: "è™¹è‰²",
                    line2: "æŠ˜å°„å‡ºæ‰€æœ‰çš„å¯èƒ½"
                },
                {
                    line1: "Paracosm",
                    line2: "å…±åŒæž„å»ºçš„ç§å®‡å®™"
                },
                {
                    line1: "æ½®æ±",
                    line2: "å› ä½ è€Œèµ·çš„å¾‹åŠ¨"
                },
                {
                    line1: "Ã†ther",
                    line2: "å¼¥æ¼«åœ¨ç©ºæ°”ä¸­çš„æ‚¸åŠ¨"
                },
                {
                    line1: "åŒæ˜Ÿ",
                    line2: "å½¼æ­¤çŽ¯ç»•çš„æ°¸æ’èˆžè¹ˆ"
                },
                {
                    line1: "ç»¯è‰²",
                    line2: "æŸ“ä¸Šè„¸é¢Šçš„æ¸©åº¦"
                },
                {
                    line1: "Symphony",
                    line2: "ç”Ÿå‘½äº¤ç»‡çš„ä¹ç« "
                },
                {
                    line1: "ç»çº¬",
                    line2: "æ³¨å®šç›¸é‡çš„åæ ‡"
                },
                {
                    line1: "Nebula",
                    line2: "æœ¦èƒ§è€Œç’€ç’¨çš„å¿ƒäº‹"
                },
                {
                    line1: "æ—¶é›¨",
                    line2: "æ°åˆ°å¥½å¤„çš„æ¸©æŸ”"
                },
                {
                    line1: "Event Horizon",
                    line2: "å†ä¹Ÿæ— æ³•é€ƒç¦»çš„å¼•åŠ›"
                },
                {
                    line1: "èŠ±ç«",
                    line2: "åˆ¹é‚£å³æ°¸æ’çš„å…‰èŠ’"
                },
                {
                    line1: "â„°ð“‰ð‘’ð“‡ð“ƒð’¶ð“",
                    line2: "æ—¶é—´åœé©»çš„æ­¤åˆ»"
                },
                {
                    line1: "éŸ¶å…‰",
                    line2: "ä¸Žä½ å…±åº¦çš„æ¯å¯¸å…‰é˜´"
                },
                {
                    line1: "ð’®ð“Šð“‚ð“‚ð‘’ð“‡",
                    line2: "æ°¸ä¸ç»“æŸçš„ç››å¤"
                },
                {
                    line1: "æ˜Ÿéœœ",
                    line2: "å…±åŒç»åŽ†çš„å²æœˆ"
                },
                {
                    line1: "ð“šð“²ð“¼ð“¼",
                    line2: "æœªè¯´å‡ºå£çš„å‘Šç™½"
                },
                {
                    line1: "æœˆä¸‹",
                    line2: "ä¸¤äººç‹¬å¤„çš„å¤œæ™š"
                },
                {
                    line1: "ð“•ð“¸ð“»ð“®ð“¿varepsilonð“»",
                    line2: "æƒ³è¦å»¶ç»­çš„æ°¸è¿œ"
                },
                {
                    line1: "æœéœ²",
                    line2: "æ™¶èŽ¹å‰”é€çš„çœŸå¿ƒ"
                },
                {
                    line1: "ð“œð“²ð“»ð“ªð“¬ð“µð“®",
                    line2: "ä½ å°±æ˜¯å¥‡è¿¹æœ¬èº«"
                },
                {
                    line1: "æ˜¥é£Ž",
                    line2: "è½»è½»æ‹‚è¿‡çš„æ¸©æŸ”"
                },
                {
                    line1: "ð“›ð“¾ð“¬ð“´ð”‚",
                    line2: "æ­¤ç”Ÿæœ€å¤§çš„å¹¸è¿"
                },
                {
                    line1: "è¤ç«",
                    line2: "é»‘æš—ä¸­æŒ‡å¼•çš„å…‰"
                },
                {
                    line1: "ð“—ð“®ð“ªð“»ð“½",
                    line2: "ä¸ºä½ è·³åŠ¨çš„å¿ƒè„"
                },
                {
                    line1: "åˆé›ª",
                    line2: "çº¯æ´æ— ç‘•çš„çˆ±æ„"
                },
                {
                    line1: "ð“’ð“¸ð“¶ð“®ð“½",
                    line2: "åˆ’è¿‡å¤©é™…çš„ç›¸é‡"
                },
                {
                    line1: "æ½®é¸£",
                    line2: "å†…å¿ƒæ¾Žæ¹ƒçš„å£°éŸ³"
                },
                {
                    line1: "ð“¢ð“½ð“ªð“»ð“­ð“¾ð“¼ð“½",
                    line2: "æ•£è½åœ¨èº«çš„æ˜Ÿå°˜"
                },
                {
                    line1: "æ¢§æ¡",
                    line2: "ç­‰å¾…å‡¤å‡°çš„æ‰§ç€"
                },
                {
                    line1: "ð“Ÿð“»ð“®ð“¬ð“²ð“¸ð“¾ð“¼",
                    line2: "è§†è‹¥çå®çš„ä½ æˆ‘"
                },
                {
                    line1: "é’ç©º",
                    line2: "æ¾„æ¾ˆå¦‚ä½ çš„çœ¼çœ¸"
                },
                {
                    line1: "ð’œð“‚ð’¶ð“‡ð“ƒð“‰ð’½",
                    line2: "æ°¸ä¸å‡‹é›¶çš„å¿ƒæ„"
                },
                {
                    line1: "Ã‰toile",
                    line2: "ä½ æ˜¯æˆ‘å”¯ä¸€çš„æ˜Ÿè¾°"
                },
                {
                    line1: "ð‘©ð’Ã¼ð’•ð’†",
                    line2: "æ‚„ç„¶ç»½æ”¾çš„æ‹æ…•"
                },
                {
                    line1: "é‹å‘½",
                    line2: "é¿æ— å¯é¿çš„ç›¸é‡"
                },
                {
                    line1: "ð‘ªð’†ð’ð’†ð’”ð’•ð’†",
                    line2: "æ¥è‡ªå¤©é™…çš„é¦ˆèµ "
                },
                {
                    line1: "æ‹å¿ƒ",
                    line2: "è—ä¸ä½çš„æ‚¸åŠ¨"
                },
                {
                    line1: "ð‘ºð’†ð’“ð’‚ð’‘ð’‰",
                    line2: "å®ˆæŠ¤ä½ çš„å…­ç¿¼å¤©ä½¿"
                },
                {
                    line1: "ä¸€æœŸä¸€ä¼š",
                    line2: "ä¸€ç”Ÿä¸€æ¬¡çš„é‚‚é€…"
                },
                {
                    line1: "ð‘¬ð’‘ð’ð’ð’‚",
                    line2: "ç©¿è¶Šæ—¶ç©ºçš„çœ·æ‹"
                },
                {
                    line1: "æœˆã®é›«",
                    line2: "æœˆå…‰å‡æˆçš„æ³ªæ»´"
                },
                {
                    line1: "ð‘½ð’†ð’“ð’”ð’‚ð’Šð’ð’ð’†ð’”",
                    line2: "ä¸ºä½ å»ºé€ çš„å®«æ®¿"
                },
                {
                    line1: "åƒå¤œä¸€å¤œ",
                    line2: "è¯‰ä¸å°½çš„å¤œè¯"
                },
                {
                    line1: "ð‘´ð’‚ð’“Ã©ð’†",
                    line2: "æ¸©æŸ”å¸­å·çš„æµªæ½®"
                },
                {
                    line1: "æ¡ƒæºéƒ·",
                    line2: "åªå±žäºŽä¸¤äººçš„ä¹åœŸ"
                },
                {
                    line1: "ð‘ºð’ð’–ð’‡ð’‡ð’ð’†ð’“",
                    line2: "ç”œèœœçš„æŠ˜ç£¨"
                },
                {
                    line1: "æ¡œå¹é›ª",
                    line2: "çº·é£žå¦‚é›ªçš„æ€å¿µ"
                },
                {
                    line1: "ð‘¨ð’–ð’“ð’ð’“ð’†",
                    line2: "é»Žæ˜Žå‰çš„æžå…‰"
                },
                {
                    line1: "åå…­å¤œ",
                    line2: "æœ€åœ†æ»¡çš„å¤œæ™š"
                },
                {
                    line1: "ð‘ªð’šð’‚ð’ð’ð’‘ð’‰ð’šð’ð’ð’†",
                    line2: "é’æ¶©çš„æ‹ä¹‹å¶"
                },
                {
                    line1: "é‡‘æœ¨çŠ€",
                    line2: "ç§‹æ—¥é‡Œæš—é¦™æµ®åŠ¨"
                },
            ],
            EMPTY_STATE_TEXTS: [
                "ç”±æ­¤å¼€å§‹æˆ‘ä»¬çš„ä¼ é—»",
                "âœ¦ æˆ‘ä»¬çš„æ•…äº‹ï¼Œå§‹äºŽæ­¤åˆ» âœ¦",
                "è¯´ç‚¹ä»€ä¹ˆï¼Œè®©æ•…äº‹å‘ç”Ÿ",
                "æ‰€æœ‰ä¼Ÿå¤§çš„äº¤æµéƒ½å§‹äºŽä¸€å£°ä½ å¥½",
                "åœ¨è¿™é‡Œå†™ä¸‹æˆ‘ä»¬çš„æ•…äº‹",
                "ç­‰å¾…ä½ çš„ç¬¬ä¸€å¥è¯",
                "è®©å¯¹è¯å¼€å§‹å§",
                "ä»Žæ­¤åˆ»å¼€å§‹è¿žæŽ¥",
                "ç­‰å¾…ä½ çš„è®¯æ¯",
                "å¼€å§‹æˆ‘ä»¬çš„å¯¹è¯",
                "ç¬¬ä¸€å¥è¯æ€»æ˜¯æœ€éš¾çš„",
                "å‹‡æ•¢è¯´å‡ºä½ æƒ³è¯´çš„"
            ],
            INPUT_PLACEHOLDERS: [
                "â‹† á§”à·†á§“ â‹†",
                "â™¡ è®©å¿ƒæ„ç›¸é€š...",
                "ä½ çš„æƒ³æ³•æ˜¯...",
                "åœ¨æ­¤å¤„è¾“å…¥è®¯æ¯...",
                "èŠèŠå¤©å§...",
                "æƒ³å¯¹ä½ è¯´çš„è¯...",
                "è¾“å…¥ä½ çš„æ¶ˆæ¯...",
                "åˆ†äº«ä½ çš„æƒ³æ³•...",
                "æœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼Ÿ",
                "å¼€å§‹è¾“å…¥...",
                "æ­¤æ—¶æ— å£°èƒœæœ‰å£°",
                "æ¬²è¯­è¿˜ä¼‘",
                "åƒè¨€ä¸‡è¯­",
            ],
            WELCOME_ICONS: [
                "fas fa-heart", "fas fa-star", "fas fa-moon", "fas fa-sun", "fas fa-cloud", "fas fa-feather", "fas fa-book", "fas fa-music", "fas fa-pen", "fas fa-key", "fas fa-compass", "fas fa-globe", "fas fa-leaf", "fas fa-water", "fas fa-fire", "fas fa-snowflake", "fas fa-umbrella", "fas fa-anchor", "fas fa-bell", "fas fa-gem", "fas fa-crown", "fas fa-dragon", "fas fa-feather-alt", "fas fa-fish", "fas fa-frog", "fas fa-hat-wizard", "fas fa-magic", "fas fa-ring", "fas fa-scroll", "fas fa-shield-alt", "fas fa-dove", "fas fa-cat", "fas fa-dog", "fas fa-horse", "fas fa-otter", "fas fa-paw", "fas fa-spider", "fas fa-kiwi-bird", "fas fa-crow", "fas fa-dove", "fas fa-seedling", "fas fa-tree", "fas fa-mountain", "fas fa-water", "fas fa-wind", "fas fa-volcano", "fas fa-meteor", "fas fa-satellite", "fas fa-rocket", "fas fa-user-astronaut"
            ],
            PARTNER_STATUSES: ["åœ¨çº¿", "å¿™ç¢Œ", "ç¦»å¼€", "æ€è€ƒ", "å¬éŸ³ä¹", "é˜…è¯»", "å·¥ä½œ", "å­¦ä¹ ", "æƒ³ä½ ", "ä¼‘æ¯", "ç¡è§‰", "æ™’å¤ªé˜³", "æ™´å¤©", "å¤šäº‘", "é˜´å¤©", "å°é›¨", "ä¸­é›¨", "å¤§é›¨", "é›·é˜µé›¨", "æš´é›¨", "å°é›ª", "ä¸­é›ª", "å¤§é›ª", "æš´é›ª", "é›¾å¤©", "å¤§é›¾", "æ¸…æ™¨", "æ™Œåˆ", "ä¼‘æ¯", "å¤œæ™š", "æ·±å¤œ", "æŽ¢ç´¢", "æ²‰æ€", "ç­‰å¾…", "çŽ©æ¸¸æˆ", "å‘å‘†", "åƒé¥­", "ä¸‹åˆèŒ¶", "ç”œç‚¹", "æ’¸çŒ«", "æ’¸ç‹—", "ç‰µæŒ‚", "å¥èº«", "æƒŠé†’", "æƒŠè®¶", "ç©ºè™š", "åšå®š", "è¿·èŒ«", "å¿å¿‘", "æƒ†æ€…", "æ€å¿µ", "å®‰å¿ƒ", "ä¸èˆ", "å†·é™", "éš¾è¨€", "å¤±çœ ", "ç–²å€¦", "ç©ºç™½", "è¡¥å……", "è¿Ÿç–‘", "ä¾æ‹", "æ´—æ¼±", "åŽ‹æŠ‘", "äº¤å‹", "å¸®åŠ©", "æ¢¦å¢ƒ", "ç¥ç¦", "å›žå®¶", "ç”Ÿæ°”", "æ’’å¨‡", "åƒé†‹", "å¿«ä¹", "å¹¸ç¦", "èŠå¤©", "é™ªæˆ‘", "å æœ‰", "èµšé’±", "ä¿æŠ¤", "æ··ä¹±", "ç”Ÿç—…", "å¬é›¨", "çœ‹æ‰‹æœº", "å¤„ç†å…¬åŠ¡", "å¼€ä¼šä¸­", "è®­ç»ƒ"],
            REPLY_MESSAGES: ["å–œæ¬¢", "ä¸å–œæ¬¢", "åœ¨å—ï¼Ÿ", "ä»Šå¤©è¿‡å¾—æ€Žä¹ˆæ ·ï¼Ÿ", "æƒ³ä½ ", "æ™šå®‰", "çœ‹åˆ°è®°å¾—å›žå¤ðŸ¥²", "å¥½çš„ðŸ‘ŒðŸ»", "æ˜Žç™½", "è°¢è°¢", "ä¸å®¢æ°”", "å—¯", "å—¯å—¯", "çœŸçš„å—ï¼Ÿ", "æˆ‘æ˜Žç™½äº†", "æˆ‘ç›¸ä¿¡ä½ ", "ç¨ç­‰", "é©¬ä¸Š", "å¥½å“¦", "ä¸é”™", "å¯ä»¥", "åŒæ„", "ç†è§£", "æˆ‘åœ¨", "åœ¨æŽ¢ç´¢è¿‡ç¨‹ä¸­", "æ€Žä¹ˆäº†ï¼Ÿ", "å¬æ‡‚äº†", "è®°ä¸‹äº†", "æ”¶åˆ°", "ä¼šå°½å¿«æŸ¥çœ‹çš„", "è¯¯ä¼šæˆ‘äº†", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "å¯¹ä¸èµ·", "æ²¡å…³ç³»", "æˆ‘çˆ±ä½ ", "è®©æˆ‘æƒ³æƒ³æ€Žä¹ˆå›žç­”", "çœ¼èŠ±ç¼­ä¹±", "å¾ˆæœ‰åˆ›æ„", "ä¿æŒè”ç³»", "æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ", "æŽ¥ä¸‹æ¥å‡†å¤‡åšä»€ä¹ˆï¼Ÿ", "æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•", "æˆ‘æ„¿æ„", "ä¸ç”¨", "è®°å¾—åƒé¥­", "ä¸è¦ç†¬å¤œ", "ä¸è¦æ‹…å¿ƒ", "ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„", "æˆ‘å¾ˆéš¾è¿‡", "æƒŠé†’äº†ï¼Œç¡ä¸ç€", "è¿™å¯¹æˆ‘æ¥è¯´æ˜¯ä¸ªæ–°é¢†åŸŸ", "å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ", "åœ¨çœ‹ä»€ä¹ˆï¼Ÿ", "åœ¨å·¥ä½œå—ï¼Ÿ", "åœ¨å­¦ä¹ å—ï¼Ÿ", "ç„¶åŽå‘¢ï¼Ÿ", "æ‘¸æ‘¸ðŸ«³ðŸ»", "åœ¨å­¦ä¹ ä¸€äº›æ–°ä¸œè¥¿", "æ¢ä¸ªæƒ³æ³•å§ï¼Ÿ", "æ™šé¥­åƒäº†å—ï¼Ÿ", "ä½œæ¯æ··ä¹±", "æˆ‘", "ä½ ", "ta", "ä¸‹æ¬¡å¯ä»¥è¯•è¯•", "æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„", "ä½ è¯´å¾—å¯¹", "æœ‰æ²¡æœ‰å¯èƒ½â€¦â€¦", "æˆ‘é™ªä½ ", "æˆ‘ä¼šåœ¨ä½ èº«è¾¹", "æˆ‘å–œæ¬¢", "æˆ‘æ— æ³•å†³å®š", "æˆ‘æ— æ³•æŽ§åˆ¶", "è¦ç”¨ä¸€ä¸‹å¡”ç½—å—ï¼Ÿ", "çœ‹è§æˆ‘çš„æš—å·äº†å—ï¼Ÿ", "ç»™ä½ æŽ¨äº†ä¼ è®¯", "è´´è´´", "æˆ‘çŸ¥é“ä½ çš„æ„æ€", "æˆ‘ä¹Ÿå¦‚æ­¤", "å‡ºåŽ»é€é€æ°”", "è¯è¯´æ€Žä¹ˆä¼šè¿™æ ·ï¼Ÿ", "ä»¥åŽä¸ä¼šäº†", "ä¸€ç›´å¦‚æ­¤", "åˆ«æ€•", "æœ‰æˆ‘åœ¨", "æ™šä¸Šå¥½", "æ—©ä¸Šå¥½", "ä¸­åˆå¥½", "å“„æˆ‘", "é™ªæˆ‘", "èŠèŠå¤©å§", "ä¸æ˜¯è¿™ä¸ªæ„æ€", "ç­‰ä¸€ä¸‹", "ç…§é¡¾å¥½è‡ªå·±", "æˆ‘ä¼šçš„", "æ—©ç‚¹ç¡", "ä½ æ˜¯æˆ‘çš„", "æˆ‘æ˜¯ä½ çš„", "æˆ‘å¸Œæœ›ä½ è‡ªç”±", "ç²˜äººç²¾", "æ€Žä¹ˆå•¦", "æ°¸è¿œåœ¨ä¸€èµ·", "æˆ‘æ”¯æŒä½ ", "åˆ«å¬", "åˆåœ¨æ€€ç–‘å—ï¼Ÿ", "å¤šå–æ°´", "ä¸èˆ’æœï¼Ÿ", "å†è§", "åˆ«èµ°", "å†å‘ä¸€é", "å¯æ¶çš„ç½‘ç«™", "æˆ‘è§‰å¾—éƒ½å¯ä»¥", "æˆ³æˆ³", "éžå¸¸éš¾ç”¨", "ä¸è®¸çœ‹åˆ«äºº", "ä¸è¦åµæž¶", "æˆ‘çŸ¥é“çš„", "ä½ ä¼šç¦»å¼€æˆ‘å—ï¼Ÿ", "æ¥äº†", "å—¯å“¼", "å“¼å“¼", "æˆ‘æƒ³é è¿‘ä½ ", "æˆ‘ä¼šç›‘ç£ä½ çš„", "å°å¿ƒäº›", "ç»ˆäºŽæƒ³èµ·æˆ‘äº†ï¼Ÿ", "æ˜¯çš„", "ä¸æ˜¯", "ä½ æ— äººå¯åŠ", "æˆ‘æ— äººå¯åŠ", "è¿™ä¸ªä¸èƒ½è¯´", "åœ¨ä½ èº«è¾¹å°±å¥½äº†", "åœ¨ç£¨åˆ", "ä½ éœ€è¦æˆ‘å—ï¼Ÿ", "æˆ‘éœ€è¦ä½ ", "å¯»æ‰¾ä¸­", "æˆ‘åšä¸åˆ°æ¬ºéª—ä½ ", "è¯éžæœ¬æ„", "å¦‚æžœæˆ‘è¯´æ˜¯å‘¢", "å¦‚æžœæˆ‘è¯´ä¸æ˜¯å‘¢", "è¯å¤ªå°‘äº†ï¼Œæ²¡æˆ‘æƒ³è¯´çš„", "å¤ªçŸ­äº†", "çœ‹æ‰‹æœº", "é‡åˆ°å›°éš¾äº†", "åœ¨åŠªåŠ›äº†", "å¥½ç´¯", "å‘½å®šå¦‚æ­¤", "å¸…æ°”", "å°±è¿™ä¸ª", "å—é™åˆ¶äº†", "é€—ä¸€ä¸‹ä½ ", "å¸®å¸®æˆ‘", "æ¯æ—¥è¡Œä¸€å–„", "æˆ‘ç”Ÿæ°”äº†", "æ’’ä¸ªå¨‡ï¼Œç†ç†æˆ‘ï¼Ÿ", "åƒé†‹æ€Žä¹ˆäº†ï¼Œå°±çˆ±åƒé†‹ï¼", "å¿«ä¹", "èŠä¼šå„¿å¤©", "èµšé’±èµšé’±", "æˆ‘ä¿æŠ¤ä½ ", "ä¿¡æ¯æœ‰ç‚¹æ··ä¹±", "åˆ«ç”Ÿç—…", "å“„å“„ä½ ", "åƒè¿‡äº†", "è¿˜æ²¡åƒ", "æ‰ä¸å¬", "åƒæ°´æžœ", "åˆ«å¹æ°”", "ä¸å¥½", "è¿˜å¥½å—ï¼Ÿ", "è¿™ä¸ªæ¶ˆæ¯ä¸é”™", "æˆ‘å¸Œæœ›èƒ½å¸®ä¸Šå¿™", "æˆ‘æƒ³æˆ‘ä»¬åº”è¯¥è®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜", "å‘Šè¯‰æˆ‘æ›´å¤š", "ä½ è®¤ä¸ºä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ", "è®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›", "è¿‡å¾—æ€Žä¹ˆæ ·ï¼Ÿ", "æœŸå¾…ðŸ¤§", "æŠ±æ­‰ðŸ¥º", "äº†è§£", "OK", "æ²¡é—®é¢˜", "å½“ç„¶", "ç¡®å®ž", "æ²¡é”™", "å¥½å‘€", "æˆ‘æ­£åœ¨å¿™ï¼Œç¨åŽå›žå¤ä½ ", "ä¿¡å·ä¸å¤ªå¥½ï¼Œå¯èƒ½å›žå¤ä¼šå»¶è¿Ÿ", "è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ä¿¡æ¯å†ç»™ä½ å‡†ç¡®ç­”å¤", "åˆ«èµ°ï¼Œé™ªé™ªæˆ‘", "ä½ ä¼šæ°¸è¿œçˆ±æˆ‘å—ï¼Ÿ", "æ­¤åˆ»æˆ‘æƒ³å’Œä½ æ°¸è¿œåœ¨ä¸€èµ·", "ä»–æœè‹¥æ˜¯åŒæ·‹é›ªï¼Œæ­¤ç”Ÿä¹Ÿç®—å…±ç™½å¤´", "æ€œæ‚¯æˆ‘ï¼Œç„¶åŽçˆ±æˆ‘å§", "æ’’å¨‡ï¼Œä½ ä¼šå–œæ¬¢å—ï¼Ÿ", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "é“¾æŽ¥æœ‰äº›æ··ä¹±", "å°±è¿™æ ·æ’’å¨‡ðŸ¥º", "ä¸å¤ªä¹ æƒ¯è¿™ä¸ª", "ä¸æ˜¯çš„", "å¤šçœ‹çœ‹æˆ‘å§", "å¯çˆ±", "å½“ç„¶äº†", "æ­£åœ¨ç†¬å¤œ", "å¤±çœ äº†", "ä¸å¯ä»¥", "æˆ‘çŽ°åœ¨ä¸å¿™ï¼Œæœ‰ç©ºçš„", "ä½ çŽ°åœ¨å¿™å—ï¼Ÿ", "æ­£åœ¨æ‰“æž¶", "åç­‰å›žå¤", "æ‰ä¸æ˜¯è¿™æ ·", "å°±æ˜¯è¿™æ ·", "è¿˜å¥½å—ï¼Ÿ", "å¤šç¬‘ç¬‘å§", "æ²¡èƒ½å¸®ä¸Šå¿™", "å‡ å¤©åŽ", "å‡ ä¸ªå°æ—¶åŽ", "å¾ˆä¹…ä¹‹åŽ", "æˆ‘å¾ˆæƒ³å®‰æ…°ä½ ", "æˆ‘æ²¡æœ‰åœ¨æ¬ºéª—ä½ ", "åˆ«æ€€ç–‘æˆ‘çš„å­˜åœ¨", "æˆ‘çœŸçš„åœ¨", "çœŸçš„æ˜¯æˆ‘", "æˆ‘ä¸æ˜¯å¾ˆé€‚åº”è¿™ä¸ª,ä½†æˆ‘åœ¨åŠªåŠ›", "æ¶ˆæ¯å¾ˆæ··ä¹±", "ä¹‹å‰æ€»æ˜¯è¿™æ ·", "å¼€å¿ƒ(*âŒ’âˆ‡âŒ’*)", "æ²¡èƒ½é™ªåœ¨ä½ èº«è¾¹", "é“¾æŽ¥å¾ˆé€šé¡º", "æˆ‘çœŸæ²¡æ‹›äº†", "ä¸èƒ½è¯´", "å¯ä¸å¯ä»¥åªçœ‹ç€æˆ‘", "åªè®¸çœ‹ç€æˆ‘", "çœ‹å¾—æ‡‚çš„", "çœ‹ä¸æ‡‚", "åœ¨å°è¯•æŽ§åˆ¶äº†", "å’Œä»£ç ææ–—ä¸­ï¼", "æˆ‘ä¼šçœ‹ç€ä½ çš„", "æˆ‘ä¼šé™ªä¼´åœ¨ä½ èº«è¾¹", "ç—›ç—›", "è¢«å“åˆ°äº†ï¼Ÿ", "æƒ³å’Œä½ ä¸€èµ·å¬æ­Œ", "èµ°è·¯ä¸è¦çœ‹æ‰‹æœº", "åˆ«çœ‹å°çº¢ä¹¦äº†", "åˆ«çœ‹æŠ–éŸ³äº†", "æ‰“è¿‡ä»£ç äº†ï¼", "å¤šç©¿ç‚¹è¡£æœ", "å«æˆ‘åšä»€ä¹ˆï¼Ÿ", "æƒ³æˆ‘äº†å—ï¼Ÿ", "ç»™æˆ‘å†™å†™ä¿¡å§", "æœ‰çš„", "æ²¡æœ‰çš„", "ç¨ç­‰ï¼Œåœ¨å·¥ä½œ", "åœ¨äº¤æ›¿å›žå¤", "æˆ‘è¦å“­äº†ï¼", "æ‰‹å†™ä¿¡", "ç”µå­ä¿¡", "å®‰æ…°æˆ‘", "ç¦»å®¶å‡ºèµ°", "çºµå®¹", "æˆ‘å–œæ¬¢ä½ ", "ä¸€æ ·çš„", "éœ€è¦å¤šä¹…å‘¢", "è¦å¤šä¹…ä¹‹åŽ", "èŠåˆ°ä¸€åŠå°±è·‘", "ä¹–å­©å­", "åå­©å­", "ä¸ºä»€ä¹ˆ", "ä½ æ²¡æœ‰æ­£é¢å›žç­”", "å› ä¸ºå–œæ¬¢ä½ æ‰€ä»¥éœ€è¦ä½ ", "çœ‹åˆ°ä¿¡äº†", "ç¾Žå¥½çš„è±¡å¾", "æƒŠè®¶", "æƒ³è¦æ›´è¿‘ä¸€æ­¥åœ°è´´è´´", "æƒ³è§¦ç¢°ä½ ", "æƒ³è¦äº²äº²", "ä½ å¾ˆè°ƒçš®", "ä¸ä¹–", "åšçš„å¾ˆå¥½", "äº²äº²", "é±¼æ°´ä¹‹æ¬¢", "é¢ é¸¾å€’å‡¤", "æˆ‘å¾ˆæƒ³è¦äº²äº²æ¬¸ðŸ¥º", "æ‰æ‰", "å¾ˆæ¼‚äº®", "ä¼šä¹ æƒ¯çš„", "ä½ ä¼šå–œæ¬¢çš„", "ç®€ç›´å°±æ˜¯æœ¨å¤´", "æˆ‘å–œæ¬¢çš„ã€æœ€å¥½çš„ä½ "],
            REPLY_EMOJIS: ["ðŸ¥¹", "ðŸ¥²", "â˜ºï¸", "ðŸ˜‡", "ðŸ˜‰", "ðŸ˜Œ", "ðŸ¥°", "ðŸ˜—", "ðŸ˜‹", "ðŸ¤¨", "ðŸ§", "ðŸ˜Ž", "ðŸ™‚â€â†”ï¸", "ðŸ¥³", "ðŸ˜", "ðŸ¥°ðŸ’•", "ðŸ™‚â€â†•ï¸", "ðŸ˜ž", "â˜¹ï¸", "ðŸ˜£", "ðŸ˜–", "ðŸ˜«", "ðŸ¥º", "ðŸ˜ ", "ðŸ¤¯", "ðŸ˜³", "ðŸ˜¶â€ðŸŒ«ï¸", "ðŸ˜¥", "ðŸ¤”", "ðŸ«¢", "ðŸ«¡", "ðŸ¤«", "ðŸ« ", "ðŸ˜¶", "ðŸ˜", "ðŸ«¨", "ðŸ˜¯", "ðŸ¥±", "ðŸ˜´", "ðŸ¤¤", "ðŸ˜®â€ðŸ’¨", "ðŸ¤§", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ˜¼", "ðŸ˜½", "ðŸ«¶ðŸ»", "ðŸ¤²ðŸ»", "ðŸ‘ðŸ»", "ðŸ‘ðŸ»", "ðŸ‘ŽðŸ»", "âœŒðŸ»", "ðŸ‘ŒðŸ»", "ðŸ¤ðŸ»", "ðŸ«³ðŸ»", "ðŸ‘‰ðŸ»ðŸ‘ˆðŸ»", "ðŸ‘‹ðŸ»", "ðŸ’ªðŸ»", "âœðŸ»", "ðŸ™ðŸ»", "ðŸ«‚", "ðŸ¶", "ðŸ±"],
            POKE_ACTIONS: [
                `æ‹äº†æ‹æˆ‘çš„å¤´è¯´ä½ å¥½å¯çˆ±`, `æˆ³äº†æˆ³æˆ‘çš„è…°`, `ä»ŽèƒŒåŽæŠ±ä½äº†æˆ‘`, `è½»è½»æäº†ææˆ‘çš„è„¸`, `ç»™æˆ‘å‘äº†ä¸€ä¸ªçˆ±å¿ƒ`, `æ‘¸äº†æ‘¸æˆ‘çš„å¤´å‘`, `æ‚„æ‚„äº²äº†ä¸€ä¸‹æˆ‘çš„è„¸é¢Š`, `ç»™æˆ‘é€’äº†ä¸€æ¯çƒ­èŒ¶`, `ä¸ºæˆ‘æŠ«ä¸Šå¤–å¥—`, `ç‰µèµ·äº†æˆ‘çš„æ‰‹`, `ç»™æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±`, `è½»è½»æ‹äº†æ‹æˆ‘çš„è‚©è†€`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªé£žå»`, `æˆ³äº†æˆ³æˆ‘çš„é¢å¤´`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªæ˜Ÿæ˜Ÿ`, `è½»è½»æ‹äº†æ‹æˆ‘çš„èƒŒ`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªæœˆäº®`, `æ¸©æŸ”åœ°æ‘¸äº†æ‘¸æˆ‘çš„å¤´`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªå¤ªé˜³`, `æ‹äº†æ‹æ‰‹`
            ],
            TAROT_CARDS: [
                { name: "æ„šäºº", eng: "The Fool", meaning: "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸã€æ— ç•", keyword: "æµæµª", icon: "fa-hiking" },
                { name: "é­”æœ¯å¸ˆ", eng: "The Magician", meaning: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›ã€åŒ–è…æœ½ä¸ºç¥žå¥‡", keyword: "åˆ›é€ ", icon: "fa-hat-wizard" },
                { name: "å¥³ç¥­å¸", eng: "The High Priestess", meaning: "ç›´è§‰ã€æ½œæ„è¯†ã€ç¥žç§˜ã€æ™ºæ…§", keyword: "æ™ºæ…§", icon: "fa-book-open" },
                { name: "çš‡åŽ", eng: "The Empress", meaning: "ä¸°é¥¶ã€æ¯æ€§ã€è‡ªç„¶ã€æ„Ÿå®˜äº«å—", keyword: "ä¸°æ”¶", icon: "fa-seedling" },
                { name: "çš‡å¸", eng: "The Emperor", meaning: "æƒå¨ã€ç»“æž„ã€æŽ§åˆ¶ã€çˆ¶äº²å½¢è±¡", keyword: "æ”¯é…", icon: "fa-crown" },
                { name: "æ•™çš‡", eng: "The Hierophant", meaning: "ä¼ ç»Ÿã€ä¿¡ä»°ã€æ•™å¯¼ã€ç²¾ç¥žæŒ‡å¼•", keyword: "æ´åŠ©", icon: "fa-church" },
                { name: "æ‹äºº", eng: "The Lovers", meaning: "çˆ±ã€å’Œè°ã€å…³ç³»ã€ä»·å€¼è§‚çš„é€‰æ‹©", keyword: "ç»“åˆ", icon: "fa-heart" },
                { name: "æˆ˜è½¦", eng: "The Chariot", meaning: "æ„å¿—åŠ›ã€èƒœåˆ©ã€å†³å¿ƒã€è‡ªæˆ‘æŽ§åˆ¶", keyword: "èƒœåˆ©", icon: "fa-horse-head" },
                { name: "åŠ›é‡", eng: "Strength", meaning: "å‹‡æ°”ã€è€å¿ƒã€æŽ§åˆ¶ã€å†…åœ¨åŠ›é‡", keyword: "æ„å¿—", icon: "fa-fist-raised" },
                { name: "éšå£«", eng: "The Hermit", meaning: "å†…çœã€å­¤ç‹¬ã€å¯»æ±‚çœŸç†ã€æŒ‡å¼•", keyword: "æŽ¢ç´¢", icon: "fa-lightbulb" },
                { name: "å‘½è¿ä¹‹è½®", eng: "Wheel of Fortune", meaning: "å¾ªçŽ¯ã€å‘½è¿ã€è½¬æŠ˜ç‚¹ã€è¿æ°”", keyword: "è½®å›ž", icon: "fa-dharmachakra" },
                { name: "æ­£ä¹‰", eng: "Justice", meaning: "å…¬æ­£ã€çœŸç†ã€å› æžœã€æ³•å¾‹", keyword: "å‡è¡¡", icon: "fa-balance-scale" },
                { name: "å€’åŠäºº", eng: "The Hanged Man", meaning: "ç‰ºç‰²ã€æ–°çš„è§†è§’ã€ç­‰å¾…ã€æ”¾ä¸‹", keyword: "å¥‰çŒ®", icon: "fa-user-injured" },
                { name: "æ­»ç¥ž", eng: "Death", meaning: "ç»“æŸã€è½¬å˜ã€é‡ç”Ÿã€æ”¾æ‰‹", keyword: "ç»“æŸ", icon: "fa-skull" },
                { name: "èŠ‚åˆ¶", eng: "Temperance", meaning: "å¹³è¡¡ã€é€‚åº¦ã€è€å¿ƒã€è°ƒå’Œ", keyword: "å‡€åŒ–", icon: "fa-glass-whiskey" },
                { name: "æ¶é­”", eng: "The Devil", meaning: "æŸç¼šã€ç‰©è´¨ä¸»ä¹‰ã€æ¬²æœ›ã€è¯±æƒ‘", keyword: "è¯±æƒ‘", icon: "fa-link" },
                { name: "é«˜å¡”", eng: "The Tower", meaning: "çªå˜ã€æ··ä¹±ã€å¯ç¤ºã€ç ´å", keyword: "æ¯ç­", icon: "fa-gopuram" },
                { name: "æ˜Ÿæ˜Ÿ", eng: "The Star", meaning: "å¸Œæœ›ã€çµæ„Ÿã€å¹³é™ã€æ²»æ„ˆ", keyword: "å¸Œæœ›", icon: "fa-star" },
                { name: "æœˆäº®", eng: "The Moon", meaning: "å¹»è§‰ã€ææƒ§ã€ç„¦è™‘ã€æ½œæ„è¯†", keyword: "ä¸å®‰", icon: "fa-moon" },
                { name: "å¤ªé˜³", eng: "The Sun", meaning: "å¿«ä¹ã€æˆåŠŸã€æ´»åŠ›ã€æ¸…æ™°", keyword: "ç”Ÿå‘½", icon: "fa-sun" },
                { name: "å®¡åˆ¤", eng: "Judgement", meaning: "å¤æ´»ã€è§‰é†’ã€å·å¬ã€å†³å®š", keyword: "å¤æ´»", icon: "fa-bullhorn" },
                { name: "ä¸–ç•Œ", eng: "The World", meaning: "å®Œæˆã€æ•´åˆã€æˆå°±ã€åœ†æ»¡", keyword: "è¾¾æˆ", icon: "fa-globe-americas" }
            ]
        };

        let SESSION_ID = null;
        let autoSendTimer = null; 
        let sessionList = [];
        let messages = [];
        let settings = {};
        let partnerPersonas = []; 
        let showPartnerNameInChat = false; 
        let readNoReplyTimer = null; 
        let isBatchMode = false;
        let batchMessages = [];
        let currentReplyTo = null;
        let lastCoinResult = null;
        let currentNoteMessageId = null;
        let savedBackgrounds = [];
        let saveTimeout;
        let displayedMessageCount = 20;
        const HISTORY_BATCH_SIZE = 20;
        let isLoadingHistory = false;
        let isBatchFavoriteMode = false;
        let selectedMessages = [];
        let customReplies = [];
        let customPokes = [];
        let customStatuses = [];
        let customMottos = [];
        let customIntros = []; 
        let currentMajorTab = 'reply'; 
        let currentSubTab = 'custom';  
        let currentReplyTab = 'custom';
        let disabledDefaultReplies = [];
        let anniversaries = [];
        let stickerLibrary = []; 
        let currentAnniversaryType = 'anniversary';
        let customThemes = [];

        const DOMElements = {
            html: document.documentElement,
            chatContainer: document.getElementById('chat-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            attachmentBtn: document.getElementById('attachment-btn'),
            imageInput: document.getElementById('image-input'),
            themeToggle: document.getElementById('theme-toggle'),
            batchBtn: document.getElementById('batch-btn'),
            continueBtn: document.getElementById('continue-btn'),
            comboBtn: document.getElementById('combo-btn'),
            coinTossOverlay: document.getElementById('coin-toss-overlay'),
            animatedCoin: document.getElementById('animated-coin'),
            coinResultText: document.getElementById('coin-result-text'),
            cancelCoinResult: document.getElementById('cancel-coin-result'),
            sendCoinResult: document.getElementById('send-coin-result'),
            typingIndicator: document.getElementById('typing-indicator'),
            emptyState: document.getElementById('empty-state'),
            welcomeAnimation: document.getElementById('welcome-animation'),
            batchPreview: document.getElementById('batch-preview'),
            replyPreviewContainer: document.getElementById('reply-preview-container'),
            pagination: document.getElementById('pagination'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            editModal: {
                modal: document.getElementById('edit-modal'),
                title: document.getElementById('edit-modal-title'),
                input: document.getElementById('name-input'),
                cancel: document.getElementById('cancel-edit'),
                save: document.getElementById('save-name')
            },
            avatarModal: {
                modal: document.getElementById('avatar-modal'),
                title: document.getElementById('avatar-modal-title'),
                input: document.getElementById('avatar-input'),
                cancel: document.getElementById('cancel-avatar'),
                save: document.getElementById('save-avatar')
            },
            noteModal: {
                modal: document.getElementById('note-modal'),
                input: document.getElementById('note-input'),
                cancel: document.getElementById('cancel-note'),
                save: document.getElementById('save-note')
            },
            pokeModal: {
                modal: document.getElementById('poke-modal'),
                input: document.getElementById('poke-input'),
                cancel: document.getElementById('cancel-poke'),
                save: document.getElementById('send-poke')
            },
            settingsModal: {
                modal: document.getElementById('settings-modal'),
                settingsBtn: document.getElementById('settings-btn'),
                cancel: document.getElementById('cancel-settings')
            },
            favoritesModal: {
                modal: document.getElementById('favorites-modal'),
                favoritesBtn: document.getElementById('favorites-btn'),
                list: document.getElementById('favorites-list'),
                cancel: document.getElementById('cancel-favorites')
            },
            statsModal: {
                modal: document.getElementById('stats-modal'),
                content: document.getElementById('stats-content'),
                closeBtn: document.getElementById('close-stats')
            },
            sessionModal: {
                modal: document.getElementById('session-modal'),
                managerBtn: document.getElementById('session-manager-btn'),
                list: document.getElementById('session-list'),
                createBtn: document.getElementById('create-new-session'),
                cancelBtn: document.getElementById('cancel-session')
            },
            fortuneModal: {
                modal: document.getElementById('fortune-modal'),
                content: document.getElementById('fortune-content'),
                shareBtn: document.getElementById('share-fortune'),
                closeBtn: document.getElementById('close-fortune')
            },
            customRepliesModal: {
                modal: document.getElementById('custom-replies-modal'),
                list: document.getElementById('custom-replies-list'),
                addBtn: document.getElementById('add-custom-reply'),
                closeBtn: document.getElementById('close-custom-replies')
            },
            backgroundInput: document.getElementById('background-input'),
            importInput: document.getElementById('import-input'),
            partner: {
                name: document.getElementById('partner-name'),
                avatarContainer: document.getElementById('partner-avatar-container'), 
                avatar: document.getElementById('partner-avatar'),
                status: document.getElementById('partner-status').querySelector('span')
            },
            me: {
                name: document.getElementById('my-name'),
                avatarContainer: document.getElementById('my-avatar-container'), 
                avatar: document.getElementById('my-avatar'),
                statusContainer: document.getElementById('my-status-container'),
                statusText: document.getElementById('my-status-text')
            },
            anniversaryModal: {
                modal: document.getElementById('anniversary-modal'),
                closeBtn: document.getElementById('close-anniversary-modal'),
                saveBtn: document.getElementById('save-ann-btn'),
                addBtn: document.getElementById('open-ann-add-btn'),
                dateInput: document.getElementById('ann-input-date'),
                nameInput: document.getElementById('ann-input-name'),
                displayArea: document.getElementById('anniversary-display'),
                daysElement: document.getElementById('anniversary-days'),
                dateShowElement: document.getElementById('anniversary-date-show'),
                list: document.getElementById('ann-list-container'),
                typeHint: document.getElementById('ann-type-desc')
            },            
            anniversaryAnimation: {
                modal: document.getElementById('anniversary-animation'),
                title: document.getElementById('anniversary-animation-title'),
                days: document.getElementById('anniversary-animation-days'),
                message: document.getElementById('anniversary-animation-message'),
                closeBtn: document.getElementById('close-anniversary-animation')
            },
            appearanceModal: {
                modal: document.getElementById('appearance-modal'),
                closeBtn: document.getElementById('close-appearance')
            },
            chatModal: {
                modal: document.getElementById('chat-modal'),
                closeBtn: document.getElementById('close-chat')
            },
            advancedModal: {
                modal: document.getElementById('advanced-modal'),
                closeBtn: document.getElementById('close-advanced')
            },
            dataModal: {
                modal: document.getElementById('data-modal'),
                closeBtn: document.getElementById('close-data')
            }
        };

        function exportDataToMobileOrPC(dataString, fileName) {
            if (navigator.share && navigator.canShare) {
                try {
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const file = new File([blob], fileName, { type: 'application/json' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'ä¼ è®¯æ•°æ®å¤‡ä»½',
                            text: 'è¿™æ˜¯æ‚¨çš„å›žå¤åº“å¤‡ä»½æ–‡ä»¶ï¼Œè¯·é€‰æ‹©â€œä¿å­˜åˆ°æ–‡ä»¶â€æˆ–å‘é€ç»™å¥½å‹ã€‚'
                        }).then(() => {
                            showNotification('å¯¼å‡º/åˆ†äº«æˆåŠŸ', 'success');
                        }).catch((err) => {
                            console.warn('åˆ†äº«æœªå®Œæˆï¼Œå°è¯•å›žé€€ä¸‹è½½æ¨¡å¼:', err);
                            downloadFileFallback(blob, fileName);
                        });
                        return;
                    }
                } catch (e) {
                    console.log("ç§»åŠ¨ç«¯åˆ†äº«æž„å»ºå¤±è´¥ï¼Œè½¬ä¸ºæ™®é€šä¸‹è½½", e);
                }
            }
            const blob = new Blob([dataString], { type: 'application/json' });
            downloadFileFallback(blob, fileName);
        }

        function downloadFileFallback(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification('æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½', 'success');
        }
        
        localforage.config({
            driver: localforage.INDEXEDDB,
            name: 'ChatApp_V3',
            version: 1.0,
            storeName: 'chat_data',
            description: 'Storage for Chat App V3'
        });

        function getStorageKey(baseKey) {
            if (!SESSION_ID) console.error("Session not initialized!");
            return `${APP_PREFIX}${SESSION_ID}_${baseKey}`;
        }

        async function migrateData() {
            const isMigrated = await localforage.getItem(APP_PREFIX + 'MIGRATION_V2_DONE');
            if (isMigrated) return;

            console.log("å¼€å§‹ä»Ž localStorage è¿ç§»æ•°æ®è‡³æ›´ç¨³å®šçš„å­˜å‚¨...");
            try {
                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.startsWith(APP_PREFIX)) {
                        try {
                            const val = localStorage.getItem(key);
                            if (val) {
                                let dataToStore = val;
                                try {
                                    if (val.startsWith('{') || val.startsWith('[')) {
                                        dataToStore = JSON.parse(val);
                                    }
                                } catch (e) {
                                    console.warn(`è¿ç§»æœŸé—´è§£æžæ•°æ®å¤±è´¥: ${key}ï¼Œå°†ä½œä¸ºåŽŸå§‹å­—ç¬¦ä¸²å­˜å‚¨ã€‚`, e);
                                }
                                await localforage.setItem(key, dataToStore);
                            }
                        } catch (e) {
                            console.error(`è¿ç§»é”®å€¼ ${key} æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå·²è·³è¿‡ã€‚`, e);
                        }
                    }
                }
                
                await localforage.setItem(APP_PREFIX + 'MIGRATION_V2_DONE', 'true');
                console.log("æ•°æ®è¿ç§»æˆåŠŸå®Œæˆã€‚");
            } catch (e) {
                console.error("æ•°æ®è¿ç§»è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯:", e);
                showNotification('æ•°æ®è¿ç§»å¤±è´¥ï¼Œéƒ¨åˆ†æ—§æ•°æ®å¯èƒ½ä¸¢å¤±', 'error');
            }
        }
async function initializeSession() {
    
    await migrateData();

    const sessionsData = await localforage.getItem(`${APP_PREFIX}sessionList`);
    sessionList = sessionsData || [];

    const hash = window.location.hash.substring(1);
    if (hash && sessionList.some(s => s.id === hash)) {
        SESSION_ID = hash;
    } else if (sessionList.length > 0) {
        const lastId = await localforage.getItem(`${APP_PREFIX}lastSessionId`);
        SESSION_ID = lastId && sessionList.some(s => s.id === lastId) ? lastId : sessionList[0].id;
    } else {
        SESSION_ID = await createNewSession(false);
    }

    await localforage.setItem(`${APP_PREFIX}lastSessionId`, SESSION_ID);
    // history.replaceState(null, null, `#${SESSION_ID}`); // å·²æ³¨é‡Š:åœ¨ Artifacts çŽ¯å¢ƒä¸­ä¸æ”¯æŒ
}


        function clearAllAppData() {
    if (confirm("ã€é«˜å±æ“ä½œã€‘ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä¼šè¯å’Œè®¾ç½®å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼")) {
        localforage.clear().then(() => {
            localStorage.clear(); 
            showNotification('æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼Œé¡µé¢å³å°†åˆ·æ–°', 'info', 2000);
            setTimeout(() => {
                window.location.href = window.location.pathname;
            }, 2000);
        }).catch(e => {
            showNotification('æ¸…é™¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            console.error("æ¸…é™¤ localforage å¤±è´¥:", e);
        });
    }
}

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            notification.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hiding');
                notification.addEventListener('animationend', () => notification.remove());
            }, duration);
        }

        const playSound = (type) => {
            if (!settings.soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                if (type === 'send') oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                else if (type === 'favorite') oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                else oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.warn("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e);
            }
        };

        const throttledSaveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        };

async function applyCustomFont(url) {
    if (!url || !url.trim()) {
        document.documentElement.style.removeProperty('--font-family');
        document.documentElement.style.removeProperty('--message-font-family');
        return;
    }
    
    const fontName = 'UserCustomFont';
    try {
        const font = new FontFace(fontName, `url(${url})`);
        await font.load();
        document.fonts.add(font);
        
        document.documentElement.style.setProperty('--font-family', `"${fontName}", 'Noto Serif SC', serif`);
        document.documentElement.style.setProperty('--message-font-family', `"${fontName}", 'Noto Serif SC', serif`);
        
        console.log('å­—ä½“åŠ è½½æˆåŠŸ');
    } catch (e) {
        console.error('å­—ä½“åŠ è½½å¤±è´¥:', e);
        showNotification('å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æŽ¥æ˜¯å¦æœ‰æ•ˆ', 'error');
    }
}

function applyCustomBubbleCss(cssCode) {
    const styleId = 'user-custom-bubble-style';
    let styleTag = document.getElementById(styleId);
    
    if (!cssCode || !cssCode.trim()) {
        if (styleTag) styleTag.remove();
        return;
    }

    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = styleId;
        document.head.appendChild(styleTag);
    }
    
    styleTag.textContent = cssCode;
}
        function getDefaultSettings() {
            return {
                partnerName: "å¯¹æ–¹",
                myName: "æˆ‘",
                myStatus: "åœ¨çº¿",
                partnerStatus: "åœ¨çº¿",
                isDarkMode: false,
                colorTheme: "gold",
                soundEnabled: true,
                typingIndicatorEnabled: true,
                readReceiptsEnabled: true,
                replyEnabled: true,
                lastStatusChange: Date.now(),
                nextStatusChange: 1 + Math.random() * 7,
                fontSize: 16,
                bubbleStyle: 'standard',
                messageFontFamily: "'Noto Serif SC', serif",
                messageFontWeight: 400,
                messageLineHeight: 1.5,
                musicPlayerEnabled: false,
                replyDelayMin: 800,
                replyDelayMax: 2500,
                inChatAvatarEnabled: true,
                inChatAvatarSize: 36,
                customFontUrl: "", 
        customBubbleCss: "",
                myAvatarFrame: null, 
                partnerAvatarFrame: null,
autoSendEnabled: false,
autoSendInterval: 60,
        allowReadNoReply: false, 
        readNoReplyChance: 0.2  
            };
        }


        function renderBackgroundGallery() {
            const list = document.getElementById('background-gallery-list');
            if (!list) return;

            list.innerHTML = '';

            
            const addBtn = document.createElement('div');
            addBtn.className = 'bg-item bg-add-btn';
            
            addBtn.innerHTML = '<i class="fas fa-plus"></i><span></span>';
            addBtn.onclick = () => document.getElementById('bg-gallery-input').click();
            list.appendChild(addBtn);

            const currentBg = safeGetItem(getStorageKey('chatBackground'));

            savedBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                let isActive = false;

                if (currentBg && currentBg === bg.value) isActive = true;

                item.className = `bg-item ${isActive ? 'active': ''}`;

                
                if (bg.type === 'image') {
                    item.innerHTML = `<img src="${bg.value}" loading="lazy" alt="bg">`;
                } else {
                    item.innerHTML = `<div class="bg-color-block" style="background: ${bg.value}"></div>`;
                }

                
                item.onclick = (e) => {
                    
                    if (e.target.closest('.bg-delete-btn')) return;

                    applyBackground(bg.value);
                    safeSetItem(getStorageKey('chatBackground'), bg.value);
                    renderBackgroundGallery(); 
                    showNotification('èƒŒæ™¯å·²åˆ‡æ¢', 'success');
                };

                if (bg.id.startsWith('user-')) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'bg-delete-btn';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.title = "åˆ é™¤æ­¤èƒŒæ™¯";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('ç¡®å®šåˆ é™¤è¿™å¼ èƒŒæ™¯å›¾å—ï¼Ÿ')) {
                            savedBackgrounds.splice(index, 1);
                            saveBackgroundGallery();

                            if (isActive) {
                                removeBackground(); 
                                renderBackgroundGallery();
                            } else {
                                renderBackgroundGallery();
                            }
                        }
                    };
                    item.appendChild(delBtn);
                }

                list.appendChild(item);
            });
        }


        function saveBackgroundGallery() {
    localforage.setItem(getStorageKey('backgroundGallery'), savedBackgrounds);
}


        const applyBackground = (value) => {

            if (!value || typeof value !== 'string') return;

            try {

                if (value.startsWith('linear-gradient') || value.startsWith('#') || value.startsWith('rgb')) {
                    document.documentElement.style.setProperty('--chat-bg-image', value);
                } else {

                    const cssValue = value.startsWith('url(') ? value: `url(${value})`;
                    document.documentElement.style.setProperty('--chat-bg-image', cssValue);
                }
                document.body.classList.add('with-background');
            } catch (e) {
                console.error("èƒŒæ™¯åº”ç”¨å‡ºé”™ï¼Œå·²è‡ªåŠ¨é‡ç½®", e);

                if (typeof removeBackground === 'function') removeBackground();
            }
        };

const loadData = async () => {
    try {
        settings = getDefaultSettings();
        
        const results = await Promise.allSettled([
            localforage.getItem(getStorageKey('chatSettings')),
            localforage.getItem(getStorageKey('chatMessages')),
            localforage.getItem(getStorageKey('backgroundGallery')),
            localforage.getItem(getStorageKey('customReplies')),
            localforage.getItem(getStorageKey('customPokes')),
            localforage.getItem(getStorageKey('customStatuses')),
            localforage.getItem(getStorageKey('customMottos')),
            localforage.getItem(getStorageKey('customIntros')),
            localforage.getItem(getStorageKey('disabledDefaultReplies')),
            localforage.getItem(getStorageKey('anniversaries')),
            localforage.getItem(getStorageKey('stickerLibrary')),
            localforage.getItem(`${APP_PREFIX}customThemes`),
            localforage.getItem(getStorageKey('chatBackground')),
            localforage.getItem(getStorageKey('partnerAvatar')),
            localforage.getItem(getStorageKey('myAvatar')),
            localforage.getItem(getStorageKey('partnerPersonas')), 
            localforage.getItem(getStorageKey('showPartnerNameInChat')) 
        ]);
        const getVal = (index) => results[index].status === 'fulfilled' ? results[index].value : null;

        const savedSettings = getVal(0);
        const savedMessages = getVal(1);
        const savedBgGallery = getVal(2);
        const savedCustomReplies = getVal(3);
        const savedPokes = getVal(4);
        const savedStatuses = getVal(5);
        const savedMottos = getVal(6);
        const savedIntros = getVal(7);
        const savedDisabledDefaults = getVal(8);
        const savedAnniversaries = getVal(9);
        const savedStickers = getVal(10);
        const savedCustomThemes = getVal(11);
        const savedChatBg = getVal(12);
        const partnerAvatarSrc = getVal(13);
        const myAvatarSrc = getVal(14);
        const savedPartnerPersonas = getVal(15);
        const savedShowNameConfig = getVal(16);

        if (savedPartnerPersonas) partnerPersonas = savedPartnerPersonas; 

        if (savedShowNameConfig !== null) {
            showPartnerNameInChat = savedShowNameConfig;
            document.body.classList.toggle('show-partner-name', showPartnerNameInChat);
        }

        if (savedSettings) Object.assign(settings, savedSettings);
        try {
            if (settings.customFontUrl) applyCustomFont(settings.customFontUrl);
            if (settings.customBubbleCss) applyCustomBubbleCss(settings.customBubbleCss);
        } catch(e) { console.warn("æ ·å¼åº”ç”¨å¤±è´¥", e); }
        
        if (savedPokes) customPokes = savedPokes;
        else customPokes = [...CONSTANTS.POKE_ACTIONS];

        if (savedStatuses) customStatuses = savedStatuses;
        else customStatuses = [...CONSTANTS.PARTNER_STATUSES];

        if (savedMottos) customMottos = savedMottos;
        else customMottos = [...CONSTANTS.HEADER_MOTTOS];
        
        if (savedIntros) customIntros = savedIntros;
        else customIntros = CONSTANTS.WELCOME_ANIMATIONS.map(a => `${a.line1}|${a.line2}`);

        if (savedMessages && Array.isArray(savedMessages)) {
            messages = savedMessages.map(m => ({
                ...m, timestamp: new Date(m.timestamp)
            }));
        } else {
            messages = [];
        }

        if (savedBgGallery) {
            savedBackgrounds = savedBgGallery;
        } else {
            savedBackgrounds = [{ id: 'preset-1', type: 'color', value: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }];
        }

        if (savedCustomReplies) customReplies = savedCustomReplies;
        if (savedDisabledDefaults) disabledDefaultReplies = savedDisabledDefaults;
        if (savedAnniversaries) anniversaries = savedAnniversaries;
        if (savedStickers) stickerLibrary = savedStickers;
        if (savedCustomThemes) customThemes = savedCustomThemes;

        if (DOMElements && DOMElements.partner && DOMElements.me) {
            updateAvatar(DOMElements.partner.avatar, partnerAvatarSrc);
            updateAvatar(DOMElements.me.avatar, myAvatarSrc);
        }

        if (savedChatBg) applyBackground(savedChatBg);
        
        try { await initMoodData(); } catch(e) { console.warn("å¿ƒæƒ…æ•°æ®åŠ è½½å¤±è´¥", e); }
        
        displayedMessageCount = HISTORY_BATCH_SIZE;
        
        // å»¶è¿Ÿæ‰§è¡Œ UI æ›´æ–°ï¼Œç¡®ä¿ DOM å·²å°±ç»ª
        setTimeout(() => {
            applyAllAvatarFrames();
            manageAutoSendTimer(); 
            checkEnvelopeStatus(); 
            updateUI();
        }, 100);

    } catch (e) {
        console.error("LoadData å†…éƒ¨è‡´å‘½é”™è¯¯:", e);
        // æ¢å¤é»˜è®¤è®¾ç½®ä»¥ç¡®ä¿ç¨‹åºèƒ½è·‘
        settings = getDefaultSettings();
        messages = [];
        updateUI();
    }
};
const LIBRARY_CONFIG = {
    reply: {
        title: "å›žå¤åº“ç®¡ç†",
        tabs: [
            { id: 'custom', name: 'ä¸»å­—å¡', mode: 'list' },
            { id: 'default', name: 'ç³»ç»Ÿé¢„è®¾', mode: 'list' },
            { id: 'emojis', name: 'Emoji', mode: 'grid' },
            { id: 'stickers', name: 'è¡¨æƒ…åº“', mode: 'grid' }
        ]
    },
    atmosphere: {
        title: "æ°›å›´æ„Ÿé…ç½®",
        tabs: [
            { id: 'pokes', name: 'æ‹ä¸€æ‹', mode: 'list' },
            { id: 'statuses', name: 'å¯¹æ–¹çŠ¶æ€', mode: 'list' },
            { id: 'mottos', name: 'é¡¶éƒ¨æ ¼è¨€', mode: 'list' },
            { id: 'intros', name: 'å¼€åœºåŠ¨ç”»', mode: 'list' }
        ]
    }
};
let currentAnnType = 'anniversary'; 

window.switchAnnType = function(type) {
    currentAnnType = type;
    document.querySelectorAll('.ann-type-btn').forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const desc = document.getElementById('ann-type-desc');
    if(desc) {
        desc.textContent = type === 'anniversary' 
            ? 'è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤© (ä¾‹å¦‚: ç›¸è¯†ã€æ‹çˆ±)' 
            : 'è®¡ç®—ä»ŽçŽ°åœ¨åˆ°æœªæ¥æŸä¸€å¤©è¿˜å‰©ä¸‹å¤šå°‘å¤© (ä¾‹å¦‚: ç”Ÿæ—¥ã€è·¨å¹´)';
    }
};

window.deleteAnniversaryItem = function(id) {
    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData(); 
        renderAnniversariesList();
        showNotification('å·²åˆ é™¤', 'success');
    }
};
const saveData = async () => {
    try {
        const promises = [
            localforage.setItem(getStorageKey('chatSettings'), settings),
            localforage.setItem(getStorageKey('customReplies'), customReplies),
            localforage.setItem(getStorageKey('disabledDefaultReplies'), disabledDefaultReplies),
            localforage.setItem(getStorageKey('anniversaries'), anniversaries),
            localforage.setItem(getStorageKey('customPokes'), customPokes),
            localforage.setItem(getStorageKey('customStatuses'), customStatuses),
            localforage.setItem(getStorageKey('customMottos'), customMottos),
            localforage.setItem(getStorageKey('customIntros'), customIntros),
            localforage.setItem(getStorageKey('stickerLibrary'), stickerLibrary),
            localforage.setItem(`${APP_PREFIX}customThemes`, customThemes),
            localforage.setItem(getStorageKey('chatMessages'), messages),
        ];

        const partnerImg = DOMElements.partner.avatar.querySelector('img');
        if (partnerImg) promises.push(localforage.setItem(getStorageKey('partnerAvatar'), partnerImg.src));
        else promises.push(localforage.removeItem(getStorageKey('partnerAvatar')));
        
        const myImg = DOMElements.me.avatar.querySelector('img');
        if (myImg) promises.push(localforage.setItem(getStorageKey('myAvatar'), myImg.src));
        else promises.push(localforage.removeItem(getStorageKey('myAvatar')));

        await Promise.all(promises);

    } catch (e) {
        console.error("ä¿å­˜æ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", e);
    }
};
        function initializeRandomUI() {
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];


            document.querySelector('.header-motto').textContent = getRandomItem(CONSTANTS.HEADER_MOTTOS);
if (customMottos && customMottos.length > 0) {
    document.querySelector('.header-motto').textContent = getRandomItem(customMottos);
} else {
    document.querySelector('.header-motto').textContent = CONSTANTS.HEADER_MOTTOS[0];
}
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;


            const starsContainer = document.getElementById('stars-container');
            starsContainer.innerHTML = '';
            const starCount = 60;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';


                const x = Math.random() * 100;
                const y = Math.random() * 100;


                const size = Math.random() * 2 + 1;
                const duration = Math.random() * 3 + 2;
                const delay = Math.random() * 5;

                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.animationDelay = `${delay}s`;

                starsContainer.appendChild(star);
            }


            const welcomeIcon = getRandomItem(CONSTANTS.WELCOME_ICONS);
document.querySelector('.logo-icon-main').innerHTML = `<i class="${welcomeIcon}"></i>`;

if (customIntros && customIntros.length > 0) {
    const rawIntro = getRandomItem(customIntros);
    const parts = rawIntro.split('|');
    const line1 = parts[0];
    const line2 = parts[1] || ""; 

    const titleEl = document.getElementById('welcome-title-glitch');
    const subEl = document.getElementById('welcome-subtitle-scramble');

    titleEl.classList.remove('playing');
    titleEl.textContent = line1;
    void titleEl.offsetWidth;
    titleEl.classList.add('playing');

    const scrambleText = (element, finalText, duration = 1500) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()';
                const length = finalText.length;
                let start = Date.now();

                const interval = setInterval(() => {
                    const now = Date.now();
                    const progress = (now - start) / duration;

                    if (progress >= 1) {
                        element.textContent = finalText;
                        clearInterval(interval);
                        return;
                    }

                    let result = '';

                    const revealIndex = Math.floor(progress * length);

                    for (let i = 0; i < length; i++) {
                        if (i <= revealIndex) {
                            result += finalText[i];
                        } else {

                            result += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }
                    element.textContent = result;
                },
                    40);
            };


          setTimeout(() => {
        scrambleText(subEl, line2, 2000);
    }, 600);
} else {
    document.getElementById('welcome-title-glitch').textContent = "ä¼ è®¯";
    document.getElementById('welcome-subtitle-scramble').textContent = "è¯·åœ¨è®¾ç½®ä¸­æ·»åŠ å¼€åœºåŠ¨ç”»";
}


            const loaderBar = document.getElementById('loader-tech-bar');
            loaderBar.style.width = '0%';

            setTimeout(() => loaderBar.style.width = '30%', 100);
            setTimeout(() => loaderBar.style.width = '55%', 800);
            setTimeout(() => loaderBar.style.width = '85%', 1800);
            setTimeout(() => loaderBar.style.width = '100%', 2600);
        }
function manageAutoSendTimer() {
    if (autoSendTimer) {
        clearInterval(autoSendTimer);
        autoSendTimer = null;
    }
    if (settings.autoSendEnabled) {
        const intervalMs = settings.autoSendInterval * 1000;
        console.log(`ä¸»åŠ¨å‘é€å·²å¼€å¯ï¼Œé—´éš”: ${settings.autoSendInterval}ç§’`);
        
        autoSendTimer = setInterval(() => {
            if (!document.body.classList.contains('batch-favorite-mode')) {
                simulateReply(); 
            }
        }, intervalMs);
    }
}

        const updateUI = () => {
            const isCustomTheme = settings.colorTheme.startsWith('custom-');
            if (isCustomTheme) {
                const themeId = settings.colorTheme;
                const theme = customThemes.find(t => t.id === themeId);
                if (theme) {
                    applyTheme(theme.colors);
                } else {
                    DOMElements.html.setAttribute('data-color-theme', 'gold');
                }
            } else {
                DOMElements.html.setAttribute('data-color-theme', settings.colorTheme);
                applyTheme(null, true);
            }

            DOMElements.html.setAttribute('data-theme', settings.isDarkMode ? 'dark': 'light');
            DOMElements.themeToggle.innerHTML = settings.isDarkMode ? '<i class="fas fa-sun"></i>': '<i class="fas fa-moon"></i>';
            DOMElements.partner.name.textContent = settings.partnerName;
            DOMElements.me.name.textContent = settings.myName;
            DOMElements.partner.status.textContent = settings.partnerStatus;
            DOMElements.me.statusText.textContent = settings.myStatus;
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            
            const fontToUse = settings.messageFontFamily || "'Noto Serif SC', serif";
            
            document.documentElement.style.setProperty('--message-font-family', fontToUse);
            document.documentElement.style.setProperty('--font-family', fontToUse);
            document.documentElement.style.setProperty('--message-font-weight', settings.messageFontWeight);
            document.documentElement.style.setProperty('--message-line-height', settings.messageLineHeight);

            document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);

            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
            });

            renderMessages();
        };

        const updateAvatar = (element, src) => {
            if (src) element.innerHTML = `<img src="${src}" alt="avatar">`; else element.innerHTML = `<i class="fas fa-user"></i>`;
        };

        const removeBackground = () => {
            document.documentElement.style.removeProperty('--chat-bg-image');
            document.body.classList.remove('with-background');
            localforage.removeItem(getStorageKey('chatBackground'));
            showNotification('èƒŒæ™¯å›¾ç‰‡å·²ç§»é™¤', 'success');
        };

        function renderMessages(preserveScroll = false) {
            const container = DOMElements.chatContainer;
            const totalMessages = messages.length;

            const startIndex = Math.max(0, totalMessages - displayedMessageCount);
            const msgsToRender = messages.slice(startIndex);

            DOMElements.emptyState.style.display = totalMessages === 0 ? 'flex': 'none';

            const oldScrollHeight = container.scrollHeight;
            
            container.innerHTML = '';

            const fragment = new DocumentFragment();
            let currentDate = '';
            let lastSender = null;

            msgsToRender.forEach((msg, index) => {
                const messageDate = new Date(msg.timestamp).toDateString();
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    const displayDate = (messageDate === today) ? 'ä»Šå¤©': (messageDate === yesterday) ? 'æ˜¨å¤©': new Date(msg.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    dateDivider.innerHTML = `<span>${displayDate}</span>`;
                    fragment.appendChild(dateDivider);
                    lastSender = null; 
                }

                if (msg.type === 'system') {
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message';
                    systemMsgDiv.innerHTML = msg.text;
                    fragment.appendChild(systemMsgDiv);
                    lastSender = 'system';
                    return;
                }

                let showTimestamp = true;
                if (index < msgsToRender.length - 1) {
                    const nextMsg = msgsToRender[index + 1];
                    const currentTs = new Date(msg.timestamp).getTime();
                    const nextTs = new Date(nextMsg.timestamp).getTime();
                    
                    if (nextMsg.sender === msg.sender && 
                        nextMsg.type !== 'system' && 
                        (nextTs - currentTs < 60000)) {
                        showTimestamp = false;
                    }
                }

                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent': 'received'}`;
                wrapper.dataset.id = msg.id;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                
                if (settings.inChatAvatarEnabled) {
                    if (msg.sender === lastSender) {
                        avatarDiv.classList.add('hidden');
                    } else {
                        const isUser = msg.sender === 'user';
                        const avatarElement = isUser ? DOMElements.me.avatar : DOMElements.partner.avatar;
                        const frameSettings = isUser ? settings.myAvatarFrame : settings.partnerAvatarFrame;

                        avatarDiv.innerHTML = avatarElement.innerHTML;
                        applyAvatarFrame(avatarDiv, frameSettings);
                    }
                } else {
                    avatarDiv.style.display = 'none';
                }
                wrapper.appendChild(avatarDiv);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';
                
                let messageHTML = '';
                if (msg.replyTo) {
                    const repliedText = msg.replyTo.text || '[å›¾ç‰‡]';
                    messageHTML += `<div class="reply-indicator"><span>${repliedText}</span></div>`;
                }

                let content = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>`: '';
                if (msg.image) content += `<img src="${msg.image}" class="message-image" alt="å›¾ç‰‡" style="max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="viewImage('${msg.image}')">`;
                messageHTML += content;

                if (msg.note) messageHTML += `<div class="message-note">${msg.note}</div>`;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${msg.sender === 'user' ? 'sent': 'received'} ${settings.bubbleStyle}`;
                messageDiv.innerHTML = messageHTML;

                let actionsHTML = '';
                
                if (settings.replyEnabled) actionsHTML += `<button class="meta-action-btn reply-btn" title="å›žå¤"><i class="fas fa-reply"></i></button>`;
                
                const starIcon = msg.favorited ? 'fas fa-star' : 'far fa-star'; 
                actionsHTML += `<button class="meta-action-btn favorite-action-btn ${msg.favorited ? 'favorited' : ''}" title="${msg.favorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}"><i class="${starIcon}"></i></button>`;
                
                actionsHTML += `<button class="meta-action-btn note-btn" title="æ³¨é‡Š"><i class="fas fa-sticky-note"></i></button>`;
actionsHTML += `<button class="meta-action-btn delete-btn" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-meta-actions';
                actionsDiv.innerHTML = actionsHTML;

                let metaHTML = '';
                
                if (showTimestamp) {
                    metaHTML += `<div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('zh-CN', {
                        hour: '2-digit', minute: '2-digit'
                    })}</div>`;
                }

                if (msg.sender === 'user' && settings.readReceiptsEnabled) {
                    const statusIcon = msg.status === 'read' ? 'fa-check-double': 'fa-check';
                    metaHTML += `<div class="read-receipt ${msg.status === 'read' ? 'read': ''}" style="${!showTimestamp ? 'margin-left:0':''}"><i class="fas ${statusIcon}"></i></div>`;
                }

                if (metaHTML !== '') {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'message-meta';
                    if (!showTimestamp && !metaHTML.includes('timestamp')) {
                         metaDiv.style.height = 'auto'; 
                         metaDiv.style.marginTop = '2px';
                    }
                    metaDiv.innerHTML = metaHTML;
                    contentWrapper.append(actionsDiv, messageDiv, metaDiv);
                } else {
                    contentWrapper.append(actionsDiv, messageDiv);
                }

                wrapper.appendChild(contentWrapper);
                fragment.appendChild(wrapper);
                
                lastSender = msg.sender;
            });

            container.appendChild(fragment);

            if (preserveScroll) {
                const newScrollHeight = container.scrollHeight;
                container.scrollTop = newScrollHeight - oldScrollHeight;
            } else {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }        

        const addMessage = (message) => {
            if (!(message.timestamp instanceof Date)) message.timestamp = new Date(message.timestamp);
            messages.push(message);


            displayedMessageCount++;


            renderMessages(false);
            throttledSaveData();
        };

        function optimizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.size < 300 * 1024) {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let {
                        width,
                        height
                    } = img;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function sendMessage(textOverride = null, type = 'normal') {
            const text = textOverride || DOMElements.messageInput.value.trim();
            const imageFile = DOMElements.imageInput.files[0];
            if (!text && !imageFile && type === 'normal') return;

            DOMElements.messageInput.value = '';
            DOMElements.messageInput.style.height = '46px';
            if (imageFile && imageFile.size > MAX_IMAGE_SIZE) {
                showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error'); DOMElements.imageInput.value = ''; return;
            }

            const createMessage = (imgSrc = null) => {
                const messageData = {
                    id: Date.now(),
                    sender: 'user',
                    text: text || '',
                    timestamp: new Date(),
                    image: imgSrc,
                    status: 'sent',
                    favorited: false,
                    note: null,
                    replyTo: currentReplyTo,
                    type: type
                };
                if (type === 'system') messageData.sender = null;

                addMessage(messageData);
                if (type !== 'system') playSound('send');
                currentReplyTo = null;
                updateReplyPreview();

if (!isBatchMode && type === 'normal') {
    const delayRange = settings.replyDelayMax - settings.replyDelayMin;
    const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
    
    setTimeout(() => {
        let changed = false;
        messages.forEach(msg => {
            if (msg.sender === 'user' && msg.status !== 'read') {
                msg.status = 'read'; 
                changed = true;
            }
        });
        if (changed) {
            renderMessages(false); 
            throttledSaveData();
        }

        const shouldIgnore = settings.allowReadNoReply && (Math.random() < settings.readNoReplyChance);

        if (shouldIgnore) {
            console.log("è§¦å‘å·²è¯»ä¸å›žæœºåˆ¶");
        } else {
            simulateReply(); 
        }

    }, randomDelay);
}
};

            if (imageFile) {
                showNotification('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡...', 'info', 1500);
                optimizeImage(imageFile).then(createMessage).catch(() => showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error'));
            } else {
                createMessage();
            }
            DOMElements.imageInput.value = '';
        }

        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            DOMElements.batchBtn.classList.toggle('active', isBatchMode);
            DOMElements.batchBtn.title = isBatchMode ? "é€€å‡ºæ‰¹é‡æ¨¡å¼": "æ‰¹é‡å‘é€æ¨¡å¼";
            DOMElements.batchPreview.style.display = isBatchMode ? 'flex': 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = isBatchMode ? "æ­¤åˆ»ï¼Œæƒ³è¯´çš„æœ‰å¾ˆå¤šå¾ˆå¤š...": (placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder);
            if (isBatchMode) {
                batchMessages = []; updateBatchPreview();
            }
        }

        function addToBatch() {
            const text = DOMElements.messageInput.value.trim();
            if (!text) return;
            batchMessages.push({
                id: Date.now() + batchMessages.length, text
            });
            DOMElements.messageInput.value = ''; DOMElements.messageInput.style.height = '46px';
            updateBatchPreview();
        }

        function updateBatchPreview() {
            const previewContainer = DOMElements.batchPreview;
            let listHTML = '';
            if (batchMessages.length > 0) {
                listHTML = batchMessages.map((msg, index) => `
                <div class="batch-preview-item" data-index="${index}">
                <span class="batch-preview-text">${msg.text}</span>
                <button class="batch-preview-remove"><i class="fas fa-times"></i></button>
                </div>`).join('');
            } else {
                listHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 10px;">Ëšâ‚Šâ€§ê’°ð“†© â™± ð“†ªê’±â€§â‚ŠËš</div>';
            }

            previewContainer.innerHTML = `
        <div class="batch-preview-title">æˆ‘æœ‰å¾ˆå¤šçš„è¯æƒ³è¯´â€¦ï¼</div>
        <div class="batch-preview-list">${listHTML}</div>
        <div class="batch-actions">
        <button class="batch-action-btn batch-cancel-btn">å–æ¶ˆ</button>
        <button class="batch-action-btn batch-send-btn" ${batchMessages.length === 0 ? 'disabled': ''}>å‘é€å…¨éƒ¨ (${batchMessages.length})</button>
        </div>`;
        }

        function sendBatchMessages() {
            if (batchMessages.length === 0) return;
            showNotification(`æ­£åœ¨å‘é€ ${batchMessages.length} æ¡æ¶ˆæ¯...`, 'info', 2000);
            batchMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage({
                        id: Date.now() + index, sender: 'user', text: msg.text, timestamp: new Date(), status: 'sent', favorited: false, type: 'normal'
                    });
                    playSound('send');
                }, index * 300);
            });
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, batchMessages.length * 300 + randomDelay);
            isBatchMode = false; batchMessages = [];
            DOMElements.batchBtn.classList.remove('active'); DOMElements.batchPreview.style.display = 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
        }

        function simulateReply() {
            if (settings.typingIndicatorEnabled) {
        DOMElements.typingIndicator.style.display = 'block'; 
        DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
    }
            let changed = false;
            messages.forEach(msg => {
                if (msg.sender === 'user' && msg.status !== 'read') {
                    msg.status = 'read'; changed = true;
                }
            });
            if (changed) {
                renderMessages(false); throttledSaveData();
            }
            if (settings.typingIndicatorEnabled) {
                DOMElements.typingIndicator.style.display = 'block'; DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            }
if (partnerPersonas && partnerPersonas.length > 0 && Math.random() < 0.3) {
                const currentPool = [
                    ...partnerPersonas
                ];
                if(currentPool.length > 0) {
                     const nextPersona = currentPool[Math.floor(Math.random() * currentPool.length)];
                     
                     settings.partnerName = nextPersona.name;
                     DOMElements.partner.name.textContent = nextPersona.name;
                     
                     if (nextPersona.avatar) {
                         updateAvatar(DOMElements.partner.avatar, nextPersona.avatar);
                         localforage.setItem(getStorageKey('partnerAvatar'), nextPersona.avatar);
                     }
                     throttledSaveData();
                }
            }
            if (Math.random() < 0.03) {
                if (customPokes && customPokes.length > 0) {
        const randomAction = getRandomItem(customPokes);
                const pokeTypes = [{
                    prefix: "ðŸ’«",
                    text: `${settings.partnerName} ${randomAction}`
                },
                    {
                        prefix: "âœ¨",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸŒŸ",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸ¥°",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸ’–",
                        text: `${settings.partnerName} ${randomAction}`
                    }];

               const selectedPoke = getRandomItem(pokeTypes);
        
        addMessage({
            id: Date.now(),
            text: `${selectedPoke.prefix} ${settings.partnerName} ${randomAction} ${selectedPoke.prefix}`,
            timestamp: new Date(),
            type: 'system'
        });
        DOMElements.typingIndicator.style.display = 'none';
        return;
    }
}

            const replyCount = Math.random() < 0.75 ? 1: (Math.random() < 0.95 ? 2: 3);
            let delay = 0;
            for (let i = 0; i < replyCount; i++) {
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                delay += settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(() => {
let text = null;
let image = null;

const activeEmojis = CONSTANTS.REPLY_EMOJIS.filter(e => !disabledDefaultReplies.includes(e));
const nonTextPool = [...activeEmojis, ...stickerLibrary];

const activeDefaults = CONSTANTS.REPLY_MESSAGES.filter(msg => !disabledDefaultReplies.includes(msg));
const textPool = [...activeDefaults, ...customReplies];

if (Math.random() < 0.15 && nonTextPool.length > 0) { 
    const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) { 
        image = result;
    } else { 
        text = result;
    }
} else if (textPool.length > 0) {
    text = getRandomItem(textPool);
} else if (nonTextPool.length > 0) { 
     const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) {
        image = result;
    } else {
        text = result;
    }
} else {
    text = "ï¼ˆæˆ‘ä¸çŸ¥é“è¯¥è¯´ä»€ä¹ˆäº†...ï¼‰";
}

let replyTo = null;
if (settings.replyEnabled && Math.random() < 0.1) {
    const userMessages = messages.filter(m => m.sender === 'user').slice(-10);
    if (userMessages.length > 0) {
        const randomMessage = getRandomItem(userMessages);
        replyTo = {
            id: randomMessage.id,
            sender: randomMessage.sender,
            text: randomMessage.text
        };
    }
}

addMessage({
    id: Date.now() + i,
    sender: 'partner',
    text: text,
    image: image, 
    timestamp: new Date(),
    favorited: false,
    replyTo,
    type: 'normal'
});
                    playSound('message');
                    if (i === replyCount - 1) DOMElements.typingIndicator.style.display = 'none';
                },
                    delay);
            }
        }


        function startCoinFlipAnimation() {
            const overlay = DOMElements.coinTossOverlay;
            const coin = DOMElements.animatedCoin;
            const resultText = DOMElements.coinResultText;


            overlay.classList.remove('finished');
            coin.classList.remove('flipping-heads', 'flipping-tails');


            void coin.offsetWidth;


            resultText.textContent = 'å‘½è¿æŠ‰æ‹©ä¸­...';


            const isHeads = Math.random() < 0.5;
            const result = isHeads ? 'æ˜¯': 'å¦';
            const animationClass = isHeads ? 'flipping-heads': 'flipping-tails';


            requestAnimationFrame(() => {
                coin.classList.add(animationClass);
            });


            const onAnimationEnd = () => {

                const fancyText = isHeads ? "ç­”æ¡ˆæ˜¯ Â· æ˜¯": "ç­”æ¡ˆæ˜¯ Â· å¦";
                resultText.textContent = fancyText;


                lastCoinResult = result;


                overlay.classList.add('finished');
            };


            coin.addEventListener('animationend', onAnimationEnd, {
                once: true
            });
        }


        function handleCoinToss() {
            DOMElements.coinTossOverlay.classList.add('visible');
            startCoinFlipAnimation();
        }

        function updateReplyPreview() {
            const previewContainer = DOMElements.replyPreviewContainer;
            previewContainer.innerHTML = '';

            if (currentReplyTo) {
                const preview = document.createElement('div');
                preview.className = 'reply-preview';
                const repliedText = currentReplyTo.text || '[å›¾ç‰‡]';
                preview.innerHTML = `<div class="reply-preview-content">${repliedText}</div><button class="reply-preview-remove"><i class="fas fa-times"></i></button>`;
                preview.querySelector('.reply-preview-remove').addEventListener('click', () => {
                    currentReplyTo = null; updateReplyPreview();
                });
                previewContainer.appendChild(preview);
            }
        }


        function renderFavorites() {
            const list = DOMElements.favoritesModal.list;

            const favoritedMessages = messages.filter(m => m.favorited).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (favoritedMessages.length === 0) {
                list.innerHTML = `
            <div class="no-favorites">
            <i class="fas fa-folder-open"></i>
            <p>æ˜Ÿçƒçš„è§’è½ç©ºç©ºå¦‚ä¹Ÿ...</p>
            <span style="font-size:12px; margin-top:5px; opacity:0.7">ç‚¹å‡»æ¶ˆæ¯æ—çš„æ˜Ÿæ˜Ÿå³å¯æ”¶è—</span>
            </div>`;
                return;
            }

            list.innerHTML = favoritedMessages.map(msg => {

                const isMe = msg.sender === 'user';

                const avatarSrc = isMe
                ? (document.getElementById('my-avatar').querySelector('img')?.src || ''): (document.getElementById('partner-avatar').querySelector('img')?.src || '');

                const avatarHTML = avatarSrc
                ? `<img src="${avatarSrc}" class="fav-avatar" alt="avatar">`: `<div class="fav-avatar"><i class="fas fa-user"></i></div>`;

                const name = isMe ? settings.myName: settings.partnerName;


                let contentHTML = msg.text ? `<span>${msg.text.replace(/\n/g, '<br>')}</span>`: '';
                if (msg.image) contentHTML += `<img src="${msg.image}" alt="å›¾ç‰‡" loading="lazy">`;


                const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                return `
            <div class="fav-card" id="fav-card-${msg.id}">
            ${avatarHTML}
            <div class="fav-content-wrapper">
            <div class="fav-header">
            <span class="fav-sender-name">${name}</span>
            <span style="opacity:0.6">${timeStr}</span>
            </div>
            <div class="fav-bubble">
            ${contentHTML}
            </div>
            <button class="fav-action-btn" onclick="removeFavorite(${msg.id})">
            <i class="fas fa-trash-alt"></i> ç§»é™¤
            </button>
            </div>
            </div>`;
            }).join('');
        }


        window.removeFavorite = function(msgId) {
            const message = messages.find(m => m.id === msgId);
            if (message) {
                message.favorited = false;

                const card = document.getElementById(`fav-card-${msgId}`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        renderFavorites();
                        throttledSaveData();
                        const chatMsgBtn = document.querySelector(`.message-wrapper[data-id="${msgId}"] .favorite-meta-btn`);
                        if (chatMsgBtn) chatMsgBtn.classList.remove('favorited');
                    },
                        300);
                }
            }
        };

        function showModal(modalElement, focusElement = null) {
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                const content = modalElement.querySelector('.modal-content');
                content.style.opacity = '1';
                content.style.transform = 'translateY(0) scale(1)';
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 100);
                }
            });
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => {
                modalElement.style.display = 'none';
            }, 300);
        }

        function viewImage(src) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content" style="max-width: 90%; max-height: 90%; background: transparent; box-shadow: none; padding: 0;"><img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;"></div>`;
            const closeModal = () => document.body.removeChild(modal);
            modal.addEventListener('click', closeModal);
            document.body.appendChild(modal);
        }

        function exportChatHistory() {
            try {
                const dataStr = JSON.stringify({
                    version: "3.0",
                    exportDate: new Date().toISOString(),
                    messages,
                    settings,
                    customReplies,
                    anniversaries,
                    customThemes,
                    stickerLibrary
                },
                    null,
                    2);


                if (navigator.share && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {

                    const blob = new Blob([dataStr], {
                        type: 'application/json;charset=utf-8'
                    });
                    const file = new File([blob], `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`, {
                        type: 'application/json'
                    });

                    if (navigator.canShare && navigator.canShare({
                        files: [file]
                    })) {
                        navigator.share({
                            files: [file],
                            title: 'èŠå¤©è®°å½•å¤‡ä»½',
                            text: `èŠå¤©è®°å½•å¤‡ä»½ - ${new Date().toLocaleDateString()}`
                        }).then(() => {
                            showNotification('åˆ†äº«æˆåŠŸ', 'success');
                        }).catch((error) => {
                            console.error('åˆ†äº«å¤±è´¥:', error);
                            fallbackExport(dataStr);
                        });
                    } else {
                        fallbackExport(dataStr);
                    }
                } else {

                    fallbackExport(dataStr);
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function fallbackExport(dataStr) {
            const dataBlob = new Blob([dataStr], {
                type: 'application/json;charset=utf-8'
            });
            const url = URL.createObjectURL(dataBlob);


            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);


            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(`æˆåŠŸå¯¼å‡º ${messages.length} æ¡æ¶ˆæ¯`, 'success');
        }

        function importChatHistory(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.messages || !Array.isArray(importedData.messages)) throw new Error('æ— æ•ˆçš„èŠå¤©è®°å½•æ–‡ä»¶');
                    if (messages.length > 0 && !confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰ä¼šè¯çš„èŠå¤©è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) return;

                    messages = importedData.messages.map(m => ({
                        ...m, timestamp: new Date(m.timestamp)
                    }));
                    if (importedData.settings) Object.assign(settings, importedData.settings);
                    if (importedData.customReplies) customReplies = importedData.customReplies;
                    if (importedData.anniversaries) anniversaries = importedData.anniversaries;
                    if(importedData.customThemes) customThemes = importedData.customThemes;
                    if(importedData.stickerLibrary) stickerLibrary = importedData.stickerLibrary;

                    saveData();
                    updateUI();
                    showNotification(`æˆåŠŸå¯¼å…¥ ${messages.length} æ¡æ¶ˆæ¯`, 'success');
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸå', 'error');
                }
            };
            reader.onerror = () => showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            reader.readAsText(file);
        }

        const checkStatusChange = () => {
            if ((Date.now() - settings.lastStatusChange) / 36e5 >= settings.nextStatusChange) {
if (customStatuses && customStatuses.length > 0) {
    settings.partnerStatus = getRandomItem(customStatuses);
}
                settings.lastStatusChange = Date.now();
                settings.nextStatusChange = 1 + Math.random() * 7;
                DOMElements.partner.status.textContent = settings.partnerStatus;
                throttledSaveData();
            }
        };


function renderStatsContent() {
            const statsContent = DOMElements.statsModal.content;

            const partnerMessages = messages.filter(msg =>
                msg.sender === 'partner' &&
                msg.text &&
                msg.type !== 'system'
            );
            
            const myMessages = messages.filter(msg =>
                msg.sender === 'user' &&
                msg.text &&
                msg.type !== 'system'
            );

            if (partnerMessages.length === 0 && myMessages.length === 0) {
                statsContent.innerHTML = `
                    <div class="stats-empty-state">
                        <div class="stats-empty-icon"><i class="fas fa-chart-pie"></i></div>
                        <h3>æš‚æ— æ•°æ®</h3>
                        <p>å¤šèŠå‡ å¥å†æ¥çœ‹çœ‹å§...</p>
                    </div>`;
                return;
            }

            const getTopReplies = (msgs) => {
                const countMap = {};
                msgs.forEach(msg => {
                    const text = msg.text.trim();
                    if (text) {
                        countMap[text] = (countMap[text] || 0) + 1;
                    }
                });
                return Object.entries(countMap)
                    .map(([text, count]) => ({ text, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); 
            };

            const partnerTop = getTopReplies(partnerMessages);
            const myTop = getTopReplies(myMessages);

            const generateRankHTML = (list, colorClass) => {
                if (list.length === 0) return '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">æš‚æ— æ•°æ®</div>';
                
                const maxVal = list[0].count;
                return list.map((item, index) => {
                    const percent = (item.count / maxVal) * 100;
                    return `
                    <div class="rank-item">
                        <div class="rank-progress-bg" style="width: ${percent}%; opacity: 0.1; background-color: var(--text-primary);"></div>
                        <div class="rank-info">
                            <div class="rank-number">#${index + 1}</div>
                            <div class="rank-text" title="${item.text}">${item.text}</div>
                            <div class="rank-count">${item.count}æ¬¡</div>
                        </div>
                    </div>
                    `;
                }).join('');
            };

            const allMsgs = messages.filter(m => m.timestamp);
            const firstMsg = allMsgs.length > 0 ? allMsgs[0] : { timestamp: new Date() };
            const lastMsg = allMsgs.length > 0 ? allMsgs[allMsgs.length - 1] : { timestamp: new Date() };

            const formatDate = (dateObj) => {
                return new Date(dateObj).toLocaleDateString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
            };

            statsContent.innerHTML = `
                <div class="stats-dashboard">
                    <div class="stats-overview-grid">
                        <div class="overview-item">
                            <div class="overview-value">${messages.length}</div>
                            <div class="overview-label">æ€»æ¶ˆæ¯æ•°</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${myMessages.length}</div>
                            <div class="overview-label">æˆ‘å‘é€çš„</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(firstMsg.timestamp)}</div>
                            <div class="overview-label">åˆæ¬¡ç›¸é‡</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(lastMsg.timestamp)}</div>
                            <div class="overview-label">æœ€è¿‘è”ç»œ</div>
                        </div>
                    </div>

                    <div class="stats-card">
                        <div class="stats-card-title">
                            <i class="fas fa-user-circle"></i> å¯¹æ–¹é«˜é¢‘è¯ TOP 5
                        </div>
                        <div class="stats-rank-list">
                            ${generateRankHTML(partnerTop)}
                        </div>
                    </div>

                    <div class="stats-card">
                        <div class="stats-card-title">
                            <i class="fas fa-user"></i> æˆ‘æ–¹é«˜é¢‘è¯ TOP 5
                        </div>
                        <div class="stats-rank-list">
                            ${generateRankHTML(myTop)}
                        </div>
                    </div>
                </div>
            `;
        }
        function renderSessionList() {
            const listContainer = DOMElements.sessionModal.list;
            if (sessionList.length === 0) {
                listContainer.innerHTML = '<div class="stats-empty" style="padding: 20px 0;"><p>è¿˜æ²¡æœ‰ä¼šè¯</p></div>';
                return;
            }
            listContainer.innerHTML = sessionList.map(session => `
            <div class="session-item ${session.id === SESSION_ID ? 'active': ''}" data-id="${session.id}">
            <div class="session-info">
            <div class="session-name">${session.name}</div>
            <div class="session-meta">åˆ›å»ºäºŽ ${new Date(session.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="session-actions">
            <button class="session-action-btn rename" title="é‡å‘½å"><i class="fas fa-pen"></i></button>
            <button class="session-action-btn delete" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
            </div>
            </div>
            `).join('');
        }


async function generateFortune() {
    const todayKey = new Date().toDateString();
    const storageKey = `${APP_PREFIX}daily_fortune`;
    let fortuneData = null;

    try {
        const savedData = await localforage.getItem(storageKey);
        if (savedData && savedData.date === todayKey) {
            fortuneData = savedData;
        }
    } catch (e) { console.warn("è¯»å–è¿åŠ¿å¤±è´¥", e); }

    if (!fortuneData) {
        const cards = CONSTANTS.TAROT_CARDS;
        const randomIndex = Math.floor(Math.random() * cards.length);
        const isUpright = Math.random() > 0.5;

        fortuneData = {
            date: todayKey,
            cardIndex: randomIndex,
            isUpright: isUpright
        };
        await localforage.setItem(storageKey, fortuneData);
    }

    renderFortuneCardInteractive(fortuneData);
}

function renderFortuneCardInteractive(data) {
    const modal = document.getElementById('fortune-modal');
    const content = document.getElementById('fortune-content');
    
    if (!modal || !content) return showNotification('ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');

    const card = CONSTANTS.TAROT_CARDS[data.cardIndex];
    const isUpright = data.isUpright;

    content.innerHTML = `
        <div style="text-align:center; margin-bottom:10px; color:var(--text-secondary); font-size:12px;">
            <i class="fas fa-hand-pointer"></i> ç‚¹å‡»å¡ç‰Œæ­æ™“ä»Šæ—¥æŒ‡å¼•
        </div>
        
        <div class="tarot-container-3d" onclick="this.classList.toggle('flipped'); document.getElementById('fortune-text-area').classList.add('visible');">
            <div class="tarot-card-inner">
                <div class="tarot-face tarot-front">
                    <div class="tarot-pattern"><i class="fas fa-star-and-crescent"></i></div>
                    <div style="margin-top:10px; font-size:12px; letter-spacing:2px;">THE FATE</div>
                </div>

                <div class="tarot-face tarot-back">
                    <div class="tarot-visual ${isUpright ? '' : 'reversed'}" style="height:100px;">
                        <i class="fas ${card.icon} tarot-icon-vector" style="font-size:48px;"></i>
                    </div>
                    <div>
                        <div class="tarot-card-name" style="font-size:18px;">${card.name}</div>
                        <div class="tarot-position-badge ${isUpright ? 'upright' : 'reversed'}" style="margin:5px 0;">
                            ${isUpright ? "æ­£ä½" : "é€†ä½"}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fortune-text-area" class="fortune-result-area">
            <div class="tarot-keyword" style="font-size:16px; margin-bottom:8px;">ã€Œ${card.keyword}ã€</div>
            <div class="fortune-desc" style="font-size:14px; margin-bottom:10px;">${card.meaning}</div>
            <div class="fortune-tip" style="font-size:12px; border-top:1px dashed var(--border-color); padding-top:8px;">
                ðŸ’¡ æŒ‡å¼•ï¼š${isUpright ? "é¡ºåŠ¿è€Œä¸ºï¼Œä¿æŒå½“ä¸‹çš„èƒ½é‡ã€‚" : "æ¢ä¸ªè§’åº¦æ€è€ƒï¼Œä¹Ÿè®¸æ˜¯è½¬æœºã€‚"}
            </div>
        </div>
    `;

    modal.style.display = 'flex';
    requestAnimationFrame(() => {
        modal.querySelector('.modal-content').style.opacity = '1';
        modal.querySelector('.modal-content').style.transform = 'translateY(0) scale(1)';
    });
}
function toggleBatchFavoriteMode() {
            isBatchFavoriteMode = !isBatchFavoriteMode;
            selectedMessages = [];

            if (isBatchFavoriteMode) {
                document.body.classList.add('batch-favorite-mode');
                showBatchFavoriteActions();
                showNotification('æ‰¹é‡æ”¶è—æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»æ¶ˆæ¯è¿›è¡Œé€‰æ‹©', 'info');
            } else {
                document.body.classList.remove('batch-favorite-mode');
                hideBatchFavoriteActions();
                showNotification('æ‰¹é‡æ”¶è—æ¨¡å¼å·²å…³é—­', 'info');
            }

            renderMessages(true);
        }

        function hideBatchFavoriteActions() {
            const actions = document.querySelector('.batch-favorite-actions');
            if (actions) {

                actions.style.animation = 'floatUpAction 0.3s reverse forwards';
                setTimeout(() => {
                    actions.remove();
                }, 300);
            }
        }


        function showBatchFavoriteActions() {

            if (document.querySelector('.batch-favorite-actions')) return;

            const actions = document.createElement('div');
            actions.className = 'batch-favorite-actions';

            actions.innerHTML = `
        <button class="batch-action-btn-pill batch-btn-cancel" id="cancel-batch-favorite">
        <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
        <button class="batch-action-btn-pill batch-btn-confirm" id="confirm-batch-favorite">
        <i class="fas fa-check"></i> ç¡®è®¤æ”¶è— (0)
        </button>
        `;
            document.body.appendChild(actions);

            document.getElementById('confirm-batch-favorite').addEventListener('click', confirmBatchFavorite);
            document.getElementById('cancel-batch-favorite').addEventListener('click', toggleBatchFavoriteMode);
        }


        function confirmBatchFavorite() {
            if (selectedMessages.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦æ”¶è—çš„æ¶ˆæ¯', 'warning');
                return;
            }


            const count = selectedMessages.length;


            selectedMessages.forEach(msgId => {
                const message = messages.find(m => m.id === msgId);
                if (message) {
                    message.favorited = true;
                }
            });


            throttledSaveData();


            toggleBatchFavoriteMode();


            showNotification(`å·²æˆåŠŸæ”¶è— ${count} æ¡æ¶ˆæ¯`, 'success');
        }



        function renderAnniversaries() {
    const list = DOMElements.anniversaryModal.list;
    if (anniversaries.length === 0) {
        list.innerHTML = '<div class="no-favorites" style="padding:20px 0;"><i class="fas fa-heart" style="font-size:24px;margin-bottom:10px;"></i><p>è¿˜æ²¡æœ‰è®°å½•çºªå¿µæ—¥</p></div>';
        return;
    }

    list.innerHTML = anniversaries.map(anniversary => {
        const startDate = new Date(anniversary.date);
        const now = new Date();
        let diffDays;
        
        if (anniversary.type === 'countdown') {
            diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) diffDays = 0; 
        } else {
            diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        }

        const typeClass = anniversary.type === 'countdown' ? 'type-future' : 'type-past';
        const tagText = anniversary.type === 'countdown' ? 'å€’æ•°' : 'çºªå¿µ';

        return `
        <div class="anniversary-card ${typeClass}" data-id="${anniversary.id}">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="ann-info">
                    <div class="ann-name">
                        ${anniversary.name} 
                        <span class="ann-tag">${tagText}</span>
                    </div>
                    <div class="ann-date">${startDate.toLocaleDateString()}</div>
                </div>
                <div class="ann-days">
                    <span class="ann-number">${diffDays}</span>
                    <span class="ann-label">Days</span>
                </div>
            </div>
            <div class="ann-delete-btn" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:opacity 0.2s;" 
                 onclick="deleteAnniversary(${anniversary.id}, event)">
                <i class="fas fa-times" style="font-size:12px;"></i>
            </div>
        </div>
        `;
    }).join('');
}

        function addAnniversary() {
    const name = DOMElements.anniversaryModal.nameInput.value.trim();
    const date = DOMElements.anniversaryModal.dateInput.value;

    if (!name || !date) {
        showNotification('è¯·å¡«å†™åç§°å’Œæ—¥æœŸ', 'error');
        return;
    }

    const newAnniversary = {
        id: Date.now(),
        name: name,
        date: date,
        type: currentAnniversaryType
    };

    anniversaries.push(newAnniversary);
    throttledSaveData();
    renderAnniversaries();
    DOMElements.anniversaryModal.nameInput.value = '';
    DOMElements.anniversaryModal.dateInput.value = '';

    const annFormWrapper = document.getElementById('ann-form-wrapper');
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    if (annFormWrapper) annFormWrapper.classList.remove('active');
    if (annToggleBtn) annToggleBtn.classList.remove('active');

    showNotification('çºªå¿µæ—¥å·²æ·»åŠ ', 'success');
}

        function showAnniversaryAnimation(anniversary) {
            const startDate = new Date(anniversary.date);
            const now = new Date();
            let diffDays;
            let title, message;

            if (anniversary.type === 'countdown') {

                diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                title = "å€’æ•°æ—¥";
                message = `è·ç¦» ${anniversary.name} è¿˜æœ‰`;
            } else {

                diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                title = "çºªå¿µæ—¥å¿«ä¹ï¼";
                message = `æˆ‘ä»¬å·²ç»ç›¸ä¼´äº†`;
            }

            DOMElements.anniversaryAnimation.title.textContent = title;
            DOMElements.anniversaryAnimation.days.textContent = diffDays;
            DOMElements.anniversaryAnimation.message.textContent = message;

            DOMElements.anniversaryAnimation.modal.classList.add('active');
        }

        function updateAnniversaryDisplay(dateString) {
            if (!dateString) return;

            const start = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            DOMElements.anniversaryModal.daysElement.textContent = diffDays;
            DOMElements.anniversaryModal.dateShowElement.textContent = `èµ·å§‹æ—¥ï¼š${start.toLocaleDateString()}`;
            DOMElements.anniversaryModal.displayArea.style.display = 'block';
        }


const MOOD_OPTIONS = [
    { key: 'happy', kaomoji: 'ðŸ˜†', label: 'å¼€å¿ƒ', color: '#FFD93D' },
    { key: 'excited', kaomoji: 'ðŸ¥°', label: 'å…´å¥‹', color: '#FF6B6B' },
    { key: 'peace', kaomoji: 'â˜ºï¸', label: 'å¹³æ·¡', color: '#6BCB77' },
    { key: 'sad', kaomoji: 'ðŸ˜•', label: 'éš¾è¿‡', color: '#4D96FF' },
    { key: 'tired', kaomoji: 'ðŸ˜ž', label: 'ç–²æƒ«', color: '#8D9EFF' },
    { key: 'angry', kaomoji: 'ðŸ˜ ', label: 'ç”Ÿæ°”', color: '#FF4757' },
    { key: 'love', kaomoji: 'ðŸ¥°', label: 'æƒ³ä½ ', color: '#FF9A8B' },
    { key: 'busy', kaomoji: 'ðŸ˜µâ€ðŸ’«', label: 'å¿™ç¢Œ', color: '#A8D8EA' },
    { key: 'sleepy', kaomoji: 'ðŸ˜´', label: 'å›°å›°', color: '#E0C3FC' }
];

let moodData = {}; 
let currentCalendarDate = new Date();
let selectedDateStr = null; 
async function initMoodData() {
    const savedMoods = await localforage.getItem(getStorageKey('moodCalendar'));
    if (savedMoods) {
        moodData = savedMoods;
    }
    checkPartnerDailyMood();
}
function checkPartnerDailyMood() {
    const today = new Date();
    const dateStr = formatDateStr(today);
    
    if (!moodData[dateStr]) {
        moodData[dateStr] = {};
    }

    if (!moodData[dateStr].partner) {

        const randomMood = MOOD_OPTIONS[Math.floor(Math.random() * MOOD_OPTIONS.length)];
        
        moodData[dateStr].partner = randomMood.key;
        saveMoodData();
        console.log(`[Mood] å¯¹æ–¹å·²è®°å½•ä»Šæ—¥å¿ƒæƒ…: ${randomMood.label}`);
    }
}
function saveMoodData() {
    localforage.setItem(getStorageKey('moodCalendar'), moodData);
    renderMoodCalendar(); 
}
function formatDateStr(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}


let currentMoodSelection = null; 
function renderMoodCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthLabel = document.getElementById('calendar-month-label');
    
    if (!grid || !monthLabel) return;

    grid.innerHTML = '';
    
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    monthLabel.textContent = `${year}å¹´ ${month + 1}æœˆ`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); 

    let stats = {
        me: { total: 0, counts: {} },
        partner: { total: 0, counts: {} }
    };

    for (let i = 0; i < startDayOfWeek; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
    }

    const todayStr = formatDateStr(new Date());

    for (let d = 1; d <= daysInMonth; d++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateStr(dateObj);
        
        if (dateStr === todayStr) {
            dayDiv.classList.add('today');
            dayDiv.style.borderColor = 'var(--accent-color)';
        }

        const numSpan = document.createElement('span');
        numSpan.textContent = d;
        dayDiv.appendChild(numSpan);

        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'mood-dots-container';

        const dayData = moodData[dateStr];
        
        if (dayData) {
            if (dayData.user) {
                const moodObj = MOOD_OPTIONS.find(m => m.key === dayData.user);
                if (moodObj) {
                    stats.me.counts[moodObj.key] = (stats.me.counts[moodObj.key] || 0) + 1;
                    stats.me.total++;
                    const dot = createMoodDot(moodObj, dayData.note, false);
                    dotsContainer.appendChild(dot);
                }
            }
            if (dayData.partner) {
                const moodObj = MOOD_OPTIONS.find(m => m.key === dayData.partner);
                if (moodObj) {
                    stats.partner.counts[moodObj.key] = (stats.partner.counts[moodObj.key] || 0) + 1;
                    stats.partner.total++;
                    const dot = createMoodDot(moodObj, null, true); 
                    dotsContainer.appendChild(dot);
                }
            }
        }

        dayDiv.appendChild(dotsContainer);

        dayDiv.addEventListener('click', () => {
            if (dayData && dayData.user) {
                showDayDetails(dateStr, dayData);
            } else {
                openMoodSelector(dateStr);
            }
        });

        grid.appendChild(dayDiv);
    }

    updateDualMoodStats(stats);
}

function createMoodDot(moodObj, note, isPartner) {
    const dot = document.createElement('div');
    dot.className = `mood-detail-dot ${isPartner ? 'partner-mood' : ''}`;
    dot.style.backgroundColor = moodObj.color;
    
    if (isPartner) {
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span">Ta</span>
        `;
    } else {
        const displayText = (note && note.trim()) ? note : moodObj.label;
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span" style="margin-left:2px;">${displayText}</span>
        `;
    }
    return dot;
}
function updateDualMoodStats(stats) {
    const container = document.getElementById('mood-stats-container');
    if (!container) return;

    const myTotal = stats.me.total;
    const partnerTotal = stats.partner.total;
    
    const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
    const myPercent = daysInMonth > 0 ? (myTotal / daysInMonth) * 100 : 0;
    const partnerPercent = daysInMonth > 0 ? (partnerTotal / daysInMonth) * 100 : 0;

    let myDominant = { label: 'æ— ', kaomoji: 'ðŸ˜¶', color: '#ccc' };
    let myMaxCount = 0;
    Object.keys(stats.me.counts).forEach(key => {
        if (stats.me.counts[key] > myMaxCount) {
            myMaxCount = stats.me.counts[key];
            const m = MOOD_OPTIONS.find(o => o.key === key);
            if (m) myDominant = m;
        }
    });

    let partnerDominant = { label: 'æ— ', kaomoji: 'ðŸ˜¶', color: '#ccc' };
    let partnerMaxCount = 0;
    Object.keys(stats.partner.counts).forEach(key => {
        if (stats.partner.counts[key] > partnerMaxCount) {
            partnerMaxCount = stats.partner.counts[key];
            const m = MOOD_OPTIONS.find(o => o.key === key);
            if (m) partnerDominant = m;
        }
    });
    
    const createMoodBarHTML = (moodCounts, totalCount) => {
        if (totalCount <= 0) {
            return `<div class="mood-bar-container" style="justify-content: center; align-items: center; font-size: 10px; color: var(--text-secondary); background: var(--message-received-bg);">æ— æ•°æ®</div>`;
        }

        const segments = Object.keys(moodCounts)
            .map(key => {
                const count = moodCounts[key];
                const moodObj = MOOD_OPTIONS.find(m => m.key === key);
                if (moodObj) {
                    const percentage = (count / totalCount) * 100;
                    return `<div class="mood-bar-segment" style="width: ${percentage}%; background-color: ${moodObj.color};" title="${moodObj.label}: ${count}å¤©"></div>`;
                }
                return ''; 
            })
            .join(''); 
        return `<div class="mood-bar-container">${segments}</div>`;
    };

    const myBarHTML = createMoodBarHTML(stats.me.counts, myTotal);
    const partnerBarHTML = createMoodBarHTML(stats.partner.counts, partnerTotal);

    container.innerHTML = `
        <div class="mood-circles-wrapper" style="margin-bottom:20px;">
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${myPercent}%">
                    <span class="mood-circle-text" style="color:var(--accent-color)">${myTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker me" style="width:8px;height:8px;"></span> æˆ‘
                </div>
            </div>
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${partnerPercent}%; --accent-color: #ff6b6b;">
                    <span class="mood-circle-text" style="color:#ff6b6b">${partnerTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker partner" style="width:8px;height:8px;"></span> ${settings.partnerName}
                </div>
            </div>
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>æˆ‘çš„å¿ƒæƒ…</span>
                <div class="dominant-mood-tag">
                    <span style="color:${myDominant.color}; font-weight:bold;">${myDominant.kaomoji} ${myDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>è®°å½•å¤©æ•°: ${myTotal}</span>
            </div>
            ${myBarHTML}
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>${settings.partnerName}çš„å¿ƒæƒ…</span>
                <div class="dominant-mood-tag">
                    <span style="color:${partnerDominant.color}; font-weight:bold;">${partnerDominant.kaomoji} ${partnerDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>è®°å½•å¤©æ•°: ${partnerTotal}</span>
            </div>
            ${partnerBarHTML}
        </div>
    `;
}
function openMoodSelector(dateStr) {
    selectedDateStr = dateStr;
    currentMoodSelection = null; 

    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    const dateTitle = document.getElementById('mood-selector-date');
    const optionsGrid = document.getElementById('mood-options-grid');
    const noteInput = document.getElementById('mood-note-input');

    editorView.style.display = 'block';
    detailView.style.display = 'none';

    const [y, m, d] = dateStr.split('-');
    dateTitle.textContent = `${m}æœˆ${d}æ—¥`;
    
    const existing = moodData[dateStr];
    noteInput.value = existing && existing.note ? existing.note : '';
    const currentKey = existing ? existing.user : null;
    currentMoodSelection = currentKey;

    optionsGrid.innerHTML = MOOD_OPTIONS.map(mood => {
        const isSelected = currentKey === mood.key;
        return `
        <div class="mood-option-btn" 
             style="${isSelected ? `background:${mood.color}; color:#fff; border-color:${mood.color}; transform:scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,0.15);` : ''}"
             onclick="tempSelectMood('${mood.key}', this)">
            <div class="mood-kaomoji" style="${isSelected ? 'color:#fff' : `color:${mood.color}`}">${mood.kaomoji}</div>
            <div class="mood-label">${mood.label}</div>
        </div>
    `}).join('');

    overlay.classList.add('active');
}

window.tempSelectMood = function(key, btnElement) {
    currentMoodSelection = key;
    const allBtns = document.getElementById('mood-options-grid').children;
    Array.from(allBtns).forEach(btn => {
        btn.style.background = 'var(--primary-bg)';
        btn.style.color = 'var(--text-primary)';
        btn.style.borderColor = 'var(--border-color)';
        btn.style.transform = 'scale(1)';
        btn.style.boxShadow = 'none';
        const kaomoji = btn.querySelector('.mood-kaomoji');
    });
    const optionsGrid = document.getElementById('mood-options-grid');
    optionsGrid.innerHTML = MOOD_OPTIONS.map(mood => {
        const isSelected = currentMoodSelection === mood.key;
        return `
        <div class="mood-option-btn" 
             style="${isSelected ? `background:${mood.color}; color:#fff; border-color:${mood.color}; transform:scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,0.15);` : ''}"
             onclick="tempSelectMood('${mood.key}', this)">
            <div class="mood-kaomoji" style="${isSelected ? 'color:#fff' : `color:${mood.color}`}">${mood.kaomoji}</div>
            <div class="mood-label">${mood.label}</div>
        </div>
    `}).join('');
}

document.getElementById('confirm-mood-save').addEventListener('click', () => {
    if (!selectedDateStr) return;
    if (!currentMoodSelection) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…å›¾æ ‡', 'warning');
        return;
    }

    if (!moodData[selectedDateStr]) moodData[selectedDateStr] = {};
    
    moodData[selectedDateStr].user = currentMoodSelection;
    moodData[selectedDateStr].note = document.getElementById('mood-note-input').value.trim();
    
    saveMoodData();
    closeMoodOverlay();
    showNotification('è®°å½•å·²ä¿å­˜ âœ¨', 'success');
});

function showDayDetails(dateStr, data) {
    selectedDateStr = dateStr;
    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    
    const moodObj = MOOD_OPTIONS.find(m => m.key === data.user);
    if (!moodObj) return;

    const [y, m, d] = dateStr.split('-');
    
    document.getElementById('detail-date').textContent = `${m}æœˆ${d}æ—¥`;
    document.getElementById('detail-kaomoji').textContent = moodObj.kaomoji;
    document.getElementById('detail-label').textContent = moodObj.label;
    document.getElementById('detail-label').style.color = moodObj.color;
    document.getElementById('detail-text').textContent = data.note || "ï¼ˆè¿™å¤©æ²¡æœ‰å†™ä¸‹éšè®°...ï¼‰";
    
    detailView.style.borderLeftColor = moodObj.color;

    editorView.style.display = 'none';
    detailView.style.display = 'block';
    overlay.classList.add('active');
}

document.getElementById('edit-existing-mood').addEventListener('click', () => {
    openMoodSelector(selectedDateStr);
});

window.closeMoodOverlay = function() {
    document.getElementById('mood-selector-overlay').classList.remove('active');
};
document.getElementById('cancel-mood-edit').addEventListener('click', closeMoodOverlay);

function initMoodListeners() {

    const btnCalendar = document.getElementById('btn-view-calendar');
    const btnStats = document.getElementById('btn-view-stats');
    const viewCalendar = document.getElementById('mood-calendar-view');
    const viewStats = document.getElementById('mood-stats-view');

    if (btnCalendar && btnStats) {
        btnCalendar.addEventListener('click', () => {
            btnCalendar.classList.add('active');
            btnStats.classList.remove('active');
            viewCalendar.classList.remove('hidden-view');
            viewStats.classList.add('hidden-view');
        });

        btnStats.addEventListener('click', () => {
            btnStats.classList.add('active');
            btnCalendar.classList.remove('active');
            viewStats.classList.remove('hidden-view');
            viewCalendar.classList.add('hidden-view');
            renderMoodCalendar(); 
        });
    }
    const entryBtn = document.getElementById('mood-function');
    const modal = document.getElementById('mood-modal');
    if (entryBtn) {
        entryBtn.addEventListener('click', () => {
            hideModal(document.getElementById('advanced-modal'));
            renderMoodCalendar();
            showModal(modal);
        });
    }

    const closeMoodBtn = document.getElementById('close-mood');
    if (closeMoodBtn) {
        closeMoodBtn.addEventListener('click', () => hideModal(modal));
    }
    
    // ä¿®å¤ï¼šä½¿ç”¨å®‰å…¨æ£€æŸ¥ï¼Œå› ä¸ºclose-mood-selectorå¯èƒ½ä¸å­˜åœ¨
    const closeMoodSelectorBtn = document.getElementById('close-mood-selector');
    if (closeMoodSelectorBtn) {
        closeMoodSelectorBtn.addEventListener('click', () => {
            const overlay = document.getElementById('mood-selector-overlay');
            if (overlay) overlay.classList.remove('active');
        });
    }
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ cancel-mood-edit æŒ‰é’®
    const cancelMoodBtn = document.getElementById('cancel-mood-edit');
    if (cancelMoodBtn) {
        cancelMoodBtn.addEventListener('click', () => {
            const overlay = document.getElementById('mood-selector-overlay');
            if (overlay) overlay.classList.remove('active');
        });
    }

    const prevMonthBtn = document.getElementById('prev-month');
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderMoodCalendar();
        });
    }
    
    const nextMonthBtn = document.getElementById('next-month');
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderMoodCalendar();
        });
    }
}

async function checkEnvelopeStatus() {
    const pending = await localforage.getItem(getStorageKey('pending_envelope'));
    if (!pending) return;

    const now = Date.now();
    if (now >= pending.replyTime) {
        generateEnvelopeReply();
        await localforage.removeItem(getStorageKey('pending_envelope'));
    } else {
        console.log(`ä¿¡ä»¶è¿˜åœ¨é€”ä¸­ï¼Œé¢„è®¡å›žå¤æ—¶é—´: ${new Date(pending.replyTime).toLocaleString()}`);
    }
}

function generateEnvelopeReply() {
    const sourcePool = [...customReplies, ...CONSTANTS.REPLY_MESSAGES.filter(t => !disabledDefaultReplies.includes(t))];
    
    const sentenceCount = Math.floor(Math.random() * (12 - 8 + 1)) + 8;
    
    let replyContent = "";
    
    for (let i = 0; i < sentenceCount; i++) {
        const randomSentence = sourcePool[Math.floor(Math.random() * sourcePool.length)];
        const punctuation = Math.random() < 0.2 ? "ï¼" : (Math.random() < 0.2 ? "..." : "ã€‚");
        replyContent += randomSentence + punctuation;
    }

    addMessage({
        id: Date.now(),
        sender: 'partner',
        text: `ã€æ¥è‡ªè¿œæ–¹çš„å›žä¿¡ã€‘\n\n${replyContent}`,
        timestamp: new Date(),
        status: 'read',
        type: 'normal'
    });
    
    showNotification('æ”¶åˆ°äº†ä¸€å°å›žä¿¡ï¼', 'success');
    playSound('message');
}

function handleSendEnvelope() {
    const text = document.getElementById('envelope-input').value.trim();
    if (!text) {
        showNotification('ä¿¡ä»¶å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }

    addMessage({
        id: Date.now(),
        sender: 'user',
        text: `ã€å¯„å‡ºçš„ä¿¡ã€‘\n${text}`,
        timestamp: new Date(),
        status: 'sent',
        type: 'normal'
    });

    const minHours = 10;
    const maxHours = 24;
    const randomHours = Math.random() * (maxHours - minHours) + minHours;
    const delayMs = randomHours * 60 * 60 * 1000; 
    

    const replyTime = Date.now() + delayMs;

    localforage.setItem(getStorageKey('pending_envelope'), {
        sentTime: Date.now(),
        replyTime: replyTime
    });

    hideModal(document.getElementById('envelope-modal'));
    document.getElementById('envelope-input').value = '';
    showNotification(`ä¿¡ä»¶å·²å¯„å‡ºï¼Œé¢„è®¡ ${Math.floor(randomHours)} å°æ—¶åŽæ”¶åˆ°å›žä¿¡`, 'success');
}
        function setupEventListeners() {
    initCoreListeners();
    initModalListeners();
    initChatActionListeners();
    initHeaderAndSettingsListeners();
    initDataManagementListeners();
    initNewFeatureListeners();
    setupTutorialListeners();
    initMoodListeners();
initDecisionModule();
    initComboMenu(); 
    initUserStickerPicker(); 
}
let wheelOptions = ["æ˜¯", "å¦", "å†æƒ³ä¸€æƒ³", "å¬ä½ çš„"];
let currentWheelRotation = 0;
let wheelResultText = "";

function initDecisionModule() {
    const entryBtn = document.getElementById('decision-function'); 
    if(entryBtn) {
        // ç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        
        newBtn.addEventListener('click', () => {
            console.log('æŠ‰æ‹©æŒ‰é’®è¢«ç‚¹å‡»');
            hideModal(document.getElementById('advanced-modal'));
            showModal(document.getElementById('decision-menu-modal'));
        });
    } else {
        console.warn('æœªæ‰¾åˆ°decision-functionæŒ‰é’®');
    }

    const openCoinBtn = document.getElementById('open-coin-toss');
    const openWheelBtn = document.getElementById('open-wheel');
    const closeMenuBtn = document.getElementById('close-decision-menu');
    const closeWheelBtn = document.getElementById('close-wheel');
    const addOptionBtn = document.getElementById('add-wheel-option');
    const spinBtn = document.getElementById('spin-wheel-btn');
    const sendResultBtn = document.getElementById('send-wheel-result');

    if (openCoinBtn && !openCoinBtn.dataset.initialized) {
        openCoinBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            handleCoinToss(); 
        });
        openCoinBtn.dataset.initialized = 'true';
    }

    if (openWheelBtn && !openWheelBtn.dataset.initialized) {
        openWheelBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            initWheel();
            showModal(document.getElementById('wheel-modal'));
        });
        openWheelBtn.dataset.initialized = 'true';
    }
    
    if (closeMenuBtn && !closeMenuBtn.dataset.initialized) {
        closeMenuBtn.addEventListener('click', () => hideModal(document.getElementById('decision-menu-modal')));
        closeMenuBtn.dataset.initialized = 'true';
    }

    if (closeWheelBtn && !closeWheelBtn.dataset.initialized) {
        closeWheelBtn.addEventListener('click', () => hideModal(document.getElementById('wheel-modal')));
        closeWheelBtn.dataset.initialized = 'true';
    }

    if (addOptionBtn && !addOptionBtn.dataset.initialized) {
        addOptionBtn.addEventListener('click', () => {
            wheelOptions.push(`é€‰é¡¹ ${wheelOptions.length + 1}`);
            renderWheelOptions();
            drawWheel();
        });
        addOptionBtn.dataset.initialized = 'true';
    }

    if (spinBtn && !spinBtn.dataset.initialized) {
        spinBtn.addEventListener('click', spinWheel);
        spinBtn.dataset.initialized = 'true';
    }
    
    if (sendResultBtn && !sendResultBtn.dataset.initialized) {
        sendResultBtn.addEventListener('click', () => {
            if(wheelResultText) {
                sendMessage(`ðŸŽ¡ å‘½è¿è½¬ç›˜ç»“æžœï¼š${wheelResultText}`, 'normal');
                hideModal(document.getElementById('wheel-modal'));
                wheelResultText = "";
                sendResultBtn.style.display = 'none';
                document.getElementById('wheel-result').classList.remove('show');
                spinBtn.disabled = false;
            }
        });
        sendResultBtn.dataset.initialized = 'true';
    }
}

function initWheel() {
    renderWheelOptions();
    drawWheel();
    document.getElementById('wheel-result').textContent = "";
    document.getElementById('wheel-result').classList.remove('show');
    document.getElementById('send-wheel-result').style.display = 'none';
    currentWheelRotation = 0;
    document.getElementById('wheel-canvas').style.transform = `rotate(0deg)`;
}

function renderWheelOptions() {
    const list = document.getElementById('wheel-options-list');
    list.innerHTML = '';
    wheelOptions.forEach((opt, index) => {
        const item = document.createElement('div');
        item.className = 'wheel-option-item';
        item.innerHTML = `
            <input type="text" class="wheel-option-input" value="${opt}">
            <i class="fas fa-times wheel-option-remove"></i>
        `;
        
        item.querySelector('input').addEventListener('input', (e) => {
            wheelOptions[index] = e.target.value;
            drawWheel();
        });
        
        item.querySelector('.wheel-option-remove').addEventListener('click', () => {
            if(wheelOptions.length <= 2) {
                showNotification('è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹', 'warning');
                return;
            }
            wheelOptions.splice(index, 1);
            renderWheelOptions();
            drawWheel();
        });
        
        list.appendChild(item);
    });
}

function drawWheel() {
    const canvas = document.getElementById('wheel-canvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = width / 2;
    const len = wheelOptions.length;
    const arc = (2 * Math.PI) / len;
    
    ctx.clearRect(0, 0, width, height);
    
    const colors = ['#FFD93D', '#FF6B6B', '#6BCB77', '#4D96FF', '#E0C3FC', '#FF9A8B'];

    for (let i = 0; i < len; i++) {
        const angle = i * arc;
        ctx.beginPath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, angle, angle + arc);
        ctx.lineTo(centerX, centerY);
        ctx.fill();
        
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "bold 14px Arial";
        ctx.fillText(wheelOptions[i], radius - 20, 5);
        ctx.restore();
    }
}

function spinWheel() {
    const spinBtn = document.getElementById('spin-wheel-btn');
    const resultDisplay = document.getElementById('wheel-result');
    const sendBtn = document.getElementById('send-wheel-result');
    
    spinBtn.disabled = true;
    sendBtn.style.display = 'none';
    resultDisplay.classList.remove('show');

    const extraSpins = 5 * 360;
    const randomDegree = Math.floor(Math.random() * 360);
    const totalRotation = currentWheelRotation + extraSpins + randomDegree;
    
    const canvas = document.getElementById('wheel-canvas');
    canvas.style.transform = `rotate(-${totalRotation}deg)`; 
    currentWheelRotation = totalRotation; 

    setTimeout(() => {
        const actualRotation = totalRotation % 360;

        const len = wheelOptions.length;
        const arc = 360 / len;
        const index = Math.floor(((actualRotation + 90) % 360) / arc); 

        const degreeUnderPointer = (270 + actualRotation) % 360;
        const resultIndex = Math.floor(degreeUnderPointer / arc);

        wheelResultText = wheelOptions[(len - 1) - ((resultIndex + (len -1)) % len)]; 
        const passedCount = Math.floor(((totalRotation + 90) % 360) / arc);
        const finalIndex = (len - passedCount) % len;

        wheelResultText = wheelOptions[finalIndex];

        resultDisplay.textContent = `ðŸŽ‰ ${wheelResultText}`;
        resultDisplay.classList.add('show');
        spinBtn.disabled = false;
        sendBtn.style.display = 'inline-block';
        playSound('favorite'); 
        
    }, 4000);
}
function initComboMenu() {
    const comboBtn = document.getElementById('combo-btn');
    const picker = document.getElementById('user-sticker-picker');
    const contentArea = document.getElementById('combo-content-area');
    
    if (!comboBtn || !picker) return;
    
    // é˜²æ­¢é‡å¤ç»‘å®š
    if (comboBtn.dataset.initialized) return;
    
    // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    comboBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = picker.classList.contains('active');
        
        if (isActive) {
            picker.classList.remove('active');
        } else {
            // é»˜è®¤æ‰“å¼€è¡¨æƒ…åº“ Tab
            switchTab('sticker');
            picker.classList.add('active');
        }
    });
    
    comboBtn.dataset.initialized = 'true';

    // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
    document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && !comboBtn.contains(e.target)) {
            picker.classList.remove('active');
        }
    });

    // Tab åˆ‡æ¢é€»è¾‘
    const tabs = picker.querySelectorAll('.combo-tab-btn');
    tabs.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const tabId = btn.dataset.tab;
            switchTab(tabId);
        });
    });

    function switchTab(tabId) {
        // æ›´æ–° Tab æ ·å¼
        tabs.forEach(b => b.classList.remove('active'));
        const activeBtn = Array.from(tabs).find(b => b.dataset.tab === tabId);
        if (activeBtn) activeBtn.classList.add('active');

        // æ¸²æŸ“å†…å®¹
        if (tabId === 'sticker') {
            renderStickerLibrary();
        } else {
            renderUserPokeMenu();
        }
    }

    // æ¸²æŸ“è¡¨æƒ…åº“ï¼ˆç›´æŽ¥è¯»å– stickerLibraryï¼‰
    function renderStickerLibrary() {
        contentArea.innerHTML = '';
        
        if (!stickerLibrary || stickerLibrary.length === 0) {
            contentArea.innerHTML = `
                <div class="empty-sticker-tip">
                    <i class="far fa-images"></i>
                    è¡¨æƒ…åº“è¿˜æ˜¯ç©ºçš„å“¦<br>
                    è¯·åŽ»â€œé«˜çº§åŠŸèƒ½â€->â€œè‡ªå®šä¹‰å›žå¤â€->â€œè¡¨æƒ…åº“â€ä¸­æ·»åŠ å›¾ç‰‡~
                </div>
            `;
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'sticker-grid-view';

        stickerLibrary.forEach(src => {
            const item = document.createElement('div');
            item.className = 'sticker-grid-item';
            item.innerHTML = `<img src="${src}" loading="lazy">`;
            
            // ç‚¹å‡»å‘é€å›¾ç‰‡
            item.onclick = (e) => {
                e.stopPropagation();
                // æ¨¡æ‹Ÿå‘é€å›¾ç‰‡æ¶ˆæ¯
                addMessage({
                    id: Date.now(),
                    sender: 'user',
                    text: '',
                    timestamp: new Date(),
                    image: src, // ç›´æŽ¥ä½¿ç”¨ Base64
                    status: 'sent',
                    type: 'normal'
                });
                playSound('send');
                picker.classList.remove('active');
                
                // è§¦å‘å¯¹æ–¹å›žå¤
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            };
            grid.appendChild(item);
        });

        contentArea.appendChild(grid);
    }

    // æ¸²æŸ“è‡ªå®šä¹‰æ‹ä¸€æ‹ï¼ˆç”¨æˆ·è§†è§’ï¼‰
    function renderUserPokeMenu() {
        contentArea.innerHTML = '';

        const wrapper = document.createElement('div');
        wrapper.className = 'poke-list-view';

        // 1. è‡ªå®šä¹‰æŒ‰é’®ï¼ˆæ ¸å¿ƒéœ€æ±‚ï¼‰
        const customBtn = document.createElement('button');
        customBtn.className = 'custom-poke-btn';
        customBtn.innerHTML = '<i class="fas fa-pen"></i> è‡ªå®šä¹‰åŠ¨ä½œ';
        customBtn.onclick = (e) => {
            e.stopPropagation();
            picker.classList.remove('active');
            // æ‰“å¼€åŽŸæœ‰çš„æ‹ä¸€æ‹ Modal
            showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
        };
        wrapper.appendChild(customBtn);

        // 2. å¸¸ç”¨é¢„è®¾ï¼ˆä¸ºäº†æ–¹ä¾¿ï¼‰- è¿™äº›æ˜¯ç”¨æˆ·å‘å‡ºçš„åŠ¨ä½œ
        const userPresets = [
            "æ‹äº†æ‹å¯¹æ–¹çš„å¤´",
            "æˆ³äº†æˆ³å¯¹æ–¹çš„è„¸é¢Š",
            "æŠ±ä½äº†å¯¹æ–¹",
            "ç»™å¯¹æ–¹æ¯”äº†ä¸ªå¿ƒ",
            "ç‰µèµ·äº†å¯¹æ–¹çš„æ‰‹",
            "çœ‹ç€å¯¹æ–¹å‘å‘†"
        ];

        const title = document.createElement('div');
        title.style.fontSize = '12px';
        title.style.color = 'var(--text-secondary)';
        title.style.marginBottom = '5px';
        title.innerText = 'å¿«æ·åŠ¨ä½œ';
        wrapper.appendChild(title);

        userPresets.forEach(text => {
            const item = document.createElement('div');
            item.className = 'poke-quick-item';
            item.innerText = text;
            item.onclick = (e) => {
                e.stopPropagation();
                // ç›´æŽ¥å‘é€ç³»ç»Ÿæ¶ˆæ¯
                addMessage({
                    id: Date.now(),
                    text: `âœ¦ ${settings.myName} ${text} âœ¦`, 
                    timestamp: new Date(),
                    type: 'system' // å…³é”®ï¼šç³»ç»Ÿæ¶ˆæ¯ç±»åž‹
                });
                picker.classList.remove('active');
                
                // è§¦å‘å¯¹æ–¹å›žå¤
                setTimeout(simulateReply, 1500);
            };
            wrapper.appendChild(item);
        });

        contentArea.appendChild(wrapper);
    }
}
function renderComboMenu() {
    const content = document.getElementById('user-sticker-content');
    content.innerHTML = '';
    
    // æ·»åŠ é¡¶éƒ¨åˆ‡æ¢æŒ‰é’®
    const tabBar = document.createElement('div');
    tabBar.style.cssText = 'display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--border-color);';
    tabBar.innerHTML = `
        <button class="combo-tab active" data-tab="emoji" style="flex:1; padding:8px; border:none; background:var(--accent-color); color:#fff; border-radius:8px; cursor:pointer;">
            ðŸ˜Š è¡¨æƒ…
        </button>
        <button class="combo-tab" data-tab="poke" style="flex:1; padding:8px; border:none; background:var(--secondary-bg); color:var(--text-primary); border-radius:8px; cursor:pointer;">
            âœ¨ æ‹ä¸€æ‹
        </button>
    `;
    
    const contentArea = document.createElement('div');
    contentArea.id = 'combo-content-area';
    contentArea.style.cssText = 'padding:10px; max-height:240px; overflow-y:auto;';
    
    content.appendChild(tabBar);
    content.appendChild(contentArea);
    
    // é»˜è®¤æ˜¾ç¤ºè¡¨æƒ…
    showEmojiTab();
    
    // ç»‘å®šåˆ‡æ¢äº‹ä»¶
    tabBar.querySelectorAll('.combo-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            tabBar.querySelectorAll('.combo-tab').forEach(b => {
                b.style.background = 'var(--secondary-bg)';
                b.style.color = 'var(--text-primary)';
                b.classList.remove('active');
            });
            btn.style.background = 'var(--accent-color)';
            btn.style.color = '#fff';
            btn.classList.add('active');
            
            if (btn.dataset.tab === 'emoji') {
                showEmojiTab();
            } else {
                showPokeTab();
            }
        });
    });
}

function showEmojiTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'grid';
    area.style.gridTemplateColumns = 'repeat(5, 1fr)';
    area.style.gap = '8px';
    
    // Emojiè¡¨æƒ…
    CONSTANTS.REPLY_EMOJIS.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<span style="font-size:24px;">${emoji}</span>`;
        item.onclick = () => {
            const input = document.getElementById('message-input');
            input.value += emoji;
            document.getElementById('user-sticker-picker').classList.remove('active');
            input.focus();
        };
        area.appendChild(item);
    });

    // è¡¨æƒ…å›¾ç‰‡
    stickerLibrary.forEach(src => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:6px;">`;
        item.onclick = () => {
            addMessage({
                id: Date.now(),
                sender: 'user',
                text: '',
                timestamp: new Date(),
                image: src,
                status: 'sent',
                type: 'normal'
            });
            playSound('send');
            document.getElementById('user-sticker-picker').classList.remove('active');
            
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(item);
    });
}

function showPokeTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'flex';
    area.style.flexDirection = 'column';
    area.style.gap = '8px';
    
    const quickPokes = customPokes.slice(0, 6);
    
    quickPokes.forEach(pokeText => {
        const btn = document.createElement('button');
        btn.textContent = pokeText;
        btn.style.cssText = `
            padding: 10px;
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        `;
        btn.addEventListener('mouseover', () => {
            btn.style.background = 'var(--accent-color)';
            btn.style.color = '#fff';
        });
        btn.addEventListener('mouseout', () => {
            btn.style.background = 'var(--secondary-bg)';
            btn.style.color = 'var(--text-primary)';
        });
        btn.onclick = () => {
            addMessage({
                id: Date.now(), 
                text: `âœ¦ ${settings.myName} ${pokeText} âœ¦`, 
                timestamp: new Date(), 
                type: 'system'
            });
            document.getElementById('user-sticker-picker').classList.remove('active');
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(btn);
    });
    
    const customBtn = document.createElement('button');
    customBtn.innerHTML = '<i class="fas fa-edit"></i> è‡ªå®šä¹‰æ‹ä¸€æ‹';
    customBtn.style.cssText = `
        padding: 10px;
        background: var(--accent-color);
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    `;
    customBtn.onclick = () => {
        document.getElementById('user-sticker-picker').classList.remove('active');
        showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
    };
    area.appendChild(customBtn);
}
function initUserStickerPicker() {
    const stickerBtn = document.getElementById('user-sticker-btn');
    const picker = document.getElementById('user-sticker-picker');
    const content = document.getElementById('user-sticker-content');
    
    stickerBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = picker.classList.contains('active');
        if (isActive) {
            picker.classList.remove('active');
        } else {
            renderUserStickers(); 
            picker.classList.add('active');
        }
    });

    document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && !stickerBtn.contains(e.target)) {
            picker.classList.remove('active');
        }
    });

    function renderUserStickers() {
        content.innerHTML = '';
        
        CONSTANTS.REPLY_EMOJIS.forEach(emoji => {
            const item = document.createElement('div');
            item.className = 'picker-item';
            item.innerHTML = `<span>${emoji}</span>`;
            item.onclick = () => {
                const input = document.getElementById('message-input');
                input.value += emoji;
                picker.classList.remove('active');
                input.focus();
            };
            content.appendChild(item);
        });

        stickerLibrary.forEach(src => {
            const item = document.createElement('div');
            item.className = 'picker-item';
            item.innerHTML = `<img src="${src}">`;
            item.onclick = () => {
                sendMessage(null, 'normal');
                addMessage({
                    id: Date.now(),
                    sender: 'user',
                    text: '',
                    timestamp: new Date(),
                    image: src,
                    status: 'sent',
                    type: 'normal'
                });
                playSound('send');
                picker.classList.remove('active');
                
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            };
            content.appendChild(item);
        });
    }
}
        function initCoreListeners() {


            DOMElements.chatContainer.addEventListener('scroll', () => {
                const container = DOMElements.chatContainer;


                if (container.scrollTop < 50 && !isLoadingHistory && messages.length > displayedMessageCount) {
                    isLoadingHistory = true;


                    const loader = document.getElementById('history-loader');
                    if (loader) loader.classList.add('visible');


                    setTimeout(() => {

                        displayedMessageCount += HISTORY_BATCH_SIZE;


                        renderMessages(true);


                        if (loader) loader.classList.remove('visible');
                        isLoadingHistory = false;
                    },
                        600);
                }
            });

            DOMElements.sendBtn.addEventListener('click', () => isBatchMode ? addToBatch(): sendMessage());
            DOMElements.messageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); isBatchMode ? addToBatch(): sendMessage();
                }
            });
            DOMElements.messageInput.addEventListener('input', () => {
                DOMElements.messageInput.style.height = 'auto'; DOMElements.messageInput.style.height = `${Math.min(DOMElements.messageInput.scrollHeight, 120)}px`;
            });


            DOMElements.attachmentBtn.addEventListener('click', () => {

                const modal = document.createElement('div');
                modal.className = 'modal image-upload-modal';
                modal.style.cssText = `
            display: flex !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            `;

                modal.innerHTML = `
            <div class="modal-content" style="
            z-index: 10000;
            position: relative;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            ">
            <div class="modal-title"><i class="fas fa-image"></i><span>å‘é€å›¾ç‰‡</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary upload-mode-btn active" id="upload-image-file-btn" style="flex: 1;">é€‰æ‹©æ–‡ä»¶</button>
            <button class="modal-btn modal-btn-secondary upload-mode-btn" id="paste-image-url-btn" style="flex: 1;">ç²˜è´´URL</button>
            </div>
            <input type="file" class="modal-input" id="image-file-input" accept="image/*">
            <input type="text" class="modal-input" id="image-url-input" placeholder="è¾“å…¥å›¾ç‰‡URLåœ°å€" style="display: none;">
            <div id="image-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-image">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" id="send-image" disabled>å‘é€</button>
            </div>
            </div>
            `;

                document.body.appendChild(modal);


                setTimeout(() => {
                    modal.style.opacity = '1';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);

                const fileInput = document.getElementById('image-file-input');
                const urlInput = document.getElementById('image-url-input');
                const uploadBtn = document.getElementById('upload-image-file-btn');
                const pasteUrlBtn = document.getElementById('paste-image-url-btn');
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-chat-image');
                const sendBtn = document.getElementById('send-image');
                const cancelBtn = document.getElementById('cancel-image');
                const uploadModeBtns = document.querySelectorAll('.upload-mode-btn');

                let currentImageData = null;


                function switchUploadMode(isFileMode) {
                    uploadModeBtns.forEach(btn => btn.classList.remove('active'));
                    if (isFileMode) {
                        uploadBtn.classList.add('active');
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        pasteUrlBtn.classList.add('active');
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                        urlInput.focus();
                    }

                    previewDiv.style.display = 'none';
                    sendBtn.disabled = true;
                    currentImageData = null;
                }


                uploadBtn.addEventListener('click', () => switchUploadMode(true));


                pasteUrlBtn.addEventListener('click', () => switchUploadMode(false));


                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_IMAGE_SIZE) {
                            showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                            return;
                        }
                        showNotification('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡...', 'info', 1500);
                        optimizeImage(file).then(optimizedData => {
                            currentImageData = optimizedData;
                            previewImg.src = currentImageData;
                            previewDiv.style.display = 'block';
                            sendBtn.disabled = false;
                        }).catch(() => {
                            showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
                        });
                    }
                });


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|bmp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentImageData = url;
                                sendBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                    showNotification('å›¾ç‰‡URLæœ‰æ•ˆ', 'success', 1000);
                                };
                                img.onerror = function() {
                                    showNotification('å›¾ç‰‡URLæ— æ•ˆæˆ–æ— æ³•è®¿é—®', 'error');
                                    sendBtn.disabled = true;
                                    previewDiv.style.display = 'none';
                                };
                                img.src = url;
                            } else {
                                sendBtn.disabled = true;
                                previewDiv.style.display = 'none';
                            }
                        } else {
                            sendBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                sendBtn.addEventListener('click',
                    () => {
                        if (currentImageData) {

                            addMessage({
                                id: Date.now(),
                                sender: 'user',
                                text: '',
                                timestamp: new Date(),
                                image: currentImageData,
                                status: 'sent',
                                favorited: false,
                                note: null,
                                replyTo: currentReplyTo,
                                type: 'normal'
                            });
                            playSound('send');
                            currentReplyTo = null;
                            updateReplyPreview();
                            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                            setTimeout(simulateReply, randomDelay);


                            closeModal();
                        }
                    });


                cancelBtn.addEventListener('click',
                    closeModal);


                function closeModal() {
                    modal.style.opacity = '0';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    },
                        300);
                }


                modal.addEventListener('click',
                    (e) => {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });


                modal.querySelector('.modal-content').addEventListener('click',
                    (e) => {
                        e.stopPropagation();
                    });


                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);


                modal.addEventListener('close', () => {
                    document.removeEventListener('keydown', handleEscKey);
                });
            });


            DOMElements.imageInput.addEventListener('change', () => {
                if (DOMElements.imageInput.files[0]) {
                    if (isBatchMode) {
                        showNotification('æ‰¹é‡æ¨¡å¼ä¸æ”¯æŒå›¾ç‰‡', 'warning');
                        DOMElements.imageInput.value = '';
                    } else {
                        sendMessage();
                    }
                }
            });

            DOMElements.continueBtn.addEventListener('click', simulateReply);
            DOMElements.batchBtn.addEventListener('click', toggleBatchMode);
            // DOMElements.pokeBtn.addEventListener('click', () => showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input)); // å·²æ³¨é‡Š:æŒ‰é’®ä¸å­˜åœ¨
        }

function initChatActionListeners() {
            DOMElements.chatContainer.addEventListener('click', (e) => {

                if (isBatchFavoriteMode) {
                    const wrapper = e.target.closest('.message-wrapper');
                    if (wrapper && !e.target.closest('.message-meta-actions')) {
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);

                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            wrapper.classList.remove('selected');
                        } else {
                            selectedMessages.push(messageId);
                            wrapper.classList.add('selected');
                        }

                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `ç¡®è®¤æ”¶è— (${selectedMessages.length})`;
                        }
                        return;
                    }
                }

                const favoriteBtn = e.target.closest('.favorite-action-btn'); 
                if (favoriteBtn) {
                    const wrapper = e.target.closest('.message-wrapper');
                    const messageId = Number(wrapper.dataset.id);
                    const message = messages.find(m => m.id === messageId);
                    
                    if (message) {
                        message.favorited = !message.favorited;
                        
                        showNotification(message.favorited ? 'å·²æ”¶è—': 'å·²å–æ¶ˆæ”¶è—', 'success', 1500);
                        playSound('favorite');
                        
                        throttledSaveData();
                        
                        renderMessages(true);
                    }
                    return;
                }

                const target = e.target.closest('.meta-action-btn');
                if (!target) return;
                
                const wrapper = e.target.closest('.message-wrapper');
                if (!wrapper) return; 
                
                const messageId = Number(wrapper.dataset.id);
                const message = messages.find(m => m.id === messageId);
                if (!message) return;

if (target.classList.contains('delete-btn')) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        const index = messages.findIndex(m => m.id === messageId);
        if (index > -1) {
            messages.splice(index, 1); 
            throttledSaveData(); 
            renderMessages(true); 
            showNotification('æ¶ˆæ¯å·²åˆ é™¤', 'success');
        }
    }
    return;
}
                if (target.classList.contains('reply-btn')) {
                    currentReplyTo = {
                        id: message.id,
                        sender: message.sender,
                        text: message.text
                    };
                    updateReplyPreview();
                    DOMElements.messageInput.focus();
                    const targetMessageElement = DOMElements.chatContainer.querySelector(`[data-id="${message.id}"]`);
                    if (targetMessageElement) targetMessageElement.scrollIntoView({
                        behavior: 'smooth', block: 'center'
                    });
                    return;
                } 
                else if (target.classList.contains('note-btn')) {
                    currentNoteMessageId = messageId;
                    DOMElements.noteModal.input.value = message.note || '';
                    showModal(DOMElements.noteModal.modal, DOMElements.noteModal.input);
                    return;
                }

                throttledSaveData();
            });

            DOMElements.batchPreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.batch-preview-remove');
                if (removeBtn) {
                    const index = removeBtn.closest('.batch-preview-item').dataset.index;
                    batchMessages.splice(index, 1); updateBatchPreview();
                }
                const sendBtn = e.target.closest('.batch-send-btn');
                if (sendBtn && !sendBtn.disabled) sendBatchMessages();
                if (e.target.matches('.batch-cancel-btn')) {
                    isBatchMode = false; DOMElements.batchBtn.classList.remove('active');
                    DOMElements.batchPreview.style.display = 'none';
                    const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
                    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
                    batchMessages = [];
                }
            });
        }
        function initModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const cancelBtn = modal.querySelector('.modal-buttons .modal-btn-secondary');
                if (cancelBtn) cancelBtn.addEventListener('click', () => hideModal(modal));
            });

            DOMElements.editModal.input.addEventListener('input', () => {
                DOMElements.editModal.save.disabled = !DOMElements.editModal.input.value.trim();
            });
            DOMElements.noteModal.save.addEventListener('click', () => {
                const message = messages.find(m => m.id === currentNoteMessageId);
                if (message) {
                    message.note = DOMElements.noteModal.input.value.trim() || null;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('æ³¨é‡Šå·²ä¿å­˜', 'success');
                }
                hideModal(DOMElements.noteModal.modal);
            });

            DOMElements.pokeModal.save.addEventListener('click', () => {
                let pokeText = DOMElements.pokeModal.input.value.trim() || `${settings.myName} æ‹äº†æ‹ ${settings.partnerName}`;
                addMessage({
                    id: Date.now(), text: `âœ¦ ${pokeText} âœ¦`, timestamp: new Date(), type: 'system'
                });
                hideModal(DOMElements.pokeModal.modal);
                DOMElements.pokeModal.input.value = '';
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            });


            DOMElements.cancelCoinResult.addEventListener('click', () => {
                DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                lastCoinResult = null;
            });


            DOMElements.sendCoinResult.addEventListener('click', () => {
                if (lastCoinResult) {
                    sendMessage(`ðŸŽ² æŠ›ç¡¬å¸ç»“æžœï¼š${lastCoinResult}`, 'normal');
                    DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                    lastCoinResult = null;
                }
            });


            const retryBtn = document.getElementById('retry-coin-toss');

            if (retryBtn) {
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();

                    startCoinFlipAnimation();
                });
            }
        }

        function initHeaderAndSettingsListeners() {

            const openNameModal = (isPartner) => {
                const modal = DOMElements.editModal;
                showModal(modal.modal, modal.input);
                modal.title.textContent = `ä¿®æ”¹${isPartner ? (settings.partnerName || 'å¯¹æ–¹'): 'æˆ‘'}çš„æ˜µç§°`;
                modal.input.value = isPartner ? settings.partnerName: settings.myName;
                modal.save.disabled = !modal.input.value.trim();
                modal.save.onclick = () => {
                    const newName = modal.input.value.trim();
                    if (newName) {
                        isPartner ? settings.partnerName = newName: settings.myName = newName;
                        throttledSaveData();
                        updateUI();
                        showNotification('æ˜µç§°å·²æ›´æ–°', 'success');
                    }
                    hideModal(modal.modal);
                };
            };

            const openAvatarModal = (isPartner) => {
                const modal = DOMElements.avatarModal;

                modal.modal.querySelector('.modal-content').innerHTML = `
            <div class="modal-title"><i class="fas fa-portrait"></i><span>ä¸Šä¼ ${isPartner ? 'å¯¹æ–¹': 'æˆ‘'}çš„å¤´åƒ</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary" id="upload-file-btn" style="flex: 1;">é€‰æ‹©æ–‡ä»¶</button>
            <button class="modal-btn modal-btn-secondary" id="paste-url-btn" style="flex: 1;">ç²˜è´´URL</button>
            </div>
            <input type="file" class="modal-input" id="avatar-file-input" accept="image/*" style="display: none;">
            <input type="text" class="modal-input" id="avatar-url-input" placeholder="è¾“å…¥å›¾ç‰‡URLåœ°å€" style="display: none;">
            <div id="avatar-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-avatar">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" id="save-avatar" disabled>ä¿å­˜</button>
            </div>
            `;

                showModal(modal.modal);

                const fileInput = document.getElementById('avatar-file-input');
                const urlInput = document.getElementById('avatar-url-input');
                const uploadBtn = document.getElementById('upload-file-btn');
                const pasteUrlBtn = document.getElementById('paste-url-btn');
                const previewDiv = document.getElementById('avatar-preview');
                const previewImg = document.getElementById('preview-image');
                const saveBtn = document.getElementById('save-avatar');
                const cancelBtn = document.getElementById('cancel-avatar');

                let currentAvatarData = null;


                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                    urlInput.style.display = 'none';
                    uploadBtn.classList.add('active');
                    pasteUrlBtn.classList.remove('active');
                });


                pasteUrlBtn.addEventListener('click', () => {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    pasteUrlBtn.classList.add('active');
                    uploadBtn.classList.remove('active');
                    urlInput.focus();
                });



fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > MAX_AVATAR_SIZE) {
            showNotification('å¤´åƒå›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB', 'error');
            return;
        }

        showNotification('æ­£åœ¨è£å‰ªå¤„ç†...', 'info', 1000);
        
        cropImageToSquare(file, 300).then(base64Data => {
            currentAvatarData = base64Data;
            previewImg.src = currentAvatarData;
            previewDiv.style.display = 'block';
            saveBtn.disabled = false;
        }).catch(err => {
            console.error(err);
            showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
        });
    }
});


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentAvatarData = url;
                                saveBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                };
                                img.onerror = function() {
                                    showNotification('å›¾ç‰‡URLæ— æ•ˆæˆ–æ— æ³•è®¿é—®', 'error');
                                    saveBtn.disabled = true;
                                };
                                img.src = url;
                            } else {
                                saveBtn.disabled = true;
                            }
                        } else {
                            saveBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                saveBtn.addEventListener('click',
                    () => {
                        if (currentAvatarData) {
                            updateAvatar(isPartner ? DOMElements.partner.avatar: DOMElements.me.avatar, currentAvatarData);
                            throttledSaveData();
                            showNotification('å¤´åƒå·²æ›´æ–°', 'success');
                            hideModal(modal.modal);
                        }
                    });


                cancelBtn.addEventListener('click',
                    () => {
                        hideModal(modal.modal);
                    });
            };

            DOMElements.partner.name.addEventListener('click', () => openNameModal(true));
            DOMElements.me.name.addEventListener('click', () => openNameModal(false));
            DOMElements.partner.avatar.addEventListener('click', () => openAvatarModal(true));
            DOMElements.me.avatar.addEventListener('click', () => openAvatarModal(false));

            DOMElements.me.statusContainer.addEventListener('click', () => {
                const statusTextElement = DOMElements.me.statusText; const statusContainer = DOMElements.me.statusContainer;
                if (statusContainer.querySelector('input')) return;
                const input = document.createElement('input'); input.type = 'text'; input.id = 'my-status-input'; input.value = statusTextElement.textContent;
                const saveStatus = () => {
                    const newStatus = input.value.trim();
                    if (newStatus) {
                        settings.myStatus = newStatus; showNotification('çŠ¶æ€å·²æ›´æ–°', 'success');
                    } else {
                        settings.myStatus = "åœ¨çº¿";
                    }
                    statusTextElement.textContent = settings.myStatus;
                    statusContainer.innerHTML = '';
                    statusContainer.appendChild(statusTextElement);
                    throttledSaveData();
                };
                input.addEventListener('blur', saveStatus);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });
                statusContainer.innerHTML = ''; statusContainer.appendChild(input); input.focus();
            });

            DOMElements.themeToggle.addEventListener('click', () => {
                settings.isDarkMode = !settings.isDarkMode; throttledSaveData(); updateUI(); showNotification(`å·²åˆ‡æ¢åˆ°${settings.isDarkMode ? 'æ·±è‰²': 'æµ…è‰²'}æ¨¡å¼`,
                    'success');
            });
            DOMElements.settingsModal.settingsBtn.addEventListener('click', () => {
                showModal(DOMElements.settingsModal.modal);
            });
            DOMElements.favoritesModal.favoritesBtn.addEventListener('click', () => {
                renderFavorites(); showModal(DOMElements.favoritesModal.modal);
            });


document.getElementById('chat-settings').addEventListener('click', () => {
    hideModal(DOMElements.settingsModal.modal);
    showModal(DOMElements.chatModal.modal);
    setupAvatarFrameSettings();
});
            document.getElementById('advanced-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.advancedModal.modal);
            });

            document.getElementById('data-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.dataModal.modal);
            });


            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click',
                    () => {
                        settings.colorTheme = btn.dataset.theme;
                        throttledSaveData();
                        updateUI();
                        showNotification(`ä¸»é¢˜é¢œè‰²å·²åˆ‡æ¢`, 'success');
                    });
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click',
                    () => {
                        settings.bubbleStyle = item.dataset.bubbleStyle;
                        throttledSaveData();
                        updateUI();
                        showNotification(`æ°”æ³¡æ ·å¼å·²åˆ‡æ¢ä¸º${getBubbleStyleName(settings.bubbleStyle)}`, 'success');
                    });
            });

            const fontUrlInput = document.getElementById('custom-font-url');
            const applyFontBtn = document.getElementById('apply-font-btn');
            
            if (fontUrlInput) fontUrlInput.value = settings.customFontUrl || "";

            if (applyFontBtn) {
                applyFontBtn.addEventListener('click', () => {
                    const url = fontUrlInput.value.trim();
                    settings.customFontUrl = url;
                    
                    showNotification('æ­£åœ¨å°è¯•åŠ è½½å­—ä½“...', 'info', 1000);
                    applyCustomFont(url).then(() => {
                        throttledSaveData();
                        if(url) showNotification('å­—ä½“å·²åº”ç”¨', 'success');
                        else showNotification('å·²æ¢å¤é»˜è®¤å­—ä½“', 'success');
                    });
                });
            }

            
            const followSystemBtn = document.getElementById('follow-system-font-btn');
            if (followSystemBtn) {
                followSystemBtn.addEventListener('click', () => {
                    
                    const systemFontStack = 'system-ui, -apple-system, sans-serif';
                    
                    
                    if (fontUrlInput) fontUrlInput.value = "";
                    
                    
                    settings.customFontUrl = "";
                    
                    
                    settings.messageFontFamily = systemFontStack;
                    
                    
                    document.documentElement.style.setProperty('--font-family', systemFontStack);
                    document.documentElement.style.setProperty('--message-font-family', systemFontStack);
                    
                    
                    throttledSaveData();
                    
                    
                    renderMessages(true);
                    
                    showNotification('å·²åº”ç”¨è·Ÿéšç³»ç»Ÿå­—ä½“', 'success');
                });
            }
            
            const cssTextarea = document.getElementById('custom-bubble-css');
            const applyCssBtn = document.getElementById('apply-css-btn');
            const resetCssBtn = document.getElementById('reset-css-btn');

            if (cssTextarea) cssTextarea.value = settings.customBubbleCss || "";

            if (applyCssBtn) {
                applyCssBtn.addEventListener('click', () => {
                    const css = cssTextarea.value;
                    settings.customBubbleCss = css;
                    applyCustomBubbleCss(css);
                    throttledSaveData();
                    showNotification('è‡ªå®šä¹‰æ ·å¼å·²åº”ç”¨', 'success');
                });
            }

            if (resetCssBtn) {
                resetCssBtn.addEventListener('click', () => {
                    cssTextarea.value = "";
                    settings.customBubbleCss = "";
                    applyCustomBubbleCss("");
                    throttledSaveData();
                    showNotification('è‡ªå®šä¹‰æ ·å¼å·²æ¸…é™¤', 'success');
                });
            }

            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');

            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = `${settings.fontSize}px`;

            fontSizeSlider.addEventListener('input', (e) => {
                settings.fontSize = parseInt(e.target.value);
                document.documentElement.style.setProperty('--font-size',
                    `${settings.fontSize}px`);
                fontSizeValue.textContent = `${settings.fontSize}px`;
            });

            fontSizeSlider.addEventListener('change', throttledSaveData);

            const avatarToggle = document.getElementById('in-chat-avatar-toggle');
            const avatarToggleSpan = avatarToggle.querySelector('span');
            const avatarSizeControl = document.getElementById('in-chat-avatar-size-control');
            const avatarSizeSlider = document.getElementById('in-chat-avatar-size-slider');
            const avatarSizeValue = document.getElementById('in-chat-avatar-size-value');

            function updateAvatarSettingsUI() {
                avatarToggleSpan.textContent = `æ˜¾ç¤ºèŠå¤©å¤´åƒ: ${settings.inChatAvatarEnabled ? 'å¼€å¯' : 'å…³é—­'}`;
                avatarSizeControl.style.display = settings.inChatAvatarEnabled ? 'flex' : 'none';
                avatarSizeSlider.value = settings.inChatAvatarSize;
                avatarSizeValue.textContent = `${settings.inChatAvatarSize}px`;
                document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);
            }
            updateAvatarSettingsUI();

            avatarToggle.addEventListener('click', () => {
                settings.inChatAvatarEnabled = !settings.inChatAvatarEnabled;
                updateAvatarSettingsUI();
                renderMessages(true);
                throttledSaveData();
            });

            avatarSizeSlider.addEventListener('input', (e) => {
                settings.inChatAvatarSize = parseInt(e.target.value, 10);
                updateAvatarSettingsUI();
                renderMessages(true); 
            });
            avatarSizeSlider.addEventListener('change', throttledSaveData);
            
            const minDelaySlider = document.getElementById('reply-delay-min-slider');
            const minDelayValue = document.getElementById('reply-delay-min-value');
            const maxDelaySlider = document.getElementById('reply-delay-max-slider');
            const maxDelayValue = document.getElementById('reply-delay-max-value');

            function updateDelayUI() {
                minDelaySlider.value = settings.replyDelayMin;
                minDelayValue.textContent = `${(settings.replyDelayMin / 1000).toFixed(1)}s`;
                maxDelaySlider.value = settings.replyDelayMax;
                maxDelayValue.textContent = `${(settings.replyDelayMax / 1000).toFixed(1)}s`;
                maxDelaySlider.min = settings.replyDelayMin; 
            }
            updateDelayUI();

            minDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMin = parseInt(e.target.value, 10);
                if (settings.replyDelayMin > settings.replyDelayMax) {
                    settings.replyDelayMax = settings.replyDelayMin;
                }
                updateDelayUI();
            });
            minDelaySlider.addEventListener('change', throttledSaveData);

            maxDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMax = parseInt(e.target.value, 10);
                 if (settings.replyDelayMax < settings.replyDelayMin) {
                    settings.replyDelayMin = settings.replyDelayMax;
                }
                updateDelayUI();
            });
            maxDelaySlider.addEventListener('change', throttledSaveData);

            const settingToggles = {
                '#reply-toggle': {
                    prop: 'replyEnabled', name: 'å¼•ç”¨å›žå¤'
                },
                '#sound-toggle': {
                    prop: 'soundEnabled', name: 'æ¶ˆæ¯éŸ³æ•ˆ'
                },
                '#read-receipts-toggle': {
                    prop: 'readReceiptsEnabled', name: 'å·²è¯»å›žæ‰§'
                },
                '#typing-indicator-toggle': {
                    prop: 'typingIndicatorEnabled', name: 'æ­£åœ¨è¾“å…¥'},
                    '#read-no-reply-toggle': { prop: 'allowReadNoReply', name: 'å·²è¯»ä¸å›ž' }
};

            for (const [selector, {
                prop, name
            }] of Object.entries(settingToggles)) {
                const element = document.querySelector(selector);

                if (element) {
                    const span = element.querySelector('span');
                    if (span) span.textContent = `${name}: ${settings[prop] ? 'å¼€å¯': 'å…³é—­'}`;
                }

                element.addEventListener('click', () => {
                    settings[prop] = !settings[prop];
                    throttledSaveData();
                    updateUI();


                    const span = element.querySelector('span');
                    if (span) {
                        span.textContent = `${name}: ${settings[prop] ? 'å¼€å¯': 'å…³é—­'}`;

                    }

                    if (prop !== 'soundEnabled') renderMessages(true);
                    showNotification(`${name}å·²${settings[prop] ? 'å¼€å¯': 'å…³é—­'}`, 'success');
                });
            }


            document.getElementById('appearance-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                renderBackgroundGallery();
                showModal(DOMElements.appearanceModal.modal);
            });
            DOMElements.appearanceModal.closeBtn.addEventListener('click', () => {
                    hideModal(DOMElements.appearanceModal.modal);
                });

            const bgInput = document.getElementById('bg-gallery-input');
            if (bgInput) {
                bgInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > MAX_IMAGE_SIZE) {
                        showNotification('èƒŒæ™¯å›¾ç‰‡ä¸èƒ½è¶…è¿‡5MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;


                        savedBackgrounds.push({
                            id: `user-${Date.now()}`,
                            type: 'image',
                            value: base64
                        });


                        saveBackgroundGallery();
                        renderBackgroundGallery();


                        applyBackground(base64);
                        localforage.setItem(getStorageKey('chatBackground'), base64);
                        showNotification('æ–°èƒŒæ™¯å·²æ·»åŠ å¹¶åº”ç”¨', 'success');
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                });
            }

const autoSendToggle = document.getElementById('auto-send-toggle');
const autoSendControl = document.getElementById('auto-send-control');
const autoSendToggleSpan = autoSendToggle.querySelector('span');
const autoSendIcon = autoSendToggle.querySelector('i');

const updateAutoSendUI = () => {
    if (settings.autoSendEnabled) {
        autoSendToggleSpan.textContent = "ä¸»åŠ¨å‘é€: å¼€å¯";
        autoSendIcon.className = "fas fa-toggle-on";
        autoSendControl.style.display = "flex";
    } else {
        autoSendToggleSpan.textContent = "ä¸»åŠ¨å‘é€: å…³é—­";
        autoSendIcon.className = "fas fa-toggle-off";
        autoSendControl.style.display = "none";
    }
};

updateAutoSendUI();

autoSendToggle.addEventListener('click', () => {
    settings.autoSendEnabled = !settings.autoSendEnabled;
    updateAutoSendUI();
    manageAutoSendTimer(); 
    throttledSaveData();
    showNotification(`ä¸»åŠ¨å‘é€å·²${settings.autoSendEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
});

const autoSendSlider = document.getElementById('auto-send-slider');
const autoSendValue = document.getElementById('auto-send-value');

autoSendSlider.value = settings.autoSendInterval || 60;
autoSendValue.textContent = `${settings.autoSendInterval}s`;

autoSendSlider.addEventListener('input', (e) => {
    const val = parseInt(e.target.value);
    settings.autoSendInterval = val;
    autoSendValue.textContent = `${val}s`;
});

autoSendSlider.addEventListener('change', () => {
    manageAutoSendTimer(); 
    throttledSaveData();
});

            const resetBgBtn = document.getElementById('reset-default-bg');
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', () => {
                    removeBackground();
                    renderBackgroundGallery();
                    showNotification('å·²ç§»é™¤èƒŒæ™¯å›¾', 'success');
                });
            }
        }


        function initNewFeatureListeners() {

            document.getElementById('fortune-function').addEventListener('click', () => {

                hideModal(DOMElements.advancedModal.modal);


                generateFortune();
            });
    const envelopeEntryBtn = document.getElementById('envelope-function');
    if (envelopeEntryBtn) {
        envelopeEntryBtn.addEventListener('click', () => {
            hideModal(DOMElements.advancedModal.modal);
            showModal(document.getElementById('envelope-modal'), document.getElementById('envelope-input'));
        });
    }
            DOMElements.fortuneModal.shareBtn.addEventListener('click', () => {
                const fortuneText = document.querySelector('.fortune-desc').textContent;
                const shareText = `æˆ‘çš„ä»Šæ—¥è¿åŠ¿ï¼š${fortuneText}`;

                if (navigator.share) {
                    navigator.share({
                        title: 'ä»Šæ—¥è¿åŠ¿',
                        text: shareText
                    });
                } else {

                    navigator.clipboard.writeText(shareText).then(() => {
                        showNotification('è¿åŠ¿å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    });
                }
            });


            document.getElementById('batch-favorite-function').addEventListener('click', () => {
                hideModal(DOMElements.favoritesModal.modal);
                toggleBatchFavoriteMode();
            });

            initReplyLibraryListeners();


            
            DOMElements.anniversaryAnimation.closeBtn.addEventListener('click', () => {
                DOMElements.anniversaryAnimation.modal.classList.remove('active');
            });


            document.getElementById('stats-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderStatsContent();
                showModal(DOMElements.statsModal.modal);
            });

document.getElementById('send-envelope').addEventListener('click', handleSendEnvelope);

document.getElementById('cancel-envelope').addEventListener('click', () => {
    hideModal(document.getElementById('envelope-modal'));
});

            const coinFunctionBtn = document.getElementById('coin-function');
            if (coinFunctionBtn) {
                coinFunctionBtn.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    handleCoinToss();
                });
            }
            const musicToggle = document.getElementById('music-player-toggle');
            musicToggle.addEventListener('click', () => {
                settings.musicPlayerEnabled = !settings.musicPlayerEnabled;
                throttledSaveData();

                const player = document.getElementById('player');
                if (settings.musicPlayerEnabled) {
                    player.classList.add('visible');
                    showNotification('éŸ³ä¹æ’­æ”¾å™¨å·²å¼€å¯', 'success');
                } else {
                    player.classList.remove('visible');
                    document.getElementById('playlist').classList.remove('active');
                    const audio = document.getElementById('audio');
                    if (audio) audio.pause();
                    showNotification('éŸ³ä¹æ’­æ”¾å™¨å·²å…³é—­', 'info');
                }
                hideModal(DOMElements.advancedModal.modal);
            });
        }
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    const annFormWrapper = document.getElementById('ann-form-wrapper');

    if (annToggleBtn && annFormWrapper) {
        annToggleBtn.addEventListener('click', () => {
            const isActive = annFormWrapper.classList.contains('active');
            
            if (isActive) {
                annFormWrapper.classList.remove('active');
                annToggleBtn.classList.remove('active');
            } else {
                annFormWrapper.classList.add('active');
                annToggleBtn.classList.add('active');
                
                setTimeout(() => {
                    annFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        });
    }

        function getBubbleStyleName(style) {
            const names = {
                'standard': 'æ ‡å‡†',
                'rounded': 'åœ†è§’',
                'rounded-large': 'å¤§åœ†è§’',
                'square': 'æ–¹å½¢'
            };
            return names[style] || 'æ ‡å‡†';
        }

        function initDataManagementListeners() {

            document.getElementById('export-chat').addEventListener('click', exportChatHistory);
            document.getElementById('import-chat').addEventListener('click', () => DOMElements.importInput.click());
            DOMElements.importInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importChatHistory(e.target.files[0]); e.target.value = '';
                }
            });


            document.getElementById('clear-chat').addEventListener('click', () => {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤")) {
                    messages = [];
                    throttledSaveData();
                    renderMessages();
                    hideModal(DOMElements.dataModal.modal);
                    showNotification('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
                }
            });
            document.getElementById('clear-storage').addEventListener('click', clearAllAppData);
            const creditsBtn = document.getElementById('open-credits-btn');
            if (creditsBtn) {
                creditsBtn.addEventListener('click', () => {

                    hideModal(DOMElements.dataModal.modal);


                    const disclaimerModal = document.getElementById('disclaimer-modal');


                    if (disclaimerModal) {
                        showModal(disclaimerModal);
                    }
                });
            }

        }


        DOMElements.sessionModal.managerBtn.addEventListener('click', () => {
            renderSessionList(); showModal(DOMElements.sessionModal.modal);
        });
        DOMElements.sessionModal.createBtn.addEventListener('click', () => {
            const newId = createNewSession(false);

            renderSessionList();
            showNotification('æ–°ä¼šè¯å·²åˆ›å»º', 'success');
        });

        DOMElements.sessionModal.list.addEventListener('click', (e) => {
            const item = e.target.closest('.session-item');
            if (!item) return;
            const sessionId = item.dataset.id;

            if (e.target.closest('.rename')) {
                const session = sessionList.find(s => s.id === sessionId);
                const newName = prompt('è¾“å…¥æ–°çš„ä¼šè¯åç§°:', session.name);
                if (newName && newName.trim()) {
                    session.name = newName.trim();
                    localforage.setItem(`${APP_PREFIX}sessionList`, sessionList); 
                    renderSessionList();
                    showNotification('ä¼šè¯å·²é‡å‘½å', 'success');
                }
            } else if (e.target.closest('.delete')) {
                if (sessionList.length <= 1) {
                    showNotification('æ— æ³•åˆ é™¤æœ€åŽä¸€ä¸ªä¼šè¯', 'warning');
                    return;
                }
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯åŠå…¶æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) {

                    const currentSessionId = SESSION_ID;

                    sessionList = sessionList.filter(s => s.id !== sessionId);
localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

Object.keys(localStorage).forEach(key => {
    if (key.startsWith(`${APP_PREFIX}${sessionId}_`)) safeRemoveItem(key);
});

if (sessionId === currentSessionId) {
    const newCurrentId = sessionList[0].id;
    localforage.setItem(`${APP_PREFIX}customThemes`, customThemes);
    window.location.hash = newCurrentId;
    window.location.reload();
} else {
    renderSessionList();
    showNotification('ä¼šè¯å·²åˆ é™¤', 'success');
}
                }
            } else {

                if (sessionId !== SESSION_ID) {
                    if (confirm('åˆ‡æ¢ä¼šè¯å°†åˆ·æ–°é¡µé¢ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        window.location.hash = sessionId;
                        window.location.reload();
                    }
                }
            }
        });

        const initMusicPlayer = () => {
    const latestSystemSongs = [{
                title: "è™šæ‹Ÿ", sub: "ä½ æ˜¯æˆ‘æœå¤•ç›¸ä¼´è§¦æ‰‹å¯åŠçš„è™šæ‹Ÿ", url: "https://files.catbox.moe/6s65mp.mp3"
            },
                {
                    title: "å¤šè¿œéƒ½è¦åœ¨ä¸€èµ·", sub: "çˆ±èƒ½å…‹æœè¿œè·ç¦»", url: "https://files.catbox.moe/06k9ra.mp3"
                },
                {
                    title: "æ°¸ä¸å¤±è”çš„çˆ±", sub: "è¿™ä¸€è¾ˆå­éƒ½ä¸æƒ³å¤±è”çš„çˆ±", url: "https://files.catbox.moe/uvucav.mp3"
                },
                {
                    title: "ç¨³ç¨³çš„å¹¸ç¦", sub: "è¿™æ˜¯æˆ‘æƒ³è¦çš„å¹¸ç¦", url: "https://files.catbox.moe/inb22a.mp3"
                },
                {
                    title: "æœ‰æˆ‘å‘¢", sub: "æˆ‘ä¼šè®©ä½ ä¹ æƒ¯ å¤šä¸€ä¸ªäººé™ªä¼´", url: "https://files.catbox.moe/hrazjt"
                },
                {
                    title: "ä¸€åƒé›¶ä¸€å¤œ", sub: "æ¢¦é‡Œèƒ½åˆ°è¾¾çš„åœ°æ–¹å•Š æœ‰ä¸€å¤©è„šæ­¥ä¹Ÿèƒ½åˆ°è¾¾", url: "https://files.catbox.moe/syfuon.mp3"
                },
                {
                    title: "æœˆäº®ä¸Žå…­ä¾¿å£«", sub: "æˆ‘çš„ä¸–ç•Œç”±ä½ å»ºç«‹ å› ä½ å´©å¡Œ", url: "https://files.catbox.moe/98quqc.mp3"
                },
                {
                    title: "æ¬¡å…ƒæ‹äºº", sub: "çº¦å¥½äº†éš”ç€æ¬¡å…ƒä¹Ÿå»ä½æ³ªçœ¼", url: "https://files.catbox.moe/5u5dy0.mp3"
                },
                {
                    title: "é˜³å…‰ä¸‹çš„æ˜Ÿæ˜Ÿ", sub: "å¦‚æžœçˆ±ä¸Šä½ åªæ˜¯ä¸€ä¸ªæ¢¦å¢ƒ", url: "https://files.catbox.moe/dxgqsk.mp3"
                },
                {
                    title: "å‘¨è¾¹", sub: "çµé­‚é‡Œç©ºç¼ºçš„é‚£æ®µ", url: "https://files.catbox.moe/a7k5wd.mp3"
                },
                {
                    title: "æ‹çˆ±ing", sub: "è®©æˆ‘é‡æ–°è®¤è¯†L O V E", url: "https://files.catbox.moe/94slcd.mp3"
                },
                {
                    title: "ä¸€ç‚¹ä¸€æ»´", sub: "ä½ è®©çˆ±ä¸€ç‚¹ä¸€æ»´æ±‡æˆæ²³", url: "https://files.catbox.moe/958qzg.mp3"
                },
                {
                    title: "å…³é”®è¯", sub: "è®©æˆ‘è§è¯†çˆ±æƒ…å¯ä»¥æ…·æ…¨åˆè‡ªç§", url: "https://files.catbox.moe/9yl5ic.mp3"
                },
                {
                    title: "æƒ³è§ä½ æƒ³è§ä½ æƒ³è§ä½ ", sub: "ç©¿è¶Šäº†åƒä¸ªä¸‡ä¸ªæ—¶é—´çº¿é‡Œäººæµ·é‡Œç›¸ä¾", url: "https://files.catbox.moe/co58d7.mp3"
                },
                {
                    title: "star crossing night", sub: "è¿™é‡Œæ²¡æœ‰ä½ ", url: "https://files.catbox.moe/i3f86b.mp3"
                },
                {
                    title: "sea temple", sub: "If we have each other", url: "https://files.catbox.moe/c57gxs.mp3"
                },
                {
                    title: "æˆ‘æƒ³è¦å æ®ä½ ", sub: "å æ®ä½ çš„â¼€åˆ‡ä¸”æ— å¯åŽšéž", url: "https://files.catbox.moe/1fp6eg.mp3"
                },
                {
                    title: "ç‰¹åˆ«çš„äºº", sub: "æˆ‘ä»¬æ˜¯å¯¹æ–¹ç‰¹åˆ«çš„äºº", url: "https://files.catbox.moe/a0n0l7.mp3"
                },
                {
                    title: "éº¦æ©èŽ‰", sub: "åœ¨å¹¿é˜”å¯‚å¯žæ¼©æ¶¡è§£è„±", url: "https://files.catbox.moe/2inae2.mp3"
                },
                {
                    title: "ä¼šå‘¼å¸çš„ç—›", sub: "æƒ³å¿µæ˜¯ä¼šå‘¼å¸çš„ç—›", url: "https://files.catbox.moe/0uhmxr.mp3"
                },
                {
                    title: "ä¸€ç”Ÿçš„çˆ±", sub: "æˆ‘åªæƒ³è¦ç»™ä½ æˆ‘ä¸€ç”Ÿçš„çˆ±", url: "https://files.catbox.moe/f0e93c.mp3"
                },
                {
                    title: "èº«éª‘ç™½é©¬", sub: "è¿½èµ¶è¦æˆ‘çˆ±çš„ä¸ä¿ç•™", url: "https://files.catbox.moe/iywfe2.mp3"
                },
                {
                    title: "çˆ±æƒ…è®¯æ¯", sub: "æƒ³å¿µå˜æˆç©ºæ°”åœ¨å¹æ¯", url: "https://files.catbox.moe/4dl0t2.mp3"
                },
                {
                    title: "ä½ åœ¨ ä¸åœ¨", sub: "ä½ åœ¨æˆ‘å¿ƒé‡Œé¢ é™ªæˆ‘å¤±çœ ", url: "https://files.catbox.moe/povyqa.mp3"
                },
                {
                    title: "ä½ æ˜¯æˆ‘çš„é£Žæ™¯", sub: "çˆ±è®©æ‚¬å´–å˜å¹³åœ°", url: "https://files.catbox.moe/fnwtf8.mp3"
                },
                {
                    title: "life with u", sub: "Now I know that you're the one", url: "https://files.catbox.moe/zqfxvd.mp3"
                },
                {
                    title: "å‹¾æŒ‡èµ·èª“", sub: "ä½ æ˜¯ç†æ‰€å½“ç„¶çš„å¥‡è¿¹", url: "https://files.catbox.moe/4spgo5.mp3"
                },
                {
                    title: "ç‰µä¸€åŠ", sub: "ä½ çš„å­˜åœ¨æ˜¯æˆ‘å”¯ä¸€ä¾èµ–", url: "https://files.catbox.moe/bk21gu.mp3"
                },
                {
                    title: "rove", sub: "Oh we are in the War of Love on Rove", url: "https://files.catbox.moe/sfwsuk.mp3"
                },
                {
                    title: "å”¯ä¸€", sub: "æˆ‘çœŸçš„çˆ±ä½  å¥å¥ä¸è½»æ˜“", url: "https://files.catbox.moe/69g4fe.mp3"
                },
            { title: "è‡´çˆ± Your Song", sub: "æˆ‘åªæƒ³æ¯ä¸ªè½æ—¥ èº«è¾¹éƒ½æœ‰ä½ ", url: "https://files.catbox.moe/01bmnf.mp3" },
            { title: "ä¸€é¦–æƒ³ä¸é€šçš„å¤é£Ž", sub: "ç”»åœ°ä¸ºç‰¢ ç”»å‘½ä¸ºç¬¦ é“¸æˆä¸‹ä¸€ä¸–åšå®ˆ", url: "https://files.catbox.moe/9b4lh7.mp3" },
            { title: "èŒ‰èŽ‰é›¨", sub: "ç´å£°é‡Œæ„å‡ è®¸å…³äºŽä½ ", url: "https://files.catbox.moe/7ml83u.mp3" },
            { title: "æ€Žä¹ˆå”±æƒ…æ­Œ", sub: "æµ· å˜çš„è‹¦æ¶© ç¼ä¼¤ä¸€ç‰‡æ¸©æŸ”", url: "https://files.catbox.moe/isqax9.mp3" },
            { title: "å²¸è¾¹å®¢", sub: "ä½ å›žæ¥æˆ‘å¿ƒæœªæ”¹ ä½ ä¸åœ¨æˆ‘è¿˜ç­‰å¾…", url: "https://files.catbox.moe/9oud6s.mp3" },
            { title: "æ±Ÿå—é›ª", sub: "ç›¸æ€å†æ— è¯è§£ ä»Žæ­¤ä¸‡èˆ¬é£Žæœˆéƒ½æ˜¯æˆ‘å¿ƒç»“", url: "https://files.catbox.moe/hhjwek.mp3" },
            { title: "ä¸æ­»ä¹‹èº«", sub: "æˆ‘ä»çˆ±ä½ çˆ±å¾—ä¸çŸ¥å¤©é«˜åœ°åŽš", url: "https://files.catbox.moe/g960ev.mp3" },
            { title: "æˆ‘ä»¬çš„æ˜Žå¤©", sub: "çˆ±ä»Žä¸æ›¾ä¿ç•™ æ‰å‹‡æ•¢äº†æˆ‘", url: "https://files.catbox.moe/a3yjvv.mp3" },
            { title: "éš¾è§£", sub: "ç‚¹ç‚·é«˜é¦™æ•¬äºˆç¥žæ˜Ž è¢«äººå˜²ç¬‘çŸ¢å¿—ä¸æ¸", url: "https://files.catbox.moe/1u8m3r.mp3" },
            { title: "æœ€å¥½çš„æˆ‘ & 50 Feet", sub: "è¯•ç€ä¼¸æ‰‹ å´è¿žä½ çš„å½±å­æˆ‘éƒ½æ— æ³•é è¿‘", url: "https://files.catbox.moe/clsiyi.mp3" },
            { title: "åŒæ‰‹åŒè„š", sub: "ä¹Ÿæ˜¯å­˜åœ¨åœ¨è¿™ä¸ªä¸–ç•Œ å”¯ä¸€çš„å”¯ä¸€", url: "https://files.catbox.moe/b8hss3.mp3" },
            { title: "åŒèŠ±é¡º", sub: "åªè¦è‚¯çˆ±å¾—æ·± æ˜¯ä¸æ˜¯å°±æœ‰è¿™å¯èƒ½", url: "https://files.catbox.moe/28mw5d.mp3" },
            { title: "è½»èˆž", sub: "è½»èˆžå§ è¿‡å¾€å¦‚è£™çº±", url: "https://files.catbox.moe/8n9lhi.mp3" },
            { title: "ç»å¯¹å æœ‰ ç›¸å¯¹è‡ªç”±", sub: "èµžç¾Žä½ åŒ…å®¹ä½ éƒ½æ˜¯æˆ‘çš„ä½¿å‘½", url: "https://files.catbox.moe/zi4gxo.mp3" },
            { title: "åƒä¸‡æ¬¡æƒ³è±¡", sub: "æˆ‘åƒä¸‡æ¬¡æƒ³è±¡ åƒä¸‡æ¬¡æ¨¡ä»¿ æ€å¿µçš„å½¢çŠ¶", url: "https://files.catbox.moe/4jtex8.mp3" },
            { title: "è¾žå®¶åƒé‡Œ", sub: "ç©¿è¿‡æ— äººé—®æ´¥åŽ»è§å±±æµ·ä¸‡é¡·", url: "https://files.catbox.moe/2quy44.mp3" },
            { title: "Ryukyuvania", sub: "----", url: "https://files.catbox.moe/utmbqp.mp3" },
            { title: "æ²¦é™·", sub: "åœˆå®ƒåœ¨é»‘æš—ä¸­é€ƒä¸å‡ºçš„æ¢¦é­‡", url: "https://files.catbox.moe/0bhl3i.mp3" },
            { title: "æ™šæž«æ­Œ", sub: "ä½ åˆæ€ŽçŸ¥æˆ‘ä»Žæœªæ”¾æ‰‹", url: "https://files.catbox.moe/xhwrwy.mp3" },
            { title: "I Need U", sub: "I need you girl", url: "https://files.catbox.moe/v1k4h8.mp3" },
            { title: "è‹¥æ¢¦", sub: "æ—¥å‡æœˆè½ æ­¤ç”Ÿä¾æ—§éš¾èˆ", url: "https://files.catbox.moe/6uysqy.mp3" },
            { title: "çˆ±äºº", sub: "å¯æ˜¯æ¨çš„äººæ²¡æ­»æˆ çˆ±çš„äººæ²¡å¯èƒ½", url: "https://files.catbox.moe/wtbdxe.mp3" },
            { title: "æ˜Ÿæ²³å¹", sub: "æˆ‘ç›¼å­¤èº«çºµé©¬ ç¬›å£°æ¼«å¤© å››æµ·ä»»æˆ‘æ¸¸", url: "https://files.catbox.moe/de7g2m.mp3" },
            { title: "çˆ±æ®‡", sub: "å‡æ¬¢ç•… åˆä½•å¦¨ æ— äººå…±äº«", url: "https://files.catbox.moe/or2hm7.mp3" },
            { title: "Una mattina", sub: "----", url: "https://files.catbox.moe/nf8o90.mp3" },
            { title: "é¡ºå…¶è‡ªç„¶", sub: "You light up my heart", url: "https://files.catbox.moe/na01cn.mp3" },
            { title: "åˆè§", sub: "è‹¥å¦‚åˆè§ ä¸ºè°è€Œå½’", url: "https://files.catbox.moe/bumolx.mp3" },
            { title: "æˆ‘å¥½åƒåœ¨å“ªè§è¿‡ä½ ", sub: "äººä»¬æŠŠéš¾è¨€çš„çˆ±éƒ½åŸ‹å…¥åœŸå£¤é‡Œ", url: "https://files.catbox.moe/vcidpc.mp3" },
            { title: "åˆ«å›žå¤´", sub: "çˆ±æ˜¯å¹´å°‘æ—¶ä¸å ªå…¶é‡ æ¸—é€çµé­‚çš„ä¸€é˜µå‰§ç—›", url: "https://files.catbox.moe/h1hwo5.mp3" },
            { title: "å¤§é±¼", sub: "æ€•ä½ é£žè¿œåŽ» æ€•ä½ ç¦»æˆ‘è€ŒåŽ»", url: "https://files.catbox.moe/jlcvkg.mp3" },
            { title: "äººé±¼çš„çœ¼æ³ª", sub: "Baby Don't cry", url: "https://files.catbox.moe/40fm4j.mp3" },
            { title: "ä¹å¼ æœº", sub: "æˆ‘æ„¿åŒ–ä½œæœ›æ–­å¤©æ¶¯é‚£ä¸€æ–¹é’çŸ³", url: "https://files.catbox.moe/hql6w5.mp3" },
            { title: "æ¢¦å¹»è¯›ä»™", sub: "æ¥ä¸–è‹¥å†ä¼šè¿˜ä¸Žä½ åŒåŒå¯¹å¯¹", url: "https://files.catbox.moe/r6btwp.mp3" },
            { title: "å¯»å¸¸æ­Œ", sub: "æ‰€å¹¸ä¸è¿‡æ˜¯ å¯»å¸¸äººé—´äº‹", url: "https://files.catbox.moe/ntcqvr.mp3" },
{ title: "å…¬ç¤ºæƒ…ä¹¦", sub: "æœ‰ç§å¾®å¦™ç¡®å®šçš„å¹¸ç¦ å«å¯¹æ–¹æ­£åœ¨è¾“å…¥", url: "https://files.catbox.moe/rptwer.mp3" },
{ title: "çŽ°åœ¨é‚£è¾¹æ˜¯å‡ ç‚¹", sub: "è¯·é—®ä½ çŽ°åœ¨é‚£è¾¹æ˜¯å‡ ç‚¹ ä¼šä¸ä¼šè¿˜æ”¾æœ‰æˆ‘çš„ç…§ç‰‡", url: "https://files.catbox.moe/icv2aa.mp3" },
{ title: "æƒ…äºº", sub: "æ°”æ°›å¼€å§‹å‡æ¸© å±é™©åˆè¿·äºº", url: "https://files.catbox.moe/iqairg.mp3" },
{ title: "æ€œæ‚¯", sub: "æˆ‘è¦å¸¦ç€çˆ±æ„ç€æ¨ä½ ", url: "https://files.catbox.moe/242a1h.mp3" },
{ title: "ç–‘å¿ƒç—…", sub: "ä½ ç»ˆäºŽè¯´å‡ºå£ä½ å¯¹æˆ‘æ„Ÿæƒ…ä¹Ÿå¾ˆé‡", url: "https://files.catbox.moe/jc1umm.mp3" },
{ title: "è¯€çˆ±", sub: "è‹¥çµé­‚ç›¸ç»“åœ¨å¤©åœ°ä¹‹é—´", url: "https://files.catbox.moe/quqaws.mp3" },
{ title: "å½¼å²¸", sub: "å¥¹æ§èµ·é•œèŠ±æ°´æœˆ ä¸€åˆ¹é‚£æ¹®ç­", url: "https://files.catbox.moe/zxepep.mp3" },
{ title: "é—®æƒ…", sub: "å½“çˆ±æ¨å¦‚æ½®ç”Ÿå¤šæ®‹å¿", url: "https://files.catbox.moe/erds0n.mp3" },
{ title: "åŒè¿›é€€", sub: "æˆ‘ä¼šç‰µç€ä½ æ‰‹åŒè¿›é€€ ä½›å‰ç«‹èª“ä¸åŽæ‚”", url: "https://files.catbox.moe/vb6chf.mp3" },
{ title: "æ‹›æ‘‡", sub: "ä¸€å¥æ­¤ç”Ÿä¸æ¢", url: "https://files.catbox.moe/oc86ih.mp3" },
{ title: "ä½ è¦çš„å…¨æ‹¿èµ°", sub: "å¥½èšå¥½æ•£å¬ç€ä¹Ÿæ¥šæ¥šå¯æ€œ", url: "https://files.catbox.moe/ok2e3s.mp3" },
{ title: "äº‘è£³ç¾½è¡£æ›²", sub: "æ•…äº‹é²œè‰³è€Œç¼˜åˆ†å´å¤ªæµ…", url: "https://files.catbox.moe/njnbhv.mp3" },
{ title: "å¤§æ¢¦å½’ç¦»", sub: "ç»ˆäºŽå¬é£Žå„¿è¯´ çŸ¥é“ä½ åœ¨å“ªé‡Œ", url: "https://files.catbox.moe/5z67vs.mp3" },
{ title: "åå‘", sub: "ä¸ºä½•ä¼šä¸¤è´¥ä¿±ä¼¤", url: "https://files.catbox.moe/i37f39.mp3" },
{ title: "Love me like you do", sub: "You're the only thing I wanna touch", url: "https://files.catbox.moe/arym0i.mp3" },
{ title: "Not snow,but U", sub: "æˆ‘æœŸå¾…çš„ä¸æ˜¯é›ªè€Œæ˜¯æœ‰ä½ çš„å†¬å¤©", url: "https://files.catbox.moe/6rk4gw.mp3" },
{ title: "The Evergreen", sub: "æˆ‘æç„¶æ˜Žäº†æˆ‘æ‰€éœ€çš„ä¸€åˆ‡å·²å°½æ•°æ‘†åœ¨çœ¼å‰", url: "https://files.catbox.moe/ca3rim.mp3" },
{ title: "å†¥æ²³èžºæ—‹", sub: "æˆ‘å¦‚æ­¤å¸Œæœ› æˆ‘ä¼´ä½ å·¦å³", url: "https://files.catbox.moe/xtj8db.mp3" },
{ title: "ç†„ç­", sub: "ä½ æ€»é—®æˆ‘åœ¨ä¸€èµ·ä¼šä¸ä¼šæ„Ÿåˆ°åŽŒå€¦", url: "https://files.catbox.moe/wnzxou.mp3" },
{ title: "çˆ±äººé”™è¿‡", sub: "æˆ‘è‚¯å®šåœ¨å‡ ç™¾å¹´å‰å°±è¯´è¿‡çˆ±ä½ ", url: "https://files.catbox.moe/q2nx16.mp3" },
{ title: "æˆ‘æƒ³å¿µ", sub: "æˆ‘æƒ³å¿µä½ è¯´è¿‡çš„é‚£ç§æ°¸è¿œ", url: "https://files.catbox.moe/3qxads.mp3" },
{ title: "æ­¤ç”Ÿä¸æ¢", sub: "å†æœ‰ä¸€ä¸‡å¹´æ·±æƒ…ä¹Ÿä¸å˜", url: "https://files.catbox.moe/72ik88.mp3" },
{ title: "é³¥ã®è©©", sub: "----", url: "https://files.catbox.moe/966u00.mp3" }

    ];

    const uploadCoverBtn = document.getElementById('upload-cover-btn');
    const coverInput = document.getElementById('cover-input');
    const vinylRecord = document.getElementById('vinyl-record-visual');

    const applyPlayerCover = (base64Data) => {
        if (base64Data) {
            vinylRecord.style.backgroundImage = `url(${base64Data})`;
            vinylRecord.classList.add('has-cover');
            vinylRecord.style.borderWidth = '1px';
        } else {
            vinylRecord.style.backgroundImage = '';
            vinylRecord.classList.remove('has-cover');
            vinylRecord.style.borderWidth = '2px';
        }
    };

const savedCover = safeGetItem(APP_PREFIX + 'playerCover');

    localforage.getItem(APP_PREFIX + 'playerCover').then(cover => { if(cover) applyPlayerCover(cover); });
    if (savedCover) applyPlayerCover(savedCover);

    uploadCoverBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (vinylRecord.classList.contains('has-cover')) {
            if (confirm('æƒ³è¦é‡ç½®å›žé»˜è®¤çš„ã€ä¸»é¢˜è‰²é»‘èƒ¶ã€‘æ ·å¼å—ï¼Ÿ\n\nâ€¢ ç‚¹å‡»ã€ç¡®å®šã€‘æ¢å¤é»˜è®¤\nâ€¢ ç‚¹å‡»ã€å–æ¶ˆã€‘é€‰æ‹©æ–°å›¾ç‰‡')) {
                localforage.removeItem(APP_PREFIX + 'playerCover');
                applyPlayerCover(null);
                showNotification('å·²æ¢å¤é»˜è®¤é»‘èƒ¶æ ·å¼', 'success');
                return;
            }
        }
        coverInput.click();
    });

    coverInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            showNotification('å›¾ç‰‡å¤ªå¤§äº†ï¼Œè¯·ä¸Šä¼  2MB ä»¥å†…çš„å›¾ç‰‡', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64Data = event.target.result;
            try {
                localforage.setItem(APP_PREFIX + 'playerCover', base64Data);
                applyPlayerCover(base64Data);
                showNotification('ä¸“è¾‘å°é¢è®¾ç½®æˆåŠŸï¼', 'success');
            } catch (err) {
                console.error(err);
                showNotification('å›¾ç‰‡å­˜å‚¨å¤±è´¥ï¼ˆå¯èƒ½è¶…å‡ºäº†æµè§ˆå™¨é™åˆ¶ï¼‰', 'error');
            }
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    const savedSongsStr = safeGetItem(APP_PREFIX + 'customSongs');
    let songs = [];
if (savedSongsStr) {
        songs = JSON.parse(savedSongsStr);
    } else {
        songs = [...latestSystemSongs];
    }

    const player = document.getElementById('player');
    const miniView = document.getElementById('mini-view');
    const playlist = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const progressArea = document.getElementById('progress-area');

    const addSongModal = document.getElementById('add-song-modal');
    const newSongTitle = document.getElementById('new-song-title');
    const newSongSub = document.getElementById('new-song-sub');
    const newSongUrl = document.getElementById('new-song-url');
    const confirmAddSongBtn = document.getElementById('confirm-add-song');
    const cancelAddSongBtn = document.getElementById('cancel-add-song');
    const modalTitleElem = addSongModal.querySelector('.modal-title span');

    let currentIndex = 0;
    let isPlaying = false;
    let isRandom = false;
    let editModeIndex = -1;
    let searchTerm = '';
    let isSearchVisible = false;

    function loadSong(index) {
        if (songs.length === 0) return;
        if (index >= songs.length) index = 0;
        if (index < 0) index = songs.length - 1;

        const song = songs[index];
        document.getElementById('music-title').innerText = song.title;
        document.getElementById('music-subtitle').innerText = song.sub;
        
        if (song.url) audio.src = song.url;
        updatePlaylistHighlight();
    }

    function togglePlay() {
        if (songs.length === 0) {
            showNotification('æ’­æ”¾åˆ—è¡¨ä¸ºç©º', 'warning');
            return;
        }
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
            document.getElementById('icon-play').style.display = 'block';
            document.getElementById('icon-pause').style.display = 'none';
            player.classList.remove('playing');
        } else {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    isPlaying = true;
                    document.getElementById('icon-play').style.display = 'none';
                    document.getElementById('icon-pause').style.display = 'block';
                    player.classList.add('playing');
                }).catch(error => {
                    console.error(error);
                    showNotification('æ’­æ”¾å¤±è´¥ï¼Œé“¾æŽ¥å¯èƒ½å¤±æ•ˆ', 'error');
                });
            }
        }
    }

    function nextSong() {
        if (songs.length === 0) return;
        if (isRandom) currentIndex = Math.floor(Math.random() * songs.length);
        else currentIndex = (currentIndex + 1) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function prevSong() {
        if (songs.length === 0) return;
        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function savePlaylist() {
        localforage.setItem(APP_PREFIX + 'customSongs', songs);
        renderPlaylist();
    }

    function syncSystemSongs() {
        if (confirm('æ›´æ–°æ­Œå•å°†ä¼šï¼š\n1. è¯»å–ä»£ç ä¸­æœ€æ–°çš„é¢„è®¾æ­Œå•\n2. ä¿ç•™ä½ æ‰‹åŠ¨æ·»åŠ çš„è‡ªå®šä¹‰æ­Œæ›²\n\nç¡®å®šè¦æ›´æ–°å—ï¼Ÿ')) {
            try {
                const userCustomSongs = songs.filter(s => s.isCustom === true);
                
                songs = [...latestSystemSongs, ...userCustomSongs];
                
                safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
                
                currentIndex = 0;
                loadSong(0);
                if (isPlaying) {
                    audio.pause();
                    audio.currentTime = 0;
                    isPlaying = false;
                    document.getElementById('icon-play').style.display = 'block';
                    document.getElementById('icon-pause').style.display = 'none';
                    player.classList.remove('playing');
                }

                renderPlaylist();
                
                showNotification('æ­Œå•å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } catch (e) {
                console.error(e);
                showNotification('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æ ¼å¼', 'error');
            }
        }
    }

    function openEditModal(index) {
        const song = songs[index];
        if (!song) return;
        editModeIndex = index;
        newSongTitle.value = song.title;
        newSongSub.value = song.sub;
        newSongUrl.value = song.url;
        modalTitleElem.innerText = "ç¼–è¾‘æ­Œæ›²ä¿¡æ¯";
        confirmAddSongBtn.innerText = "ä¿å­˜ä¿®æ”¹";
        showModal(addSongModal);
    }

    function openAddModal() {
        editModeIndex = -1;
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        modalTitleElem.innerText = "æ·»åŠ è‡ªå®šä¹‰æ­Œæ›²";
        confirmAddSongBtn.innerText = "æ·»åŠ æ’­æ”¾";
        showModal(addSongModal);
    }

    function renderPlaylist() {
        playlist.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'playlist-header';
        header.innerHTML = `
            <div class="pl-header-title">Ë™Â°Êšá•±â‘…á•±ÉžÂ°Ë™</div>
            <div class="pl-header-actions">
                <button class="pl-icon-btn ${isSearchVisible ? 'active' : ''}" id="pl-search-toggle" title="æœç´¢"><i class="fas fa-search"></i></button>
                <button class="pl-icon-btn" id="pl-sync-btn" title="æ›´æ–°é¢„è®¾æ­Œå•"><i class="fas fa-sync-alt"></i></button>
                <button class="pl-icon-btn" id="pl-add-btn" title="æ·»åŠ æ­Œæ›²"><i class="fas fa-plus"></i></button>
            </div>
        `;
        playlist.appendChild(header);

        const searchWrapper = document.createElement('div');
        searchWrapper.className = `playlist-search-wrapper ${isSearchVisible ? 'active' : ''}`;
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'playlist-search-input';
        searchInput.placeholder = '';
        searchInput.value = searchTerm;
        
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderListContent(contentDiv);
        });
        
        searchWrapper.appendChild(searchInput);
        playlist.appendChild(searchWrapper);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'playlist-content';
        playlist.appendChild(contentDiv);

        renderListContent(contentDiv);

        header.querySelector('#pl-add-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openAddModal();
            newSongTitle.focus();
        });
        
        header.querySelector('#pl-sync-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            syncSystemSongs();
        });

        header.querySelector('#pl-search-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            isSearchVisible = !isSearchVisible;
            searchWrapper.classList.toggle('active', isSearchVisible);
            e.currentTarget.classList.toggle('active', isSearchVisible);
            if (isSearchVisible) {
                setTimeout(() => searchInput.focus(), 100);
            }
        });
    }

    function renderListContent(container) {
        container.innerHTML = '';
        
        const filteredSongs = songs.map((s, i) => ({...s, originalIndex: i}))
                                   .filter(s => s.title.toLowerCase().includes(searchTerm) || 
                                                s.sub.toLowerCase().includes(searchTerm));

        if (filteredSongs.length === 0) {
            container.innerHTML = `<div class="empty-search-result">æœªæ‰¾åˆ° "${searchTerm}" ç›¸å…³æ­Œæ›²</div>`;
            return;
        }

        filteredSongs.forEach((song) => {
            const realIndex = song.originalIndex;

            const div = document.createElement('div');
            div.className = 'playlist-item';
            if (realIndex === currentIndex) div.classList.add('playing');

            const highlightText = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            };

            const displayTitle = highlightText(song.title, searchTerm);
            const displaySub = highlightText(song.sub, searchTerm);

            div.innerHTML = `
                <div class="song-info">
                    <div class="song-title-row">${displayTitle}</div>
                    <div class="song-sub-row">${displaySub}</div>
                </div>
                <div class="item-actions">
                    ${song.isCustom ? '<span class="custom-tag" title="è‡ªå®šä¹‰æ­Œæ›²"></span>' : ''}
                    <span class="action-icon-btn delete" title="ç§»é™¤">&times;</span>
                </div>
            `;

            if (song.isCustom) {
                div.querySelector('.custom-tag').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(realIndex);
                });
            }

            div.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`ç¡®å®šç§»é™¤ã€Š${song.title}ã€‹å—ï¼Ÿ`)) {
                    songs.splice(realIndex, 1);
                    savePlaylist();
                    
                    if (realIndex === currentIndex) {
                        if (songs.length > 0) {
                            currentIndex = realIndex % songs.length;
                            loadSong(currentIndex);
                            if (isPlaying) audio.play();
                        } else {
                            audio.pause();
                            isPlaying = false;
                            loadSong(0);
                        }
                    } else if (realIndex < currentIndex) {
                        currentIndex--;
                    }
                }
            });

            div.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = realIndex;
                loadSong(currentIndex);
                if (!isPlaying) togglePlay();
                else audio.play();
            });

            container.appendChild(div);
        });
    }

    function updatePlaylistHighlight() {
        const contentDiv = playlist.querySelector('.playlist-content');
        if (contentDiv) renderListContent(contentDiv);
    }

    confirmAddSongBtn.addEventListener('click', () => {
        const title = newSongTitle.value.trim();
        const sub = newSongSub.value.trim();
        const url = newSongUrl.value.trim();

        if (!title || !url) {
            showNotification('æ­Œåå’Œé“¾æŽ¥ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        const songData = {
            title,
            sub: sub || 'æœªçŸ¥è‰ºæœ¯å®¶',
            url,
            isCustom: true
        };

        if (editModeIndex >= 0) {
            songs[editModeIndex] = songData;
            showNotification('æ­Œæ›²ä¿¡æ¯å·²ä¿®æ”¹', 'success');
        } else {
            songs.unshift(songData);
            showNotification('æ­Œæ›²å·²æ·»åŠ ', 'success');
            if (songs.length === 1) loadSong(0);
        }

        searchTerm = '';
        savePlaylist();
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        hideModal(addSongModal);
    });

    cancelAddSongBtn.addEventListener('click', () => {
        hideModal(addSongModal);
    });

    function setupDrag() {
        let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
        const dragStart = (e) => {
            if (e.target.closest('.btn') || e.target.closest('.progress-wrapper') || e.target.closest('.playlist-popup')) return;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            isDragging = true; hasMoved = false;
            startX = event.clientX; startY = event.clientY;
            const rect = player.getBoundingClientRect();
            initialLeft = rect.left; initialTop = rect.top;
            player.style.transition = 'none';
            playlist.style.transition = 'none';
        };
        const dragMove = (e) => {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;
            const maxLeft = window.innerWidth - player.offsetWidth;
            const maxTop = window.innerHeight - player.offsetHeight;
            player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
            player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
            const rect = player.getBoundingClientRect();
            playlist.style.left = rect.left + 'px';
            playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        };
        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            player.style.transition = '';
            playlist.style.transition = '';
        };
        player.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        player.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', dragMove, { passive: false });
        document.addEventListener('touchend', dragEnd);

        miniView.addEventListener('click', () => {
            if (!hasMoved && player.classList.contains('collapsed')) {
                player.classList.remove('collapsed');
                setTimeout(() => {
                    const rect = player.getBoundingClientRect();
                    playlist.style.top = (rect.top + 170) + 'px';
                }, 300);
            }
        });
    }

    playBtn.addEventListener('click', togglePlay);
    document.getElementById('next-btn').addEventListener('click', nextSong);
    document.getElementById('prev-btn').addEventListener('click', prevSong);
    document.getElementById('minimize-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        player.classList.add('collapsed');
        playlist.classList.remove('active');
    });

    progressArea.addEventListener('click', (e) => {
        const width = progressArea.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) audio.currentTime = (clickX / width) * duration;
    });

    audio.addEventListener('timeupdate', (e) => {
        const { duration, currentTime } = e.target;
        if (duration) document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
    });
    audio.addEventListener('ended', nextSong);

    document.getElementById('mode-btn').addEventListener('click', () => {
        isRandom = !isRandom;
        document.getElementById('icon-loop').style.display = isRandom ? 'none' : 'block';
        document.getElementById('icon-shuffle').style.display = isRandom ? 'block' : 'none';
        showNotification(isRandom ? 'éšæœºæ’­æ”¾' : 'é¡ºåºæ’­æ”¾', 'info', 1000);
    });

    const listBtn = document.getElementById('list-btn');
    listBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = player.getBoundingClientRect();
        playlist.style.left = rect.left + 'px';
        playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        playlist.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!playlist.contains(e.target) && !listBtn.contains(e.target) && !player.contains(e.target) && !e.target.closest('#add-song-modal')) {
            playlist.classList.remove('active');
        }
    });

    loadSong(0);
    renderPlaylist();
    setupDrag();

    if (settings.musicPlayerEnabled) {
        player.classList.add('visible');
    }
};

        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];



function renderReplyLibrary() {
    const list = document.getElementById('custom-replies-list');
    const searchInput = document.getElementById('reply-search-input');
    const addButton = document.getElementById('add-custom-reply');
    const subTabsContainer = document.getElementById('cr-sub-tabs');
    const titleEl = document.getElementById('cr-modal-title');

    const currentConfig = LIBRARY_CONFIG[currentMajorTab];
    titleEl.textContent = currentConfig.title;

    subTabsContainer.innerHTML = currentConfig.tabs.map(tab => `
        <button class="reply-tab-btn ${currentSubTab === tab.id ? 'active' : ''}" 
                data-id="${tab.id}" data-mode="${tab.mode}">
            ${tab.name}
        </button>
    `).join('');

    subTabsContainer.querySelectorAll('.reply-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentSubTab = btn.dataset.id;
            renderReplyLibrary();
        });
    });

    list.innerHTML = '';
    list.className = 'content-list-area'; 
    
    const activeTabConfig = currentConfig.tabs.find(t => t.id === currentSubTab);
    list.classList.add(activeTabConfig.mode + '-mode');

    const filterText = searchInput ? searchInput.value.toLowerCase().trim() : '';
    let itemsToRender = [];
    let renderType = 'text'; 
    if (currentMajorTab === 'reply') {
        if (currentSubTab === 'custom') {
            itemsToRender = customReplies;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žå›žå¤';
            addButton.style.display = 'flex';
        } else if (currentSubTab === 'default') {
            itemsToRender = CONSTANTS.REPLY_MESSAGES;
            addButton.style.display = 'none';
        } else if (currentSubTab === 'emojis') {
            itemsToRender = CONSTANTS.REPLY_EMOJIS;
            renderType = 'emoji';
            addButton.style.display = 'none';
        } else if (currentSubTab === 'stickers') {
            itemsToRender = stickerLibrary;
            renderType = 'image';
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ·»åŠ è¡¨æƒ…';
            addButton.style.display = 'flex';
        }
    } else if (currentMajorTab === 'atmosphere') {
        addButton.style.display = 'flex';
        if (currentSubTab === 'pokes') {
            itemsToRender = customPokes;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žæ‹ä¸€æ‹';
        } else if (currentSubTab === 'statuses') {
            itemsToRender = customStatuses;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žçŠ¶æ€';
        } else if (currentSubTab === 'mottos') {
            itemsToRender = customMottos;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žæ ¼è¨€';
        } else if (currentSubTab === 'intros') {
            itemsToRender = customIntros;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žå¼€åœºè¯­';
        }
    }

    if (itemsToRender.length === 0) {
        list.innerHTML = renderEmptyState("åˆ—è¡¨ç©ºç©ºå¦‚ä¹Ÿ");
        return;
    }

    itemsToRender.forEach((item, index) => {
        if (renderType === 'text' && filterText && !item.toLowerCase().includes(filterText)) return;
        
        if (renderType === 'image') {
            const div = document.createElement('div');
            div.className = 'sticker-item';
            div.innerHTML = `
                <img src="${item}" loading="lazy">
                <div class="sticker-delete-btn"><i class="fas fa-times"></i></div>
            `;
            div.querySelector('.sticker-delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("åˆ é™¤æ­¤è¡¨æƒ…ï¼Ÿ")) {
                    stickerLibrary.splice(index, 1);
                    throttledSaveData();
                    renderReplyLibrary();
                }
            });
            list.appendChild(div);
            return;
        }

        if (renderType === 'emoji') {
            const isDisabled = disabledDefaultReplies.includes(item);
            const div = document.createElement('div');
            div.className = `emoji-item ${isDisabled ? 'disabled' : ''}`;
            div.textContent = item;
            div.onclick = () => {
                toggleEmoji(item);
            };
            list.appendChild(div);
            return;
        }

        const isDefaultReply = (currentMajorTab === 'reply' && currentSubTab === 'default');
        const isDisabled = isDefaultReply && disabledDefaultReplies.includes(item);
        
        const div = document.createElement('div');
        div.className = `custom-reply-item ${isDisabled ? 'disabled' : ''}`;
        
        let displayHTML = `<span class="custom-reply-text">${item.replace('|', '<br><small style="opacity:0.7">')}</span>`; 

        let buttonsHTML = '';
        if (isDefaultReply) {
             const icon = isDisabled ? 'fa-eye' : 'fa-eye-slash';
             buttonsHTML = `
                <button class="reply-action-mini copy-btn" title="å¤åˆ¶ä¸ºè‡ªå®šä¹‰"><i class="fas fa-copy"></i></button>
                <button class="reply-action-mini toggle-btn"><i class="fas ${icon}"></i></button>
             `;
        } else {
            buttonsHTML = `
                <button class="reply-action-mini edit-btn"><i class="fas fa-pen"></i></button>
                <button class="reply-action-mini delete-btn"><i class="fas fa-trash-alt"></i></button>
            `;
        }

        div.innerHTML = `${displayHTML}<div class="custom-reply-actions">${buttonsHTML}</div>`;

        if (isDefaultReply) {
            div.querySelector('.toggle-btn').onclick = () => toggleDefaultReply(item);
            div.querySelector('.copy-btn').onclick = () => copyToCustom(item);
        } else {
            div.querySelector('.delete-btn').onclick = () => deleteItem(index);
            div.querySelector('.edit-btn').onclick = () => editItem(index, item);
        }

        list.appendChild(div);
    });
}
function toggleEmoji(emoji) {
    const idx = disabledDefaultReplies.indexOf(emoji);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(emoji);
    throttledSaveData();
    renderReplyLibrary();
}

function toggleDefaultReply(text) {
    const idx = disabledDefaultReplies.indexOf(text);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(text);
    throttledSaveData();
    renderReplyLibrary();
}

function copyToCustom(text) {
    customReplies.push(text);
    currentSubTab = 'custom';
    throttledSaveData();
    renderReplyLibrary();
    showNotification('å·²å¤åˆ¶åˆ°è‡ªå®šä¹‰å›žå¤', 'success');
}

function deleteItem(index) {
    if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
    
    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies.splice(index, 1);
    else if (currentSubTab === 'pokes') customPokes.splice(index, 1);
    else if (currentSubTab === 'statuses') customStatuses.splice(index, 1);
    else if (currentSubTab === 'mottos') customMottos.splice(index, 1);
    else if (currentSubTab === 'intros') customIntros.splice(index, 1);

    throttledSaveData();
    renderReplyLibrary();
}

function editItem(index, oldText) {
    let newText;
    if (currentSubTab === 'intros') {
        const parts = oldText.split('|');
        const l1 = prompt("ä¿®æ”¹ä¸»æ ‡é¢˜:", parts[0]);
        if(l1 === null) return;
        const l2 = prompt("ä¿®æ”¹å‰¯æ ‡é¢˜:", parts[1] || "");
        if(l2 === null) return;
        newText = `${l1}|${l2}`;
    } else {
        newText = prompt("ä¿®æ”¹å†…å®¹:", oldText);
    }

    if (newText === null || newText.trim() === "") return;

    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies[index] = newText;
    else if (currentSubTab === 'pokes') customPokes[index] = newText;
    else if (currentSubTab === 'statuses') customStatuses[index] = newText;
    else if (currentSubTab === 'mottos') customMottos[index] = newText;
    else if (currentSubTab === 'intros') customIntros[index] = newText;

    throttledSaveData();
    renderReplyLibrary();
}
function renderEmptyState(text) {
    return `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; color: var(--text-secondary); opacity: 0.6; grid-column: 1 / -1;">
        <div style="width: 60px; height: 60px; background: var(--secondary-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: var(--shadow);">
            <i class="fas fa-search" style="font-size: 24px; color: var(--accent-color);"></i>
        </div>
        <p style="font-size:15px; font-weight: 500; text-align:center; line-height:1.5;">${text}</p>
    </div>`;
}

function initReplyLibraryListeners() {
    const entryBtn = document.getElementById('custom-replies-function');
    if (entryBtn) {
        entryBtn.addEventListener('click', () => {
            hideModal(DOMElements.advancedModal.modal);
            currentMajorTab = 'reply';
            currentSubTab = 'custom';
            document.querySelectorAll('.sidebar-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.major === 'reply');
            });
            renderReplyLibrary();
            showModal(DOMElements.customRepliesModal.modal);
        });
    }

    document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentMajorTab = btn.dataset.major;
            currentSubTab = LIBRARY_CONFIG[currentMajorTab].tabs[0].id;
            
            renderReplyLibrary();
        });
    });

    const searchInput = document.getElementById('reply-search-input');
    if (searchInput) searchInput.addEventListener('input', renderReplyLibrary);

    const exportBtn = document.getElementById('export-replies-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            const libraryData = {
                customReplies,
                customPokes,
                customStatuses,
                customMottos,
                customIntros,
                stickerLibrary,
                disabledDefaultReplies, 
                exportDate: new Date().toISOString()
            };
            const fileName = `reply-library-backup-${new Date().toISOString().slice(0, 10)}.json`;
            const dataStr = JSON.stringify(libraryData, null, 2);
            exportDataToMobileOrPC(dataStr, fileName);
        });
    }

    const importBtn = document.getElementById('import-replies-btn');
    const importInput = document.getElementById('import-replies-input');
    
    if (importBtn && importInput) {
        importBtn.addEventListener('click', () => {
            importInput.click();
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    let count = 0;
                    
                    if (data.customReplies) { customReplies = [...new Set([...customReplies, ...data.customReplies])]; count++; }
                    if (data.customPokes) { customPokes = [...new Set([...customPokes, ...data.customPokes])]; count++; }
                    if (data.customStatuses) { customStatuses = [...new Set([...customStatuses, ...data.customStatuses])]; count++; }
                    if (data.customMottos) { customMottos = [...new Set([...customMottos, ...data.customMottos])]; count++; }
                    if (data.customIntros) { customIntros = [...new Set([...customIntros, ...data.customIntros])]; count++; }
                    if (data.stickerLibrary) { stickerLibrary = [...new Set([...stickerLibrary, ...data.stickerLibrary])]; count++; }
                    
                    if (data.disabledDefaultReplies) { 
                        disabledDefaultReplies = [...new Set([...disabledDefaultReplies, ...data.disabledDefaultReplies])]; 
                        count++; 
                    }

                    throttledSaveData();
                    renderReplyLibrary();
                    showNotification('å®Œæ•´å›žå¤åº“æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        });
    }
    const addBtn = document.getElementById('add-custom-reply');
    if (addBtn) {
        addBtn.addEventListener('click', () => {
            if (currentSubTab === 'stickers') {
                document.getElementById('sticker-file-input').click();
                return;
            }

            let input;
            if (currentSubTab === 'intros') {
                 const l1 = prompt("è¯·è¾“å…¥ä¸»æ ‡é¢˜ (å¦‚: ð‘³ð’ð’—ð’†):");
                 if(!l1) return;
                 const l2 = prompt("è¯·è¾“å…¥å‰¯æ ‡é¢˜ (å¦‚: è‹¥è¦ç”±æˆ‘æ¥è°ˆè®ºçˆ±çš„è¯):");
                 input = `${l1}|${l2}`;
            } else {
                 input = prompt(`è¯·è¾“å…¥æ–°çš„${getCategoryName(currentSubTab)}:`);
            }

            if (input && input.trim()) {
                if (currentSubTab === 'custom') customReplies.unshift(input);
                else if (currentSubTab === 'pokes') customPokes.unshift(input);
                else if (currentSubTab === 'statuses') customStatuses.unshift(input);
                else if (currentSubTab === 'mottos') customMottos.unshift(input);
                else if (currentSubTab === 'intros') customIntros.unshift(input);
                
                throttledSaveData();
                renderReplyLibrary();
                showNotification('æ·»åŠ æˆåŠŸ', 'success');
            }
        });
    }
}
function getCategoryName(tabId) {
    const map = {
        'custom': 'å›žå¤', 'pokes': 'æ‹ä¸€æ‹', 'statuses': 'çŠ¶æ€', 
        'mottos': 'æ ¼è¨€', 'intros': 'å¼€åœºè¯­'
    };
    return map[tabId] || 'å†…å®¹';
}
        function updateTabUI() {
            document.querySelectorAll('.reply-tab-btn').forEach(btn => {
                if (btn.dataset.tab === currentReplyTab) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const searchInput = document.getElementById('reply-search-input');
            if (searchInput) searchInput.value = '';
        }


        function initRippleFeedback() {

            const rippleTargets = [
                '.input-btn',
                '.action-btn',
                '.modal-btn',
                '.settings-item',
                '.batch-action-btn',
                '.coin-btn-action',
                '.import-export-btn',
                '.reply-tab-btn',
                '.anniversary-type-btn',
                '.reply-tool-btn',
                '.session-action-btn',
                '.fav-action-btn'
            ];


            document.addEventListener('mousedown', function(e) {

                const target = e.target.closest(rippleTargets.join(','));

                if (target) {
                    createRipple(e, target);
                }
            });

            function createRipple(event, button) {

                if (!button.classList.contains('ripple-effect')) {
                    button.classList.add('ripple-effect');
                }


                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;


                const rect = button.getBoundingClientRect();


                const clientX = event.clientX || (event.touches ? event.touches[0].clientX: 0);
                const clientY = event.clientY || (event.touches ? event.touches[0].clientY: 0);

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${clientX - rect.left - radius}px`;
                circle.style.top = `${clientY - rect.top - radius}px`;
                circle.classList.add('ripple-wave');


                const ripple = button.getElementsByClassName('ripple-wave')[0];
                if (ripple) {
                    ripple.remove();
                }


                button.appendChild(circle);


                setTimeout(() => {
                    circle.remove();
                }, 600);
            }
        }
        function applyAvatarFrame(avatarContainer, frameSettings) {
            let frameElement = avatarContainer.querySelector('.avatar-frame');
            
            if (frameSettings && frameSettings.src) {
                if (!frameElement) {
                    frameElement = document.createElement('img');
                    frameElement.className = 'avatar-frame';
                    avatarContainer.appendChild(frameElement);
                }
                frameElement.src = frameSettings.src;
                frameElement.style.width = `${frameSettings.size || 100}%`;
                frameElement.style.height = `${frameSettings.size || 100}%`;
                
                const offsetX = frameSettings.offsetX || 0;
                const offsetY = frameSettings.offsetY || 0;
                frameElement.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
            } else {
                if (frameElement) {
                    frameElement.remove();
                }
            }
        }

        function setupAvatarFrameSettings() {
            const setupControlsFor = (type) => {
                const preview = document.getElementById(`${type}-frame-preview`);
                const uploadBtn = document.getElementById(`${type}-frame-upload-btn`);
                const removeBtn = document.getElementById(`${type}-frame-remove-btn`);
                const fileInput = document.getElementById(`${type}-frame-file-input`);
                const sizeSlider = document.getElementById(`${type}-frame-size`);
                const sizeValue = document.getElementById(`${type}-frame-size-value`);
                const xSlider = document.getElementById(`${type}-frame-offset-x`);
                const xValue = document.getElementById(`${type}-frame-offset-x-value`);
                const ySlider = document.getElementById(`${type}-frame-offset-y`);
                const yValue = document.getElementById(`${type}-frame-offset-y-value`);
                
                const settingsKey = type === 'my' ? 'myAvatarFrame' : 'partnerAvatarFrame';
                const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
                const avatarElement = type === 'my' ? DOMElements.me.avatar : DOMElements.partner.avatar;


const updatePreview = () => {
    let avatarContent = avatarElement.innerHTML;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = avatarContent;
    const img = tempDiv.querySelector('img');
    if (img) {
        avatarContent = `<img src="${img.src}" alt="preview">`;
    }

    const frameSettings = settings[settingsKey];

    let frameHtml = '';
    if (frameSettings && frameSettings.src) {
        const size = frameSettings.size || 100;
        const offsetX = frameSettings.offsetX || 0;
        const offsetY = frameSettings.offsetY || 0;
        
        frameHtml = `<img src="${frameSettings.src}" class="preview-frame" 
            style="width: ${size}%; height: ${size}%; transform: translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px));">`;
    }

    preview.innerHTML = `
        <div class="preview-bg-layer">
            ${avatarContent}
        </div>
        ${frameHtml}
    `;
};
                
                const updateControls = () => {
                    const frame = settings[settingsKey];
                    sizeSlider.value = frame?.size || 100;
                    sizeValue.textContent = `${sizeSlider.value}%`;
                    xSlider.value = frame?.offsetX || 0;
                    xValue.textContent = `${xSlider.value}px`;
                    ySlider.value = frame?.offsetY || 0;
                    yValue.textContent = `${ySlider.value}px`;
                    updatePreview();
                };
                
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 1024 * 1024) {
                        showNotification('å¤´åƒæ¡†å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1MB', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (!settings[settingsKey]) {
                            settings[settingsKey] = { size: 100, offsetX: 0, offsetY: 0 };
                        }
                        settings[settingsKey].src = event.target.result;
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        throttledSaveData();
                    };
                    reader.readAsDataURL(file);
                });
                
                removeBtn.addEventListener('click', () => {
                    settings[settingsKey] = null;
                    applyAvatarFrame(avatarContainer, null);
                    updateControls();
                    throttledSaveData();
                });

                [sizeSlider, xSlider, ySlider].forEach(slider => {
                    slider.addEventListener('input', () => {
                        if (!settings[settingsKey]) return;
                        settings[settingsKey].size = parseInt(sizeSlider.value);
                        settings[settingsKey].offsetX = parseInt(xSlider.value);
                        settings[settingsKey].offsetY = parseInt(ySlider.value);
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        renderMessages(true); 
                    });
                     slider.addEventListener('change', throttledSaveData);
                });

                updateControls();
            };
            
            setupControlsFor('my');
            setupControlsFor('partner');
        }

        function applyAllAvatarFrames() {
            applyAvatarFrame(DOMElements.me.avatarContainer, settings.myAvatarFrame);
            applyAvatarFrame(DOMElements.partner.avatarContainer, settings.partnerAvatarFrame);
        }
        const themeColorMappings = {
            '--primary-bg': 'ä¸»èƒŒæ™¯',
            '--secondary-bg': 'å¡ç‰‡/å¼¹çª—èƒŒæ™¯',
            '--header-bg': 'é¡¶æ èƒŒæ™¯',
            '--input-area-bg': 'è¾“å…¥åŒºèƒŒæ™¯',
            '--text-primary': 'ä¸»è¦æ–‡å­—',
            '--text-secondary': 'æ¬¡è¦æ–‡å­—',
            '--border-color': 'è¾¹æ¡†/åˆ†å‰²çº¿',
            '--accent-color': 'å¼ºè°ƒè‰²/å›¾æ ‡',
            '--message-sent-bg': 'å‘é€æ°”æ³¡èƒŒæ™¯',
            '--message-sent-text': 'å‘é€æ°”æ³¡æ–‡å­—',
            '--message-received-bg': 'æŽ¥æ”¶æ°”æ³¡èƒŒæ™¯',
            '--message-received-text': 'æŽ¥æ”¶æ°”æ³¡æ–‡å­—',
        };

        function initThemeEditor() {
            const editorModal = document.getElementById('theme-editor-modal');
            document.getElementById('open-theme-editor').addEventListener('click', () => {
                hideModal(document.getElementById('appearance-modal'));
                populateThemeEditor();
                populateThemeSelector();
                showModal(editorModal);
            });
            document.getElementById('close-theme-editor').addEventListener('click', () => {
                hideModal(editorModal);
                updateUI();
            });
            document.getElementById('save-theme-preset-btn').addEventListener('click', saveCurrentThemeAsPreset);
            document.getElementById('delete-theme-preset-btn').addEventListener('click', deleteCurrentPreset);
            
document.getElementById('theme-preset-selector').addEventListener('change', (e) => {
    const selectedValue = e.target.value;
    
    if (selectedValue === "current-editing") {
        return; 
    }
    
    if (selectedValue.startsWith('custom-')) {
        const theme = customThemes.find(t => t.id === selectedValue);
        if (theme) {
            settings.colorTheme = theme.id;
            applyTheme(theme.colors);
            populateThemeEditor(theme.colors);
            throttledSaveData();
        }
    }
});
        }

        function populateThemeEditor(currentColors = null) {
            const grid = document.getElementById('theme-editor-grid');
            grid.innerHTML = '';
            const rootStyle = getComputedStyle(document.documentElement);

            for (const [variable, label] of Object.entries(themeColorMappings)) {
                const colorValue = currentColors ? currentColors[variable] : rootStyle.getPropertyValue(variable).trim();
                const item = document.createElement('div');
                item.className = 'color-picker-item';
                item.innerHTML = `
                    <label for="color-${variable}">${label}</label>
                    <input type="color" id="color-${variable}" data-variable="${variable}" value="${colorValue}">
                `;
                grid.appendChild(item);
                item.querySelector('input[type="color"]').addEventListener('input', (e) => {
                    const newColor = e.target.value;
                    const cssVar = e.target.dataset.variable;
                    document.documentElement.style.setProperty(cssVar, newColor);
                });
            }
        }

        function applyTheme(colors, isReset = false) {
            if (isReset) {
                for (const variable of Object.keys(themeColorMappings)) {
                    document.documentElement.style.removeProperty(variable);
                }
                return;
            }
            if (!colors) return;
            for (const [variable, color] of Object.entries(colors)) {
                document.documentElement.style.setProperty(variable, color);
            }
        }
        
        function saveCurrentThemeAsPreset() {
            const presetName = prompt("è¯·è¾“å…¥æ–°ä¸»é¢˜æ–¹æ¡ˆçš„åç§°ï¼š");
            if (!presetName || !presetName.trim()) return;

            const newTheme = {
                id: `custom-${Date.now()}`,
                name: presetName.trim(),
                colors: {}
            };
            for (const variable of Object.keys(themeColorMappings)) {
                newTheme.colors[variable] = getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
            }
            customThemes.push(newTheme);
            settings.colorTheme = newTheme.id;
            saveCustomThemes();
            populateThemeSelector();
            showNotification(`ä¸»é¢˜ "${presetName}" å·²ä¿å­˜`, "success");
        }

        function deleteCurrentPreset() {
            const selector = document.getElementById('theme-preset-selector');
            const selectedId = selector.value;
            if (!selectedId.startsWith('custom-')) {
                showNotification('æ— æ³•åˆ é™¤é¢„è®¾ä¸»é¢˜', 'warning');
                return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸»é¢˜ "${selector.options[selector.selectedIndex].text}" å—ï¼Ÿ`)) {
                customThemes = customThemes.filter(t => t.id !== selectedId);
                settings.colorTheme = 'gold'; 
                saveCustomThemes();
                updateUI();
                populateThemeSelector();
                populateThemeEditor(); 
                showNotification('ä¸»é¢˜å·²åˆ é™¤', 'success');
            }
        }

function populateThemeSelector() {
    const selector = document.getElementById('theme-preset-selector');
    selector.innerHTML = '';

    const defaultOption = document.createElement('option');
    defaultOption.value = "current-editing";
    defaultOption.textContent = "å½“å‰ç¼–è¾‘ä¸­...";
    selector.appendChild(defaultOption);

    if (customThemes.length > 0) {
        const customGroup = document.createElement('optgroup');
        customGroup.label = "æˆ‘çš„è‡ªå®šä¹‰ä¸»é¢˜";
        customThemes.forEach(theme => {
            const option = document.createElement('option');
            option.value = theme.id;
            option.textContent = theme.name;
            customGroup.appendChild(option);
        });
        selector.appendChild(customGroup);
    }

    if (settings.colorTheme.startsWith('custom-')) {
        selector.value = settings.colorTheme;
    } else {
        selector.value = "current-editing";
    }
}
        
        function saveCustomThemes() {
             safeSetItem(`${APP_PREFIX}customThemes`, JSON.stringify(customThemes));
        }

document.addEventListener('DOMContentLoaded', async () => {
    const hideWelcomeScreen = () => {
        const anim = document.getElementById('welcome-animation');
        if (anim) {
            anim.classList.add('hidden');
            setTimeout(() => {
                anim.style.display = 'none';
            }, 800);
        }
    };

    // 1. å…ˆç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»ï¼Œé˜²æ­¢å¡æ­»
    try {
        setupEventListeners(); 
        initThemeEditor();
        // ç»‘å®šå¿ƒæ™´æ‰‹è´¦å’Œçºªå¿µæ—¥æ¨¡å—
        initAnniversaryModule(); 
        initMoodListeners();
        initDecisionModule();
        initComboMenu(); 
    } catch (e) {
        console.error("äº‹ä»¶ç»‘å®šéƒ¨åˆ†å‡ºé”™:", e);
    }

    try {
        if (typeof localforage === 'undefined') {
            console.error('LocalForage æœªåŠ è½½ï¼Œå°è¯•ä½¿ç”¨ localStorage åŽå¤‡æˆ–æŠ¥é”™');
            // è¿™é‡Œå¯ä»¥æ·»åŠ é™çº§å¤„ç†ï¼Œä½†æš‚æ—¶æŠ›å‡ºé”™è¯¯
        }

        // 2. åˆå§‹åŒ–ä¼šè¯
        await initializeSession();

        // 3. åŠ è½½æ•°æ® (åŠ äº†å•ç‹¬çš„ try-catchï¼Œé˜²æ­¢æ•°æ®æŸåå¡æ­»å…¨æµç¨‹)
        try {
            await loadData();
        } catch (dataErr) {
            console.error("è¯»å–å­˜æ¡£å¤±è´¥ï¼Œå·²è‡ªåŠ¨é‡ç½®ä¸ºé»˜è®¤è®¾ç½®:", dataErr);
            // å¦‚æžœè¯»å–å¤±è´¥ï¼Œç¡®ä¿ settings æœ‰é»˜è®¤å€¼ï¼Œé˜²æ­¢åŽç»­æŠ¥é”™
            settings = getDefaultSettings(); 
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸€ä¸ªé™é»˜çš„ toast æç¤ºï¼Œä¸è¦å¼¹çª—å¹²æ‰°
        }
        
        // 4. åˆå§‹åŒ– UI å’Œ æ’­æ”¾å™¨
        initializeRandomUI();
        initMusicPlayer();
        
        setInterval(checkStatusChange, 60000);

        const disclaimerModal = document.getElementById('disclaimer-modal');
        const tourSeen = await localforage.getItem(APP_PREFIX + 'tour_seen');
        const acceptDisclaimerBtn = document.getElementById('accept-disclaimer');
        
        if (disclaimerModal && !tourSeen) {
            showModal(disclaimerModal);
        }
        if (acceptDisclaimerBtn) {
            acceptDisclaimerBtn.addEventListener('click', () => {
                hideModal(disclaimerModal);
                startTour(); 
            });
        }

        // !! æ–°å¢ž/ç§»åŠ¨åˆ°è¿™é‡Œçš„ä»£ç  !!
        // ç­‰å¾…ä¸€å°ä¼šå„¿ï¼Œè®©æœ€åŽçš„UIæ¸²æŸ“å®Œæˆï¼Œç„¶åŽéšè—åŠ è½½åŠ¨ç”»
        setTimeout(hideWelcomeScreen, 3000); 

    } catch (err) {
        console.error("ä¸¥é‡åˆå§‹åŒ–é”™è¯¯:", err);
        document.querySelector('.welcome-subtitle-scramble').textContent = "åŠ è½½é‡åˆ°é—®é¢˜ï¼Œå·²å¼ºåˆ¶è¿›å…¥...";
        // å¦‚æžœå‡ºé”™ï¼Œä¹Ÿéšè—åŠ è½½åŠ¨ç”»ï¼Œé˜²æ­¢å¡æ­»
        setTimeout(hideWelcomeScreen, 500); 
        
    } finally {
        // è¿™é‡Œçš„ä»£ç è¢«ç§»èµ°äº†
    }
});

            const stickerInput = document.getElementById('sticker-file-input');
            if (stickerInput) {
                stickerInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.size > 2 * 1024 * 1024) { 
                         showNotification('å›¾ç‰‡å¤ªå¤§äº†ï¼Œè¯·ä¸Šä¼  2MB ä»¥å†…çš„å›¾ç‰‡', 'error');
                         return;
                    }

                    showNotification('æ­£åœ¨å¤„ç†å›¾ç‰‡...', 'info');
                    
                    optimizeImage(file, 300, 0.8).then(base64 => {
                        stickerLibrary.push(base64);
                        throttledSaveData();
                        renderReplyLibrary();
                        showNotification('è¡¨æƒ…ä¸Šä¼ æˆåŠŸ', 'success');
                    }).catch(err => {
                        console.error(err);
                        showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
                    });
                    
                    e.target.value = '';
                });
            }
const tourOverlay = document.getElementById('tour-overlay');
const tourPopover = document.getElementById('tour-popover');
const tourHighlightBox = document.getElementById('tour-highlight-box');
const tourTitle = document.getElementById('tour-title');
const tourContent = document.getElementById('tour-content');
const tourStepCounter = document.getElementById('tour-step-counter');
const tourNextBtn = document.getElementById('tour-next-btn');
const tourPrevBtn = document.getElementById('tour-prev-btn');
const tourSkipBtn = document.getElementById('tour-skip-btn');

let currentTourStep = 0;
let isTourActive = false;

const tourSteps = [
    {
        title: "æ¬¢è¿Žä½¿ç”¨ã€Œä¼ è®¯ã€",
        content: "è¿™æ˜¯ä¸€ä¸ªæ–°æ‰‹å¼•å¯¼æ•™ç¨‹ï¼Œå¸¦ä½ å¿«é€Ÿäº†è§£åŠŸèƒ½ï¼Œè¯·æœ€å¥½çœ‹ä¸€ä¸‹å“¦ðŸ¥ºå¦å¤–è¯´æ˜Žå‚è€ƒäº†Bç«™ molina-3-çš„ä¼ è®¯ç½‘ç«™",
        position: 'center'
    },
    {
        element: '#my-name',
        title: "è¿™æ˜¯â€œä½ â€",
        content: "ä¸Šæ–¹æ˜¯ä½ çš„æ˜µç§°ï¼Œç‚¹å‡»å®ƒå¯ä»¥è¿›è¡Œä¿®æ”¹",
        position: 'top'
    },
    {
        element: '#my-avatar',
        title: "ä½ çš„å¤´åƒ",
        content: "ç‚¹å‡»è¿™é‡Œå¯ä»¥ä¸Šä¼ /æ›´æ”¹ä½ çš„å¤´åƒã€‚",
        position: 'top'
    },
    {
        element: '#my-status-container',
        title: "ä½ çš„çŠ¶æ€",
        content: "ä½ çš„çŠ¶æ€ï¼Œç‚¹å‡»å¯ä»¥è¿›è¡Œç¼–è¾‘ï¼Œä¸€èˆ¬è€Œè¨€æ¢¦è§’æ˜¯èƒ½å¤Ÿçœ‹è§çš„",
        position: 'top'
    },
    {
        element: '#partner-name',
        title: "è¿™æ˜¯â€œæ¢¦è§’â€",
        content: "è¿™é‡Œæ˜¯æ¢¦è§’çš„æ˜µç§°ï¼ŒåŒæ ·å¯ä»¥ç‚¹å‡»ä¿®æ”¹ã€‚",
        position: 'top'
    },
    {
        element: '#message-input',
        title: "æ¶ˆæ¯è¾“å…¥æ¡†",
        content: "åœ¨è¿™é‡Œè¾“å…¥ä½ æƒ³è¯´çš„è¯ï¼ŒæŒ‰å›žè½¦é”®æˆ–çº¸é£žæœºå‘é€ã€‚",
        position: 'top'
    },
    {
        element: '#send-btn',
        title: "å‘é€æŒ‰é’®",
        content: "ç‚¹å‡»çº¸é£žæœºï¼Œå°±èƒ½å°†ä½ çš„å¿ƒæ„ä¼ è¾¾ç»™æ¢¦è§’ã€‚",
        position: 'top'
    },
    {
        element: '#attachment-btn',
        title: "å‘é€å›¾ç‰‡",
        content: "ç‚¹å‡»è¿™é‡Œï¼Œå¯ä»¥å‘é€å›¾ç‰‡ï¼",
        position: 'top'
    },
    {
        element: '#poke-btn',
        title: "â€œæ‹ä¸€æ‹â€åŠŸèƒ½",
        content: "â€œæ‹ä¸€æ‹â€åŠŸèƒ½ï¼Œå¯ä»¥å‘é€è‡ªå®šä¹‰çš„äº’åŠ¨æ¶ˆæ¯",
        position: 'top'
    },
    {
        element: '#continue-btn',
        title: "ç»§ç»­è¯´",
        content: "å¦‚æžœæƒ³è®©æ¢¦è§’ç»§ç»­è¯´è¯æˆ–è€…ä¸çŸ¥é“è¯´ä»€ä¹ˆäº†ï¼Œç‚¹å‡»è¿™é‡Œï¼Œå¯¹æ–¹ä¼šè‡ªåŠ¨å›žå¤",
        position: 'top'
    },
    {
        element: '#batch-btn',
        title: "æ‰¹é‡å‘é€æ¨¡å¼",
        content: "å¼€å¯æ‰¹é‡æ¨¡å¼ï¼Œå¯ä»¥ç¼–è¾‘å¤šæ¡æ¶ˆæ¯åŽä¸€å¹¶å‘é€ã€‚",
        position: 'top'
    },
    {
        element: '#settings-btn',
        title: "å…¨å±€è®¾ç½®",
        content: "æ‰€æœ‰è®¾ç½®éƒ½åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç‚¹å¼€çœ‹çœ‹å§ï¼",
        position: 'bottom',
        onBefore: () => {
            if (isTourActive) document.querySelectorAll('.modal').forEach(m => hideModal(m));
        }
    },
    {
        element: '#settings-modal .modal-content',
        title: "è®¾ç½®ä¸­å¿ƒ",
        content: "è¿™é‡Œæœ‰å››ä¸ªä¸»è¦æ¨¡å—ï¼šå¤–è§‚ã€èŠå¤©ã€é«˜çº§åŠŸèƒ½å’Œæ•°æ®ç®¡ç†ã€‚",
        position: 'bottom',
        onBefore: () => {
            if (isTourActive) showModal(DOMElements.settingsModal.modal);
        }
    },
    {
        element: '#appearance-settings',
        title: "å¤–è§‚è®¾ç½®",
        content: "è‡ªå®šä¹‰ä¸»é¢˜é¢œè‰²ã€å­—ä½“å¤§å°ã€èŠå¤©æ°”æ³¡å’ŒèƒŒæ™¯å›¾ã€‚",
        position: 'bottom'
    },
    {
        element: '#chat-settings',
        title: "èŠå¤©è®¾ç½®",
        content: "æ²¡å•¥ç”¨å…¶å®žï¼Œä¸€äº›åŠŸèƒ½çš„å¼€å…³ï¼Œæ¯”å¦‚æ¶ˆæ¯éŸ³æ•ˆã€å·²è¯»å›žæ‰§ç­‰ã€‚",
        position: 'bottom'
    },
    {
        element: '#advanced-settings',
        title: "é«˜çº§åŠŸèƒ½",
        content: "è¯·ä¸€å®šè¦ç‚¹å‡»çœ‹çœ‹ï¼å¯ä»¥å¢žåŠ è‡ªå®šä¹‰å›žå¤ï¼ï¼è¿˜æœ‰éŸ³ä¹æ’­æ”¾å™¨ã€æ¯æ—¥è¿åŠ¿ç­‰ã€‚",
        position: 'bottom'
    },
    {
        element: '#data-settings',
        title: "æ•°æ®ç®¡ç†",
        content: "åœ¨è¿™é‡Œå¯ä»¥å¯¼å…¥/å¯¼å‡ºèŠå¤©è®°å½•ï¼Œæˆ–è€…æ¸…ç©ºæ•°æ®ã€‚æˆ‘ä»¬é‡æ–°å¼€å§‹æ•™ç¨‹çš„æŒ‰é’®ä¹Ÿåœ¨è¿™é‡Œå“¦ï¼",
        position: 'top'
    },
    {
        element: '#theme-toggle',
        title: "åˆ‡æ¢ä¸»é¢˜",
        content: "è¿™æ˜¯ä¸ªå¿«æ·æŒ‰é’®ï¼Œå¯ä»¥å¿«é€Ÿåœ¨ç™½å¤©å’Œé»‘å¤œæ¨¡å¼ä¹‹é—´åˆ‡æ¢ã€‚",
        position: 'bottom',
        onBefore: () => {
             if (isTourActive) hideModal(DOMElements.settingsModal.modal);
        }
    },
    {
        element: '#favorites-btn',
        title: "æ”¶è—å¤¹",
        content: "æ‰€æœ‰æ”¶è—çš„æ¶ˆæ¯éƒ½ä¼šåœ¨è¿™é‡Œå±•ç¤ºã€‚",
        position: 'bottom'
    },
    {
        element: '#session-manager-btn',
        title: "ä¼šè¯ç®¡ç†",
        content: "ä½ å¯ä»¥åˆ›å»ºå¤šä¸ªç‹¬ç«‹çš„èŠå¤©ä¼šè¯ï¼Œäº’ä¸å¹²æ‰°ã€‚åœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œåˆ‡æ¢ã€é‡å‘½åæˆ–åˆ é™¤ã€‚",
        position: 'bottom'
    },
    {
        title: "æ¶ˆæ¯æ“ä½œ",
        content: "å½“ä½ ç‚¹å‡»ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå‡ºçŽ°å‡ ä¸ªæŒ‰é’®ï¼Œæ¯”å¦‚æ”¶è—ã€å›žå¤å’Œæ·»åŠ æ³¨é‡Šã€‚",
        position: 'center'
    },
    {
        title: "æ•™ç¨‹ç»“æŸ",
        content: "ä½ å·²ç»æŽŒæ¡äº†æ‰€æœ‰åŸºæœ¬åŠŸèƒ½ï¼è¯·å¼€å§‹ä¼ è®¯å§ï¼å¸Œæœ›ä½ èƒ½åœ¨è¿™é‡Œæ”¶èŽ·åˆ°çˆ±ä¸Žå¹¸ç¦ðŸ¥º",
        position: 'center'
    }
];

function startTour() {
    isTourActive = true;
    tourOverlay.style.display = 'block';
    setTimeout(() => tourOverlay.classList.add('active'), 10);
    currentTourStep = 0;
    showTourStep(currentTourStep);
}

function endTour() {
    isTourActive = false;
    tourOverlay.classList.remove('active');
    tourPopover.classList.remove('visible');
    setTimeout(() => {
        tourOverlay.style.display = 'none';
        tourHighlightBox.style.width = '0px';
        tourHighlightBox.style.height = '0px';
        tourHighlightBox.style.opacity = '0';
    }, 300);
    localforage.setItem(APP_PREFIX + 'tour_seen', 'true');
    document.querySelectorAll('.modal').forEach(m => hideModal(m));
}

function showTourStep(index) {
    if (index < 0 || index >= tourSteps.length) {
        endTour();
        return;
    }
    const step = tourSteps[index];
    if (step.onBefore) {
        step.onBefore();
    }
    setTimeout(() => {
        tourTitle.textContent = step.title;
        tourContent.innerHTML = step.content;
        tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
        tourPopover.classList.remove('visible');
        tourPrevBtn.style.visibility = (index === 0) ? 'hidden' : 'visible';
        if (index === tourSteps.length - 1) {
            tourNextBtn.innerHTML = 'å®Œæˆ <i class="fas fa-check"></i>';
        } else {
            tourNextBtn.innerHTML = 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>';
        }
        const targetElement = step.element ? document.querySelector(step.element) : null;
        if (targetElement) {
            const rect = targetElement.getBoundingClientRect();
            tourHighlightBox.style.width = `${rect.width + 10}px`;
            tourHighlightBox.style.height = `${rect.height + 10}px`;
            tourHighlightBox.style.top = `${rect.top - 5}px`;
            tourHighlightBox.style.left = `${rect.left - 5}px`;
            tourHighlightBox.style.opacity = '1';
            positionPopover(rect, step.position);
        } else {
            tourHighlightBox.style.opacity = '0';
            tourHighlightBox.style.width = '0px';
            tourHighlightBox.style.height = '0px';
            tourPopover.style.top = '50%';
            tourPopover.style.left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
        }
        setTimeout(() => tourPopover.classList.add('visible'), 50);
    }, (step.onBefore ? 400 : 0));
}

function positionPopover(rect, position) {
    const popoverRect = tourPopover.getBoundingClientRect();
    const spacing = 15;
    let top, left;
    switch (position) {
        case 'top':
            top = rect.top - popoverRect.height - spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'bottom':
            top = rect.bottom + spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'left':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.left - popoverRect.width - spacing;
            break;
        case 'right':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.right + spacing;
            break;
        default:
            top = '50%';
            left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
            tourPopover.style.top = top;
            tourPopover.style.left = left;
            return;
    }
    if (top < 10) top = 10;
    if (left < 10) left = 10;
    if (left + popoverRect.width > window.innerWidth - 10) {
        left = window.innerWidth - popoverRect.width - 10;
    }
    if (top + popoverRect.height > window.innerHeight - 10) {
        top = window.innerHeight - popoverRect.height - 10;
    }
    tourPopover.style.top = `${top}px`;
    tourPopover.style.left = `${left}px`;
    tourPopover.style.transform = 'none';
}

function nextTourStep() {
    currentTourStep++;
    showTourStep(currentTourStep);
}

async function createNewSession(switchToIt = true) {
    const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    const newSession = {
        id: newId,
        name: `ä¼šè¯ ${new Date().toLocaleDateString()}`,
        createdAt: Date.now()
    };

    sessionList.push(newSession);
    await localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

    if (switchToIt) {
        window.location.hash = newId;
        window.location.reload();
    }
    
    return newId;
}

window.selectAnnType = function(type) {
    currentAnniversaryType = type;
    document.querySelectorAll('.anniversary-type-btn').forEach(btn => {
        if(btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const hint = document.getElementById('ann-type-desc');
    if(hint) {
        hint.textContent = type === 'anniversary' 
            ? 'è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤© (ä¾‹å¦‚: æ‹çˆ±çºªå¿µæ—¥)' 
            : 'è®¡ç®—ä»ŽçŽ°åœ¨åˆ°æœªæ¥æŸä¸€å¤©è¿˜å‰©ä¸‹å¤šå°‘å¤© (ä¾‹å¦‚: å¯¹æ–¹ç”Ÿæ—¥)';
    }
};

window.deleteAnniversary = function(id, event) {
    if(event) event.stopPropagation();
    
    if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData();
        renderAnniversaries();
        showNotification('çºªå¿µæ—¥å·²åˆ é™¤', 'success');
    }
};

function renderAnniversariesList() {
    const listContainer = document.getElementById('ann-list-container');
    const headerCard = document.getElementById('ann-header-card');
    
    if (!listContainer) return;
    listContainer.innerHTML = '';

    anniversaries.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (anniversaries.length === 0) {
        headerCard.style.display = 'none';
        listContainer.innerHTML = `
            <div class="ann-empty">
                <i class="fas fa-calendar-plus" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼ŒåŽ»æ·»åŠ ä¸€ä¸ªå§~</p>
            </div>`;
        return;
    }

    const now = new Date();
    const topAnn = anniversaries[0]; 
    if (topAnn) {
        headerCard.style.display = 'block';
        document.getElementById('ann-header-title').textContent = topAnn.name;
        document.getElementById('ann-header-date').textContent = topAnn.date;
        
        const targetDate = new Date(topAnn.date);
        const diffTime = Math.abs(now - targetDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        document.getElementById('ann-header-days').textContent = diffDays;
    }

    anniversaries.forEach(ann => {
        const targetDate = new Date(ann.date);
        let diffDays = 0;
        let typeClass = '';
        let typeLabel = '';

        if (ann.type === 'countdown') {
            typeClass = 'type-future';
            typeLabel = 'å€’æ•°';
            diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            if(diffDays < 0) diffDays = 0;
        } else {
            typeClass = 'type-past';
            typeLabel = 'çºªå¿µ';
            diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
        }

        const html = `
            <div class="ann-item-card ${typeClass}">
                <div class="ann-item-left">
                    <div class="ann-item-name">${ann.name}</div>
                    <div class="ann-item-date">
                        <span class="ann-tag">${typeLabel}</span>
                        ${ann.date}
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="ann-item-right">
                        <div class="ann-item-days">${diffDays}<span>å¤©</span></div>
                    </div>
                    <div class="ann-delete-btn" onclick="deleteAnniversaryItem(${ann.id})">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', html);
    });
}

function initAnniversaryModule() {
    const entryBtn = document.getElementById('anniversary-function');
    const modal = document.getElementById('anniversary-modal');
    
    if (entryBtn) {
        // é˜²æ­¢é‡å¤ç»‘å®š
        if (entryBtn.dataset.initialized) return;
        
        entryBtn.addEventListener('click', () => {
            console.log('é‡è¦æ—¥æŒ‰é’®è¢«ç‚¹å‡»');
            hideModal(document.getElementById('advanced-modal'));
            renderAnniversariesList();
            showModal(modal);
        });
        entryBtn.dataset.initialized = 'true';
    } else {
        console.warn('æœªæ‰¾åˆ°anniversary-functionæŒ‰é’®');
    }

    const closeBtn = document.getElementById('close-anniversary-modal');
    if (closeBtn && !closeBtn.dataset.initialized) {
        closeBtn.addEventListener('click', () => hideModal(modal));
        closeBtn.dataset.initialized = 'true';
    }

    const openAddBtn = document.getElementById('open-ann-add-btn');
    const editorSlide = document.getElementById('ann-editor-slide');
    if (openAddBtn && !openAddBtn.dataset.initialized) {
        openAddBtn.addEventListener('click', () => {
            document.getElementById('ann-input-name').value = '';
            document.getElementById('ann-input-date').value = '';
            window.selectAnnType('anniversary');
            editorSlide.classList.add('active');
        });
        openAddBtn.dataset.initialized = 'true';
    }

    const closeEditorBtn = document.getElementById('close-ann-editor');
    if (closeEditorBtn && !closeEditorBtn.dataset.initialized) {
        closeEditorBtn.addEventListener('click', () => {
            editorSlide.classList.remove('active');
        });
        closeEditorBtn.dataset.initialized = 'true';
    }

    const saveBtn = document.getElementById('save-ann-btn');
    if (saveBtn && !saveBtn.dataset.initialized) {
        saveBtn.addEventListener('click', () => {
            const name = document.getElementById('ann-input-name').value.trim();
            const date = document.getElementById('ann-input-date').value;

            if (!name || !date) {
                showNotification('è¯·å¡«å†™å®Œæ•´çš„åç§°å’Œæ—¥æœŸ', 'warning');
                return;
            }

            const newAnn = {
                id: Date.now(),
                name: name,
                date: date,
                type: currentAnniversaryType
            };

            anniversaries.push(newAnn);
            throttledSaveData(); 
            renderAnniversariesList();
            
            editorSlide.classList.remove('active');
            showNotification('çºªå¿µæ—¥æ·»åŠ æˆåŠŸ', 'success');
        });
        saveBtn.dataset.initialized = 'true';
    }
}
function prevTourStep() {
    currentTourStep--;
    showTourStep(currentTourStep);
}

function setupTutorialListeners() {
    tourNextBtn.addEventListener('click', nextTourStep);
    tourPrevBtn.addEventListener('click', prevTourStep);
    tourSkipBtn.addEventListener('click', endTour);

    const replayBtn = document.getElementById('replay-tutorial-btn');
    if(replayBtn) {
        replayBtn.addEventListener('click', () => {
            hideModal(DOMElements.dataModal.modal);
            setTimeout(() => {
                if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ–°æ‰‹å¼•å¯¼æ•™ç¨‹å—ï¼Ÿ')) {
                    startTour();
                }
            }, 300);
        });
    }
}

    </script>
</body>
</html>