<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="black-white">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

    <title>‰º†ËÆØ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/png" sizes="192x192" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<link rel="apple-touch-icon" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<meta name="apple-mobile-web-app-title" content=" öùë≥ùë∂ùëΩùë¨…û">
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0;
        }

:root {
            --primary-bg: #f9f9f9;
            --secondary-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #7a7a7a;
            --border-color: #ebebeb;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #f0f0f0;
            --message-received-text: #1a1a1a; 
            --header-bg: #ffffff;
            --input-area-bg: #ffffff; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-family: 'Noto Serif SC', serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size: 16px;
            --favorite-color: #ffc107;
            --primary-bg-rgb: 249, 249, 249;
            --secondary-bg-rgb: 255, 255, 255;
            --bubble-style: 'standard';
            --message-font-family: 'Noto Serif SC', serif;
            --message-font-weight: 400;
            --message-line-height: 1.5;
            --in-chat-avatar-size: 36px;
        }

:root[data-color-theme="gold"] {
            --accent-color: #c5a47e;
            --accent-color-dark: #d4af37;
            --accent-color-rgb: 197, 164, 126;
        }
:root[data-color-theme="blue"] {
            --accent-color: #7FA6CD;
            --accent-color-dark: #7FA6CD;
            --accent-color-rgb: 127, 166, 205;
        }
:root[data-color-theme="purple"] {
            --accent-color: #BB9EC7;
            --accent-color-dark: #BB9EC7;
            --accent-color-rgb: 187, 158, 199;
        }
:root[data-color-theme="green"] {
            --accent-color: #7BC8A4;
            --accent-color-dark: #7BC8A4;
            --accent-color-rgb: 123, 200, 164;
        }
:root[data-color-theme="pink"] {
            --accent-color: #F4A6B3;
            --accent-color-dark: #F4A6B3;
            --accent-color-rgb: 244, 166, 179;
        }
:root[data-color-theme="black-white"] {
            --accent-color: #333333;
            --accent-color-dark: #D6D6D6;
            --accent-color-rgb: 51, 51, 51;
        }
:root[data-color-theme="pastel"] {
            --accent-color: #A8D8EA;
            --accent-color-dark: #AA96DA;
            --accent-color-rgb: 168, 216, 234;
        }
:root[data-color-theme="sunset"] {
            --accent-color: #FF9A8B;
            --accent-color-dark: #FF6B6B;
            --accent-color-rgb: 255, 154, 139;
        }
:root[data-color-theme="forest"] {
            --accent-color: #7BA05B;
            --accent-color-dark: #556B2F;
            --accent-color-rgb: 123, 160, 91;
        }
:root[data-color-theme="ocean"] {
            --accent-color: #4A90E2;
            --accent-color-dark: #2E5B9A;
            --accent-color-rgb: 74, 144, 226;
        }

        html[data-theme="dark"] {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-primary: #e5e5e5;
            --text-secondary: #8c8c8c;
            --border-color: #2f2f2f;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #2a2a2a;
            --message-received-text: #e5e5e5; 
            --header-bg: #1e1e1e; 
            --input-area-bg: #1e1e1e; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --favorite-color: #ffd700;

            --primary-bg-rgb: 18, 18, 18;
            --secondary-bg-rgb: 30, 30, 30;
        }

        html[data-theme="dark"][data-color-theme="black-white"] .message-sent {
            color: #1a1a1a !important;
        }

        html[data-theme="dark"][data-color-theme="gold"] .message-sent,
        html[data-theme="dark"][data-color-theme="blue"] .message-sent,
        html[data-theme="dark"][data-color-theme="purple"] .message-sent,
        html[data-theme="dark"][data-color-theme="green"] .message-sent,
        html[data-theme="dark"][data-color-theme="pink"] .message-sent,
        html[data-theme="dark"][data-color-theme="pastel"] .message-sent,
        html[data-theme="dark"][data-color-theme="sunset"] .message-sent,
        html[data-theme="dark"][data-color-theme="forest"] .message-sent,
        html[data-theme="dark"][data-color-theme="ocean"] .message-sent {
            color: #ffffff !important;
        }

        .message.rounded {
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message.rounded-large {
            border-radius: 24px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
        }
        .message.square {
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .message.rounded-sent {
            border-radius: var(--radius) var(--radius) 6px var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message.rounded-received {
            border-radius: var(--radius) var(--radius) var(--radius) 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message-sent { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .message-received { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
            font-family: var(--font-family);
            font-weight: 400;
            position: relative;
            font-size: var(--font-size);
            opacity: 0;
            animation: delayedShow 0.8s ease 0.2s forwards;
        }
@keyframes delayedShow {
            to {
                opacity: 1;
            }
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background-color: var(--primary-bg);
            background-image: var(--chat-bg-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
        }

        .header {
            padding: 0;
            padding-top: env(safe-area-inset-top, 0px);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            box-shadow: var(--shadow);
            z-index: 10;
            flex-shrink: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        /* ‚îÄ‚îÄ Immersive Mode ‚îÄ‚îÄ */
        body.immersive-mode .header {
            transform: translateY(-110%);
            opacity: 0;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.4s ease;
        }
        body.immersive-mode .chat-container {
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
        }
        #immersive-exit-btn {
            display: none;
            position: fixed;
            /* ÁßªËá≥Âè≥‰∏ãËßíÔºåÈÅøÂºÄÂÆâÂÖ®Âå∫ */
            bottom: calc(env(safe-area-inset-bottom, 0px) + 100px);
            right: 20px;
            left: auto;
            top: auto;
            transform: none;
            z-index: 9999;
            background: rgba(var(--accent-color-rgb), 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(var(--accent-color-rgb), 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            padding: 0;
            font-size: 16px;
            color: var(--accent-color);
            cursor: pointer;
            letter-spacing: 0;
            transition: all 0.22s ease;
            font-family: var(--font-family);
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        #immersive-exit-btn:hover {
            background: rgba(var(--accent-color-rgb), 0.32);
            transform: scale(1.1);
        }
        body.immersive-mode #immersive-exit-btn {
            display: flex;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 650px;
            margin: 0 auto;
            padding: 6px 5px 6px;
            width: 100%;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border: 2px solid transparent;
            transition: var(--transition);
            order: 2;
        }
      .header-motto {
position: relative;
top: auto;
left: auto;
transform: none;
display: flex;
align-items: center;
justify-content: center;
width: 100%;
padding: 4px 24px 6px;
margin: 0 auto;
max-width: 100%;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
font-size: 12px;
font-family: 'Inter', 'Noto Serif SC', 'Cormorant Garamond', serif, -apple-system, BlinkMacSystemFont, sans-serif;
font-weight: 350;
letter-spacing: 3px;
font-style: normal;
text-transform: uppercase;
color: var(--accent-color);
background: transparent;
border: none;
border-radius: 0;
box-shadow: none;
transition: all 0.6s cubic-bezier(0.25, 0.1, 0.15, 1);
gap: 14px;
opacity: 0.8;
mix-blend-mode: normal;
backdrop-filter: none;
-webkit-backdrop-filter: none;
text-rendering: optimizeLegibility;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
animation: mottoFadeIn 1.2s ease 0.6s both;
z-index: 1;
}
@keyframes mottoFadeIn {
    from { opacity: 0; letter-spacing: 6px; }
    to { opacity: 0.8; letter-spacing: 3px; }
}

.header-motto::before,
.header-motto::after {
content: "";
width: 28px;
height: 1px;
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.4;
transition: all 0.6s cubic-bezier(0.25, 0.1, 0.15, 1);
}

.header-motto:hover {
letter-spacing: 4.5px;
opacity: 1;
cursor: default;
transform: scale(1.01);
}

.header-motto:hover::before,
.header-motto:hover::after {
width: 48px;
opacity: 0.75;
}

html[data-theme="dark"] .header-motto {
color: var(--accent-color);
opacity: 0.88;
text-shadow: 0 0 18px rgba(var(--accent-color-rgb), 0.25);
font-weight: 300;
}

html[data-theme="dark"] .header-motto::before,
html[data-theme="dark"] .header-motto::after {
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.28;
}

html[data-theme="dark"] .header-motto:hover {
text-shadow: 0 0 32px rgba(var(--accent-color-rgb), 0.5);
}

@media (max-width: 480px) {
.header-motto {
padding: 2px 14px 4px;
font-size: 10.5px;
letter-spacing: 2.5px;
gap: 10px;
}
.header-motto::before,
.header-motto::after {
    width: 16px;
}
}
        

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 60px;
        }

        .avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        html[data-theme="dark"] .avatar:hover {
            border-color: var(--accent-color-dark);
        }
        .avatar > img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .username {
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            order: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 72px;
            visibility: visible !important;
            opacity: 1 !important;
            color: var(--text-primary);
            text-align: center;
        }
        .username:hover {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .username:hover {
            color: var(--accent-color-dark);
        }
        .status {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            order: 3;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .status:hover {
            background-color: var(--message-received-bg);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: var(--transition);
        }
        .action-btn:hover {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            transform: rotate(15deg) scale(1.1);
        }

        .main-chat-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* ‰∏∫Âõ∫ÂÆöÂÆö‰ΩçÁöÑËæìÂÖ•Ê°ÜÁïôÁ©∫Èó¥ÔºåÂåÖÂê´ÂÆâÂÖ®Âå∫È´òÂ∫¶ */
            padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: background-color 0.5s ease;
            background-color: transparent;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
            width: 0;
        }

        
        .message-wrapper {
            display: flex;
            max-width: 85%;
            margin-bottom: 12px;
            animation: messageAppear 0.4s ease-out forwards;
            opacity: 0;
            position: relative;
            gap: 10px;
            align-items: var(--avatar-align, flex-start);
        }
        .message-avatar {
            width: var(--in-chat-avatar-size);
            height: var(--in-chat-avatar-size);
            border-radius: 50%;
            flex-shrink: 0;
            background-color: var(--border-color);
            transition: all 0.3s ease;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .message-avatar.hidden {
            visibility: hidden;
        }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

@keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(0) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-wrapper.sent .message-content-wrapper {
            align-items: flex-end;
        }
        .message-wrapper.received {
            align-self: flex-start;
            flex-direction: row;
        }
        .message-wrapper.received .message-content-wrapper {
            align-items: flex-start;
        }

        .message {
            padding: 12px 18px;
            border-radius: var(--radius);
            word-wrap: break-word;
            line-height: var(--message-line-height);
            box-shadow: var(--shadow);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            position: relative;
            overflow: hidden;
            min-width: 50px;
            font-family: var(--message-font-family);
            font-weight: var(--message-font-weight);
        }

        .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
            border-bottom-right-radius: 6px;
        }
        html[data-theme="dark"] .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .message-received {
            background-color: var(--message-received-bg);
            color: var(--message-received-text, var(--text-primary));
            border-bottom-left-radius: 6px;
        }

        .message-meta {
            display: flex;
            align-items: center; 
            gap: 8px;
            margin: 6px 10px 0 10px;
            opacity: 0.7;
            font-size: 11px;
            color: var(--text-secondary);
            position: relative;
            height: 20px; 
        }
        .message-meta-actions {
            position: absolute;
            top: -12px;
            background-color: var(--secondary-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            padding: 4px 6px;
            opacity: 0;
            transform: translateY(5px);
            transition: var(--transition);
            z-index: 2;
        }
        .message-content-wrapper:hover .message-meta-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-wrapper.sent .message-meta-actions {
            left: -20px;
        }
        .message-wrapper.received .message-meta-actions {
            right: -20px;
        }

        .meta-action-btn {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none; 
            border: none;   
        }
        
        .meta-action-btn:hover {
            transform: scale(1.2);
            color: var(--text-primary);
            background-color: var(--border-color);
        }
.meta-action-btn.delete-btn:hover {
    color: #ff4757 !important; 
    background-color: rgba(255, 71, 87, 0.1);
}

        .meta-action-btn.favorited {
            color: #ffc107 !important; 
        }
        

        .timestamp {
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .read-receipt {
            font-size: 12px;
        }
        .read-receipt.read {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .read-receipt.read {
            color: var(--accent-color-dark);
        }

        .input-area-wrapper {
            flex-shrink: 0;
            background-color: var(--input-area-bg);
            transition: background-color 0.5s ease;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            /* Â∫ïÈÉ®ÂÆâÂÖ®Âå∫ÔºöËÆ©ÂÜÖÂÆπÂú®Home Bar‰∏äÊñπ */
            padding-bottom: env(safe-area-inset-bottom, 0px);
            padding-left: env(safe-area-inset-left, 0px);
            padding-right: env(safe-area-inset-right, 0px);
        }

        /* ÂÖ®Â±è/Ê≤âÊµ∏Ê®°Âºè‰∏ãÁ°Æ‰øùËæìÂÖ•Âå∫ÂüüÂßãÁªàÂèØËßÅ */
        body.immersive-mode .input-area-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        body.immersive-mode .main-chat-area {
            padding-bottom: 80px;
        }
        .input-area {
            display: flex;
            padding: 12px 15px;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            transition: border-color 0.5s ease;
        }
        .message-input {
            flex: 1;
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 12px 18px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 46px;
            transition: var(--transition);
            font-weight: 500;
            font-family: var(--font-family);
            font-size: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-input:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }
        html[data-theme="dark"] .message-input:focus {
            border-color: var(--accent-color-dark);
        }

        .input-buttons {
            display: flex;
            gap: 8px;
            position: relative;
        }
        .input-btn {
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .input-btn:hover {
            transform: scale(1.08) rotate(5deg);
            filter: brightness(1.1);
        }

        .send-btn, .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .send-btn, html[data-theme="dark"] .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .coin-btn, .batch-btn, .continue-btn, .attachment-btn, .poke-btn {
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
        }
        .attachment-btn:hover, .continue-btn:hover, .batch-btn:hover, .coin-btn:hover, .poke-btn:hover {
            color: var(--text-primary);
        }

        #reply-preview-container {
            padding: 0 15px;
        }
        .reply-preview {
            background-color: rgba(var(--primary-bg-rgb), 0.9);
            border-left: 3px solid var(--accent-color);
            padding: 6px 12px 6px 10px;
            margin-top: 6px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .reply-preview-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .reply-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .reply-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .reply-indicator {
            display: flex;
            flex-direction: column;
            border-left: 3px solid var(--accent-color);
            padding: 5px 10px 5px 9px;
            margin-bottom: 7px;
            background-color: rgba(var(--primary-bg-rgb), 0.55);
            border-radius: 0 8px 8px 0;
            cursor: default;
            overflow: hidden;
            max-width: 100%;
        }
        .reply-indicator-sender {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-color);
            opacity: 1;
            margin-bottom: 2px;
            letter-spacing: 0.3px;
        }
        .reply-indicator-text {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-style: italic;
            opacity: 0.85;
            max-width: 200px;
        }

        .message-wrapper.sent .reply-indicator {
            background-color: rgba(255, 255, 255, 0.18);
            border-left-color: rgba(255, 255, 255, 0.7);
        }
        .message-wrapper.sent .reply-indicator-sender {
            color: rgba(255, 255, 255, 0.9);
        }
        .message-wrapper.sent .reply-indicator-text {
            color: rgba(255, 255, 255, 0.75);
        }
        html[data-theme="dark"] .message-wrapper.sent .reply-indicator {
            background-color: rgba(0, 0, 0, 0.18);
            border-left-color: rgba(255,255,255,0.35);
        }
        .time-fmt-opt.active {
            border: 1.5px solid var(--accent-color) !important;
            background: rgba(var(--accent-color-rgb), 0.08);
            color: var(--accent-color);
        }
        .time-fmt-opt.active i, .time-fmt-opt.active span { color: var(--accent-color); }
        .modal-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .modal {
            z-index: 2000 !important;
        }

        .modal-content {
            z-index: 2001 !important;
        }

        .group-sender-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 2px;
            opacity: 0.85;
            padding: 0 2px;
        }

        .message-note {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
        }
        html[data-theme="dark"] .message-note {
            color: var(--text-primary);
        }

        .system-message {
            align-self: center;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 20px;
            border-radius: 0;
            margin: 12px auto;
            box-shadow: none;
            border: none;
            letter-spacing: 1.5px;
            max-width: 80%;
            text-align: center;
            animation: systemMsgPop 0.45s cubic-bezier(0.34,1.56,0.64,1) forwards;
            opacity: 0;
            transform: scale(0.88) translateY(6px);
            position: relative;
        }
        .system-message::before,
        .system-message::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 24px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(var(--accent-color-rgb),0.35));
        }
        .system-message::before { right: 100%; transform: translateX(8px); }
        .system-message::after { left: 100%; transform: translateX(-8px) scaleX(-1); }
        @keyframes systemMsgPop {
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* ‚îÄ‚îÄ‚îÄ Pill toggle row ‚îÄ‚îÄ‚îÄ */
        .setting-pill-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.18s, border-color 0.18s, box-shadow 0.18s;
            user-select: none;
        }
        .setting-pill-row:hover {
            border-color: var(--accent-color);
            box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.12);
        }
        .setting-pill-row:active { transform: scale(0.98); }
        .setting-pill-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: rgba(var(--accent-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            font-size: 13px;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .setting-pill-row.active .setting-pill-icon {
            background: rgba(var(--accent-color-rgb), 0.2);
        }
        .setting-pill-label {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .setting-pill-switch {
            width: 42px;
            height: 23px;
            border-radius: 23px;
            background: var(--border-color);
            position: relative;
            flex-shrink: 0;
            transition: background 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        .setting-pill-row.active .setting-pill-switch {
            background: var(--accent-color);
        }
        .setting-pill-knob {
            position: absolute;
            width: 17px;
            height: 17px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: left 0.25s cubic-bezier(0.4,0,0.2,1), box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .setting-pill-row.active .setting-pill-knob {
            left: 22px;
        }

        body.with-background .header,
        body.with-background .input-area-wrapper {
            background-color: rgba(var(--secondary-bg-rgb), 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        body.with-background .input-area {
            border-top-color: transparent;
        }
        body.with-background .message-received {
            background-color: rgba(var(--secondary-bg-rgb), 0.95);
        }
        body.with-background .message-input {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
        }
        body.with-background .message-input:focus {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
        }
        body.with-background .batch-preview {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.with-background .message-meta {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: modalBgFadeIn 0.3s ease;
        }
@keyframes modalBgFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalContentSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transition: background-color 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            display: flex;
            flex-direction: column;
        }
        .modal-content::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes modalContentSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.5s ease;
            flex-shrink: 0;
        }
        .modal-title i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .modal-title i {
            color: var(--accent-color-dark);
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }
        html[data-theme="dark"] .modal-input:focus, html[data-theme="dark"] .modal-textarea:focus {
            border-color: var(--accent-color-dark);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .modal-btn-primary {
            background-color: var(--accent-color-dark);
        }
        .modal-btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .modal-btn-secondary {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
        .modal-btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }

        .notif-toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--border-color); border-radius: 24px; transition: 0.3s;
        }
        .notif-toggle-slider::before {
            content: ''; position: absolute; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        #notif-permission-toggle:checked + .notif-toggle-slider {
            background: var(--accent-color);
        }
        #notif-permission-toggle:checked + .notif-toggle-slider::before {
            transform: translateX(20px);
        }

        #daily-greeting-modal {
            position: fixed; inset: 0; z-index: 9998;
            background: rgba(0,0,0,0.65); backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.35s ease;
        }
        #daily-greeting-modal.hidden { display: none; }
        .daily-greeting-card {
            background: var(--secondary-bg);
            border-radius: 24px;
            max-width: 350px; width: 92%;
            box-shadow: 0 32px 80px rgba(0,0,0,0.32), 0 0 0 1px rgba(var(--accent-color-rgb),0.18), inset 0 1px 0 rgba(255,255,255,0.08);
            position: relative;
            animation: slideUpBounce 0.5s cubic-bezier(0.34,1.56,0.64,1);
            overflow: hidden;
        }
        @keyframes slideUpBounce {
            from { opacity:0; transform: translateY(30px) scale(0.92); }
            to { opacity:1; transform: translateY(0) scale(1); }
        }
        .dg-header-band {
            background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
            padding: 22px 22px 20px;
            position: relative;
            overflow: hidden;
            border-radius: 24px 24px 0 0;
        }
        .dg-header-band::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.04) 10px, rgba(255,255,255,0.04) 20px);
        }
        .dg-header-band::after {
            content: 'ÂÖ¨Âëä';
            position: absolute; top: 10px; right: 14px;
            font-size: 9px; letter-spacing: 2.5px; opacity: 0.45;
            color: #fff; font-weight: 700; text-transform: uppercase;
        }
        .dg-header-band-shimmer {
            position: absolute; inset: 0;
            background: linear-gradient(105deg, transparent 40%, rgba(255,255,255,0.08) 50%, transparent 60%);
            animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { transform: translateX(-100%); }
            60%,100% { transform: translateX(200%); }
        }
        .dg-header-top {
            display: flex; align-items: center; gap: 14px;
            position: relative; z-index: 2;
        }
        .dg-emoji-circle {
            width: 56px; height: 56px; border-radius: 50%;
            background: rgba(255,255,255,0.22);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.38);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.25);
            animation: floatEmoji 2.8s ease-in-out infinite;
        }
        @keyframes floatEmoji {
            0%,100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }
        .dg-header-text { flex: 1; }
        .dg-festival-label {
            font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
            color: rgba(255,255,255,0.72); margin-bottom: 4px;
        }
        .dg-main-title {
            font-size: 22px; font-weight: 700; color: #fff;
            text-shadow: 0 2px 8px rgba(0,0,0,0.18);
            letter-spacing: 0.5px;
        }
        .dg-date-stamp {
            position: relative; z-index: 2;
            margin-top: 12px; font-size: 11px;
            color: rgba(255,255,255,0.6); letter-spacing: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .dg-date-stamp::before {
            content: '';
            flex: 1; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35));
            max-width: 30px;
        }
        .dg-date-stamp::after {
            content: '';
            flex: 1; height: 1px;
            background: linear-gradient(270deg, transparent, rgba(255,255,255,0.35));
            max-width: 30px;
        }
        .dg-body { padding: 18px 20px 20px; }
        .dg-section-label {
            font-size: 10px; letter-spacing: 2.5px; text-transform: uppercase;
            color: var(--accent-color); font-weight: 700;
            margin-bottom: 9px; opacity: 0.85;
            display: flex; align-items: center; gap: 6px;
        }
        .dg-section-label::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, rgba(var(--accent-color-rgb),0.3), transparent);
        }
        .dg-info-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 9px; margin-bottom: 13px;
        }
        .dg-info-cell {
            background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.04));
            border-radius: 14px; padding: 12px 14px;
            border: 1px solid rgba(var(--accent-color-rgb),0.12);
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease;
        }
        .dg-info-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.12);
        }
        .dg-info-cell-icon { font-size: 0; margin-bottom: 0; height: 28px; display: flex; align-items: center; }
        .dg-info-cell-icon svg { display: block; }
        .dg-info-cell-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; margin-top: 5px; letter-spacing: 0.3px; }
        .dg-info-cell-val { font-size: 13px; font-weight: 700; color: var(--text-primary); }
        .dg-mood-panel {
            background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.04));
            border-radius: 14px; padding: 13px 16px;
            border: 1px solid rgba(var(--accent-color-rgb),0.12);
            margin-bottom: 13px;
            display: flex; align-items: center; gap: 12px;
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease;
        }
        .dg-mood-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.1);
        }
        .dg-mood-icon-big { font-size: 32px; }
        .dg-mood-info { flex: 1; }
        .dg-mood-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .dg-mood-sub { font-size: 11px; color: var(--text-secondary); margin-top: 3px; line-height: 1.45; }
        /* ‚îÄ‚îÄ Daily note / ÊØèÊó•ÂØÑËØ≠ ‚îÄ beautifully styled ‚îÄ‚îÄ */
        .dg-note-box {
            font-size: 13px; color: var(--text-secondary); line-height: 1.75;
            padding: 14px 16px; border-radius: 14px;
            margin-bottom: 15px;
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), rgba(var(--accent-color-rgb),0.03));
            border: 1px solid rgba(var(--accent-color-rgb),0.15);
        }
        .dg-note-box::before {
            content: '\275D';
            position: absolute; top: 6px; left: 10px;
            font-size: 28px; color: var(--accent-color); opacity: 0.18;
            font-family: Georgia, serif; line-height: 1;
        }
        .dg-note-box::after {
            content: '\275E';
            position: absolute; bottom: 2px; right: 10px;
            font-size: 28px; color: var(--accent-color); opacity: 0.18;
            font-family: Georgia, serif; line-height: 1;
        }
        .dg-note-inner {
            position: relative; z-index: 1;
            text-align: center; letter-spacing: 0.3px;
        }
        .dg-note-weather-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: rgba(var(--accent-color-rgb),0.12);
            border-radius: 20px; padding: 3px 10px;
            font-size: 11px; color: var(--accent-color);
            font-weight: 600; margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .dg-footer { display: flex; gap: 8px; }
        .daily-greeting-close-btn {
            flex: 2; padding: 12px;
            background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.82));
            color: white; border: none; border-radius: 14px; font-size: 13px;
            font-weight: 600; font-family: var(--font-family);
            cursor: pointer; transition: all 0.25s ease;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.28);
        }
        .daily-greeting-close-btn:hover {
            opacity: 0.9; transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb),0.35);
        }
        .daily-greeting-close-btn:active { transform: translateY(0); }
        /* Legacy selectors kept for JS compatibility */
        /* ‚îÄ‚îÄ‚îÄ Daily Greeting Enhanced CSS ‚îÄ‚îÄ‚îÄ */
        .dg-header-band-bg {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            background-repeat: no-repeat;
            z-index: 0;
        }
        .dg-header-band-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
            z-index: 1;
            transition: opacity 0.3s;
        }
        .dg-header-band-bg.has-img + .dg-header-band-overlay {
            opacity: 0.55;
        }
        .daily-greeting-emoji { display: none; }
        .daily-greeting-festival { display: none; }
        .daily-greeting-title { display: none; }
        .daily-greeting-divider { display: none; }
        .daily-greeting-row { display: none; }
        .daily-greeting-note { display: none; }

        /* ‚îÄ‚îÄ‚îÄ Global Visual Enhancements ‚îÄ‚îÄ‚îÄ */
        /* Smoother button interactions */
        .action-btn, .input-btn, .modal-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .action-btn:active, .input-btn:active {
            transform: scale(0.92) !important;
        }
        /* Ripple-like active feedback for most interactive elements */
        .modal-btn:active { transform: scale(0.96) !important; }
        .poke-quick-item:active { transform: scale(0.97) !important; }
        .settings-item:active { transform: scale(0.98) !important; }
        .sidebar-btn:active { transform: scale(0.95) !important; }

        /* Better message bubbles */
        .message {
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .message:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
        }
        /* Refined modal */
        .modal-content {
            animation: modalSlideUp 0.32s cubic-bezier(0.34, 1.3, 0.64, 1) !important;
        }
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(24px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        /* Card hover lifts */
        .ann-item-card, .env-letter-item, .dg-info-cell, .dg-mood-panel {
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease !important;
        }
        .dg-info-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(var(--accent-color-rgb), 0.1) !important;
        }
        /* Calendar day hover */
        .calendar-day:not(.empty) {
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1) !important;
        }
        .calendar-day:not(.empty):hover {
            transform: scale(1.06) !important;
            z-index: 2;
        }
        /* Mood selector card */
        .mood-selector-card {
            border-radius: 22px !important;
            box-shadow: 0 16px 48px rgba(0,0,0,0.22) !important;
        }
        /* Input focus glow */
        .message-input:focus {
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.12) !important;
        }
        /* Settings pill hover */
        .setting-pill-row {
            border-radius: 14px !important;
        }
        /* Notification toast */
        .notification-toast {
            border-radius: 14px !important;
            backdrop-filter: blur(12px) !important;
        }

        /* ‚îÄ‚îÄ‚îÄ Important Days Layout Tweaks ‚îÄ‚îÄ‚îÄ */
        .ann-item-card {
            padding: 12px 14px 12px 16px !important;
        }
        .ann-item-name {
            font-size: 14px !important;
            letter-spacing: 0.2px;
        }
        .ann-item-days {
            font-size: 28px !important;
        }

        /* ‚îÄ‚îÄ‚îÄ Stats UI Enhancements ‚îÄ‚îÄ‚îÄ */
        .stats-card {
            border-radius: 18px !important;
            border: none !important;
            background: linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.03)) !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
            padding: 18px !important;
        }
        .overview-item {
            border-radius: 14px !important;
            background: var(--primary-bg) !important;
            border: 1px solid rgba(var(--accent-color-rgb),0.1) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
        }
        .overview-item:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 14px rgba(var(--accent-color-rgb),0.1) !important;
        }
        .overview-value {
            font-size: 24px !important;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats-toggle-btn {
            border-radius: 12px !important;
        }
        .rank-item {
            border-radius: 10px !important;
        }
        .rank-item:hover {
            background: rgba(var(--accent-color-rgb), 0.04) !important;
        }
        .stats-card-title {
            font-size: 12px !important;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        #envelope-modal .modal-content {
            padding: 0 !important;
            overflow: hidden !important;
            border-radius: 20px;
            background: transparent !important;
        }
        .env-wrapper {
            background: var(--secondary-bg);
            border-radius: 20px;
            overflow: hidden;
            display: flex; flex-direction: column;
            max-height: 88vh;
        }
        .env-header-flap {
            position: relative;
            background: var(--accent-color);
            padding: 22px 24px 42px;
            clip-path: polygon(0 0, 100% 0, 100% 60%, 50% 100%, 0 60%);
            text-align: center; color: white;
        }
        .env-header-flap::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(160deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.04) 55%, transparent 100%);
            pointer-events: none;
        }
        .env-header-flap::after {
            content: '';
            position: absolute;
            bottom: 38px; left: 0; right: 0;
            height: 1px;
            background: rgba(255,255,255,0.2);
            pointer-events: none;
        }
        .env-header-icon {
            display: block; margin: 0 auto 8px;
            opacity: 0.95;
        }
        .env-header-title {
            font-size: 15px; font-weight: 700; letter-spacing: 3px;
            text-shadow: 0 1px 6px rgba(0,0,0,0.25);
        }
        .env-header-subtitle {
            font-size: 10px; opacity: 0.7; letter-spacing: 2px; margin-top: 3px;
            text-transform: uppercase; font-style: italic;
        }
        .env-body {
            padding: 14px 18px 4px;
            flex: 1; overflow-y: auto;
            min-height: 0;
        }
        .env-tab-bar {
            display: flex; gap: 6px; margin-bottom: 14px;
        }
        .env-tab-btn {
            flex: 1; padding: 9px 6px;
            background: var(--primary-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 8px; cursor: pointer;
            font-size: 12px; font-family: var(--font-family);
            color: var(--text-secondary); position: relative;
            transition: all 0.25s; letter-spacing: 0.5px;
        }
        .env-tab-btn.active {
            background: rgba(var(--accent-color-rgb), 0.08);
            border: 1.5px solid var(--accent-color);
            color: var(--accent-color); font-weight: 600;
        }
        .env-badge {
            position: absolute; top: -6px; right: -6px;
            background: #ff4757; color: #fff; border-radius: 8px;
            font-size: 10px; padding: 1px 5px; min-width: 16px; text-align: center;
            border: 2px solid var(--secondary-bg);
        }
        .env-letter-item {
            background: var(--primary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px; cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25,0.8,0.25,1);
            position: relative; overflow: hidden;
        }
        .env-letter-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.12);
            border-color: rgba(var(--accent-color-rgb), 0.35);
        }
        .env-letter-item.env-letter-new {
            border-color: rgba(var(--accent-color-rgb), 0.4);
        }
        .env-letter-header {
            background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb), 0.7));
            padding: 8px 12px 7px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .env-letter-header-from {
            font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.95);
            letter-spacing: 0.5px;
        }
        .env-letter-header-date {
            font-size: 10px; color: rgba(255,255,255,0.75);
        }
        .env-stamp {
            width: 32px; height: 38px;
            border: 2px solid rgba(255,255,255,0.7);
            border-radius: 3px;
            background: rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            position: relative;
            box-shadow:
              0 0 0 3px rgba(255,255,255,0.12),
              2px 2px 0 3px rgba(255,255,255,0.12),
              -2px 2px 0 3px rgba(255,255,255,0.12),
              2px -2px 0 3px rgba(255,255,255,0.12),
              -2px -2px 0 3px rgba(255,255,255,0.12);
        }
        .env-letter-body {
            padding: 10px 12px 10px;
        }
        .env-letter-meta { font-size: 10px; color: var(--text-secondary); margin-bottom: 5px; display:flex; justify-content:space-between; }
        .env-letter-preview { font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 86%; font-style: italic; color: var(--text-primary); }
        .env-letter-status { font-size: 10px; color: var(--accent-color); margin-top: 5px; display: flex; align-items: center; gap: 4px; }
        .env-letter-delete-btn {
            position: absolute; bottom: 10px; right: 10px;
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 12px; opacity: 0.35;
            padding: 4px; border-radius: 4px; transition: all 0.2s;
        }
        .env-letter-delete-btn:hover { color: #ff4757; opacity: 1; }
        .env-letter-item.reply .env-letter-status::before {
            content: 'Â∑≤Âõû‰ø°';
            font-size: 9px; color: #6BCB77; border: 1px solid #6BCB77;
            border-radius: 4px; padding: 1px 5px; letter-spacing: 0.5px;
            margin-right: 4px;
        }
        .env-compose-paper {
            background: var(--primary-bg);
            border-radius: 12px;
            border: 1px solid rgba(var(--accent-color-rgb), 0.2);
            padding: 16px 16px 12px;
            margin-bottom: 10px;
            position: relative; overflow: hidden;
        }
        .env-compose-paper::before {
            content: '';
            position: absolute; left: 38px; top: 0; bottom: 0;
            width: 1px; background: rgba(220, 80, 80, 0.25);
            pointer-events: none;
        }
        .env-compose-paper::after {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                transparent,
                transparent 28px,
                rgba(var(--accent-color-rgb), 0.07) 28px,
                rgba(var(--accent-color-rgb), 0.07) 29px
            );
            pointer-events: none; border-radius: 12px;
        }
        .env-compose-heading {
            font-size: 11px; color: var(--accent-color); letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 10px; opacity: 0.8;
            position: relative; z-index: 1;
            display: flex; align-items: center; gap: 6px;
        }
        #envelope-input {
            background: transparent !important;
            border: none !important;
            outline: none !important;
            font-family: var(--font-family) !important;
            font-size: 14px !important;
            line-height: 2 !important;
            color: var(--text-primary) !important;
            width: 100%; resize: none;
            padding-left: 16px;
            min-height: 160px;
            position: relative; z-index: 1;
        }
        .env-letter-paper {
            background: var(--primary-bg);
            background-image:
                repeating-linear-gradient(
                    transparent,
                    transparent 30px,
                    rgba(var(--accent-color-rgb), 0.07) 30px,
                    rgba(var(--accent-color-rgb), 0.07) 31px
                );
            border-radius: 10px;
            padding: 16px 20px 16px 52px;
            font-size: 14px; line-height: 31px;
            white-space: pre-wrap; word-break: break-word;
            min-height: 120px; position: relative;
            border: 1px solid var(--border-color);
        }
        .env-letter-paper::before {
            content: '';
            position: absolute; left: 40px; top: 0; bottom: 0;
            width: 1px; background: rgba(220, 80, 80, 0.2);
        }
        .env-empty {
            text-align:center; padding: 36px 20px;
            color: var(--text-secondary); font-size: 13px; opacity: 0.65;
        }
        .env-empty svg { display: block; margin: 0 auto 12px; opacity: 0.4; }
        .env-send-area {
            padding: 12px 18px 16px;
        }
        .env-send-info {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; color: var(--text-secondary);
            margin-bottom: 10px; padding: 7px 10px;
            background: var(--primary-bg); border-radius: 8px;
        }
        .env-write-btn {
            width: 100%;
            padding: 13px;
            background: var(--accent-color);
            color: white;
            border: none; border-radius: 14px;
            font-size: 14px; font-weight: 600;
            font-family: var(--font-family);
            cursor: pointer; letter-spacing: 1px;
            transition: all 0.25s;
            box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.35);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .env-write-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .env-close-btn {
            width: 100%; padding: 10px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 14px; font-size: 13px;
            color: var(--text-secondary); cursor: pointer;
            font-family: var(--font-family);
            margin-top: 8px; transition: all 0.2s;
        }
        .env-close-btn:hover { background: var(--primary-bg); }
        .env-postmark {
            display: inline-flex; flex-direction: column; align-items: center;
            border: 2px solid rgba(var(--accent-color-rgb), 0.4);
            border-radius: 50%; width: 56px; height: 56px;
            justify-content: center; font-size: 8px; line-height: 1.3;
            text-align: center; color: var(--accent-color);
            opacity: 0.6; letter-spacing: 0.5px;
        }

        .file-input {
            display: none;
        }
        .typing-indicator, .empty-state {
            position: absolute;
            left: 20px;
            bottom: 20px;
            z-index: 5;
        }
        .empty-state {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
            width: 100%;
            transition: color 0.5s ease;
        }
        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }
        .empty-state p {
            font-size: 16px;
            font-weight: 500;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: var(--message-received-bg);
            padding: 12px 16px;
            border-radius: var(--radius);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
            display: none;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }
        .typing-dots {
            display: flex;
            gap: 5px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
@keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .settings-item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

#appearance-modal .settings-item-list {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
}

#appearance-modal .settings-item {
    display: flex;
    align-items: center;
    justify-content: center; 
    padding: 15px;
    width: 100%;
    margin-bottom: 0; 
    flex-direction: column; 
    gap: 8px;
    text-align: center;
}

#appearance-modal .settings-item i {
    font-size: 20px;
    width: auto;
    height: auto;
    background: none;
    margin: 0;
}

#appearance-modal .settings-item::after {
    display: none;
}

        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background-color: var(--primary-bg);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            position: relative;
        }


        .settings-item:hover {
            background-color: var(--secondary-bg);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }


        .settings-item i {
            font-size: 18px;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .settings-item:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1);
        }


        .settings-item span {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }


        .settings-item::after {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0.5;
            transition: transform 0.3s ease;
        }

        .settings-item:hover::after {
            transform: translateX(3px);
            opacity: 0.8;
            color: var(--accent-color);
        }


        #advanced-modal .settings-item-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        #advanced-modal .settings-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 10px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        #advanced-modal .settings-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            z-index: 1;
        }


        #advanced-modal .settings-item i {
            width: 56px;
            height: 56px;
            font-size: 24px;
            border-radius: 20px;
            margin-bottom: 4px;
        }


        #advanced-modal .settings-item::after {
            display: none;
        }

        #appearance-modal .settings-item-list {
            gap: 8px;
        }


        .import-export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }
        .import-export-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid transparent;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .import-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .import-export-btn.export {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            border-color: rgba(var(--accent-color-rgb), 0.2);
        }
        .import-export-btn.export:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .settings-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }

        #my-status-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font-family);
            text-align: center;
            padding: 2px 6px;
            width: 100px;
        }


:root {
            --welcome-bg: #f0f2f5;
            --welcome-text-main: #2c3e50;
            --welcome-text-sub: #7f8c8d;
            --welcome-star: #bdc3c7;
            --welcome-circle-outer: rgba(0, 0, 0, 0.1);
            --welcome-loader-bg: rgba(0, 0, 0, 0.1);
        }

        html[data-theme="dark"] {

            --welcome-bg: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            --welcome-text-main: #ffffff;
            --welcome-text-sub: var(--accent-color);
            --welcome-star: #ffffff;
            --welcome-circle-outer: rgba(255, 255, 255, 0.1);
            --welcome-loader-bg: rgba(255, 255, 255, 0.1);
        }

        .welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--welcome-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            transition: all 1s cubic-bezier(0.7, 0, 0.3, 1);
        }
        .welcome-animation.hidden {
            opacity: 0;
            transform: scale(1.08);
            filter: blur(24px);
            pointer-events: none;
        }
        .welcome-bg-gradient {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 40%, rgba(var(--accent-color-rgb), 0.18) 0%, transparent 60%),
                        radial-gradient(ellipse at 70% 60%, rgba(var(--accent-color-rgb), 0.12) 0%, transparent 55%);
            animation: bgPulse 6s ease-in-out infinite;
        }
        @keyframes bgPulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        .welcome-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .wp {
            position: absolute;
            pointer-events: none;
            animation: petalFloat var(--pDur, 10s) ease-in-out infinite var(--pDel, 0s);
            opacity: 0;
        }
        .wp.petal {
            width: var(--pSz, 8px);
            height: calc(var(--pSz, 8px) * 1.5);
            background: radial-gradient(ellipse at 40% 30%, rgba(var(--accent-color-rgb), 0.9), rgba(var(--accent-color-rgb), 0.3));
            border-radius: 50% 0 50% 0;
            filter: blur(0.3px);
        }
        .wp.sparkle {
            width: var(--pSz, 4px);
            height: var(--pSz, 4px);
            background: rgba(var(--accent-color-rgb), 0.7);
            border-radius: 50%;
            box-shadow: 0 0 calc(var(--pSz, 4px) * 2) rgba(var(--accent-color-rgb), 0.5);
        }
        @keyframes petalFloat {
            0%   { transform: translateY(105vh) translateX(0) rotate(0deg) scale(0.6); opacity: 0; }
            8%   { opacity: 0.85; transform: translateY(88vh) translateX(var(--pX1, 15px)) rotate(30deg) scale(1); }
            50%  { opacity: 0.7; transform: translateY(45vh) translateX(var(--pX2, -20px)) rotate(140deg) scale(0.9); }
            90%  { opacity: 0.3; }
            100% { transform: translateY(-8vh) translateX(var(--pX3, 10px)) rotate(280deg) scale(0.5); opacity: 0; }
        }


        .stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: var(--welcome-star);
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }

@keyframes twinkle {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        .welcome-content-wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }


        .logo-tech-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon-main {
            font-size: 52px;
            color: var(--accent-color);
            z-index: 5;
            filter: drop-shadow(0 0 20px rgba(var(--accent-color-rgb), 0.7));
            animation: floatIcon 3s ease-in-out infinite, iconGlow 2s ease-in-out infinite;
        }
        @keyframes iconGlow {
            0%, 100% { filter: drop-shadow(0 0 15px rgba(var(--accent-color-rgb), 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(var(--accent-color-rgb), 0.9)); }
        }
        .logo-circle-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1.5px solid rgba(var(--accent-color-rgb), 0.25);
            border-radius: 50%;
            animation: pulseRing 2.5s ease-in-out infinite;
        }
        .logo-circle-outer::before {
            content: '';
            position: absolute;
            inset: -12px;
            border-radius: 50%;
            border: 1px solid rgba(var(--accent-color-rgb), 0.1);
            animation: pulseRing 2.5s ease-in-out infinite 0.5s;
        }
        .logo-circle-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border: 1px dashed rgba(var(--accent-color-rgb), 0.5);
            border-radius: 50%;
            animation: rotateCircle 8s linear infinite;
        }
        .orbit-dot {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: rotateCircle 3s linear infinite;
        }
        .orbit-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 14px var(--accent-color), 0 0 4px rgba(255,255,255,0.5);
        }
        .orbit-dot-2 {
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            animation: rotateCircle 5s linear infinite reverse;
            top: 15%;
            left: 15%;
        }
        .orbit-dot-2::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(var(--accent-color-rgb), 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px var(--accent-color);
        }


        .text-tech-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 80px;
        }


        .welcome-title-glitch {
            font-family: 'Noto Serif SC', serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            position: relative;


            opacity: 1;


            transition: color 0.5s ease;
        }


        .welcome-title-glitch.playing {
            opacity: 0;
            animation: cinematicFadeIn 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }


        html[data-theme="light"] .welcome-title-glitch {
            color: #2c3e50;
            text-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }


        html[data-theme="dark"] .welcome-title-glitch,
        .welcome-title-glitch {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        }


@keyframes cinematicFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(8px);
                letter-spacing: 0px;
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                letter-spacing: 6px;
            }
        }

        .title-cinematic-enter {
            animation: cinematicIn 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

@keyframes cinematicIn {
            0% {
                opacity: 0;
                letter-spacing: 15px;
                filter: blur(12px);
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                letter-spacing: 4px;
                filter: blur(0);
                transform: scale(1);
            }
        }


        .welcome-subtitle-scramble {
            font-family: monospace;
            font-size: 12px;
            color: var(--welcome-text-sub);
            letter-spacing: 2px;
            opacity: 0.8;
            text-transform: uppercase;
            min-height: 18px;
        }


        .loader-tech {
            width: 160px;
            height: 2px;
            background: var(--welcome-loader-bg);
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }

        .loader-tech-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transition: width 0.2s linear;
        }

        .meteor {
            position: absolute;
            width: 2px;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(var(--accent-color-rgb),0.9) 40%, rgba(255,255,255,0.6) 70%, rgba(255,255,255,0) 100%);
            border-radius: 2px;
            animation: meteorFall var(--mDur,1.5s) ease-in var(--mDel,0s) forwards;
            transform-origin: top center;
            will-change: transform, opacity;
        }
        @keyframes meteorFall {
            0% { opacity:0; transform: rotate(var(--mRot,35deg)) translateY(-100px); }
            10% { opacity:1; }
            80% { opacity:0.7; }
            100% { opacity:0; transform: rotate(var(--mRot,35deg)) translateY(600px); }
        }
        .orbit-dot-3 {
            position: absolute;
            width: 130%;
            height: 130%;
            border-radius: 50%;
            animation: rotateCircle 7s linear infinite 1s;
            top: -15%; left: -15%;
            opacity: 0.5;
        }
        .orbit-dot-3::after {
            content: '';
            position: absolute;
            top: 50%; left: 100%;
            width: 4px; height: 4px;
            background: rgba(var(--accent-color-rgb), 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 6px var(--accent-color);
        }

        .logo-tech-container {
            animation: logoAppear 1.2s cubic-bezier(0.22,1,0.36,1) forwards;
        }
        @keyframes logoAppear {
            0% { opacity:0; transform:scale(0.6) translateY(20px); filter:blur(12px); }
            100% { opacity:1; transform:scale(1) translateY(0); filter:blur(0); }
        }

        @keyframes barPulse {
            0%,100% { box-shadow: 0 0 10px var(--accent-color); }
            50% { box-shadow: 0 0 25px var(--accent-color), 0 0 5px rgba(255,255,255,0.4); }
        }
        .loader-tech-bar.pulsing {
            animation: barPulse 0.8s ease-in-out infinite;
        }

@keyframes floatIcon {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

@keyframes rotateCircle {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

@keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
                border-color: rgba(var(--accent-color-rgb), 0.5);
            }
            100% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
        }

@keyframes breath {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.2;
            }
        }
@keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
@keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
        }
@keyframes blink-caret {
            from, to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent-color);
            }
        }

        .batch-preview {
            position: absolute;
            bottom: 85px;
            left: 15px;
            right: 15px;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            z-index: 5;
            transition: all 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            animation: batchPreviewSlideUp 0.3s ease;
        }
        .batch-preview::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes batchPreviewSlideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .batch-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            font-size: 14px;
            transition: background-color 0.5s ease, opacity 0.3s ease;
            user-select: none;
            animation: batchItemAppear 0.2s ease;
        }
@keyframes batchItemAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .batch-preview-text {
            flex-grow: 1;
            cursor: text;
            margin-right: 10px;
        }
        .batch-preview-input {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            border-bottom: 1px solid var(--accent-color);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }
        .batch-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .batch-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }
        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .batch-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .batch-send-btn {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .batch-send-btn {
            background-color: var(--accent-color-dark);
        }
        .batch-cancel-btn {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
.appearance-group {
    display: flex;
    gap: 15px;
    align-items: stretch; 
    margin-bottom: 20px;
}

.theme-editor-entry-btn {
    flex: 1;
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    border-radius: 16px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--message-sent-text);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
    border: none;
    text-align: center;
}

.theme-editor-entry-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(var(--accent-color-rgb), 0.4);
}

.theme-editor-entry-btn i {
    font-size: 24px;
    margin-bottom: 8px;
}

.theme-editor-entry-btn span {
    font-size: 13px;
    font-weight: 600;
}

.preset-colors-container {
    flex: 2;
    background-color: var(--primary-bg);
    border-radius: 16px;
    padding: 15px;
    border: 1px solid var(--border-color);
}

.preset-colors-title {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}

        .theme-picker {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(28px, 1fr)); 
    gap: 8px;
    margin-bottom: 0; 
}


@media (max-width: 480px) {
    .appearance-group {
        flex-direction: column; 
    }
    .theme-editor-entry-btn {
        flex-direction: row;
        gap: 10px;
        padding: 12px;
    }
    .theme-editor-entry-btn i {
        font-size: 18px;
        margin-bottom: 0;
    }
}
        .theme-picker-label {
            font-weight: 500;
            font-size: 14px;
        }
        .theme-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .theme-color-btn:hover {
            transform: scale(1.1);
        }
        .theme-color-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }
        #theme-gold {
            background-color: #c5a47e;
        }
        #theme-blue {
            background-color: #7FA6CD;
        }
        #theme-purple {
            background-color: #BB9EC7;
        }
        #theme-green {
            background-color: #7BC8A4;
        }
        #theme-pink {
            background-color: #F4A6B3;
        }
        #theme-black-white {
            background: linear-gradient(135deg, #000000 50%, #ffffff 50%);
        }
        #theme-pastel {
            background: linear-gradient(135deg, #A8D8EA, #AA96DA);
        }
        #theme-sunset {
            background: linear-gradient(135deg, #FF9A8B, #FF6B6B);
        }
        #theme-forest {
            background: linear-gradient(135deg, #7BA05B, #556B2F);
        }
        #theme-ocean {
            background: linear-gradient(135deg, #4A90E2, #2E5B9A);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .font-size-label {
            font-weight: 500;
            font-size: 14px;
        }
        .font-size-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--message-received-bg);
            outline: none;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .font-size-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .font-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }
        .font-size-value {
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        html[data-theme="dark"] .settings-section-title {
            color: var(--accent-color-dark);
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10001 !important;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: notificationSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid var(--accent-color);
        }
@keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .notification.hiding {
            animation: notificationSlideOut 0.4s ease-in forwards;
        }
@keyframes notificationSlideOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
        .notification i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .notification i {
            color: var(--accent-color-dark);
        }

        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .import-export-btn {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-family);
        }
        .import-export-btn:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        .import-export-btn.export {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .import-export-btn.export {
            background-color: var(--accent-color-dark);
        }

        .date-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }
        .date-divider::before, .date-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--border-color);
        }
        .date-divider span {
            padding: 0 12px;
        }


        .coin-toss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .coin-toss-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .coin-container {
            perspective: 1200px;
            margin-bottom: 40px;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.2));
        }

        .coin {
            width: 180px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            border-radius: 50%;
        }

        .coin.flipping-heads {
            animation: flip-coin-heads 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .coin.flipping-tails {
            animation: flip-coin-tails 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Serif SC', serif;
            border: 8px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .coin-front {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: #333;
            transform: rotateY(0deg);
        }
        .coin-front::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #bdc3c7;
            border-radius: 50%;
        }

        .coin-back {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: #fdfbfb;
            transform: rotateY(180deg);
        }
        .coin-back::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #7f8c8d;
            border-radius: 50%;
        }

        .coin-text-main {
            font-size: 48px;
            font-weight: 400;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }
        .coin-text-sub {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            font-family: sans-serif;
        }


        .coin-result-container {
            min-height: 60px;
            display: flex;
            justify-content: center;
        }

        .coin-result-text {
            font-family: 'Noto Serif SC', serif;
            font-size: 15px;
            color: #fff;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 3px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin-top: 20px;
            text-align: center;
        }


        .coin-toss-overlay.finished .coin-result-text {
            font-size: 28px;
            opacity: 1;
            font-weight: 500;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }


        .coin-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;

            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;


            transition: opacity 0.3s ease, transform 0.3s ease;
        }


        .coin-toss-overlay.finished .coin-confirm-buttons {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;

            transition-delay: 0.3s;
        }

        .coin-btn-action {
            padding: 10px 24px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            backdrop-filter: blur(5px);
        }
        .coin-btn-action:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            transform: translateY(-2px);
        }

        .coin-btn-primary {
            background: #fff;
            color: #000;
            border-color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .coin-btn-primary:hover {
            background: #f0f0f0;
            box-shadow: 0 6px 20px rgba(255,255,255,0.3);
            transform: translateY(-2px) scale(1.02);
        }

@keyframes flip-coin-heads {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2160deg) scale(1);
            }
        }

@keyframes flip-coin-tails {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2340deg) scale(1);
            }
        }

        .settings-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .settings-footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .settings-footer a:hover {
            text-decoration: underline;
        }

        #session-modal .modal-content {
            max-width: 500px;
        }
        .session-list {
            flex: 1;
            overflow-y: auto;
            margin: 0 -10px;
            padding: 0 10px;
            max-height: 50vh;
        }
        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .session-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }
        .session-item.active {
            border-color: var(--accent-color);
            background-color: rgba(var(--accent-color-rgb), 0.1);
            font-weight: 600;
        }
        .session-info {
            cursor: pointer;
            flex-grow: 1;
        }
        .session-name {
            font-size: 15px;
        }
        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }
        .session-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .session-action-btn:hover {
            color: var(--text-primary);
            background-color: var(--border-color);
            transform: scale(1.1);
        }
        .session-action-btn.delete:hover {
            color: #e53935;
        }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }

        .pagination-btn {
            background-color: var(--message-received-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }


        .fortune-card.tarot-style {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }


        .fortune-card.tarot-style::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            pointer-events: none;
        }


        .tarot-header {
            padding: 20px 0 10px;
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }


        .tarot-visual {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            position: relative;
        }


        .tarot-icon-vector {
            font-size: 64px;
            color: var(--text-primary);
            opacity: 0.8;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }


        .tarot-visual.reversed .tarot-icon-vector {
            transform: rotate(180deg);
            opacity: 0.6;
        }


        .tarot-card-name {
            font-family: var(--font-family);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }


        .tarot-position-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .tarot-position-badge.reversed {
            color: #e57373;
            background-color: rgba(229, 115, 115, 0.1);
            border-color: rgba(229, 115, 115, 0.2);
        }


        .tarot-details {
            padding: 0 30px 30px;
            position: relative;
            z-index: 2;
        }

        .tarot-divider {
            height: 1px;
            width: 40px;
            background-color: var(--accent-color);
            margin: 0 auto 15px;
        }

        .tarot-keyword {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .fortune-desc {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            font-style: italic;
        }

        .fortune-tip {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }


        .fortune-card {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
@keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .batch-favorite-mode .message-wrapper {
            cursor: pointer;
        }

        .batch-favorite-mode .message-wrapper:hover .message {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .batch-favorite-mode .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px var(--favorite-color);
        }


        
        .fav-card {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .fav-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
        .fav-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .fav-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fav-sender-name {
            font-weight: 600;
            color: var(--accent-color);
        }
        .fav-bubble {
            background-color: var(--secondary-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border-top-left-radius: 2px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.03);
            word-break: break-all;
        }
        .fav-bubble img {
            max-width: 100%;
            border-radius: 6px;
            display: block;
            margin-top: 5px;
        }
        .fav-action-btn {
            align-self: flex-end;
            font-size: 11px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 4px;
            opacity: 0.6;
            transition: 0.2s;
        }
        .fav-action-btn:hover {
            color: #e53935;
            opacity: 1;
            text-decoration: underline;
        }

        .no-favorites {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .no-favorites i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--border-color);
        }


        .batch-favorite-checkbox {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            background-color: var(--secondary-bg);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }
        .batch-favorite-checkbox.checked {
            background-color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
        }
        .batch-favorite-checkbox.checked::after {
            content: "‚úì";
            font-weight: 900;
            color: #fff;
            font-size: 12px;
        }

        .batch-favorite-mode .message-wrapper {
            transform: translateX(30px);
            transition: transform 0.3s ease;
        }

        .batch-favorite-mode .message-wrapper .batch-favorite-checkbox {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px #ffc107, 0 4px 12px rgba(255, 193, 7, 0.2);
            transform: scale(1.02);
        }

        .batch-favorite-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(128,128,128,0.2);
            border-radius: 50px;
            padding: 8px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 2002;
            animation: floatUpAction 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
@keyframes floatUpAction {
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        .batch-action-btn-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-family);
        }
        .batch-btn-confirm {
            background-color: #ffc107;
            color: #fff;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
        }
        .batch-btn-confirm:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .batch-btn-cancel {
            background-color: transparent;
            color: var(--text-primary);
        }
        .batch-btn-cancel:hover {
            background-color: var(--border-color);
        }



        #custom-replies-modal .modal-content {
            background-color: var(--primary-bg);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            padding: 0;
            height: 90vh; 
            max-height: 90vh; 
        }


        #custom-replies-modal .modal-title {
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            font-size: 18px;
            border-bottom: none;
            flex-shrink: 0; 
        }


        .reply-tabs {
            display: flex;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
        }

        .reply-tab-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 20px;

            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .reply-tab-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .reply-tab-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
            transform: translateY(-1px);
        }


        .reply-toolbar {
            padding: 15px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--primary-bg);
            flex-shrink: 0; 
        }

        .reply-search {
            flex: 1;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .reply-search:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.15);
            transform: translateY(-1px);
        }

        .reply-tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .reply-tool-btn:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.2);
        }

        .custom-replies-list {
            padding: 10px 20px;
            gap: 12px;
            background-color: var(--primary-bg);
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .reply-list-with-buttons {
            padding-bottom: 90px !important; 
        }

        .custom-reply-item {
            background-color: var(--secondary-bg);
            border-radius: 16px;

            padding: 16px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .custom-reply-item:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
.custom-reply-text {
    flex: 1;
    white-space: normal; 
    word-break: break-all; 
    line-height: 1.4;
    padding-right: 10px;
    font-size: 14px;
}


        .custom-reply-item.disabled {
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border-style: dashed;
            opacity: 0.7;
        }
        .custom-reply-item.disabled .custom-reply-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }


        .custom-reply-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .reply-action-mini {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background-color: var(--primary-bg);

            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }


        .reply-action-mini.edit-reply:hover,
        .reply-action-mini.modify-default:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: rotate(10deg);
        }


        .reply-action-mini.delete-reply:hover {
            background-color: #ff4757;
            color: white;
            transform: rotate(-10deg);
        }


        .reply-action-mini.toggle-default:hover {
            background-color: var(--text-secondary);
            color: var(--secondary-bg);
        }

        #custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background-color: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    z-index: 100;
    margin-top: 0;
    flex-shrink: 0;
}

        #add-custom-reply {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            color: var(--message-sent-text);
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #add-custom-reply:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4);
        }


        html[data-theme="dark"] .custom-reply-item {
            background-color: rgba(255,255,255,0.03);
        }
        html[data-theme="dark"] .reply-action-mini {
            background-color: rgba(255,255,255,0.08);
        }


        .stats-dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px 0;
        }


        .stats-card {
            background-color: var(--primary-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }


        .stats-overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background-color: var(--secondary-bg);
            border-radius: 12px;
            text-align: center;
            border: 1px solid transparent;
        }

        .overview-item:hover {
            border-color: var(--border-color);
            background-color: var(--primary-bg);
        }

        .overview-value {
            font-family: 'Georgia', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }

        .overview-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }


        .stats-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stats-toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 20px;
            background: var(--secondary-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: var(--font-family);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .stats-toggle-btn.active {
            background: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
        }
        .stats-toggle-btn:not(.active):hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .rank-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            min-height: 44px;
        }


        .rank-progress-bg {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(var(--accent-color-rgb), 0.12);
            z-index: 0;
            border-radius: 8px;
            transition: width 0.6s ease;
        }


        .rank-info {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }

        .rank-number {
            width: 24px;
            font-weight: 800;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.5;
            flex-shrink: 0;
            text-align: center;
            font-size: 14px;
        }

        .rank-item:nth-child(1) .rank-number {
            color: #FFD700;
            opacity: 1;
            text-shadow: 0 1px 0 rgba(0,0,0,0.1);
            font-size: 16px;
        }
        .rank-item:nth-child(2) .rank-number {
            color: #9EA1A3;
            opacity: 1;
            font-size: 15px;
        }
        .rank-item:nth-child(3) .rank-number {
            color: #CD7F32;
            opacity: 1;
            font-size: 15px;
        }


        .rank-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            white-space: normal;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .rank-count {
            flex-shrink: 0;
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 700;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            min-width: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .rank-count small {
            font-size: 9px;
            opacity: 0.7;
            font-weight: normal;
            margin-top: 2px;
        }

        .stats-empty-state {
            text-align: center;
            padding: 30px 10px;
            color: var(--text-secondary);
        }

        #stats-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            padding: 20px;
            overflow: hidden;
        }

        #stats-modal .modal-title {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        #stats-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
            margin-bottom: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #stats-content::-webkit-scrollbar {
            display: none;
        }

        #stats-modal .modal-buttons {
            flex-shrink: 0;
            margin-top: 0;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }
        
        

#anniversary-modal .modal-content {
    padding: 0;
    background-color: var(--primary-bg);
    display: flex;
    flex-direction: column;
    height: 82vh; 
    max-height: 82vh;
    overflow: hidden;
    position: relative;
}

.ann-header-card {
    background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark, var(--accent-color)) 60%, rgba(var(--accent-color-rgb),0.7) 100%);
    color: #fff;
    padding: 0;
    text-align: center;
    flex-shrink: 0;
    box-shadow: 0 6px 24px rgba(var(--accent-color-rgb), 0.35);
    z-index: 5;
    position: relative;
    overflow: hidden;
    min-height: 180px;
    display: flex;
    align-items: stretch;
}

.ann-header-card-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 0.4s;
}

.ann-header-card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.5) 100%);
    pointer-events: none;
}

.ann-header-card-inner {
    position: relative;
    z-index: 2;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 20px 18px;
    gap: 2px;
}

.ann-header-upload-btn {
    position: static;
    z-index: 5;
    background: rgba(255,255,255,0.22);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 11px;
    color: #fff;
    cursor: pointer;
    backdrop-filter: blur(6px);
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: background 0.2s;
}
.ann-header-upload-btn:hover { background: rgba(255,255,255,0.35); }

#ann-card-toolbar {
    display: none;
    padding: 8px 14px 4px;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 2px;
}

.ann-header-card::before {
    content: '‚ù§Ô∏é';
    position: absolute;
    font-size: 80px;
    right: -10px;
    top: -10px;
    opacity: 0.08;
    pointer-events: none;
    line-height: 1;
    z-index: 1;
}

.ann-header-icon {
    font-size: 22px;
    margin-bottom: 4px;
    display: block;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
}

.ann-header-label {
    font-size: 10px;
    letter-spacing: 3px;
    opacity: 0.75;
    text-transform: uppercase;
    margin-bottom: 4px;
    display: block;
}

.ann-header-title {
    font-size: 15px;
    font-weight: 600;
    opacity: 0.95;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.ann-header-days {
    font-size: 68px;
    font-weight: 800;
    font-family: 'Georgia', serif;
    margin: 2px 0;
    line-height: 1;
    text-shadow: 0 3px 12px rgba(0,0,0,0.15);
    letter-spacing: -2px;
}

.ann-header-days-unit {
    font-size: 16px;
    font-weight: 500;
    opacity: 0.8;
    margin-left: 4px;
    letter-spacing: 0;
    vertical-align: baseline;
}

.ann-header-date {
    font-size: 12px;
    background: rgba(255,255,255,0.22);
    padding: 4px 14px;
    border-radius: 20px;
    display: inline-block;
    backdrop-filter: blur(5px);
    margin-top: 6px;
    letter-spacing: 0.5px;
}

.ann-header-milestones {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
}

.ann-milestone-chip {
    background: rgba(255,255,255,0.22);
    border: 1px solid rgba(255,255,255,0.35);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 11px;
    backdrop-filter: blur(4px);
    white-space: nowrap;
}

.ann-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ann-item-card {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.ann-item-card.ann-item-active {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.18);
}

.ann-item-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    border-radius: 4px 0 0 4px;
}

.ann-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.ann-item-card.type-past {
    background: linear-gradient(135deg, rgba(255,154,158,0.06) 0%, var(--secondary-bg) 60%);
}
.ann-item-card.type-past::before { background: linear-gradient(180deg, #ff9a9e, #fecfef); }

.ann-item-card.type-future {
    background: linear-gradient(135deg, rgba(118,75,162,0.07) 0%, var(--secondary-bg) 60%);
}
.ann-item-card.type-future::before { background: linear-gradient(180deg, #764ba2, #a78bfa); }

.ann-item-left {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
    min-width: 0;
    padding-left: 10px;
}

.ann-item-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ann-item-date {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.ann-tag {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 6px;
    font-weight: 500;
}
.ann-item-card.type-past .ann-tag {
    background: rgba(255,154,158,0.18);
    color: #d14d6e;
    border: 1px solid rgba(255,154,158,0.3);
}
.ann-item-card.type-future .ann-tag {
    background: rgba(118,75,162,0.13);
    color: #764ba2;
    border: 1px solid rgba(118,75,162,0.25);
}

html[data-theme="dark"] .ann-item-card.type-past .ann-tag { color: #ff9a9e; }
html[data-theme="dark"] .ann-item-card.type-future .ann-tag { color: #c4b5fd; }

.ann-item-right {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    flex-shrink: 0;
    margin-left: 12px;
}

.ann-item-days {
    font-size: 26px;
    font-weight: 800;
    font-family: 'Georgia', serif;
    line-height: 1;
    letter-spacing: -0.5px;
}
.ann-item-card.type-past .ann-item-days { color: #e07a8f; }
.ann-item-card.type-future .ann-item-days { color: #764ba2; }
html[data-theme="dark"] .ann-item-card.type-past .ann-item-days { color: #ffa0b0; }
html[data-theme="dark"] .ann-item-card.type-future .ann-item-days { color: #c4b5fd; }

.ann-item-days-unit {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    font-family: var(--font-family);
    letter-spacing: 0;
}

.ann-item-days-label {
    font-size: 10px;
    color: var(--text-secondary);
    opacity: 0.75;
}

.ann-delete-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: rgba(0,0,0,0.04);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 11px;
    margin-left: 8px;
    transition: all 0.2s;
    flex-shrink: 0;
    border: 1px solid transparent;
}

.ann-delete-btn:hover {
    background: #ff4757;
    color: white;
    border-color: #ff4757;
    transform: scale(1.1);
}

.ann-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    gap: 12px;
    padding: 40px 20px;
}

.ann-empty-icon {
    font-size: 52px;
    opacity: 0.3;
}

.ann-empty p {
    font-size: 14px;
    opacity: 0.6;
    text-align: center;
    line-height: 1.6;
}

.ann-footer {
    padding: 14px 16px;
    background-color: var(--secondary-bg);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    z-index: 10;
}

.ann-editor-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--secondary-bg);
    z-index: 20;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.ann-editor-slide.active {
    transform: translateY(0);
}

.ann-editor-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), transparent);
}

.ann-back-btn {
    background: none;
    border: none;
    font-size: 18px;
    margin-right: 15px;
    color: var(--accent-color);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.ann-back-btn:hover {
    background: rgba(var(--accent-color-rgb), 0.12);
}

.ann-editor-content {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

.ann-form-group {
    margin-bottom: 22px;
}

.ann-label {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ann-label i {
    color: var(--accent-color);
    font-size: 13px;
}

.ann-type-selector {
    display: flex;
    gap: 10px;
}

.ann-type-btn {
    flex: 1;
    padding: 13px 10px;
    border: 2px solid var(--border-color);
    background: var(--primary-bg);
    color: var(--text-primary);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.ann-type-btn .ann-type-hint {
    font-size: 10px;
    opacity: 0.55;
    font-weight: 400;
}

.ann-type-btn.active {
    background: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    border-color: var(--accent-color);
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.2);
}


@media (max-width: 768px) {
    .message-input, 
    .modal-input, 
    .modal-textarea,
    .reply-search,
    #my-status-input {
        font-size: 16px !important; 
    }
    .user-info {
        min-width: 45px;
    }
    .avatar {
        width: 48px;
        height: 48px;
    }
    .username {
        font-size: 12px;
        max-width: 55px;
    }
    .status {
        font-size: 10px;
    }
    .header-motto {
        font-size: 9px;
        top: 5px;
    }
    .header-actions {
        gap: 6px;
    }
    .action-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
    .chat-container {
        padding: 20px 10px;
    }
    .message-wrapper {
        max-width: 90%;
    }
    .input-area {
        padding: 10px 12px;
        gap: 8px;
    }
    .input-btn {
        width: 42px;
        height: 42px;
    }
    .message-input {
        min-height: 42px;
        padding: 10px 16px;
    }
    .modal-content {
        width: 95%;
        max-width: none;
    }
    .batch-preview {
        left: 10px;
        right: 10px;
        bottom: 75px;
    }
    .stats-content {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .header-inner {
        padding: 10px 6px;
    }
    .user-info {
        min-width: 40px;
    }
    .avatar {
        width: 40px;
        height: 40px;
    }
    .username {
        font-size: 11px;
        max-width: 45px;
    }
    .status {
        font-size: 9px;
        padding: 1px 4px;
    }
    .header-motto {
        font-size: 8px;
        top: 4px;
    }
    .header-actions {
        gap: 4px;
    }
    .action-btn {
        width: 30px;
        height: 30px;
        font-size: 14px;
    }
    .chat-container {
        padding: 15px 8px;
    }
    .input-area {
        padding: 8px 10px;
        gap: 6px;
    }
    .input-btn {
        width: 38px;
        height: 38px;
    }
    .message-input {
        min-height: 38px;
        padding: 8px 14px;
        font-size: 14px;
    }
    .batch-preview {
        left: 8px;
        right: 8px;
        bottom: 70px;
        max-height: 130px;
    }
    .empty-state i {
        font-size: 48px;
    }
    .empty-state p {
        font-size: 14px;
    }
}

/* ‚îÄ‚îÄ Tablet responsive: prevent bottom panel overflow ‚îÄ‚îÄ */
@media (min-width: 481px) and (max-width: 1024px) {
    .sticker-picker-popover {
        width: min(320px, calc(100vw - 40px));
        height: min(350px, calc(100vh - 180px));
        right: 0;
        max-height: calc(100vh - 150px);
    }
}

@media (max-width: 1024px) {
    .sticker-picker-popover {
        max-height: calc(100svh - 160px);
        height: min(350px, calc(100svh - 160px));
        /* Ensure it doesn't go off screen bottom */
        bottom: calc(100% + 6px);
    }
    /* Emoji grid scrollable within constrained height */
    .combo-content-area {
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }
}

@media (max-width: 360px) {
    .username {
        display: none;
    }
    .user-info {
        gap: 2px;
    }
    .header-inner {
        padding: 8px 5px;
    }
    .input-buttons {
        gap: 5px;
    }
    .input-btn {
        width: 36px;
        height: 36px;
    }
}

.report-card {
    background-color: rgba(255,255,255,0.5);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    animation: slideInUp 0.5s ease forwards;
    opacity: 0;
    transform: translateY(20px);
}

html[data-theme="dark"] .report-card {
    background-color: rgba(30,30,30,0.5);
    border: 1px solid rgba(255,255,255,0.05);
}

.report-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 8px;
}

.report-card .highlight-text {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-color);
    margin: 5px 0;
}

.report-card .sub-text {
    font-size: 12px;
    opacity: 0.7;
    line-height: 1.5;
}

.report-tag {
    display: inline-block;
    background: var(--message-received-bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 2px;
}

@keyframes slideInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 10px 5px;
        }

        .settings-card {
            background-color: var(--primary-bg);
            border-radius: 20px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }


        .settings-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }


        .settings-card i {
            font-size: 28px;
            color: var(--accent-color);
            width: 64px;
            height: 64px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.4s ease;
        }

        html[data-theme="dark"] .settings-card i {
            background-color: rgba(var(--accent-color-rgb), 0.2);
        }


        .settings-card:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.4);
        }

        .settings-card span {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }


        .settings-footer {
            margin-top: 25px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border: 1px dashed var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .settings-footer p {
            margin: 2px 0;
        }

@media (max-width: 480px) {
            .settings-grid {
                gap: 12px;
            }
            .settings-card {
                padding: 20px 10px;
            }
            .settings-card i {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            .settings-card span {
                font-size: 13px;
            }
        }


        .anniversary-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .anniversary-animation.active {
            opacity: 1;
            pointer-events: all;
        }

        .anniversary-animation-content {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 80%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .anniversary-animation.active .anniversary-animation-content {
            transform: scale(1);
            opacity: 1;
        }

        .anniversary-animation-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .anniversary-animation-days {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .anniversary-animation-message {
            font-size: 16px;
            opacity: 0.9;
        }


        .anniversary-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .anniversary-type-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .anniversary-type-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
        }

        .anniversary-type-btn:hover {
            transform: translateY(-2px);
        }
        .player-container {
            position: fixed;
            top: 100px;
            left: 20px;
            width: 300px;
            height: 148px;
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 1px 0 rgba(255,255,255,0.06) inset;
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            border-radius 0.4s ease,
            opacity 0.3s ease, visibility 0.3s ease;
            z-index: 990;
            overflow: hidden;
            cursor: grab;
            border: 1px solid rgba(var(--accent-color-rgb), 0.12);
            display: none;
            touch-action: none;
        }

        .player-container.visible {
            display: block;
        }

        .player-container:active {
            cursor: grabbing;
        }

        .player-container.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            border-color: rgba(var(--accent-color-rgb), 0.25);
            box-shadow: 0 4px 20px rgba(var(--accent-color-rgb), 0.2), 0 1px 0 rgba(255,255,255,0.06) inset;
        }

        .full-view {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease 0.1s;
            padding: 15px 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .player-container.collapsed .full-view {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            position: absolute;
        }

        .mini-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-container.collapsed .mini-view {
            opacity: 1;
            pointer-events: auto;
        }


        .vinyl-record {
            width: 44px;
            height: 44px;
            background-color: #1a1a1a;

            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(0,0,0,0.25);
            animation: spin 4s linear infinite;
            animation-play-state: paused;

            border: 2.5px solid rgba(var(--accent-color-rgb), 0.5);

            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: border-color 0.5s ease, box-shadow 0.3s ease;
        }


        .player-container.collapsed.playing .vinyl-record {
            animation-play-state: running;
        }
@keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }


        .vinyl-record::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-color);

            border-radius: 50%;
            position: absolute;
            z-index: 1;
            transition: background-color 0.5s ease;
        }


        .vinyl-record svg {
            width: 14px;
            height: 14px;
            fill: var(--accent-color);

            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .mini-view:hover .vinyl-record svg {
            opacity: 1;
        }


        .vinyl-record.has-cover::after {
            display: none !important;
            width: 0;
            height: 0;
            opacity: 0;
        }


        .vinyl-record.has-cover svg {
            display: none !important;
        }


        #upload-cover-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .minimize-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 10;
            color: var(--text-secondary);
        }
        .minimize-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        .minimize-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .track-info {
            text-align: center;
            margin-top: 5px;
        }
        .track-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.2px;
        }
        .track-sub {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.7;
            letter-spacing: 0.3px;
        }


        .progress-wrapper {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
            position: relative;
        }
        .progress-wrapper::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: -6px;
            left: 0;
            right: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);

            border-radius: 2px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -3px;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .progress-wrapper:hover .progress-bar::after {
            opacity: 1;
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn:hover {
            background: var(--message-received-bg);
            color: var(--text-primary);
        }
        .btn-main {
            width: 44px;
            height: 44px;
            background: var(--accent-color);

            color: var(--message-sent-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        html[data-theme="dark"] .btn-main {
            background: var(--accent-color-dark);
        }
        .btn-main:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
            color: var(--message-sent-text);
        }
        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }


        .playlist-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 320px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 980;
    display: flex;
    flex-direction: column;
    height: 400px;
    max-height: 60vh;
    overflow: hidden;
    padding: 0;
}

.playlist-popup.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.playlist-header {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(var(--secondary-bg-rgb), 0.98);
    z-index: 5;
}

.pl-header-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-family);
    letter-spacing: 1px;
}

.pl-header-actions {
    display: flex;
    gap: 8px;
}

.pl-icon-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
}

.pl-icon-btn:hover, .pl-icon-btn.active {
    background-color: var(--primary-bg);
    color: var(--accent-color);
}

.playlist-search-wrapper {
    flex-shrink: 0;
    padding: 0 15px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    border-bottom: 1px solid var(--border-color);
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: all 0.3s ease;
}

.playlist-search-wrapper.active {
    height: 50px;
    opacity: 1;
    padding: 8px 15px;
}

.playlist-search-input {
    width: 100%;
    background-color: var(--primary-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 6px 10px 6px 30px;
    font-size: 12px;
    color: var(--text-primary);
    outline: none;
    transition: all 0.3s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: 12px;
    background-position: 10px center;
}

.playlist-search-input:focus {
    background-color: var(--secondary-bg);
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.1);
}

.playlist-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 10px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.playlist-content::-webkit-scrollbar {
    display: none;
}

.playlist-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
    gap: 10px;
}

.playlist-item:hover {
    background-color: var(--primary-bg);
}

.playlist-item.playing {
    background-color: rgba(var(--accent-color-rgb), 0.08);
}

.song-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.song-title-row {
    font-size: 13px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    font-weight: 500;
}

.song-title-row .highlight {
    color: var(--accent-color);
    font-weight: bold;
}

.playlist-item.playing .song-title-row {
    color: var(--accent-color);
    font-weight: 700;
}

.song-sub-row {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.action-icon-btn.delete {
    font-size: 16px;
    color: var(--text-secondary);
    opacity: 0;
    transition: all 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 100%;
}

.playlist-item:hover .action-icon-btn.delete {
    opacity: 0.6;
}

.action-icon-btn.delete:hover {
    opacity: 1 !important;
    color: #ff4757;
    transform: scale(1.1);
}

.custom-tag {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background-color: var(--accent-color);
    opacity: 0.6;
    box-shadow: 0 0 0 1px rgba(var(--accent-color-rgb), 0.3);
}

.empty-search-result {
    text-align: center;
    padding: 30px 10px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.8;
}

        .pagination {
            display: none !important;
        }


        .chat-container {
            padding-top: 20px;
        }


        .history-loader {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;

        }


        .history-loader.visible {
            opacity: 1;
        }


        .history-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--accent-color-rgb), 0.2);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: history-spin 0.8s linear infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

@keyframes history-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .input-btn:active,
        .action-btn:active,
        .modal-btn:active,
        .batch-action-btn:active,
        .reply-action-mini:active,
        .settings-item:active,
        .session-item:active,
        .coin-btn-action:active,
        .import-export-btn:active {
            transform: scale(0.92) !important;

            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);

        }


        .ripple-effect {
            position: relative;
            overflow: hidden;

            transform: translate3d(0, 0, 0);

        }


        .ripple-wave {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;

            background: rgba(255, 255, 255, 0.4);

            z-index: 99;
        }


        .modal-btn-primary .ripple-wave,
        .send-btn .ripple-wave,
        .batch-send-btn .ripple-wave,
        .theme-color-btn .ripple-wave {
            background: rgba(255, 255, 255, 0.6);
        }


        .modal-btn-secondary .ripple-wave,
        .input-btn:not(.send-btn) .ripple-wave,
        .settings-item .ripple-wave {
            background: rgba(0, 0, 0, 0.1);

        }


@keyframes ripple-anim {
            to {
                transform: scale(4);

                opacity: 0;

            }
        }


        .send-btn:hover {
            box-shadow: 0 6px 15px rgba(var(--accent-color-rgb), 0.4);
            transform: translateY(-2px) scale(1.05);
        }


        .input-btn:not(.send-btn):hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }


        .settings-item {
            transition: all 0.2s ease;
        }
        .settings-item:hover {
            background-color: var(--secondary-bg);
            border-color: rgba(var(--accent-color-rgb), 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(5px) scale(1.01);

        }


        .modal-btn-secondary:hover {
            background-color: #f5f5f5;
            color: #333;
            border-color: #ddd;
        }
        html[data-theme="dark"] .modal-btn-secondary:hover {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }

        .bg-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 15px;
            padding: 15px 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .bg-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; 
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
        }

        .bg-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .bg-item img, .bg-item div.bg-color-block {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .bg-item.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        .bg-item.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: var(--accent-color);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

@keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .bg-add-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            border-radius: 50%; 
            border: 2px dashed var(--border-color);
            gap: 8px;
        }
        
        .bg-add-btn i {
            font-size: 24px;
            opacity: 0.7;
        }
        
        .bg-add-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .bg-add-btn:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .bg-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
            z-index: 5;
        }
        .bg-item:hover .bg-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .bg-delete-btn:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
.tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: none; 
}
.tour-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.tour-highlight-box {
    position: absolute;
    border-radius: 8px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 15px rgba(255, 255, 255, 0.5);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    z-index: 10001;
}

.tour-popover {
    position: absolute;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 16px 20px;
    width: 300px;
    max-width: 90vw;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 10002;
    opacity: 0;
    transform: translateY(15px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-color);
}
.tour-popover.visible {
    opacity: 1;
    transform: translateY(0);
}
.tour-popover-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.tour-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-color);
}
html[data-theme="dark"] .tour-title {
    color: var(--accent-color-dark);
}
.tour-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
    background-color: var(--primary-bg);
    padding: 2px 8px;
    border-radius: 10px;
}
.tour-popover-content {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 16px;
}
.tour-popover-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tour-navigation {
    display: flex;
    gap: 8px;
}
.tour-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tour-btn:hover {
    transform: translateY(-1px);
}
.tour-btn:active {
    transform: scale(0.95) !important;
}
.tour-btn-skip {
    background-color: transparent;
    color: var(--text-secondary);
}
.tour-btn-skip:hover {
    background-color: var(--message-received-bg);
}
.tour-btn-primary {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}
html[data-theme="dark"] .tour-btn-primary {
    background-color: var(--accent-color-dark);
}
.tour-btn-primary:hover {
    filter: brightness(1.1);
}

        #custom-replies-modal .modal-content {
    display: flex !important;
    flex-direction: row !important; 
    height: 85vh !important;       
    max-height: 85vh !important;
    overflow: hidden !important;   
    padding: 0 !important;
    background-color: var(--secondary-bg);
}

        #custom-replies-modal .modal-title {
            flex-shrink: 0;
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            border-bottom: none;
        }

        #custom-replies-modal .reply-tabs {
            flex-shrink: 0;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        #custom-replies-modal .reply-toolbar {
            flex-shrink: 0;
            padding: 15px 20px;
            background-color: var(--primary-bg);
            display: flex;
            gap: 12px;
            align-items: center;
        }
#custom-replies-modal .modal-content {
    flex-direction: column !important; 
    overflow: hidden;
    background-color: var(--secondary-bg);
}

.modal-sidebar {
    width: 100%;
    height: auto;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-direction: row;
    padding: 10px 20px;
    gap: 10px;
    flex-shrink: 0;
    justify-content: center;
}

.sidebar-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 500;
    min-width: 120px;
    justify-content: center;
}

.sidebar-btn i {
    font-size: 18px;
}

.sidebar-btn.active {
    background-color: var(--secondary-bg);
    color: var(--accent-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.modal-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: 100%;
    position: relative;
    overflow: hidden; 
}

.modal-main-view .reply-tabs {
    padding: 15px 20px 10px;
    background-color: var(--secondary-bg);
    white-space: nowrap;
    overflow-x: auto;
    flex-shrink: 0;
}

.modal-main-view .reply-toolbar {
    padding: 10px 20px;
    background-color: var(--secondary-bg);
    border-bottom: 1px solid var(--border-color);
}

.content-list-area {
    flex: 1;
    overflow-y: auto !important; 
    overflow-x: hidden;
    padding: 15px;
    padding-bottom: 80px !important; 
    background-color: var(--primary-bg);
    height: 0; 
    -webkit-overflow-scrolling: touch; 
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)) !important; 
    gap: 12px !important;
    align-content: start; 
}

.content-list-area.list-mode .custom-reply-item {
    margin-bottom: 10px; 
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    height: auto; 
    min-height: 50px;
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    align-content: start;
}

.modal-main-view .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
}

.sticker-item {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; 
    border-radius: 12px;
    border: 2px solid var(--border-color);
    overflow: hidden;
    background-color: var(--secondary-bg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    display: block;
}

.sticker-item:hover {
    border-color: var(--accent-color);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.sticker-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0; 
    transform: scale(0.8);
    transition: all 0.2s ease;
    z-index: 2;
}

.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
    transform: scale(1);
}

.sticker-delete-btn:hover {
    background: #ff4757;
    transform: scale(1.1);
}

        #custom-replies-modal .modal-buttons {
            position: static; 
            flex-shrink: 0; 
            width: 100%;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 0;
            z-index: 10;
        }
#custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 10;
    flex-shrink: 0;
}

.sticker-delete-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 22px;
    height: 22px;
    background: rgba(0,0,0,0.6);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    opacity: 0;
    transition: opacity 0.2s;
}

.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
}

.sticker-delete-btn:hover {
    background: #ff4757;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 10px;
    padding: 15px;
}

.emoji-item {
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    aspect-ratio: 1 / 1;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.emoji-item:hover {
    background-color: var(--border-color);
    transform: scale(1.1);
}

.emoji-item.disabled {
    opacity: 0.4;
    background-color: var(--primary-bg);
    filter: grayscale(100%);
}

.emoji-item.disabled::after {
    content: '\f05e'; 
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    font-size: 14px;
    color: #ff4757;
}

#theme-editor-modal .modal-content {
    max-width: 580px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}
.theme-editor-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
    flex-wrap: wrap;
}
.theme-editor-toolbar select {
    flex-grow: 1;
    min-width: 140px;
    padding: 9px 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
}
#theme-editor-grid {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
}
.theme-editor-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    padding: 4px 2px;
}
.color-picker-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.03));
    padding: 9px 10px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    transition: border-color 0.2s, box-shadow 0.2s;
}
.color-picker-item:hover {
    border-color: rgba(var(--accent-color-rgb),0.3);
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.08);
}
.color-picker-item label {
    font-size: 12px;
    flex-grow: 1;
    color: var(--text-secondary);
}
.color-picker-item input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 36px;
    height: 36px;
    background-color: transparent;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}
.color-picker-item input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker-item input[type="color"]::-webkit-color-swatch {
    border-radius: 8px;
    border: 2px solid var(--border-color);
}
.color-picker-item input[type="color"]::-moz-color-swatch {
    border-radius: 8px;
    border: 2px solid var(--border-color);
}
.avatar-container {
    position: relative;
    width: 56px;
    height: 56px;
    order: 2;
    flex-shrink: 0;
}

/* Avatar shape presets */
.avatar-shape-circle img, .avatar-shape-circle i { border-radius: 50%; overflow: hidden; }
.avatar-shape-square img, .avatar-shape-square i { border-radius: 8px; clip-path: inset(0 round 8px); }
.avatar-shape-pentagon img, .avatar-shape-pentagon i { clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); border-radius: 0 !important; }
.avatar-shape-heart img, .avatar-shape-heart i { clip-path: path('M 50 80 C 20 60 0 45 0 30 C 0 15 12 5 25 5 C 35 5 45 12 50 20 C 55 12 65 5 75 5 C 88 5 100 15 100 30 C 100 45 80 60 50 80 Z'); border-radius: 0 !important; }

/* In-chat message avatar shapes */
.message-avatar.shape-circle img { border-radius: 50%; }
.message-avatar.shape-square img { border-radius: 4px; clip-path: inset(0 round 4px); }
.message-avatar.shape-pentagon img { clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%); border-radius: 0; }
.message-avatar.shape-heart img { clip-path: path('M 50 80 C 20 60 0 45 0 30 C 0 15 12 5 25 5 C 35 5 45 12 50 20 C 55 12 65 5 75 5 C 88 5 100 15 100 30 C 100 45 80 60 50 80 Z'); border-radius: 0; }

.avatar {
    width: 100% !important;
    height: 100% !important;
    position: relative;
    z-index: 1;
}

.avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none; 
}

.message-avatar {
    position: relative;
}

.message-avatar .avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none;
}
.message-avatar img, .message-avatar i {
    position: absolute; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: calc(var(--in-chat-avatar-size) * 0.5); 
}


.frame-settings-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    padding-top: 10px;
}
.frame-preview-wrapper {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.frame-preview {
    width: 80px;
    height: 80px;
    position: relative;
flex-shrink: 0; 
}
.frame-preview .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
overflow: hidden;
position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color); 
    display: flex;
    align-items: center;
    justify-content: center;

}
.frame-preview .preview-bg-layer {
    width: 100%;
    height: 100%;
    border-radius: 50%; 
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color);
    box-sizing: border-box; 
    -webkit-mask-image: radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    overflow: hidden; 
}
.frame-preview .preview-bg-layer img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
border-radius: 50%; 
    display: block;
    
}
.frame-preview .preview-bg-layer i {
    font-size: 32px;
    color: var(--text-secondary);
position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.frame-preview .preview-avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: var(--text-secondary);
}
.frame-preview .preview-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    pointer-events: none;
    max-width: none; 
    max-height: none;
}
.frame-controls {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.frame-slider-group {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}
.frame-slider-group label {
    width: 40px;
    flex-shrink: 0;
    color: var(--text-secondary);
}
.frame-slider-group input[type="range"] {
    flex-grow: 1;
}

@media (max-width: 768px) {
    .avatar-container {
        width: 46px;
        height: 46px;
    }
}
@media (max-width: 480px) {
    .avatar-container {
        width: 40px;
        height: 40px;
    }
}
#custom-bubble-css {
    background-color: #2b2b2b; 
    color: #f8f8f2; 
    border: 1px solid var(--border-color);
    padding: 10px;
    line-height: 1.4;
    border-radius: 8px;
    resize: vertical;
}

html[data-theme="light"] #custom-bubble-css {
    background-color: #f5f5f5;
    color: #333;
}
.content-list-area.grid-mode {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
    grid-auto-rows: max-content !important; 
    gap: 15px !important;
    align-content: start !important;
    padding-bottom: 120px !important; 
    overflow-y: auto !important;
    height: auto !important;
}

.sticker-item {
    position: relative !important;
    width: 100% !important;
    aspect-ratio: 1 / 1 !important;
    height: auto !important;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    overflow: hidden !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    margin: 0 !important; 
}

.sticker-item img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important; 
    display: block !important;
}

.emoji-grid {
    padding-bottom: 100px !important;
}
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 10px;
}
.current-month-label {
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font-family);
}
.calendar-nav-btn {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px 10px;
}
.calendar-nav-btn:hover {
    color: var(--accent-color);
}
.calendar-weekdays, .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    gap: 2px;
}
.calendar-weekdays div {
    font-size: 12px;
    color: var(--text-secondary);
    padding-bottom: 5px;
}
.calendar-day {
    min-height: 50px; 
    padding: 2px;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    align-items: center;
}

@media (max-width: 480px) {
    .calendar-weekdays div { font-size: 10px; }
    .calendar-day { 
        min-height: 45px; 
        font-size: 10px;
    }
.mood-detail-dot {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 20px !important; 
        height: 20px !important;
        border-radius: 50% !important; 
        padding: 0 !important;
        margin: 1px auto !important; 
        font-size: 12px !important;
        line-height: 1 !important;
        overflow: hidden;
    }
.mood-text-span {
        display: none;
    }
    
 .mood-kaomoji-span {
        display: block;
        transform: scale(0.9);
    }

    .mood-dots-container {
        flex-direction: row !important;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2px;
    }
.mood-detail-dot {
    width: 100%;
    border-radius: 4px;
    padding: 2px;
    font-size: 10px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    transform: scale(0.9); 
}

.mood-detail-dot.partner-mood {
    opacity: 0.9;
    border: 1px dashed rgba(255,255,255,0.5); 
}
.calendar-day:hover {
    background-color: var(--message-received-bg);
}
.calendar-day.today {
    background-color: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    font-weight: bold;
    border-color: var(--accent-color);
}
.calendar-day.empty {
    pointer-events: none;
}
.mood-dots {
    display: flex;
    gap: 2px;
    margin-top: 2px;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
}
.mood-marker {
    font-size: 10px;
    width: 16px; 
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: var(--secondary-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.mood-marker.me { color: var(--accent-color); border: 1px solid rgba(var(--accent-color-rgb), 0.3); }
.mood-marker.partner { color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }

.calendar-footer-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    font-size: 12px;
    color: var(--text-secondary);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-item .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.legend-item .dot.me { background-color: var(--accent-color); }
.legend-item .dot.partner { background-color: #ff6b6b; }

.mood-selector-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2100;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
    border-radius: var(--radius);
}
.mood-selector-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
.mood-selector-card {
    background: var(--secondary-bg);
    padding: 20px;
    border-radius: 16px;
    width: 90%;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.mood-options-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 12px;
}
.mood-options-slider-wrapper {
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    max-height: 240px;
    padding-right: 2px;
}
.mood-options-slider-wrapper::-webkit-scrollbar { display:none; }
.mood-options-slider-wrapper .mood-options-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 8px;
    width: 100%;
}

.theme-schemes-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
    max-height: 220px;
    overflow-y: auto;
    padding-right: 2px;
}
.theme-schemes-list::-webkit-scrollbar { display: none; }
.theme-scheme-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--primary-bg);
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}
.theme-scheme-item:hover {
    border-color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.06);
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(var(--accent-color-rgb), 0.15);
}
.theme-scheme-item.active-scheme {
    border-color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.1);
}
.scheme-preview-dots {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}
.scheme-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1.5px solid rgba(0,0,0,0.08);
    flex-shrink: 0;
}
.scheme-info {
    flex: 1;
    text-align: left;
    min-width: 0;
}
.scheme-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scheme-meta {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scheme-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}
.scheme-action-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s;
}
.scheme-action-btn:hover {
    background: var(--border-color);
    color: var(--text-primary);
}
.scheme-action-btn.delete:hover {
    background: rgba(255,71,87,0.1);
    color: #ff4757;
}
.theme-schemes-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 20px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.7;
}
.theme-schemes-empty i {
    font-size: 24px;
    opacity: 0.4;
}

.mood-page-btn {
    background: var(--border-color);
    border: none;
    border-radius: 50%;
    width: 30px; height: 30px;
    font-size: 18px;
    color: var(--text-primary);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
    padding: 0 0 2px 0;
    flex-shrink: 0;
}
.mood-page-btn:hover { background: var(--accent-color); color: #fff; }
.mood-page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.mood-tab-btn {
    background: var(--border-color);
    border: none;
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 12px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s;
    font-family: var(--font-family);
    font-weight: 500;
}
.mood-tab-btn.active {
    background: var(--accent-color);
    color: #fff;
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.35);
}
.mood-custom-add-btn {
    margin-top: 10px;
    width: 100%;
    background: none;
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    padding: 6px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-family);
    transition: all 0.2s;
}
.mood-custom-add-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
.custom-mood-color-dot {
    width: 22px; height: 22px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s;
}
.custom-mood-color-dot.selected { border-color: var(--text-primary); transform: scale(1.2); }
.mood-option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 4px;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    background: var(--primary-bg);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 58px;
    position: relative;
}
.mood-option-btn:hover {
    transform: translateY(-2px);
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
}
.mood-kaomoji { font-size: 20px; margin-bottom: 4px; white-space: nowrap; line-height: 1; }
.mood-label { font-size: 11px; opacity: 0.75; font-weight: 500; }

/* Custom mood edit/delete actions */
.mood-custom-actions {
    position: absolute;
    top: 2px; right: 2px;
    display: none;
    gap: 2px;
    background: rgba(var(--secondary-bg-rgb), 0.9);
    border-radius: 6px;
    padding: 2px;
}
.mood-option-custom:hover .mood-custom-actions { display: flex; }
.mood-custom-action-btn {
    border: none; background: none; cursor: pointer;
    font-size: 11px; padding: 2px 3px; border-radius: 4px;
    line-height: 1;
    transition: background 0.15s;
}
.mood-custom-action-btn:hover { background: var(--border-color); }

/* Stats page weather tag */
.stats-weather-tag {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
    text-align: center;
    cursor: pointer;
    padding: 3px 8px;
    border-radius: 20px;
    border: 1px dashed var(--border-color);
    transition: all 0.2s;
    min-width: 60px;
}
.stats-weather-tag:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.06);
}

@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
#fortune-lenormand-modal {
    z-index: 9999 !important; 
}

.tarot-container-3d {
    perspective: 1000px;
    width: 200px;
    height: 320px;
    margin: 0 auto 20px;
    cursor: pointer;
}

.tarot-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s;
    transform-style: preserve-3d;
}

.tarot-container-3d.flipped .tarot-card-inner {
    transform: rotateY(180deg);
}

.tarot-face {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.tarot-front {
    background: linear-gradient(135deg, #2c3e50, #000);
    color: #fff;
    border: 2px solid #bdc3c7;
}

.tarot-pattern {
    font-size: 40px;
    opacity: 0.3;
    animation: pulse 3s infinite;
}

.tarot-back {
    background-color: var(--secondary-bg);
    transform: rotateY(180deg);
    border: 1px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.fortune-result-area {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease 0.5s; 
    padding: 0 20px;
    text-align: center;
}

.fortune-result-area.visible {
    opacity: 1;
    transform: translateY(0);
}

.lenormand-sys-btn, .lenormand-num-btn {
    padding: 8px 18px;
    border: 1.5px solid var(--border-color);
    border-radius: 20px;
    background: var(--secondary-bg);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
}
.lenormand-sys-btn.active, .lenormand-num-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}
.lenormand-sys-btn:hover:not(.active), .lenormand-num-btn:hover:not(.active) {
    border-color: var(--accent-color);
    color: var(--accent-color);
}
.lenormand-cards-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 14px 0;
}
.lenormand-card-item {
    background: var(--secondary-bg);
    border: 1.5px solid var(--border-color);
    border-radius: 14px;
    padding: 14px 10px;
    text-align: center;
    min-width: 80px;
    max-width: 110px;
    flex: 1;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    animation: lenCardIn 0.4s ease forwards;
    opacity: 0;
    transform: translateY(12px);
}
@keyframes lenCardIn {
    to { opacity: 1; transform: translateY(0); }
}
.lenormand-card-icon {
    font-size: 28px;
    margin-bottom: 6px;
    display: block;
}
.lenormand-card-name {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
}
.lenormand-card-num {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}
.lenormand-card-keyword {
    font-size: 12px;
    color: var(--accent-color);
    font-style: italic;
}
.lenormand-card-meaning {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-top: 6px;
    text-align: left;
    border-top: 1px dashed var(--border-color);
    padding-top: 6px;
}
.lenormand-question-show {
    text-align: center;
    font-size: 14px;
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: var(--primary-bg);
    border-radius: 10px;
    border-left: 3px solid var(--accent-color);
}
.lenormand-synthesis {
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), rgba(var(--accent-color-rgb),0.02));
    border: 1px solid rgba(var(--accent-color-rgb),0.2);
    border-radius: 14px;
    padding: 14px;
    margin-top: 12px;
    font-size: 13px;
    line-height: 1.7;
}
.lenormand-synthesis-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 6px;
    letter-spacing: 1px;
}

#mood-modal .modal-content {
    background-color: var(--primary-bg);
    max-height: 90vh;
}

.mood-stats-bar {
    height: 12px !important; 
    border-radius: 6px !important;
    background: #eee !important;
    margin: 10px 0 20px 0 !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

html[data-theme="dark"] .mood-stats-bar {
    background: #333 !important;
}

#month-mood-summary {
    font-weight: bold;
    font-size: 13px;
}
.mood-stat-segment { height: 100%; transition: width 0.5s; }

.calendar-day {
    border-radius: 12px;
    background-color: var(--secondary-bg);
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    min-height: 60px; 
    justify-content: flex-start;
    padding: 4px;
    border: 1px solid transparent;
}
.calendar-day span { font-weight: 600; font-size: 12px; margin-bottom: 2px; }

.mood-detail-dot {
    width: 100%;
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 10px;
    margin-top: 2px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
}

.mood-input-wrapper {
    width: 100%;
    margin-top: 15px;
    text-align: left;
}
.mood-note-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--primary-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 13px;
    margin-top: 8px;
}

.day-detail-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: left;
    position: relative;
    border-left: 5px solid var(--accent-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.day-detail-date { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
.day-detail-content { 
    background: var(--primary-bg); 
    padding: 15px; 
    border-radius: 8px; 
    font-size: 14px; 
    line-height: 1.6;
    min-height: 60px;
    white-space: pre-wrap;
}
.user-info .avatar,
.user-info .username {
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.user-info.changing .avatar,
.user-info.changing .username {
    opacity: 0;
    transform: scale(0.9);
}
.message-sender-name {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 2px;
    margin-left: 4px;
    display: none; 
}

body.show-partner-name .message-wrapper.received .message-sender-name {
    display: block;
}

.mood-stats-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.mood-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}

.mood-circles-wrapper {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
}

.mood-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
}

.mood-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: conic-gradient(var(--accent-color) var(--percent), var(--message-received-bg) 0);
    transition: all 0.5s ease;
}

.mood-circle::before {
    content: "";
    position: absolute;
    width: 52px;
    height: 52px;
    background-color: var(--secondary-bg);
    border-radius: 50%;
}

.mood-circle-text {
    position: absolute;
    z-index: 2;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
}

.mood-circle-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

.mood-bar-container {
    height: 8px;
    width: 100%;
    background-color: var(--message-received-bg);
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    margin-top: 5px;
}

.mood-bar-segment {
    height: 100%;
    transition: width 0.6s ease;
}

.dominant-mood-tag {
    background-color: var(--primary-bg);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.mood-view-section {
    display: block;
    animation: fadeIn 0.3s ease;
}
.mood-view-section.hidden-view {
    display: none;
}

.mood-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.view-switch-btn {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
}
.view-switch-btn:hover, .view-switch-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}

.mood-stat-group {
    margin-bottom: 20px;
    background: var(--primary-bg);
    padding: 15px;
    border-radius: 12px;
}
.mood-stat-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.sticker-picker-popover {
    position: absolute;
    bottom: calc(100% + 10px);
    right: 0;
    width: 320px;
    height: 350px; 
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    z-index: 100;
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: fadeUp 0.2s ease;
}

.sticker-picker-popover.active {
    display: flex;
}

.combo-tabs-header {
    display: flex;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 12px;
    gap: 10px;
    flex-shrink: 0;
}

.combo-tab-btn {
    flex: 1;
    padding: 8px 0;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
}

.combo-tab-btn:hover {
    background-color: var(--border-color);
}

.combo-tab-btn.active {
    background-color: var(--accent-color);
    color: #fff;
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
}

.combo-content-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    background-color: var(--secondary-bg);
}

.sticker-grid-view {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px;
}

.sticker-grid-item {
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-grid-item:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
}

.sticker-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.poke-list-view {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.poke-quick-item {
    padding: 10px 14px;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.13) 0%, rgba(var(--accent-color-rgb),0.04) 50%, rgba(var(--accent-color-rgb),0.09) 100%);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    text-align: left;
    font-size: 13px;
    transition: all 0.22s cubic-bezier(0.4,0,0.2,1);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 1px 5px rgba(var(--accent-color-rgb),0.1);
}
.poke-quick-item::before {
    content: '‚ú¶';
    font-size: 10px;
    color: var(--accent-color);
    opacity: 0.5;
    flex-shrink: 0;
}

.poke-quick-item:hover {
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.22) 0%, rgba(var(--accent-color-rgb),0.08) 50%, rgba(var(--accent-color-rgb),0.16) 100%);
    transform: translateX(4px);
    color: var(--text-primary);
    box-shadow: 0 3px 10px rgba(var(--accent-color-rgb),0.18);
}

.custom-poke-btn {
    width: 100%;
    padding: 11px 14px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.8));
    color: #fff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
    transition: all 0.22s ease;
    letter-spacing: 0.3px;
}

.custom-poke-btn:hover {
    filter: brightness(1.08);
    transform: translateY(-1px);
    box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.32);
}

.empty-sticker-tip {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-size: 12px;
    line-height: 1.6;
}
.empty-sticker-tip i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    opacity: 0.5;
}
.sticker-picker-header {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--primary-bg);
}
.sticker-picker-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.picker-item {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
}
.picker-item:hover {
    background-color: var(--primary-bg);
}
.picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}
.picker-item span {
    font-size: 24px;
}

.decision-menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px 0;
}
.decision-option-card {
    background: var(--primary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
.decision-option-card:hover {
    transform: translateY(-5px);
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.2);
}
.decision-option-card i {
    font-size: 40px;
    margin-bottom: 15px;
    color: var(--accent-color);
}
.decision-option-card h3 {
    font-size: 16px;
    margin-bottom: 5px;
}
.decision-option-card p {
    font-size: 12px;
    color: var(--text-secondary);
}

.fl-modal-content {
    max-height: 90vh;
    overflow-y: auto;
    padding: 0 !important;
    border-radius: 20px !important;
}
.fl-tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: var(--secondary-bg);
    border-radius: 20px 20px 0 0;
    overflow: hidden;
    flex-shrink: 0;
}
.fl-tab {
    flex: 1;
    padding: 16px 10px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    font-family: var(--font-family);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.25s ease;
    position: relative;
}
.fl-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    width: 60%;
    height: 2px;
    background: var(--accent-color);
    border-radius: 2px 2px 0 0;
    opacity: 0;
    transform: scaleX(0);
    transition: all 0.25s ease;
}
.fl-tab.active {
    color: var(--accent-color);
    font-weight: 600;
    background: rgba(var(--accent-color-rgb), 0.04);
}
.fl-tab.active::after {
    opacity: 1;
    transform: scaleX(1);
}
.fl-panel {
    display: none;
    padding: 20px;
    min-height: 200px;
}
.fl-panel.fl-panel-active {
    display: block;
}
.leno-num-section {
    margin-bottom: 20px;
}
.leno-section-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.leno-num-btns {
    display: flex;
    gap: 12px;
}
.lenormand-num-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 10px;
    border: 1.5px solid var(--border-color);
    border-radius: 14px;
    background: var(--secondary-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    position: relative;
    overflow: hidden;
}
.leno-btn-num {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
}
.leno-btn-label {
    font-size: 11px;
    opacity: 0.6;
}
.lenormand-num-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.35);
    transform: translateY(-2px);
}
.lenormand-num-btn.active .leno-btn-label {
    opacity: 0.85;
}
.lenormand-num-btn:hover:not(.active) {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
}
.leno-num-desc {
    text-align: center;
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
    font-style: italic;
    opacity: 0.7;
    transition: all 0.2s;
}
.leno-question-section {
    margin-bottom: 18px;
}
.leno-question-input {
    width: 100%;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 13px;
    background: var(--primary-bg);
    color: var(--text-primary);
    resize: none;
    height: 70px;
    font-family: var(--font-family);
    line-height: 1.6;
    transition: border-color 0.2s;
    outline: none;
    margin-top: 10px;
}
.leno-question-input:focus {
    border-color: var(--accent-color);
}
.leno-draw-btn {
    width: 100%;
    margin-top: 4px;
    padding: 14px !important;
    font-size: 15px !important;
    border-radius: 12px !important;
    letter-spacing: 1px;
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
}

.picker-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
}
.picker-box-stage {
    position: relative;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}
.picker-cards-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    min-height: 90px;
    align-items: center;
}
.picker-card {
    width: 72px;
    height: 90px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--primary-bg) 100%);
    border: 1.5px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: default;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    text-align: center;
    padding: 6px;
    word-break: break-all;
    position: relative;
    overflow: hidden;
    animation: cardEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes cardEnter {
    from { opacity: 0; transform: translateY(12px) scale(0.88); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.picker-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.06) 0%, transparent 60%);
    border-radius: inherit;
}
.picker-card.selected {
    background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
    color: #fff;
    border-color: transparent;
    transform: translateY(-6px) scale(1.08);
    box-shadow: 0 10px 28px rgba(var(--accent-color-rgb), 0.4);
    animation: cardWin 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes cardWin {
    0% { transform: translateY(0) scale(1); }
    40% { transform: translateY(-10px) scale(1.12) rotate(-2deg); }
    70% { transform: translateY(-5px) scale(1.1) rotate(1deg); }
    100% { transform: translateY(-6px) scale(1.08) rotate(0deg); }
}
.picker-card.unselected {
    opacity: 0.4;
    transform: scale(0.94);
}
.picker-result-text {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-color);
    text-align: center;
    min-height: 28px;
    padding: 8px 16px;
    border-radius: 10px;
    background: rgba(var(--accent-color-rgb), 0.08);
    border: 1px solid rgba(var(--accent-color-rgb), 0.2);
    opacity: 0;
    transition: opacity 0.4s ease;
    width: 100%;
}
.picker-result-text.show { opacity: 1; }
.picker-controls { width: 100%; }
.picker-options-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
}
.picker-options-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    padding: 6px;
    margin-bottom: 10px;
    background: var(--primary-bg);
}
.picker-option-item {
    display: flex;
    gap: 8px;
    padding: 7px 8px;
    align-items: center;
    border-radius: 8px;
    transition: background 0.15s;
}
.picker-option-item:hover { background: var(--message-received-bg); }
.picker-option-color-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.picker-option-input {
    flex: 1;
    border: none;
    background: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 3px 4px;
    font-size: 14px;
    outline: none;
    font-family: var(--font-family);
    color: var(--text-primary);
}
.picker-option-remove {
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    transition: all 0.2s;
    font-size: 12px;
}
.picker-option-remove:hover { color: #ff4757; background: rgba(255,71,87,0.1); }
.picker-add-btn {
    width: 100%;
    margin-bottom: 10px;
    font-size: 13px;
    border-style: dashed !important;
    opacity: 0.75;
    transition: opacity 0.2s !important;
}
.picker-add-btn:hover { opacity: 1 !important; }
.wheel-option-input { flex:1; border:none; background:transparent; border-bottom:1px solid var(--border-color); padding:3px 4px; font-size:14px; outline:none; font-family:var(--font-family); color:var(--text-primary); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Global UI Polish & Animation Enhancements ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Enhanced message appear with subtle spring */
@keyframes messageAppear {
    0% { opacity: 0; transform: translateY(10px) scale(0.94); }
    60% { opacity: 1; transform: translateY(-2px) scale(1.01); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* Ripple effect on interactive elements */
.modal-btn, .settings-item, .setting-pill-row, .action-btn, .input-btn {
    position: relative;
    overflow: hidden;
}
.modal-btn::after, .settings-item::after, .setting-pill-row::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(var(--accent-color-rgb),0.2) 0%, transparent 70%);
    opacity: 0;
    transform: scale(0);
    transition: transform 0.4s ease, opacity 0.4s ease;
    pointer-events: none;
    border-radius: inherit;
}
.modal-btn:active::after, .settings-item:active::after, .setting-pill-row:active::after {
    opacity: 1;
    transform: scale(2);
    transition: 0s;
}

/* Smoother modal slide-in */
@keyframes modalContentSlideIn {
    from { opacity: 0; transform: translateY(28px) scale(0.93); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Enhanced settings-item hover */
.settings-item {
    transition: all 0.2s cubic-bezier(0.25,0.8,0.25,1);
}
.settings-item:hover {
    transform: translateX(2px);
}

/* Smooth notification with better spring */
@keyframes slideUpNotif {
    from { opacity:0; transform:translateX(-50%) translateY(24px) scale(0.9); }
    60% { transform: translateX(-50%) translateY(-4px) scale(1.02); }
    to { opacity:1; transform:translateX(-50%) translateY(0) scale(1); }
}

/* Action button hover glow */
.action-btn:hover {
    box-shadow: 0 0 0 6px rgba(var(--accent-color-rgb), 0.1);
}

/* Send button pulse on hover */
.send-btn:hover {
    box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.45), 0 0 0 4px rgba(var(--accent-color-rgb),0.1);
}

/* Input focus glow */
.message-input:focus {
    box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.12);
}

/* Calendar day click feedback */
.calendar-day {
    transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), background 0.2s, border-color 0.2s;
}
.calendar-day:active { transform: scale(0.9); }

/* Mood overlay card animation */
.mood-selector-card, .day-detail-card {
    animation: cardSlideUp 0.38s cubic-bezier(0.34,1.4,0.64,1) forwards;
    opacity: 0;
    transform: translateY(30px) scale(0.96);
}
@keyframes cardSlideUp {
    to { opacity:1; transform: translateY(0) scale(1); }
}

/* Smooth tab switch */
.mood-tab-btn, .combo-tab, .stats-toggle-btn, .view-switch-btn {
    transition: all 0.22s cubic-bezier(0.25,0.8,0.25,1) !important;
}

/* Picker item hover spring */
.picker-item:hover {
    transform: scale(1.12) translateY(-2px) !important;
}

/* Sticker picker slide-up */
#user-sticker-picker.active {
    animation: pickerSlideUp 0.3s cubic-bezier(0.34,1.2,0.64,1) forwards;
}
@keyframes pickerSlideUp {
    from { opacity:0; transform: translateY(16px) scale(0.97); }
    to { opacity:1; transform: translateY(0) scale(1); }
}

    </style>
</head>
<body>
<div id="tour-overlay" class="tour-overlay">
    <div id="tour-highlight-box" class="tour-highlight-box"></div>
    <div id="tour-popover" class="tour-popover">
        <div class="tour-popover-header">
            <span id="tour-title" class="tour-title"></span>
            <span id="tour-step-counter" class="tour-step-counter"></span>
        </div>
        <div id="tour-content" class="tour-popover-content"></div>
        <div class="tour-popover-footer">
            <button id="tour-skip-btn" class="tour-btn tour-btn-skip">Ë∑≥Ëøá</button>
            <div class="tour-navigation">
                <button id="tour-prev-btn" class="tour-btn"><i class="fas fa-arrow-left"></i> ‰∏ä‰∏ÄÊ≠•</button>
                <button id="tour-next-btn" class="tour-btn tour-btn-primary">‰∏ã‰∏ÄÊ≠• <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

    <div class="welcome-animation" id="welcome-animation">
        <div class="welcome-bg-gradient"></div>
        <div class="stars-container" id="stars-container"></div>
        <div class="welcome-particles" id="welcome-particles"></div>
        <!-- Êñ∞Â¢ûÔºöÊµÅÊòüÊïàÊûú -->
        <div id="welcome-meteors" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
        <div class="welcome-content-wrapper">
            <div class="logo-tech-container">
                <div class="logo-circle-outer"></div>
                <div class="logo-circle-inner"></div>
                <div class="logo-icon-main">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot-2"></div>
                <!-- Êñ∞Â¢ûÔºöÁ¨¨‰∏â‰∏™ËΩ®ÈÅìÁÇπ -->
                <div class="orbit-dot-3"></div>
            </div>

            <div class="text-tech-container">
                <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="‰º†ËÆØ">
                    Âä†ËΩΩÂ§±Ë¥•
                </div>
                <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">
                    ËØ∑ÈáçËØïÔºèÊõ¥Êç¢Âπ≥Âè∞/Êõ¥Êç¢ÁΩëÁªú
                </div>
            </div>

            <div class="loader-tech">
                <div class="loader-tech-bar" id="loader-tech-bar"></div>
            </div>
            <!-- Êñ∞Â¢ûÔºöÂä†ËΩΩÁä∂ÊÄÅÊñáÂ≠ó -->
            <div id="loader-status-text" style="font-size:10px;opacity:0.5;letter-spacing:1px;color:var(--welcome-text-sub);margin-top:4px;font-family:monospace;"></div>
        </div>
    </div>
    <button id="immersive-exit-btn" onclick="toggleImmersiveMode(false)" title="ÈÄÄÂá∫Ê≤âÊµ∏Ê®°Âºè">
<i class="fas fa-expand"></i>
</button>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
         <div class="user-info">
                <div id="partner-name" class="username">
                    Ê¢¶Ëßí
                </div>
                <div id="partner-avatar-container" class="avatar-container">
                    <div class="avatar" id="partner-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="status" id="partner-status">
                    <span>Âú®Á∫ø</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="‰ºöËØùÁÆ°ÁêÜ"><i class="fas fa-comments"></i></button>
                <button id="group-chat-btn" class="action-btn" title="Áæ§ËÅäËÆæÁΩÆ"><i class="fas fa-users"></i></button>
                <button id="daily-greeting-btn" class="action-btn" title="‰ªäÊó•ÂÖ¨Âëä" onclick="reopenDailyGreeting()"><i class="fas fa-newspaper"></i></button>
                <button id="theme-toggle" class="action-btn" title="ÂàáÊç¢‰∏ªÈ¢ò"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="ËÆæÁΩÆ"><i class="fas fa-cog"></i></button>
            </div>
             <div class="user-info">
                <div class="username" id="my-name">
                    Êàë
                </div>
               
                <div id="my-avatar-container" class="avatar-container">
                    <div class="avatar" id="my-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
               
                <div class="status" id="my-status-container">
                    <span id="my-status-text">Âú®Á∫ø</span>
                </div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">

        <div class="history-loader" id="history-loader">
            <div class="history-spinner"></div>
        </div>

        <div class="chat-container" id="chat-container"></div>
        <div class="empty-state" id="empty-state">
            <i class="far fa-comments"></i><p></p>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        <div class="batch-preview" id="batch-preview"></div>
    </div>
    <div class="input-area-wrapper">
        <div id="reply-preview-container"></div>
        <div class="input-area">
    <button class="attachment-btn input-btn" id="attachment-btn" title="ÂèëÈÄÅÂõæÁâá"><i class="fas fa-image"></i></button>
    
    <button class="combo-btn input-btn" id="combo-btn" title="Ë°®ÊÉÖ & Êãç‰∏ÄÊãç">
        <i class="fas fa-laugh-beam"></i>
    </button>

    <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
    
    <div class="input-buttons">
    <button class="continue-btn input-btn" id="continue-btn" title="ËÆ©ÂØπÊñπÁªßÁª≠ËØ¥"><i class="fas fa-ellipsis-h"></i></button>
        <button class="batch-btn input-btn" id="batch-btn" title="ÊâπÈáèÂèëÈÄÅÊ®°Âºè"><i class="fas fa-layer-group"></i></button>
        <button class="send-btn input-btn" id="send-btn" title="ÂèëÈÄÅÊ∂àÊÅØ"><i class="fas fa-paper-plane"></i></button>
        
        <div class="sticker-picker-popover" id="user-sticker-picker">
            <div class="combo-tabs-header">
                <button class="combo-tab-btn active" data-tab="sticker">Ë°®ÊÉÖÂ∫ì</button>
                <button class="combo-tab-btn" data-tab="poke">Êãç‰∏ÄÊãç</button>
            </div>
            <div class="combo-content-area" id="combo-content-area">
            </div>
        </div>
    </div>
    <input type="file" id="image-input" class="file-input" accept="image/*">
</div>
    </div>


    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-user-edit"></i><span id="edit-modal-title">‰øÆÊîπÊòµÁß∞</span>
            </div>
            <input type="text" class="modal-input" id="name-input" placeholder="ËæìÂÖ•Êñ∞ÊòµÁß∞"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit">ÂèñÊ∂à</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-portrait"></i><span id="avatar-modal-title">‰∏ä‰º†Â§¥ÂÉè</span>
            </div>
            <input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-avatar">ÂèñÊ∂à</button><button class="modal-btn modal-btn-primary" id="save-avatar">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-sticky-note"></i><span>ÁºñËæëÊ≥®Èáä</span>
            </div>
            <textarea class="modal-textarea" id="note-input" placeholder="‰∏∫ËøôÊù°Ê∂àÊÅØÊ∑ªÂä†Ê≥®Èáä..."></textarea><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-note">ÂèñÊ∂à</button><button class="modal-btn modal-btn-primary" id="save-note">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="poke-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hand-sparkles"></i><span>Êãç‰∏ÄÊãç</span>
            </div>
            <input type="text" class="modal-input" id="poke-input" placeholder="‰æãÂ¶ÇÔºöÊãç‰∫ÜÊãçÂØπÊñπÁöÑËÇ©ËÜÄ"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-poke">ÂèñÊ∂à</button><button class="modal-btn modal-btn-primary" id="send-poke">ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>
<div class="modal" id="envelope-modal">
    <div class="modal-content" style="max-height:92vh; padding:0; overflow:hidden; background:transparent;">
    <div class="env-wrapper">
        <div class="env-header-flap">
            <svg class="env-header-icon" width="40" height="30" viewBox="0 0 40 30" fill="none">
                <!-- Envelope body -->
                <rect x="1" y="7" width="38" height="22" rx="3" fill="rgba(255,255,255,0.18)" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/>
                <!-- Flap fold lines -->
                <path d="M1 9 L20 20 L39 9" stroke="rgba(255,255,255,0.5)" stroke-width="1.2" fill="none"/>
                <path d="M1 29 L14 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
                <path d="M39 29 L26 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
            </svg>
            <div class="env-header-title">‰ø° Â∞Å Êäï ÈÄí</div>
            <div class="env-header-subtitle">Letters ¬∑ Correspondence</div>
        </div>

        <div class="env-body">
            <div class="env-tab-bar">
                <button class="env-tab-btn active" id="env-tab-outbox" onclick="switchEnvTab('outbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>ÂØÑÂá∫ÁöÑ‰ø°
                    <span id="env-outbox-badge" class="env-badge" style="display:none;"></span>
                </button>
                <button class="env-tab-btn" id="env-tab-inbox" onclick="switchEnvTab('inbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 13V19a2 2 0 01-2 2H4a2 2 0 01-2-2v-6"/><polyline points="15 3 21 3 21 9"/><line x1="21" y1="3" x2="10" y2="14"/></svg>Êî∂Âà∞ÁöÑ‰ø°
                    <span id="env-inbox-badge" class="env-badge" style="display:none;"></span>
                </button>
            </div>

            <div id="env-outbox-section">
                <div id="env-outbox-list"></div>
            </div>

            <div id="env-inbox-section" style="display:none;">
                <div id="env-inbox-list"></div>
            </div>

            <div id="env-compose-form" style="display:none;">
                <div class="env-compose-paper">
                    <div class="env-compose-heading">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        <span id="env-compose-title">ÂÜô‰∏ÄÂ∞Å‰ø°</span>
                    </div>
                    <textarea id="envelope-input" placeholder="‰∫≤Áà±ÁöÑÔºå&#10;&#10;‰ªäÂ§©ÊÉ≥Ë∑ü‰Ω†ËØ¥..."></textarea>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin:4px 0 6px; font-size:12px; padding: 0 2px;">
                    <input type="checkbox" id="env-send-to-chat" style="width:15px;height:15px; cursor:pointer; accent-color:var(--accent-color);">
                    <label for="env-send-to-chat" style="cursor:pointer; color:var(--text-secondary);">ÂêåÊó∂ÂèëÈÄÅÂà∞ËÅäÂ§©ËÆ∞ÂΩï</label>
                </div>
                <div class="env-send-info">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="env-reply-time-info">ÂØπÊñπÂ∞ÜÂú® 10-24 Â∞èÊó∂ÂÜÖÂõû‰ø°Ôºà8-12 Âè•ËØùÔºâ</span>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="modal-btn modal-btn-secondary" id="cancel-compose" onclick="cancelEnvelopeCompose()" style="flex:1;">ÂèñÊ∂à</button>
                    <button class="modal-btn modal-btn-primary" id="send-envelope" style="flex:2;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>Â∞Å ¬∑ ÂØÑÂá∫
                    </button>
                </div>
            </div>
        </div>

        <div class="env-send-area" id="env-main-close-btn">
            <button class="env-write-btn" id="new-envelope-btn" onclick="openNewEnvelopeForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                ÊèêÁ¨îÂÜô‰ø°
            </button>
            <button class="env-close-btn" id="cancel-envelope">ÂÖ≥Èó≠</button>
        </div>
    </div>
    </div>
</div>

<div class="modal" id="envelope-view-modal" style="z-index:2100;">
    <div class="modal-content" style="overflow:hidden;padding:0;background:transparent;max-height:92vh;display:flex;flex-direction:column;">
    <div style="background:var(--secondary-bg);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;max-height:92vh;">
        <!-- ‰ø°Â∞ÅÈ°∂ÈÉ®ÔºöÈÇÆÊà≥ÂºèËÆæËÆ° -->
        <div style="background:var(--accent-color);padding:0;position:relative;overflow:hidden;flex-shrink:0;">
            <!-- ÊñúÁ∫πË£ÖÈ•∞ -->
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,0.04) 0px,rgba(255,255,255,0.04) 2px,transparent 2px,transparent 12px);pointer-events:none;"></div>
            <div style="position:relative;padding:14px 20px 12px;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:10px;color:white;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                    <span id="env-view-title" style="font-size:14px;font-weight:700;letter-spacing:2px;">‰ø°‰ª∂ÂÜÖÂÆπ</span>
                </div>
                <!-- ÈÇÆÊà≥Ë£ÖÈ•∞ -->
                <div style="border:2px solid rgba(255,255,255,0.5);border-radius:50%;width:48px;height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0.7;">
                    <span style="font-size:7px;color:white;letter-spacing:0.5px;">Â∑≤ÈÄÅËææ</span>
                    <span id="env-view-stamp-date" style="font-size:8px;color:white;font-weight:600;"></span>
                    <span style="font-size:6px;color:white;opacity:0.8;">DELIVERED</span>
                </div>
            </div>
        </div>

        <!-- ‰ø°Á∫∏ÂÜÖÂÆπÂå∫Âüü -->
        <div style="padding:0;overflow-y:auto;flex:1;min-height:0;">
            <div id="env-view-content" style="display:none;">
                <!-- ‰ø°Á∫∏‰∏ª‰Ωì -->
                <div style="background:var(--primary-bg);margin:16px;border-radius:12px;border:1px solid var(--border-color);overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <!-- ‰ø°Á∫∏È°∂ÈÉ®Ë£ÖÈ•∞Êù° -->
                    <div style="height:6px;background:linear-gradient(90deg,var(--accent-color),rgba(var(--accent-color-rgb),0.4),var(--accent-color));"></div>
                    <!-- ‰ø°‰ª∂ÂÜÖÂÆπ -->
                    <div style="padding:20px 20px 16px;position:relative;">
                        <!-- Â∑¶‰æßÁ∫¢Á∫øÔºà‰ø°Á∫∏ÊÑüÔºâ -->
                        <div style="position:absolute;left:52px;top:0;bottom:0;width:1px;background:rgba(220,80,80,0.15);pointer-events:none;"></div>
                        <!-- Ê®™Á∫øËÉåÊôØ -->
                        <div style="position:absolute;inset:0;background:repeating-linear-gradient(transparent,transparent 31px,rgba(var(--accent-color-rgb),0.06) 31px,rgba(var(--accent-color-rgb),0.06) 32px);pointer-events:none;border-radius:12px;"></div>
                        
                        <div style="position:relative;z-index:1;">
                            <!-- Êó•ÊúüË°å -->
                            <div id="env-view-date-line" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:16px;letter-spacing:1px;opacity:0.8;font-style:italic;"></div>
                            <!-- To Ë°å -->
                            <div id="env-view-to-line" style="font-size:13px;color:var(--text-primary);margin-bottom:4px;font-weight:500;"></div>
                            <!-- ÂºÄÂ§¥ËØ≠ -->
                            <div id="env-view-greeting-line" style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;font-style:italic;opacity:0.8;"></div>
                            <!-- Ê≠£Êñá -->
                            <div id="env-view-text" class="env-letter-paper" style="border:none;background:transparent;padding:0 0 0 8px;line-height:32px;margin-bottom:16px;"></div>
                            <!-- ËêΩÊ¨æÂàÜÈöî -->
                            <div style="border-top:1px dashed rgba(var(--accent-color-rgb),0.25);margin:12px 0;"></div>
                            <!-- ËêΩÊ¨æÊó•Êúü -->
                            <div id="env-view-sign-date" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:4px;letter-spacing:0.5px;"></div>
                            <!-- ËêΩÊ¨æÁΩ≤Âêç -->
                            <div id="env-view-sign-name" style="font-size:14px;color:var(--accent-color);text-align:right;font-weight:600;letter-spacing:1px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ÁºñËæëÂå∫Âüü -->
            <div id="env-view-edit" style="display:none;padding:16px;">
                <div class="env-compose-paper" style="padding:14px;">
                    <textarea class="modal-textarea" id="env-edit-input" style="height:160px;background:transparent;border:none;outline:none;font-family:var(--font-family);font-size:14px;line-height:1.9;width:100%;resize:none;"></textarea>
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="margin:0;padding:12px 18px 16px;border-top:1px solid var(--border-color);flex-shrink:0;">
            <button class="modal-btn modal-btn-secondary" id="close-env-view" onclick="closeEnvViewModal()">ÂÖ≥Èó≠</button>
            <button class="modal-btn modal-btn-secondary" id="env-view-edit-btn" onclick="toggleEnvEdit()">ÁºñËæë</button>
            <button class="modal-btn modal-btn-primary" id="env-view-save-btn" onclick="saveEnvEdit()" style="display:none;">‰øùÂ≠ò</button>
        </div>
    </div>
    </div>
</div>
<!-- Áæ§ËÅäËÆæÁΩÆ Modal -->
<div class="modal" id="group-chat-modal">
    <div class="modal-content">
        <div class="modal-title">
            <i class="fas fa-users"></i><span>Áæ§ËÅäËÆæÁΩÆ</span>
        </div>

        <!-- Áæ§ËÅäÊÄªÂºÄÂÖ≥ -->
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-toggle-on"></i>Áæ§ËÅäÊ®°Âºè</div>
            <div id="group-mode-toggle" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="group-mode-icon" class="fas fa-users" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">Áæ§ËÅäÊ®°Âºè</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="group-mode-status">Â∑≤ÂÖ≥Èó≠ ‚Äî ÁÇπÂáªÂºÄÂêØ</div>
                </div>
                <div id="group-mode-pill" style="width:44px;height:24px;border-radius:24px;background:var(--border-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="group-mode-knob" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
        </div>

        <!-- ÊòæÁ§∫ÂºÄÂÖ≥ -->
        <div class="settings-section" id="group-display-section" style="display:none;">
            <div class="settings-section-title"><i class="fas fa-eye"></i>ÊòæÁ§∫ÈÄâÈ°π</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div id="group-show-avatar-toggle" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;cursor:pointer;">
                    <i class="fas fa-user-circle" style="color:var(--accent-color);width:18px;"></i>
                    <span style="flex:1;font-size:13px;">ÊòæÁ§∫ÊàêÂëòÂ§¥ÂÉè</span>
                    <div id="group-show-avatar-pill" style="width:36px;height:20px;border-radius:20px;background:var(--accent-color);position:relative;transition:background 0.3s;">
                        <div id="group-show-avatar-knob" style="position:absolute;width:14px;height:14px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                    </div>
                </div>
                <div id="group-show-name-toggle" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;cursor:pointer;">
                    <i class="fas fa-tag" style="color:var(--accent-color);width:18px;"></i>
                    <span style="flex:1;font-size:13px;">ÊòæÁ§∫ÊàêÂëòÂêçÁß∞</span>
                    <div id="group-show-name-pill" style="width:36px;height:20px;border-radius:20px;background:var(--accent-color);position:relative;transition:background 0.3s;">
                        <div id="group-show-name-knob" style="position:absolute;width:14px;height:14px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊàêÂëòÁÆ°ÁêÜ -->
        <div class="settings-section" id="group-members-section" style="display:none;">
            <div class="settings-section-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span><i class="fas fa-users"></i>Áæ§ÊàêÂëò</span>
                <button onclick="openAddGroupMember()" class="modal-btn modal-btn-primary" style="padding:5px 12px;font-size:12px;"><i class="fas fa-plus"></i> Ê∑ªÂä†</button>
            </div>
            <div id="group-members-list" style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto;"></div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-group-chat">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- Áæ§ÊàêÂëòÁºñËæë Modal -->
<div class="modal" id="group-member-edit-modal" style="z-index:2200;">
    <div class="modal-content" style="max-width:320px;">
        <div class="modal-title">
            <i class="fas fa-user-edit"></i><span id="group-member-edit-title">Ê∑ªÂä†ÊàêÂëò</span>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;padding:4px 0;">
            <!-- Â§¥ÂÉè‰∏ä‰º† -->
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div id="group-member-avatar-preview" onclick="document.getElementById('group-member-avatar-input').click()" style="width:64px;height:64px;border-radius:50%;background:var(--primary-bg);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;">
                    <i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>
                </div>
                <span style="font-size:11px;color:var(--text-secondary);">ÁÇπÂáª‰∏ä‰º†Â§¥ÂÉè</span>
                <input type="file" id="group-member-avatar-input" accept="image/*" style="display:none;" onchange="previewGroupMemberAvatar(this)">
            </div>
            <div>
                <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">ÊàêÂëòÂêçÂ≠ó</label>
                <input type="text" id="group-member-name-input" placeholder="ËæìÂÖ•ÂêçÂ≠ó" maxlength="10" style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:10px;background:var(--primary-bg);color:var(--text-primary);font-size:14px;box-sizing:border-box;">
            </div>
        </div>
        <input type="hidden" id="group-member-edit-index">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeGroupMemberEdit()">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-primary" onclick="saveGroupMember()">‰øùÂ≠ò</button>
        </div>
    </div>
</div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i><span>ËÆæÁΩÆ</span>
            </div>

            <div class="settings-grid">
                <div class="settings-card" id="appearance-settings">
                    <i class="fas fa-palette"></i>
                    <span>Â§ñËßÇËÆæÁΩÆ</span>
                </div>
                <div class="settings-card" id="chat-settings">
                    <i class="fas fa-comments"></i>
                    <span>ËÅäÂ§©ËÆæÁΩÆ</span>
                </div>
                <div class="settings-card" id="advanced-settings">
                    <i class="fas fa-tools"></i>
                    <span>È´òÁ∫ßÂäüËÉΩ</span>
                </div>
                <div class="settings-card" id="data-settings">
                    <i class="fas fa-database"></i>
                    <span>Êï∞ÊçÆÁÆ°ÁêÜ</span>
                </div>
            </div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>


    <div class="modal" id="appearance-modal">
        <div class="modal-content">

<div class="modal-title" id="appearance-modal-title">
    <i class="fas fa-palette"></i><span>Â§ñËßÇËÆæÁΩÆ</span>
</div>

<!-- ÊùøÂùóÂØºËà™ÁΩëÊ†º -->
<div id="appearance-nav-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:4px 0 12px;">
    <div class="settings-card" onclick="showAppearancePanel('theme')" style="cursor:pointer;">
        <i class="fas fa-paint-roller"></i><span>‰∏ªÈ¢òÈÖçËâ≤</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('font-bg')" style="cursor:pointer;">
        <i class="fas fa-font"></i><span>ËÉåÊôØ & Â≠ó‰Ωì</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('bubble-css')" style="cursor:pointer;">
        <i class="fas fa-comment"></i><span>Ê∞îÊ≥° & CSS</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('avatar')" style="cursor:pointer;">
        <i class="fas fa-user-circle"></i><span>ËÅäÂ§©Â§¥ÂÉè</span>
    </div>
</div>

<!-- Èù¢ÊùøÂÆπÂô® -->
<div id="appearance-panel-container" style="display:none;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <button onclick="hideAppearancePanel()" style="background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;padding:6px 12px;font-size:12px;cursor:pointer;color:var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> ËøîÂõû
        </button>
        <span id="appearance-panel-title" style="font-size:14px;font-weight:600;color:var(--text-primary);"></span>
    </div>

    <!-- ‰∏ªÈ¢òÈÖçËâ≤Èù¢Êùø -->
    <div id="appearance-panel-theme" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-paint-roller"></i>‰∏ªÈ¢òÈÖçËâ≤</div>
            <div class="appearance-group" style="margin-bottom:0;">
                <div class="theme-editor-entry-btn" id="open-theme-editor">
                    <i class="fas fa-sliders-h"></i>
                    <span>Ëá™ÂÆö‰πâ<br>ÁºñËæëÂô®</span>
                </div>
                <div class="preset-colors-container">
                    <div class="preset-colors-title"><i class="fas fa-swatchbook"></i> Âø´Êç∑Êç¢ËÇ§</div>
                    <div class="theme-picker">
                        <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="ÈáëËâ≤"></button>
                        <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="ËìùËâ≤"></button>
                        <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="Á¥´Ëâ≤"></button>
                        <button class="theme-color-btn" id="theme-green" data-theme="green" title="ÁªøËâ≤"></button>
                        <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="Á≤âËâ≤"></button>
                        <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="ÈªëÁôΩ"></button>
                        <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="Á∫¢Ëâ≤"></button>
                        <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="Ê©ôËâ≤"></button>
                        <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="Ê∑±Áªø"></button>
                        <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="Ê∑±Ëìù"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-section" id="theme-schemes-section">
            <div class="settings-section-title">
                <i class="fas fa-layer-group"></i>‰∏ªÈ¢òÊñπÊ°à
                <button id="save-theme-scheme-btn" class="modal-btn modal-btn-primary" style="padding:4px 10px; font-size:11px; margin-left:auto;">
                    <i class="fas fa-plus"></i> ‰øùÂ≠òÂΩìÂâç
                </button>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);opacity:0.7;margin-bottom:8px;">‰øùÂ≠òÂΩìÂâçÊâÄÊúâÂ§ñËßÇËÆæÁΩÆÔºåÊñπ‰æøÂø´ÈÄüÂàáÊç¢</div>
            <div id="theme-schemes-list" class="theme-schemes-list">
                <div class="theme-schemes-empty" id="theme-schemes-empty">
                    <i class="fas fa-paint-brush"></i>
                    <span>ÊöÇÊó†‰øùÂ≠òÁöÑÊñπÊ°àÔºåÁÇπÂáª"‰øùÂ≠òÂΩìÂâç"ËØïËØï~</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Â≠ó‰ΩìËÆæÁΩÆÈù¢Êùø -->
    <div id="appearance-panel-font" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-font"></i>Â≠ó‰ΩìËÆæÁΩÆ</div>
            <div class="font-size-control">
                <span class="font-size-label">Â§ßÂ∞è:</span>
                <input type="range" min="12" max="24" value="16" class="font-size-slider" id="font-size-slider">
                <span class="font-size-value" id="font-size-value">16px</span>
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:5px;">Â≠ó‰ΩìÈìæÊé• (CSS/TTF):</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="custom-font-url" class="modal-input" style="margin-bottom:0; font-size:12px;" placeholder="https://example.com/font.woff2">
                    <button id="apply-font-btn" class="modal-btn modal-btn-primary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap;">Â∫îÁî®</button>
                    <button id="follow-system-font-btn" class="modal-btn modal-btn-secondary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap; margin-left: 5px;">Ë∑üÈöèÁ≥ªÁªü</button>
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; opacity: 0.7;">
                    ÊèêÁ§∫: Â∫îÁî®ÂêéÂ∞ÜË¶ÜÁõñÈªòËÆ§Â≠ó‰Ωì„ÄÇÁïôÁ©∫Âπ∂Â∫îÁî®ÂèØÊÅ¢Â§çÈªòËÆ§„ÄÇ
                </div>
            </div>
        </div>
    </div>

    <!-- ËÅäÂ§©ËÉåÊôØÈù¢Êùø -->
    <div id="appearance-panel-background" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-image"></i>ËÅäÂ§©ËÉåÊôØ
                <input type="file" id="bg-gallery-input" accept="image/*" style="display: none;">
            </div>
            <div class="bg-gallery" id="background-gallery-list"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="modal-btn modal-btn-secondary" id="reset-default-bg" style="font-size: 12px; padding: 6px 12px;">
                    <i class="fas fa-undo"></i> ÊÅ¢Â§çÈªòËÆ§ËÉåÊôØ
                </button>
            </div>
        </div>
    </div>

    <!-- Ê∞îÊ≥°Ê†∑ÂºèÈù¢Êùø -->
    <div id="appearance-panel-bubble" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-comment"></i>Ê∞îÊ≥°Ê†∑Âºè
            </div>
            <div class="settings-item-list" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="settings-item" data-bubble-style="standard" style="justify-content:center;">
                    <i class="fas fa-comment"></i><span>Ê†áÂáÜÂ∞ñËßí</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded" style="justify-content:center;">
                    <i class="fas fa-comment-dots"></i><span>ÂúÜËßí</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded-large" style="justify-content:center;">
                    <i class="fas fa-circle"></i><span>Â§ßÂúÜËßíËÉ∂Âõä</span>
                </div>
                <div class="settings-item" data-bubble-style="square" style="justify-content:center;">
                    <i class="fas fa-square"></i><span>ÊñπÂΩ¢Áõ¥Ëßí</span>
                </div>
            </div>

        </div>
    </div>

    <!-- ËÅäÂ§©Â§¥ÂÉèÈù¢Êùø -->
    <div id="appearance-panel-avatar" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-user-circle"></i>ËÅäÂ§©Â§¥ÂÉè</div>
            <div id="in-chat-avatar-toggle-2" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;margin-bottom:10px;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="avatar-toggle-icon-2" class="fas fa-user-circle" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">ÊòæÁ§∫ËÅäÂ§©Â§¥ÂÉè</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="avatar-toggle-status-2">Â∑≤ÂºÄÂêØ ‚Äî Ê∂àÊÅØÊóÅÊòæÁ§∫Â§¥ÂÉè</div>
                </div>
                <div id="avatar-toggle-pill-2" style="width:44px;height:24px;border-radius:24px;background:var(--accent-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="avatar-toggle-knob-2" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
            <div class="font-size-control" id="in-chat-avatar-size-control-2">
                <span class="font-size-label">Â§¥ÂÉèÂ∞∫ÂØ∏:</span>
                <input type="range" min="24" max="48" value="36" class="font-size-slider" id="in-chat-avatar-size-slider-2">
                <span class="font-size-value" id="in-chat-avatar-size-value-2">36px</span>
            </div>
            <div id="in-chat-avatar-position-control-2" style="margin-top:10px;">
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;">Â§¥ÂÉèÂØπÈΩêÊñπÂºè</div>
                <div style="display:flex;gap:8px;">
                    <button id="avatar-pos-top-2" class="modal-btn modal-btn-secondary" data-pos="top" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-up"></i> È°∂ÈÉ®</button>
                    <button id="avatar-pos-center-2" class="modal-btn modal-btn-primary" data-pos="center" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrows-alt-v"></i> Â±Ö‰∏≠</button>
                    <button id="avatar-pos-bottom-2" class="modal-btn modal-btn-secondary" data-pos="bottom" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-down"></i> Â∫ïÈÉ®</button>
                </div>
            </div>
            <div id="avatar-bubble-preview" style="margin-top:14px;background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);display:none;">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;opacity:0.7;text-align:center;letter-spacing:0.3px;">È¢ÑËßàÊïàÊûú</div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                    <div id="preview-partner-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                    <div style="background:var(--message-received-bg);color:var(--message-received-text);border-radius:16px 16px 16px 4px;padding:9px 13px;font-size:13px;max-width:160px;">
                        ‰Ω†ÊòØÊàëÊúùÂ§ïÁõ∏‰º¥Ëß¶ÊâãÂèØÂèäÁöÑËôöÊãü
                    </div>
                </div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                    <div style="background:var(--message-sent-bg);color:var(--message-sent-text);border-radius:16px 16px 4px 16px;padding:9px 13px;font-size:13px;max-width:160px;">
                        ‰Ω†ÊòØÊàëÊú™ÊõæÊã•ÊúâÊó†Ê≥ïÊçïÊçâÁöÑ‰∫≤Êòµ
                    </div>
                    <div id="preview-my-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â§¥ÂÉèÊ°ÜËÆæÁΩÆÔºà‰ªéËÅäÂ§©ËÆæÁΩÆÁßªÊù•Ôºâ -->
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-id-badge"></i>Â§¥ÂÉèÊ°ÜËÆæÁΩÆ</div>
            <h4 style="font-size:13px;font-weight:600;margin:10px 0 8px;color:var(--text-primary);">ÊàëÁöÑÂ§¥ÂÉèÊ°Ü</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="my-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="my-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">‰∏ä‰º†</button>
                        <button class="modal-btn modal-btn-secondary" id="my-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">ÁßªÈô§</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="my-frame-size-2">Â§ßÂ∞è</label>
                        <input type="range" id="my-frame-size-2" min="50" max="200" value="100">
                        <span id="my-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-x-2">Â∑¶Âè≥</label>
                        <input type="range" id="my-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-y-2">‰∏ä‰∏ã</label>
                        <input type="range" id="my-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="my-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">

            <h4 style="font-size:13px;font-weight:600;margin:20px 0 8px;border-top:1px dashed var(--border-color);padding-top:14px;color:var(--text-primary);">Ê¢¶ËßíÁöÑÂ§¥ÂÉèÊ°Ü</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="partner-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">‰∏ä‰º†</button>
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">ÁßªÈô§</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="partner-frame-size-2">Â§ßÂ∞è</label>
                        <input type="range" id="partner-frame-size-2" min="50" max="200" value="100">
                        <span id="partner-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-x-2">Â∑¶Âè≥</label>
                        <input type="range" id="partner-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-y-2">‰∏ä‰∏ã</label>
                        <input type="range" id="partner-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="partner-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">
        </div>
    </div>

    <!-- Ëá™ÂÆö‰πâCSSÈù¢Êùø -->
    <div id="appearance-panel-css" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-code"></i>Ëá™ÂÆö‰πâ CSS</div>
            <textarea id="custom-bubble-css" class="modal-textarea" style="font-family: monospace; font-size: 12px; height: 150px; white-space: pre;" placeholder=".message-sent {
  border-radius: 20px 20px 0 20px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.message-received {
  border-bottom: 2px solid var(--accent-color);
}"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top:8px;">
                <button id="reset-css-btn" class="modal-btn modal-btn-secondary" style="padding: 6px 12px; font-size: 12px;">Ê∏ÖÁ©∫</button>
                <button id="apply-css-btn" class="modal-btn modal-btn-primary" style="padding: 6px 12px; font-size: 12px;">Â∫îÁî® CSS</button>
            </div>
            <!-- Live CSS Preview -->
            <div style="margin-top:14px;">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;letter-spacing:0.3px;">ÂÆûÊó∂È¢ÑËßà</div>
                <div id="css-live-preview" style="background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);">
                    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:#fff;"></i>
                        </div>
                        <div class="message message-received" style="max-width:180px;">‰Ω†ÊòØÊàëÊúùÂ§ïÁõ∏‰º¥Ëß¶ÊâãÂèØÂèäÁöÑËôöÊãü</div>
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                        <div class="message message-sent" style="max-width:180px;">‰Ω†ÊòØÊàëÊú™ÊõæÊã•ÊúâÊó†Ê≥ïÊçïÊçâÁöÑ‰∫≤Êòµ</div>
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--border-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <style id="css-live-preview-style"></style>
            </div>
        </div>
    </div>
</div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 4px;z-index:10;margin-top:8px;">
                <button class="modal-btn modal-btn-secondary" id="back-appearance" onclick="(function(){hideModal(document.getElementById('appearance-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> ËøîÂõû
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-appearance">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>


    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>ËÅäÂ§©ËÆæÁΩÆ</span>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-hourglass-half"></i>ÂØπÊñπÂõûÂ§çÈÄüÂ∫¶
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">ÊúÄÂ∞èÈó¥Èöî:</span>
                    <input type="range" min="1000" max="30000" step="1000" value="3000" class="font-size-slider" id="reply-delay-min-slider">
                    <span class="font-size-value" id="reply-delay-min-value">3s</span>
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">ÊúÄÂ§ßÈó¥Èöî:</span>
                    <input type="range" min="1000" max="120000" step="1000" value="7000" class="font-size-slider" id="reply-delay-max-slider">
                    <span class="font-size-value" id="reply-delay-max-value">7s</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-paper-plane"></i> ÂØπÊñπ‰∏ªÂä®ÂèëÊ∂àÊÅØ
                </div>
                <div class="setting-pill-row" id="auto-send-toggle">
                    <span class="setting-pill-icon"><i class="fas fa-paper-plane"></i></span>
                    <span class="setting-pill-label">‰∏ªÂä®ÂèëÈÄÅ</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div class="font-size-control" id="auto-send-control" style="display:none; margin-top:10px;">
                    <span class="font-size-label">Èó¥Èöî(ÂàÜÈíü):</span>
                    <input type="range" min="1" max="120" step="1" value="5" class="font-size-slider" id="auto-send-slider">
                    <span class="font-size-value" id="auto-send-value">5ÂàÜÈíü</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>ÂäüËÉΩÂºÄÂÖ≥
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div class="setting-pill-row" id="reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-reply"></i></span>
                        <span class="setting-pill-label">ÂºïÁî®ÂõûÂ§ç</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-receipts-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-check-double"></i></span>
                        <span class="setting-pill-label">Â∑≤ËØªÂõûÊâß</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-no-reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-comment-slash"></i></span>
                        <span class="setting-pill-label">Â∑≤ËØª‰∏çÂõû</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="typing-indicator-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-keyboard"></i></span>
                        <span class="setting-pill-label">Ê≠£Âú®ËæìÂÖ•</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-volume-up"></i>Ê∂àÊÅØÈü≥Êïà
                </div>
                <div class="setting-pill-row" id="sound-toggle" style="margin-bottom:10px;">
                    <span class="setting-pill-icon"><i class="fas fa-volume-up"></i></span>
                    <span class="setting-pill-label">Ê∂àÊÅØÈü≥Êïà</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div id="sound-detail-section">
                    <div class="font-size-control" style="margin-bottom:8px;">
                        <span class="font-size-label">Èü≥Èáè:</span>
                        <input type="range" min="0" max="100" step="5" value="15" class="font-size-slider" id="sound-volume-slider">
                        <span class="font-size-value" id="sound-volume-value">15%</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">Ëá™ÂÆö‰πâÈü≥Êïà URLÔºàÁïôÁ©∫‰ΩøÁî®ÂÜÖÁΩÆÈü≥ÊïàÔºâ</div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <input type="text" id="custom-sound-url-input" placeholder="https://example.com/sound.mp3" style="flex:1;padding:7px 10px;border:1px solid var(--border-color);border-radius:8px;font-size:12px;background:var(--primary-bg);color:var(--text-primary);outline:none;">
                        <button id="test-sound-btn" class="modal-btn modal-btn-secondary" style="padding:6px 10px;font-size:12px;white-space:nowrap;"><i class="fas fa-play"></i> ËØïÂê¨</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-clock"></i>Êó∂Èó¥Ê†ºÂºè
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="time-format-options">
                    <div class="settings-item time-fmt-opt active" data-fmt="HH:mm">
                        <i class="fas fa-clock"></i><span>14:05</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="HH:mm:ss">
                        <i class="fas fa-clock"></i><span>14:05:30</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm AM/PM">
                        <i class="fas fa-clock"></i><span>2:05 PM</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm:ss AM/PM">
                        <i class="fas fa-clock"></i><span>2:05:30 PM</span>
                    </div>
                </div>
            </div>

            

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-expand"></i>Ê≤âÊµ∏ÂºèËÅäÂ§©
                </div>
                <div class="setting-pill-row" id="immersive-toggle" onclick="toggleImmersiveMode()">
                    <span class="setting-pill-icon"><i class="fas fa-expand-arrows-alt"></i></span>
                    <span class="setting-pill-label">Ê≤âÊµ∏ÂºèÊ®°Âºè <span style="font-size:11px;color:var(--text-secondary);font-weight:400;">ÔºàÈöêËóèÈ°∂ÈÉ®Ê†èÔºå‰∏ìÊ≥®ËÅäÂ§©Ôºâ</span></span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 4px;z-index:10;margin-top:8px;">
                <button class="modal-btn modal-btn-secondary" id="back-chat" onclick="(function(){hideModal(document.getElementById('chat-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> ËøîÂõû
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-chat">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

<div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-tools"></i><span>È´òÁ∫ßÂäüËÉΩ</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-magic"></i>ÂÆûÁî®Â∑•ÂÖ∑
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function">
                        <i class="fas fa-comment-dots"></i><span>Ëá™ÂÆö‰πâÂõûÂ§ç</span>
                    </div>
                    <div class="settings-item" id="music-player-toggle">
                        <i class="fas fa-music"></i><span>ÊÇ¨ÊµÆÈü≥‰πêÊí≠ÊîæÂô®</span>
                    </div>
                    <div class="settings-item" id="stats-function">
                        <i class="fas fa-chart-bar"></i><span>Ê∂àÊÅØÁªüËÆ°</span>
                    </div>
                    <div class="settings-item" id="decision-function">
                        <i class="fas fa-balance-scale"></i> 
                        <span>ÊäâÊã©</span> 
                    </div>
                    <div class="settings-item" id="fortune-lenormand-function" style="position:relative;">
                        <i class="fas fa-star-and-crescent"></i><span>ËøêÂäø ¬∑ Âç†Âçú</span>
                    </div>
                    <div class="settings-item" id="anniversary-function">
                        <i class="fas fa-heart"></i><span>ÈáçË¶ÅÊó•</span>
                    </div>
                    <div class="settings-item" id="mood-function">
                        <i class="fas fa-calendar-day"></i><span>ÂøÉÊô¥ÊâãË¥¶</span>
                    </div>
                    <div class="settings-item" id="envelope-function">
                        <i class="fas fa-envelope"></i><span>‰ø°Â∞ÅÊäïÈÄí</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 4px;z-index:10;margin-top:8px;">
                <button class="modal-btn modal-btn-secondary" id="back-advanced" onclick="(function(){hideModal(document.getElementById('advanced-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> ËøîÂõû
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-advanced">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>


    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-database"></i><span>Êï∞ÊçÆÁÆ°ÁêÜ</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-bell"></i>Ê∂àÊÅØÈÄöÁü•
                </div>
                <div style="background:var(--primary-bg);border-radius:12px;padding:12px 14px;border:1px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:13px;font-weight:500;color:var(--text-primary);">ÂêéÂè∞Ê∂àÊÅØÊé®ÈÄÅ</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">ÊåÇÂú®ÂêéÂè∞Êó∂Êî∂Âà∞Êñ∞Ê∂àÊÅØËá™Âä®ÂºπÂá∫ÊèêÈÜí</div>
                        </div>
                        <label class="notif-toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;margin-left:12px;">
                            <input type="checkbox" id="notif-permission-toggle" style="opacity:0;width:0;height:0;" onchange="handleNotifToggle(this)">
                            <span class="notif-toggle-slider" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border-color);border-radius:24px;transition:0.3s;"></span>
                        </label>
                    </div>
                    <div id="notif-status-text" style="font-size:11px;color:var(--text-secondary);margin-top:4px;"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-comments"></i>ËÅäÂ§©ËÆ∞ÂΩï
                </div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>ÂØºÂá∫ËÆ∞ÂΩï</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>ÂØºÂÖ•ËÆ∞ÂΩï</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-archive"></i>ÂÖ®ÈáèÂ§á‰ªΩ
                </div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">ÂåÖÂê´Â§ñËßÇ„ÄÅËÅäÂ§©ËÆæÁΩÆ„ÄÅÂ≠óÂç°„ÄÅÂøÉÊÉÖ„ÄÅ‰ø°Â∞ÅÁ≠âÂÖ®ÈÉ®Êï∞ÊçÆ</div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-all-settings"><i class="fas fa-download"></i>ÂØºÂá∫ÂÖ®ÈÉ®</button>
                    <button class="import-export-btn export" id="import-all-settings"><i class="fas fa-upload"></i>ÂØºÂÖ•ÊÅ¢Â§ç</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-trash-alt"></i>Êï∞ÊçÆÊ∏ÖÁêÜ
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-chat">
                        <i class="fas fa-trash-alt"></i><span>Ê∏ÖÁ©∫ÂΩìÂâç‰ºöËØù</span>
                    </div>
                    <div class="settings-item" id="clear-storage">
                        <i class="fas fa-server"></i><span>ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-info-circle"></i>ÂÖ≥‰∫é‰∏éÂ£∞Êòé
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="replay-tutorial-btn">
                        <i class="fas fa-question-circle"></i><span>ÈáçÊîæÊñ∞ÊâãÂºïÂØº</span>
                    </div>
                    <div class="settings-item" id="open-credits-btn">
                        <i class="fas fa-scroll"></i><span>Â£∞Êòé‰∏éËá¥Ë∞¢</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 4px;z-index:10;margin-top:8px;">
                <button class="modal-btn modal-btn-secondary" id="back-data" onclick="(function(){hideModal(document.getElementById('data-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> ËøîÂõû
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-data">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-chart-bar"></i><span>Ê∂àÊÅØÁªüËÆ° & Êî∂Ëóè</span>
            </div>
            <!-- Tab switcher -->
            <div style="display:flex;gap:8px;margin-bottom:14px;">
                <button class="modal-btn modal-btn-primary" id="stats-tab-btn" onclick="switchStatsTab('stats')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-chart-bar"></i> Ê∂àÊÅØÁªüËÆ°
                </button>
                <button class="modal-btn modal-btn-secondary" id="favorites-tab-btn" onclick="switchStatsTab('favorites')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-star"></i> Êî∂ËóèÂ§π
                </button>
            </div>
            <!-- Stats panel -->
            <div id="stats-panel">
                <div class="stats-content" id="stats-content"></div>
            </div>
            <!-- Favorites panel -->
            <div id="favorites-panel" style="display:none;">
                <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
                    <button class="modal-btn modal-btn-secondary" id="batch-favorite-function" style="font-size:12px;padding:6px 14px;"><i class="fas fa-layer-group"></i> ÊâπÈáèÊî∂Ëóè</button>
                </div>
                <div class="favorites-list" id="favorites-list" style="max-height:55vh;overflow-y:auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-stats">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>‰ºöËØùÁÆ°ÁêÜ</span>
            </div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> Êñ∞Âª∫‰ºöËØù</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-lenormand-modal">
        <div class="modal-content fl-modal-content">
            <div class="fl-tab-bar">
                <button class="fl-tab active" id="fl-tab-fortune" onclick="switchFLTab('fortune')">
                    <i class="fas fa-sun"></i> ÊØèÊó•ËøêÂäø
                </button>
                <button class="fl-tab" id="fl-tab-lenormand" onclick="switchFLTab('lenormand')">
                    <i class="fas fa-moon"></i> Èõ∑ËØ∫ÊõºÂç†Âçú
                </button>
            </div>
            <div id="fl-panel-fortune" class="fl-panel fl-panel-active">
                <div id="fortune-content"></div>
                <div class="modal-buttons" style="margin-top:16px;">
                    <button class="modal-btn modal-btn-primary" id="share-fortune"><i class="fas fa-share-alt"></i> ÂàÜ‰∫´ËøêÂäø</button>
                    <button class="modal-btn modal-btn-secondary" id="close-fortune">ÂÖ≥Èó≠</button>
                </div>
            </div>
            <div id="fl-panel-lenormand" class="fl-panel">
                <div id="lenormand-content">
                    <div id="lenormand-setup" style="padding: 4px 0 12px;">
                        <div class="leno-num-section">
                            <div class="leno-section-label"><i class="fas fa-layer-group"></i> ÊäΩÁâåÊï∞Èáè</div>
                            <div class="leno-num-btns">
                                <button class="lenormand-num-btn active" onclick="setLenormandCount(1)"><span class="leno-btn-num">1</span><span class="leno-btn-label">ÂçïÂº†</span></button>
                                <button class="lenormand-num-btn" onclick="setLenormandCount(3)"><span class="leno-btn-num">3</span><span class="leno-btn-label">‰∏âÂº†</span></button>
                            </div>
                            <div class="leno-num-desc" id="leno-num-desc">ÂçïÂº†Áâå ¬∑ Áõ¥ËææÁ≠îÊ°à</div>
                        </div>
                        <div class="leno-question-section">
                            <div class="leno-section-label"><i class="fas fa-feather-alt"></i> ‰Ω†ÁöÑÊèêÈóÆÔºàÂèØÈÄâÔºâ</div>
                            <textarea id="lenormand-question" placeholder="Â∞ÜÂøÉ‰∏≠ÁöÑÁñëÈóÆËΩªÂ£∞ËØâËØ¥..." class="leno-question-input"></textarea>
                        </div>
                        <button class="modal-btn modal-btn-primary leno-draw-btn" onclick="startLenormandDraw()"><i class="fas fa-hand-sparkles"></i> ÂºÄÂßãÊäΩÁâå</button>
                    </div>
                    <div id="lenormand-result" style="display:none;"></div>
                </div>
                <div class="modal-buttons" style="margin-top:12px;">
                    <button class="modal-btn modal-btn-secondary" id="lenormand-reset-btn" onclick="resetLenormand()" style="display:none;">ÈáçÊñ∞Âç†Âçú</button>
                    <button class="modal-btn modal-btn-secondary" id="close-lenormand">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </div>
    <div id="fortune-modal" style="display:none;"></div>

    <div id="lenormand-modal" style="display:none;"></div>


    <div class="modal" id="mood-modal">
       <div class="modal-content">
        <div class="mood-header-actions">
            <div class="modal-title" style="margin-bottom:0; border:none; padding:0;">
                <i class="fas fa-book-open"></i><span>ÂøÉÊô¥ÊâãÂ∏ê</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="view-switch-btn active" id="btn-view-calendar">
                    <i class="fas fa-calendar-alt"></i> Êó•ÂéÜ
                </button>
                <button class="view-switch-btn" id="btn-view-stats">
                    <i class="fas fa-chart-pie"></i> ÁªüËÆ°
                </button>
            </div>
        </div>
        <div id="mood-calendar-view" class="mood-view-section">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month-label" id="calendar-month-label">--</div>
                <button class="calendar-nav-btn" id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>Êó•</div><div>‰∏Ä</div><div>‰∫å</div><div>‰∏â</div><div>Âõõ</div><div>‰∫î</div><div>ÂÖ≠</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    
        <div id="mood-stats-view" class="mood-view-section hidden-view">
            <div id="mood-stats-container" class="mood-stats-card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            </div>
        </div>
    
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-mood">ÂÖ≥Èó≠</button>
        </div>
       </div>
    </div>

    <div class="mood-selector-overlay" id="mood-selector-overlay">
        <div class="mood-selector-card" id="mood-editor-view">
            <h3 id="mood-selector-date">--Êúà--Êó•</h3>
            
            <div id="mood-edit-target-tabs" style="display:flex; gap:6px; justify-content:center; margin:8px 0 4px;">
                <button class="mood-tab-btn active" id="mood-tab-me" onclick="switchMoodEditTarget('me')" data-name-me>ÊàëÁöÑËÆ∞ÂΩï</button>
                <button class="mood-tab-btn" id="mood-tab-partner" onclick="switchMoodEditTarget('partner')" data-name-partner>Ê¢¶ËßíÁöÑËÆ∞ÂΩï</button>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 4px;">
                <button class="mood-page-btn" id="mood-page-prev" onclick="switchMoodPage(-1)">&#8249;</button>
                <span id="mood-page-indicator" style="font-size:12px; opacity:0.7;">Á¨¨ 1 È°µ ¬∑ ÂøÉÊÉÖ</span>
                <button class="mood-page-btn" id="mood-page-next" onclick="switchMoodPage(1)">&#8250;</button>
            </div>

            <div id="mood-page-1">
                <div class="mood-options-slider-wrapper">
                    <div class="mood-options-grid" id="mood-options-grid"></div>
                </div>
                <button class="mood-custom-add-btn" id="mood-custom-add" onclick="openCustomMoodDialog()">
                    <i class="fas fa-plus"></i> Ëá™ÂÆö‰πâÂøÉÊÉÖ
                </button>
            </div>

            <div id="mood-page-2" style="display:none;">
                <div class="mood-input-wrapper">
                    <label style="font-size:12px; font-weight:500;" id="mood-note-label">ÈöèËÆ∞:</label>
                    <textarea id="mood-note-input" class="mood-note-input" rows="3" placeholder="ËÆ∞ÂΩï‰∏ã‰ªäÂ§©ÂèëÁîüÁöÑÂ∞è‰∫ã..."></textarea>
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:12px; font-weight:500; display:flex; align-items:center; gap:5px; margin-bottom:6px;" id="mood-weather-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        ‰ªäÊó•Â§©Ê∞î&nbsp;
                    </label>
                    <input type="text" id="mood-weather-input" maxlength="20" placeholder="‰æãÂ¶ÇÔºöÊô¥Êúó / Èò¥Â§© / Â∞èÈõ®..." style="width:100%; padding:9px 14px; border:1px solid var(--border-color); border-radius:10px; font-size:13px; background:var(--primary-bg); color:var(--text-primary); outline:none; font-family:var(--font-family);">
                </div>
            </div>
    
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="modal-btn modal-btn-secondary" id="cancel-mood-edit" style="flex:1;">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-secondary" id="view-mood-detail-btn" onclick="viewMoodDetailFromEditor()" style="flex:1;">Êü•ÁúãËØ¶ÊÉÖ</button>
                <button class="modal-btn modal-btn-primary" id="confirm-mood-save" style="flex:1;">‰øùÂ≠ò</button>
            </div>
        </div>

        <div id="custom-mood-dialog" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--secondary-bg); padding:20px; border-radius:16px; width:80%; max-width:280px; z-index:2200; box-shadow:0 10px 30px rgba(0,0,0,0.3); text-align:center;">
            <h4 style="margin-bottom:12px; font-size:14px;">Ëá™ÂÆö‰πâÂøÉÊÉÖ</h4>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input id="custom-mood-emoji" type="text" maxlength="2" placeholder="Ë°®ÊÉÖ" style="width:60px; text-align:center; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:20px; background:var(--primary-bg); color:var(--text-primary);">
                <input id="custom-mood-label" type="text" maxlength="6" placeholder="ÂêçÁß∞ÔºàÊúÄÂ§ö6Â≠óÔºâ" style="flex:1; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:13px; background:var(--primary-bg); color:var(--text-primary);">
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;">
                <span style="font-size:11px; opacity:0.6; width:100%;">ÈÄâÊã©È¢úËâ≤:</span>
                <div id="custom-mood-colors" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="modal-btn modal-btn-secondary" onclick="closeCustomMoodDialog()" style="flex:1; font-size:12px;">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-primary" onclick="saveCustomMood()" style="flex:1; font-size:12px;">Ê∑ªÂä†</button>
            </div>
        </div>
    
        <div class="day-detail-card" id="mood-detail-view" style="display:none; width:85%; max-width:320px;">
            <div class="day-detail-date" id="detail-date">--</div>
            <div id="detail-my-section" style="margin-bottom:12px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;">ÊàëÁöÑ</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-text"></div>
                <div id="detail-my-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-my-weather-val"></span></div>
            </div>
                <div id="detail-partner-section" style="border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;" id="detail-partner-title">Ê¢¶ËßíÁöÑ</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-partner-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-partner-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-partner-text"></div>
                <div id="detail-partner-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-partner-weather-val"></span></div>
            </div>
            <div id="detail-partner-no-record" style="display:none; border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px; font-size:13px; color:var(--text-secondary); font-style:italic; text-align:center;" id="detail-partner-no-record-msg">Ta ËøôÂ§©ËøòÊ≤°ÊúâÁïô‰∏ãËÆ∞ÂΩï</div>
            <div style="margin-top:20px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="modal-btn modal-btn-secondary" onclick="closeMoodOverlay()" style="font-size:12px; padding:6px 12px;">ÂÖ≥Èó≠</button>
                <button class="modal-btn modal-btn-secondary" id="delete-my-mood" onclick="deleteDailyMood(selectedDateStr,'me')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-me>Âà†Èô§ÊàëÁöÑ</button>
                <button class="modal-btn modal-btn-secondary" id="delete-partner-mood" onclick="deleteDailyMood(selectedDateStr,'partner')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-partner>Âà†Èô§Ê¢¶Ëßí</button>
                <button class="modal-btn modal-btn-primary" id="edit-existing-mood" style="font-size:12px; padding:6px 12px;">‰øÆÊîπÊàëÁöÑ</button>
                <button class="modal-btn modal-btn-primary" id="edit-partner-mood" onclick="editPartnerMoodRecord()" style="font-size:12px; padding:6px 12px; background:rgba(255,107,107,0.8);" data-edit-partner>‰øÆÊîπÊ¢¶Ëßí</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="theme-editor-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-palette"></i><span>‰∏ªÈ¢òÁºñËæëÂô®</span></div>
            <div class="theme-editor-toolbar">
                <select id="theme-preset-selector" style="flex:1;"></select>
                <button id="overwrite-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px; display:none;" title="Ë¶ÜÁõñ‰øùÂ≠òÂΩìÂâçÊñπÊ°à"><i class="fas fa-check"></i></button>
                <button id="save-theme-preset-btn" class="modal-btn modal-btn-primary" style="padding: 8px 10px;" title="Âè¶Â≠ò‰∏∫Êñ∞ÊñπÊ°à"><i class="fas fa-save"></i></button>
                <button id="rename-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="ÈáçÂëΩÂêçÂΩìÂâçÊñπÊ°à"><i class="fas fa-pen"></i></button>
                <button id="delete-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="Âà†Èô§ÂΩìÂâçÊñπÊ°à"><i class="fas fa-trash"></i></button>
            </div>
            <div id="theme-editor-grid" class="theme-editor-grid">
            </div>
            <div class="modal-buttons" style="margin-top:12px;">
                <button class="modal-btn modal-btn-primary" id="apply-close-theme-editor" style="flex:2;" onclick="document.getElementById('close-theme-editor').click()"><i class="fas fa-check" style="margin-right:5px;"></i>Â∫îÁî®Âπ∂ÂÖ≥Èó≠</button>
                <button class="modal-btn modal-btn-secondary" id="close-theme-editor">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">
            <div class="modal-sidebar">
                <button class="sidebar-btn active" data-major="reply">
                    <i class="fas fa-comment-dots"></i>
                    <span>ÂõûÂ§çÂ∫ì</span>
                </button>
                <button class="sidebar-btn" data-major="atmosphere">
                    <i class="fas fa-magic"></i>
                    <span>Ê∞õÂõ¥ÊÑü</span>
                </button>
                <button class="sidebar-btn" data-major="announcement" onclick="switchToAnnouncementPanel()">
                    <i class="fas fa-newspaper"></i>
                    <span>ÂÖ¨Âëä</span>
                </button>
            </div>
    
            <div class="modal-main-view">
                <div class="modal-title" style="padding: 15px 20px; font-size: 16px;">
                    <i class="fas fa-layer-group"></i> <span id="cr-modal-title">ÂÜÖÂÆπÁÆ°ÁêÜ</span>
                </div>
    
                <div class="reply-tabs" id="cr-sub-tabs">
                </div>
    
                <div class="reply-toolbar" id="cr-toolbar">
                    <input type="text" class="reply-search" id="reply-search-input" placeholder="ÊêúÁ¥¢...">
                    <button class="reply-tool-btn" id="import-replies-btn" title="ÂØºÂÖ•"><i class="fas fa-file-import"></i></button>
                    <button class="reply-tool-btn" id="export-replies-btn" title="ÂØºÂá∫"><i class="fas fa-file-export"></i></button>
                </div>
    
                <div class="content-list-area" id="custom-replies-list">
                </div>

                <!-- ‰ªäÊó•ÂÖ¨ÂëäÁºñËæëÈù¢Êùø -->
                <div id="announcement-panel" style="display:none; padding:0 16px 80px; overflow-y:auto; flex:1; min-height:0; -webkit-overflow-scrolling:touch;">
                    <div style="display:flex;flex-direction:column;gap:12px; padding:4px 0 16px;">
                        <div style="background:linear-gradient(135deg,rgba(var(--accent-color-rgb),0.12),rgba(var(--accent-color-rgb),0.05));border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.2);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>È°∂ÈÉ®ËÉåÊôØÂõæ</div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="document.getElementById('dg-header-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    ‰∏ä‰º†È°∂ÈÉ®ËÉåÊôØ
                                </button>
                                <button onclick="clearDgHeaderBg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">Ê∏ÖÈô§</button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>‰∏≠ÈÉ®Ë£ÖÈ•∞Âõæ</div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button onclick="document.getElementById('dg-deco-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    ‰∏ä‰º†Ë£ÖÈ•∞Âõæ
                                </button>
                                <button onclick="clearDgDecoImg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">Ê∏ÖÈô§</button>
                            </div>
                            <input type="file" id="dg-deco-img-input" accept="image/*" style="display:none">
                            <div id="dg-deco-preview" style="margin-top:8px;display:none;border-radius:10px;overflow:hidden;">
                                <img id="dg-deco-preview-img" src="" style="width:100%;max-height:100px;object-fit:cover;display:block;">
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-edit" style="margin-right:6px;"></i>ÂÖ¨ÂëäÊñáÊ°à</div>
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">ÂÖ¨ÂëäÊ†áÈ¢ò <span style="opacity:0.6;">ÔºàÊØèË°å‰∏ÄÊù°ÔºåÈöèÊú∫ÊòæÁ§∫Ôºâ</span></label>
                                    <textarea id="dg-edit-title" rows="4" placeholder="ÊØèË°å‰∏ÄÊù°ÔºåÂ¶ÇÔºö&#10;Êó©‰∏äÂ•Ω&#10;‰∏ÉÂ§ïÂø´‰πê&#10;ÊÄùÂøµ‰Ω†" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">ÊØèÊó•ÂØÑËØ≠ <span style="opacity:0.6;">ÔºàÊØèË°å‰∏ÄÊù°ÔºåÈöèÊú∫ÊòæÁ§∫Ôºâ</span></label>
                                    <textarea id="dg-edit-note" rows="5" placeholder="ÊØèË°å‰∏ÄÊù°ÔºåÂ¶ÇÔºö&#10;‰ªäÂ§©‰πüË¶ÅÂÖÉÊ∞îÊª°Êª°ÔºåÊàëÂú®ËøôÈáåÈô™ÁùÄ‰Ω† ‚ú¶&#10;ÊÉ≥‰Ω†‰∫ÜÔºå‰Ω†ÊúâÊ≤°ÊúâÂú®ÊÉ≥ÊàëÂë¢" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <button onclick="saveDailyGreetingCustom()" style="width:100%;padding:11px;background:var(--accent-color);color:white;border:none;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font-family);">
                                    <i class="fas fa-save" style="margin-right:6px;"></i>‰øùÂ≠òÂÖ¨ÂëäÂÜÖÂÆπ
                                </button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-random" style="margin-right:6px;"></i>Áä∂ÊÄÅÈöèÊú∫Â∫ì</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;line-height:1.5;">ÊØèÊ¨°ÊâìÂºÄÂÖ¨ÂëäÊó∂ÔºåÁä∂ÊÄÅ„ÄÅËã±ÊñáÊ†áÁ≠æ„ÄÅÂõæÊ†áÂ∞Ü‰ªé‰∏ãÊñπÈöèÊú∫ÊäΩÂèñ‰∏ÄÊù°„ÄÇ</div>
                            <div id="ann-status-pool-list" style="display:flex;flex-direction:column;gap:7px;margin-bottom:12px;max-height:200px;overflow-y:auto;"></div>
                            <div style="display:flex;flex-direction:column;gap:7px;">
                                <input type="text" id="ann-status-pool-input" placeholder="Áä∂ÊÄÅÊñáÊ°àÔºåÂ¶ÇÔºöÂú®ÊÉ≥‰Ω†" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <input type="text" id="ann-status-label-input" placeholder="Ëã±ÊñáÊ†áÁ≠æÔºåÂ¶ÇÔºöMISSING YOU" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <div style="display:flex;gap:7px;align-items:center;">
                                    <div style="position:relative;flex:1;">
                                        <input type="text" id="ann-status-icon-input" placeholder="ÂõæÊ†á emoji ÊàñÁïôÁ©∫" style="width:100%;padding:9px 36px 9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);box-sizing:border-box;">
                                        <button onclick="document.getElementById('ann-icon-img-input').click()" title="‰∏ä‰º†ÂõæÁâáÂõæÊ†á" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:22px;height:22px;background:rgba(var(--accent-color-rgb),0.15);border:none;border-radius:6px;cursor:pointer;font-size:10px;color:var(--accent-color);display:flex;align-items:center;justify-content:center;padding:0;"><i class="fas fa-image"></i></button>
                                        <input type="file" id="ann-icon-img-input" accept="image/*" style="display:none" onchange="handleAnnStatusIconUpload(this)">
                                    </div>
                                    <button onclick="addAnnStatusPoolItem()" style="padding:9px 18px;background:var(--accent-color);color:white;border:none;border-radius:9px;cursor:pointer;font-size:13px;font-weight:600;flex-shrink:0;font-family:var(--font-family);letter-spacing:0.5px;">Ê∑ªÂä†</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-primary" id="add-custom-reply" style="flex: 1;">
                        <i class="fas fa-plus"></i> Êñ∞Â¢û
                    </button>
                    <button class="modal-btn modal-btn-secondary" id="close-custom-replies">ÂÖ≥Èó≠</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-replies-input" accept=".json" style="display: none;">
    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">
    <input type="file" id="sticker-file-input" class="file-input" accept="image/*" multiple>

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">
                <div class="coin-face coin-front">
                    <div class="coin-text-main">ÊòØ</div>
                    <div class="coin-text-sub">YES</div>
                </div>
                <div class="coin-face coin-back">
                    <div class="coin-text-main">Âê¶</div>
                    <div class="coin-text-sub">NO</div>
                </div>
            </div>
        </div>
        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>
        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">ÂèñÊ∂à</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> ÂÜçÊù•‰∏ÄÊ¨°</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">ÂèëÈÄÅÁªìÊûú</button>
        </div>
    </div>

    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-scroll"></i><span>ÂÖ≥‰∫é & Â£∞Êòé</span>
            </div>
            <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <h3 style="color: var(--accent-color); margin-bottom: 10px;">ÁâπÂà´È∏£Ë∞¢</h3>
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                        <p style="margin: 5px 0; color: var(--text-primary);">
                            ÂèÇËÄÉ‰∫Ü <strong>BÁ´ô @molina-3- ÁöÑ‰º†ËÆØÁΩëÁ´ô</strong>
                        </p>
                        <p style="margin: 5px 0; font-weight: bold; color: #e53935;">
                            Â¶ÇÊûúÈúÄË¶ÅÊõ¥Â•ΩÁöÑÊ≤üÈÄö‰ΩìÈ™å ËØ∑ÊîØÊåÅÂì¶ÔºÅ
                        </p>
                    </div>
                    <p>ÊÑüË∞¢ <strong>@ËãèÈìÇÊΩº</strong></p>
                    <p style="font-size: 12px; opacity: 0.8;">Â∞èÁ∫¢‰π¶Âè∑Ôºö9568228497</p>
                    <p style="font-size: 12px; margin-top: 5px; font-style: italic;">(ËÅäÂ§©ÁªüËÆ°ÈÉ®ÂàÜ‰ª£Á†ÅÂèÇËÄÉ)</p>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: bold; color: var(--text-primary); text-align: center;">
                        ÂéüÂàõÔºöÂ∞èÁ∫¢‰π¶ @milk (1149615009)
                    </p>
                    <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">
                        Ê≠§‰ª£Á†ÅÁªùÂØπÁ¶ÅÊ≠¢ÂïÜÁî®ÂíåÁõàÂà©Ë°å‰∏∫Ôºå‰∏ÄÊó¶ÂèëÁé∞ËøΩÁ©∂Âà∞Â∫ï
                    </p>
                    <p style="text-align: center; margin-bottom: 15px;">ÊîØÊåÅ‰∫åÊîπ‰∫å‰º†ÔºåÊÑüË∞¢‰ΩøÁî®ÔºÅ</p>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>ÂèçÂØπÊÄßÂà´Êö¥Âäõ</b></li>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>Â∞äÈáç‰∏çËØ•ÊòØÂ•¢Ê±Ç,ÂÆâÂÖ®ÂøÖÈ°ªÊòØÂ∫ïÁ∫ø</b></li>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="accept-disclaimer" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div class="modal" id="anniversary-modal">
        <div class="modal-content">
            <div class="ann-header-card" id="ann-header-card" style="display: none;">
                <div class="ann-header-card-bg" id="ann-header-card-bg"></div>
                <div class="ann-header-card-overlay" id="ann-header-card-overlay"></div>
                <input type="file" id="ann-header-bg-input" accept="image/*" style="display:none;">
                <div class="ann-header-card-inner">
                    <span class="ann-header-icon" id="ann-header-icon">‚ù§Ô∏é</span>
                    <span class="ann-header-label" id="ann-header-label">ANNIVERSARY</span>
                    <div class="ann-header-title" id="ann-header-title">Á∫™ÂøµÊó•</div>
                    <div class="ann-header-days" id="ann-header-days">0<span class="ann-header-days-unit">Â§©</span></div>
                    <div class="ann-header-date" id="ann-header-date">--/--</div>
                    <div class="ann-header-milestones" id="ann-header-milestones"></div>
                </div>
            </div>
            <div id="ann-card-toolbar" style="display:none; padding:6px 14px 2px; align-items:center; justify-content:flex-end; gap:8px;">
                <button class="ann-header-upload-btn" onclick="document.getElementById('ann-header-bg-input').click()" title="Êõ¥Êç¢ËÉåÊôØÂõæ" style="position:static; background:rgba(var(--accent-color-rgb),0.1); border-color:rgba(var(--accent-color-rgb),0.3); color:var(--accent-color);">
                    <i class="fas fa-image"></i> Êõ¥Êç¢Â∞ÅÈù¢
                </button>
                <button class="ann-header-upload-btn" onclick="clearAnnCardBg()" title="Ê∏ÖÈô§ËÉåÊôØÂõæ" style="position:static; background:rgba(var(--accent-color-rgb),0.05); border-color:rgba(var(--accent-color-rgb),0.2); color:var(--text-secondary);">
                    <i class="fas fa-times"></i> Ê∏ÖÈô§
                </button>
            </div>
    
            <div class="ann-list-container" id="ann-list-container">
            </div>
    
            <div class="ann-footer">
                <button class="modal-btn modal-btn-secondary" id="close-anniversary-modal">ÂÖ≥Èó≠</button>
                <button class="modal-btn modal-btn-primary" id="open-ann-add-btn" style="flex: 1;">
                    <i class="fas fa-plus"></i> Êñ∞Â¢ûÁ∫™ÂøµÊó•
                </button>
            </div>
    
            <div class="ann-editor-slide" id="ann-editor-slide">
                <div class="ann-editor-header">
                    <button class="ann-back-btn" id="close-ann-editor"><i class="fas fa-arrow-left"></i></button>
                    <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M12 5v14M5 12h14"/></svg> Ê∑ªÂä†Á∫™ÂøµÊó•</span>
                </div>
                
                <div class="ann-editor-content">
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-tag"></i>Ê†áÈ¢òÂêçÁß∞</label>
                        <input type="text" class="modal-input" id="ann-input-name" placeholder="‰æãÂ¶ÇÔºöÊÅãÁà±Á∫™ÂøµÊó•„ÄÅÊ¢¶ËßíÁîüÊó•">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-calendar-alt"></i>ÈÄâÊã©Êó•Êúü</label>
                        <input type="date" class="modal-input" id="ann-input-date">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-th-large"></i>Á±ªÂûã</label>
                        <div class="ann-type-selector">
                            <div class="ann-type-btn active" data-type="anniversary" onclick="switchAnnType('anniversary')">
                                <i class="fas fa-heart"></i>
                                <span>Á∫™ÂøµÊó•</span>
                                <span class="ann-type-hint">ËøáÂéª ‚Üí ‰ªäÂ§©</span>
                            </div>
                            <div class="ann-type-btn" data-type="countdown" onclick="switchAnnType('countdown')">
                                <i class="fas fa-hourglass-half"></i>
                                <span>ÂÄíÊï∞Êó•</span>
                                <span class="ann-type-hint">‰ªäÂ§© ‚Üí Êú™Êù•</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; opacity: 0.7; padding: 0 2px;">
                            <span id="ann-type-desc">ËÆ°ÁÆó‰ªéËøáÂéªÊüê‰∏ÄÂ§©Âà∞Áé∞Âú®Â∑≤ÁªèËøá‰∫ÜÂ§öÂ∞ëÂ§©</span>
                        </div>
                    </div>
    
                    <button class="modal-btn modal-btn-primary" id="save-ann-btn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-check"></i> ‰øùÂ≠ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">
                Á∫™ÂøµÊó•Âø´‰πêÔºÅ
            </div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">
                0
            </div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">
                Êàë‰ª¨Â∑≤ÁªèÁõ∏‰º¥‰∫ÜËøô‰πàÂ§öÂ§©
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <div class="modal" id="decision-menu-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-balance-scale"></i><span>ÊäâÊã©Âä©Êâã</span>
            </div>
            <div class="decision-menu-grid">
                <div class="decision-option-card" id="open-coin-toss">
                    <i class="fas fa-coins"></i>
                    <h3>ÊäõÁ°¨Â∏Å</h3>
                    <p>ÊòØ / Âê¶ ‰∫åÂÖÉÈÄâÊã©</p>
                </div>
                <div class="decision-option-card" id="open-wheel">
                    <i class="fas fa-magic"></i>
                    <h3>ÈöèÊú∫ÊäΩÁ≠æ</h3>
                    <p>Ëá™ÂÆö‰πâÈÄâÈ°πÈöèÊú∫ÊäΩÂèñ</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-decision-menu">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="wheel-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-magic"></i><span>ÈöèÊú∫ÊäΩÁ≠æ</span>
            </div>
            
            <div class="picker-wrapper">
                <div class="picker-box-stage">
                    <div class="picker-cards-row" id="picker-cards-row"></div>
                    <div class="picker-result-text" id="wheel-result"></div>
                </div>
                <div class="picker-controls">
                    <div class="picker-options-label">ÈÄâÈ°πÂàóË°®ÔºàËá≥Â∞ë 2 È°πÔºâ</div>
                    <div class="picker-options-list" id="wheel-options-list"></div>
                    <button class="modal-btn modal-btn-secondary picker-add-btn" id="add-wheel-option">
                        <i class="fas fa-plus"></i> Ê∑ªÂä†ÈÄâÈ°π
                    </button>
                </div>
            </div>
    
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-wheel">ÂÖ≥Èó≠</button>
                <button class="modal-btn modal-btn-primary" id="spin-wheel-btn"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 12a10 10 0 0 1 18.8-3.6M22 12a10 10 0 0 1-18.8 3.6"/></svg> ÂºÄÂßãÊäΩÁ≠æ</button>
                <button class="modal-btn modal-btn-primary" id="send-wheel-result" style="display:none;">ÂèëÈÄÅÁªìÊûú</button>
            </div>
        </div>
    </div>

    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="ÁÇπÂáªÂ±ïÂºÄ">
            <div class="vinyl-record" id="vinyl-record-visual">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z" /></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="Êî∂Ëµ∑">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
            </div>
            <button id="upload-cover-btn" style="position: absolute; top: 12px; left: 15px; background: none; border: 1px dashed var(--border-color); color: var(--text-secondary); cursor: pointer; opacity: 0.7; z-index: 10; width: 24px; height: 24px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px;" title="Êõ¥Êç¢‰∏ìËæëÂ∞ÅÈù¢">
                <i class="fas fa-camera"></i>
            </button>
            <input type="file" id="cover-input" accept="image/*" style="display: none;">
            <div class="track-info">
                <div class="track-name" id="music-title">Loading...</div>
                <div class="track-sub" id="music-subtitle">...</div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="ÂàáÊç¢Ê®°Âºè">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" /></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" /></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" /></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>

    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-music"></i><span>Ê∑ªÂä†Ëá™ÂÆö‰πâÊ≠åÊõ≤</span>
            </div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="Ê≠åÊõ≤ÂêçÁß∞ (‰æãÂ¶Ç: ËøôÈáåÁöÑÈ£éÊôØ)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="Ê≠åÊâã/Â§áÊ≥® (‰æãÂ¶Ç: ‰Ω†ÁöÑÂêçÂ≠ó)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="Èü≥È¢ëÈìæÊé• (mp3/m4a ÈìæÊé•)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">ÂèñÊ∂à</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">Ê∑ªÂä†Êí≠Êîæ</button>
            </div>
        </div>
    </div>

    <script>
        const APP_PREFIX = 'CHAT_APP_V3_';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        const MAX_AVATAR_SIZE = 2 * 1024 * 1024;
        const MESSAGES_PER_PAGE = 50;
        
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.error('Error getting item:', e);
                return null;
            }
        }

        function safeSetItem(key, value) {
            try {
                if (typeof value === 'object') {
                    value = JSON.stringify(value);
                }
                localStorage.setItem(key, value);
            } catch (e) {
                console.error('Error setting item:', e);
            }
        }

        function safeRemoveItem(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Error removing item:', e);
            }
        }

        function cropImageToSquare(file, maxSize = 640) { 
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const minSide = Math.min(img.width, img.height);
                        const sx = (img.width - minSide) / 2;
                        const sy = (img.height - minSide) / 2;

                        const canvas = document.createElement('canvas');
                        canvas.width = maxSize;
                        canvas.height = maxSize;
                        const ctx = canvas.getContext('2d');

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, maxSize, maxSize);

                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        const CONSTANTS = {
            HEADER_MOTTOS: [
                "‚ãÜ‚Å∫‚Çä‚ãÜ ‚òæ ‚ãÜ‚Å∫‚Çä‚ãÜ ÊÄùÂøµÁöÑÁîµÊ≥¢Â∑≤ËøûÊé• ‚ãÜ‚Å∫‚Çä‚ãÜ ‚òæ ‚ãÜ‚Å∫‚Çä‚ãÜ",
                "Êàë‰ª¨ÊòØÂΩºÊ≠§ÁöÑÂÆáÂÆôÂõûÂìç",
                "ÊâÄÊúâÊÄùÁª™ÔºåÈÉΩÂ•îÂêë‰Ω†",
                "Á≠îÊ°àÂæàÈïøÔºåÊàëÂáÜÂ§áÁî®‰∏ÄÁîüÊù•ÂõûÁ≠î",
                "ÊúàËâ≤ÁúüÁæé",
                "‰∏ÄÊúü‰∏Ä‰ºö",
                "ÂøµÂøµ‰∏çÂøòÔºåÂøÖÊúâÂõûÂìç",
                "Â±±ÊúâÊú®ÂÖÆÊú®ÊúâÊûù",
                "‰ªäÊôöÊúàËâ≤ÁúüÁæé",
                "Êò•È£éÂçÅÈáå‰∏çÂ¶Ç‰Ω†",
                "ÂøÉÊúâÁåõËôéÔºåÁªÜÂóÖËî∑Ëñá",
                "‰∫∫Èó¥ÊúâÂë≥ÊòØÊ∏ÖÊ¨¢",
                "ÊñØ‰∫∫Ëã•ÂΩ©ËôπÔºåÈÅá‰∏äÊñπÁü•Êúâ",
                "You are my sunshine",
                "I love you three thousand",
                "What is essential is invisible to the eye",
                "Carpe diem",
                "To be or not to be",
                "Ê∞∏ÈÅ†„ÅÆ‰∏ÄÁû¨",
                "Âêõ„ÅÆÂêç„ÅØ",
                "‰∏ñÁïå„ÅåÁµÇ„Çè„Çã„Åæ„Åß„ÅØ",
                "„Åï„Çà„ÅÜ„Å™„Çâ„ÄÅ„ÅÇ„Çä„Åå„Å®„ÅÜ",
                "Âêõ„Å®‰ºö„Åà„Å¶„Çà„Åã„Å£„Åü",
                "‰∫∫ÁîüËã•Âè™Â¶ÇÂàùËßÅ",
                "ÂΩìÊó∂Âè™ÈÅìÊòØÂØªÂ∏∏",
                "ÊõæÁªèÊ≤ßÊµ∑Èöæ‰∏∫Ê∞¥",
                "Ê≠§ÊÉÖÂèØÂæÖÊàêËøΩÂøÜ",
                "‰ººÊ≠§ÊòüËæ∞ÈùûÊò®Â§ú",
                "The best is yet to come",
                "All you need is love",
                "Let it be",
                "Here comes the sun",
                "Yesterday once more",
                "Êò•„ÅØ„ÅÇ„Åë„Åº„ÅÆ",
                "Áâ©„ÅÆÂìÄ„Çå",
                "„Çè„Å≥„Åï„Å≥",
                "Ëä±„ÅØÊ°úÊú®‰∫∫„ÅØÊ≠¶Â£´",
                "‰∏ÄÊúü‰∏Ä‰ºö",
                "Â±±ÊúâÊú®ÂÖÆÊú®ÊúâÊûù",
                "ÂøÉÊÇ¶ÂêõÂÖÆÂêõ‰∏çÁü•",
                "È£éËµ∑‰∫éÈùíËêç‰πãÊú´",
                "‰∫ëÂç∑‰∫ëËàí",
                "Ëä±ÂºÄËä±ËêΩ",
                "ÊúàÂúÜÊúàÁº∫",
                "ÊΩÆËµ∑ÊΩÆËêΩ",
                "ÂøÉÊúâÁÅµÁäÄ‰∏ÄÁÇπÈÄö",
                "Ë®ÄÊúâÂ∞ΩËÄåÊÑèÊó†Á©∑",
                "È£é‰πçËµ∑ÔºåÂêπÁö±‰∏ÄÊ±†Êò•Ê∞¥",
                "‰∫ëÊó†ÂøÉ‰ª•Âá∫Â≤´",
                "Ëä±Ëá™È£òÈõ∂Ê∞¥Ëá™ÊµÅ",
                "ÊúàÊòØÊïÖ‰π°Êòé",
                "ÊΩÆÂπ≥‰∏§Â≤∏Èòî",
                "ÂøÉÊúâÂçÉÂçÉÁªì",
                "Ë®Ä‰∏çÂ∞ΩÊÑè",
                "Ê≠§Êó∂Ê≠§Â§úÈöæ‰∏∫ÊÉÖ",
                "Ê¨≤ËØ≠Ê≥™ÂÖàÊµÅ",
                "ÂçÉÂ±±‰∏áÊ∞¥",
                "È£éËêßËêßÂÖÆÊòìÊ∞¥ÂØí",
                "‰∫ëÊ∑°È£éËΩª",
                "Ëä±Â•ΩÊúàÂúÜ",
                "ÊúàËêΩ‰πåÂïºÈúúÊª°Â§©",
                "ÊΩÆËêΩÂ§úÊ±üÊñúÊúàÈáå",
                "ÂøÉ‰πãÊâÄÂêëÔºåÁ¥†Â±•‰ª•ÂæÄ",
                "Ë®Ä‰∏∫ÂøÉÂ£∞",
                "Ê≠§ÊÉÖÂèØÂæÖÊàêËøΩÂøÜ",
                "Ê¨≤Á©∑ÂçÉÈáåÁõÆ",
                "ÂçÉÈáåÂÖ±Â©µÂ®ü"
            ],
            WELCOME_ANIMATIONS: [{
                line1: "‚ô° Áà± ‚ô°",
                line2: "‚úß Ê≠£Âú®ËøûÊé•Êàë‰ª¨ÁöÑÊÄùÁª™ ‚úß"
            },
                {
                    line1: "ùë≥ùíêùíóùíÜ",
                    line2: "Ëã•Ë¶ÅÁî±ÊàëÊù•Ë∞àËÆ∫Áà±ÁöÑËØù"
                },
                {
                    line1: "ùï∞ùñàùñçùñî",
                    line2: "Âê¨ËßÅÊàëÁöÑÂõûÈü≥‰∫ÜÂêóÔºü"
                },
                {
                    line1: "ùöÇùöòùöûùöïùöñùöäùöùùöé",
                    line2: "ÁÅµÈ≠ÇÊ≠£Âú®ÂÖ±ÊåØ"
                },
                {
                    line1: "Akashic Eye",
                    line2: "ÈìæÊé•Â∑≤Âª∫Á´ã"
                },
                {
                    line1: "‚ú¶ Áõ∏ÈÅá ‚ú¶",
                    line2: "Âú®‰∏áÂçÉ‰∫∫Êµ∑‰∏≠ÈÅáËßÅ‰Ω†"
                },
                {
                    line1: "Ë©©ÁØá",
                    line2: "‰∏∫‰Ω†ÂÜô‰∏ãÁöÑÊØè‰∏ÄË°åËØó"
                },
                {
                    line1: "Melody",
                    line2: "ÂøÉË∑≥ÁöÑÊóãÂæã‰∏∫‰Ω†Â•èÂìç"
                },
                {
                    line1: "Destiny",
                    line2: "ÂëΩËøêÁöÑÁ∫¢Á∫øÂ∞ÜÊàë‰ª¨Áõ∏Ëøû"
                },
                {
                    line1: "Memory",
                    line2: "ÂàõÈÄ†Â±û‰∫éÊàë‰ª¨ÁöÑÂõûÂøÜ"
                },
                {
                    line1: "Ë®ÄËëâ",
                    line2: "ÊÉ≥‰º†ËææÁªô‰Ω†ÁöÑËØùËØ≠"
                },
                {
                    line1: "ÁµÜ",
                    line2: "Áúã‰∏çËßÅÁöÑÁæÅÁªä"
                },
                {
                    line1: "Êú™Êù•",
                    line2: "‰∏ÄËµ∑Ëµ∞ÂêëÁöÑÊú™Êù•"
                },
                {
                    line1: "Â∏åÊúõ",
                    line2: "‰Ω†Â∞±ÊòØÊàëÁöÑÂ∏åÊúõ"
                },
                {
                    line1: "ÂÖâ",
                    line2: "‰Ω†ÊòØÊàëÁîüÂëΩ‰∏≠ÁöÑÂÖâ"
                },
                {
                    line1: "Amore",
                    line2: "ÂøÉË∑≥ÊºèÊãçÁöÑÈÇ£‰∏ÄÁßí"
                },
                {
                    line1: "ÂÖ±ÊåØ",
                    line2: "È¢ëÁéáÁõ∏ÂêåÁöÑ‰∏§‰∏™ÁÅµÈ≠Ç"
                },
                {
                    line1: "‚àû",
                    line2: "Êó†ÈôêÂæ™ÁéØÁöÑÊÄùÂøµ"
                },
                {
                    line1: "Serendipity",
                    line2: "ÊúÄÁæé‰∏ΩÁöÑÊÑèÂ§ñ"
                },
                {
                    line1: "ÊµÆ‰∏ñ",
                    line2: "Ê≤âÊµÆ‰∫∫‰∏ñÈó¥ÁöÑÊ∏©Êüî"
                },
                {
                    line1: "ÈáèÂ≠êÁ∫†Áº†",
                    line2: "Ë∂ÖË∂äË∑ùÁ¶ªÁöÑÈªòÂ•ë"
                },
                {
                    line1: "Elysian",
                    line2: "‰∏é‰Ω†ÂÖ±Â∫¶ÁöÑÁêÜÊÉ≥‰π°"
                },
                {
                    line1: "ÊòüËΩ®",
                    line2: "‰∫§Ê±áÊó∂‰∫íÊîæÁöÑÂÖâ‰∫Æ"
                },
                {
                    line1: "ËôπËâ≤",
                    line2: "ÊäòÂ∞ÑÂá∫ÊâÄÊúâÁöÑÂèØËÉΩ"
                },
                {
                    line1: "Paracosm",
                    line2: "ÂÖ±ÂêåÊûÑÂª∫ÁöÑÁßÅÂÆáÂÆô"
                },
                {
                    line1: "ÊΩÆÊ±ê",
                    line2: "Âõ†‰Ω†ËÄåËµ∑ÁöÑÂæãÂä®"
                },
                {
                    line1: "√Üther",
                    line2: "Âº•Êº´Âú®Á©∫Ê∞î‰∏≠ÁöÑÊÇ∏Âä®"
                },
                {
                    line1: "ÂèåÊòü",
                    line2: "ÂΩºÊ≠§ÁéØÁªïÁöÑÊ∞∏ÊÅíËàûËπà"
                },
                {
                    line1: "ÁªØËâ≤",
                    line2: "Êüì‰∏äËÑ∏È¢äÁöÑÊ∏©Â∫¶"
                },
                {
                    line1: "Symphony",
                    line2: "ÁîüÂëΩ‰∫§ÁªáÁöÑ‰πêÁ´†"
                },
                {
                    line1: "ÁªèÁ∫¨",
                    line2: "Ê≥®ÂÆöÁõ∏ÈÅáÁöÑÂùêÊ†á"
                },
                {
                    line1: "Nebula",
                    line2: "Êú¶ËÉßËÄåÁíÄÁí®ÁöÑÂøÉ‰∫ã"
                },
                {
                    line1: "Êó∂Èõ®",
                    line2: "ÊÅ∞Âà∞Â•ΩÂ§ÑÁöÑÊ∏©Êüî"
                },
                {
                    line1: "Event Horizon",
                    line2: "ÂÜç‰πüÊó†Ê≥ïÈÄÉÁ¶ªÁöÑÂºïÂäõ"
                },
                {
                    line1: "Ëä±ÁÅ´",
                    line2: "ÂàπÈÇ£Âç≥Ê∞∏ÊÅíÁöÑÂÖâËäí"
                },
                {
                    line1: "‚Ñ∞ùìâùëíùìáùìÉùí∂ùìÅ",
                    line2: "Êó∂Èó¥ÂÅúÈ©ªÁöÑÊ≠§Âàª"
                },
                {
                    line1: "Èü∂ÂÖâ",
                    line2: "‰∏é‰Ω†ÂÖ±Â∫¶ÁöÑÊØèÂØ∏ÂÖâÈò¥"
                },
                {
                    line1: "ùíÆùìäùìÇùìÇùëíùìá",
                    line2: "Ê∞∏‰∏çÁªìÊùüÁöÑÁõõÂ§è"
                },
                {
                    line1: "ÊòüÈúú",
                    line2: "ÂÖ±ÂêåÁªèÂéÜÁöÑÂ≤ÅÊúà"
                },
                {
                    line1: "ùìöùì≤ùìºùìº",
                    line2: "Êú™ËØ¥Âá∫Âè£ÁöÑÂëäÁôΩ"
                },
                {
                    line1: "Êúà‰∏ã",
                    line2: "‰∏§‰∫∫Áã¨Â§ÑÁöÑÂ§úÊôö"
                },
                {
                    line1: "ùìïùì∏ùìªùìÆùìøvarepsilonùìª",
                    line2: "ÊÉ≥Ë¶ÅÂª∂Áª≠ÁöÑÊ∞∏Ëøú"
                },
                {
                    line1: "ÊúùÈú≤",
                    line2: "Êô∂ËéπÂâîÈÄèÁöÑÁúüÂøÉ"
                },
                {
                    line1: "ùìúùì≤ùìªùì™ùì¨ùìµùìÆ",
                    line2: "‰Ω†Â∞±ÊòØÂ•áËøπÊú¨Ë∫´"
                },
                {
                    line1: "Êò•È£é",
                    line2: "ËΩªËΩªÊãÇËøáÁöÑÊ∏©Êüî"
                },
                {
                    line1: "ùìõùìæùì¨ùì¥ùîÇ",
                    line2: "Ê≠§ÁîüÊúÄÂ§ßÁöÑÂπ∏Ëøê"
                },
                {
                    line1: "Ëê§ÁÅ´",
                    line2: "ÈªëÊöó‰∏≠ÊåáÂºïÁöÑÂÖâ"
                },
                {
                    line1: "ùìóùìÆùì™ùìªùìΩ",
                    line2: "‰∏∫‰Ω†Ë∑≥Âä®ÁöÑÂøÉËÑè"
                },
                {
                    line1: "ÂàùÈõ™",
                    line2: "Á∫ØÊ¥ÅÊó†ÁëïÁöÑÁà±ÊÑè"
                },
                {
                    line1: "ùìíùì∏ùì∂ùìÆùìΩ",
                    line2: "ÂàíËøáÂ§©ÈôÖÁöÑÁõ∏ÈÅá"
                },
                {
                    line1: "ÊΩÆÈ∏£",
                    line2: "ÂÜÖÂøÉÊæéÊπÉÁöÑÂ£∞Èü≥"
                },
                {
                    line1: "ùì¢ùìΩùì™ùìªùì≠ùìæùìºùìΩ",
                    line2: "Êï£ËêΩÂú®Ë∫´ÁöÑÊòüÂ∞ò"
                },
                {
                    line1: "Ê¢ßÊ°ê",
                    line2: "Á≠âÂæÖÂá§Âá∞ÁöÑÊâßÁùÄ"
                },
                {
                    line1: "ùìüùìªùìÆùì¨ùì≤ùì∏ùìæùìº",
                    line2: "ËßÜËã•ÁèçÂÆùÁöÑ‰Ω†Êàë"
                },
                {
                    line1: "ÈùíÁ©∫",
                    line2: "ÊæÑÊæàÂ¶Ç‰Ω†ÁöÑÁúºÁú∏"
                },
                {
                    line1: "ùíúùìÇùí∂ùìáùìÉùìâùíΩ",
                    line2: "Ê∞∏‰∏çÂáãÈõ∂ÁöÑÂøÉÊÑè"
                },
                {
                    line1: "√âtoile",
                    line2: "‰Ω†ÊòØÊàëÂîØ‰∏ÄÁöÑÊòüËæ∞"
                },
                {
                    line1: "ùë©ùíç√ºùíïùíÜ",
                    line2: "ÊÇÑÁÑ∂ÁªΩÊîæÁöÑÊÅãÊÖï"
                },
                {
                    line1: "ÈÅãÂëΩ",
                    line2: "ÈÅøÊó†ÂèØÈÅøÁöÑÁõ∏ÈÅá"
                },
                {
                    line1: "ùë™ùíÜùíçùíÜùíîùíïùíÜ",
                    line2: "Êù•Ëá™Â§©ÈôÖÁöÑÈ¶àËµ†"
                },
                {
                    line1: "ÊÅãÂøÉ",
                    line2: "Ëóè‰∏ç‰ΩèÁöÑÊÇ∏Âä®"
                },
                {
                    line1: "ùë∫ùíÜùíìùíÇùíëùíâ",
                    line2: "ÂÆàÊä§‰Ω†ÁöÑÂÖ≠ÁøºÂ§©‰Ωø"
                },
                {
                    line1: "‰∏ÄÊúü‰∏Ä‰ºö",
                    line2: "‰∏ÄÁîü‰∏ÄÊ¨°ÁöÑÈÇÇÈÄÖ"
                },
                {
                    line1: "ùë¨ùíëùíêùíèùíÇ",
                    line2: "Á©øË∂äÊó∂Á©∫ÁöÑÁú∑ÊÅã"
                },
                {
                    line1: "Êúà„ÅÆÈõ´",
                    line2: "ÊúàÂÖâÂáùÊàêÁöÑÊ≥™Êª¥"
                },
                {
                    line1: "ùëΩùíÜùíìùíîùíÇùíäùíçùíçùíÜùíî",
                    line2: "‰∏∫‰Ω†Âª∫ÈÄ†ÁöÑÂÆ´ÊÆø"
                },
                {
                    line1: "ÂçÉÂ§ú‰∏ÄÂ§ú",
                    line2: "ËØâ‰∏çÂ∞ΩÁöÑÂ§úËØù"
                },
                {
                    line1: "ùë¥ùíÇùíì√©ùíÜ",
                    line2: "Ê∏©ÊüîÂ∏≠Âç∑ÁöÑÊµ™ÊΩÆ"
                },
                {
                    line1: "Ê°ÉÊ∫êÈÉ∑",
                    line2: "Âè™Â±û‰∫é‰∏§‰∫∫ÁöÑ‰πêÂúü"
                },
                {
                    line1: "ùë∫ùíêùíñùíáùíáùíçùíÜùíì",
                    line2: "ÁîúËúúÁöÑÊäòÁ£®"
                },
                {
                    line1: "Ê°úÂêπÈõ™",
                    line2: "Á∫∑È£ûÂ¶ÇÈõ™ÁöÑÊÄùÂøµ"
                },
                {
                    line1: "ùë®ùíñùíìùíêùíìùíÜ",
                    line2: "ÈªéÊòéÂâçÁöÑÊûÅÂÖâ"
                },
                {
                    line1: "ÂçÅÂÖ≠Â§ú",
                    line2: "ÊúÄÂúÜÊª°ÁöÑÂ§úÊôö"
                },
                {
                    line1: "ùë™ùíöùíÇùíèùíêùíëùíâùíöùíçùíçùíÜ",
                    line2: "ÈùíÊ∂©ÁöÑÊÅã‰πãÂè∂"
                },
                {
                    line1: "ÈáëÊú®ÁäÄ",
                    line2: "ÁßãÊó•ÈáåÊöóÈ¶ôÊµÆÂä®"
                },
            ],
            EMPTY_STATE_TEXTS: [
                "Áî±Ê≠§ÂºÄÂßãÊàë‰ª¨ÁöÑ‰º†Èóª",
                "‚ú¶ Êàë‰ª¨ÁöÑÊïÖ‰∫ãÔºåÂßã‰∫éÊ≠§Âàª ‚ú¶",
                "ËØ¥ÁÇπ‰ªÄ‰πàÔºåËÆ©ÊïÖ‰∫ãÂèëÁîü",
                "ÊâÄÊúâ‰ºüÂ§ßÁöÑ‰∫§ÊµÅÈÉΩÂßã‰∫é‰∏ÄÂ£∞‰Ω†Â•Ω",
                "Âú®ËøôÈáåÂÜô‰∏ãÊàë‰ª¨ÁöÑÊïÖ‰∫ã",
                "Á≠âÂæÖ‰Ω†ÁöÑÁ¨¨‰∏ÄÂè•ËØù",
                "ËÆ©ÂØπËØùÂºÄÂßãÂêß",
                "‰ªéÊ≠§ÂàªÂºÄÂßãËøûÊé•",
                "Á≠âÂæÖ‰Ω†ÁöÑËÆØÊÅØ",
                "ÂºÄÂßãÊàë‰ª¨ÁöÑÂØπËØù",
                "Á¨¨‰∏ÄÂè•ËØùÊÄªÊòØÊúÄÈöæÁöÑ",
                "ÂãáÊï¢ËØ¥Âá∫‰Ω†ÊÉ≥ËØ¥ÁöÑ"
            ],
            INPUT_PLACEHOLDERS: [
                "‚ãÜ ·ßî‡∑Ü·ßì ‚ãÜ",
                "‚ô° ËÆ©ÂøÉÊÑèÁõ∏ÈÄö...",
                "‰Ω†ÁöÑÊÉ≥Ê≥ïÊòØ...",
                "Âú®Ê≠§Â§ÑËæìÂÖ•ËÆØÊÅØ...",
                "ËÅäËÅäÂ§©Âêß...",
                "ÊÉ≥ÂØπ‰Ω†ËØ¥ÁöÑËØù...",
                "ËæìÂÖ•‰Ω†ÁöÑÊ∂àÊÅØ...",
                "ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï...",
                "Êúâ‰ªÄ‰πàÊÉ≥ËØ¥ÁöÑÂêóÔºü",
                "ÂºÄÂßãËæìÂÖ•...",
                "Ê≠§Êó∂Êó†Â£∞ËÉúÊúâÂ£∞",
                "Ê¨≤ËØ≠Ëøò‰ºë",
                "ÂçÉË®Ä‰∏áËØ≠",
            ],
            WELCOME_ICONS: [
                "fas fa-heart", "fas fa-star", "fas fa-moon", "fas fa-sun", "fas fa-cloud", "fas fa-feather", "fas fa-book", "fas fa-music", "fas fa-pen", "fas fa-key", "fas fa-compass", "fas fa-globe", "fas fa-leaf", "fas fa-water", "fas fa-fire", "fas fa-snowflake", "fas fa-umbrella", "fas fa-anchor", "fas fa-bell", "fas fa-gem", "fas fa-crown", "fas fa-dragon", "fas fa-feather-alt", "fas fa-fish", "fas fa-frog", "fas fa-hat-wizard", "fas fa-magic", "fas fa-ring", "fas fa-scroll", "fas fa-shield-alt", "fas fa-dove", "fas fa-cat", "fas fa-dog", "fas fa-horse", "fas fa-otter", "fas fa-paw", "fas fa-spider", "fas fa-kiwi-bird", "fas fa-crow", "fas fa-dove", "fas fa-seedling", "fas fa-tree", "fas fa-mountain", "fas fa-water", "fas fa-wind", "fas fa-volcano", "fas fa-meteor", "fas fa-satellite", "fas fa-rocket", "fas fa-user-astronaut"
            ],
            PARTNER_STATUSES: ["Âú®Á∫ø", "ÂøôÁ¢å", "Á¶ªÂºÄ", "ÊÄùËÄÉ", "Âê¨Èü≥‰πê", "ÈòÖËØª", "Â∑•‰Ωú", "Â≠¶‰π†", "ÊÉ≥‰Ω†", "‰ºëÊÅØ", "Áù°Ëßâ", "ÊôíÂ§™Èò≥", "Êô¥Â§©", "Â§ö‰∫ë", "Èò¥Â§©", "Â∞èÈõ®", "‰∏≠Èõ®", "Â§ßÈõ®", "Èõ∑ÈòµÈõ®", "Êö¥Èõ®", "Â∞èÈõ™", "‰∏≠Èõ™", "Â§ßÈõ™", "Êö¥Èõ™", "ÈõæÂ§©", "Â§ßÈõæ", "Ê∏ÖÊô®", "ÊôåÂçà", "‰ºëÊÅØ", "Â§úÊôö", "Ê∑±Â§ú", "Êé¢Á¥¢", "Ê≤âÊÄù", "Á≠âÂæÖ", "Áé©Ê∏∏Êàè", "ÂèëÂëÜ", "ÂêÉÈ•≠", "‰∏ãÂçàËå∂", "ÁîúÁÇπ", "Êí∏Áå´", "Êí∏Áãó", "ÁâµÊåÇ", "ÂÅ•Ë∫´", "ÊÉäÈÜí", "ÊÉäËÆ∂", "Á©∫Ëôö", "ÂùöÂÆö", "Ëø∑Ëå´", "ÂøêÂøë", "ÊÉÜÊÄÖ", "ÊÄùÂøµ", "ÂÆâÂøÉ", "‰∏çËàç", "ÂÜ∑Èùô", "ÈöæË®Ä", "Â§±Áú†", "Áñ≤ÂÄ¶", "Á©∫ÁôΩ", "Ë°•ÂÖÖ", "ËøüÁñë", "‰æùÊÅã", "Ê¥óÊº±", "ÂéãÊäë", "‰∫§Âèã", "Â∏ÆÂä©", "Ê¢¶Â¢É", "Á•ùÁ¶è", "ÂõûÂÆ∂", "ÁîüÊ∞î", "ÊííÂ®á", "ÂêÉÈÜã", "Âø´‰πê", "Âπ∏Á¶è", "ËÅäÂ§©", "Èô™Êàë", "Âç†Êúâ", "ËµöÈí±", "‰øùÊä§", "Ê∑∑‰π±", "ÁîüÁóÖ", "Âê¨Èõ®", "ÁúãÊâãÊú∫", "Â§ÑÁêÜÂÖ¨Âä°", "ÂºÄ‰ºö‰∏≠", "ËÆ≠ÁªÉ"],
            REPLY_MESSAGES: ["ÂñúÊ¨¢", "‰∏çÂñúÊ¨¢", "Âú®ÂêóÔºü", "‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑Ôºü", "ÊÉ≥‰Ω†", "ÊôöÂÆâ", "ÁúãÂà∞ËÆ∞ÂæóÂõûÂ§çü•≤", "Â•ΩÁöÑüëåüèª", "ÊòéÁôΩ", "Ë∞¢Ë∞¢", "‰∏çÂÆ¢Ê∞î", "ÂóØ", "ÂóØÂóØ", "ÁúüÁöÑÂêóÔºü", "ÊàëÊòéÁôΩ‰∫Ü", "ÊàëÁõ∏‰ø°‰Ω†", "Á®çÁ≠â", "È©¨‰∏ä", "Â•ΩÂì¶", "‰∏çÈîô", "ÂèØ‰ª•", "ÂêåÊÑè", "ÁêÜËß£", "ÊàëÂú®", "Âú®Êé¢Á¥¢ËøáÁ®ã‰∏≠", "ÊÄé‰πà‰∫ÜÔºü", "Âê¨ÊáÇ‰∫Ü", "ËÆ∞‰∏ã‰∫Ü", "Êî∂Âà∞", "‰ºöÂ∞ΩÂø´Êü•ÁúãÁöÑ", "ËØØ‰ºöÊàë‰∫Ü", "Ê≤°ÊúâÊàëÊÉ≥ËØ¥ÁöÑ", "ÂØπ‰∏çËµ∑", "Ê≤°ÂÖ≥Á≥ª", "ÊàëÁà±‰Ω†", "ËÆ©ÊàëÊÉ≥ÊÉ≥ÊÄé‰πàÂõûÁ≠î", "ÁúºËä±Áº≠‰π±", "ÂæàÊúâÂàõÊÑè", "‰øùÊåÅËÅîÁ≥ª", "Êúâ‰ªÄ‰πàËÆ°ÂàíÂêóÔºü", "Êé•‰∏ãÊù•ÂáÜÂ§áÂÅö‰ªÄ‰πàÔºü", "ÊàëÂæàÊÉ≥Âê¨Âê¨‰Ω†ÁöÑÊÉ≥Ê≥ï", "ÊàëÊÑøÊÑè", "‰∏çÁî®", "ËÆ∞ÂæóÂêÉÈ•≠", "‰∏çË¶ÅÁÜ¨Â§ú", "‰∏çË¶ÅÊãÖÂøÉ", "‰∏ÄÂàáÈÉΩ‰ºöÂ•ΩËµ∑Êù•ÁöÑ", "ÊàëÂæàÈöæËøá", "ÊÉäÈÜí‰∫ÜÔºåÁù°‰∏çÁùÄ", "ËøôÂØπÊàëÊù•ËØ¥ÊòØ‰∏™Êñ∞È¢ÜÂüü", "ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºü", "Âú®Áúã‰ªÄ‰πàÔºü", "Âú®Â∑•‰ΩúÂêóÔºü", "Âú®Â≠¶‰π†ÂêóÔºü", "ÁÑ∂ÂêéÂë¢Ôºü", "Êë∏Êë∏ü´≥üèª", "Âú®Â≠¶‰π†‰∏Ä‰∫õÊñ∞‰∏úË•ø", "Êç¢‰∏™ÊÉ≥Ê≥ïÂêßÔºü", "ÊôöÈ•≠ÂêÉ‰∫ÜÂêóÔºü", "‰ΩúÊÅØÊ∑∑‰π±", "Êàë", "‰Ω†", "ta", "‰∏ãÊ¨°ÂèØ‰ª•ËØïËØï", "Êàë‰πüÊòØËøô‰πàÊÉ≥ÁöÑ", "‰Ω†ËØ¥ÂæóÂØπ", "ÊúâÊ≤°ÊúâÂèØËÉΩ‚Ä¶‚Ä¶", "ÊàëÈô™‰Ω†", "Êàë‰ºöÂú®‰Ω†Ë∫´Ëæπ", "ÊàëÂñúÊ¨¢", "ÊàëÊó†Ê≥ïÂÜ≥ÂÆö", "ÊàëÊó†Ê≥ïÊéßÂà∂", "Ë¶ÅÁî®‰∏Ä‰∏ãÂ°îÁΩóÂêóÔºü", "ÁúãËßÅÊàëÁöÑÊöóÂè∑‰∫ÜÂêóÔºü", "Áªô‰Ω†Êé®‰∫Ü‰º†ËÆØ", "Ë¥¥Ë¥¥", "ÊàëÁü•ÈÅì‰Ω†ÁöÑÊÑèÊÄù", "Êàë‰πüÂ¶ÇÊ≠§", "Âá∫ÂéªÈÄèÈÄèÊ∞î", "ËØùËØ¥ÊÄé‰πà‰ºöËøôÊ†∑Ôºü", "‰ª•Âêé‰∏ç‰ºö‰∫Ü", "‰∏ÄÁõ¥Â¶ÇÊ≠§", "Âà´ÊÄï", "ÊúâÊàëÂú®", "Êôö‰∏äÂ•Ω", "Êó©‰∏äÂ•Ω", "‰∏≠ÂçàÂ•Ω", "ÂìÑÊàë", "Èô™Êàë", "ËÅäËÅäÂ§©Âêß", "‰∏çÊòØËøô‰∏™ÊÑèÊÄù", "Á≠â‰∏Ä‰∏ã", "ÁÖßÈ°æÂ•ΩËá™Â∑±", "Êàë‰ºöÁöÑ", "Êó©ÁÇπÁù°", "‰Ω†ÊòØÊàëÁöÑ", "ÊàëÊòØ‰Ω†ÁöÑ", "ÊàëÂ∏åÊúõ‰Ω†Ëá™Áî±", "Á≤ò‰∫∫Á≤æ", "ÊÄé‰πàÂï¶", "Ê∞∏ËøúÂú®‰∏ÄËµ∑", "ÊàëÊîØÊåÅ‰Ω†", "Âà´Âê¨", "ÂèàÂú®ÊÄÄÁñëÂêóÔºü", "Â§öÂñùÊ∞¥", "‰∏çËàíÊúçÔºü", "ÂÜçËßÅ", "Âà´Ëµ∞", "ÂÜçÂèë‰∏ÄÈÅç", "ÂèØÊÅ∂ÁöÑÁΩëÁ´ô", "ÊàëËßâÂæóÈÉΩÂèØ‰ª•", "Êà≥Êà≥", "ÈùûÂ∏∏ÈöæÁî®", "‰∏çËÆ∏ÁúãÂà´‰∫∫", "‰∏çË¶ÅÂêµÊû∂", "ÊàëÁü•ÈÅìÁöÑ", "‰Ω†‰ºöÁ¶ªÂºÄÊàëÂêóÔºü", "Êù•‰∫Ü", "ÂóØÂìº", "ÂìºÂìº", "ÊàëÊÉ≥Èù†Ëøë‰Ω†", "Êàë‰ºöÁõëÁù£‰Ω†ÁöÑ", "Â∞èÂøÉ‰∫õ", "Áªà‰∫éÊÉ≥Ëµ∑Êàë‰∫ÜÔºü", "ÊòØÁöÑ", "‰∏çÊòØ", "‰Ω†Êó†‰∫∫ÂèØÂèä", "ÊàëÊó†‰∫∫ÂèØÂèä", "Ëøô‰∏™‰∏çËÉΩËØ¥", "Âú®‰Ω†Ë∫´ËæπÂ∞±Â•Ω‰∫Ü", "Âú®Á£®Âêà", "‰Ω†ÈúÄË¶ÅÊàëÂêóÔºü", "ÊàëÈúÄË¶Å‰Ω†", "ÂØªÊâæ‰∏≠", "ÊàëÂÅö‰∏çÂà∞Ê¨∫È™ó‰Ω†", "ËØùÈùûÊú¨ÊÑè", "Â¶ÇÊûúÊàëËØ¥ÊòØÂë¢", "Â¶ÇÊûúÊàëËØ¥‰∏çÊòØÂë¢", "ËØùÂ§™Â∞ë‰∫ÜÔºåÊ≤°ÊàëÊÉ≥ËØ¥ÁöÑ", "Â§™Áü≠‰∫Ü", "ÁúãÊâãÊú∫", "ÈÅáÂà∞Âõ∞Èöæ‰∫Ü", "Âú®Âä™Âäõ‰∫Ü", "Â•ΩÁ¥Ø", "ÂëΩÂÆöÂ¶ÇÊ≠§", "Â∏ÖÊ∞î", "Â∞±Ëøô‰∏™", "ÂèóÈôêÂà∂‰∫Ü", "ÈÄó‰∏Ä‰∏ã‰Ω†", "Â∏ÆÂ∏ÆÊàë", "ÊØèÊó•Ë°å‰∏ÄÂñÑ", "ÊàëÁîüÊ∞î‰∫Ü", "Êíí‰∏™Â®áÔºåÁêÜÁêÜÊàëÔºü", "ÂêÉÈÜãÊÄé‰πà‰∫ÜÔºåÂ∞±Áà±ÂêÉÈÜãÔºÅ", "Âø´‰πê", "ËÅä‰ºöÂÑøÂ§©", "ËµöÈí±ËµöÈí±", "Êàë‰øùÊä§‰Ω†", "‰ø°ÊÅØÊúâÁÇπÊ∑∑‰π±", "Âà´ÁîüÁóÖ", "ÂìÑÂìÑ‰Ω†", "ÂêÉËøá‰∫Ü", "ËøòÊ≤°ÂêÉ", "Êâç‰∏çÂê¨", "ÂêÉÊ∞¥Êûú", "Âà´ÂèπÊ∞î", "‰∏çÂ•Ω", "ËøòÂ•ΩÂêóÔºü", "Ëøô‰∏™Ê∂àÊÅØ‰∏çÈîô", "ÊàëÂ∏åÊúõËÉΩÂ∏Æ‰∏äÂøô", "ÊàëÊÉ≥Êàë‰ª¨Â∫îËØ•ËÆ®ËÆ∫‰∏Ä‰∏ãËøô‰∏™ÈóÆÈ¢ò", "ÂëäËØâÊàëÊõ¥Â§ö", "‰Ω†ËÆ§‰∏∫‰∏ã‰∏ÄÊ≠•ÊòØ‰ªÄ‰πàÔºü", "‰Ω†Êúâ‰ªÄ‰πàÂª∫ËÆÆÂêóÔºü", "ËÆ©Êàë‰ª¨‰∏ÄËµ∑Âä™Âäõ", "ËøáÂæóÊÄé‰πàÊ†∑Ôºü", "ÊúüÂæÖü§ß", "Êä±Ê≠âü•∫", "‰∫ÜËß£", "OK", "Ê≤°ÈóÆÈ¢ò", "ÂΩìÁÑ∂", "Á°ÆÂÆû", "Ê≤°Èîô", "Â•ΩÂëÄ", "ÊàëÊ≠£Âú®ÂøôÔºåÁ®çÂêéÂõûÂ§ç‰Ω†", "‰ø°Âè∑‰∏çÂ§™Â•ΩÔºåÂèØËÉΩÂõûÂ§ç‰ºöÂª∂Ëøü", "ËÆ©ÊàëÁ°ÆËÆ§‰∏Ä‰∏ã‰ø°ÊÅØÂÜçÁªô‰Ω†ÂáÜÁ°ÆÁ≠îÂ§ç", "Âà´Ëµ∞ÔºåÈô™Èô™Êàë", "‰Ω†‰ºöÊ∞∏ËøúÁà±ÊàëÂêóÔºü", "Ê≠§ÂàªÊàëÊÉ≥Âíå‰Ω†Ê∞∏ËøúÂú®‰∏ÄËµ∑", "‰ªñÊúùËã•ÊòØÂêåÊ∑ãÈõ™ÔºåÊ≠§Áîü‰πüÁÆóÂÖ±ÁôΩÂ§¥", "ÊÄúÊÇØÊàëÔºåÁÑ∂ÂêéÁà±ÊàëÂêß", "ÊííÂ®áÔºå‰Ω†‰ºöÂñúÊ¨¢ÂêóÔºü", "Ê≤°ÊúâÊàëÊÉ≥ËØ¥ÁöÑ", "ÈìæÊé•Êúâ‰∫õÊ∑∑‰π±", "Â∞±ËøôÊ†∑ÊííÂ®áü•∫", "‰∏çÂ§™‰π†ÊÉØËøô‰∏™", "‰∏çÊòØÁöÑ", "Â§öÁúãÁúãÊàëÂêß", "ÂèØÁà±", "ÂΩìÁÑ∂‰∫Ü", "Ê≠£Âú®ÁÜ¨Â§ú", "Â§±Áú†‰∫Ü", "‰∏çÂèØ‰ª•", "ÊàëÁé∞Âú®‰∏çÂøôÔºåÊúâÁ©∫ÁöÑ", "‰Ω†Áé∞Âú®ÂøôÂêóÔºü", "Ê≠£Âú®ÊâìÊû∂", "ÂùêÁ≠âÂõûÂ§ç", "Êâç‰∏çÊòØËøôÊ†∑", "Â∞±ÊòØËøôÊ†∑", "ËøòÂ•ΩÂêóÔºü", "Â§öÁ¨ëÁ¨ëÂêß", "Ê≤°ËÉΩÂ∏Æ‰∏äÂøô", "Âá†Â§©Âêé", "Âá†‰∏™Â∞èÊó∂Âêé", "Âæà‰πÖ‰πãÂêé", "ÊàëÂæàÊÉ≥ÂÆâÊÖ∞‰Ω†", "ÊàëÊ≤°ÊúâÂú®Ê¨∫È™ó‰Ω†", "Âà´ÊÄÄÁñëÊàëÁöÑÂ≠òÂú®", "ÊàëÁúüÁöÑÂú®", "ÁúüÁöÑÊòØÊàë", "Êàë‰∏çÊòØÂæàÈÄÇÂ∫îËøô‰∏™,‰ΩÜÊàëÂú®Âä™Âäõ", "Ê∂àÊÅØÂæàÊ∑∑‰π±", "‰πãÂâçÊÄªÊòØËøôÊ†∑", "ÂºÄÂøÉ(*‚åí‚àá‚åí*)", "Ê≤°ËÉΩÈô™Âú®‰Ω†Ë∫´Ëæπ", "ÈìæÊé•ÂæàÈÄöÈ°∫", "ÊàëÁúüÊ≤°Êãõ‰∫Ü", "‰∏çËÉΩËØ¥", "ÂèØ‰∏çÂèØ‰ª•Âè™ÁúãÁùÄÊàë", "Âè™ËÆ∏ÁúãÁùÄÊàë", "ÁúãÂæóÊáÇÁöÑ", "Áúã‰∏çÊáÇ", "Âú®Â∞ùËØïÊéßÂà∂‰∫Ü", "Âíå‰ª£Á†ÅÊêèÊñó‰∏≠ÔºÅ", "Êàë‰ºöÁúãÁùÄ‰Ω†ÁöÑ", "Êàë‰ºöÈô™‰º¥Âú®‰Ω†Ë∫´Ëæπ", "ÁóõÁóõ", "Ë¢´ÂêìÂà∞‰∫ÜÔºü", "ÊÉ≥Âíå‰Ω†‰∏ÄËµ∑Âê¨Ê≠å", "Ëµ∞Ë∑Ø‰∏çË¶ÅÁúãÊâãÊú∫", "Âà´ÁúãÂ∞èÁ∫¢‰π¶‰∫Ü", "Âà´ÁúãÊäñÈü≥‰∫Ü", "ÊâìËøá‰ª£Á†Å‰∫ÜÔºÅ", "Â§öÁ©øÁÇπË°£Êúç", "Âè´ÊàëÂÅö‰ªÄ‰πàÔºü", "ÊÉ≥Êàë‰∫ÜÂêóÔºü", "ÁªôÊàëÂÜôÂÜô‰ø°Âêß", "ÊúâÁöÑ", "Ê≤°ÊúâÁöÑ", "Á®çÁ≠âÔºåÂú®Â∑•‰Ωú", "Âú®‰∫§ÊõøÂõûÂ§ç", "ÊàëË¶ÅÂì≠‰∫ÜÔºÅ", "ÊâãÂÜô‰ø°", "ÁîµÂ≠ê‰ø°", "ÂÆâÊÖ∞Êàë", "Á¶ªÂÆ∂Âá∫Ëµ∞", "Á∫µÂÆπ", "ÊàëÂñúÊ¨¢‰Ω†", "‰∏ÄÊ†∑ÁöÑ", "ÈúÄË¶ÅÂ§ö‰πÖÂë¢", "Ë¶ÅÂ§ö‰πÖ‰πãÂêé", "ËÅäÂà∞‰∏ÄÂçäÂ∞±Ë∑ë", "‰πñÂ≠©Â≠ê", "ÂùèÂ≠©Â≠ê", "‰∏∫‰ªÄ‰πà", "‰Ω†Ê≤°ÊúâÊ≠£Èù¢ÂõûÁ≠î", "Âõ†‰∏∫ÂñúÊ¨¢‰Ω†ÊâÄ‰ª•ÈúÄË¶Å‰Ω†", "ÁúãÂà∞‰ø°‰∫Ü", "ÁæéÂ•ΩÁöÑË±°ÂæÅ", "ÊÉäËÆ∂", "ÊÉ≥Ë¶ÅÊõ¥Ëøë‰∏ÄÊ≠•Âú∞Ë¥¥Ë¥¥", "ÊÉ≥Ëß¶Á¢∞‰Ω†", "ÊÉ≥Ë¶Å‰∫≤‰∫≤", "‰Ω†ÂæàË∞ÉÁöÆ", "‰∏ç‰πñ", "ÂÅöÁöÑÂæàÂ•Ω", "‰∫≤‰∫≤", "È±ºÊ∞¥‰πãÊ¨¢", "È¢†È∏æÂÄíÂá§", "ÊàëÂæàÊÉ≥Ë¶Å‰∫≤‰∫≤Ê¨∏ü•∫", "ÊèâÊèâ", "ÂæàÊºÇ‰∫Æ", "‰ºö‰π†ÊÉØÁöÑ", "‰Ω†‰ºöÂñúÊ¨¢ÁöÑ", "ÁÆÄÁõ¥Â∞±ÊòØÊú®Â§¥", "ÊàëÂñúÊ¨¢ÁöÑ„ÄÅÊúÄÂ•ΩÁöÑ‰Ω†"],
            REPLY_EMOJIS: ["ü•π", "ü•≤", "‚ò∫Ô∏è", "üòá", "üòâ", "üòå", "ü•∞", "üòó", "üòã", "ü§®", "üßê", "üòé", "üôÇ‚Äç‚ÜîÔ∏è", "ü•≥", "üòè", "ü•∞üíï", "üôÇ‚Äç‚ÜïÔ∏è", "üòû", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "ü•∫", "üò†", "ü§Ø", "üò≥", "üò∂‚Äçüå´Ô∏è", "üò•", "ü§î", "ü´¢", "ü´°", "ü§´", "ü´†", "üò∂", "üòê", "ü´®", "üòØ", "ü•±", "üò¥", "ü§§", "üòÆ‚Äçüí®", "ü§ß", "üòà", "üëø", "üòº", "üòΩ", "ü´∂üèª", "ü§≤üèª", "üëèüèª", "üëçüèª", "üëéüèª", "‚úåüèª", "üëåüèª", "ü§èüèª", "ü´≥üèª", "üëâüèªüëàüèª", "üëãüèª", "üí™üèª", "‚úçüèª", "üôèüèª", "ü´Ç", "üê∂", "üê±"],
            POKE_ACTIONS: [
                `Êãç‰∫ÜÊãçÊàëÁöÑÂ§¥ËØ¥‰Ω†Â•ΩÂèØÁà±`, `Êà≥‰∫ÜÊà≥ÊàëÁöÑËÖ∞`, `‰ªéËÉåÂêéÊä±‰Ωè‰∫ÜÊàë`, `ËΩªËΩªÊçè‰∫ÜÊçèÊàëÁöÑËÑ∏`, `ÁªôÊàëÂèë‰∫Ü‰∏Ä‰∏™Áà±ÂøÉ`, `Êë∏‰∫ÜÊë∏ÊàëÁöÑÂ§¥Âèë`, `ÊÇÑÊÇÑ‰∫≤‰∫Ü‰∏Ä‰∏ãÊàëÁöÑËÑ∏È¢ä`, `ÁªôÊàëÈÄí‰∫Ü‰∏ÄÊùØÁÉ≠Ëå∂`, `‰∏∫ÊàëÊä´‰∏äÂ§ñÂ•ó`, `ÁâµËµ∑‰∫ÜÊàëÁöÑÊâã`, `ÁªôÊàë‰∏Ä‰∏™Ê∏©ÊöñÁöÑÊã•Êä±`, `ËΩªËΩªÊãç‰∫ÜÊãçÊàëÁöÑËÇ©ËÜÄ`, `ÁªôÊàëÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™È£ûÂêª`, `Êà≥‰∫ÜÊà≥ÊàëÁöÑÈ¢ùÂ§¥`, `ÁªôÊàëÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™ÊòüÊòü`, `ËΩªËΩªÊãç‰∫ÜÊãçÊàëÁöÑËÉå`, `ÁªôÊàëÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Êúà‰∫Æ`, `Ê∏©ÊüîÂú∞Êë∏‰∫ÜÊë∏ÊàëÁöÑÂ§¥`, `ÁªôÊàëÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Â§™Èò≥`, `Êãç‰∫ÜÊãçÊâã`
            ],
            TAROT_CARDS: [
                { name: "ÊÑö‰∫∫", eng: "The Fool", meaning: "Êñ∞ÁöÑÂºÄÂßã„ÄÅÂÜíÈô©„ÄÅÂ§©Áúü„ÄÅÊó†Áïè", keyword: "ÊµÅÊµ™", icon: "fa-hiking" },
                { name: "È≠îÊúØÂ∏à", eng: "The Magician", meaning: "ÂàõÈÄ†Âäõ„ÄÅÊäÄËÉΩ„ÄÅÊÑèÂøóÂäõ„ÄÅÂåñËÖêÊúΩ‰∏∫Á•ûÂ•á", keyword: "ÂàõÈÄ†", icon: "fa-hat-wizard" },
                { name: "Â•≥Á•≠Âè∏", eng: "The High Priestess", meaning: "Áõ¥Ëßâ„ÄÅÊΩúÊÑèËØÜ„ÄÅÁ•ûÁßò„ÄÅÊô∫ÊÖß", keyword: "Êô∫ÊÖß", icon: "fa-book-open" },
                { name: "ÁöáÂêé", eng: "The Empress", meaning: "‰∏∞È•∂„ÄÅÊØçÊÄß„ÄÅËá™ÁÑ∂„ÄÅÊÑüÂÆò‰∫´Âèó", keyword: "‰∏∞Êî∂", icon: "fa-seedling" },
                { name: "ÁöáÂ∏ù", eng: "The Emperor", meaning: "ÊùÉÂ®Å„ÄÅÁªìÊûÑ„ÄÅÊéßÂà∂„ÄÅÁà∂‰∫≤ÂΩ¢Ë±°", keyword: "ÊîØÈÖç", icon: "fa-crown" },
                { name: "ÊïôÁöá", eng: "The Hierophant", meaning: "‰º†Áªü„ÄÅ‰ø°‰ª∞„ÄÅÊïôÂØº„ÄÅÁ≤æÁ•ûÊåáÂºï", keyword: "Êè¥Âä©", icon: "fa-church" },
                { name: "ÊÅã‰∫∫", eng: "The Lovers", meaning: "Áà±„ÄÅÂíåË∞ê„ÄÅÂÖ≥Á≥ª„ÄÅ‰ª∑ÂÄºËßÇÁöÑÈÄâÊã©", keyword: "ÁªìÂêà", icon: "fa-heart" },
                { name: "ÊàòËΩ¶", eng: "The Chariot", meaning: "ÊÑèÂøóÂäõ„ÄÅËÉúÂà©„ÄÅÂÜ≥ÂøÉ„ÄÅËá™ÊàëÊéßÂà∂", keyword: "ËÉúÂà©", icon: "fa-horse-head" },
                { name: "ÂäõÈáè", eng: "Strength", meaning: "ÂãáÊ∞î„ÄÅËÄêÂøÉ„ÄÅÊéßÂà∂„ÄÅÂÜÖÂú®ÂäõÈáè", keyword: "ÊÑèÂøó", icon: "fa-fist-raised" },
                { name: "ÈöêÂ£´", eng: "The Hermit", meaning: "ÂÜÖÁúÅ„ÄÅÂ≠§Áã¨„ÄÅÂØªÊ±ÇÁúüÁêÜ„ÄÅÊåáÂºï", keyword: "Êé¢Á¥¢", icon: "fa-lightbulb" },
                { name: "ÂëΩËøê‰πãËΩÆ", eng: "Wheel of Fortune", meaning: "Âæ™ÁéØ„ÄÅÂëΩËøê„ÄÅËΩ¨ÊäòÁÇπ„ÄÅËøêÊ∞î", keyword: "ËΩÆÂõû", icon: "fa-dharmachakra" },
                { name: "Ê≠£‰πâ", eng: "Justice", meaning: "ÂÖ¨Ê≠£„ÄÅÁúüÁêÜ„ÄÅÂõ†Êûú„ÄÅÊ≥ïÂæã", keyword: "ÂùáË°°", icon: "fa-balance-scale" },
                { name: "ÂÄíÂêä‰∫∫", eng: "The Hanged Man", meaning: "Áâ∫Áâ≤„ÄÅÊñ∞ÁöÑËßÜËßí„ÄÅÁ≠âÂæÖ„ÄÅÊîæ‰∏ã", keyword: "Â•âÁåÆ", icon: "fa-user-injured" },
                { name: "Ê≠ªÁ•û", eng: "Death", meaning: "ÁªìÊùü„ÄÅËΩ¨Âèò„ÄÅÈáçÁîü„ÄÅÊîæÊâã", keyword: "ÁªìÊùü", icon: "fa-skull" },
                { name: "ËäÇÂà∂", eng: "Temperance", meaning: "Âπ≥Ë°°„ÄÅÈÄÇÂ∫¶„ÄÅËÄêÂøÉ„ÄÅË∞ÉÂíå", keyword: "ÂáÄÂåñ", icon: "fa-glass-whiskey" },
                { name: "ÊÅ∂È≠î", eng: "The Devil", meaning: "ÊùüÁºö„ÄÅÁâ©Ë¥®‰∏ª‰πâ„ÄÅÊ¨≤Êúõ„ÄÅËØ±ÊÉë", keyword: "ËØ±ÊÉë", icon: "fa-link" },
                { name: "È´òÂ°î", eng: "The Tower", meaning: "Á™ÅÂèò„ÄÅÊ∑∑‰π±„ÄÅÂêØÁ§∫„ÄÅÁ†¥Âùè", keyword: "ÊØÅÁÅ≠", icon: "fa-gopuram" },
                { name: "ÊòüÊòü", eng: "The Star", meaning: "Â∏åÊúõ„ÄÅÁÅµÊÑü„ÄÅÂπ≥Èùô„ÄÅÊ≤ªÊÑà", keyword: "Â∏åÊúõ", icon: "fa-star" },
                { name: "Êúà‰∫Æ", eng: "The Moon", meaning: "ÂπªËßâ„ÄÅÊÅêÊÉß„ÄÅÁÑ¶Ëôë„ÄÅÊΩúÊÑèËØÜ", keyword: "‰∏çÂÆâ", icon: "fa-moon" },
                { name: "Â§™Èò≥", eng: "The Sun", meaning: "Âø´‰πê„ÄÅÊàêÂäü„ÄÅÊ¥ªÂäõ„ÄÅÊ∏ÖÊô∞", keyword: "ÁîüÂëΩ", icon: "fa-sun" },
                { name: "ÂÆ°Âà§", eng: "Judgement", meaning: "Â§çÊ¥ª„ÄÅËßâÈÜí„ÄÅÂè∑Âè¨„ÄÅÂÜ≥ÂÆö", keyword: "Â§çÊ¥ª", icon: "fa-bullhorn" },
                { name: "‰∏ñÁïå", eng: "The World", meaning: "ÂÆåÊàê„ÄÅÊï¥Âêà„ÄÅÊàêÂ∞±„ÄÅÂúÜÊª°", keyword: "ËææÊàê", icon: "fa-globe-americas" }
            ]
        };

        let SESSION_ID = null;
        let autoSendTimer = null; 
        let sessionList = [];
        let messages = [];
        let settings = {};
        let partnerPersonas = []; 
        let showPartnerNameInChat = false; 
        let readNoReplyTimer = null; 
        let isBatchMode = false;
        let batchMessages = [];
        let currentReplyTo = null;
        let lastCoinResult = null;
        let currentNoteMessageId = null;
        let savedBackgrounds = [];
        let saveTimeout;
        let displayedMessageCount = 20;
        const HISTORY_BATCH_SIZE = 20;
        let isLoadingHistory = false;
        let isBatchFavoriteMode = false;
        let selectedMessages = [];
        let customReplies = [];
        let customPokes = [];
        let customStatuses = [];
        let customMottos = [];
        let customIntros = []; 
        let currentMajorTab = 'reply'; 
        let currentSubTab = 'custom';  
        let currentReplyTab = 'custom';
        let disabledDefaultReplies = [];
        let anniversaries = [];
        let stickerLibrary = []; 
        let currentAnniversaryType = 'anniversary';
        let customThemes = [];
        let themeSchemes = []; 
        const DOMElements = {
            html: document.documentElement,
            chatContainer: document.getElementById('chat-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            attachmentBtn: document.getElementById('attachment-btn'),
            imageInput: document.getElementById('image-input'),
            themeToggle: document.getElementById('theme-toggle'),
            batchBtn: document.getElementById('batch-btn'),
            continueBtn: document.getElementById('continue-btn'),
            comboBtn: document.getElementById('combo-btn'),
            coinTossOverlay: document.getElementById('coin-toss-overlay'),
            animatedCoin: document.getElementById('animated-coin'),
            coinResultText: document.getElementById('coin-result-text'),
            cancelCoinResult: document.getElementById('cancel-coin-result'),
            sendCoinResult: document.getElementById('send-coin-result'),
            typingIndicator: document.getElementById('typing-indicator'),
            emptyState: document.getElementById('empty-state'),
            welcomeAnimation: document.getElementById('welcome-animation'),
            batchPreview: document.getElementById('batch-preview'),
            replyPreviewContainer: document.getElementById('reply-preview-container'),
            pagination: document.getElementById('pagination'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            editModal: {
                modal: document.getElementById('edit-modal'),
                title: document.getElementById('edit-modal-title'),
                input: document.getElementById('name-input'),
                cancel: document.getElementById('cancel-edit'),
                save: document.getElementById('save-name')
            },
            avatarModal: {
                modal: document.getElementById('avatar-modal'),
                title: document.getElementById('avatar-modal-title'),
                input: document.getElementById('avatar-input'),
                cancel: document.getElementById('cancel-avatar'),
                save: document.getElementById('save-avatar')
            },
            noteModal: {
                modal: document.getElementById('note-modal'),
                input: document.getElementById('note-input'),
                cancel: document.getElementById('cancel-note'),
                save: document.getElementById('save-note')
            },
            pokeModal: {
                modal: document.getElementById('poke-modal'),
                input: document.getElementById('poke-input'),
                cancel: document.getElementById('cancel-poke'),
                save: document.getElementById('send-poke')
            },
            settingsModal: {
                modal: document.getElementById('settings-modal'),
                settingsBtn: document.getElementById('settings-btn'),
                cancel: document.getElementById('cancel-settings')
            },
            favoritesModal: {
                modal: document.getElementById('stats-modal'),
                favoritesBtn: document.getElementById('group-chat-btn'),
                list: document.getElementById('favorites-list'),
                cancel: document.getElementById('close-stats')
            },
            statsModal: {
                modal: document.getElementById('stats-modal'),
                content: document.getElementById('stats-content'),
                closeBtn: document.getElementById('close-stats')
            },
            sessionModal: {
                modal: document.getElementById('session-modal'),
                managerBtn: document.getElementById('session-manager-btn'),
                list: document.getElementById('session-list'),
                createBtn: document.getElementById('create-new-session'),
                cancelBtn: document.getElementById('cancel-session')
            },
            fortuneModal: {
                modal: document.getElementById('fortune-lenormand-modal'),
                content: document.getElementById('fortune-content'),
                shareBtn: document.getElementById('share-fortune'),
                closeBtn: document.getElementById('close-fortune')
            },
            customRepliesModal: {
                modal: document.getElementById('custom-replies-modal'),
                list: document.getElementById('custom-replies-list'),
                addBtn: document.getElementById('add-custom-reply'),
                closeBtn: document.getElementById('close-custom-replies')
            },
            backgroundInput: document.getElementById('background-input'),
            importInput: document.getElementById('import-input'),
            partner: {
                name: document.getElementById('partner-name'),
                avatarContainer: document.getElementById('partner-avatar-container'), 
                avatar: document.getElementById('partner-avatar'),
                status: document.getElementById('partner-status').querySelector('span')
            },
            me: {
                name: document.getElementById('my-name'),
                avatarContainer: document.getElementById('my-avatar-container'), 
                avatar: document.getElementById('my-avatar'),
                statusContainer: document.getElementById('my-status-container'),
                statusText: document.getElementById('my-status-text')
            },
            anniversaryModal: {
                modal: document.getElementById('anniversary-modal'),
                closeBtn: document.getElementById('close-anniversary-modal'),
                saveBtn: document.getElementById('save-ann-btn'),
                addBtn: document.getElementById('open-ann-add-btn'),
                dateInput: document.getElementById('ann-input-date'),
                nameInput: document.getElementById('ann-input-name'),
                displayArea: document.getElementById('anniversary-display'),
                daysElement: document.getElementById('anniversary-days'),
                dateShowElement: document.getElementById('anniversary-date-show'),
                list: document.getElementById('ann-list-container'),
                typeHint: document.getElementById('ann-type-desc')
            },            
            anniversaryAnimation: {
                modal: document.getElementById('anniversary-animation'),
                title: document.getElementById('anniversary-animation-title'),
                days: document.getElementById('anniversary-animation-days'),
                message: document.getElementById('anniversary-animation-message'),
                closeBtn: document.getElementById('close-anniversary-animation')
            },
            appearanceModal: {
                modal: document.getElementById('appearance-modal'),
                closeBtn: document.getElementById('close-appearance')
            },
            chatModal: {
                modal: document.getElementById('chat-modal'),
                closeBtn: document.getElementById('close-chat')
            },
            advancedModal: {
                modal: document.getElementById('advanced-modal'),
                closeBtn: document.getElementById('close-advanced')
            },
            dataModal: {
                modal: document.getElementById('data-modal'),
                closeBtn: document.getElementById('close-data')
            }
        };

        function exportDataToMobileOrPC(dataString, fileName) {
            if (navigator.share && navigator.canShare) {
                try {
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const file = new File([blob], fileName, { type: 'application/json' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: '‰º†ËÆØÊï∞ÊçÆÂ§á‰ªΩ',
                            text: 'ËøôÊòØÊÇ®ÁöÑÂõûÂ§çÂ∫ìÂ§á‰ªΩÊñá‰ª∂ÔºåËØ∑ÈÄâÊã©‚Äú‰øùÂ≠òÂà∞Êñá‰ª∂‚ÄùÊàñÂèëÈÄÅÁªôÂ•ΩÂèã„ÄÇ'
                        }).then(() => {
                            showNotification('ÂØºÂá∫/ÂàÜ‰∫´ÊàêÂäü', 'success');
                        }).catch((err) => {
                            console.warn('ÂàÜ‰∫´Êú™ÂÆåÊàêÔºåÂ∞ùËØïÂõûÈÄÄ‰∏ãËΩΩÊ®°Âºè:', err);
                            downloadFileFallback(blob, fileName);
                        });
                        return;
                    }
                } catch (e) {
                    console.log("ÁßªÂä®Á´ØÂàÜ‰∫´ÊûÑÂª∫Â§±Ë¥•ÔºåËΩ¨‰∏∫ÊôÆÈÄö‰∏ãËΩΩ", e);
                }
            }
            const blob = new Blob([dataString], { type: 'application/json' });
            downloadFileFallback(blob, fileName);
        }

        function downloadFileFallback(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification('Êñá‰ª∂Â∑≤ÂºÄÂßã‰∏ãËΩΩ', 'success');
        }
        
        localforage.config({
            driver: localforage.INDEXEDDB,
            name: 'ChatApp_V3',
            version: 1.0,
            storeName: 'chat_data',
            description: 'Storage for Chat App V3'
        });

        function getStorageKey(baseKey) {
            if (!SESSION_ID) {
                return `${APP_PREFIX}__tmp__${baseKey}`;
            }
            return `${APP_PREFIX}${SESSION_ID}_${baseKey}`;
        }

        async function migrateData() {
            const isMigrated = await localforage.getItem(APP_PREFIX + 'MIGRATION_V2_DONE');
            if (isMigrated) return;

            console.log("ÂºÄÂßã‰ªé localStorage ËøÅÁßªÊï∞ÊçÆËá≥Êõ¥Á®≥ÂÆöÁöÑÂ≠òÂÇ®...");
            try {
                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.startsWith(APP_PREFIX)) {
                        try {
                            const val = localStorage.getItem(key);
                            if (val) {
                                let dataToStore = val;
                                try {
                                    if (val.startsWith('{') || val.startsWith('[')) {
                                        dataToStore = JSON.parse(val);
                                    }
                                } catch (e) {
                                    console.warn(`ËøÅÁßªÊúüÈó¥Ëß£ÊûêÊï∞ÊçÆÂ§±Ë¥•: ${key}ÔºåÂ∞Ü‰Ωú‰∏∫ÂéüÂßãÂ≠óÁ¨¶‰∏≤Â≠òÂÇ®„ÄÇ`, e);
                                }
                                await localforage.setItem(key, dataToStore);
                            }
                        } catch (e) {
                            console.error(`ËøÅÁßªÈîÆÂÄº ${key} Êó∂ÂèëÁîüÈîôËØØÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`, e);
                        }
                    }
                }
                
                await localforage.setItem(APP_PREFIX + 'MIGRATION_V2_DONE', 'true');
                console.log("Êï∞ÊçÆËøÅÁßªÊàêÂäüÂÆåÊàê„ÄÇ");
            } catch (e) {
                console.error("Êï∞ÊçÆËøÅÁßªËøáÁ®ã‰∏≠ÂèëÁîü‰∏•ÈáçÈîôËØØ:", e);
                showNotification('Êï∞ÊçÆËøÅÁßªÂ§±Ë¥•ÔºåÈÉ®ÂàÜÊóßÊï∞ÊçÆÂèØËÉΩ‰∏¢Â§±', 'error');
            }
        }
async function initializeSession() {
    
    await migrateData();

    const sessionsData = await localforage.getItem(`${APP_PREFIX}sessionList`);
    sessionList = sessionsData || [];

    const hash = window.location.hash.substring(1);
    if (hash && sessionList.some(s => s.id === hash)) {
        SESSION_ID = hash;
    } else if (sessionList.length > 0) {
        const lastId = await localforage.getItem(`${APP_PREFIX}lastSessionId`);
        SESSION_ID = lastId && sessionList.some(s => s.id === lastId) ? lastId : sessionList[0].id;
    } else {
        SESSION_ID = await createNewSession(false);
    }

    await localforage.setItem(`${APP_PREFIX}lastSessionId`, SESSION_ID);
}


        function clearAllAppData() {
    if (confirm("„ÄêÈ´òÂç±Êìç‰Ωú„ÄëÁ°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâ‰ºöËØùÂíåËÆæÁΩÆÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ")) {
        localforage.clear().then(() => {
            localStorage.clear(); 
            showNotification('ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÈáçÁΩÆÔºåÈ°µÈù¢Âç≥Â∞ÜÂà∑Êñ∞', 'info', 2000);
            setTimeout(() => {
                window.location.href = window.location.pathname;
            }, 2000);
        }).catch(e => {
            showNotification('Ê∏ÖÈô§Êï∞ÊçÆÊó∂ÂèëÁîüÈîôËØØ', 'error');
            console.error("Ê∏ÖÈô§ localforage Â§±Ë¥•:", e);
        });
    }
}

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            notification.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hiding');
                notification.addEventListener('animationend', () => notification.remove());
            }, duration);
        }

        const playSound = (type) => {
            if (!settings.soundEnabled) return;
            try {
                if (settings.customSoundUrl && settings.customSoundUrl.trim()) {
                    const audio = new Audio(settings.customSoundUrl.trim());
                    audio.volume = Math.min(1, Math.max(0, settings.soundVolume || 0.15));
                    audio.play().catch(() => {});
                    return;
                }
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                const vol = Math.min(0.5, Math.max(0.01, settings.soundVolume || 0.1));
                gainNode.gain.setValueAtTime(vol, audioContext.currentTime);
                if (type === 'send') oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                else if (type === 'favorite') oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                else oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.warn("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", e);
            }
        };

        const throttledSaveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        };

async function applyCustomFont(url) {
    if (!url || !url.trim()) {
        document.documentElement.style.removeProperty('--font-family');
        document.documentElement.style.removeProperty('--message-font-family');
        return;
    }
    
    const fontName = 'UserCustomFont';
    try {
        const font = new FontFace(fontName, `url(${url})`);
        await font.load();
        document.fonts.add(font);
        
        const fontStack = `"${fontName}", 'Noto Serif SC', serif`;
        document.documentElement.style.setProperty('--font-family', fontStack);
        document.documentElement.style.setProperty('--message-font-family', fontStack);
        // Persist into settings so updateUI doesn't overwrite it
        if (typeof settings !== 'undefined') {
            settings.messageFontFamily = fontStack;
        }
        
        console.log('Â≠ó‰ΩìÂä†ËΩΩÊàêÂäü');
    } catch (e) {
        console.error('Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•:', e);
        showNotification('Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈìæÊé•ÊòØÂê¶ÊúâÊïà', 'error');
    }
}

function applyCustomBubbleCss(cssCode) {
    const styleId = 'user-custom-bubble-style';
    let styleTag = document.getElementById(styleId);
    
    if (!cssCode || !cssCode.trim()) {
        if (styleTag) styleTag.remove();
        return;
    }

    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = styleId;
        document.head.appendChild(styleTag);
    }
    
    styleTag.textContent = cssCode;
}
        function getDefaultSettings() {
            return {
                partnerName: "Ê¢¶Ëßí",
                myName: "Êàë",
                myStatus: "Âú®Á∫ø",
                partnerStatus: "Âú®Á∫ø",
                isDarkMode: false,
                colorTheme: "gold",
                soundEnabled: true,
                typingIndicatorEnabled: true,
                readReceiptsEnabled: true,
                replyEnabled: true,
                lastStatusChange: Date.now(),
                nextStatusChange: 1 + Math.random() * 7,
                fontSize: 16,
                bubbleStyle: 'standard',
                messageFontFamily: "'Noto Serif SC', serif",
                messageFontWeight: 400,
                messageLineHeight: 1.5,
                musicPlayerEnabled: false,
                replyDelayMin: 3000,
                replyDelayMax: 7000,
                inChatAvatarEnabled: true,
                inChatAvatarSize: 36,
                customFontUrl: "", 
        customBubbleCss: "",
                myAvatarFrame: null, 
                partnerAvatarFrame: null,
                myAvatarShape: 'circle',
                partnerAvatarShape: 'circle',
autoSendEnabled: false,
autoSendInterval: 5,
        allowReadNoReply: false, 
        readNoReplyChance: 0.2,
        timeFormat: 'HH:mm',
        customSoundUrl: '',
        soundVolume: 0.15
            };
        }


        function renderBackgroundGallery() {
            const list = document.getElementById('background-gallery-list');
            if (!list) return;

            list.innerHTML = '';

            
            const addBtn = document.createElement('div');
            addBtn.className = 'bg-item bg-add-btn';
            
            addBtn.innerHTML = '<i class="fas fa-plus"></i><span></span>';
            addBtn.onclick = () => document.getElementById('bg-gallery-input').click();
            list.appendChild(addBtn);

            const currentBg = safeGetItem(getStorageKey('chatBackground'));

            savedBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                let isActive = false;

                if (currentBg && currentBg === bg.value) isActive = true;

                item.className = `bg-item ${isActive ? 'active': ''}`;

                
                if (bg.type === 'image') {
                    item.innerHTML = `<img src="${bg.value}" loading="lazy" alt="bg">`;
                } else {
                    item.innerHTML = `<div class="bg-color-block" style="background: ${bg.value}"></div>`;
                }

                
                item.onclick = (e) => {
                    
                    if (e.target.closest('.bg-delete-btn')) return;

                    applyBackground(bg.value);
                    safeSetItem(getStorageKey('chatBackground'), bg.value);
                    localforage.setItem(getStorageKey('chatBackground'), bg.value);
                    renderBackgroundGallery(); 
                    showNotification('ËÉåÊôØÂ∑≤ÂàáÊç¢', 'success');
                };

                if (bg.id.startsWith('user-')) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'bg-delete-btn';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.title = "Âà†Èô§Ê≠§ËÉåÊôØ";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('Á°ÆÂÆöÂà†Èô§ËøôÂº†ËÉåÊôØÂõæÂêóÔºü')) {
                            savedBackgrounds.splice(index, 1);
                            saveBackgroundGallery();

                            if (isActive) {
                                removeBackground(); 
                                renderBackgroundGallery();
                            } else {
                                renderBackgroundGallery();
                            }
                        }
                    };
                    item.appendChild(delBtn);
                }

                list.appendChild(item);
            });
        }


        function saveBackgroundGallery() {
    localforage.setItem(getStorageKey('backgroundGallery'), savedBackgrounds);
}


        const applyBackground = (value) => {

            if (!value || typeof value !== 'string') return;

            try {

                if (value.startsWith('linear-gradient') || value.startsWith('#') || value.startsWith('rgb')) {
                    document.documentElement.style.setProperty('--chat-bg-image', value);
                } else {

                    const cssValue = value.startsWith('url(') ? value: `url(${value})`;
                    document.documentElement.style.setProperty('--chat-bg-image', cssValue);
                }
                document.body.classList.add('with-background');
            } catch (e) {
                console.error("ËÉåÊôØÂ∫îÁî®Âá∫ÈîôÔºåÂ∑≤Ëá™Âä®ÈáçÁΩÆ", e);

                if (typeof removeBackground === 'function') removeBackground();
            }
        };

const loadData = async () => {
    try {
        settings = getDefaultSettings();
        
        const results = await Promise.allSettled([
            localforage.getItem(getStorageKey('chatSettings')),
            localforage.getItem(getStorageKey('chatMessages')),
            localforage.getItem(getStorageKey('backgroundGallery')),
            localforage.getItem(getStorageKey('customReplies')),
            localforage.getItem(getStorageKey('customPokes')),
            localforage.getItem(getStorageKey('customStatuses')),
            localforage.getItem(getStorageKey('customMottos')),
            localforage.getItem(getStorageKey('customIntros')),
            localforage.getItem(getStorageKey('disabledDefaultReplies')),
            localforage.getItem(getStorageKey('anniversaries')),
            localforage.getItem(getStorageKey('stickerLibrary')),
            localforage.getItem(`${APP_PREFIX}customThemes`),
            localforage.getItem(getStorageKey('chatBackground')),
            localforage.getItem(getStorageKey('partnerAvatar')),
            localforage.getItem(getStorageKey('myAvatar')),
            localforage.getItem(getStorageKey('partnerPersonas')), 
            localforage.getItem(getStorageKey('showPartnerNameInChat')),
            localforage.getItem(`${APP_PREFIX}themeSchemes`)
        ]);
        const getVal = (index) => results[index].status === 'fulfilled' ? results[index].value : null;

        const savedSettings = getVal(0);
        const savedMessages = getVal(1);
        const savedBgGallery = getVal(2);
        const savedCustomReplies = getVal(3);
        const savedPokes = getVal(4);
        const savedStatuses = getVal(5);
        const savedMottos = getVal(6);
        const savedIntros = getVal(7);
        const savedDisabledDefaults = getVal(8);
        const savedAnniversaries = getVal(9);
        const savedStickers = getVal(10);
        const savedCustomThemes = getVal(11);
        const savedChatBg = getVal(12);
        const partnerAvatarSrc = getVal(13);
        const myAvatarSrc = getVal(14);
        const savedPartnerPersonas = getVal(15);
        const savedShowNameConfig = getVal(16);
        const savedThemeSchemes = getVal(17);

        if (savedPartnerPersonas) partnerPersonas = savedPartnerPersonas; 

        if (savedShowNameConfig !== null) {
            showPartnerNameInChat = savedShowNameConfig;
            document.body.classList.toggle('show-partner-name', showPartnerNameInChat);
        }

        if (savedSettings) Object.assign(settings, savedSettings);
        try {
            if (settings.customFontUrl) applyCustomFont(settings.customFontUrl);
            if (settings.customBubbleCss) applyCustomBubbleCss(settings.customBubbleCss);
        } catch(e) { console.warn("Ê†∑ÂºèÂ∫îÁî®Â§±Ë¥•", e); }
        
        if (savedPokes) customPokes = savedPokes;
        else customPokes = [...CONSTANTS.POKE_ACTIONS];

        if (savedStatuses) customStatuses = savedStatuses;
        else customStatuses = [...CONSTANTS.PARTNER_STATUSES];

        if (savedMottos) customMottos = savedMottos;
        else customMottos = [...CONSTANTS.HEADER_MOTTOS];
        
        if (savedIntros) customIntros = savedIntros;
        else customIntros = CONSTANTS.WELCOME_ANIMATIONS.map(a => `${a.line1}|${a.line2}`);

        if (savedMessages && Array.isArray(savedMessages)) {
            messages = savedMessages.map(m => ({
                ...m, timestamp: new Date(m.timestamp)
            }));
        } else {
            messages = [];
        }

        if (savedBgGallery) {
            savedBackgrounds = savedBgGallery;
        } else {
            savedBackgrounds = [{ id: 'preset-1', type: 'color', value: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }];
        }

        if (savedCustomReplies) customReplies = savedCustomReplies;
        if (savedDisabledDefaults) disabledDefaultReplies = savedDisabledDefaults;
        if (savedAnniversaries) anniversaries = savedAnniversaries;
        if (savedStickers) stickerLibrary = savedStickers;
        if (savedCustomThemes) customThemes = savedCustomThemes;
        if (savedThemeSchemes) themeSchemes = savedThemeSchemes;
        window._customReplies = customReplies;
        window._disabledDefaultReplies = disabledDefaultReplies;
        window._CONSTANTS = CONSTANTS;

        if (DOMElements && DOMElements.partner && DOMElements.me) {
            updateAvatar(DOMElements.partner.avatar, partnerAvatarSrc);
            updateAvatar(DOMElements.me.avatar, myAvatarSrc);
        }

        if (savedChatBg) {
            applyBackground(savedChatBg);
        } else {
            // Fallback: check localStorage for background (compatibility with safeSetItem saves)
            const lsBg = safeGetItem(getStorageKey('chatBackground'));
            if (lsBg) {
                applyBackground(lsBg);
                // Migrate to localforage
                localforage.setItem(getStorageKey('chatBackground'), lsBg);
            }
        }
        
        try { await initMoodData(); } catch(e) { console.warn("ÂøÉÊÉÖÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•", e); }
        try { await loadEnvelopeData(); } catch(e) { console.warn("‰ø°Â∞ÅÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•", e); }
        
        displayedMessageCount = HISTORY_BATCH_SIZE;
        
        setTimeout(() => {
            applyAllAvatarFrames();
            manageAutoSendTimer(); 
            checkEnvelopeStatus(); 
            updateUI();
        }, 100);

    } catch (e) {
        console.error("LoadData ÂÜÖÈÉ®Ëá¥ÂëΩÈîôËØØ:", e);
        settings = getDefaultSettings();
        messages = [];
        updateUI();
    }
};
const LIBRARY_CONFIG = {
    reply: {
        title: "ÂõûÂ§çÂ∫ìÁÆ°ÁêÜ",
        tabs: [
            { id: 'custom', name: '‰∏ªÂ≠óÂç°', mode: 'list' },
            { id: 'default', name: 'Á≥ªÁªüÈ¢ÑËÆæ', mode: 'list' },
            { id: 'emojis', name: 'Emoji', mode: 'grid' },
            { id: 'stickers', name: 'Ë°®ÊÉÖÂ∫ì', mode: 'grid' }
        ]
    },
    atmosphere: {
        title: "Ê∞õÂõ¥ÊÑüÈÖçÁΩÆ",
        tabs: [
            { id: 'pokes', name: 'Êãç‰∏ÄÊãç', mode: 'list' },
            { id: 'statuses', name: 'ÂØπÊñπÁä∂ÊÄÅ', mode: 'list' },
            { id: 'mottos', name: 'È°∂ÈÉ®Ê†ºË®Ä', mode: 'list' },
            { id: 'intros', name: 'ÂºÄÂú∫Âä®Áîª', mode: 'list' }
        ]
    }
};
let currentAnnType = 'anniversary'; 

window.switchAnnType = function(type) {
    currentAnnType = type;
    currentAnniversaryType = type; 
    document.querySelectorAll('.ann-type-btn').forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const desc = document.getElementById('ann-type-desc');
    if(desc) {
        desc.textContent = type === 'anniversary' 
            ? 'ËÆ°ÁÆó‰ªéËøáÂéªÊüê‰∏ÄÂ§©Âà∞Áé∞Âú®Â∑≤ÁªèËøá‰∫ÜÂ§öÂ∞ëÂ§© (‰æãÂ¶Ç: Áõ∏ËØÜ„ÄÅÊÅãÁà±)' 
            : 'ËÆ°ÁÆó‰ªéÁé∞Âú®Âà∞Êú™Êù•Êüê‰∏ÄÂ§©ËøòÂâ©‰∏ãÂ§öÂ∞ëÂ§© (‰æãÂ¶Ç: ÁîüÊó•„ÄÅË∑®Âπ¥)';
    }
};

window.deleteAnniversaryItem = function(id) {
    if(confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü")) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData(); 
        renderAnniversariesList();
        showNotification('Â∑≤Âà†Èô§', 'success');
    }
};
const saveData = async () => {
    try {
        const promises = [
            localforage.setItem(getStorageKey('chatSettings'), settings),
            localforage.setItem(getStorageKey('customReplies'), customReplies),
            localforage.setItem(getStorageKey('disabledDefaultReplies'), disabledDefaultReplies),
            localforage.setItem(getStorageKey('anniversaries'), anniversaries),
            localforage.setItem(getStorageKey('customPokes'), customPokes),
            localforage.setItem(getStorageKey('customStatuses'), customStatuses),
            localforage.setItem(getStorageKey('customMottos'), customMottos),
            localforage.setItem(getStorageKey('customIntros'), customIntros),
            localforage.setItem(getStorageKey('stickerLibrary'), stickerLibrary),
            localforage.setItem(`${APP_PREFIX}customThemes`, customThemes),
            localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes),
            localforage.setItem(getStorageKey('chatMessages'), messages),
        ];

        const partnerImg = DOMElements.partner.avatar.querySelector('img');
        if (partnerImg) promises.push(localforage.setItem(getStorageKey('partnerAvatar'), partnerImg.src));
        else promises.push(localforage.removeItem(getStorageKey('partnerAvatar')));
        
        const myImg = DOMElements.me.avatar.querySelector('img');
        if (myImg) promises.push(localforage.setItem(getStorageKey('myAvatar'), myImg.src));
        else promises.push(localforage.removeItem(getStorageKey('myAvatar')));

        await Promise.all(promises);

    } catch (e) {
        console.error("‰øùÂ≠òÊï∞ÊçÆÊó∂ÂèëÁîü‰∏•ÈáçÈîôËØØ:", e);
    }
};
        function initializeRandomUI() {
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];


            document.querySelector('.header-motto').textContent = getRandomItem(CONSTANTS.HEADER_MOTTOS);
if (customMottos && customMottos.length > 0) {
    document.querySelector('.header-motto').textContent = getRandomItem(customMottos);
} else {
    document.querySelector('.header-motto').textContent = CONSTANTS.HEADER_MOTTOS[0];
}
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;


            const starsContainer = document.getElementById('stars-container');
            starsContainer.innerHTML = '';
            const starCount = 80;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const size = Math.random() * 2.5 + 0.5;
                const duration = Math.random() * 4 + 2;
                const delay = Math.random() * 6;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.animationDelay = `${delay}s`;
                starsContainer.appendChild(star);
            }
            const particlesContainer = document.getElementById('welcome-particles');
            if (particlesContainer) {
                particlesContainer.innerHTML = '';
                const types = ['petal', 'petal', 'petal', 'sparkle', 'sparkle'];
                for (let i = 0; i < 22; i++) {
                    const p = document.createElement('div');
                    const type = types[i % types.length];
                    p.className = `wp ${type}`;
                    const sz = type === 'petal' ? (Math.random() * 6 + 5) : (Math.random() * 4 + 2);
                    p.style.setProperty('--pSz', sz + 'px');
                    p.style.left = (Math.random() * 100) + '%';
                    p.style.setProperty('--pDur', (Math.random() * 10 + 9) + 's');
                    p.style.setProperty('--pDel', (Math.random() * 8) + 's');
                    p.style.setProperty('--pX1', (Math.random() * 50 - 25) + 'px');
                    p.style.setProperty('--pX2', (Math.random() * 80 - 40) + 'px');
                    p.style.setProperty('--pX3', (Math.random() * 50 - 25) + 'px');
                    particlesContainer.appendChild(p);
                }
            }

            const meteorsContainer = document.getElementById('welcome-meteors');
            if (meteorsContainer) {
                meteorsContainer.innerHTML = '';
                let meteorCount = 0;
                const MAX_METEORS = 12;
                const createMeteor = () => {
                    if (meteorCount >= MAX_METEORS) return;
                    meteorCount++;
                    const m = document.createElement('div');
                    m.className = 'meteor';
                    m.style.left = (Math.random() * 100) + '%';
                    m.style.top = (Math.random() * 35) + '%';
                    const dur = (Math.random() * 0.8 + 0.7);
                    m.style.setProperty('--mDur', dur + 's');
                    m.style.setProperty('--mDel', '0s');
                    m.style.setProperty('--mRot', (25 + Math.random() * 20) + 'deg');
                    meteorsContainer.appendChild(m);
                    setTimeout(() => { m.remove(); meteorCount = Math.max(0, meteorCount - 1); }, (dur + 0.1) * 1000);
                };
                for (let i = 0; i < 8; i++) setTimeout(createMeteor, i * 350);
                const meteorTimer = setInterval(createMeteor, 600);
                setTimeout(() => clearInterval(meteorTimer), 5000);
            }

            const loaderBarEl = document.getElementById('loader-tech-bar');
            if (loaderBarEl) {
                setTimeout(() => loaderBarEl.classList.add('pulsing'), 300);
            }


            const welcomeIcon = getRandomItem(CONSTANTS.WELCOME_ICONS);
document.querySelector('.logo-icon-main').innerHTML = `<i class="${welcomeIcon}"></i>`;

if (customIntros && customIntros.length > 0) {
    const rawIntro = getRandomItem(customIntros);
    const parts = rawIntro.split('|');
    const line1 = parts[0];
    const line2 = parts[1] || ""; 

    const titleEl = document.getElementById('welcome-title-glitch');
    const subEl = document.getElementById('welcome-subtitle-scramble');

    titleEl.classList.remove('playing');
    titleEl.textContent = line1;
    void titleEl.offsetWidth;
    titleEl.classList.add('playing');

    const scrambleText = (element, finalText, duration = 1500) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()';
                const length = finalText.length;
                let start = Date.now();

                const interval = setInterval(() => {
                    const now = Date.now();
                    const progress = (now - start) / duration;

                    if (progress >= 1) {
                        element.textContent = finalText;
                        clearInterval(interval);
                        return;
                    }

                    let result = '';

                    const revealIndex = Math.floor(progress * length);

                    for (let i = 0; i < length; i++) {
                        if (i <= revealIndex) {
                            result += finalText[i];
                        } else {

                            result += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }
                    element.textContent = result;
                },
                    40);
            };


          setTimeout(() => {
        scrambleText(subEl, line2, 2000);
    }, 600);
} else {
    document.getElementById('welcome-title-glitch').textContent = "‰º†ËÆØ";
    document.getElementById('welcome-subtitle-scramble').textContent = "ËØ∑Âú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†ÂºÄÂú∫Âä®Áîª";
}


            const loaderBar = document.getElementById('loader-tech-bar');
            const statusText = document.getElementById('loader-status-text');
            loaderBar.style.width = '0%';
            const loadingPhases = [
                { width: '15%', text: 'INITIALIZING ¬∑ ÂàùÂßãÂåñ‰∏≠' },
                { width: '40%', text: 'LOADING MEMORIES ¬∑ ËØªÂèñËÆ∞ÂøÜ' },
                { width: '70%', text: 'BUILDING WORLD ¬∑ ÊûÑÂª∫‰∏ñÁïå' },
                { width: '90%', text: 'ALMOST THERE ¬∑ Âç≥Â∞ÜÂÆåÊàê' },
                { width: '100%', text: 'CONNECTED ¬∑ ËøûÊé•ÊàêÂäü' }
            ];
            const delays = [100, 700, 1600, 2400, 2900];
            delays.forEach((delay, i) => {
                setTimeout(() => {
                    loaderBar.style.width = loadingPhases[i].width;
                    if (statusText) statusText.textContent = loadingPhases[i].text;
                }, delay);
            });
        }
function manageAutoSendTimer() {
    if (autoSendTimer) {
        clearInterval(autoSendTimer);
        autoSendTimer = null;
    }
    if (settings.autoSendEnabled) {
        const intervalMs = settings.autoSendInterval * 60 * 1000;
        console.log(`‰∏ªÂä®ÂèëÈÄÅÂ∑≤ÂºÄÂêØÔºåÈó¥Èöî: ${settings.autoSendInterval}ÂàÜÈíü`);
        
        autoSendTimer = setInterval(() => {
            if (!document.body.classList.contains('batch-favorite-mode')) {
                simulateReply(); 
            }
        }, intervalMs);
    }
}

        const updateUI = () => {
            const isCustomTheme = settings.colorTheme.startsWith('custom-');
            if (isCustomTheme) {
                const themeId = settings.colorTheme;
                const theme = customThemes.find(t => t.id === themeId);
                if (theme) {
                    applyTheme(theme.colors);
                } else {
                    DOMElements.html.setAttribute('data-color-theme', 'gold');
                }
            } else {
                DOMElements.html.setAttribute('data-color-theme', settings.colorTheme);
                applyTheme(null, true);
            }

            DOMElements.html.setAttribute('data-theme', settings.isDarkMode ? 'dark': 'light');
            DOMElements.themeToggle.innerHTML = settings.isDarkMode ? '<i class="fas fa-sun"></i>': '<i class="fas fa-moon"></i>';
            DOMElements.partner.name.textContent = settings.partnerName;
            DOMElements.me.name.textContent = settings.myName;
            // ÈöèÊú∫ÊòæÁ§∫ÂØπÊñπÁä∂ÊÄÅÔºàËã•Áä∂ÊÄÅÊ±†ÊúâÂÜÖÂÆπÔºâ
            var displayStatus = settings.partnerStatus;
            if (customStatuses && customStatuses.length > 0 && (displayStatus === 'Âú®Á∫ø' || !displayStatus)) {
                displayStatus = customStatuses[Math.floor(Math.random() * customStatuses.length)];
                settings.partnerStatus = displayStatus;
            }
            DOMElements.partner.status.textContent = displayStatus;
            DOMElements.me.statusText.textContent = settings.myStatus;
            // Update all dynamic name references
            if (typeof window.updateDynamicNames === 'function') window.updateDynamicNames();
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            
            const fontToUse = settings.messageFontFamily || "'Noto Serif SC', serif";
            
            document.documentElement.style.setProperty('--message-font-family', fontToUse);
            document.documentElement.style.setProperty('--font-family', fontToUse);
            document.documentElement.style.setProperty('--message-font-weight', settings.messageFontWeight);
            document.documentElement.style.setProperty('--message-line-height', settings.messageLineHeight);

            document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);

            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
            });

            renderMessages();
        };

        const updateAvatar = (element, src) => {
            if (src) element.innerHTML = `<img src="${src}" alt="avatar">`; else element.innerHTML = `<i class="fas fa-user"></i>`;
        };

        const removeBackground = () => {
            document.documentElement.style.removeProperty('--chat-bg-image');
            document.body.classList.remove('with-background');
            localforage.removeItem(getStorageKey('chatBackground'));
            safeRemoveItem(getStorageKey('chatBackground'));
            showNotification('ËÉåÊôØÂõæÁâáÂ∑≤ÁßªÈô§', 'success');
        };

        function renderMessages(preserveScroll = false) {
            const container = DOMElements.chatContainer;
            const totalMessages = messages.length;

            const startIndex = Math.max(0, totalMessages - displayedMessageCount);
            const msgsToRender = messages.slice(startIndex);

            DOMElements.emptyState.style.display = totalMessages === 0 ? 'flex': 'none';

            const oldScrollHeight = container.scrollHeight;
            
            container.innerHTML = '';

            const fragment = new DocumentFragment();
            let currentDate = '';
            let lastSender = null;

            msgsToRender.forEach((msg, index) => {
                const messageDate = new Date(msg.timestamp).toDateString();
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    const displayDate = (messageDate === today) ? '‰ªäÂ§©': (messageDate === yesterday) ? 'Êò®Â§©': new Date(msg.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    dateDivider.innerHTML = `<span>${displayDate}</span>`;
                    fragment.appendChild(dateDivider);
                    lastSender = null; 
                }

                if (msg.type === 'system') {
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message';
                    systemMsgDiv.innerHTML = msg.text;
                    fragment.appendChild(systemMsgDiv);
                    lastSender = 'system';
                    return;
                }

                let showTimestamp = true;
                if (index < msgsToRender.length - 1) {
                    const nextMsg = msgsToRender[index + 1];
                    const currentTs = new Date(msg.timestamp).getTime();
                    const nextTs = new Date(nextMsg.timestamp).getTime();
                    
                    if (nextMsg.sender === msg.sender && 
                        nextMsg.type !== 'system' && 
                        (nextTs - currentTs < 60000)) {
                        showTimestamp = false;
                    }
                }

                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent': 'received'}`;
                wrapper.dataset.id = msg.id;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';

                const groupMember = (msg.sender !== 'user' && typeof getGroupMemberForMessage === 'function') ? getGroupMemberForMessage(msg.id) : null;

                if (settings.inChatAvatarEnabled) {
                    const isSameSenderGroup = groupMember && lastSender === 'group_' + (groupMember ? groupMember.name : '');
                    const isSameSenderNormal = !groupMember && msg.sender === lastSender;
                    if (isSameSenderGroup || isSameSenderNormal) {
                        avatarDiv.classList.add('hidden');
                    } else if (groupMember) {
                        if (groupMember.avatar) {
                            avatarDiv.innerHTML = `<img src="${groupMember.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        } else {
                            const initials = (groupMember.name || '?').charAt(0).toUpperCase();
                            avatarDiv.innerHTML = `<div style="width:100%;height:100%;border-radius:50%;background:var(--accent-color);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;">${initials}</div>`;
                        }
                    } else {
                        const isUser = msg.sender === 'user';
                        const avatarElement = isUser ? DOMElements.me.avatar : DOMElements.partner.avatar;
                        const frameSettings = isUser ? settings.myAvatarFrame : settings.partnerAvatarFrame;
                        const avatarShape = isUser ? (settings.myAvatarShape || 'circle') : (settings.partnerAvatarShape || 'circle');
                        avatarDiv.innerHTML = avatarElement.innerHTML;
                        applyAvatarFrame(avatarDiv, frameSettings);
                        // Apply shape
                        ['circle','square','pentagon','heart'].forEach(s => avatarDiv.classList.remove('shape-' + s));
                        if (avatarShape !== 'none') avatarDiv.classList.add('shape-' + avatarShape);
                    }
                } else {
                    avatarDiv.style.display = 'none';
                }
                wrapper.appendChild(avatarDiv);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';

                if (groupMember && groupChatSettings.showName) {
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'group-sender-name';
                    nameLabel.textContent = groupMember.name;
                    const isSameSenderGroupForName = lastSender === 'group_' + groupMember.name;
                    if (!isSameSenderGroupForName) contentWrapper.appendChild(nameLabel);
                }
                
                let messageHTML = '';
                if (msg.replyTo) {
                    const repliedText = msg.replyTo.text || (msg.replyTo.image ? 'üñº ÂõæÁâá' : '[Ê∂àÊÅØ]');
                    const repliedSender = msg.replyTo.sender === 'user' ? (settings.myName || 'Êàë') : (settings.partnerName || 'ÂØπÊñπ');
                    messageHTML += `<div class="reply-indicator"><span class="reply-indicator-sender">${repliedSender}</span><span class="reply-indicator-text">${repliedText}</span></div>`;
                }

                let content = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>`: '';
                if (msg.image) content += `<img src="${msg.image}" class="message-image" alt="ÂõæÁâá" style="max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="viewImage('${msg.image}')">`;
                messageHTML += content;

                if (msg.note) messageHTML += `<div class="message-note">${msg.note}</div>`;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${msg.sender === 'user' ? 'sent': 'received'} ${settings.bubbleStyle}`;
                messageDiv.innerHTML = messageHTML;

                let actionsHTML = '';
                
                if (settings.replyEnabled) actionsHTML += `<button class="meta-action-btn reply-btn" title="ÂõûÂ§ç"><i class="fas fa-reply"></i></button>`;
                
                const starIcon = msg.favorited ? 'fas fa-star' : 'far fa-star'; 
                actionsHTML += `<button class="meta-action-btn favorite-action-btn ${msg.favorited ? 'favorited' : ''}" title="${msg.favorited ? 'ÂèñÊ∂àÊî∂Ëóè' : 'Êî∂Ëóè'}"><i class="${starIcon}"></i></button>`;
                
                actionsHTML += `<button class="meta-action-btn note-btn" title="Ê≥®Èáä"><i class="fas fa-sticky-note"></i></button>`;
actionsHTML += `<button class="meta-action-btn delete-btn" title="Âà†Èô§"><i class="fas fa-trash-alt"></i></button>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-meta-actions';
                actionsDiv.innerHTML = actionsHTML;

                let metaHTML = '';
                
                if (showTimestamp) {
                    const ts = new Date(msg.timestamp);
                    let timeStr;
                    const fmt = settings.timeFormat || 'HH:mm';
                    if (fmt === 'HH:mm:ss') {
                        timeStr = ts.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    } else if (fmt === 'h:mm AM/PM') {
                        timeStr = ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    } else if (fmt === 'h:mm:ss AM/PM') {
                        timeStr = ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
                    } else {
                        timeStr = ts.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                    }
                    metaHTML += `<div class="timestamp">${timeStr}</div>`;
                }

                if (msg.sender === 'user' && settings.readReceiptsEnabled && showTimestamp) {
                    const statusIcon = msg.status === 'read' ? 'fa-check-double': 'fa-check';
                    metaHTML += `<div class="read-receipt ${msg.status === 'read' ? 'read': ''}"><i class="fas ${statusIcon}"></i></div>`;
                }

                if (metaHTML !== '') {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'message-meta';
                    if (!showTimestamp && !metaHTML.includes('timestamp')) {
                         metaDiv.style.height = 'auto'; 
                         metaDiv.style.marginTop = '2px';
                    }
                    metaDiv.innerHTML = metaHTML;
                    contentWrapper.append(actionsDiv, messageDiv, metaDiv);
                } else {
                    contentWrapper.append(actionsDiv, messageDiv);
                }

                wrapper.appendChild(contentWrapper);
                fragment.appendChild(wrapper);
                
                lastSender = groupMember ? ('group_' + groupMember.name) : msg.sender;
            });

            container.appendChild(fragment);

            if (preserveScroll) {
                const newScrollHeight = container.scrollHeight;
                const delta = newScrollHeight - oldScrollHeight;
                container.scrollTop = Math.max(0, container.scrollTop + delta);
            } else {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }        

        const addMessage = (message) => {
            if (!(message.timestamp instanceof Date)) message.timestamp = new Date(message.timestamp);
            messages.push(message);


            displayedMessageCount++;


            renderMessages(false);
            throttledSaveData();
        };

        function optimizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.size < 300 * 1024) {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let {
                        width,
                        height
                    } = img;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function sendMessage(textOverride = null, type = 'normal') {
            const text = textOverride || DOMElements.messageInput.value.trim();
            const imageFile = DOMElements.imageInput.files[0];
            if (!text && !imageFile && type === 'normal') return;

            DOMElements.messageInput.value = '';
            DOMElements.messageInput.style.height = '46px';
            if (imageFile && imageFile.size > MAX_IMAGE_SIZE) {
                showNotification('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB', 'error'); DOMElements.imageInput.value = ''; return;
            }

            const createMessage = (imgSrc = null) => {
                const messageData = {
                    id: Date.now(),
                    sender: 'user',
                    text: text || '',
                    timestamp: new Date(),
                    image: imgSrc,
                    status: 'sent',
                    favorited: false,
                    note: null,
                    replyTo: currentReplyTo,
                    type: type
                };
                if (type === 'system') messageData.sender = null;

                addMessage(messageData);
                if (type !== 'system') playSound('send');
                currentReplyTo = null;
                updateReplyPreview();

if (!isBatchMode && type === 'normal') {
    const delayRange = settings.replyDelayMax - settings.replyDelayMin;
    const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
    
    setTimeout(() => {
        let changed = false;
        messages.forEach(msg => {
            if (msg.sender === 'user' && msg.status !== 'read') {
                msg.status = 'read'; 
                changed = true;
            }
        });
        if (changed) {
            renderMessages(false); 
            throttledSaveData();
        }

        const shouldIgnore = settings.allowReadNoReply && (Math.random() < settings.readNoReplyChance);

        if (shouldIgnore) {
            console.log("Ëß¶ÂèëÂ∑≤ËØª‰∏çÂõûÊú∫Âà∂");
        } else {
            simulateReply(); 
        }

    }, randomDelay);
}
};

            if (imageFile) {
                showNotification('Ê≠£Âú®‰ºòÂåñÂõæÁâá...', 'info', 1500);
                optimizeImage(imageFile).then(createMessage).catch(() => showNotification('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•', 'error'));
            } else {
                createMessage();
            }
            DOMElements.imageInput.value = '';
        }

        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            DOMElements.batchBtn.classList.toggle('active', isBatchMode);
            DOMElements.batchBtn.title = isBatchMode ? "ÈÄÄÂá∫ÊâπÈáèÊ®°Âºè": "ÊâπÈáèÂèëÈÄÅÊ®°Âºè";
            DOMElements.batchPreview.style.display = isBatchMode ? 'flex': 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = isBatchMode ? "Ê≠§ÂàªÔºåÊÉ≥ËØ¥ÁöÑÊúâÂæàÂ§öÂæàÂ§ö...": (placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder);
            if (isBatchMode) {
                batchMessages = []; updateBatchPreview();
            }
        }

        function addToBatch() {
            const text = DOMElements.messageInput.value.trim();
            if (!text) return;
            batchMessages.push({
                id: Date.now() + batchMessages.length, text
            });
            DOMElements.messageInput.value = ''; DOMElements.messageInput.style.height = '46px';
            updateBatchPreview();
        }

        function updateBatchPreview() {
            const previewContainer = DOMElements.batchPreview;
            let listHTML = '';
            if (batchMessages.length > 0) {
                listHTML = batchMessages.map((msg, index) => `
                <div class="batch-preview-item" data-index="${index}">
                <span class="batch-preview-text">${msg.text}</span>
                <button class="batch-preview-remove"><i class="fas fa-times"></i></button>
                </div>`).join('');
            } else {
                listHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 10px;">„Å§‚ô°‚äÇ</div>';
            }

            previewContainer.innerHTML = `
        <div class="batch-preview-title">ÊàëÊúâÂæàÂ§öÁöÑËØùÊÉ≥ËØ¥‚Ä¶ÔºÅ</div>
        <div class="batch-preview-list">${listHTML}</div>
        <div class="batch-actions">
        <button class="batch-action-btn batch-cancel-btn">ÂèñÊ∂à</button>
        <button class="batch-action-btn batch-send-btn" ${batchMessages.length === 0 ? 'disabled': ''}>ÂèëÈÄÅÂÖ®ÈÉ® (${batchMessages.length})</button>
        </div>`;
        }

        function sendBatchMessages() {
            if (batchMessages.length === 0) return;
            showNotification(`Ê≠£Âú®ÂèëÈÄÅ ${batchMessages.length} Êù°Ê∂àÊÅØ...`, 'info', 2000);
            batchMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage({
                        id: Date.now() + index, sender: 'user', text: msg.text, timestamp: new Date(), status: 'sent', favorited: false, type: 'normal'
                    });
                    playSound('send');
                }, index * 300);
            });
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, batchMessages.length * 300 + randomDelay);
            isBatchMode = false; batchMessages = [];
            DOMElements.batchBtn.classList.remove('active'); DOMElements.batchPreview.style.display = 'none';
            const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
        }

        function simulateReply() {
            if (settings.typingIndicatorEnabled) {
        DOMElements.typingIndicator.style.display = 'block'; 
        DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
    }
            let changed = false;
            messages.forEach(msg => {
                if (msg.sender === 'user' && msg.status !== 'read') {
                    msg.status = 'read'; changed = true;
                }
            });
            if (changed) {
                renderMessages(false); throttledSaveData();
            }
            if (settings.typingIndicatorEnabled) {
                DOMElements.typingIndicator.style.display = 'block'; DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            }
if (partnerPersonas && partnerPersonas.length > 0 && Math.random() < 0.3) {
                const currentPool = [
                    ...partnerPersonas
                ];
                if(currentPool.length > 0) {
                     const nextPersona = currentPool[Math.floor(Math.random() * currentPool.length)];
                     
                     settings.partnerName = nextPersona.name;
                     DOMElements.partner.name.textContent = nextPersona.name;
                     
                     if (nextPersona.avatar) {
                         updateAvatar(DOMElements.partner.avatar, nextPersona.avatar);
                         localforage.setItem(getStorageKey('partnerAvatar'), nextPersona.avatar);
                     }
                     throttledSaveData();
                }
            }
            if (Math.random() < 0.03) {
                if (customPokes && customPokes.length > 0) {
        const randomAction = getRandomItem(customPokes);
                const pokeTypes = [{
                    prefix: "üí´",
                    text: `${settings.partnerName} ${randomAction}`
                },
                    {
                        prefix: "‚ú®",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "üåü",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ü•∞",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "üíñ",
                        text: `${settings.partnerName} ${randomAction}`
                    }];

               const selectedPoke = getRandomItem(pokeTypes);
        
        addMessage({
            id: Date.now(),
            text: `${selectedPoke.prefix} ${settings.partnerName} ${randomAction} ${selectedPoke.prefix}`,
            timestamp: new Date(),
            type: 'system'
        });
        DOMElements.typingIndicator.style.display = 'none';
        return;
    }
}

            const replyCount = Math.random() < 0.75 ? 1: (Math.random() < 0.95 ? 2: 3);
            let delay = 0;
            for (let i = 0; i < replyCount; i++) {
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                delay += settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(() => {
let text = null;
let image = null;

const activeEmojis = CONSTANTS.REPLY_EMOJIS.filter(e => !disabledDefaultReplies.includes(e));
const nonTextPool = [...activeEmojis, ...stickerLibrary];

const activeDefaults = CONSTANTS.REPLY_MESSAGES.filter(msg => !disabledDefaultReplies.includes(msg));
const textPool = [...activeDefaults, ...customReplies];

if (Math.random() < 0.15 && nonTextPool.length > 0) { 
    const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) { 
        image = result;
    } else { 
        text = result;
    }
} else if (textPool.length > 0) {
    text = getRandomItem(textPool);
} else if (nonTextPool.length > 0) { 
     const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) {
        image = result;
    } else {
        text = result;
    }
} else {
    text = "ÔºàÊàë‰∏çÁü•ÈÅìËØ•ËØ¥‰ªÄ‰πà‰∫Ü...Ôºâ";
}

let replyTo = null;
if (settings.replyEnabled && Math.random() < 0.1) {
    const userMessages = messages.filter(m => m.sender === 'user').slice(-10);
    if (userMessages.length > 0) {
        const randomMessage = getRandomItem(userMessages);
        replyTo = {
            id: randomMessage.id,
            sender: randomMessage.sender,
            text: randomMessage.text
        };
    }
}

addMessage({
    id: Date.now() + i,
    sender: 'partner',
    text: text,
    image: image, 
    timestamp: new Date(),
    favorited: false,
    replyTo,
    type: 'normal'
});
                    playSound('message');
                    if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                        const notifTitle = settings.partnerName || 'ÂØπÊñπ';
                        const notifBody = text ? text.slice(0, 60) : '[ÂõæÁâáÊ∂àÊÅØ]';
                        try {
                            new Notification(notifTitle, {
                                body: notifBody,
                                icon: document.getElementById('partner-avatar')?.querySelector('img')?.src || undefined,
                                tag: 'new-message',
                                renotify: true
                            });
                        } catch(e) {}
                    }
                    if (i === replyCount - 1) DOMElements.typingIndicator.style.display = 'none';
                },
                    delay);
            }
        }


        function startCoinFlipAnimation() {
            const overlay = DOMElements.coinTossOverlay;
            const coin = DOMElements.animatedCoin;
            const resultText = DOMElements.coinResultText;


            overlay.classList.remove('finished');
            coin.classList.remove('flipping-heads', 'flipping-tails');


            void coin.offsetWidth;


            resultText.textContent = 'ÂëΩËøêÊäâÊã©‰∏≠...';


            const isHeads = Math.random() < 0.5;
            const result = isHeads ? 'ÊòØ': 'Âê¶';
            const animationClass = isHeads ? 'flipping-heads': 'flipping-tails';


            requestAnimationFrame(() => {
                coin.classList.add(animationClass);
            });


            const onAnimationEnd = () => {

                const fancyText = isHeads ? "Á≠îÊ°àÊòØ ¬∑ ÊòØ": "Á≠îÊ°àÊòØ ¬∑ Âê¶";
                resultText.textContent = fancyText;


                lastCoinResult = result;


                overlay.classList.add('finished');
            };


            coin.addEventListener('animationend', onAnimationEnd, {
                once: true
            });
        }


        function handleCoinToss() {
            DOMElements.coinTossOverlay.classList.add('visible');
            startCoinFlipAnimation();
        }

        function updateReplyPreview() {
            const previewContainer = DOMElements.replyPreviewContainer;
            previewContainer.innerHTML = '';

            if (currentReplyTo) {
                const preview = document.createElement('div');
                preview.className = 'reply-preview';
                const repliedText = currentReplyTo.text || (currentReplyTo.image ? 'üñº ÂõæÁâá' : '[Ê∂àÊÅØ]');
                const senderName = currentReplyTo.sender === 'user' ? (settings.myName || 'Êàë') : (settings.partnerName || 'ÂØπÊñπ');
                preview.innerHTML = `<div class="reply-preview-content"><span style="font-size:11px;font-weight:600;color:var(--accent-color);display:block;margin-bottom:2px;">ÂõûÂ§ç ${senderName}</span><span>${repliedText}</span></div><button class="reply-preview-remove"><i class="fas fa-times"></i></button>`;
                preview.querySelector('.reply-preview-remove').addEventListener('click', () => {
                    currentReplyTo = null; updateReplyPreview();
                });
                previewContainer.appendChild(preview);
            }
        }


        function renderFavorites() {
            const list = DOMElements.favoritesModal.list;

            const favoritedMessages = messages.filter(m => m.favorited).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (favoritedMessages.length === 0) {
                list.innerHTML = `
            <div class="no-favorites">
            <i class="fas fa-folder-open"></i>
            <p>ÊòüÁêÉÁöÑËßíËêΩÁ©∫Á©∫Â¶Ç‰πü...</p>
            <span style="font-size:12px; margin-top:5px; opacity:0.7">ÁÇπÂáªÊ∂àÊÅØÊóÅÁöÑÊòüÊòüÂç≥ÂèØÊî∂Ëóè</span>
            </div>`;
                return;
            }

            list.innerHTML = favoritedMessages.map(msg => {

                const isMe = msg.sender === 'user';

                const avatarSrc = isMe
                ? (document.getElementById('my-avatar').querySelector('img')?.src || ''): (document.getElementById('partner-avatar').querySelector('img')?.src || '');

                const avatarHTML = avatarSrc
                ? `<img src="${avatarSrc}" class="fav-avatar" alt="avatar">`: `<div class="fav-avatar"><i class="fas fa-user"></i></div>`;

                const name = isMe ? settings.myName: settings.partnerName;


                let contentHTML = msg.text ? `<span>${msg.text.replace(/\n/g, '<br>')}</span>`: '';
                if (msg.image) contentHTML += `<img src="${msg.image}" alt="ÂõæÁâá" loading="lazy">`;


                const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                return `
            <div class="fav-card" id="fav-card-${msg.id}">
            ${avatarHTML}
            <div class="fav-content-wrapper">
            <div class="fav-header">
            <span class="fav-sender-name">${name}</span>
            <span style="opacity:0.6">${timeStr}</span>
            </div>
            <div class="fav-bubble">
            ${contentHTML}
            </div>
            <button class="fav-action-btn" onclick="removeFavorite(${msg.id})">
            <i class="fas fa-trash-alt"></i> ÁßªÈô§
            </button>
            </div>
            </div>`;
            }).join('');
        }


        window.removeFavorite = function(msgId) {
            const message = messages.find(m => m.id === msgId);
            if (message) {
                message.favorited = false;

                const card = document.getElementById(`fav-card-${msgId}`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        renderFavorites();
                        throttledSaveData();
                        const chatMsgBtn = document.querySelector(`.message-wrapper[data-id="${msgId}"] .favorite-meta-btn`);
                        if (chatMsgBtn) chatMsgBtn.classList.remove('favorited');
                    },
                        300);
                }
            }
        };

        function showModal(modalElement, focusElement = null) {
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                const content = modalElement.querySelector('.modal-content');
                content.style.opacity = '1';
                content.style.transform = 'translateY(0) scale(1)';
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 100);
                }
            });
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            content.style.opacity = '0';
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => {
                modalElement.style.display = 'none';
            }, 300);
        }

        function viewImage(src) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content" style="max-width: 90%; max-height: 90%; background: transparent; box-shadow: none; padding: 0;"><img src="${src}" style="max-width: 100%; max-height: 100%; object-fit: contain; display: block;"></div>`;
            const closeModal = () => document.body.removeChild(modal);
            modal.addEventListener('click', closeModal);
            document.body.appendChild(modal);
        }

        function exportChatHistory() {
            try {
                // Gather announcement/custom settings
                let dgCustomData = null, dgStatusPool = null, customWeatherMap = {};
                try { dgCustomData = JSON.parse(localStorage.getItem('dg_custom_data') || 'null'); } catch(e2) {}
                try { dgStatusPool = JSON.parse(localStorage.getItem('dg_status_pool') || 'null'); } catch(e2) {}
                // Also grab customWeather entries
                for (var ki = 0; ki < localStorage.length; ki++) {
                    var kk = localStorage.key(ki);
                    if (kk && kk.startsWith('customWeather_')) customWeatherMap[kk] = localStorage.getItem(kk);
                }
                const dataStr = JSON.stringify({
                    version: "3.0",
                    exportDate: new Date().toISOString(),
                    messages,
                    settings,
                    customReplies,
                    anniversaries,
                    customThemes,
                    stickerLibrary,
                    dgCustomData,
                    dgStatusPool,
                    customWeatherMap
                },
                    null,
                    2);


                if (navigator.share && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {

                    const blob = new Blob([dataStr], {
                        type: 'application/json;charset=utf-8'
                    });
                    const file = new File([blob], `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`, {
                        type: 'application/json'
                    });

                    if (navigator.canShare && navigator.canShare({
                        files: [file]
                    })) {
                        navigator.share({
                            files: [file],
                            title: 'ËÅäÂ§©ËÆ∞ÂΩïÂ§á‰ªΩ',
                            text: `ËÅäÂ§©ËÆ∞ÂΩïÂ§á‰ªΩ - ${new Date().toLocaleDateString()}`
                        }).then(() => {
                            showNotification('ÂàÜ‰∫´ÊàêÂäü', 'success');
                        }).catch((error) => {
                            console.error('ÂàÜ‰∫´Â§±Ë¥•:', error);
                            fallbackExport(dataStr);
                        });
                    } else {
                        fallbackExport(dataStr);
                    }
                } else {

                    fallbackExport(dataStr);
                }
            } catch (error) {
                console.error('ÂØºÂá∫Â§±Ë¥•:', error);
                showNotification('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        }

        function fallbackExport(dataStr) {
            const dataBlob = new Blob([dataStr], {
                type: 'application/json;charset=utf-8'
            });
            const url = URL.createObjectURL(dataBlob);


            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);


            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(`ÊàêÂäüÂØºÂá∫ ${messages.length} Êù°Ê∂àÊÅØ`, 'success');
        }

        function importChatHistory(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.messages || !Array.isArray(importedData.messages)) throw new Error('Êó†ÊïàÁöÑËÅäÂ§©ËÆ∞ÂΩïÊñá‰ª∂');
                    if (messages.length > 0 && !confirm('ÂØºÂÖ•Â∞ÜË¶ÜÁõñÂΩìÂâç‰ºöËØùÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) return;

                    messages = importedData.messages.map(m => ({
                        ...m, timestamp: new Date(m.timestamp)
                    }));
                    if (importedData.settings) Object.assign(settings, importedData.settings);
                    if (importedData.customReplies) customReplies = importedData.customReplies;
                    if (importedData.anniversaries) anniversaries = importedData.anniversaries;
                    if(importedData.customThemes) customThemes = importedData.customThemes;
                    if(importedData.stickerLibrary) stickerLibrary = importedData.stickerLibrary;
                    if(importedData.dgCustomData) { try { localStorage.setItem('dg_custom_data', JSON.stringify(importedData.dgCustomData)); } catch(e2) {} }
                    if(importedData.dgStatusPool) { try { localStorage.setItem('dg_status_pool', JSON.stringify(importedData.dgStatusPool)); } catch(e2) {} }
                    if(importedData.customWeatherMap) { try { for(var wk in importedData.customWeatherMap) localStorage.setItem(wk, importedData.customWeatherMap[wk]); } catch(e2) {} }

                    saveData();
                    updateUI();
                    showNotification(`ÊàêÂäüÂØºÂÖ• ${messages.length} Êù°Ê∂àÊÅØ`, 'success');
                } catch (error) {
                    console.error('ÂØºÂÖ•Â§±Ë¥•:', error);
                    showNotification('Êñá‰ª∂Ê†ºÂºèÈîôËØØÊàñÂ∑≤ÊçüÂùè', 'error');
                }
            };
            reader.onerror = () => showNotification('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', 'error');
            reader.readAsText(file);
        }

        const checkStatusChange = () => {
            if ((Date.now() - settings.lastStatusChange) / 36e5 >= settings.nextStatusChange) {
if (customStatuses && customStatuses.length > 0) {
    settings.partnerStatus = getRandomItem(customStatuses);
}
                settings.lastStatusChange = Date.now();
                settings.nextStatusChange = 1 + Math.random() * 7;
                DOMElements.partner.status.textContent = settings.partnerStatus;
                throttledSaveData();
            }
        };


function renderStatsContent() {
            const statsContent = DOMElements.statsModal.content;

            const partnerMessages = messages.filter(msg =>
                msg.sender === 'partner' &&
                msg.text &&
                msg.type !== 'system'
            );
            
            const myMessages = messages.filter(msg =>
                msg.sender === 'user' &&
                msg.text &&
                msg.type !== 'system'
            );

            if (partnerMessages.length === 0 && myMessages.length === 0) {
                statsContent.innerHTML = `
                    <div class="stats-empty-state">
                        <div class="stats-empty-icon"><i class="fas fa-chart-pie"></i></div>
                        <h3>ÊöÇÊó†Êï∞ÊçÆ</h3>
                        <p>Â§öËÅäÂá†Âè•ÂÜçÊù•ÁúãÁúãÂêß...</p>
                    </div>`;
                return;
            }

            const getTopReplies = (msgs) => {
                const countMap = {};
                msgs.forEach(msg => {
                    const text = msg.text.trim();
                    if (text) {
                        countMap[text] = (countMap[text] || 0) + 1;
                    }
                });
                return Object.entries(countMap)
                    .map(([text, count]) => ({ text, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); 
            };

            const partnerTop = getTopReplies(partnerMessages);
            const myTop = getTopReplies(myMessages);

            const generateRankHTML = (list) => {
                if (list.length === 0) return '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
                const maxVal = list[0].count;
                return list.map((item, index) => {
                    const percent = (item.count / maxVal) * 100;
                    return `
                    <div class="rank-item">
                        <div class="rank-progress-bg" style="width: ${percent}%; opacity: 0.1; background-color: var(--text-primary);"></div>
                        <div class="rank-info">
                            <div class="rank-number">#${index + 1}</div>
                            <div class="rank-text" title="${item.text}">${item.text}</div>
                            <div class="rank-count">${item.count}Ê¨°</div>
                        </div>
                    </div>`;
                }).join('');
            };

            const allMsgs = messages.filter(m => m.timestamp);
            const firstMsg = allMsgs.length > 0 ? allMsgs[0] : { timestamp: new Date() };
            const lastMsg = allMsgs.length > 0 ? allMsgs[allMsgs.length - 1] : { timestamp: new Date() };

            const formatDate = (dateObj) => {
                return new Date(dateObj).toLocaleDateString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
            };

            statsContent.innerHTML = `
                <div class="stats-dashboard">
                    <div class="stats-overview-grid">
                        <div class="overview-item">
                            <div class="overview-value">${messages.length}</div>
                            <div class="overview-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${myMessages.length}</div>
                            <div class="overview-label">ÊàëÂèëÈÄÅÁöÑ</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(firstMsg.timestamp)}</div>
                            <div class="overview-label">ÂàùÊ¨°Áõ∏ÈÅá</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(lastMsg.timestamp)}</div>
                            <div class="overview-label">ÊúÄËøëËÅîÁªú</div>
                        </div>
                    </div>

                    <div class="stats-card">
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <button id="stats-toggle-partner" class="stats-toggle-btn active" onclick="switchStatsView('partner')">
                                <i class="fas fa-user-circle"></i> ÂØπÊñπ
                            </button>
                            <button id="stats-toggle-me" class="stats-toggle-btn" onclick="switchStatsView('me')">
                                <i class="fas fa-user"></i> ÊàëÊñπ
                            </button>
                        </div>
                        <div class="stats-card-title" id="stats-rank-title">
                            <i class="fas fa-user-circle"></i> ÂØπÊñπÈ´òÈ¢ëËØç TOP 5
                        </div>
                        <div class="stats-rank-list" id="stats-rank-list">
                            ${generateRankHTML(partnerTop)}
                        </div>
                    </div>
                </div>
            `;

            statsContent._partnerHTML = generateRankHTML(partnerTop);
            statsContent._myHTML = generateRankHTML(myTop);
        }

        window.switchStatsView = function(who) {
            const statsContent = DOMElements.statsModal.content;
            const partnerBtn = document.getElementById('stats-toggle-partner');
            const meBtn = document.getElementById('stats-toggle-me');
            const title = document.getElementById('stats-rank-title');
            const list = document.getElementById('stats-rank-list');
            if (!partnerBtn || !meBtn || !list) return;

            if (who === 'partner') {
                partnerBtn.classList.add('active');
                meBtn.classList.remove('active');
                title.innerHTML = '<i class="fas fa-user-circle"></i> ÂØπÊñπÈ´òÈ¢ëËØç TOP 5';
                list.innerHTML = statsContent._partnerHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
            } else {
                meBtn.classList.add('active');
                partnerBtn.classList.remove('active');
                title.innerHTML = '<i class="fas fa-user"></i> ÊàëÊñπÈ´òÈ¢ëËØç TOP 5';
                list.innerHTML = statsContent._myHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">ÊöÇÊó†Êï∞ÊçÆ</div>';
            }
        };
        function renderSessionList() {
            const listContainer = DOMElements.sessionModal.list;
            if (sessionList.length === 0) {
                listContainer.innerHTML = '<div class="stats-empty" style="padding: 20px 0;"><p>ËøòÊ≤°Êúâ‰ºöËØù</p></div>';
                return;
            }
            listContainer.innerHTML = sessionList.map(session => `
            <div class="session-item ${session.id === SESSION_ID ? 'active': ''}" data-id="${session.id}">
            <div class="session-info">
            <div class="session-name">${session.name}</div>
            <div class="session-meta">ÂàõÂª∫‰∫é ${new Date(session.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="session-actions">
            <button class="session-action-btn rename" title="ÈáçÂëΩÂêç"><i class="fas fa-pen"></i></button>
            <button class="session-action-btn delete" title="Âà†Èô§"><i class="fas fa-trash"></i></button>
            </div>
            </div>
            `).join('');
        }


async function generateFortune() {
    const todayKey = new Date().toDateString();
    const storageKey = `${APP_PREFIX}daily_fortune`;
    let fortuneData = null;

    try {
        const savedData = await localforage.getItem(storageKey);
        if (savedData && savedData.date === todayKey) {
            fortuneData = savedData;
        }
    } catch (e) { console.warn("ËØªÂèñËøêÂäøÂ§±Ë¥•", e); }

    if (!fortuneData) {
        const cards = CONSTANTS.TAROT_CARDS;
        const randomIndex = Math.floor(Math.random() * cards.length);
        const isUpright = Math.random() > 0.5;

        fortuneData = {
            date: todayKey,
            cardIndex: randomIndex,
            isUpright: isUpright
        };
        await localforage.setItem(storageKey, fortuneData);
    }

    renderFortuneCardInteractive(fortuneData);
}

function renderFortuneCardInteractive(data) {
    const content = document.getElementById('fortune-content');
    
    if (!content) return showNotification('ÁªÑ‰ª∂Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢', 'error');

    const card = CONSTANTS.TAROT_CARDS[data.cardIndex];
    const isUpright = data.isUpright;

    content.innerHTML = `
        <div style="text-align:center; margin-bottom:10px; color:var(--text-secondary); font-size:12px;">
            <i class="fas fa-hand-pointer"></i> ÁÇπÂáªÂç°ÁâåÊè≠Êôì‰ªäÊó•ÊåáÂºï
        </div>
        
        <div class="tarot-container-3d" onclick="this.classList.toggle('flipped'); document.getElementById('fortune-text-area').classList.add('visible');">
            <div class="tarot-card-inner">
                <div class="tarot-face tarot-front">
                    <div class="tarot-pattern"><i class="fas fa-star-and-crescent"></i></div>
                    <div style="margin-top:10px; font-size:12px; letter-spacing:2px;">THE FATE</div>
                </div>

                <div class="tarot-face tarot-back">
                    <div class="tarot-visual ${isUpright ? '' : 'reversed'}" style="height:100px;">
                        <i class="fas ${card.icon} tarot-icon-vector" style="font-size:48px;"></i>
                    </div>
                    <div>
                        <div class="tarot-card-name" style="font-size:18px;">${card.name}</div>
                        <div class="tarot-position-badge ${isUpright ? 'upright' : 'reversed'}" style="margin:5px 0;">
                            ${isUpright ? "Ê≠£‰Ωç" : "ÈÄÜ‰Ωç"}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fortune-text-area" class="fortune-result-area">
            <div class="tarot-keyword" style="font-size:16px; margin-bottom:8px;">„Äå${card.keyword}„Äç</div>
            <div class="fortune-desc" style="font-size:14px; margin-bottom:10px;">${card.meaning}</div>
            <div class="fortune-tip" style="font-size:12px; border-top:1px dashed var(--border-color); padding-top:8px;">
                üí° ÊåáÂºïÔºö${isUpright ? "È°∫ÂäøËÄå‰∏∫Ôºå‰øùÊåÅÂΩì‰∏ãÁöÑËÉΩÈáè„ÄÇ" : "Êç¢‰∏™ËßíÂ∫¶ÊÄùËÄÉÔºå‰πüËÆ∏ÊòØËΩ¨Êú∫„ÄÇ"}
            </div>
        </div>
    `;

    showModal(document.getElementById('fortune-lenormand-modal'));
}

let lenormandSystem = 36;
let lenormandCount = 1;

const LENORMAND_CARDS_40 = [
    { num: 1, name: "È™ëÂ£´", icon: "üèá", keyword: "Ê∂àÊÅØ¬∑ÈÄüÂ∫¶", meaning: "Âø´ÈÄüÂà∞Êù•ÁöÑÊ∂àÊÅØÔºåË°åÂä®ËøÖÈÄüÔºå‰ΩøËÄÖÔºåÁü≠ÈÄîÊóÖË°å„ÄÇ" },
    { num: 2, name: "ÂõõÂè∂Ëçâ", icon: "üçÄ", keyword: "Âπ∏Ëøê¬∑Êú∫ÈÅá", meaning: "Â∞èÂπ∏ËøêÔºåÂÅ∂ÁÑ∂ÁöÑÂ•ΩËøêÔºåÁü≠ÊöÇÁöÑÂñúÊÇ¶Ôºå‰πêËßÇÈù¢ÂØπÁîüÊ¥ª„ÄÇ" },
    { num: 3, name: "Â∏ÜËàπ", icon: "‚õµ", keyword: "ÊóÖË°å¬∑ÊñπÂêë", meaning: "ÊóÖË°åÔºåÂÜíÈô©ÔºåËøΩÂØªÁõÆÊ†áÔºå‰∫∫ÁîüÁöÑËà™Âêë„ÄÇ" },
    { num: 4, name: "ÊàøÂ±ã", icon: "üè†", keyword: "ÂÆ∂Â∫≠¬∑ÂÆâÁ®≥", meaning: "ÂÆ∂ÔºåÁ®≥ÂÆöÔºåÂÆâÂÖ®ÊÑüÔºåÂÆ∂Â∫≠ÂÖ≥Á≥ªÔºåÊàø‰∫ß„ÄÇ" },
    { num: 5, name: "Â§ßÊ†ë", icon: "üå≥", keyword: "ÂÅ•Â∫∑¬∑Ê†πÂü∫", meaning: "ÂÅ•Â∫∑ÔºåÁîüÂëΩÂäõÔºåÊàêÈïøÔºåÊ†πÂü∫ÔºåÈïø‰πÖÁ®≥Âõ∫„ÄÇ" },
    { num: 6, name: "‰πå‰∫ë", icon: "‚òÅÔ∏è", keyword: "Âõ∞ÊÉë¬∑ÈöúÁ¢ç", meaning: "Âõ∞ÊÉëÔºå‰∏çÁ°ÆÂÆöÔºåÊöÇÊó∂ÁöÑÈò¥ÈúæÔºåÈúÄË¶ÅËÄêÂøÉÁ≠âÂæÖ„ÄÇ" },
    { num: 7, name: "Ëõá", icon: "üêç", keyword: "ËØ±ÊÉë¬∑ËøÇÂõû", meaning: "Á´û‰∫âËÄÖÔºåËØ±ÊÉëÔºåËøÇÂõûÁöÑÈÅìË∑ØÔºåÂ§çÊùÇÁöÑÂ•≥ÊÄß„ÄÇ" },
    { num: 8, name: "Ê£∫Êùê", icon: "‚ö∞Ô∏è", keyword: "ÁªìÊùü¬∑ËΩ¨Âèò", meaning: "ÁªìÊùüÔºåËΩ¨ÂèòÔºåÊüê‰∫ãÂëä‰∏ÄÊÆµËêΩÔºå‰ΩéËêΩÊúüÔºåÁñæÁóÖ„ÄÇ" },
    { num: 9, name: "Ëä±Êùü", icon: "üíê", keyword: "Á§ºÁâ©¬∑ÂñúÊÇ¶", meaning: "Á§ºÁâ©ÔºåÊÉäÂñúÔºåÂñúÊÇ¶ÔºåÁæéÂ•ΩÁöÑÂÖ≥Á≥ªÔºåÊÑüÊøÄ‰πãÊÉÖ„ÄÇ" },
    { num: 10, name: "Èï∞ÂàÄ", icon: "üåæ", keyword: "ÂÜ≥Êñ≠¬∑Êî∂Ââ≤", meaning: "Á™ÅÁÑ∂ÁöÑÂÜ≥ÂÆöÔºåÂç±Èô©ÔºåÊî∂Ââ≤ÔºåÁªìÊùüÔºåÊâãÊúØ„ÄÇ" },
    { num: 11, name: "Èû≠Â≠ê", icon: "‚ö°", keyword: "‰∫âÊâß¬∑ÊøÄÊÉÖ", meaning: "‰∫âËÆ∫ÔºåÂÜ≤Á™ÅÔºåÈáçÂ§çÔºåÊøÄÊÉÖÔºå‰ΩìËÇ≤ËøêÂä®„ÄÇ" },
    { num: 12, name: "È∏üÂÑø", icon: "üê¶", keyword: "ÂØπËØù¬∑ÁÑ¶Ëôë", meaning: "ÂØπËØùÔºåÊµÅË®ÄÔºåÊ∂àÊÅØÔºåÁÑ¶ËôëÔºå‰∏ÄÂØπÊÉÖ‰æ£„ÄÇ" },
    { num: 13, name: "Â≠©Á´•", icon: "üßí", keyword: "Êñ∞ÂºÄÂßã¬∑Á∫ØÁúü", meaning: "Êñ∞ÁöÑÂºÄÂßãÔºåÁ∫ØÁúüÔºåÂ≠©Â≠êÔºåÂ∞è‰∫ãÔºåÊñ∞È≤úÊÑü„ÄÇ" },
    { num: 14, name: "ÁãêÁã∏", icon: "ü¶ä", keyword: "Áã°Áåæ¬∑Â∑•‰Ωú", meaning: "Áã°ÁåæÔºåÁ≠ñÁï•ÔºåÂ∑•‰ΩúÔºåË∞®Èò≤Ê¨∫È™óÔºåËá™Êàë‰øùÊä§„ÄÇ" },
    { num: 15, name: "ÁÜä", icon: "üêª", keyword: "ÂäõÈáè¬∑ÊùÉÂ®Å", meaning: "Âº∫Â§ßÁöÑÂäõÈáèÔºåËÄÅÊùøÔºåË¥¢Âä°ÔºåÊØçÊÄßÔºå‰øùÊä§ËÄÖ„ÄÇ" },
    { num: 16, name: "ÊòüÊòü", icon: "‚≠ê", keyword: "Â∏åÊúõ¬∑ÊåáÂºï", meaning: "Â∏åÊúõÔºåÊ¢¶ÊÉ≥ÔºåÁÅµÊÑüÔºåÊåáÂºïÔºåÊ∏ÖÊô∞ÔºåÁæéÂ•ΩÊú™Êù•„ÄÇ" },
    { num: 17, name: "Èπ≥È∏ü", icon: "üïäÔ∏è", keyword: "ÂèòÂåñ¬∑ÁßªÂä®", meaning: "ÂèòÂåñÔºåÁßªÂä®ÔºåÈÄÇÂ∫îÔºåÊñ∞ÁöÑÁîüÊ¥ªÈò∂ÊÆµÔºåËøÅÂæô„ÄÇ" },
    { num: 18, name: "Áãó", icon: "üêï", keyword: "ÂèãË∞ä¬∑Âø†ËØö", meaning: "Âø†ËØöÁöÑÊúãÂèãÔºåÂèãË∞äÔºåÂèØÈù†ÔºåÊîØÊåÅÔºåÂÆ†Áâ©„ÄÇ" },
    { num: 19, name: "È´òÂ°î", icon: "üè∞", keyword: "Â≠§Áã¨¬∑Êú∫ÊûÑ", meaning: "Â≠§Áã¨ÔºåËæπÁïåÔºåÊú∫ÊûÑÔºåÂÆòÊñπÔºåË∑ùÁ¶ªÔºåËá™Êàë‰øùÊä§„ÄÇ" },
    { num: 20, name: "Ëä±Âõ≠", icon: "üå∫", keyword: "Á§æ‰∫§¬∑ÂÖ¨‰ºó", meaning: "Á§æ‰∫§Âú∫ÂêàÔºåÂÖ¨‰ºóÔºåËÅö‰ºöÔºåÂºÄÊîæÁöÑÁ©∫Èó¥„ÄÇ" },
    { num: 21, name: "Â±±‰∏ò", icon: "‚õ∞Ô∏è", keyword: "ÈöúÁ¢ç¬∑ÊåëÊàò", meaning: "ÈöúÁ¢çÔºåÊåëÊàòÔºåÂª∂ËøüÔºåÁ´û‰∫âÔºåÈúÄË¶ÅÊîÄË∂äÁöÑÂõ∞Èöæ„ÄÇ" },
    { num: 22, name: "ÂçÅÂ≠óË∑ØÂè£", icon: "üõ§Ô∏è", keyword: "ÈÄâÊã©¬∑ÊñπÂêë", meaning: "ÈÄâÊã©ÔºåÂ≤îË∑ØÔºåÂèØËÉΩÊÄßÔºåÂ§öÊù°ÈÅìË∑ØÔºåÂÜ≥Á≠ñÊó∂Âàª„ÄÇ" },
    { num: 23, name: "ËÄÅÈº†", icon: "üêÄ", keyword: "ÊçüËÄó¬∑ÂéãÂäõ", meaning: "ÊçüÂ§±ÔºåÂéãÂäõÔºåÁÑ¶ËôëÔºåÂÅ∑Ëµ∞ÔºåÈÄêÊ∏êÂáèÂ∞ëÔºåÊãÖÂøß„ÄÇ" },
    { num: 24, name: "ÂøÉ", icon: "‚ù§Ô∏è", keyword: "Áà±ÊÉÖ¬∑ÊÑüÊÉÖ", meaning: "Áà±ÔºåÊÑüÊÉÖÔºåÂÖ≥ÊÄÄÔºåÁúüÂøÉÔºåÊÉÖÊÑüÁöÑÊ†∏ÂøÉ„ÄÇ" },
    { num: 25, name: "ÊåáÁéØ", icon: "üíç", keyword: "ÊâøËØ∫¬∑Â•ëÁ∫¶", meaning: "ÊâøËØ∫ÔºåÂ•ëÁ∫¶ÔºåÂ©öÂßªÔºåÂêà‰ΩúÔºåÂæ™ÁéØÂæÄÂ§ç„ÄÇ" },
    { num: 26, name: "‰π¶", icon: "üìö", keyword: "ÁßòÂØÜ¬∑Áü•ËØÜ", meaning: "ÁßòÂØÜÔºåÁü•ËØÜÔºåÂ≠¶‰π†ÔºåÈöêËóèÁöÑ‰ø°ÊÅØÔºåÈúÄË¶ÅÊ∑±ÂÖ•‰∫ÜËß£„ÄÇ" },
    { num: 27, name: "‰ø°‰ª∂", icon: "‚úâÔ∏è", keyword: "Ê≤üÈÄö¬∑Êñá‰ª∂", meaning: "ÈÄöËÆØÔºåÊñá‰ª∂Ôºå‰ø°ÊÅØÔºå‰π¶Èù¢ÂêàÂêåÔºåÈáçË¶ÅÁöÑÊ∂àÊÅØ„ÄÇ" },
    { num: 28, name: "Áî∑Â£´", icon: "üë®", keyword: "Áî∑ÊÄß¬∑ÂΩì‰∫ã‰∫∫", meaning: "‰∏ªË¶ÅÁî∑ÊÄß‰∫∫Áâ©ÔºåÁî∑ÊÄßÊèêÈóÆËÄÖÊàñÈáçË¶ÅÁî∑ÊÄß„ÄÇ" },
    { num: 29, name: "Â•≥Â£´", icon: "üë©", keyword: "Â•≥ÊÄß¬∑ÂΩì‰∫ã‰∫∫", meaning: "‰∏ªË¶ÅÂ•≥ÊÄß‰∫∫Áâ©ÔºåÂ•≥ÊÄßÊèêÈóÆËÄÖÊàñÈáçË¶ÅÂ•≥ÊÄß„ÄÇ" },
    { num: 30, name: "ÁôæÂêà", icon: "üå∏", keyword: "Á∫ØÊ¥Å¬∑Âπ≥Èùô", meaning: "Á∫ØÊ¥ÅÔºåÂπ≥ÈùôÔºåÂíåË∞êÔºåÊàêÁÜüÁöÑÊÑüÊÉÖÔºåÈ´òÂ∞öÁöÑÂìÅÊ†º„ÄÇ" },
    { num: 31, name: "Â§™Èò≥", icon: "‚òÄÔ∏è", keyword: "ÊàêÂäü¬∑Ê¥ªÂäõ", meaning: "ÊàêÂäüÔºåÊ¥ªÂäõÔºåÂø´‰πêÔºåÊ∏©ÊöñÔºåÂÖâÊòéÔºåÁßØÊûÅËÉΩÈáè„ÄÇ" },
    { num: 32, name: "Êúà‰∫Æ", icon: "üåô", keyword: "Ëç£Ë™â¬∑Áõ¥Ëßâ", meaning: "Ëç£Ë™âÔºåÂêçÂ£∞ÔºåÁõ¥ËßâÔºåÊÉÖÊÑüÊ≥¢Âä®ÔºåÂàõÈÄ†ÂäõÔºåÊ¢¶Â¢É„ÄÇ" },
    { num: 33, name: "Èí•Âåô", icon: "üîë", keyword: "Á≠îÊ°à¬∑Ëß£ÈîÅ", meaning: "Á≠îÊ°àÔºåËß£ÂÜ≥ÊñπÊ°àÔºåÈáçË¶ÅÂèëÁé∞ÔºåÂºÄÂêØÊñ∞ÁöÑÂèØËÉΩ„ÄÇ" },
    { num: 34, name: "È±º", icon: "üêü", keyword: "Ë¥¢ÂØå¬∑ÊµÅÂä®", meaning: "Ë¥¢ÂØåÔºåÁîüÊÑèÔºåÊµÅÂä®Ôºå‰∏∞ÁõõÔºåÂïÜ‰∏öÊ¥ªÂä®ÔºåËµÑÊ∫ê„ÄÇ" },
    { num: 35, name: "Èîö", icon: "‚öì", keyword: "Á®≥ÂÆö¬∑ÂùöÊåÅ", meaning: "Á®≥ÂÆöÔºåÂùöÊåÅÔºåÁõÆÊ†áÔºåÈïøÊúüÔºåË∏èÂÆûÔºåÂ∑•‰Ωú„ÄÇ" },
    { num: 36, name: "ÂçÅÂ≠óÊû∂", icon: "‚úùÔ∏è", keyword: "ÂëΩËøê¬∑ÊãÖÂΩì", meaning: "ÂëΩËøêÔºåË¥£‰ªªÔºåÁóõËã¶Ôºå‰ø°‰ª∞ÔºåÊé•ÂèóÔºåÁ≤æÁ•û‰ΩøÂëΩ„ÄÇ" },
    { num: 37, name: "ÁÅµ‰Ωì", icon: "üí≠", keyword: "È´òÊàë¬∑ÊÑüÂèó", meaning: "Áõ¥ËßâÔºåÊÑüÂèóÔºåËßâÂØüÔºåÂõ†ÊûúËßÑÂæãÔºåÁÅµÈ≠Ç‰º¥‰æ£Ôºå„ÄÇ" },
    { num: 38, name: "È¶ôÁÇâ", icon: "‚öñÔ∏è", keyword: "Ê∏ÖÈô§¬∑ÂΩíÈõ∂", meaning: "Ê∏ÖÈô§ÔºåÂáÄÂåñÔºåÊ∂àÊï£ÔºåÂº•Êº´ÔºåÊ∏ÖÂáÄ‰πãÂú∞ÔºåÊ∞õÂõ¥ÊÑü„ÄÇ" },
    { num: 39, name: "Â∫ä", icon: "üõè", keyword: "ËàíÈÄÇ¬∑‰ºëÊÅØ", meaning: "Áù°ËßâÔºåÂõûÈÅøÔºåË∫∫Âπ≥ÔºåËàíÈÄÇÔºåÂçßÂÆ§ÔºåÊÄßÂÖ≥Á≥ª„ÄÇ" },
    { num: 40, name: "Â∏ÇÂú∫", icon: "üè™", keyword: "‰∫§Êòì¬∑Â∑•‰Ωú", meaning: "Â∑•‰ΩúÔºå‰∫§ÊòìÔºåÁª¥Êä§ÔºåËøêËê•ÔºåÂäøÂùáÂäõÊïåÔºåÂá∫ÂéªÊ∏∏Áé©„ÄÇ" }
];

function getLenormandCards() {
    return LENORMAND_CARDS_40.slice(0, lenormandSystem);
}

function setLenormandSystem(n) {
    lenormandSystem = n;
}

function setLenormandCount(n) {
    lenormandCount = n;
    document.querySelectorAll('.lenormand-num-btn').forEach(btn => {
        const numEl = btn.querySelector('.leno-btn-num');
        btn.classList.toggle('active', numEl && parseInt(numEl.textContent) === n);
    });
    updateLenoNumDesc(n);
}

function updateLenoNumDesc(n) {
    const desc = document.getElementById('leno-num-desc');
    if (!desc) return;
    if (n === 1) desc.textContent = 'ÂçïÂº†Áâå ¬∑ Áõ¥ËææÁ≠îÊ°à';
    else if (n === 3) desc.textContent = '‰∏âÂº†Áâå ¬∑ ËøáÂéª ¬∑ Áé∞Âú® ¬∑ Êú™Êù•';
}

function switchFLTab(tab) {
    document.querySelectorAll('.fl-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.fl-panel').forEach(panel => panel.classList.remove('fl-panel-active'));
    const activeTab = document.getElementById('fl-tab-' + tab);
    const activePanel = document.getElementById('fl-panel-' + tab);
    if (activeTab) activeTab.classList.add('active');
    if (activePanel) activePanel.classList.add('fl-panel-active');
}

function openLenormandModal() {
    resetLenormand();
    switchFLTab('lenormand');
    showModal(document.getElementById('fortune-lenormand-modal'));
}

function resetLenormand() {
    const setup = document.getElementById('lenormand-setup');
    const result = document.getElementById('lenormand-result');
    const resetBtn = document.getElementById('lenormand-reset-btn');
    const qInput = document.getElementById('lenormand-question');
    if (setup) setup.style.display = '';
    if (result) result.style.display = 'none';
    if (resetBtn) resetBtn.style.display = 'none';
    if (qInput) qInput.value = '';
    lenormandSystem = 40;
    lenormandCount = 1;
    document.querySelectorAll('.lenormand-num-btn').forEach(btn => {
        const num = btn.querySelector('.leno-btn-num');
        btn.classList.toggle('active', num && num.textContent.trim() === '1');
    });
    updateLenoNumDesc(1);
}

function startLenormandDraw() {
    const cards = getLenormandCards();
    const shuffled = [...cards].sort(() => Math.random() - 0.5);
    const drawn = shuffled.slice(0, lenormandCount);
    const question = document.getElementById('lenormand-question').value.trim();

    let cardsHTML = drawn.map((card, i) => `
        <div class="lenormand-card-item" style="animation-delay:${i * 0.1}s;">
            <span class="lenormand-card-icon">${card.icon}</span>
            <div class="lenormand-card-name">${card.name}</div>
            <div class="lenormand-card-num">No.${card.num}</div>
            <div class="lenormand-card-keyword">„Äå${card.keyword}„Äç</div>
            <div class="lenormand-card-meaning">${card.meaning}</div>
        </div>
    `).join('');

    let synthesisHTML = '';
    if (drawn.length > 1) {
        const keywords = drawn.map(c => c.keyword.split('¬∑')[0]).join('„ÄÅ');
        const energies = drawn.map(c => c.name).join(' + ');
        const m0 = drawn[0].meaning.split('Ôºå')[0];
        const m2 = drawn.length >= 3 ? drawn[2].meaning.split('Ôºå')[0] : '';
        const n0 = drawn[0].name, n1 = drawn[1].name, n2 = drawn.length >= 3 ? drawn[2].name : '';
        
        const templates3 = [
            `„Äå${n0}„ÄçÂ∏¶Êù•ÁöÑËøáÂéªÔºåÂ¶ÇÂêå${m0}ÁöÑÂ∫ïËâ≤Ôºõ„Äå${n1}„ÄçÊèèÁªòÂΩì‰∏ãÊ≠£Âú®ÂèëÁîüÁöÑ‰∏ÄÂàáÔºõ„Äå${n2}„ÄçÂàôÊåáÂêë${m2}ÁöÑÊú™Êù•ËΩÆÂªì„ÄÇ‰∏âÂº†ÁâåÁöÑËÉΩÈáèÊµÅÂä®ÔºåÂÖ±ÂêåÁºñÁªáÂá∫‰∏ÄÊÆµÂÖ≥‰∫é${keywords}ÁöÑÊïÖ‰∫ã„ÄÇ`,
            `ÊòüÁõò‰πã‰∏äÔºå„Äå${n0}„Äç„ÄÅ„Äå${n1}„Äç„ÄÅ„Äå${n2}„Äç‰∏âÂº†Áâå‰æùÊ¨°Â±ïÂºÄ‚Äî‚ÄîËøáÂéªÁöÑÂç∞ËÆ∞„ÄÅÂΩì‰∏ãÁöÑÈÄâÊã©„ÄÅÊú™Êù•ÁöÑÂèØËÉΩÔºåÁöÜÂú®Ëøô‰∏âÊûöÁ¨¶Âè∑ÈáåÊÇÑÊÇÑ‰ΩéËØ≠„ÄÇ${keywords}ÔºåÊòØÊ≠§ÂàªÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑÊ†∏ÂøÉËÉΩÈáè„ÄÇ`,
            `‰ªé„Äå${n0}„ÄçÂà∞„Äå${n2}„ÄçÔºåÊó∂Èó¥Âú®ÁâåÈòµ‰∏≠ÊµÅÂä®„ÄÇ${m0}ÁöÑËøáÂéªÈÄ†Â∞±‰∫Ü‰Ω†Áé∞Âú®ÁöÑÊ®°Ê†∑ÔºåËÄå${m2}ÁöÑÊñπÂêëÔºåÊ≠£Á≠âÂæÖ‰Ω†ËøàÂá∫ÈÇ£‰∏ÄÊ≠•„ÄÇÊÑøÊ≠§ÂàªÁöÑ„Äå${n1}„ÄçÔºåÊàê‰∏∫ËøûÊé•‰∏§Á´ØÁöÑÊ°•Ê¢Å„ÄÇ`,
            `‰∏âÂº†ÁâåÂÖ±ÂêåÂëàÁé∞‰∫Ü‰∏ÄÊÆµÊóÖÁ®ãÔºö‰ª•„Äå${n0}„Äç‰∏∫Ëµ∑ÁÇπÔºåÁªèÂéÜ„Äå${n1}„ÄçÁöÑÂΩì‰∏ãÊó∂ÂàªÔºåÊäµËææ„Äå${n2}„ÄçÊâÄÊåáÂºïÁöÑËøúÊñπ„ÄÇ${keywords}ÁöÑ‰∏ªÈ¢òË¥ØÁ©øÂÖ∂‰∏≠ÔºåÊåáÂºïÁùÄÂâçË°åÁöÑÊñπÂêë„ÄÇ`,
            `ÂÆáÂÆôÂÄü${energies}ÁöÑËÉΩÈáèÔºåÂêë‰Ω†‰º†ÈÄí‰ø°ÊÅØÔºöÊõæÁªè${m0}ÔºåÂ¶Ç‰ªäÊ≠£ÁªèÂéÜËΩ¨ÂèòÔºåËÄåÂâçÊñπ${m2}ÁöÑÂèØËÉΩÊÄßÂ∑≤ÊÇÑÁÑ∂ÂºÄÂêØ„ÄÇËØ∑Áõ∏‰ø°ËøôÊÆµÊóÖÁ®ãÊúâÂÖ∂Ê∑±ÊÑè„ÄÇ`
        ];
        const templates2 = [
            `„Äå${n0}„Äç‰∏é„Äå${n1}„ÄçÁöÑËÉΩÈáèÁõ∏ÈÅáÔºå${keywords}ÁöÑ‰∏ªÈ¢òÂú®Ê≠§‰∫§Ê±á„ÄÇ${m0}ÁöÑÂäõÈáèÈÅáËßÅ‰∫ÜÊñ∞ÁöÑÂèØËÉΩÔºåÂÖ±ÂêåÊèèÁªòÂá∫ÂΩì‰∏ãÂ±ÄÂäøÁöÑÈù¢Ë≤å„ÄÇ`,
            `‰∏§Âº†ÁâåÊê∫ÊâãËÄåÊù•Ôºö„Äå${n0}„ÄçÂ∏¶ÁùÄ${m0}ÁöÑÂ∫ïËâ≤Ôºå„Äå${n1}„ÄçÂ∏¶Êù•Êñ∞ÁöÑËßÜËßí„ÄÇÂÆÉ‰ª¨ÂÖ±ÂêåÊåáÂêë‰∏Ä‰∏™ÂÖ≥‰∫é${keywords}ÁöÑÁ≠îÊ°àÔºåÁ≠âÂæÖ‰Ω†ÁªÜÁªÜÂìÅÂë≥„ÄÇ`,
            `${energies}‚Äî‚Äî‰∏§ÁßçËÉΩÈáèÂú®‰Ω†ÁöÑÈóÆÈ¢ò‰∏äÁïô‰∏ãÂç∞ËÆ∞„ÄÇ${m0}‰∏éÂØπÊñπÁöÑËÉΩÈáèÁõ∏‰∫í‰ΩúÁî®ÔºåÂΩìÂâçÂ±ÄÈù¢Âõ†Ê≠§ÂÖÖÊª°‰∫Ü${keywords}ÁöÑË¥®ÊÑü„ÄÇÈùô‰∏ãÂøÉÊù•ÔºåÁ≠îÊ°àÂ∑≤Âú®ÂÖ∂‰∏≠„ÄÇ`,
            `Áâå‰∏éÁâå‰πãÈó¥ÊÄªÊúâÂëºÂ∫î„ÄÇ„Äå${n0}„ÄçÂíå„Äå${n1}„ÄçÁöÑÁªÑÂêàÔºåÂÉèÊòØÂÆáÂÆôÁâπÊÑè‰∏∫‰Ω†ÊéíÂàóÁöÑÂØÜÁ†ÅÔºå${keywords}‰æøÊòØËß£ËØªËøôÊÆµÁºòÂàÜÁöÑÈí•Âåô„ÄÇ`
        ];
        
        const templates = drawn.length === 3 ? templates3 : templates2;
        const chosenText = templates[Math.floor(Math.random() * templates.length)];
        
        synthesisHTML = `
        <div class="lenormand-synthesis">
            <div class="lenormand-synthesis-title">‚ú¶ ÁªºÂêàËß£ËØª</div>
            ${chosenText}
        </div>`;
    }

    const questionDisplay = question ? `<div class="lenormand-question-show">„Äå${question}„Äç</div>` : '';

    document.getElementById('lenormand-result').innerHTML = `
        ${questionDisplay}
        <div style="text-align:center; font-size:12px; color:var(--text-secondary); margin-bottom:12px;">
            <i class="fas fa-moon"></i> Èõ∑ËØ∫ÊõºËΩªÂ£∞ËØ¥ ¬∑ Áà±ËÉΩÂÖãÊúçËøúË∑ùÁ¶ª
        </div>
        <div class="lenormand-cards-row">${cardsHTML}</div>
        ${synthesisHTML}
    `;

    document.getElementById('lenormand-setup').style.display = 'none';
    document.getElementById('lenormand-result').style.display = '';
    document.getElementById('lenormand-reset-btn').style.display = '';
}

function toggleBatchFavoriteMode() {
            isBatchFavoriteMode = !isBatchFavoriteMode;
            selectedMessages = [];

            if (isBatchFavoriteMode) {
                document.body.classList.add('batch-favorite-mode');
                showBatchFavoriteActions();
                showNotification('ÊâπÈáèÊî∂ËóèÊ®°ÂºèÂ∑≤ÂºÄÂêØÔºåÁÇπÂáªÊ∂àÊÅØËøõË°åÈÄâÊã©', 'info');
            } else {
                document.body.classList.remove('batch-favorite-mode');
                hideBatchFavoriteActions();
                showNotification('ÊâπÈáèÊî∂ËóèÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠', 'info');
            }

            renderMessages(true);
        }

        function hideBatchFavoriteActions() {
            const actions = document.querySelector('.batch-favorite-actions');
            if (actions) {

                actions.style.animation = 'floatUpAction 0.3s reverse forwards';
                setTimeout(() => {
                    actions.remove();
                }, 300);
            }
        }


        function showBatchFavoriteActions() {

            if (document.querySelector('.batch-favorite-actions')) return;

            const actions = document.createElement('div');
            actions.className = 'batch-favorite-actions';

            actions.innerHTML = `
        <button class="batch-action-btn-pill batch-btn-cancel" id="cancel-batch-favorite">
        <i class="fas fa-times"></i> ÂèñÊ∂à
        </button>
        <button class="batch-action-btn-pill batch-btn-confirm" id="confirm-batch-favorite">
        <i class="fas fa-check"></i> Á°ÆËÆ§Êî∂Ëóè (0)
        </button>
        `;
            document.body.appendChild(actions);

            document.getElementById('confirm-batch-favorite').addEventListener('click', confirmBatchFavorite);
            document.getElementById('cancel-batch-favorite').addEventListener('click', toggleBatchFavoriteMode);
        }


        function confirmBatchFavorite() {
            if (selectedMessages.length === 0) {
                showNotification('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊî∂ËóèÁöÑÊ∂àÊÅØ', 'warning');
                return;
            }


            const count = selectedMessages.length;


            selectedMessages.forEach(msgId => {
                const message = messages.find(m => m.id === msgId);
                if (message) {
                    message.favorited = true;
                }
            });


            throttledSaveData();


            toggleBatchFavoriteMode();


            showNotification(`Â∑≤ÊàêÂäüÊî∂Ëóè ${count} Êù°Ê∂àÊÅØ`, 'success');
        }



        function renderAnniversaries() {
    const list = DOMElements.anniversaryModal.list;
    if (anniversaries.length === 0) {
        list.innerHTML = '<div class="no-favorites" style="padding:20px 0;"><i class="fas fa-heart" style="font-size:24px;margin-bottom:10px;"></i><p>ËøòÊ≤°ÊúâËÆ∞ÂΩïÁ∫™ÂøµÊó•</p></div>';
        return;
    }

    list.innerHTML = anniversaries.map(anniversary => {
        const startDate = new Date(anniversary.date);
        const now = new Date();
        let diffDays;
        
        if (anniversary.type === 'countdown') {
            diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) diffDays = 0; 
        } else {
            diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        }

        const typeClass = anniversary.type === 'countdown' ? 'type-future' : 'type-past';
        const tagText = anniversary.type === 'countdown' ? 'ÂÄíÊï∞' : 'Á∫™Âøµ';

        return `
        <div class="anniversary-card ${typeClass}" data-id="${anniversary.id}">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="ann-info">
                    <div class="ann-name">
                        ${anniversary.name} 
                        <span class="ann-tag">${tagText}</span>
                    </div>
                    <div class="ann-date">${startDate.toLocaleDateString()}</div>
                </div>
                <div class="ann-days">
                    <span class="ann-number">${diffDays}</span>
                    <span class="ann-label">Days</span>
                </div>
            </div>
            <div class="ann-delete-btn" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:opacity 0.2s;" 
                 onclick="deleteAnniversary(${anniversary.id}, event)">
                <i class="fas fa-times" style="font-size:12px;"></i>
            </div>
        </div>
        `;
    }).join('');
}

        function addAnniversary() {
    const nameInput = document.getElementById('ann-input-name');
    const dateInput = document.getElementById('ann-input-date');
    
    const name = (nameInput ? nameInput.value : (DOMElements.anniversaryModal.nameInput ? DOMElements.anniversaryModal.nameInput.value : '')).trim();
    const date = dateInput ? dateInput.value : (DOMElements.anniversaryModal.dateInput ? DOMElements.anniversaryModal.dateInput.value : '');

    if (!name || !date) {
        showNotification('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÊó•Êúü', 'error');
        return;
    }

    const type = (typeof currentAnnType !== 'undefined' ? currentAnnType : null) 
              || (typeof currentAnniversaryType !== 'undefined' ? currentAnniversaryType : 'anniversary');

    const newAnniversary = {
        id: Date.now(),
        name: name,
        date: date,
        type: type
    };

    anniversaries.push(newAnniversary);
    throttledSaveData();
    renderAnniversariesList();
    
    if (nameInput) nameInput.value = '';
    if (dateInput) dateInput.value = '';
    if (DOMElements.anniversaryModal.nameInput) DOMElements.anniversaryModal.nameInput.value = '';
    if (DOMElements.anniversaryModal.dateInput) DOMElements.anniversaryModal.dateInput.value = '';

    const annFormWrapper = document.getElementById('ann-form-wrapper');
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    if (annFormWrapper) annFormWrapper.classList.remove('active');
    if (annToggleBtn) annToggleBtn.classList.remove('active');

    showNotification('Á∫™ÂøµÊó•Â∑≤Ê∑ªÂä†', 'success');
}

        function showAnniversaryAnimation(anniversary) {
            const startDate = new Date(anniversary.date);
            const now = new Date();
            let diffDays;
            let title, message;

            if (anniversary.type === 'countdown') {

                diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                title = "ÂÄíÊï∞Êó•";
                message = `Ë∑ùÁ¶ª ${anniversary.name} ËøòÊúâ`;
            } else {

                diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                title = "Á∫™ÂøµÊó•Âø´‰πêÔºÅ";
                message = `Êàë‰ª¨Â∑≤ÁªèÁõ∏‰º¥‰∫Ü`;
            }

            DOMElements.anniversaryAnimation.title.textContent = title;
            DOMElements.anniversaryAnimation.days.textContent = diffDays;
            DOMElements.anniversaryAnimation.message.textContent = message;

            DOMElements.anniversaryAnimation.modal.classList.add('active');
        }

        function updateAnniversaryDisplay(dateString) {
            if (!dateString) return;

            const start = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            DOMElements.anniversaryModal.daysElement.textContent = diffDays;
            DOMElements.anniversaryModal.dateShowElement.textContent = `Ëµ∑ÂßãÊó•Ôºö${start.toLocaleDateString()}`;
            DOMElements.anniversaryModal.displayArea.style.display = 'block';
        }


const MOOD_OPTIONS = [
    { key: 'happy', kaomoji: 'üòÜ', label: 'ÂºÄÂøÉ', color: '#FFD93D' },
    { key: 'excited', kaomoji: 'ü•∞', label: 'ÂÖ¥Â•ã', color: '#FF6B6B' },
    { key: 'peace', kaomoji: '‚ò∫Ô∏è', label: 'Âπ≥Ê∑°', color: '#6BCB77' },
    { key: 'sad', kaomoji: 'üòï', label: 'ÈöæËøá', color: '#4D96FF' },
    { key: 'tired', kaomoji: 'üòû', label: 'Áñ≤ÊÉ´', color: '#8D9EFF' },
    { key: 'angry', kaomoji: 'üò†', label: 'ÁîüÊ∞î', color: '#FF4757' },
    { key: 'love', kaomoji: 'ü•∞', label: 'ÊÉ≥‰Ω†', color: '#FF9A8B' },
    { key: 'busy', kaomoji: 'üòµ‚Äçüí´', label: 'ÂøôÁ¢å', color: '#A8D8EA' },
    { key: 'sleepy', kaomoji: 'üò¥', label: 'Âõ∞Âõ∞', color: '#E0C3FC' },
{ key: 'lonely', kaomoji: 'ü•π', label: 'Â≠§Âçï', color: '#B8A9C9' }, 
{ key: 'cool', kaomoji: 'üòé', label: 'ÊΩáÊ¥í', color: '#2C3E50' },
    { key: 'cute', kaomoji: 'ü•∫', label: 'ÊííÂ®á', color: '#FFB6C1' }
];

let moodData = {}; 
let currentCalendarDate = new Date();
window.selectedDateStr = null;
let selectedDateStr = null;
let currentMoodPage = 1; 
let currentMoodEditTarget = 'me'; 
let customMoodOptions = []; 
let customMoodSelectedColor = '#FFD93D';
const CUSTOM_MOOD_COLORS = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#8D9EFF','#FF9A8B','#A8D8EA','#E0C3FC','#B8A9C9','#2C3E50'];

async function initMoodData() {
    const savedMoods = await localforage.getItem(getStorageKey('moodCalendar'));
    if (savedMoods) { moodData = savedMoods; }
    const savedCustomMoods = await localforage.getItem(getStorageKey('customMoodOptions'));
    if (savedCustomMoods) { customMoodOptions = savedCustomMoods; }
    window.moodData = moodData;
    checkPartnerDailyMood();
}
function checkPartnerDailyMood() {
    const today = new Date();
    const dateStr = formatDateStr(today);
    
    if (!moodData[dateStr]) {
        moodData[dateStr] = {};
    }

    if (!moodData[dateStr].partner && moodData[dateStr].partnerChecked === undefined) {
        moodData[dateStr].partnerChecked = true;
        // 20% chance of no mood record today
        if (Math.random() < 0.20) {
            // Skip recording - partner didn't record mood today
            saveMoodData();
            return;
        }
        const randomMood = MOOD_OPTIONS[Math.floor(Math.random() * MOOD_OPTIONS.length)];
        moodData[dateStr].partner = randomMood.key;
        try {
            const cReplies = (typeof customReplies !== 'undefined') ? customReplies : (window._customReplies || []);
            const dDisabled = (typeof disabledDefaultReplies !== 'undefined') ? disabledDefaultReplies : (window._disabledDefaultReplies || []);
            const cConstants = (typeof CONSTANTS !== 'undefined') ? CONSTANTS : (window._CONSTANTS || { REPLY_MESSAGES: [] });
            const sourcePool = [...cReplies, ...cConstants.REPLY_MESSAGES.filter(t => !dDisabled.includes(t))];
            if (sourcePool.length > 0) {
                const count = Math.floor(Math.random() * 3) + 1;
                const chosen = [];
                const shuffled = [...sourcePool].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(count, shuffled.length); i++) {
                    chosen.push(shuffled[i]);
                }
                moodData[dateStr].partnerNote = chosen.join('„ÄÄ');
            }
        } catch(e) {  }
        saveMoodData();
    }
}
function saveMoodData() {
    localforage.setItem(getStorageKey('moodCalendar'), moodData);
    window.moodData = moodData;
    // Only render if mood modal is visible
    var moodModal = document.getElementById('mood-modal');
    if (moodModal && !moodModal.classList.contains('hidden') && moodModal.style.display !== 'none') {
        renderMoodCalendar();
    }
}
function saveCustomMoodOptions() {
    localforage.setItem(getStorageKey('customMoodOptions'), customMoodOptions);
}
function getAllMoodOptions() {
    return [...MOOD_OPTIONS, ...customMoodOptions];
}
function formatDateStr(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}


let currentMoodSelection = null; 
function renderMoodCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthLabel = document.getElementById('calendar-month-label');
    
    if (!grid || !monthLabel) return;

    grid.innerHTML = '';
    
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    monthLabel.textContent = `${year}Âπ¥ ${month + 1}Êúà`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); 

    let stats = {
        me: { total: 0, counts: {} },
        partner: { total: 0, counts: {} }
    };

    for (let i = 0; i < startDayOfWeek; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
    }

    const todayStr = formatDateStr(new Date());

    for (let d = 1; d <= daysInMonth; d++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateStr(dateObj);
        
        if (dateStr === todayStr) {
            dayDiv.classList.add('today');
            dayDiv.style.borderColor = 'var(--accent-color)';
        }

        const numSpan = document.createElement('span');
        numSpan.textContent = d;
        dayDiv.appendChild(numSpan);

        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'mood-dots-container';

        const dayData = moodData[dateStr];
        
        if (dayData) {
            if (dayData.user) {
                const moodObj = getAllMoodOptions().find(m => m.key === dayData.user);
                if (moodObj) {
                    stats.me.counts[moodObj.key] = (stats.me.counts[moodObj.key] || 0) + 1;
                    stats.me.total++;
                    const dot = createMoodDot(moodObj, dayData.note, false);
                    dotsContainer.appendChild(dot);
                }
            }
            if (dayData.partner) {
                const moodObj = getAllMoodOptions().find(m => m.key === dayData.partner);
                if (moodObj) {
                    stats.partner.counts[moodObj.key] = (stats.partner.counts[moodObj.key] || 0) + 1;
                    stats.partner.total++;
                    const dot = createMoodDot(moodObj, dayData.partnerNote, true); 
                    dotsContainer.appendChild(dot);
                }
            }
        }

        dayDiv.appendChild(dotsContainer);

        dayDiv.addEventListener('click', () => {
            const dayEntry = moodData[dateStr];
            if (dayEntry && (dayEntry.user || dayEntry.partner)) {
                showDayDetails(dateStr, dayEntry);
            } else {
                openMoodSelector(dateStr, 'me');
            }
        });

        grid.appendChild(dayDiv);
    }

    updateDualMoodStats(stats);
}

function createMoodDot(moodObj, note, isPartner) {
    const dot = document.createElement('div');
    dot.className = `mood-detail-dot ${isPartner ? 'partner-mood' : ''}`;
    dot.style.backgroundColor = moodObj.color;
    
    if (isPartner) {
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span">Ta</span>
        `;
    } else {
        const displayText = (note && note.trim()) ? note : moodObj.label;
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span" style="margin-left:2px;">${displayText}</span>
        `;
    }
    return dot;
}
function updateDualMoodStats(stats) {
    const container = document.getElementById('mood-stats-container');
    if (!container) return;

    const mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'Êàë';
    const pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'Ê¢¶Ëßí';

    const myTotal = stats.me.total;
    const partnerTotal = stats.partner.total;
    
    const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
    const myPercent = daysInMonth > 0 ? (myTotal / daysInMonth) * 100 : 0;
    const partnerPercent = daysInMonth > 0 ? (partnerTotal / daysInMonth) * 100 : 0;

    let myDominant = { label: 'Êó†', kaomoji: 'üò∂', color: '#ccc' };
    let myMaxCount = 0;
    Object.keys(stats.me.counts).forEach(key => {
        if (stats.me.counts[key] > myMaxCount) {
            myMaxCount = stats.me.counts[key];
            const m = getAllMoodOptions().find(o => o.key === key);
            if (m) myDominant = m;
        }
    });

    let partnerDominant = { label: 'Êó†', kaomoji: 'üò∂', color: '#ccc' };
    let partnerMaxCount = 0;
    Object.keys(stats.partner.counts).forEach(key => {
        if (stats.partner.counts[key] > partnerMaxCount) {
            partnerMaxCount = stats.partner.counts[key];
            const m = getAllMoodOptions().find(o => o.key === key);
            if (m) partnerDominant = m;
        }
    });
    
    const createMoodBarHTML = (moodCounts, totalCount) => {
        if (totalCount <= 0) {
            return `<div class="mood-bar-container" style="justify-content: center; align-items: center; font-size: 10px; color: var(--text-secondary); background: var(--message-received-bg);">Êó†Êï∞ÊçÆ</div>`;
        }

        const segments = Object.keys(moodCounts)
            .map(key => {
                const count = moodCounts[key];
                const moodObj = getAllMoodOptions().find(m => m.key === key);
                if (moodObj) {
                    const percentage = (count / totalCount) * 100;
                    return `<div class="mood-bar-segment" style="width: ${percentage}%; background-color: ${moodObj.color};" title="${moodObj.label}: ${count}Â§©"></div>`;
                }
                return ''; 
            })
            .join(''); 
        return `<div class="mood-bar-container">${segments}</div>`;
    };

    const myBarHTML = createMoodBarHTML(stats.me.counts, myTotal);
    const partnerBarHTML = createMoodBarHTML(stats.partner.counts, partnerTotal);

    var todayStr = formatDateStr(new Date());
    var todayEntry = moodData[todayStr] || {};
    var myWeatherVal = todayEntry.myWeather || '';
    var partnerWeatherVal = todayEntry.partnerWeather || '';

    container.innerHTML = `
        <div class="mood-circles-wrapper" style="margin-bottom:20px;">
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${myPercent}%">
                    <span class="mood-circle-text" style="color:var(--accent-color)">${myTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker me" style="width:8px;height:8px;"></span> ${mName}
                </div>
                <div class="stats-weather-tag" onclick="editStatsWeather(this,'me')" title="ÁÇπÂáªÁºñËæëÂ§©Ê∞î">
                    ${myWeatherVal ? `<span>${myWeatherVal}</span>` : `<span style="opacity:0.4;">+ Â§©Ê∞î</span>`}
                </div>
            </div>
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${partnerPercent}%; --accent-color: #ff6b6b;">
                    <span class="mood-circle-text" style="color:#ff6b6b">${partnerTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker partner" style="width:8px;height:8px;"></span> ${pName}
                </div>
                <div class="stats-weather-tag" onclick="editStatsWeather(this,'partner')" title="ÁÇπÂáªÁºñËæëÂ§©Ê∞î">
                    ${partnerWeatherVal ? `<span>${partnerWeatherVal}</span>` : `<span style="opacity:0.4;">+ Â§©Ê∞î</span>`}
                </div>
            </div>
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>ÊàëÁöÑÂøÉÊÉÖ</span>
                <div class="dominant-mood-tag">
                    <span style="color:${myDominant.color}; font-weight:bold;">${myDominant.kaomoji} ${myDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>ËÆ∞ÂΩïÂ§©Êï∞: ${myTotal}</span>
            </div>
            ${myBarHTML}
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>${pName}ÁöÑÂøÉÊÉÖ</span>
                <div class="dominant-mood-tag">
                    <span style="color:${partnerDominant.color}; font-weight:bold;">${partnerDominant.kaomoji} ${partnerDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>ËÆ∞ÂΩïÂ§©Êï∞: ${partnerTotal}</span>
            </div>
            ${partnerBarHTML}
        </div>
    `;
}

window.editStatsWeather = function(el, who) {
    if (el.querySelector('input')) return;
    var todayStr = formatDateStr(new Date());
    if (!moodData[todayStr]) moodData[todayStr] = {};
    var current = who === 'me' ? (moodData[todayStr].myWeather || '') : (moodData[todayStr].partnerWeather || '');
    var input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.maxLength = 20;
    input.placeholder = '‰ªäÊó•Â§©Ê∞î‚Ä¶';
    input.style.cssText = 'width:100%;padding:3px 7px;border:1px solid var(--accent-color);border-radius:8px;font-size:12px;background:var(--primary-bg);color:var(--text-primary);outline:none;text-align:center;';
    el.innerHTML = '';
    el.appendChild(input);
    input.focus(); input.select();
    function save() {
        var val = input.value.trim();
        if (who === 'me') moodData[todayStr].myWeather = val;
        else moodData[todayStr].partnerWeather = val;
        saveMoodData();
        el.innerHTML = val ? `<span>${val}</span>` : `<span style="opacity:0.4;">+ Â§©Ê∞î</span>`;
    }
    input.addEventListener('blur', save);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); save(); }
        if (e.key === 'Escape') { el.innerHTML = current ? `<span>${current}</span>` : `<span style="opacity:0.4;">+ Â§©Ê∞î</span>`; }
    });
};

window.deleteDailyMood = function(dateStr, who) {
    if (!moodData[dateStr]) return;
    if (who === 'me') { delete moodData[dateStr].user; delete moodData[dateStr].note; delete moodData[dateStr].myWeather; }
    else { delete moodData[dateStr].partner; delete moodData[dateStr].partnerNote; delete moodData[dateStr].partnerWeather; }
    if (!moodData[dateStr].user && !moodData[dateStr].partner) delete moodData[dateStr];
    saveMoodData();
    renderMoodCalendar();
    showNotification('Â∑≤Âà†Èô§ÂøÉÊÉÖËÆ∞ÂΩï', 'success');
    closeMoodOverlay();
};

function renderMoodOptionsGrid(targetKey) {
    const allMoods = getAllMoodOptions();
    const optionsGrid = document.getElementById('mood-options-grid');
    optionsGrid.innerHTML = allMoods.map(mood => {
        const isSelected = targetKey === mood.key;
        const isCustom = mood.key.startsWith('custom_');
        return `
        <div class="mood-option-btn${isCustom ? ' mood-option-custom' : ''}" 
             style="${isSelected ? `background:${mood.color}; color:#fff; border-color:${mood.color}; transform:scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,0.15);` : ''}"
             onclick="tempSelectMood('${mood.key}')">
            <div class="mood-kaomoji" style="${isSelected ? 'color:#fff' : `color:${mood.color}`}">${mood.kaomoji}</div>
            <div class="mood-label">${mood.label}</div>
            ${isCustom ? `<div class="mood-custom-actions" onclick="event.stopPropagation()">
                <button class="mood-custom-action-btn" onclick="editCustomMood('${mood.key}')" title="ÁºñËæë">‚úèÔ∏è</button>
                <button class="mood-custom-action-btn" onclick="deleteCustomMood('${mood.key}')" title="Âà†Èô§">üóë</button>
            </div>` : ''}
        </div>
    `}).join('');
}

function switchMoodPage(dir) {
    currentMoodPage = Math.max(1, Math.min(2, currentMoodPage + dir));
    const page1 = document.getElementById('mood-page-1');
    const page2 = document.getElementById('mood-page-2');
    const indicator = document.getElementById('mood-page-indicator');
    const prevBtn = document.getElementById('mood-page-prev');
    const nextBtn = document.getElementById('mood-page-next');
    if (currentMoodPage === 1) {
        page1.style.display = 'block'; page2.style.display = 'none';
        indicator.textContent = 'Á¨¨ 1 È°µ ¬∑ ÂøÉÊÉÖ';
        prevBtn.disabled = true; nextBtn.disabled = false;
    } else {
        page1.style.display = 'none'; page2.style.display = 'block';
        const isPartner = currentMoodEditTarget === 'partner';
        indicator.textContent = 'Á¨¨ 2 È°µ ¬∑ ÈöèËÆ∞';
        document.getElementById('mood-note-label').textContent = isPartner ? 'ÂØπÊñπÈöèËÆ∞:' : 'ÈöèËÆ∞:';
        document.getElementById('mood-note-input').placeholder = isPartner ? 'ËÆ∞ÂΩïÂØπÊñπ‰ªäÂ§©ÂèëÁîüÁöÑ‰∫ã...' : 'ËÆ∞ÂΩï‰∏ã‰ªäÂ§©ÂèëÁîüÁöÑÂ∞è‰∫ã...';
        prevBtn.disabled = false; nextBtn.disabled = true;
    }
}
window.switchMoodPage = switchMoodPage;

function switchMoodEditTarget(target) {
    currentMoodEditTarget = target;
    document.getElementById('mood-tab-me').classList.toggle('active', target === 'me');
    document.getElementById('mood-tab-partner').classList.toggle('active', target === 'partner');
    const existing = moodData[selectedDateStr];
    let currentKey, noteVal;
    if (target === 'me') {
        currentKey = existing ? existing.user : null;
        noteVal = (existing && existing.note) ? existing.note : '';
    } else {
        currentKey = existing ? existing.partner : null;
        noteVal = (existing && existing.partnerNote) ? existing.partnerNote : '';
    }
    currentMoodSelection = currentKey;
    document.getElementById('mood-note-input').value = noteVal;
    renderMoodOptionsGrid(currentKey);
    switchMoodPage(0); 
}
window.switchMoodEditTarget = switchMoodEditTarget;

function openMoodSelector(dateStr, editTarget) {
    selectedDateStr = dateStr;
    window.selectedDateStr = dateStr;
    currentMoodEditTarget = editTarget || 'me';
    currentMoodPage = 1;
    currentMoodSelection = null;

    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    const dateTitle = document.getElementById('mood-selector-date');

    editorView.style.display = 'block';
    detailView.style.display = 'none';

    const [y, m, d] = dateStr.split('-');
    dateTitle.textContent = `${m}Êúà${d}Êó•`;

    document.getElementById('mood-tab-me').classList.toggle('active', currentMoodEditTarget === 'me');
    document.getElementById('mood-tab-partner').classList.toggle('active', currentMoodEditTarget === 'partner');

    const existing = moodData[dateStr];
    let currentKey, noteVal, weatherVal;
    if (currentMoodEditTarget === 'me') {
        currentKey = existing ? existing.user : null;
        noteVal = (existing && existing.note) ? existing.note : '';
        weatherVal = (existing && existing.myWeather) ? existing.myWeather : '';
    } else {
        currentKey = existing ? existing.partner : null;
        noteVal = (existing && existing.partnerNote) ? existing.partnerNote : '';
        weatherVal = (existing && existing.partnerWeather) ? existing.partnerWeather : '';
    }
    currentMoodSelection = currentKey;
    document.getElementById('mood-note-input').value = noteVal;
    const weatherInput = document.getElementById('mood-weather-input');
    if (weatherInput) weatherInput.value = weatherVal;
    const weatherLabel = document.getElementById('mood-weather-label');
    if (weatherLabel) {
        var pNameW = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'Ê¢¶Ëßí';
        var mNameW = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'Êàë';
        if (weatherLabel.firstChild) weatherLabel.firstChild.textContent = currentMoodEditTarget === 'me' ? mNameW + 'ÁöÑÂ§©Ê∞î\u00a0' : pNameW + 'ÁöÑÂ§©Ê∞î\u00a0';
    }

    document.getElementById('mood-page-1').style.display = 'block';
    document.getElementById('mood-page-2').style.display = 'none';
    document.getElementById('mood-page-indicator').textContent = 'Á¨¨ 1 È°µ ¬∑ ÂøÉÊÉÖ';
    document.getElementById('mood-page-prev').disabled = true;
    document.getElementById('mood-page-next').disabled = false;

    renderMoodOptionsGrid(currentKey);
    overlay.classList.add('active');
}

window.editPartnerMoodRecord = function() {
    openMoodSelector(selectedDateStr, 'partner');
};

window.tempSelectMood = function(key) {
    currentMoodSelection = key;
    renderMoodOptionsGrid(key);
}

document.getElementById('confirm-mood-save').addEventListener('click', () => {
    if (!selectedDateStr) return;
    if (!currentMoodSelection && currentMoodPage === 1) {
        showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂøÉÊÉÖÂõæÊ†á', 'warning');
        return;
    }
    if (!moodData[selectedDateStr]) moodData[selectedDateStr] = {};
    const weatherVal = (document.getElementById('mood-weather-input') || {}).value || '';
    if (currentMoodEditTarget === 'me') {
        if (currentMoodSelection) moodData[selectedDateStr].user = currentMoodSelection;
        moodData[selectedDateStr].note = document.getElementById('mood-note-input').value.trim();
        moodData[selectedDateStr].myWeather = weatherVal.trim();
    } else {
        if (currentMoodSelection) moodData[selectedDateStr].partner = currentMoodSelection;
        moodData[selectedDateStr].partnerNote = document.getElementById('mood-note-input').value.trim();
        moodData[selectedDateStr].partnerWeather = weatherVal.trim();
    }
    
    saveMoodData();
    closeMoodOverlay();
    showNotification('ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò ‚ú¶', 'success');
});

function showDayDetails(dateStr, data) {
    selectedDateStr = dateStr;
    window.selectedDateStr = dateStr;
    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    
    const allMoods = getAllMoodOptions();
    const moodObj = allMoods.find(m => m.key === data.user);

    const [y, m, d] = dateStr.split('-');
    document.getElementById('detail-date').textContent = `${m}Êúà${d}Êó•`;

    const mySection = document.getElementById('detail-my-section');
    if (moodObj) {
        mySection.style.display = 'block';
        document.getElementById('detail-kaomoji').textContent = moodObj.kaomoji;
        document.getElementById('detail-label').textContent = moodObj.label;
        document.getElementById('detail-label').style.color = moodObj.color;
        document.getElementById('detail-text').textContent = data.note || "ÔºàËøôÂ§©Ê≤°ÊúâÂÜô‰∏ãÈöèËÆ∞...Ôºâ";
        detailView.style.borderLeftColor = moodObj.color;
        const myWeatherEl = document.getElementById('detail-my-weather');
        if (myWeatherEl) {
            if (data.myWeather) { myWeatherEl.style.display = 'block'; document.getElementById('detail-my-weather-val').textContent = data.myWeather; }
            else myWeatherEl.style.display = 'none';
        }
    } else {
        mySection.style.display = 'none';
    }

    const partnerSection = document.getElementById('detail-partner-section');
    const partnerNoRecord = document.getElementById('detail-partner-no-record');
    if (data.partner) {
        const partnerMoodObj = allMoods.find(mo => mo.key === data.partner);
        if (partnerMoodObj) {
            partnerSection.style.display = 'block';
            if (partnerNoRecord) partnerNoRecord.style.display = 'none';
            document.getElementById('detail-partner-kaomoji').textContent = partnerMoodObj.kaomoji;
            document.getElementById('detail-partner-label').textContent = partnerMoodObj.label;
            document.getElementById('detail-partner-label').style.color = partnerMoodObj.color;
            document.getElementById('detail-partner-text').textContent = data.partnerNote || "ÔºàTa ËøôÂ§©Ê≤°ÊúâÂÜô‰∏ã‰ªª‰ΩïÈöèËÆ∞Ôºâ";
            const partnerWeatherEl = document.getElementById('detail-partner-weather');
            if (partnerWeatherEl) {
                if (data.partnerWeather) { partnerWeatherEl.style.display = 'block'; document.getElementById('detail-partner-weather-val').textContent = data.partnerWeather; }
                else partnerWeatherEl.style.display = 'none';
            }
        } else {
            partnerSection.style.display = 'none';
            if (partnerNoRecord) partnerNoRecord.style.display = 'none';
        }
    } else {
        partnerSection.style.display = 'none';
        if (partnerNoRecord) partnerNoRecord.style.display = 'block';
    }

    editorView.style.display = 'none';
    detailView.style.display = 'block';
    overlay.classList.add('active');
}

document.getElementById('edit-existing-mood').addEventListener('click', () => {
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    openMoodSelector(selectedDateStr, 'me');
    editorView.style.display = 'block';
    detailView.style.display = 'none';
});

window.closeMoodOverlay = function() {
    document.getElementById('mood-selector-overlay').classList.remove('active');
    document.getElementById('custom-mood-dialog').style.display = 'none';
};
window.viewMoodDetailFromEditor = function() {
    if (!selectedDateStr || !moodData[selectedDateStr]) return;
    showDayDetails(selectedDateStr, moodData[selectedDateStr]);
};
document.getElementById('cancel-mood-edit').addEventListener('click', closeMoodOverlay);

window.openCustomMoodDialog = function() {
    const dialog = document.getElementById('custom-mood-dialog');
    document.getElementById('custom-mood-emoji').value = '';
    document.getElementById('custom-mood-label').value = '';
    customMoodSelectedColor = CUSTOM_MOOD_COLORS[0];
    const colorsEl = document.getElementById('custom-mood-colors');
    colorsEl.innerHTML = CUSTOM_MOOD_COLORS.map((c,i) => 
        `<div class="custom-mood-color-dot ${i===0?'selected':''}" style="background:${c};" onclick="selectCustomColor('${c}',this)"></div>`
    ).join('');
    // Reset save button to default add behavior
    const saveBtn = dialog.querySelector('.modal-btn-primary');
    saveBtn.onclick = window.saveCustomMood;
    dialog.style.display = 'block';
};
window.selectCustomColor = function(color, el) {
    customMoodSelectedColor = color;
    document.querySelectorAll('.custom-mood-color-dot').forEach(d => d.classList.remove('selected'));
    el.classList.add('selected');
};
window.closeCustomMoodDialog = function() {
    document.getElementById('custom-mood-dialog').style.display = 'none';
};
window.saveCustomMood = function() {
    const emoji = document.getElementById('custom-mood-emoji').value.trim();
    const label = document.getElementById('custom-mood-label').value.trim();
    if (!emoji || !label) { showNotification('ËØ∑Â°´ÂÜôË°®ÊÉÖÂíåÂêçÁß∞', 'warning'); return; }
    const key = 'custom_' + Date.now();
    customMoodOptions.push({ key, kaomoji: emoji, label, color: customMoodSelectedColor });
    saveCustomMoodOptions();
    closeCustomMoodDialog();
    renderMoodOptionsGrid(currentMoodSelection);
    showNotification('Ëá™ÂÆö‰πâÂøÉÊÉÖÂ∑≤Ê∑ªÂä† ‚ú¶', 'success');
};

window.deleteCustomMood = function(key) {
    customMoodOptions = customMoodOptions.filter(m => m.key !== key);
    saveCustomMoodOptions();
    renderMoodOptionsGrid(currentMoodSelection);
    showNotification('Â∑≤Âà†Èô§Ëá™ÂÆö‰πâÂøÉÊÉÖ', 'success');
};

window.editCustomMood = function(key) {
    const mood = customMoodOptions.find(m => m.key === key);
    if (!mood) return;
    const dialog = document.getElementById('custom-mood-dialog');
    document.getElementById('custom-mood-emoji').value = mood.kaomoji;
    document.getElementById('custom-mood-label').value = mood.label;
    customMoodSelectedColor = mood.color;
    const colorsEl = document.getElementById('custom-mood-colors');
    colorsEl.innerHTML = CUSTOM_MOOD_COLORS.map((c) => 
        `<div class="custom-mood-color-dot ${c===mood.color?'selected':''}" style="background:${c};" onclick="selectCustomColor('${c}',this)"></div>`
    ).join('');
    dialog.style.display = 'block';
    // Override save to update existing
    dialog._editingKey = key;
    const saveBtn = dialog.querySelector('.modal-btn-primary');
    saveBtn.onclick = function() {
        const emoji = document.getElementById('custom-mood-emoji').value.trim();
        const label = document.getElementById('custom-mood-label').value.trim();
        if (!emoji || !label) { showNotification('ËØ∑Â°´ÂÜôË°®ÊÉÖÂíåÂêçÁß∞', 'warning'); return; }
        const idx = customMoodOptions.findIndex(m => m.key === key);
        if (idx !== -1) customMoodOptions[idx] = { key, kaomoji: emoji, label, color: customMoodSelectedColor };
        saveCustomMoodOptions();
        closeCustomMoodDialog();
        saveBtn.onclick = null;
        renderMoodOptionsGrid(currentMoodSelection);
        showNotification('Ëá™ÂÆö‰πâÂøÉÊÉÖÂ∑≤Êõ¥Êñ∞ ‚ú¶', 'success');
    };
};

function initMoodListeners() {

    const btnCalendar = document.getElementById('btn-view-calendar');
    const btnStats = document.getElementById('btn-view-stats');
    const viewCalendar = document.getElementById('mood-calendar-view');
    const viewStats = document.getElementById('mood-stats-view');

    if (btnCalendar && btnStats) {
        btnCalendar.addEventListener('click', () => {
            btnCalendar.classList.add('active');
            btnStats.classList.remove('active');
            viewCalendar.classList.remove('hidden-view');
            viewStats.classList.add('hidden-view');
        });

        btnStats.addEventListener('click', () => {
            btnStats.classList.add('active');
            btnCalendar.classList.remove('active');
            viewStats.classList.remove('hidden-view');
            viewCalendar.classList.add('hidden-view');
            renderMoodCalendar(); 
        });
    }
    const entryBtn = document.getElementById('mood-function');
    const modal = document.getElementById('mood-modal');
    if (entryBtn) {
        entryBtn.addEventListener('click', () => {
            if (typeof window.updateDynamicNames === 'function') window.updateDynamicNames();
            // Hide advanced modal directly without animation to avoid timing conflict
            var advModal = document.getElementById('advanced-modal');
            if (advModal) advModal.style.display = 'none';
            // Small delay to ensure no display:none conflict from prior hideModal timeout
            setTimeout(() => {
                renderMoodCalendar();
                showModal(modal);
            }, 50);
        });
    }

    const closeMoodBtn = document.getElementById('close-mood');
    if (closeMoodBtn) {
        closeMoodBtn.addEventListener('click', () => hideModal(modal));
    }
    
    const closeMoodSelectorBtn = document.getElementById('close-mood-selector');
    if (closeMoodSelectorBtn) {
        closeMoodSelectorBtn.addEventListener('click', () => {
            const overlay = document.getElementById('mood-selector-overlay');
            if (overlay) overlay.classList.remove('active');
        });
    }
    
    const cancelMoodBtn = document.getElementById('cancel-mood-edit');
    if (cancelMoodBtn) {
        cancelMoodBtn.addEventListener('click', () => {
            const overlay = document.getElementById('mood-selector-overlay');
            if (overlay) overlay.classList.remove('active');
        });
    }

    const prevMonthBtn = document.getElementById('prev-month');
    if (prevMonthBtn) {
        prevMonthBtn.onclick = () => {
            const y = currentCalendarDate.getFullYear();
            const m = currentCalendarDate.getMonth();
            currentCalendarDate = new Date(y, m - 1, 1);
            renderMoodCalendar();
        };
    }
    
    const nextMonthBtn = document.getElementById('next-month');
    if (nextMonthBtn) {
        nextMonthBtn.onclick = () => {
            const y = currentCalendarDate.getFullYear();
            const m = currentCalendarDate.getMonth();
            currentCalendarDate = new Date(y, m + 1, 1);
            renderMoodCalendar();
        };
    }
}

let envelopeData = { outbox: [], inbox: [] }; 
let currentEnvTab = 'outbox';
let editingEnvId = null; 
let editingEnvSection = null; 

async function loadEnvelopeData() {
    const saved = await localforage.getItem(getStorageKey('envelopeData'));
    if (saved) envelopeData = saved;
    const oldPending = await localforage.getItem(getStorageKey('pending_envelope'));
    if (oldPending && envelopeData.outbox.length === 0) {
        envelopeData.outbox.push({
            id: 'legacy_' + Date.now(),
            content: 'ÔºàÂéÜÂè≤ÂØÑÂá∫ÁöÑ‰ø°‰ª∂Ôºâ',
            sentTime: oldPending.sentTime,
            replyTime: oldPending.replyTime,
            status: 'pending'
        });
        await localforage.removeItem(getStorageKey('pending_envelope'));
        saveEnvelopeData();
    }
}

function saveEnvelopeData() {
    localforage.setItem(getStorageKey('envelopeData'), envelopeData);
}

async function checkEnvelopeStatus() {
    await loadEnvelopeData();
    const now = Date.now();
    let changed = false;
    let newReplyLetter = null;
    envelopeData.outbox.forEach(letter => {
        if (letter.status === 'pending' && now >= letter.replyTime) {
            letter.status = 'replied';
            const replyContent = generateEnvelopeReplyText();
            const replyId = 'reply_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
            const inboxLetter = {
                id: replyId,
                refId: letter.id,
                originalContent: letter.content,
                content: replyContent,
                receivedTime: Date.now(),
                isNew: true
            };
            envelopeData.inbox.push(inboxLetter);
            newReplyLetter = inboxLetter;
            changed = true;
            playSound('message');
        }
    });
    if (changed) {
        saveEnvelopeData();
        if (newReplyLetter) showEnvelopeReplyPopup(newReplyLetter);
    }
}

function showEnvelopeReplyPopup(letter) {
    const existing = document.getElementById('envelope-reply-popup');
    if (existing) existing.remove();
    const popup = document.createElement('div');
    popup.id = 'envelope-reply-popup';
    popup.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--secondary-bg);border:1px solid var(--border-color);border-radius:20px;padding:18px 20px;z-index:8000;max-width:320px;width:88%;box-shadow:0 8px 32px rgba(0,0,0,0.18);display:flex;flex-direction:column;gap:12px;animation:slideUpNotif 0.4s cubic-bezier(0.22,1,0.36,1);';
    popup.innerHTML = `
        <style>@keyframes slideUpNotif{from{opacity:0;transform:translateX(-50%) translateY(24px) scale(0.9)}60%{transform:translateX(-50%) translateY(-4px) scale(1.02)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}</style>
        <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:26px;">üíå</span>
            <div>
                <div style="font-size:14px;font-weight:700;color:var(--text-primary);">Êî∂Âà∞‰∫Ü‰∏ÄÂ∞ÅÂõû‰ø°</div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;opacity:0.8;">Ta Áªô‰Ω†ÂÜô‰∫ÜÂõû‰ø°ÔºåÂø´ÂéªÁúãÁúãÂêß~</div>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="document.getElementById('envelope-reply-popup').remove();" style="flex:1;padding:8px 0;border-radius:12px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-secondary);font-size:13px;cursor:pointer;">Á®çÂêéÊü•Áúã</button>
            <button onclick="openEnvelopeAndViewReply('${letter.id}');" style="flex:2;padding:8px 0;border-radius:12px;border:none;background:var(--accent-color);color:#fff;font-size:13px;font-weight:600;cursor:pointer;">Á´ãÂç≥ÈòÖËØª ‚úâ</button>
        </div>`;
    document.body.appendChild(popup);
    setTimeout(() => { if (popup.parentNode) popup.remove(); }, 8000);
}

const APPEARANCE_PANEL_TITLES = {
    'theme': '‰∏ªÈ¢òÈÖçËâ≤', 'font': 'Â≠ó‰ΩìËÆæÁΩÆ', 'background': 'ËÅäÂ§©ËÉåÊôØ',
    'bubble': 'Ê∞îÊ≥°Ê†∑Âºè', 'avatar': 'ËÅäÂ§©Â§¥ÂÉè', 'css': 'Ëá™ÂÆö‰πâCSS',
    'font-bg': 'ËÉåÊôØ & Â≠ó‰Ωì', 'bubble-css': 'Ê∞îÊ≥° & CSS'
};
window.showAppearancePanel = function(panel) {
    const panelMap = {
        'font-bg': ['font', 'background'],
        'bubble-css': ['bubble', 'css']
    };
    document.getElementById('appearance-nav-grid').style.display = 'none';
    document.getElementById('appearance-panel-container').style.display = 'block';
    document.getElementById('appearance-panel-title').textContent = APPEARANCE_PANEL_TITLES[panel] || panel;
    document.querySelectorAll('.appearance-sub-panel').forEach(p => p.style.display = 'none');
    if (panelMap[panel]) {
        panelMap[panel].forEach(sub => {
            const target = document.getElementById('appearance-panel-' + sub);
            if (target) target.style.display = 'block';
        });
    } else {
        const target = document.getElementById('appearance-panel-' + panel);
        if (target) target.style.display = 'block';
    }
    if (panel === 'bubble' || panel === 'bubble-css') { setTimeout(() => { if (typeof window.updateBubblePreviewFn === 'function') window.updateBubblePreviewFn(); }, 50); }
};
window.hideAppearancePanel = function() {
    document.getElementById('appearance-nav-grid').style.display = 'grid';
    document.getElementById('appearance-panel-container').style.display = 'none';
    document.querySelectorAll('.appearance-sub-panel').forEach(p => p.style.display = 'none');
};

window.openEnvelopeAndViewReply = function(replyId) {
    const popup = document.getElementById('envelope-reply-popup');
    if (popup) popup.remove();
    const envelopeModal = document.getElementById('envelope-modal');
    showModal(envelopeModal);
    setTimeout(() => {
        switchEnvTab('inbox');
        viewEnvLetter('inbox', replyId);
    }, 200);
};

function generateEnvelopeReplyText() {
    const sourcePool = [...customReplies, ...CONSTANTS.REPLY_MESSAGES.filter(t => !disabledDefaultReplies.includes(t))];
    const sentenceCount = Math.floor(Math.random() * (12 - 8 + 1)) + 8;
    let replyContent = "";
    for (let i = 0; i < sentenceCount; i++) {
        const randomSentence = sourcePool[Math.floor(Math.random() * sourcePool.length)];
        const punctuation = Math.random() < 0.2 ? "ÔºÅ" : (Math.random() < 0.2 ? "..." : "„ÄÇ");
        replyContent += randomSentence + punctuation;
    }
    return replyContent;
}



window.switchEnvTab = function(tab) {
    currentEnvTab = tab;
    document.getElementById('env-tab-outbox').classList.toggle('active', tab === 'outbox');
    document.getElementById('env-tab-inbox').classList.toggle('active', tab === 'inbox');
    document.getElementById('env-outbox-section').style.display = tab === 'outbox' ? 'block' : 'none';
    document.getElementById('env-inbox-section').style.display = tab === 'inbox' ? 'block' : 'none';
    document.getElementById('env-compose-form').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'flex';
    renderEnvelopeLists();
};

function renderEnvelopeLists() {
    renderOutboxList();
    renderInboxList();
    const pendingCount = envelopeData.outbox.filter(l => l.status === 'pending').length;
    const newInboxCount = envelopeData.inbox.filter(l => l.isNew).length;
    const outboxBadge = document.getElementById('env-outbox-badge');
    const inboxBadge = document.getElementById('env-inbox-badge');
    if (outboxBadge) { outboxBadge.textContent = pendingCount; outboxBadge.style.display = pendingCount > 0 ? 'inline-block' : 'none'; }
    if (inboxBadge) { inboxBadge.textContent = newInboxCount; inboxBadge.style.display = newInboxCount > 0 ? 'inline-block' : 'none'; }
    const envelopeEntryBadge = document.getElementById('env-entry-badge');
    if (envelopeEntryBadge) { envelopeEntryBadge.style.display = newInboxCount > 0 ? 'inline-block' : 'none'; }
}

function renderOutboxList() {
    const list = document.getElementById('env-outbox-list');
    if (!list) return;
    if (envelopeData.outbox.length === 0) {
        list.innerHTML = `<div class="env-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
            <div style="font-size:14px;font-weight:500;margin-top:4px;">ËøòÊ≤°ÊúâÂØÑÂá∫‰ªª‰Ωï‰ø°‰ª∂</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">ÊèêÁ¨îÂÜô‰∏ãÂøÉÊÑèÔºåÂØÑÈÄÅÁªôTaÂêß~</div>
        </div>`;
        return;
    }
    list.innerHTML = envelopeData.outbox.slice().reverse().map(letter => {
        const date = new Date(letter.sentTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const isPending = letter.status === 'pending';
        const replyTime = isPending ? new Date(letter.replyTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
        const statusIcon = isPending
            ? `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`
            : `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        const statusText = isPending ? `${statusIcon} È¢ÑËÆ° ${replyTime} Âõû‰ø°` : `${statusIcon} Â∑≤Êî∂Âà∞Âõû‰ø°`;
        const preview = letter.content.length > 38 ? letter.content.substring(0, 38) + '‚Ä¶' : letter.content;
        return `
        <div class="env-letter-item" onclick="viewEnvLetter('outbox','${letter.id}')">
            <div class="env-letter-header">
                <div class="env-letter-header-from">
                    <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:3px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
                    ÂØÑÂá∫ ¬∑ ${date}
                </div>
                <div class="env-stamp">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </div>
            </div>
            <div class="env-letter-body">
                <div class="env-letter-preview">${preview}</div>
                <div class="env-letter-status">${statusText}</div>
            </div>
            <button class="env-letter-delete-btn" onclick="deleteEnvLetter(event,'outbox','${letter.id}')">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>`;
    }).join('');
}

function renderInboxList() {
    const list = document.getElementById('env-inbox-list');
    if (!list) return;
    if (envelopeData.inbox.length === 0) {
        list.innerHTML = `<div class="env-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/><polyline points="22 13 12 13"/><path d="M19 16l-5-3-5 3"/></svg>
            <div style="font-size:14px;font-weight:500;margin-top:4px;">ËøòÊ≤°ÊúâÊî∂Âà∞Âõû‰ø°</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">ÂØπÊñπÊ≠£Âú®ËÆ§ÁúüÂõûÂ§ç‰∏≠ÔºåËØ∑Á®çÂÄô~</div>
        </div>`;
        return;
    }
    list.innerHTML = envelopeData.inbox.slice().reverse().map(letter => {
        const date = new Date(letter.receivedTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const preview = letter.content.length > 50 ? letter.content.substring(0, 50) + '‚Ä¶' : letter.content;
        const isNew = letter.isNew;
        return `
        <div class="env-letter-item reply ${isNew ? 'env-letter-new' : ''}" onclick="viewEnvLetter('inbox','${letter.id}')">
            <div class="env-letter-header">
                <div class="env-letter-header-from">
                    <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:3px;"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                    Êî∂Âà∞ ¬∑ ${date}
                    ${isNew ? '<span style="background:rgba(255,255,255,0.3);color:#fff;font-size:9px;padding:1px 5px;border-radius:6px;margin-left:6px;">Êñ∞</span>' : ''}
                </div>
                <div class="env-stamp">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
            </div>
            <div class="env-letter-body">
                <div class="env-letter-preview">${preview}</div>
            </div>
            <button class="env-letter-delete-btn" onclick="deleteEnvLetter(event,'inbox','${letter.id}')">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>`;
    }).join('');
}

window.viewEnvLetter = function(section, id) {
    const letters = section === 'outbox' ? envelopeData.outbox : envelopeData.inbox;
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    if (section === 'inbox' && letter.isNew) {
        letter.isNew = false;
        saveEnvelopeData();
        renderEnvelopeLists();
    }
    editingEnvId = id;
    editingEnvSection = section;

    document.getElementById('env-view-title').textContent = section === 'outbox' ? 'ÂØÑÂá∫ÁöÑ‰ø°' : 'Êî∂Âà∞ÁöÑÂõû‰ø°';

    const dateObj = letter.timestamp ? new Date(letter.timestamp) : new Date();
    const y = dateObj.getFullYear();
    const mo = String(dateObj.getMonth()+1).padStart(2,'0');
    const d = String(dateObj.getDate()).padStart(2,'0');
    const dateStr = `${y}/${mo}/${d}`;
    const weekdays = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
    const fullDateStr = dateStr + ' ÊòüÊúü' + weekdays[dateObj.getDay()];

    const stampEl = document.getElementById('env-view-stamp-date');
    if (stampEl) stampEl.textContent = `${mo}/${d}`;

    const dateLine = document.getElementById('env-view-date-line');
    if (dateLine) dateLine.textContent = fullDateStr;

    const toLine = document.getElementById('env-view-to-line');
    const greetingLine = document.getElementById('env-view-greeting-line');
    if (section === 'outbox') {
        const partnerName = (typeof settings !== 'undefined' && settings.partnerName) || '‰∫≤Áà±ÁöÑ';
        if (toLine) toLine.textContent = `Ëá¥ ${partnerName}Ôºö`;
        if (greetingLine) greetingLine.textContent = 'ËßÅÂ≠óÂ¶ÇÈù¢ÔºåÊúõÂêõÂÆâÂ•Ω„ÄÇ';
    } else {
        const myName = (typeof settings !== 'undefined' && settings.myName) || '‰Ω†';
        if (toLine) toLine.textContent = `Ëá¥ ${myName}Ôºö`;
        if (greetingLine) greetingLine.textContent = 'ËßÅÂ≠óÂ¶ÇÈù¢Ôºå‰∏ÄÂàáÁöÜÂ•Ω„ÄÇ';
    }

    const textEl = document.getElementById('env-view-text');
    if (textEl) textEl.textContent = letter.content;

    const signDateEl = document.getElementById('env-view-sign-date');
    const signNameEl = document.getElementById('env-view-sign-name');
    if (signDateEl) signDateEl.textContent = fullDateStr;
    if (section === 'outbox') {
        const myName = (typeof settings !== 'undefined' && settings.myName) || '‰Ω†';
        if (signNameEl) signNameEl.textContent = myName;
    } else {
        const partnerName = (typeof settings !== 'undefined' && settings.partnerName) || 'ÂØπÊñπ';
        if (signNameEl) signNameEl.textContent = partnerName;
    }

    document.getElementById('env-edit-input').value = letter.content;
    document.getElementById('env-view-content').style.display = 'block';
    document.getElementById('env-view-edit').style.display = 'none';
    document.getElementById('env-view-edit-btn').style.display = 'inline-flex';
    document.getElementById('env-view-save-btn').style.display = 'none';
    showModal(document.getElementById('envelope-view-modal'));
};

window.toggleEnvEdit = function() {
    const contentEl = document.getElementById('env-view-content');
    const editEl = document.getElementById('env-view-edit');
    const editBtn = document.getElementById('env-view-edit-btn');
    const saveBtn = document.getElementById('env-view-save-btn');
    const isEditing = editEl.style.display !== 'none';
    if (isEditing) {
        contentEl.style.display = 'block';
        editEl.style.display = 'none';
        editBtn.textContent = 'ÁºñËæë';
        saveBtn.style.display = 'none';
    } else {
        contentEl.style.display = 'none';
        editEl.style.display = 'block';
        editBtn.textContent = 'ÂèñÊ∂à';
        saveBtn.style.display = 'inline-flex';
    }
};

window.saveEnvEdit = function() {
    const newContent = document.getElementById('env-edit-input').value.trim();
    if (!newContent) { showNotification('ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'warning'); return; }
    const letters = editingEnvSection === 'outbox' ? envelopeData.outbox : envelopeData.inbox;
    const letter = letters.find(l => l.id === editingEnvId);
    if (letter) {
        letter.content = newContent;
        saveEnvelopeData();
        const textEl = document.getElementById('env-view-text');
        if (textEl) textEl.textContent = newContent;
        showNotification('Â∑≤‰øùÂ≠ò‰øÆÊîπ', 'success');
        toggleEnvEdit();
    }
};

window.closeEnvViewModal = function() {
    hideModal(document.getElementById('envelope-view-modal'));
};

window.deleteEnvLetter = function(event, section, id) {
    event.stopPropagation();
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂ∞Å‰ø°ÂêóÔºü')) return;
    if (section === 'outbox') {
        envelopeData.outbox = envelopeData.outbox.filter(l => l.id !== id);
    } else {
        envelopeData.inbox = envelopeData.inbox.filter(l => l.id !== id);
    }
    saveEnvelopeData();
    renderEnvelopeLists();
    showNotification('Â∑≤Âà†Èô§', 'success');
};

window.openNewEnvelopeForm = function() {
    document.getElementById('env-outbox-section').style.display = 'none';
    document.getElementById('env-inbox-section').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'none';
    document.getElementById('env-compose-title').textContent = 'ÂÜô‰∏ÄÂ∞Å‰ø°';
    document.getElementById('envelope-input').value = '';
    document.getElementById('env-send-to-chat').checked = false;
    document.getElementById('env-compose-form').style.display = 'block';
};

window.cancelEnvelopeCompose = function() {
    document.getElementById('env-compose-form').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'flex';
    if (currentEnvTab === 'outbox') {
        document.getElementById('env-outbox-section').style.display = 'block';
    } else {
        document.getElementById('env-inbox-section').style.display = 'block';
    }
};

function handleSendEnvelope() {
    const text = document.getElementById('envelope-input').value.trim();
    if (!text) { showNotification('‰ø°‰ª∂ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'warning'); return; }

    const sendToChat = document.getElementById('env-send-to-chat').checked;
    if (sendToChat) {
        addMessage({ id: Date.now(), sender: 'user', text: `„ÄêÂØÑÂá∫ÁöÑ‰ø°„Äë\n${text}`, timestamp: new Date(), status: 'sent', type: 'normal' });
    }

    const minHours = 10, maxHours = 24;
    const randomHours = Math.random() * (maxHours - minHours) + minHours;
    const replyTime = Date.now() + randomHours * 60 * 60 * 1000;
    const newId = 'env_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
    envelopeData.outbox.push({
        id: newId, content: text,
        sentTime: Date.now(), replyTime,
        status: 'pending'
    });
    saveEnvelopeData();

    cancelEnvelopeCompose();
    switchEnvTab('outbox');
    showNotification(`‰ø°‰ª∂Â∑≤ÂØÑÂá∫ÔºåÈ¢ÑËÆ° ${Math.floor(randomHours)} Â∞èÊó∂ÂêéÊî∂Âà∞Âõû‰ø° ‚úâÔ∏è`, 'success');
}

function setupEventListeners() {
    console.log("Ê≠£Âú®ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨..."); 
    
    try {
        initCoreListeners();
        initModalListeners();
        initChatActionListeners();
        initHeaderAndSettingsListeners();
        initDataManagementListeners();
        initNewFeatureListeners();
        setupTutorialListeners();
        initMoodListeners();
        initDecisionModule(); 
        initAnniversaryModule(); 
        initThemeEditor(); 
        initThemeSchemes();
        
        initComboMenu(); 
        
    } catch (e) {
        console.error("‰∫ã‰ª∂ÁªëÂÆöËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØ:", e);
    }
}
let wheelOptions = ["ÊòØ", "Âê¶", "ÂÜçÊÉ≥‰∏ÄÊÉ≥", "Âê¨‰Ω†ÁöÑ"];
let wheelResultText = "";

function initDecisionModule() {
    const entryBtn = document.getElementById('decision-function'); 
    if(entryBtn) {
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        newBtn.addEventListener('click', () => {
            hideModal(document.getElementById('advanced-modal'));
            showModal(document.getElementById('decision-menu-modal'));
        });
    }

    const openCoinBtn = document.getElementById('open-coin-toss');
    const openWheelBtn = document.getElementById('open-wheel');
    const closeMenuBtn = document.getElementById('close-decision-menu');
    const closeWheelBtn = document.getElementById('close-wheel');
    const addOptionBtn = document.getElementById('add-wheel-option');
    const spinBtn = document.getElementById('spin-wheel-btn');
    const sendResultBtn = document.getElementById('send-wheel-result');

    if (openCoinBtn && !openCoinBtn.dataset.initialized) {
        openCoinBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            handleCoinToss();
        });
        openCoinBtn.dataset.initialized = 'true';
    }

    if (openWheelBtn && !openWheelBtn.dataset.initialized) {
        openWheelBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            initPicker();
            showModal(document.getElementById('wheel-modal'));
        });
        openWheelBtn.dataset.initialized = 'true';
    }
    
    if (closeMenuBtn && !closeMenuBtn.dataset.initialized) {
        closeMenuBtn.addEventListener('click', () => hideModal(document.getElementById('decision-menu-modal')));
        closeMenuBtn.dataset.initialized = 'true';
    }

    if (closeWheelBtn && !closeWheelBtn.dataset.initialized) {
        closeWheelBtn.addEventListener('click', () => hideModal(document.getElementById('wheel-modal')));
        closeWheelBtn.dataset.initialized = 'true';
    }

    if (addOptionBtn && !addOptionBtn.dataset.initialized) {
        addOptionBtn.addEventListener('click', () => {
            wheelOptions.push(`ÈÄâÈ°π ${wheelOptions.length + 1}`);
            renderPickerOptions();
            renderPickerCards();
        });
        addOptionBtn.dataset.initialized = 'true';
    }

    if (spinBtn && !spinBtn.dataset.initialized) {
        spinBtn.addEventListener('click', doPick);
        spinBtn.dataset.initialized = 'true';
    }
    
    if (sendResultBtn && !sendResultBtn.dataset.initialized) {
        sendResultBtn.addEventListener('click', () => {
            if(wheelResultText) {
                sendMessage(`‚ú® ÈöèÊú∫ÊäΩÁ≠æÁªìÊûúÔºö${wheelResultText}`, 'normal');
                hideModal(document.getElementById('wheel-modal'));
                wheelResultText = "";
                sendResultBtn.style.display = 'none';
                const resultEl = document.getElementById('wheel-result');
                if (resultEl) { resultEl.textContent = ""; resultEl.classList.remove('show'); }
                spinBtn.disabled = false;
            }
        });
        sendResultBtn.dataset.initialized = 'true';
    }
}

function initPicker() {
    renderPickerOptions();
    renderPickerCards();
    const result = document.getElementById('wheel-result');
    const sendBtn = document.getElementById('send-wheel-result');
    const spinBtn = document.getElementById('spin-wheel-btn');
    if (result) { result.textContent = ""; result.classList.remove('show'); }
    if (sendBtn) sendBtn.style.display = 'none';
    if (spinBtn) spinBtn.disabled = false;
    wheelResultText = "";
}

function renderPickerOptions() {
    const list = document.getElementById('wheel-options-list');
    if (!list) return;
    list.innerHTML = '';
    const colors = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#E0C3FC','#FF9A8B','#A8D8EA','#C44569'];
    wheelOptions.forEach((opt, index) => {
        const item = document.createElement('div');
        item.className = 'picker-option-item';
        item.innerHTML = `
            <div class="picker-option-color-dot" style="background:${colors[index % colors.length]}"></div>
            <input type="text" class="picker-option-input" value="${opt}" placeholder="ËæìÂÖ•ÈÄâÈ°π...">
            <span class="picker-option-remove"><i class="fas fa-times"></i></span>
        `;
        item.querySelector('input').addEventListener('input', (e) => {
            wheelOptions[index] = e.target.value;
            renderPickerCards();
        });
        item.querySelector('.picker-option-remove').addEventListener('click', () => {
            if(wheelOptions.length <= 2) {
                showNotification('Ëá≥Â∞ë‰øùÁïô‰∏§‰∏™ÈÄâÈ°π', 'warning');
                return;
            }
            wheelOptions.splice(index, 1);
            renderPickerOptions();
            renderPickerCards();
        });
        list.appendChild(item);
    });
}

function renderPickerCards(selectedIndex = -1) {
    const row = document.getElementById('picker-cards-row');
    if (!row) return;
    const colors = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#E0C3FC','#FF9A8B','#A8D8EA','#C44569'];
    row.innerHTML = '';
    wheelOptions.forEach((opt, i) => {
        const card = document.createElement('div');
        card.className = 'picker-card';
        if (selectedIndex >= 0) {
            if (i === selectedIndex) card.classList.add('selected');
            else card.classList.add('unselected');
        }
        if (selectedIndex >= 0 && i === selectedIndex) {
            card.style.background = `linear-gradient(135deg, ${colors[i % colors.length]}, ${colors[(i+2) % colors.length]})`;
        } else {
            card.style.borderTop = `3px solid ${colors[i % colors.length]}`;
        }
        card.style.animationDelay = (i * 0.06) + 's';
        const label = opt || `ÈÄâÈ°π${i+1}`;
        card.textContent = label.length > 6 ? label.slice(0,5) + '‚Ä¶' : label;
        row.appendChild(card);
    });
}

function doPick() {
    if (wheelOptions.length < 2) {
        showNotification("ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏§‰∏™ÈÄâÈ°π", "warning");
        return;
    }
    const spinBtn = document.getElementById('spin-wheel-btn');
    const resultDisplay = document.getElementById('wheel-result');
    const sendBtn = document.getElementById('send-wheel-result');
    
    spinBtn.disabled = true;
    sendBtn.style.display = 'none';
    resultDisplay.classList.remove('show');
    resultDisplay.textContent = "";

    let flashCount = 0;
    const totalFlashes = 16 + Math.floor(Math.random() * 8);
    const finalIndex = Math.floor(Math.random() * wheelOptions.length);
    
    function flash() {
        const row = document.getElementById('picker-cards-row');
        if (!row) return;
        const cards = row.querySelectorAll('.picker-card');
        cards.forEach(c => c.style.transform = '');
        
        let showIdx;
        if (flashCount < totalFlashes - 3) {
            showIdx = Math.floor(Math.random() * wheelOptions.length);
        } else {
            showIdx = finalIndex;
        }
        
        cards.forEach((c, i) => {
            if (i === showIdx) {
                c.style.transform = 'translateY(-4px) scale(1.06)';
                c.style.background = `linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.7))`;
                c.style.borderColor = 'transparent';
                c.style.color = '#fff';
            } else {
                c.style.transform = '';
                c.style.background = '';
                c.style.borderColor = '';
                c.style.color = '';
            }
        });
        
        flashCount++;
        const delay = flashCount < 8 ? 80 : flashCount < 14 ? 130 : 250;
        if (flashCount < totalFlashes) {
            setTimeout(flash, delay);
        } else {
            setTimeout(() => {
                renderPickerCards(finalIndex);
                wheelResultText = wheelOptions[finalIndex];
                resultDisplay.innerHTML = `<i class="fas fa-star" style="font-size:14px; margin-right:6px;"></i>${wheelResultText}`;
                resultDisplay.classList.add('show');
                spinBtn.disabled = false;
                sendBtn.style.display = 'inline-block';
                playSound('favorite');
            }, 300);
        }
    }
    
    flash();
}function initComboMenu() {
    const comboBtn = document.getElementById('combo-btn');
    const picker = document.getElementById('user-sticker-picker');
    const contentArea = document.getElementById('combo-content-area');
    
    if (!comboBtn || !picker) return;
    
    if (comboBtn.dataset.initialized) return;
    
    comboBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = picker.classList.contains('active');
        
        if (isActive) {
            picker.classList.remove('active');
        } else {
            switchTab('sticker');
            picker.classList.add('active');
        }
    });
    
    comboBtn.dataset.initialized = 'true';

    document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && !comboBtn.contains(e.target)) {
            picker.classList.remove('active');
        }
    });

    const tabs = picker.querySelectorAll('.combo-tab-btn');
    tabs.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const tabId = btn.dataset.tab;
            switchTab(tabId);
        });
    });

    function switchTab(tabId) {
        tabs.forEach(b => b.classList.remove('active'));
        const activeBtn = Array.from(tabs).find(b => b.dataset.tab === tabId);
        if (activeBtn) activeBtn.classList.add('active');

        if (tabId === 'sticker') {
            renderStickerLibrary();
        } else {
            renderUserPokeMenu();
        }
    }

    function renderStickerLibrary() {
        contentArea.innerHTML = '';
        
        if (!stickerLibrary || stickerLibrary.length === 0) {
            contentArea.innerHTML = `
                <div class="empty-sticker-tip">
                    <i class="far fa-images"></i>
                    Ë°®ÊÉÖÂ∫ìËøòÊòØÁ©∫ÁöÑÂì¶<br>
                    ËØ∑Âéª‚ÄúÈ´òÁ∫ßÂäüËÉΩ‚Äù->‚ÄúËá™ÂÆö‰πâÂõûÂ§ç‚Äù->‚ÄúË°®ÊÉÖÂ∫ì‚Äù‰∏≠Ê∑ªÂä†ÂõæÁâá~
                </div>
            `;
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'sticker-grid-view';

        stickerLibrary.forEach(src => {
            const item = document.createElement('div');
            item.className = 'sticker-grid-item';
            item.innerHTML = `<img src="${src}" loading="lazy">`;
            
            item.onclick = (e) => {
                e.stopPropagation();
                addMessage({
                    id: Date.now(),
                    sender: 'user',
                    text: '',
                    timestamp: new Date(),
                    image: src, 
                    status: 'sent',
                    type: 'normal'
                });
                playSound('send');
                picker.classList.remove('active');
                
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            };
            grid.appendChild(item);
        });

        contentArea.appendChild(grid);
    }

    function renderUserPokeMenu() {
        contentArea.innerHTML = '';

        const wrapper = document.createElement('div');
        wrapper.className = 'poke-list-view';

        const customBtn = document.createElement('button');
        customBtn.className = 'custom-poke-btn';
        customBtn.innerHTML = '<i class="fas fa-pen"></i> Ëá™ÂÆö‰πâÂä®‰Ωú';
        customBtn.onclick = (e) => {
            e.stopPropagation();
            picker.classList.remove('active');
            showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
        };
        wrapper.appendChild(customBtn);

        const userPresets = [
            "Êãç‰∫ÜÊãçÂØπÊñπÁöÑÂ§¥",
            "Êà≥‰∫ÜÊà≥ÂØπÊñπÁöÑËÑ∏È¢ä",
            "Êä±‰Ωè‰∫ÜÂØπÊñπ",
            "ÁªôÂØπÊñπÊØî‰∫Ü‰∏™ÂøÉ",
            "ÁâµËµ∑‰∫ÜÂØπÊñπÁöÑÊâã",
            "ÁúãÁùÄÂØπÊñπÂèëÂëÜ"
        ];

        const title = document.createElement('div');
        title.style.fontSize = '12px';
        title.style.color = 'var(--text-secondary)';
        title.style.marginBottom = '5px';
        title.innerText = 'Âø´Êç∑Âä®‰Ωú';
        wrapper.appendChild(title);

        userPresets.forEach(text => {
            const item = document.createElement('div');
            item.className = 'poke-quick-item';
            item.innerText = text;
            item.onclick = (e) => {
                e.stopPropagation();
                addMessage({
                    id: Date.now(),
                    text: `‚ú¶ ${settings.myName} ${text} ‚ú¶`, 
                    timestamp: new Date(),
                    type: 'system' 
                });
                picker.classList.remove('active');
                
                setTimeout(simulateReply, 1500);
            };
            wrapper.appendChild(item);
        });

        contentArea.appendChild(wrapper);
    }
}
function renderComboMenu() {
    const content = document.getElementById('user-sticker-content');
    content.innerHTML = '';
    
    const tabBar = document.createElement('div');
    tabBar.style.cssText = 'display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--border-color);';
    tabBar.innerHTML = `
        <button class="combo-tab active" data-tab="emoji" style="flex:1; padding:8px; border:none; background:var(--accent-color); color:#fff; border-radius:8px; cursor:pointer;">
            üòä Ë°®ÊÉÖ
        </button>
        <button class="combo-tab" data-tab="poke" style="flex:1; padding:8px; border:none; background:var(--secondary-bg); color:var(--text-primary); border-radius:8px; cursor:pointer;">
            ‚ú® Êãç‰∏ÄÊãç
        </button>
    `;
    
    const contentArea = document.createElement('div');
    contentArea.id = 'combo-content-area';
    contentArea.style.cssText = 'padding:10px; max-height:240px; overflow-y:auto;';
    
    content.appendChild(tabBar);
    content.appendChild(contentArea);
    
    showEmojiTab();
    
    tabBar.querySelectorAll('.combo-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            tabBar.querySelectorAll('.combo-tab').forEach(b => {
                b.style.background = 'var(--secondary-bg)';
                b.style.color = 'var(--text-primary)';
                b.classList.remove('active');
            });
            btn.style.background = 'var(--accent-color)';
            btn.style.color = '#fff';
            btn.classList.add('active');
            
            if (btn.dataset.tab === 'emoji') {
                showEmojiTab();
            } else {
                showPokeTab();
            }
        });
    });
}

function showEmojiTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'grid';
    area.style.gridTemplateColumns = 'repeat(5, 1fr)';
    area.style.gap = '8px';
    
    CONSTANTS.REPLY_EMOJIS.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<span style="font-size:24px;">${emoji}</span>`;
        item.onclick = () => {
            const input = document.getElementById('message-input');
            input.value += emoji;
            document.getElementById('user-sticker-picker').classList.remove('active');
            input.focus();
        };
        area.appendChild(item);
    });

    stickerLibrary.forEach(src => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:6px;">`;
        item.onclick = () => {
            addMessage({
                id: Date.now(),
                sender: 'user',
                text: '',
                timestamp: new Date(),
                image: src,
                status: 'sent',
                type: 'normal'
            });
            playSound('send');
            document.getElementById('user-sticker-picker').classList.remove('active');
            
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(item);
    });
}

function showPokeTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'flex';
    area.style.flexDirection = 'column';
    area.style.gap = '8px';
    
    const quickPokes = customPokes.slice(0, 6);
    
    quickPokes.forEach(pokeText => {
        const btn = document.createElement('button');
        btn.textContent = pokeText;
        btn.style.cssText = `
            padding: 10px 14px;
            background: linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.04));
            border: 1px solid rgba(var(--accent-color-rgb),0.15);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            transition: all 0.22s cubic-bezier(0.4,0,0.2,1);
            color: var(--text-primary);
            font-family: var(--font-family);
            width: 100%;
        `;
        btn.addEventListener('mouseover', () => {
            btn.style.background = 'linear-gradient(135deg, rgba(var(--accent-color-rgb),0.12), rgba(var(--accent-color-rgb),0.06))';
            btn.style.borderColor = 'var(--accent-color)';
            btn.style.transform = 'translateX(4px)';
        });
        btn.addEventListener('mouseout', () => {
            btn.style.background = 'linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.04))';
            btn.style.borderColor = 'rgba(var(--accent-color-rgb),0.15)';
            btn.style.transform = '';
        });
        btn.onclick = () => {
            addMessage({
                id: Date.now(), 
                text: `‚ú¶ ${settings.myName} ${pokeText} ‚ú¶`, 
                timestamp: new Date(), 
                type: 'system'
            });
            document.getElementById('user-sticker-picker').classList.remove('active');
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(btn);
    });
    
    const customBtn = document.createElement('button');
    customBtn.innerHTML = '<i class="fas fa-edit"></i> Ëá™ÂÆö‰πâÊãç‰∏ÄÊãç';
    customBtn.style.cssText = `
        padding: 11px 14px;
        background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.8));
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        width: 100%;
        letter-spacing: 0.3px;
        margin-top: 4px;
        box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
    `;
    customBtn.onclick = () => {
        document.getElementById('user-sticker-picker').classList.remove('active');
        showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
    };
    area.appendChild(customBtn);
}
        function initCoreListeners() {


            DOMElements.chatContainer.addEventListener('scroll', () => {
                const container = DOMElements.chatContainer;


                if (container.scrollTop < 50 && !isLoadingHistory && messages.length > displayedMessageCount) {
                    isLoadingHistory = true;


                    const loader = document.getElementById('history-loader');
                    if (loader) loader.classList.add('visible');


                    setTimeout(() => {

                        displayedMessageCount += HISTORY_BATCH_SIZE;


                        renderMessages(true);


                        if (loader) loader.classList.remove('visible');
                        isLoadingHistory = false;
                    },
                        600);
                }
            });

            DOMElements.sendBtn.addEventListener('click', () => isBatchMode ? addToBatch(): sendMessage());
            DOMElements.messageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); isBatchMode ? addToBatch(): sendMessage();
                }
            });
            DOMElements.messageInput.addEventListener('input', () => {
                DOMElements.messageInput.style.height = 'auto'; DOMElements.messageInput.style.height = `${Math.min(DOMElements.messageInput.scrollHeight, 120)}px`;
            });


            DOMElements.attachmentBtn.addEventListener('click', () => {

                const modal = document.createElement('div');
                modal.className = 'modal image-upload-modal';
                modal.style.cssText = `
            display: flex !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            `;

                modal.innerHTML = `
            <div class="modal-content" style="
            z-index: 10000;
            position: relative;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            ">
            <div class="modal-title"><i class="fas fa-image"></i><span>ÂèëÈÄÅÂõæÁâá</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary upload-mode-btn active" id="upload-image-file-btn" style="flex: 1;">ÈÄâÊã©Êñá‰ª∂</button>
            <button class="modal-btn modal-btn-secondary upload-mode-btn" id="paste-image-url-btn" style="flex: 1;">Á≤òË¥¥URL</button>
            </div>
            <input type="file" class="modal-input" id="image-file-input" accept="image/*">
            <input type="text" class="modal-input" id="image-url-input" placeholder="ËæìÂÖ•ÂõæÁâáURLÂú∞ÂùÄ" style="display: none;">
            <div id="image-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-image">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-primary" id="send-image" disabled>ÂèëÈÄÅ</button>
            </div>
            </div>
            `;

                document.body.appendChild(modal);


                setTimeout(() => {
                    modal.style.opacity = '1';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);

                const fileInput = document.getElementById('image-file-input');
                const urlInput = document.getElementById('image-url-input');
                const uploadBtn = document.getElementById('upload-image-file-btn');
                const pasteUrlBtn = document.getElementById('paste-image-url-btn');
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-chat-image');
                const sendBtn = document.getElementById('send-image');
                const cancelBtn = document.getElementById('cancel-image');
                const uploadModeBtns = document.querySelectorAll('.upload-mode-btn');

                let currentImageData = null;


                function switchUploadMode(isFileMode) {
                    uploadModeBtns.forEach(btn => btn.classList.remove('active'));
                    if (isFileMode) {
                        uploadBtn.classList.add('active');
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        pasteUrlBtn.classList.add('active');
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                        urlInput.focus();
                    }

                    previewDiv.style.display = 'none';
                    sendBtn.disabled = true;
                    currentImageData = null;
                }


                uploadBtn.addEventListener('click', () => switchUploadMode(true));


                pasteUrlBtn.addEventListener('click', () => switchUploadMode(false));


                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_IMAGE_SIZE) {
                            showNotification('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá5MB', 'error');
                            return;
                        }
                        showNotification('Ê≠£Âú®‰ºòÂåñÂõæÁâá...', 'info', 1500);
                        optimizeImage(file).then(optimizedData => {
                            currentImageData = optimizedData;
                            previewImg.src = currentImageData;
                            previewDiv.style.display = 'block';
                            sendBtn.disabled = false;
                        }).catch(() => {
                            showNotification('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•', 'error');
                        });
                    }
                });


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|bmp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentImageData = url;
                                sendBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                    showNotification('ÂõæÁâáURLÊúâÊïà', 'success', 1000);
                                };
                                img.onerror = function() {
                                    showNotification('ÂõæÁâáURLÊó†ÊïàÊàñÊó†Ê≥ïËÆøÈóÆ', 'error');
                                    sendBtn.disabled = true;
                                    previewDiv.style.display = 'none';
                                };
                                img.src = url;
                            } else {
                                sendBtn.disabled = true;
                                previewDiv.style.display = 'none';
                            }
                        } else {
                            sendBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                sendBtn.addEventListener('click',
                    () => {
                        if (currentImageData) {

                            addMessage({
                                id: Date.now(),
                                sender: 'user',
                                text: '',
                                timestamp: new Date(),
                                image: currentImageData,
                                status: 'sent',
                                favorited: false,
                                note: null,
                                replyTo: currentReplyTo,
                                type: 'normal'
                            });
                            playSound('send');
                            currentReplyTo = null;
                            updateReplyPreview();
                            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                            setTimeout(simulateReply, randomDelay);


                            closeModal();
                        }
                    });


                cancelBtn.addEventListener('click',
                    closeModal);


                function closeModal() {
                    modal.style.opacity = '0';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    },
                        300);
                }


                modal.addEventListener('click',
                    (e) => {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });


                modal.querySelector('.modal-content').addEventListener('click',
                    (e) => {
                        e.stopPropagation();
                    });


                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);


                modal.addEventListener('close', () => {
                    document.removeEventListener('keydown', handleEscKey);
                });
            });


            DOMElements.imageInput.addEventListener('change', () => {
                if (DOMElements.imageInput.files[0]) {
                    if (isBatchMode) {
                        showNotification('ÊâπÈáèÊ®°Âºè‰∏çÊîØÊåÅÂõæÁâá', 'warning');
                        DOMElements.imageInput.value = '';
                    } else {
                        sendMessage();
                    }
                }
            });

            DOMElements.continueBtn.addEventListener('click', simulateReply);
            DOMElements.batchBtn.addEventListener('click', toggleBatchMode);
        }

function initChatActionListeners() {
            DOMElements.chatContainer.addEventListener('click', (e) => {

                if (isBatchFavoriteMode) {
                    const wrapper = e.target.closest('.message-wrapper');
                    if (wrapper && !e.target.closest('.message-meta-actions')) {
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);

                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            wrapper.classList.remove('selected');
                        } else {
                            selectedMessages.push(messageId);
                            wrapper.classList.add('selected');
                        }

                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `Á°ÆËÆ§Êî∂Ëóè (${selectedMessages.length})`;
                        }
                        return;
                    }
                }

                const favoriteBtn = e.target.closest('.favorite-action-btn'); 
                if (favoriteBtn) {
                    const wrapper = e.target.closest('.message-wrapper');
                    const messageId = Number(wrapper.dataset.id);
                    const message = messages.find(m => m.id === messageId);
                    
                    if (message) {
                        message.favorited = !message.favorited;
                        
                        showNotification(message.favorited ? 'Â∑≤Êî∂Ëóè': 'Â∑≤ÂèñÊ∂àÊî∂Ëóè', 'success', 1500);
                        playSound('favorite');
                        
                        throttledSaveData();
                        
                        renderMessages(true);
                    }
                    return;
                }

                const target = e.target.closest('.meta-action-btn');
                if (!target) return;
                
                const wrapper = e.target.closest('.message-wrapper');
                if (!wrapper) return; 
                
                const messageId = Number(wrapper.dataset.id);
                const message = messages.find(m => m.id === messageId);
                if (!message) return;

if (target.classList.contains('delete-btn')) {
    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Ê∂àÊÅØÂêóÔºü')) {
        const index = messages.findIndex(m => m.id === messageId);
        if (index > -1) {
            const savedScrollTop = DOMElements.chatContainer.scrollTop;
            messages.splice(index, 1); 
            throttledSaveData(); 
            renderMessages(true);
            requestAnimationFrame(() => {
                DOMElements.chatContainer.scrollTop = savedScrollTop;
            });
            showNotification('Ê∂àÊÅØÂ∑≤Âà†Èô§', 'success');
        }
    }
    return;
}
                if (target.classList.contains('reply-btn')) {
                    currentReplyTo = {
                        id: message.id,
                        sender: message.sender,
                        text: message.text
                    };
                    updateReplyPreview();
                    DOMElements.messageInput.focus();
                    const targetMessageElement = DOMElements.chatContainer.querySelector(`[data-id="${message.id}"]`);
                    if (targetMessageElement) targetMessageElement.scrollIntoView({
                        behavior: 'smooth', block: 'center'
                    });
                    return;
                } 
                else if (target.classList.contains('note-btn')) {
                    currentNoteMessageId = messageId;
                    DOMElements.noteModal.input.value = message.note || '';
                    showModal(DOMElements.noteModal.modal, DOMElements.noteModal.input);
                    return;
                }

                throttledSaveData();
            });

            DOMElements.batchPreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.batch-preview-remove');
                if (removeBtn) {
                    const index = removeBtn.closest('.batch-preview-item').dataset.index;
                    batchMessages.splice(index, 1); updateBatchPreview();
                }
                const sendBtn = e.target.closest('.batch-send-btn');
                if (sendBtn && !sendBtn.disabled) sendBatchMessages();
                if (e.target.matches('.batch-cancel-btn')) {
                    isBatchMode = false; DOMElements.batchBtn.classList.remove('active');
                    DOMElements.batchPreview.style.display = 'none';
                    const placeholder = getRandomItem(CONSTANTS.INPUT_PLACEHOLDERS);
                    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
                    batchMessages = [];
                }
            });
        }
        function initModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const cancelBtns = modal.querySelectorAll('.modal-buttons .modal-btn-secondary');
                cancelBtns.forEach(cancelBtn => {
                    if (!cancelBtn.getAttribute('onclick') && !cancelBtn.dataset.noAutoClose) {
                        cancelBtn.addEventListener('click', () => hideModal(modal));
                    }
                });
            });

            DOMElements.editModal.input.addEventListener('input', () => {
                DOMElements.editModal.save.disabled = !DOMElements.editModal.input.value.trim();
            });
            DOMElements.noteModal.save.addEventListener('click', () => {
                const message = messages.find(m => m.id === currentNoteMessageId);
                if (message) {
                    message.note = DOMElements.noteModal.input.value.trim() || null;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('Ê≥®ÈáäÂ∑≤‰øùÂ≠ò', 'success');
                }
                hideModal(DOMElements.noteModal.modal);
            });

            DOMElements.pokeModal.save.addEventListener('click', () => {
                let pokeText = DOMElements.pokeModal.input.value.trim() || `${settings.myName} Êãç‰∫ÜÊãç ${settings.partnerName}`;
                addMessage({
                    id: Date.now(), text: `‚ú¶ ${pokeText} ‚ú¶`, timestamp: new Date(), type: 'system'
                });
                hideModal(DOMElements.pokeModal.modal);
                DOMElements.pokeModal.input.value = '';
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            });


            DOMElements.cancelCoinResult.addEventListener('click', () => {
                DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                lastCoinResult = null;
            });


            DOMElements.sendCoinResult.addEventListener('click', () => {
                if (lastCoinResult) {
                    sendMessage(`üé≤ ÊäõÁ°¨Â∏ÅÁªìÊûúÔºö${lastCoinResult}`, 'normal');
                    DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                    lastCoinResult = null;
                }
            });


            const retryBtn = document.getElementById('retry-coin-toss');

            if (retryBtn) {
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();

                    startCoinFlipAnimation();
                });
            }
        }

        function initHeaderAndSettingsListeners() {

            const openNameModal = (isPartner) => {
                const modal = DOMElements.editModal;
                showModal(modal.modal, modal.input);
                modal.title.textContent = `‰øÆÊîπ${isPartner ? (settings.partnerName || 'ÂØπÊñπ'): 'Êàë'}ÁöÑÊòµÁß∞`;
                modal.input.value = isPartner ? settings.partnerName: settings.myName;
                modal.save.disabled = !modal.input.value.trim();
                modal.save.onclick = () => {
                    const newName = modal.input.value.trim();
                    if (newName) {
                        isPartner ? settings.partnerName = newName: settings.myName = newName;
                        throttledSaveData();
                        updateUI();
                        showNotification('ÊòµÁß∞Â∑≤Êõ¥Êñ∞', 'success');
                    }
                    hideModal(modal.modal);
                };
            };

            const openAvatarModal = (isPartner) => {
                const modal = DOMElements.avatarModal;

                modal.modal.querySelector('.modal-content').innerHTML = `
            <div class="modal-title"><i class="fas fa-portrait"></i><span>‰∏ä‰º†${isPartner ? 'ÂØπÊñπ': 'Êàë'}ÁöÑÂ§¥ÂÉè</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary" id="upload-file-btn" style="flex: 1;">ÈÄâÊã©Êñá‰ª∂</button>
            <button class="modal-btn modal-btn-secondary" id="paste-url-btn" style="flex: 1;">Á≤òË¥¥URL</button>
            </div>
            <input type="file" class="modal-input" id="avatar-file-input" accept="image/*" style="display: none;">
            <input type="text" class="modal-input" id="avatar-url-input" placeholder="ËæìÂÖ•ÂõæÁâáURLÂú∞ÂùÄ" style="display: none;">
            <div id="avatar-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-avatar">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-primary" id="save-avatar" disabled>‰øùÂ≠ò</button>
            </div>
            `;

                showModal(modal.modal);

                const fileInput = document.getElementById('avatar-file-input');
                const urlInput = document.getElementById('avatar-url-input');
                const uploadBtn = document.getElementById('upload-file-btn');
                const pasteUrlBtn = document.getElementById('paste-url-btn');
                const previewDiv = document.getElementById('avatar-preview');
                const previewImg = document.getElementById('preview-image');
                const saveBtn = document.getElementById('save-avatar');
                const cancelBtn = document.getElementById('cancel-avatar');

                let currentAvatarData = null;


                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                    urlInput.style.display = 'none';
                    uploadBtn.classList.add('active');
                    pasteUrlBtn.classList.remove('active');
                });


                pasteUrlBtn.addEventListener('click', () => {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    pasteUrlBtn.classList.add('active');
                    uploadBtn.classList.remove('active');
                    urlInput.focus();
                });



fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > MAX_AVATAR_SIZE) {
            showNotification('Â§¥ÂÉèÂõæÁâá‰∏çËÉΩË∂ÖËøá2MB', 'error');
            return;
        }

        showNotification('Ê≠£Âú®Ë£ÅÂâ™Â§ÑÁêÜ...', 'info', 1000);
        
        cropImageToSquare(file, 300).then(base64Data => {
            currentAvatarData = base64Data;
            previewImg.src = currentAvatarData;
            previewDiv.style.display = 'block';
            saveBtn.disabled = false;
        }).catch(err => {
            console.error(err);
            showNotification('ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•', 'error');
        });
    }
});


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentAvatarData = url;
                                saveBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                };
                                img.onerror = function() {
                                    showNotification('ÂõæÁâáURLÊó†ÊïàÊàñÊó†Ê≥ïËÆøÈóÆ', 'error');
                                    saveBtn.disabled = true;
                                };
                                img.src = url;
                            } else {
                                saveBtn.disabled = true;
                            }
                        } else {
                            saveBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                saveBtn.addEventListener('click',
                    () => {
                        if (currentAvatarData) {
                            updateAvatar(isPartner ? DOMElements.partner.avatar: DOMElements.me.avatar, currentAvatarData);
                            throttledSaveData();
                            showNotification('Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞', 'success');
                            hideModal(modal.modal);
                        }
                    });


                cancelBtn.addEventListener('click',
                    () => {
                        hideModal(modal.modal);
                    });
            };

            DOMElements.partner.name.addEventListener('click', () => openNameModal(true));
            DOMElements.me.name.addEventListener('click', () => openNameModal(false));
            DOMElements.partner.avatar.addEventListener('click', () => openAvatarModal(true));
            DOMElements.me.avatar.addEventListener('click', () => openAvatarModal(false));

            DOMElements.me.statusContainer.addEventListener('click', () => {
                const statusTextElement = DOMElements.me.statusText; const statusContainer = DOMElements.me.statusContainer;
                if (statusContainer.querySelector('input')) return;
                const input = document.createElement('input'); input.type = 'text'; input.id = 'my-status-input'; input.value = statusTextElement.textContent;
                const saveStatus = () => {
                    const newStatus = input.value.trim();
                    if (newStatus) {
                        settings.myStatus = newStatus; showNotification('Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', 'success');
                    } else {
                        settings.myStatus = "Âú®Á∫ø";
                    }
                    statusTextElement.textContent = settings.myStatus;
                    statusContainer.innerHTML = '';
                    statusContainer.appendChild(statusTextElement);
                    throttledSaveData();
                };
                input.addEventListener('blur', saveStatus);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });
                statusContainer.innerHTML = ''; statusContainer.appendChild(input); input.focus();
            });

            DOMElements.themeToggle.addEventListener('click', () => {
                settings.isDarkMode = !settings.isDarkMode; throttledSaveData(); updateUI(); showNotification(`Â∑≤ÂàáÊç¢Âà∞${settings.isDarkMode ? 'Â§ú': 'Êòº'}Ê®°Âºè`,
                    'success');
            });
            DOMElements.settingsModal.settingsBtn.addEventListener('click', () => {
                showModal(DOMElements.settingsModal.modal);
            });
            DOMElements.favoritesModal.favoritesBtn.addEventListener('click', () => {
                showModal(document.getElementById('group-chat-modal'));
            });


document.getElementById('chat-settings').addEventListener('click', () => {
    hideModal(DOMElements.settingsModal.modal);
    
    const toggleSyncMap = {
        '#reply-toggle': { prop: 'replyEnabled', name: 'ÂºïÁî®ÂõûÂ§ç' },
        '#sound-toggle': { prop: 'soundEnabled', name: 'Èü≥Êïà' },
        '#read-receipts-toggle': { prop: 'readReceiptsEnabled', name: 'Â∑≤ËØªÂõûÊâß' },
        '#typing-indicator-toggle': { prop: 'typingIndicatorEnabled', name: 'Ê≠£Âú®ËæìÂÖ•' },
        '#read-no-reply-toggle': { prop: 'allowReadNoReply', name: 'Â∑≤ËØª‰∏çÂõû' }
    };
    for (const [selector, { prop }] of Object.entries(toggleSyncMap)) {
        const el = document.querySelector(selector);
        if (el) el.classList.toggle('active', !!settings[prop]);
    }
    const svSlider = document.getElementById('sound-volume-slider');
    const svVal = document.getElementById('sound-volume-value');
    if (svSlider) { svSlider.value = Math.round((settings.soundVolume || 0.15) * 100); if (svVal) svVal.textContent = svSlider.value + '%'; }
    const csi = document.getElementById('custom-sound-url-input');
    if (csi) csi.value = settings.customSoundUrl || '';
    document.querySelectorAll('.time-fmt-opt').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.fmt === (settings.timeFormat || 'HH:mm'));
    });
    // Update auto-send pill state
    const autoToggle = document.getElementById('auto-send-toggle');
    if (autoToggle) autoToggle.classList.toggle('active', !!settings.autoSendEnabled);
    updateAutoSendUI();
    updateDelayUI();
    // Sync immersive toggle
    const immToggle = document.getElementById('immersive-toggle');
    if (immToggle) immToggle.classList.toggle('active', document.body.classList.contains('immersive-mode'));
    
    showModal(DOMElements.chatModal.modal);
    setupAvatarFrameSettings();
});
            document.getElementById('advanced-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.advancedModal.modal);
            });

            document.getElementById('data-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.dataModal.modal);
            });


            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click',
                    () => {
                        settings.colorTheme = btn.dataset.theme;
                        throttledSaveData();
                        updateUI();
                        showNotification(`‰∏ªÈ¢òÈ¢úËâ≤Â∑≤ÂàáÊç¢`, 'success');
                    });
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click',
                    () => {
                        settings.bubbleStyle = item.dataset.bubbleStyle;
                        throttledSaveData();
                        updateUI();
                        showNotification(`Ê∞îÊ≥°Ê†∑ÂºèÂ∑≤ÂàáÊç¢‰∏∫${getBubbleStyleName(settings.bubbleStyle)}`, 'success');
                    });
            });

            const fontUrlInput = document.getElementById('custom-font-url');
            const applyFontBtn = document.getElementById('apply-font-btn');
            
            if (fontUrlInput) fontUrlInput.value = settings.customFontUrl || "";

            if (applyFontBtn) {
                applyFontBtn.addEventListener('click', () => {
                    const url = fontUrlInput.value.trim();
                    settings.customFontUrl = url;
                    
                    showNotification('Ê≠£Âú®Â∞ùËØïÂä†ËΩΩÂ≠ó‰Ωì...', 'info', 1000);
                    applyCustomFont(url).then(() => {
                        throttledSaveData();
                        if(url) showNotification('Â≠ó‰ΩìÂ∑≤Â∫îÁî®', 'success');
                        else showNotification('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì', 'success');
                    });
                });
            }

            
            const followSystemBtn = document.getElementById('follow-system-font-btn');
            if (followSystemBtn) {
                followSystemBtn.addEventListener('click', () => {
                    
                    const systemFontStack = 'system-ui, -apple-system, sans-serif';
                    
                    
                    if (fontUrlInput) fontUrlInput.value = "";
                    
                    
                    settings.customFontUrl = "";
                    
                    
                    settings.messageFontFamily = systemFontStack;
                    
                    
                    document.documentElement.style.setProperty('--font-family', systemFontStack);
                    document.documentElement.style.setProperty('--message-font-family', systemFontStack);
                    
                    
                    throttledSaveData();
                    
                    
                    renderMessages(true);
                    
                    showNotification('Â∑≤Â∫îÁî®Ë∑üÈöèÁ≥ªÁªüÂ≠ó‰Ωì', 'success');
                });
            }
            
            const cssTextarea = document.getElementById('custom-bubble-css');
            const applyCssBtn = document.getElementById('apply-css-btn');
            const resetCssBtn = document.getElementById('reset-css-btn');

            if (cssTextarea) cssTextarea.value = settings.customBubbleCss || "";

            function updateCssLivePreview() {
                const previewStyle = document.getElementById('css-live-preview-style');
                if (!previewStyle) return;
                const raw = (cssTextarea ? cssTextarea.value : '') || '';
                const scoped = raw.replace(/([^{}]+)\{/g, (match, selector) => {
                    const parts = selector.split(',').map(s => `#css-live-preview ${s.trim()}`);
                    return parts.join(', ') + ' {';
                });
                previewStyle.textContent = scoped;
            }

            if (cssTextarea) {
                cssTextarea.addEventListener('input', updateCssLivePreview);
                updateCssLivePreview();
            }

            if (applyCssBtn) {
                applyCssBtn.addEventListener('click', () => {
                    const css = cssTextarea.value;
                    settings.customBubbleCss = css;
                    applyCustomBubbleCss(css);
                    throttledSaveData();
                    showNotification('Ëá™ÂÆö‰πâÊ†∑ÂºèÂ∑≤Â∫îÁî®', 'success');
                });
            }

            if (resetCssBtn) {
                resetCssBtn.addEventListener('click', () => {
                    cssTextarea.value = "";
                    settings.customBubbleCss = "";
                    applyCustomBubbleCss("");
                    if (document.getElementById('css-live-preview-style')) document.getElementById('css-live-preview-style').textContent = '';
                    throttledSaveData();
                    showNotification('Ëá™ÂÆö‰πâÊ†∑ÂºèÂ∑≤Ê∏ÖÈô§', 'success');
                });
            }

            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');

            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = `${settings.fontSize}px`;

            fontSizeSlider.addEventListener('input', (e) => {
                settings.fontSize = parseInt(e.target.value);
                document.documentElement.style.setProperty('--font-size',
                    `${settings.fontSize}px`);
                fontSizeValue.textContent = `${settings.fontSize}px`;
            });

            fontSizeSlider.addEventListener('change', throttledSaveData);

            const avatarToggle = document.getElementById('in-chat-avatar-toggle-2');
            const avatarSizeControl = document.getElementById('in-chat-avatar-size-control-2');
            const avatarPositionControl = document.getElementById('in-chat-avatar-position-control-2');
            const avatarPreview = document.getElementById('avatar-bubble-preview');
            const avatarSizeSlider = document.getElementById('in-chat-avatar-size-slider-2');
            const avatarSizeValue = document.getElementById('in-chat-avatar-size-value-2');

            if (!settings.inChatAvatarPosition) settings.inChatAvatarPosition = 'center';

            function updateAvatarPreview() {
                if (!avatarPreview) return;
                const previewPartner = document.getElementById('preview-partner-avatar');
                const previewMe = document.getElementById('preview-my-avatar');
                const sz = `${settings.inChatAvatarSize}px`;
                if (previewPartner) {
                    previewPartner.style.width = sz;
                    previewPartner.style.height = sz;
                    const partnerImg = DOMElements.partner.avatar.querySelector('img');
                    if (partnerImg && partnerImg.src) {
                        previewPartner.innerHTML = `<img src="${partnerImg.src}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    }
                }
                if (previewMe) {
                    previewMe.style.width = sz;
                    previewMe.style.height = sz;
                    const myImg = DOMElements.me.avatar.querySelector('img');
                    if (myImg && myImg.src) {
                        previewMe.innerHTML = `<img src="${myImg.src}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                    }
                }
                updateBubblePreview();
            }

            function updateBubblePreview() {
                const receivedBubble = document.getElementById('preview-bubble-received');
                const sentBubble = document.getElementById('preview-bubble-sent');
                if (!receivedBubble || !sentBubble) return;
                const style = settings.bubbleStyle || 'standard';
                const accentRgb = getComputedStyle(document.documentElement).getPropertyValue('--accent-color-rgb').trim() || '100,150,255';
                const styleMap = {
                    'standard':      { recv: '16px 16px 16px 4px',  sent: '16px 16px 4px 16px',  recvShadow: '0 2px 10px rgba(0,0,0,0.08)', sentShadow: `0 3px 12px rgba(${accentRgb},0.22)` },
                    'rounded':       { recv: '18px 18px 18px 6px',  sent: '18px 18px 6px 18px',  recvShadow: '0 2px 10px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.04)', sentShadow: `0 3px 12px rgba(${accentRgb},0.25), 0 1px 3px rgba(${accentRgb},0.1)` },
                    'rounded-large': { recv: '24px 24px 24px 4px',  sent: '24px 24px 4px 24px',  recvShadow: '0 4px 16px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.05)', sentShadow: `0 4px 16px rgba(${accentRgb},0.28), 0 2px 4px rgba(${accentRgb},0.12)` },
                    'square':        { recv: '4px 4px 4px 0',       sent: '4px 4px 0 4px',       recvShadow: '0 3px 10px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04)', sentShadow: `0 3px 10px rgba(${accentRgb},0.2), 0 1px 2px rgba(${accentRgb},0.08)` }
                };
                const radii = styleMap[style] || styleMap['standard'];
                receivedBubble.style.borderRadius = radii.recv;
                receivedBubble.style.boxShadow = radii.recvShadow;
                sentBubble.style.borderRadius = radii.sent;
                sentBubble.style.boxShadow = radii.sentShadow;
                const recvBg = getComputedStyle(document.documentElement).getPropertyValue('--message-received-bg').trim();
                const recvText = getComputedStyle(document.documentElement).getPropertyValue('--message-received-text').trim();
                const sentBg = getComputedStyle(document.documentElement).getPropertyValue('--message-sent-bg').trim();
                const sentText = getComputedStyle(document.documentElement).getPropertyValue('--message-sent-text').trim();
                if (recvBg) receivedBubble.style.background = recvBg;
                if (recvText) receivedBubble.style.color = recvText;
                if (sentBg) sentBubble.style.background = sentBg;
                if (sentText) sentBubble.style.color = sentText;
                receivedBubble.style.fontFamily = settings.messageFontFamily || '';
                sentBubble.style.fontFamily = settings.messageFontFamily || '';
                receivedBubble.style.fontSize = (settings.fontSize || 16) + 'px';
                sentBubble.style.fontSize = (settings.fontSize || 16) + 'px';
                const customCss = (document.getElementById('custom-bubble-css') || {}).value || '';
                let previewStyle = document.getElementById('bubble-preview-custom-style');
                if (!previewStyle) {
                    previewStyle = document.createElement('style');
                    previewStyle.id = 'bubble-preview-custom-style';
                    document.head.appendChild(previewStyle);
                }
                previewStyle.textContent = customCss;
            }

            function updateAvatarSettingsUI() {
                const enabled = settings.inChatAvatarEnabled;
                const pill = document.getElementById('avatar-toggle-pill-2');
                const knob = document.getElementById('avatar-toggle-knob-2');
                const statusText = document.getElementById('avatar-toggle-status-2');
                if (pill) pill.style.background = enabled ? 'var(--accent-color)' : 'var(--border-color)';
                if (knob) knob.style.right = enabled ? '3px' : '23px';
                if (statusText) statusText.textContent = enabled ? 'Â∑≤ÂºÄÂêØ ‚Äî Ê∂àÊÅØÊóÅÊòæÁ§∫Â§¥ÂÉè' : 'Â∑≤ÂÖ≥Èó≠';

                if (avatarSizeControl) avatarSizeControl.style.display = enabled ? 'flex' : 'none';
                if (avatarPositionControl) avatarPositionControl.style.display = enabled ? 'block' : 'none';
                if (avatarPreview) avatarPreview.style.display = enabled ? 'block' : 'none';

                if (avatarSizeSlider) avatarSizeSlider.value = settings.inChatAvatarSize;
                if (avatarSizeValue) avatarSizeValue.textContent = `${settings.inChatAvatarSize}px`;
                document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);

                const pos = settings.inChatAvatarPosition || 'center';
                const alignMap = { 'top': 'flex-start', 'center': 'center', 'bottom': 'flex-end' };
                document.documentElement.style.setProperty('--avatar-align', alignMap[pos] || 'flex-start');
                document.querySelectorAll('.preview-msg-row').forEach(row => {
                    row.style.alignItems = alignMap[pos] || 'flex-start';
                });
                const topBtn = document.getElementById('avatar-pos-top-2');
                const centerBtn = document.getElementById('avatar-pos-center-2');
                const bottomBtn = document.getElementById('avatar-pos-bottom-2');
                [topBtn, centerBtn, bottomBtn].forEach(btn => {
                    if (!btn) return;
                    btn.className = btn.dataset.pos === pos ? 'modal-btn modal-btn-primary' : 'modal-btn modal-btn-secondary';
                    btn.style.flex = '1'; btn.style.fontSize = '12px'; btn.style.padding = '7px 0';
                });

                updateAvatarPreview();
            }
            updateAvatarSettingsUI();

            if (avatarToggle) {
                avatarToggle.addEventListener('click', () => {
                    settings.inChatAvatarEnabled = !settings.inChatAvatarEnabled;
                    updateAvatarSettingsUI();
                    renderMessages(true);
                    throttledSaveData();
                });
            }

            if (avatarSizeSlider) {
                avatarSizeSlider.addEventListener('input', (e) => {
                    settings.inChatAvatarSize = parseInt(e.target.value, 10);
                    updateAvatarSettingsUI();
                    renderMessages(true); 
                });
                avatarSizeSlider.addEventListener('change', throttledSaveData);
            }

            ['avatar-pos-top-2','avatar-pos-center-2','avatar-pos-bottom-2'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        settings.inChatAvatarPosition = btn.dataset.pos;
                        updateAvatarSettingsUI();
                        renderMessages(true);
                        throttledSaveData();
                    });
                }
            });

            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click', () => {
                    setTimeout(updateBubblePreview, 100);
                });
            });
            
            const minDelaySlider = document.getElementById('reply-delay-min-slider');
            const minDelayValue = document.getElementById('reply-delay-min-value');
            const maxDelaySlider = document.getElementById('reply-delay-max-slider');
            const maxDelayValue = document.getElementById('reply-delay-max-value');

            function updateDelayUI() {
                minDelaySlider.value = settings.replyDelayMin;
                const minSec = settings.replyDelayMin / 1000;
                minDelayValue.textContent = minSec >= 60 ? `${(minSec/60).toFixed(1)}ÂàÜÈíü` : `${minSec.toFixed(0)}s`;
                maxDelaySlider.value = settings.replyDelayMax;
                const maxSec = settings.replyDelayMax / 1000;
                maxDelayValue.textContent = maxSec >= 60 ? `${(maxSec/60).toFixed(1)}ÂàÜÈíü` : `${maxSec.toFixed(0)}s`;
                maxDelaySlider.min = settings.replyDelayMin; 
            }
            updateDelayUI();

            minDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMin = parseInt(e.target.value, 10);
                if (settings.replyDelayMin > settings.replyDelayMax) {
                    settings.replyDelayMax = settings.replyDelayMin;
                }
                updateDelayUI();
            });
            minDelaySlider.addEventListener('change', throttledSaveData);

            maxDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMax = parseInt(e.target.value, 10);
                 if (settings.replyDelayMax < settings.replyDelayMin) {
                    settings.replyDelayMin = settings.replyDelayMax;
                }
                updateDelayUI();
            });
            maxDelaySlider.addEventListener('change', throttledSaveData);

            const settingToggles = {
                '#reply-toggle': {
                    prop: 'replyEnabled', name: 'ÂºïÁî®ÂõûÂ§ç'
                },
                '#sound-toggle': {
                    prop: 'soundEnabled', name: 'Èü≥Êïà'
                },
                '#read-receipts-toggle': {
                    prop: 'readReceiptsEnabled', name: 'Â∑≤ËØªÂõûÊâß'
                },
                '#typing-indicator-toggle': {
                    prop: 'typingIndicatorEnabled', name: 'Ê≠£Âú®ËæìÂÖ•'},
                    '#read-no-reply-toggle': { prop: 'allowReadNoReply', name: 'Â∑≤ËØª‰∏çÂõû' }
};

            for (const [selector, {
                prop, name
            }] of Object.entries(settingToggles)) {
                const element = document.querySelector(selector);
                if (!element) continue;

                // Set initial pill state
                element.classList.toggle('active', !!settings[prop]);

                element.addEventListener('click', () => {
                    settings[prop] = !settings[prop];
                    throttledSaveData();
                    updateUI();
                    element.classList.toggle('active', !!settings[prop]);
                    if (prop !== 'soundEnabled') renderMessages(true);
                    showNotification(`${name}Â∑≤${settings[prop] ? 'ÂºÄÂêØ': 'ÂÖ≥Èó≠'}`, 'success');
                });
            }

            const soundVolSlider = document.getElementById('sound-volume-slider');
            const soundVolVal = document.getElementById('sound-volume-value');
            if (soundVolSlider) {
                soundVolSlider.value = Math.round((settings.soundVolume || 0.15) * 100);
                if (soundVolVal) soundVolVal.textContent = soundVolSlider.value + '%';
                soundVolSlider.addEventListener('input', (e) => {
                    settings.soundVolume = parseInt(e.target.value) / 100;
                    if (soundVolVal) soundVolVal.textContent = e.target.value + '%';
                });
                soundVolSlider.addEventListener('change', throttledSaveData);
            }
            const customSoundInput = document.getElementById('custom-sound-url-input');
            if (customSoundInput) {
                customSoundInput.value = settings.customSoundUrl || '';
                customSoundInput.addEventListener('change', () => {
                    settings.customSoundUrl = customSoundInput.value.trim();
                    throttledSaveData();
                });
            }
            const testSoundBtn = document.getElementById('test-sound-btn');
            if (testSoundBtn) {
                testSoundBtn.addEventListener('click', () => { playSound('message'); });
            }
            document.querySelectorAll('.time-fmt-opt').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.fmt === (settings.timeFormat || 'HH:mm'));
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.time-fmt-opt').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    settings.timeFormat = opt.dataset.fmt;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('Êó∂Èó¥Ê†ºÂºèÂ∑≤Êõ¥Êñ∞', 'success');
                });
            });


            document.getElementById('appearance-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                window.hideAppearancePanel && window.hideAppearancePanel();
                renderBackgroundGallery();
                renderThemeSchemesList();
                
                const fontSizeSliderEl = document.getElementById('font-size-slider');
                const fontSizeValueEl = document.getElementById('font-size-value');
                if (fontSizeSliderEl) {
                    fontSizeSliderEl.value = settings.fontSize;
                    if (fontSizeValueEl) fontSizeValueEl.textContent = `${settings.fontSize}px`;
                }
                const fontUrlInputEl = document.getElementById('custom-font-url');
                if (fontUrlInputEl) fontUrlInputEl.value = settings.customFontUrl || '';
                const cssTextareaEl = document.getElementById('custom-bubble-css');
                if (cssTextareaEl) cssTextareaEl.value = settings.customBubbleCss || '';
                
                document.querySelectorAll('[data-bubble-style]').forEach(item => {
                    item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
                });
                
                document.querySelectorAll('.theme-color-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
                });
                
                showModal(DOMElements.appearanceModal.modal);
                setTimeout(() => { 
                    updateAvatarSettingsUI && updateAvatarSettingsUI(); 
                    setupAppearancePanelFrameSettings && setupAppearancePanelFrameSettings();
                }, 100);
            });
            DOMElements.appearanceModal.closeBtn.addEventListener('click', () => {
                    hideModal(DOMElements.appearanceModal.modal);
                });

            const bgInput = document.getElementById('bg-gallery-input');
            if (bgInput) {
                bgInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (file.size > MAX_IMAGE_SIZE) {
                        showNotification('ËÉåÊôØÂõæÁâá‰∏çËÉΩË∂ÖËøá5MB', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;


                        savedBackgrounds.push({
                            id: `user-${Date.now()}`,
                            type: 'image',
                            value: base64
                        });


                        saveBackgroundGallery();
                        renderBackgroundGallery();


                        applyBackground(base64);
                        localforage.setItem(getStorageKey('chatBackground'), base64);
                        showNotification('Êñ∞ËÉåÊôØÂ∑≤Ê∑ªÂä†Âπ∂Â∫îÁî®', 'success');
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                });
            }

const autoSendToggle = document.getElementById('auto-send-toggle');
const autoSendControl = document.getElementById('auto-send-control');
const autoSendSlider = document.getElementById('auto-send-slider');
const autoSendValue = document.getElementById('auto-send-value');

const updateAutoSendUI = () => {
    autoSendToggle.classList.toggle('active', !!settings.autoSendEnabled);
    autoSendControl.style.display = settings.autoSendEnabled ? "flex" : "none";
    const currentVal = settings.autoSendInterval || 5;
    autoSendSlider.value = currentVal;
    autoSendValue.textContent = `${currentVal}ÂàÜÈíü`;
};

updateAutoSendUI();

autoSendToggle.addEventListener('click', () => {
    settings.autoSendEnabled = !settings.autoSendEnabled;
    updateAutoSendUI();
    manageAutoSendTimer(); 
    throttledSaveData();
    showNotification(`‰∏ªÂä®ÂèëÈÄÅÂ∑≤${settings.autoSendEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`, 'success');
});

autoSendSlider.value = settings.autoSendInterval || 5;
autoSendValue.textContent = `${settings.autoSendInterval || 5}ÂàÜÈíü`;

autoSendSlider.addEventListener('input', (e) => {
    const val = parseInt(e.target.value);
    settings.autoSendInterval = val;
    autoSendValue.textContent = `${val}ÂàÜÈíü`;
});

autoSendSlider.addEventListener('change', () => {
    manageAutoSendTimer(); 
    throttledSaveData();
});

            const resetBgBtn = document.getElementById('reset-default-bg');
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', () => {
                    removeBackground();
                    renderBackgroundGallery();
                    showNotification('Â∑≤ÁßªÈô§ËÉåÊôØÂõæ', 'success');
                });
            }
        }


        function initNewFeatureListeners() {
            const flEntry = document.getElementById('fortune-lenormand-function');
            if (flEntry) {
                flEntry.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    generateFortune();
                    switchFLTab('fortune');
                    showModal(document.getElementById('fortune-lenormand-modal'));
                });
            }

            document.getElementById('close-lenormand').addEventListener('click', () => {
                hideModal(document.getElementById('fortune-lenormand-modal'));
            });
    const envelopeEntryBtn = document.getElementById('envelope-function');
    if (envelopeEntryBtn) {
        envelopeEntryBtn.addEventListener('click', async () => {
            hideModal(DOMElements.advancedModal.modal);
            await loadEnvelopeData();
            await checkEnvelopeStatus();
            currentEnvTab = 'outbox';
            document.getElementById('env-tab-outbox').classList.add('active');
            document.getElementById('env-tab-inbox').classList.remove('active');
            document.getElementById('env-outbox-section').style.display = 'block';
            document.getElementById('env-inbox-section').style.display = 'none';
            document.getElementById('env-compose-form').style.display = 'none';
            document.getElementById('env-main-close-btn').style.display = 'flex';
            renderEnvelopeLists();
            showModal(document.getElementById('envelope-modal'));
        });
    }
document.getElementById('send-envelope').addEventListener('click', handleSendEnvelope);

document.getElementById('cancel-envelope').addEventListener('click', () => {
    hideModal(document.getElementById('envelope-modal'));
});
            const shareFortuneBtnEl = document.getElementById('share-fortune');
            if (shareFortuneBtnEl) {
                shareFortuneBtnEl.addEventListener('click', () => {
                    const fortuneDescEl = document.querySelector('.fortune-desc');
                    if (!fortuneDescEl) return;
                    const fortuneText = fortuneDescEl.textContent;
                    const shareText = `ÊàëÁöÑ‰ªäÊó•ËøêÂäøÔºö${fortuneText}`;

                    if (navigator.share) {
                        navigator.share({
                            title: '‰ªäÊó•ËøêÂäø',
                            text: shareText
                        });
                    } else {
                        navigator.clipboard.writeText(shareText).then(() => {
                            showNotification('ËøêÂäøÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
                        });
                    }
                });
            }

            const closeFortune = document.getElementById('close-fortune');
            if (closeFortune) {
                closeFortune.addEventListener('click', () => {
                    hideModal(document.getElementById('fortune-lenormand-modal'));
                });
            }


            document.getElementById('batch-favorite-function').addEventListener('click', () => {
                hideModal(DOMElements.favoritesModal.modal);
                toggleBatchFavoriteMode();
            });

            initReplyLibraryListeners();


            
            DOMElements.anniversaryAnimation.closeBtn.addEventListener('click', () => {
                DOMElements.anniversaryAnimation.modal.classList.remove('active');
            });


            document.getElementById('stats-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderStatsContent();
                showModal(DOMElements.statsModal.modal);
            });

            const coinFunctionBtn = document.getElementById('coin-function');
            if (coinFunctionBtn) {
                coinFunctionBtn.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    handleCoinToss();
                });
            }
            const musicToggle = document.getElementById('music-player-toggle');
            musicToggle.addEventListener('click', () => {
                settings.musicPlayerEnabled = !settings.musicPlayerEnabled;
                throttledSaveData();

                const player = document.getElementById('player');
                if (settings.musicPlayerEnabled) {
                    player.classList.add('visible');
                    showNotification('Èü≥‰πêÊí≠ÊîæÂô®Â∑≤ÂºÄÂêØ', 'success');
                } else {
                    player.classList.remove('visible');
                    document.getElementById('playlist').classList.remove('active');
                    const audio = document.getElementById('audio');
                    if (audio) audio.pause();
                    showNotification('Èü≥‰πêÊí≠ÊîæÂô®Â∑≤ÂÖ≥Èó≠', 'info');
                }
                hideModal(DOMElements.advancedModal.modal);
            });
        }
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    const annFormWrapper = document.getElementById('ann-form-wrapper');

    if (annToggleBtn && annFormWrapper) {
        annToggleBtn.addEventListener('click', () => {
            const isActive = annFormWrapper.classList.contains('active');
            
            if (isActive) {
                annFormWrapper.classList.remove('active');
                annToggleBtn.classList.remove('active');
            } else {
                annFormWrapper.classList.add('active');
                annToggleBtn.classList.add('active');
                
                setTimeout(() => {
                    annFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        });
    }

        function getBubbleStyleName(style) {
            const names = {
                'standard': 'Ê†áÂáÜ',
                'rounded': 'ÂúÜËßí',
                'rounded-large': 'Â§ßÂúÜËßí',
                'square': 'ÊñπÂΩ¢'
            };
            return names[style] || 'Ê†áÂáÜ';
        }

        function initDataManagementListeners() {

            document.getElementById('export-chat').addEventListener('click', exportChatHistory);
            document.getElementById('import-chat').addEventListener('click', () => DOMElements.importInput.click());
            DOMElements.importInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importChatHistory(e.target.files[0]); e.target.value = '';
                }
            });


            document.getElementById('clear-chat').addEventListener('click', () => {
                if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâç‰ºöËØùÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç")) {
                    messages = [];
                    throttledSaveData();
                    renderMessages();
                    hideModal(DOMElements.dataModal.modal);
                    showNotification('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫', 'success');
                }
            });
            document.getElementById('clear-storage').addEventListener('click', clearAllAppData);
            const creditsBtn = document.getElementById('open-credits-btn');
            if (creditsBtn) {
                creditsBtn.addEventListener('click', () => {

                    hideModal(DOMElements.dataModal.modal);


                    const disclaimerModal = document.getElementById('disclaimer-modal');


                    if (disclaimerModal) {
                        showModal(disclaimerModal);
                    }
                });
            }

        }


        DOMElements.sessionModal.managerBtn.addEventListener('click', () => {
            renderSessionList(); showModal(DOMElements.sessionModal.modal);
        });
        DOMElements.sessionModal.createBtn.addEventListener('click', () => {
            const newId = createNewSession(false);

            renderSessionList();
            showNotification('Êñ∞‰ºöËØùÂ∑≤ÂàõÂª∫', 'success');
        });

        DOMElements.sessionModal.list.addEventListener('click', (e) => {
            const item = e.target.closest('.session-item');
            if (!item) return;
            const sessionId = item.dataset.id;

            if (e.target.closest('.rename')) {
                const session = sessionList.find(s => s.id === sessionId);
                const newName = prompt('ËæìÂÖ•Êñ∞ÁöÑ‰ºöËØùÂêçÁß∞:', session.name);
                if (newName && newName.trim()) {
                    session.name = newName.trim();
                    localforage.setItem(`${APP_PREFIX}sessionList`, sessionList); 
                    renderSessionList();
                    showNotification('‰ºöËØùÂ∑≤ÈáçÂëΩÂêç', 'success');
                }
            } else if (e.target.closest('.delete')) {
                if (sessionList.length <= 1) {
                    showNotification('Êó†Ê≥ïÂà†Èô§ÊúÄÂêé‰∏Ä‰∏™‰ºöËØù', 'warning');
                    return;
                }
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§‰ºöËØùÂèäÂÖ∂ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç')) {

                    const currentSessionId = SESSION_ID;

                    sessionList = sessionList.filter(s => s.id !== sessionId);
localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

Object.keys(localStorage).forEach(key => {
    if (key.startsWith(`${APP_PREFIX}${sessionId}_`)) safeRemoveItem(key);
});

if (sessionId === currentSessionId) {
    const newCurrentId = sessionList[0].id;
    localforage.setItem(`${APP_PREFIX}customThemes`, customThemes);
    window.location.hash = newCurrentId;
    window.location.reload();
} else {
    renderSessionList();
    showNotification('‰ºöËØùÂ∑≤Âà†Èô§', 'success');
}
                }
            } else {

                if (sessionId !== SESSION_ID) {
                    if (confirm('ÂàáÊç¢‰ºöËØùÂ∞ÜÂà∑Êñ∞È°µÈù¢ÔºåÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
                        window.location.hash = sessionId;
                        window.location.reload();
                    }
                }
            }
        });

        const initMusicPlayer = () => {
    const latestSystemSongs = [{
                title: "ËôöÊãü", sub: "‰Ω†ÊòØÊàëÊúùÂ§ïÁõ∏‰º¥Ëß¶ÊâãÂèØÂèäÁöÑËôöÊãü", url: "https://files.catbox.moe/6s65mp.mp3"
            },
                {
                    title: "Â§öËøúÈÉΩË¶ÅÂú®‰∏ÄËµ∑", sub: "Áà±ËÉΩÂÖãÊúçËøúË∑ùÁ¶ª", url: "https://files.catbox.moe/06k9ra.mp3"
                },
                {
                    title: "Ê∞∏‰∏çÂ§±ËÅîÁöÑÁà±", sub: "Ëøô‰∏ÄËæàÂ≠êÈÉΩ‰∏çÊÉ≥Â§±ËÅîÁöÑÁà±", url: "https://files.catbox.moe/uvucav.mp3"
                },
                {
                    title: "Á®≥Á®≥ÁöÑÂπ∏Á¶è", sub: "ËøôÊòØÊàëÊÉ≥Ë¶ÅÁöÑÂπ∏Á¶è", url: "https://files.catbox.moe/inb22a.mp3"
                },
                {
                    title: "ÊúâÊàëÂë¢", sub: "Êàë‰ºöËÆ©‰Ω†‰π†ÊÉØ Â§ö‰∏Ä‰∏™‰∫∫Èô™‰º¥", url: "https://files.catbox.moe/hrazjt"
                },
                {
                    title: "‰∏ÄÂçÉÈõ∂‰∏ÄÂ§ú", sub: "Ê¢¶ÈáåËÉΩÂà∞ËææÁöÑÂú∞ÊñπÂïä Êúâ‰∏ÄÂ§©ËÑöÊ≠•‰πüËÉΩÂà∞Ëææ", url: "https://files.catbox.moe/syfuon.mp3"
                },
                {
                    title: "Êúà‰∫Æ‰∏éÂÖ≠‰æøÂ£´", sub: "ÊàëÁöÑ‰∏ñÁïåÁî±‰Ω†Âª∫Á´ã Âõ†‰Ω†Â¥©Â°å", url: "https://files.catbox.moe/98quqc.mp3"
                },
                {
                    title: "Ê¨°ÂÖÉÊÅã‰∫∫", sub: "Á∫¶Â•Ω‰∫ÜÈöîÁùÄÊ¨°ÂÖÉ‰πüÂêª‰ΩèÊ≥™Áúº", url: "https://files.catbox.moe/5u5dy0.mp3"
                },
                {
                    title: "Èò≥ÂÖâ‰∏ãÁöÑÊòüÊòü", sub: "Â¶ÇÊûúÁà±‰∏ä‰Ω†Âè™ÊòØ‰∏Ä‰∏™Ê¢¶Â¢É", url: "https://files.catbox.moe/dxgqsk.mp3"
                },
                {
                    title: "Âë®Ëæπ", sub: "ÁÅµÈ≠ÇÈáåÁ©∫Áº∫ÁöÑÈÇ£ÊÆµ", url: "https://files.catbox.moe/a7k5wd.mp3"
                },
                {
                    title: "ÊÅãÁà±ing", sub: "ËÆ©ÊàëÈáçÊñ∞ËÆ§ËØÜL O V E", url: "https://files.catbox.moe/94slcd.mp3"
                },
                {
                    title: "‰∏ÄÁÇπ‰∏ÄÊª¥", sub: "‰Ω†ËÆ©Áà±‰∏ÄÁÇπ‰∏ÄÊª¥Ê±áÊàêÊ≤≥", url: "https://files.catbox.moe/958qzg.mp3"
                },
                {
                    title: "ÂÖ≥ÈîÆËØç", sub: "ËÆ©ÊàëËßÅËØÜÁà±ÊÉÖÂèØ‰ª•ÊÖ∑ÊÖ®ÂèàËá™ÁßÅ", url: "https://files.catbox.moe/9yl5ic.mp3"
                },
                {
                    title: "ÊÉ≥ËßÅ‰Ω†ÊÉ≥ËßÅ‰Ω†ÊÉ≥ËßÅ‰Ω†", sub: "Á©øË∂ä‰∫ÜÂçÉ‰∏™‰∏á‰∏™Êó∂Èó¥Á∫øÈáå‰∫∫Êµ∑ÈáåÁõ∏‰æù", url: "https://files.catbox.moe/co58d7.mp3"
                },
                {
                    title: "star crossing night", sub: "ËøôÈáåÊ≤°Êúâ‰Ω†", url: "https://files.catbox.moe/i3f86b.mp3"
                },
                {
                    title: "sea temple", sub: "If we have each other", url: "https://files.catbox.moe/c57gxs.mp3"
                },
                {
                    title: "ÊàëÊÉ≥Ë¶ÅÂç†ÊçÆ‰Ω†", sub: "Âç†ÊçÆ‰Ω†ÁöÑ‚ºÄÂàá‰∏îÊó†ÂèØÂéöÈùû", url: "https://files.catbox.moe/1fp6eg.mp3"
                },
                {
                    title: "ÁâπÂà´ÁöÑ‰∫∫", sub: "Êàë‰ª¨ÊòØÂØπÊñπÁâπÂà´ÁöÑ‰∫∫", url: "https://files.catbox.moe/a0n0l7.mp3"
                },
                {
                    title: "È∫¶ÊÅ©Ëéâ", sub: "Âú®ÂπøÈòîÂØÇÂØûÊº©Ê∂°Ëß£ËÑ±", url: "https://files.catbox.moe/2inae2.mp3"
                },
                {
                    title: "‰ºöÂëºÂê∏ÁöÑÁóõ", sub: "ÊÉ≥ÂøµÊòØ‰ºöÂëºÂê∏ÁöÑÁóõ", url: "https://files.catbox.moe/0uhmxr.mp3"
                },
                {
                    title: "‰∏ÄÁîüÁöÑÁà±", sub: "ÊàëÂè™ÊÉ≥Ë¶ÅÁªô‰Ω†Êàë‰∏ÄÁîüÁöÑÁà±", url: "https://files.catbox.moe/f0e93c.mp3"
                },
                {
                    title: "Ë∫´È™ëÁôΩÈ©¨", sub: "ËøΩËµ∂Ë¶ÅÊàëÁà±ÁöÑ‰∏ç‰øùÁïô", url: "https://files.catbox.moe/iywfe2.mp3"
                },
                {
                    title: "Áà±ÊÉÖËÆØÊÅØ", sub: "ÊÉ≥ÂøµÂèòÊàêÁ©∫Ê∞îÂú®ÂèπÊÅØ", url: "https://files.catbox.moe/4dl0t2.mp3"
                },
                {
                    title: "‰Ω†Âú® ‰∏çÂú®", sub: "‰Ω†Âú®ÊàëÂøÉÈáåÈù¢ Èô™ÊàëÂ§±Áú†", url: "https://files.catbox.moe/povyqa.mp3"
                },
                {
                    title: "‰Ω†ÊòØÊàëÁöÑÈ£éÊôØ", sub: "Áà±ËÆ©ÊÇ¨Â¥ñÂèòÂπ≥Âú∞", url: "https://files.catbox.moe/fnwtf8.mp3"
                },
                {
                    title: "life with u", sub: "Now I know that you're the one", url: "https://files.catbox.moe/zqfxvd.mp3"
                },
                {
                    title: "ÂãæÊåáËµ∑Ë™ì", sub: "‰Ω†ÊòØÁêÜÊâÄÂΩìÁÑ∂ÁöÑÂ•áËøπ", url: "https://files.catbox.moe/4spgo5.mp3"
                },
                {
                    title: "Áâµ‰∏ÄÂçä", sub: "‰Ω†ÁöÑÂ≠òÂú®ÊòØÊàëÂîØ‰∏Ä‰æùËµñ", url: "https://files.catbox.moe/bk21gu.mp3"
                },
                {
                    title: "rove", sub: "Oh we are in the War of Love on Rove", url: "https://files.catbox.moe/sfwsuk.mp3"
                },
                {
                    title: "ÂîØ‰∏Ä", sub: "ÊàëÁúüÁöÑÁà±‰Ω† Âè•Âè•‰∏çËΩªÊòì", url: "https://files.catbox.moe/69g4fe.mp3"
                },
            { title: "Ëá¥Áà± Your Song", sub: "ÊàëÂè™ÊÉ≥ÊØè‰∏™ËêΩÊó• Ë∫´ËæπÈÉΩÊúâ‰Ω†", url: "https://files.catbox.moe/01bmnf.mp3" },
            { title: "‰∏ÄÈ¶ñÊÉ≥‰∏çÈÄöÁöÑÂè§È£é", sub: "ÁîªÂú∞‰∏∫Áâ¢ ÁîªÂëΩ‰∏∫Á¨¶ Èì∏Êàê‰∏ã‰∏Ä‰∏ñÂùöÂÆà", url: "https://files.catbox.moe/9b4lh7.mp3" },
            { title: "ËåâËéâÈõ®", sub: "Áê¥Â£∞ÈáåÊÑÅÂá†ËÆ∏ÂÖ≥‰∫é‰Ω†", url: "https://files.catbox.moe/7ml83u.mp3" },
            { title: "ÊÄé‰πàÂî±ÊÉÖÊ≠å", sub: "Êµ∑ ÂèòÁöÑËã¶Ê∂© ÁÅº‰º§‰∏ÄÁâáÊ∏©Êüî", url: "https://files.catbox.moe/isqax9.mp3" },
            { title: "Â≤∏ËæπÂÆ¢", sub: "‰Ω†ÂõûÊù•ÊàëÂøÉÊú™Êîπ ‰Ω†‰∏çÂú®ÊàëËøòÁ≠âÂæÖ", url: "https://files.catbox.moe/9oud6s.mp3" },
            { title: "Ê±üÂçóÈõ™", sub: "Áõ∏ÊÄùÂÜçÊó†ËçØËß£ ‰ªéÊ≠§‰∏áËà¨È£éÊúàÈÉΩÊòØÊàëÂøÉÁªì", url: "https://files.catbox.moe/hhjwek.mp3" },
            { title: "‰∏çÊ≠ª‰πãË∫´", sub: "Êàë‰ªçÁà±‰Ω†Áà±Âæó‰∏çÁü•Â§©È´òÂú∞Âéö", url: "https://files.catbox.moe/g960ev.mp3" },
            { title: "Êàë‰ª¨ÁöÑÊòéÂ§©", sub: "Áà±‰ªé‰∏çÊõæ‰øùÁïô ÊâçÂãáÊï¢‰∫ÜÊàë", url: "https://files.catbox.moe/a3yjvv.mp3" },
            { title: "ÈöæËß£", sub: "ÁÇπÁÇ∑È´òÈ¶ôÊï¨‰∫àÁ•ûÊòé Ë¢´‰∫∫Âò≤Á¨ëÁü¢Âøó‰∏çÊ∏ù", url: "https://files.catbox.moe/1u8m3r.mp3" },
            { title: "ÊúÄÂ•ΩÁöÑÊàë & 50 Feet", sub: "ËØïÁùÄ‰º∏Êâã Âç¥Ëøû‰Ω†ÁöÑÂΩ±Â≠êÊàëÈÉΩÊó†Ê≥ïÈù†Ëøë", url: "https://files.catbox.moe/clsiyi.mp3" },
            { title: "ÂêåÊâãÂêåËÑö", sub: "‰πüÊòØÂ≠òÂú®Âú®Ëøô‰∏™‰∏ñÁïå ÂîØ‰∏ÄÁöÑÂîØ‰∏Ä", url: "https://files.catbox.moe/b8hss3.mp3" },
            { title: "ÂêåËä±È°∫", sub: "Âè™Ë¶ÅËÇØÁà±ÂæóÊ∑± ÊòØ‰∏çÊòØÂ∞±ÊúâËøôÂèØËÉΩ", url: "https://files.catbox.moe/28mw5d.mp3" },
            { title: "ËΩªËàû", sub: "ËΩªËàûÂêß ËøáÂæÄÂ¶ÇË£ôÁ∫±", url: "https://files.catbox.moe/8n9lhi.mp3" },
            { title: "ÁªùÂØπÂç†Êúâ Áõ∏ÂØπËá™Áî±", sub: "ËµûÁæé‰Ω†ÂåÖÂÆπ‰Ω†ÈÉΩÊòØÊàëÁöÑ‰ΩøÂëΩ", url: "https://files.catbox.moe/zi4gxo.mp3" },
            { title: "ÂçÉ‰∏áÊ¨°ÊÉ≥Ë±°", sub: "ÊàëÂçÉ‰∏áÊ¨°ÊÉ≥Ë±° ÂçÉ‰∏áÊ¨°Ê®°‰ªø ÊÄùÂøµÁöÑÂΩ¢Áä∂", url: "https://files.catbox.moe/4jtex8.mp3" },
            { title: "ËæûÂÆ∂ÂçÉÈáå", sub: "Á©øËøáÊó†‰∫∫ÈóÆÊ¥•ÂéªËßÅÂ±±Êµ∑‰∏áÈ°∑", url: "https://files.catbox.moe/2quy44.mp3" },
            { title: "Ryukyuvania", sub: "----", url: "https://files.catbox.moe/utmbqp.mp3" },
            { title: "Ê≤¶Èô∑", sub: "ÂúàÂÆÉÂú®ÈªëÊöó‰∏≠ÈÄÉ‰∏çÂá∫ÁöÑÊ¢¶È≠á", url: "https://files.catbox.moe/0bhl3i.mp3" },
            { title: "ÊôöÊû´Ê≠å", sub: "‰Ω†ÂèàÊÄéÁü•Êàë‰ªéÊú™ÊîæÊâã", url: "https://files.catbox.moe/xhwrwy.mp3" },
            { title: "I Need U", sub: "I need you girl", url: "https://files.catbox.moe/v1k4h8.mp3" },
            { title: "Ëã•Ê¢¶", sub: "Êó•ÂçáÊúàËêΩ Ê≠§Áîü‰æùÊóßÈöæËàç", url: "https://files.catbox.moe/6uysqy.mp3" },
            { title: "Áà±‰∫∫", sub: "ÂèØÊòØÊÅ®ÁöÑ‰∫∫Ê≤°Ê≠ªÊàê Áà±ÁöÑ‰∫∫Ê≤°ÂèØËÉΩ", url: "https://files.catbox.moe/wtbdxe.mp3" },
            { title: "ÊòüÊ≤≥Âèπ", sub: "ÊàëÁõºÂ≠§Ë∫´Á∫µÈ©¨ Á¨õÂ£∞Êº´Â§© ÂõõÊµ∑‰ªªÊàëÊ∏∏", url: "https://files.catbox.moe/de7g2m.mp3" },
            { title: "Áà±ÊÆá", sub: "ÂÅáÊ¨¢ÁïÖ Âèà‰ΩïÂ¶® Êó†‰∫∫ÂÖ±‰∫´", url: "https://files.catbox.moe/or2hm7.mp3" },
            { title: "Una mattina", sub: "----", url: "https://files.catbox.moe/nf8o90.mp3" },
            { title: "È°∫ÂÖ∂Ëá™ÁÑ∂", sub: "You light up my heart", url: "https://files.catbox.moe/na01cn.mp3" },
            { title: "ÂàùËßÅ", sub: "Ëã•Â¶ÇÂàùËßÅ ‰∏∫Ë∞ÅËÄåÂΩí", url: "https://files.catbox.moe/bumolx.mp3" },
            { title: "ÊàëÂ•ΩÂÉèÂú®Âì™ËßÅËøá‰Ω†", sub: "‰∫∫‰ª¨ÊääÈöæË®ÄÁöÑÁà±ÈÉΩÂüãÂÖ•ÂúüÂ£§Èáå", url: "https://files.catbox.moe/vcidpc.mp3" },
            { title: "Âà´ÂõûÂ§¥", sub: "Áà±ÊòØÂπ¥Â∞ëÊó∂‰∏çÂ†™ÂÖ∂Èáç Ê∏óÈÄèÁÅµÈ≠ÇÁöÑ‰∏ÄÈòµÂâßÁóõ", url: "https://files.catbox.moe/h1hwo5.mp3" },
            { title: "Â§ßÈ±º", sub: "ÊÄï‰Ω†È£ûËøúÂéª ÊÄï‰Ω†Á¶ªÊàëËÄåÂéª", url: "https://files.catbox.moe/jlcvkg.mp3" },
            { title: "‰∫∫È±ºÁöÑÁúºÊ≥™", sub: "Baby Don't cry", url: "https://files.catbox.moe/40fm4j.mp3" },
            { title: "‰πùÂº†Êú∫", sub: "ÊàëÊÑøÂåñ‰ΩúÊúõÊñ≠Â§©Ê∂ØÈÇ£‰∏ÄÊñπÈùíÁü≥", url: "https://files.catbox.moe/hql6w5.mp3" },
            { title: "Ê¢¶ÂπªËØõ‰ªô", sub: "Êù•‰∏ñËã•ÂÜç‰ºöËøò‰∏é‰Ω†ÂèåÂèåÂØπÂØπ", url: "https://files.catbox.moe/r6btwp.mp3" },
            { title: "ÂØªÂ∏∏Ê≠å", sub: "ÊâÄÂπ∏‰∏çËøáÊòØ ÂØªÂ∏∏‰∫∫Èó¥‰∫ã", url: "https://files.catbox.moe/ntcqvr.mp3" },
{ title: "ÂÖ¨Á§∫ÊÉÖ‰π¶", sub: "ÊúâÁßçÂæÆÂ¶ôÁ°ÆÂÆöÁöÑÂπ∏Á¶è Âè´ÂØπÊñπÊ≠£Âú®ËæìÂÖ•", url: "https://files.catbox.moe/rptwer.mp3" },
{ title: "Áé∞Âú®ÈÇ£ËæπÊòØÂá†ÁÇπ", sub: "ËØ∑ÈóÆ‰Ω†Áé∞Âú®ÈÇ£ËæπÊòØÂá†ÁÇπ ‰ºö‰∏ç‰ºöËøòÊîæÊúâÊàëÁöÑÁÖßÁâá", url: "https://files.catbox.moe/icv2aa.mp3" },
{ title: "ÊÉÖ‰∫∫", sub: "Ê∞îÊ∞õÂºÄÂßãÂçáÊ∏© Âç±Èô©ÂèàËø∑‰∫∫", url: "https://files.catbox.moe/iqairg.mp3" },
{ title: "ÊÄúÊÇØ", sub: "ÊàëË¶ÅÂ∏¶ÁùÄÁà±ÊÑèÁùÄÊÅ®‰Ω†", url: "https://files.catbox.moe/242a1h.mp3" },
{ title: "ÁñëÂøÉÁóÖ", sub: "‰Ω†Áªà‰∫éËØ¥Âá∫Âè£‰Ω†ÂØπÊàëÊÑüÊÉÖ‰πüÂæàÈáç", url: "https://files.catbox.moe/jc1umm.mp3" },
{ title: "ËØÄÁà±", sub: "Ëã•ÁÅµÈ≠ÇÁõ∏ÁªìÂú®Â§©Âú∞‰πãÈó¥", url: "https://files.catbox.moe/quqaws.mp3" },
{ title: "ÂΩºÂ≤∏", sub: "Â•πÊçßËµ∑ÈïúËä±Ê∞¥Êúà ‰∏ÄÂàπÈÇ£ÊπÆÁÅ≠", url: "https://files.catbox.moe/zxepep.mp3" },
{ title: "ÈóÆÊÉÖ", sub: "ÂΩìÁà±ÊÅ®Â¶ÇÊΩÆÁîüÂ§öÊÆãÂøç", url: "https://files.catbox.moe/erds0n.mp3" },
{ title: "ÂêåËøõÈÄÄ", sub: "Êàë‰ºöÁâµÁùÄ‰Ω†ÊâãÂêåËøõÈÄÄ ‰ΩõÂâçÁ´ãË™ì‰∏çÂêéÊÇî", url: "https://files.catbox.moe/vb6chf.mp3" },
{ title: "ÊãõÊëá", sub: "‰∏ÄÂè•Ê≠§Áîü‰∏çÊç¢", url: "https://files.catbox.moe/oc86ih.mp3" },
{ title: "‰Ω†Ë¶ÅÁöÑÂÖ®ÊãøËµ∞", sub: "Â•ΩËÅöÂ•ΩÊï£Âê¨ÁùÄ‰πüÊ•öÊ•öÂèØÊÄú", url: "https://files.catbox.moe/ok2e3s.mp3" },
{ title: "‰∫ëË£≥ÁæΩË°£Êõ≤", sub: "ÊïÖ‰∫ãÈ≤úËâ≥ËÄåÁºòÂàÜÂç¥Â§™ÊµÖ", url: "https://files.catbox.moe/njnbhv.mp3" },
{ title: "Â§ßÊ¢¶ÂΩíÁ¶ª", sub: "Áªà‰∫éÂê¨È£éÂÑøËØ¥ Áü•ÈÅì‰Ω†Âú®Âì™Èáå", url: "https://files.catbox.moe/5z67vs.mp3" },
{ title: "ÂÅèÂêë", sub: "‰∏∫‰Ωï‰ºö‰∏§Ë¥•‰ø±‰º§", url: "https://files.catbox.moe/i37f39.mp3" },
{ title: "Love me like you do", sub: "You're the only thing I wanna touch", url: "https://files.catbox.moe/arym0i.mp3" },
{ title: "Not snow,but U", sub: "ÊàëÊúüÂæÖÁöÑ‰∏çÊòØÈõ™ËÄåÊòØÊúâ‰Ω†ÁöÑÂÜ¨Â§©", url: "https://files.catbox.moe/6rk4gw.mp3" },
{ title: "The Evergreen", sub: "ÊàëÊÅçÁÑ∂Êòé‰∫ÜÊàëÊâÄÈúÄÁöÑ‰∏ÄÂàáÂ∑≤Â∞ΩÊï∞ÊëÜÂú®ÁúºÂâç", url: "https://files.catbox.moe/ca3rim.mp3" },
{ title: "ÂÜ•Ê≤≥Ëû∫Êóã", sub: "ÊàëÂ¶ÇÊ≠§Â∏åÊúõ Êàë‰º¥‰Ω†Â∑¶Âè≥", url: "https://files.catbox.moe/xtj8db.mp3" },
{ title: "ÁÜÑÁÅ≠", sub: "‰Ω†ÊÄªÈóÆÊàëÂú®‰∏ÄËµ∑‰ºö‰∏ç‰ºöÊÑüÂà∞ÂéåÂÄ¶", url: "https://files.catbox.moe/wnzxou.mp3" },
{ title: "Áà±‰∫∫ÈîôËøá", sub: "ÊàëËÇØÂÆöÂú®Âá†ÁôæÂπ¥ÂâçÂ∞±ËØ¥ËøáÁà±‰Ω†", url: "https://files.catbox.moe/q2nx16.mp3" },
{ title: "ÊàëÊÉ≥Âøµ", sub: "ÊàëÊÉ≥Âøµ‰Ω†ËØ¥ËøáÁöÑÈÇ£ÁßçÊ∞∏Ëøú", url: "https://files.catbox.moe/3qxads.mp3" },
{ title: "Ê≠§Áîü‰∏çÊç¢", sub: "ÂÜçÊúâ‰∏Ä‰∏áÂπ¥Ê∑±ÊÉÖ‰πü‰∏çÂèò", url: "https://files.catbox.moe/72ik88.mp3" },
{ title: "È≥•„ÅÆË©©", sub: "----", url: "https://files.catbox.moe/966u00.mp3" }

    ];

    const uploadCoverBtn = document.getElementById('upload-cover-btn');
    const coverInput = document.getElementById('cover-input');
    const vinylRecord = document.getElementById('vinyl-record-visual');

    const applyPlayerCover = (base64Data) => {
        if (base64Data) {
            vinylRecord.style.backgroundImage = `url(${base64Data})`;
            vinylRecord.classList.add('has-cover');
            vinylRecord.style.borderWidth = '1px';
        } else {
            vinylRecord.style.backgroundImage = '';
            vinylRecord.classList.remove('has-cover');
            vinylRecord.style.borderWidth = '2px';
        }
    };

const savedCover = safeGetItem(APP_PREFIX + 'playerCover');

    localforage.getItem(APP_PREFIX + 'playerCover').then(cover => { if(cover) applyPlayerCover(cover); });
    if (savedCover) applyPlayerCover(savedCover);

    uploadCoverBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (vinylRecord.classList.contains('has-cover')) {
            if (confirm('ÊÉ≥Ë¶ÅÈáçÁΩÆÂõûÈªòËÆ§ÁöÑ„Äê‰∏ªÈ¢òËâ≤ÈªëËÉ∂„ÄëÊ†∑ÂºèÂêóÔºü\n\n‚Ä¢ ÁÇπÂáª„ÄêÁ°ÆÂÆö„ÄëÊÅ¢Â§çÈªòËÆ§\n‚Ä¢ ÁÇπÂáª„ÄêÂèñÊ∂à„ÄëÈÄâÊã©Êñ∞ÂõæÁâá')) {
                localforage.removeItem(APP_PREFIX + 'playerCover');
                applyPlayerCover(null);
                showNotification('Â∑≤ÊÅ¢Â§çÈªòËÆ§ÈªëËÉ∂Ê†∑Âºè', 'success');
                return;
            }
        }
        coverInput.click();
    });

    coverInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            showNotification('ÂõæÁâáÂ§™Â§ß‰∫ÜÔºåËØ∑‰∏ä‰º† 2MB ‰ª•ÂÜÖÁöÑÂõæÁâá', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64Data = event.target.result;
            try {
                localforage.setItem(APP_PREFIX + 'playerCover', base64Data);
                applyPlayerCover(base64Data);
                showNotification('‰∏ìËæëÂ∞ÅÈù¢ËÆæÁΩÆÊàêÂäüÔºÅ', 'success');
            } catch (err) {
                console.error(err);
                showNotification('ÂõæÁâáÂ≠òÂÇ®Â§±Ë¥•ÔºàÂèØËÉΩË∂ÖÂá∫‰∫ÜÊµèËßàÂô®ÈôêÂà∂Ôºâ', 'error');
            }
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    const savedSongsStr = safeGetItem(APP_PREFIX + 'customSongs');
    let songs = [];
if (savedSongsStr) {
        songs = JSON.parse(savedSongsStr);
    } else {
        songs = [...latestSystemSongs];
    }

    const player = document.getElementById('player');
    const miniView = document.getElementById('mini-view');
    const playlist = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const progressArea = document.getElementById('progress-area');

    const addSongModal = document.getElementById('add-song-modal');
    const newSongTitle = document.getElementById('new-song-title');
    const newSongSub = document.getElementById('new-song-sub');
    const newSongUrl = document.getElementById('new-song-url');
    const confirmAddSongBtn = document.getElementById('confirm-add-song');
    const cancelAddSongBtn = document.getElementById('cancel-add-song');
    const modalTitleElem = addSongModal.querySelector('.modal-title span');

    let currentIndex = 0;
    let isPlaying = false;
    let isRandom = false;
    let editModeIndex = -1;
    let searchTerm = '';
    let isSearchVisible = false;

    function loadSong(index) {
        if (songs.length === 0) return;
        if (index >= songs.length) index = 0;
        if (index < 0) index = songs.length - 1;

        const song = songs[index];
        document.getElementById('music-title').innerText = song.title;
        document.getElementById('music-subtitle').innerText = song.sub;
        
        if (song.url) audio.src = song.url;
        updatePlaylistHighlight();
    }

    function togglePlay() {
        if (songs.length === 0) {
            showNotification('Êí≠ÊîæÂàóË°®‰∏∫Á©∫', 'warning');
            return;
        }
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
            document.getElementById('icon-play').style.display = 'block';
            document.getElementById('icon-pause').style.display = 'none';
            player.classList.remove('playing');
        } else {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    isPlaying = true;
                    document.getElementById('icon-play').style.display = 'none';
                    document.getElementById('icon-pause').style.display = 'block';
                    player.classList.add('playing');
                }).catch(error => {
                    console.error(error);
                    showNotification('Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑ÊåÇvpnÔºåÂÖ∑‰ΩìÊñπÊ≥ïËá™Ë°å', 'error');
                });
            }
        }
    }

    function nextSong() {
        if (songs.length === 0) return;
        if (isRandom) currentIndex = Math.floor(Math.random() * songs.length);
        else currentIndex = (currentIndex + 1) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function prevSong() {
        if (songs.length === 0) return;
        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function savePlaylist() {
        localforage.setItem(APP_PREFIX + 'customSongs', songs);
        renderPlaylist();
    }

    function syncSystemSongs() {
        if (confirm('Êõ¥Êñ∞Ê≠åÂçïÂ∞Ü‰ºöÔºö\n1. ËØªÂèñ‰ª£Á†Å‰∏≠ÊúÄÊñ∞ÁöÑÈ¢ÑËÆæÊ≠åÂçï\n2. ‰øùÁïô‰Ω†ÊâãÂä®Ê∑ªÂä†ÁöÑËá™ÂÆö‰πâÊ≠åÊõ≤\n\nÁ°ÆÂÆöË¶ÅÊõ¥Êñ∞ÂêóÔºü')) {
            try {
                const userCustomSongs = songs.filter(s => s.isCustom === true);
                
                songs = [...latestSystemSongs, ...userCustomSongs];
                
                safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
                
                currentIndex = 0;
                loadSong(0);
                if (isPlaying) {
                    audio.pause();
                    audio.currentTime = 0;
                    isPlaying = false;
                    document.getElementById('icon-play').style.display = 'block';
                    document.getElementById('icon-pause').style.display = 'none';
                    player.classList.remove('playing');
                }

                renderPlaylist();
                
                showNotification('Ê≠åÂçïÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ', 'success');
            } catch (e) {
                console.error(e);
                showNotification('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•‰ª£Á†ÅÊ†ºÂºè', 'error');
            }
        }
    }

    function openEditModal(index) {
        const song = songs[index];
        if (!song) return;
        editModeIndex = index;
        newSongTitle.value = song.title;
        newSongSub.value = song.sub;
        newSongUrl.value = song.url;
        modalTitleElem.innerText = "ÁºñËæëÊ≠åÊõ≤‰ø°ÊÅØ";
        confirmAddSongBtn.innerText = "‰øùÂ≠ò‰øÆÊîπ";
        showModal(addSongModal);
    }

    function openAddModal() {
        editModeIndex = -1;
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        modalTitleElem.innerText = "Ê∑ªÂä†Ëá™ÂÆö‰πâÊ≠åÊõ≤";
        confirmAddSongBtn.innerText = "Ê∑ªÂä†Êí≠Êîæ";
        showModal(addSongModal);
    }

    function renderPlaylist() {
        playlist.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'playlist-header';
        header.innerHTML = `
            <div class="pl-header-title">Àô¬∞ ö·ï±‚ëÖ·ï±…û¬∞Àô</div>
            <div class="pl-header-actions">
                <button class="pl-icon-btn ${isSearchVisible ? 'active' : ''}" id="pl-search-toggle" title="ÊêúÁ¥¢"><i class="fas fa-search"></i></button>
                <button class="pl-icon-btn" id="pl-sync-btn" title="Êõ¥Êñ∞È¢ÑËÆæÊ≠åÂçï"><i class="fas fa-sync-alt"></i></button>
                <button class="pl-icon-btn" id="pl-add-btn" title="Ê∑ªÂä†Ê≠åÊõ≤"><i class="fas fa-plus"></i></button>
            </div>
        `;
        playlist.appendChild(header);

        const searchWrapper = document.createElement('div');
        searchWrapper.className = `playlist-search-wrapper ${isSearchVisible ? 'active' : ''}`;
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'playlist-search-input';
        searchInput.placeholder = '';
        searchInput.value = searchTerm;
        
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderListContent(contentDiv);
        });
        
        searchWrapper.appendChild(searchInput);
        playlist.appendChild(searchWrapper);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'playlist-content';
        playlist.appendChild(contentDiv);

        renderListContent(contentDiv);

        header.querySelector('#pl-add-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openAddModal();
            newSongTitle.focus();
        });
        
        header.querySelector('#pl-sync-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            syncSystemSongs();
        });

        header.querySelector('#pl-search-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            isSearchVisible = !isSearchVisible;
            searchWrapper.classList.toggle('active', isSearchVisible);
            e.currentTarget.classList.toggle('active', isSearchVisible);
            if (isSearchVisible) {
                setTimeout(() => searchInput.focus(), 100);
            }
        });
    }

    function renderListContent(container) {
        container.innerHTML = '';
        
        const filteredSongs = songs.map((s, i) => ({...s, originalIndex: i}))
                                   .filter(s => s.title.toLowerCase().includes(searchTerm) || 
                                                s.sub.toLowerCase().includes(searchTerm));

        if (filteredSongs.length === 0) {
            container.innerHTML = `<div class="empty-search-result">Êú™ÊâæÂà∞ "${searchTerm}" Áõ∏ÂÖ≥Ê≠åÊõ≤</div>`;
            return;
        }

        filteredSongs.forEach((song) => {
            const realIndex = song.originalIndex;

            const div = document.createElement('div');
            div.className = 'playlist-item';
            if (realIndex === currentIndex) div.classList.add('playing');

            const highlightText = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            };

            const displayTitle = highlightText(song.title, searchTerm);
            const displaySub = highlightText(song.sub, searchTerm);

            div.innerHTML = `
                <div class="song-info">
                    <div class="song-title-row">${displayTitle}</div>
                    <div class="song-sub-row">${displaySub}</div>
                </div>
                <div class="item-actions">
                    ${song.isCustom ? '<span class="custom-tag" title="Ëá™ÂÆö‰πâÊ≠åÊõ≤"></span>' : ''}
                    <span class="action-icon-btn delete" title="ÁßªÈô§">&times;</span>
                </div>
            `;

            if (song.isCustom) {
                div.querySelector('.custom-tag').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(realIndex);
                });
            }

            div.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Á°ÆÂÆöÁßªÈô§„Ää${song.title}„ÄãÂêóÔºü`)) {
                    songs.splice(realIndex, 1);
                    savePlaylist();
                    
                    if (realIndex === currentIndex) {
                        if (songs.length > 0) {
                            currentIndex = realIndex % songs.length;
                            loadSong(currentIndex);
                            if (isPlaying) audio.play();
                        } else {
                            audio.pause();
                            isPlaying = false;
                            loadSong(0);
                        }
                    } else if (realIndex < currentIndex) {
                        currentIndex--;
                    }
                }
            });

            div.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = realIndex;
                loadSong(currentIndex);
                if (!isPlaying) togglePlay();
                else audio.play();
            });

            container.appendChild(div);
        });
    }

    function updatePlaylistHighlight() {
        const contentDiv = playlist.querySelector('.playlist-content');
        if (contentDiv) renderListContent(contentDiv);
    }

    confirmAddSongBtn.addEventListener('click', () => {
        const title = newSongTitle.value.trim();
        const sub = newSongSub.value.trim();
        const url = newSongUrl.value.trim();

        if (!title || !url) {
            showNotification('Ê≠åÂêçÂíåÈìæÊé•‰∏çËÉΩ‰∏∫Á©∫', 'error');
            return;
        }

        const songData = {
            title,
            sub: sub || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂',
            url,
            isCustom: true
        };

        if (editModeIndex >= 0) {
            songs[editModeIndex] = songData;
            showNotification('Ê≠åÊõ≤‰ø°ÊÅØÂ∑≤‰øÆÊîπ', 'success');
        } else {
            songs.unshift(songData);
            showNotification('Ê≠åÊõ≤Â∑≤Ê∑ªÂä†', 'success');
            if (songs.length === 1) loadSong(0);
        }

        searchTerm = '';
        savePlaylist();
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        hideModal(addSongModal);
    });

    cancelAddSongBtn.addEventListener('click', () => {
        hideModal(addSongModal);
    });

    function setupDrag() {
        let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
        const dragStart = (e) => {
            if (e.target.closest('.btn') || e.target.closest('.progress-wrapper') || e.target.closest('.playlist-popup')) return;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            isDragging = true; hasMoved = false;
            startX = event.clientX; startY = event.clientY;
            const rect = player.getBoundingClientRect();
            initialLeft = rect.left; initialTop = rect.top;
            player.style.transition = 'none';
            playlist.style.transition = 'none';
        };
        const dragMove = (e) => {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;
            const maxLeft = window.innerWidth - player.offsetWidth;
            const maxTop = window.innerHeight - player.offsetHeight;
            player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
            player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
            const rect = player.getBoundingClientRect();
            playlist.style.left = rect.left + 'px';
            playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        };
        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            player.style.transition = '';
            playlist.style.transition = '';
        };
        player.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        player.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', dragMove, { passive: false });
        document.addEventListener('touchend', dragEnd);

        miniView.addEventListener('click', () => {
            if (!hasMoved && player.classList.contains('collapsed')) {
                player.classList.remove('collapsed');
                setTimeout(() => {
                    const rect = player.getBoundingClientRect();
                    playlist.style.top = (rect.top + 170) + 'px';
                }, 300);
            }
        });
    }

    playBtn.addEventListener('click', togglePlay);
    document.getElementById('next-btn').addEventListener('click', nextSong);
    document.getElementById('prev-btn').addEventListener('click', prevSong);
    document.getElementById('minimize-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        player.classList.add('collapsed');
        playlist.classList.remove('active');
    });

    progressArea.addEventListener('click', (e) => {
        const width = progressArea.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) audio.currentTime = (clickX / width) * duration;
    });

    audio.addEventListener('timeupdate', (e) => {
        const { duration, currentTime } = e.target;
        if (duration) document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
    });
    audio.addEventListener('ended', nextSong);

    document.getElementById('mode-btn').addEventListener('click', () => {
        isRandom = !isRandom;
        document.getElementById('icon-loop').style.display = isRandom ? 'none' : 'block';
        document.getElementById('icon-shuffle').style.display = isRandom ? 'block' : 'none';
        showNotification(isRandom ? 'ÈöèÊú∫Êí≠Êîæ' : 'È°∫Â∫èÊí≠Êîæ', 'info', 1000);
    });

    const listBtn = document.getElementById('list-btn');
    listBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = player.getBoundingClientRect();
        playlist.style.left = rect.left + 'px';
        playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 70 : 170)) + 'px';
        playlist.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!playlist.contains(e.target) && !listBtn.contains(e.target) && !player.contains(e.target) && !e.target.closest('#add-song-modal')) {
            playlist.classList.remove('active');
        }
    });

    loadSong(0);
    renderPlaylist();
    setupDrag();

    if (settings.musicPlayerEnabled) {
        player.classList.add('visible');
    }
};

        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];



function renderReplyLibrary() {
    const list = document.getElementById('custom-replies-list');
    const searchInput = document.getElementById('reply-search-input');
    const addButton = document.getElementById('add-custom-reply');
    const subTabsContainer = document.getElementById('cr-sub-tabs');
    const titleEl = document.getElementById('cr-modal-title');

    const currentConfig = LIBRARY_CONFIG[currentMajorTab];
    titleEl.textContent = currentConfig.title;

    subTabsContainer.innerHTML = currentConfig.tabs.map(tab => `
        <button class="reply-tab-btn ${currentSubTab === tab.id ? 'active' : ''}" 
                data-id="${tab.id}" data-mode="${tab.mode}">
            ${tab.name}
        </button>
    `).join('');

    subTabsContainer.querySelectorAll('.reply-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentSubTab = btn.dataset.id;
            renderReplyLibrary();
        });
    });

    list.innerHTML = '';
    list.className = 'content-list-area'; 
    
    const activeTabConfig = currentConfig.tabs.find(t => t.id === currentSubTab);
    list.classList.add(activeTabConfig.mode + '-mode');

    const filterText = searchInput ? searchInput.value.toLowerCase().trim() : '';
    let itemsToRender = [];
    let renderType = 'text'; 
    if (currentMajorTab === 'reply') {
        if (currentSubTab === 'custom') {
            itemsToRender = customReplies;
            addButton.innerHTML = '<i class="fas fa-plus"></i> Êñ∞Â¢ûÂõûÂ§ç';
            addButton.style.display = 'flex';
        } else if (currentSubTab === 'default') {
            itemsToRender = CONSTANTS.REPLY_MESSAGES;
            addButton.style.display = 'none';
        } else if (currentSubTab === 'emojis') {
            itemsToRender = CONSTANTS.REPLY_EMOJIS;
            renderType = 'emoji';
            addButton.style.display = 'none';
        } else if (currentSubTab === 'stickers') {
            itemsToRender = stickerLibrary;
            renderType = 'image';
            addButton.innerHTML = '<i class="fas fa-plus"></i> Ê∑ªÂä†Ë°®ÊÉÖ';
            addButton.style.display = 'flex';
        }
    } else if (currentMajorTab === 'atmosphere') {
        addButton.style.display = 'flex';
        if (currentSubTab === 'pokes') {
            itemsToRender = customPokes;
            addButton.innerHTML = '<i class="fas fa-plus"></i> Êñ∞Â¢ûÊãç‰∏ÄÊãç';
        } else if (currentSubTab === 'statuses') {
            itemsToRender = customStatuses;
            addButton.innerHTML = '<i class="fas fa-plus"></i> Êñ∞Â¢ûÁä∂ÊÄÅ';
        } else if (currentSubTab === 'mottos') {
            itemsToRender = customMottos;
            addButton.innerHTML = '<i class="fas fa-plus"></i> Êñ∞Â¢ûÊ†ºË®Ä';
        } else if (currentSubTab === 'intros') {
            itemsToRender = customIntros;
            addButton.innerHTML = '<i class="fas fa-plus"></i> Êñ∞Â¢ûÂºÄÂú∫ËØ≠';
        }
    }

    if (itemsToRender.length === 0) {
        list.innerHTML = renderEmptyState("ÂàóË°®Á©∫Á©∫Â¶Ç‰πü");
        return;
    }

    itemsToRender.forEach((item, index) => {
        if (renderType === 'text' && filterText && !item.toLowerCase().includes(filterText)) return;
        
        if (renderType === 'image') {
            const div = document.createElement('div');
            div.className = 'sticker-item';
            div.innerHTML = `
                <img src="${item}" loading="lazy">
                <div class="sticker-delete-btn"><i class="fas fa-times"></i></div>
            `;
            div.querySelector('.sticker-delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("Âà†Èô§Ê≠§Ë°®ÊÉÖÔºü")) {
                    stickerLibrary.splice(index, 1);
                    throttledSaveData();
                    renderReplyLibrary();
                }
            });
            list.appendChild(div);
            return;
        }

        if (renderType === 'emoji') {
            const isDisabled = disabledDefaultReplies.includes(item);
            const div = document.createElement('div');
            div.className = `emoji-item ${isDisabled ? 'disabled' : ''}`;
            div.textContent = item;
            div.onclick = () => {
                toggleEmoji(item);
            };
            list.appendChild(div);
            return;
        }

        const isDefaultReply = (currentMajorTab === 'reply' && currentSubTab === 'default');
        const isDisabled = isDefaultReply && disabledDefaultReplies.includes(item);
        
        const div = document.createElement('div');
        div.className = `custom-reply-item ${isDisabled ? 'disabled' : ''}`;
        
        let displayHTML = `<span class="custom-reply-text">${item.replace('|', '<br><small style="opacity:0.7">')}</span>`; 

        let buttonsHTML = '';
        if (isDefaultReply) {
             const icon = isDisabled ? 'fa-eye' : 'fa-eye-slash';
             buttonsHTML = `
                <button class="reply-action-mini copy-btn" title="Â§çÂà∂‰∏∫Ëá™ÂÆö‰πâ"><i class="fas fa-copy"></i></button>
                <button class="reply-action-mini toggle-btn"><i class="fas ${icon}"></i></button>
             `;
        } else {
            buttonsHTML = `
                <button class="reply-action-mini edit-btn"><i class="fas fa-pen"></i></button>
                <button class="reply-action-mini delete-btn"><i class="fas fa-trash-alt"></i></button>
            `;
        }

        div.innerHTML = `${displayHTML}<div class="custom-reply-actions">${buttonsHTML}</div>`;

        if (isDefaultReply) {
            div.querySelector('.toggle-btn').onclick = () => toggleDefaultReply(item);
            div.querySelector('.copy-btn').onclick = () => copyToCustom(item);
        } else {
            div.querySelector('.delete-btn').onclick = () => deleteItem(index);
            div.querySelector('.edit-btn').onclick = () => editItem(index, item);
        }

        list.appendChild(div);
    });
}
function toggleEmoji(emoji) {
    const idx = disabledDefaultReplies.indexOf(emoji);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(emoji);
    throttledSaveData();
    renderReplyLibrary();
}

function toggleDefaultReply(text) {
    const idx = disabledDefaultReplies.indexOf(text);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(text);
    throttledSaveData();
    renderReplyLibrary();
}

function copyToCustom(text) {
    customReplies.push(text);
    currentSubTab = 'custom';
    throttledSaveData();
    renderReplyLibrary();
    showNotification('Â∑≤Â§çÂà∂Âà∞Ëá™ÂÆö‰πâÂõûÂ§ç', 'success');
}

function deleteItem(index) {
    if (!confirm("Á°ÆÂÆöÂà†Èô§ÂêóÔºü")) return;
    
    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies.splice(index, 1);
    else if (currentSubTab === 'pokes') customPokes.splice(index, 1);
    else if (currentSubTab === 'statuses') customStatuses.splice(index, 1);
    else if (currentSubTab === 'mottos') customMottos.splice(index, 1);
    else if (currentSubTab === 'intros') customIntros.splice(index, 1);

    throttledSaveData();
    renderReplyLibrary();
}

function editItem(index, oldText) {
    let newText;
    if (currentSubTab === 'intros') {
        const parts = oldText.split('|');
        const l1 = prompt("‰øÆÊîπ‰∏ªÊ†áÈ¢ò:", parts[0]);
        if(l1 === null) return;
        const l2 = prompt("‰øÆÊîπÂâØÊ†áÈ¢ò:", parts[1] || "");
        if(l2 === null) return;
        newText = `${l1}|${l2}`;
    } else {
        newText = prompt("‰øÆÊîπÂÜÖÂÆπ:", oldText);
    }

    if (newText === null || newText.trim() === "") return;

    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies[index] = newText;
    else if (currentSubTab === 'pokes') customPokes[index] = newText;
    else if (currentSubTab === 'statuses') customStatuses[index] = newText;
    else if (currentSubTab === 'mottos') customMottos[index] = newText;
    else if (currentSubTab === 'intros') customIntros[index] = newText;

    throttledSaveData();
    renderReplyLibrary();
}
function renderEmptyState(text) {
    return `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; color: var(--text-secondary); opacity: 0.6; grid-column: 1 / -1;">
        <div style="width: 60px; height: 60px; background: var(--secondary-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: var(--shadow);">
            <i class="fas fa-search" style="font-size: 24px; color: var(--accent-color);"></i>
        </div>
        <p style="font-size:15px; font-weight: 500; text-align:center; line-height:1.5;">${text}</p>
    </div>`;
}

function initReplyLibraryListeners() {
    const entryBtn = document.getElementById('custom-replies-function');
    if (entryBtn) {
        entryBtn.addEventListener('click', () => {
            hideModal(DOMElements.advancedModal.modal);
            currentMajorTab = 'reply';
            currentSubTab = 'custom';
            document.querySelectorAll('.sidebar-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.major === 'reply');
            });
            renderReplyLibrary();
            showModal(DOMElements.customRepliesModal.modal);
        });
    }

    document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentMajorTab = btn.dataset.major;

            // Handle announcement tab separately
            if (currentMajorTab === 'announcement') {
                // switchToAnnouncementPanel called via onclick already
                return;
            }

            // Restore normal panels when switching away from announcement
            var listArea = document.getElementById('custom-replies-list');
            var annPanel = document.getElementById('announcement-panel');
            var toolbar = document.getElementById('cr-toolbar');
            var subTabs = document.getElementById('cr-sub-tabs');
            var addBtn = document.getElementById('add-custom-reply');
            var titleEl = document.getElementById('cr-modal-title');
            if (listArea) listArea.style.display = '';
            if (annPanel) annPanel.style.display = 'none';
            if (toolbar) toolbar.style.display = '';
            if (subTabs) subTabs.style.display = '';
            if (addBtn) addBtn.style.display = '';
            if (titleEl) titleEl.textContent = 'ÂÜÖÂÆπÁÆ°ÁêÜ';
            
            currentSubTab = LIBRARY_CONFIG[currentMajorTab].tabs[0].id;
            
            renderReplyLibrary();
        });
    });

    const searchInput = document.getElementById('reply-search-input');
    if (searchInput) searchInput.addEventListener('input', renderReplyLibrary);

    const exportBtn = document.getElementById('export-replies-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            const libraryData = {
                customReplies,
                customPokes,
                customStatuses,
                customMottos,
                customIntros,
                stickerLibrary,
                disabledDefaultReplies, 
                exportDate: new Date().toISOString()
            };
            const fileName = `reply-library-backup-${new Date().toISOString().slice(0, 10)}.json`;
            const dataStr = JSON.stringify(libraryData, null, 2);
            exportDataToMobileOrPC(dataStr, fileName);
        });
    }

    const importBtn = document.getElementById('import-replies-btn');
    const importInput = document.getElementById('import-replies-input');
    
    if (importBtn && importInput) {
        importBtn.addEventListener('click', () => {
            importInput.click();
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    let count = 0;
                    
                    if (data.customReplies) { customReplies = [...new Set([...customReplies, ...data.customReplies])]; count++; }
                    if (data.customPokes) { customPokes = [...new Set([...customPokes, ...data.customPokes])]; count++; }
                    if (data.customStatuses) { customStatuses = [...new Set([...customStatuses, ...data.customStatuses])]; count++; }
                    if (data.customMottos) { customMottos = [...new Set([...customMottos, ...data.customMottos])]; count++; }
                    if (data.customIntros) { customIntros = [...new Set([...customIntros, ...data.customIntros])]; count++; }
                    if (data.stickerLibrary) { stickerLibrary = [...new Set([...stickerLibrary, ...data.stickerLibrary])]; count++; }
                    
                    if (data.disabledDefaultReplies) { 
                        disabledDefaultReplies = [...new Set([...disabledDefaultReplies, ...data.disabledDefaultReplies])]; 
                        count++; 
                    }

                    throttledSaveData();
                    renderReplyLibrary();
                    showNotification('ÂÆåÊï¥ÂõûÂ§çÂ∫ìÊï∞ÊçÆÂØºÂÖ•ÊàêÂäüÔºÅ', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('Êñá‰ª∂Ê†ºÂºèÈîôËØØ', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        });
    }
    const addBtn = document.getElementById('add-custom-reply');
    if (addBtn) {
        addBtn.addEventListener('click', () => {
            if (currentSubTab === 'stickers') {
                document.getElementById('sticker-file-input').click();
                return;
            }

            let input;
            if (currentSubTab === 'intros') {
                 const l1 = prompt("ËØ∑ËæìÂÖ•‰∏ªÊ†áÈ¢ò (Â¶Ç: ùë≥ùíêùíóùíÜ):");
                 if(!l1) return;
                 const l2 = prompt("ËØ∑ËæìÂÖ•ÂâØÊ†áÈ¢ò (Â¶Ç: Ëã•Ë¶ÅÁî±ÊàëÊù•Ë∞àËÆ∫Áà±ÁöÑËØù):");
                 input = `${l1}|${l2}`;
            } else {
                 input = prompt(`ËØ∑ËæìÂÖ•Êñ∞ÁöÑ${getCategoryName(currentSubTab)}:`);
            }

            if (input && input.trim()) {
                if (currentSubTab === 'custom') customReplies.unshift(input);
                else if (currentSubTab === 'pokes') customPokes.unshift(input);
                else if (currentSubTab === 'statuses') customStatuses.unshift(input);
                else if (currentSubTab === 'mottos') customMottos.unshift(input);
                else if (currentSubTab === 'intros') customIntros.unshift(input);
                
                throttledSaveData();
                renderReplyLibrary();
                showNotification('Ê∑ªÂä†ÊàêÂäü', 'success');
            }
        });
    }
}
function getCategoryName(tabId) {
    const map = {
        'custom': 'ÂõûÂ§ç', 'pokes': 'Êãç‰∏ÄÊãç', 'statuses': 'Áä∂ÊÄÅ', 
        'mottos': 'Ê†ºË®Ä', 'intros': 'ÂºÄÂú∫ËØ≠'
    };
    return map[tabId] || 'ÂÜÖÂÆπ';
}
        function updateTabUI() {
            document.querySelectorAll('.reply-tab-btn').forEach(btn => {
                if (btn.dataset.tab === currentReplyTab) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const searchInput = document.getElementById('reply-search-input');
            if (searchInput) searchInput.value = '';
        }


        function initRippleFeedback() {

            const rippleTargets = [
                '.input-btn',
                '.action-btn',
                '.modal-btn',
                '.settings-item',
                '.batch-action-btn',
                '.coin-btn-action',
                '.import-export-btn',
                '.reply-tab-btn',
                '.anniversary-type-btn',
                '.reply-tool-btn',
                '.session-action-btn',
                '.fav-action-btn'
            ];


            document.addEventListener('mousedown', function(e) {

                const target = e.target.closest(rippleTargets.join(','));

                if (target) {
                    createRipple(e, target);
                }
            });

            function createRipple(event, button) {

                if (!button.classList.contains('ripple-effect')) {
                    button.classList.add('ripple-effect');
                }


                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;


                const rect = button.getBoundingClientRect();


                const clientX = event.clientX || (event.touches ? event.touches[0].clientX: 0);
                const clientY = event.clientY || (event.touches ? event.touches[0].clientY: 0);

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${clientX - rect.left - radius}px`;
                circle.style.top = `${clientY - rect.top - radius}px`;
                circle.classList.add('ripple-wave');


                const ripple = button.getElementsByClassName('ripple-wave')[0];
                if (ripple) {
                    ripple.remove();
                }


                button.appendChild(circle);


                setTimeout(() => {
                    circle.remove();
                }, 600);
            }
        }
        function applyAvatarFrame(avatarContainer, frameSettings) {
            let frameElement = avatarContainer.querySelector('.avatar-frame');
            
            if (frameSettings && frameSettings.src) {
                if (!frameElement) {
                    frameElement = document.createElement('img');
                    frameElement.className = 'avatar-frame';
                    avatarContainer.appendChild(frameElement);
                }
                frameElement.src = frameSettings.src;
                frameElement.style.width = `${frameSettings.size || 100}%`;
                frameElement.style.height = `${frameSettings.size || 100}%`;
                
                const offsetX = frameSettings.offsetX || 0;
                const offsetY = frameSettings.offsetY || 0;
                frameElement.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
            } else {
                if (frameElement) {
                    frameElement.remove();
                }
            }
        }

        function setupAvatarFrameSettings() {
            const setupControlsFor = (type) => {
                const preview = document.getElementById(`${type}-frame-preview`);
                const uploadBtn = document.getElementById(`${type}-frame-upload-btn`);
                const removeBtn = document.getElementById(`${type}-frame-remove-btn`);
                const fileInput = document.getElementById(`${type}-frame-file-input`);
                const sizeSlider = document.getElementById(`${type}-frame-size`);
                const sizeValue = document.getElementById(`${type}-frame-size-value`);
                const xSlider = document.getElementById(`${type}-frame-offset-x`);
                const xValue = document.getElementById(`${type}-frame-offset-x-value`);
                const ySlider = document.getElementById(`${type}-frame-offset-y`);
                const yValue = document.getElementById(`${type}-frame-offset-y-value`);
                
                if (!preview || !uploadBtn || !sizeSlider) return;

                const settingsKey = type === 'my' ? 'myAvatarFrame' : 'partnerAvatarFrame';
                const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
                const avatarElement = type === 'my' ? DOMElements.me.avatar : DOMElements.partner.avatar;


const updatePreview = () => {
    let avatarContent = avatarElement.innerHTML;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = avatarContent;
    const img = tempDiv.querySelector('img');
    if (img) {
        avatarContent = `<img src="${img.src}" alt="preview">`;
    }

    const frameSettings = settings[settingsKey];

    let frameHtml = '';
    if (frameSettings && frameSettings.src) {
        const size = frameSettings.size || 100;
        const offsetX = frameSettings.offsetX || 0;
        const offsetY = frameSettings.offsetY || 0;
        
        frameHtml = `<img src="${frameSettings.src}" class="preview-frame" 
            style="width: ${size}%; height: ${size}%; transform: translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px));">`;
    }

    preview.innerHTML = `
        <div class="preview-bg-layer">
            ${avatarContent}
        </div>
        ${frameHtml}
    `;
};
                
                const updateControls = () => {
                    const frame = settings[settingsKey];
                    sizeSlider.value = frame?.size || 100;
                    sizeValue.textContent = `${sizeSlider.value}%`;
                    xSlider.value = frame?.offsetX || 0;
                    xValue.textContent = `${xSlider.value}px`;
                    ySlider.value = frame?.offsetY || 0;
                    yValue.textContent = `${ySlider.value}px`;
                    updatePreview();
                };
                
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 1024 * 1024) {
                        showNotification('Â§¥ÂÉèÊ°ÜÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá1MB', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (!settings[settingsKey]) {
                            settings[settingsKey] = { size: 100, offsetX: 0, offsetY: 0 };
                        }
                        settings[settingsKey].src = event.target.result;
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        throttledSaveData();
                    };
                    reader.readAsDataURL(file);
                });
                
                removeBtn.addEventListener('click', () => {
                    settings[settingsKey] = null;
                    applyAvatarFrame(avatarContainer, null);
                    updateControls();
                    throttledSaveData();
                });

                [sizeSlider, xSlider, ySlider].forEach(slider => {
                    slider.addEventListener('input', () => {
                        if (!settings[settingsKey]) return;
                        settings[settingsKey].size = parseInt(sizeSlider.value);
                        settings[settingsKey].offsetX = parseInt(xSlider.value);
                        settings[settingsKey].offsetY = parseInt(ySlider.value);
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        renderMessages(true); 
                    });
                     slider.addEventListener('change', throttledSaveData);
                });

                updateControls();
            };
            
            setupControlsFor('my');
            setupControlsFor('partner');
        }

        function applyAllAvatarFrames() {
            applyAvatarFrame(DOMElements.me.avatarContainer, settings.myAvatarFrame);
            applyAvatarFrame(DOMElements.partner.avatarContainer, settings.partnerAvatarFrame);
            // Apply shape presets
            applyAvatarShapeToDOM('my', settings.myAvatarShape || 'circle');
            applyAvatarShapeToDOM('partner', settings.partnerAvatarShape || 'circle');
        }

        function applyAvatarShapeToDOM(type, shape) {
            const SHAPES = ['circle','square','pentagon','heart'];
            const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
            if (!avatarContainer) return;
            SHAPES.forEach(s => avatarContainer.classList.remove('avatar-shape-' + s));
            if (shape && shape !== 'none') avatarContainer.classList.add('avatar-shape-' + shape);
            // Also update all in-chat message avatars via re-render flag
            document.querySelectorAll('.message-avatar').forEach(el => {
                SHAPES.forEach(s => el.classList.remove('shape-' + s));
            });
        }

        function setupAppearancePanelFrameSettings() {
            const setupFor = (type) => {
                const suffix = '-2';
                const preview = document.getElementById(`${type}-frame-preview${suffix}`);
                const uploadBtn = document.getElementById(`${type}-frame-upload-btn${suffix}`);
                const removeBtn = document.getElementById(`${type}-frame-remove-btn${suffix}`);
                const fileInput = document.getElementById(`${type}-frame-file-input${suffix}`);
                const sizeSlider = document.getElementById(`${type}-frame-size${suffix}`);
                const sizeValue = document.getElementById(`${type}-frame-size-value${suffix}`);
                const xSlider = document.getElementById(`${type}-frame-offset-x${suffix}`);
                const xValue = document.getElementById(`${type}-frame-offset-x-value${suffix}`);
                const ySlider = document.getElementById(`${type}-frame-offset-y${suffix}`);
                const yValue = document.getElementById(`${type}-frame-offset-y-value${suffix}`);
                if (!preview || !uploadBtn) return;

                const settingsKey = type === 'my' ? 'myAvatarFrame' : 'partnerAvatarFrame';
                const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
                const avatarElement = type === 'my' ? DOMElements.me.avatar : DOMElements.partner.avatar;

                const updatePreview2 = () => {
                    let avatarContent = avatarElement.innerHTML;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = avatarContent;
                    const img = tempDiv.querySelector('img');
                    if (img) avatarContent = `<img src="${img.src}" alt="preview">`;
                    const frameSettings = settings[settingsKey];
                    let frameHtml = '';
                    if (frameSettings && frameSettings.src) {
                        const size = frameSettings.size || 100;
                        const ox = frameSettings.offsetX || 0;
                        const oy = frameSettings.offsetY || 0;
                        frameHtml = `<img src="${frameSettings.src}" class="preview-frame" style="width:${size}%;height:${size}%;transform:translate(calc(-50% + ${ox}px),calc(-50% + ${oy}px));">`;
                    }
                    preview.innerHTML = `<div class="preview-bg-layer">${avatarContent}</div>${frameHtml}`;
                };

                const updateControls2 = () => {
                    const frame = settings[settingsKey];
                    if (sizeSlider) { sizeSlider.value = frame?.size || 100; sizeValue.textContent = `${sizeSlider.value}%`; }
                    if (xSlider) { xSlider.value = frame?.offsetX || 0; xValue.textContent = `${xSlider.value}px`; }
                    if (ySlider) { ySlider.value = frame?.offsetY || 0; yValue.textContent = `${ySlider.value}px`; }
                    updatePreview2();
                };

                uploadBtn.addEventListener('click', () => fileInput && fileInput.click());
                if (fileInput) fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    if (file.size > 1024 * 1024) { showNotification('ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá1MB', 'error'); return; }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        if (!settings[settingsKey]) settings[settingsKey] = { size: 100, offsetX: 0, offsetY: 0 };
                        settings[settingsKey].src = ev.target.result;
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls2(); throttledSaveData();
                    };
                    reader.readAsDataURL(file);
                });
                if (removeBtn) removeBtn.addEventListener('click', () => {
                    settings[settingsKey] = null;
                    applyAvatarFrame(avatarContainer, null);
                    updateControls2(); throttledSaveData();
                });
                [sizeSlider, xSlider, ySlider].forEach(s => {
                    if (!s) return;
                    s.addEventListener('input', () => {
                        if (!settings[settingsKey]) return;
                        settings[settingsKey].size = parseInt(sizeSlider.value);
                        settings[settingsKey].offsetX = parseInt(xSlider.value);
                        settings[settingsKey].offsetY = parseInt(ySlider.value);
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls2(); renderMessages(true);
                    });
                    s.addEventListener('change', throttledSaveData);
                });
                updateControls2();
            };
            setupFor('my');
            setupFor('partner');
        }
        const themeColorMappings = {
            '--primary-bg': '‰∏ªËÉåÊôØËâ≤',
            '--secondary-bg': 'Âç°Áâá / ÂºπÁ™óËÉåÊôØ',
            '--header-bg': 'È°∂Ê†èËÉåÊôØ',
            '--input-area-bg': 'ËæìÂÖ•Âå∫ËÉåÊôØ',
            '--text-primary': '‰∏ªË¶ÅÊñáÂ≠ó',
            '--text-secondary': 'Ê¨°Ë¶ÅÊñáÂ≠ó / Âç†‰ΩçÁ¨¶',
            '--border-color': 'ËæπÊ°Ü / ÂàÜÂâ≤Á∫ø',
            '--accent-color': '‰∏ªÂº∫Ë∞ÉËâ≤ÔºàÊåâÈíÆ / ÂõæÊ†áÔºâ',
            '--accent-color-dark': 'Âº∫Ë∞ÉËâ≤Ê∑±Ëâ≤Âèò‰Ωì',
            '--message-sent-bg': 'ÊàëÊñπÊ∞îÊ≥°ËÉåÊôØ',
            '--message-sent-text': 'ÊàëÊñπÊ∞îÊ≥°ÊñáÂ≠ó',
            '--message-received-bg': 'ÂØπÊñπÊ∞îÊ≥°ËÉåÊôØ',
            '--message-received-text': 'ÂØπÊñπÊ∞îÊ≥°ÊñáÂ≠ó',
            '--favorite-color': 'Êî∂ËóèÊòüÊ†áÈ¢úËâ≤',
        };

        const themeExtraMappings = {
            '--radius': { label: 'ÂúÜËßíÂçäÂæÑ', type: 'range', min: 0, max: 32, unit: 'px', default: '16px' },
            '--message-font-weight': { label: 'Ê∂àÊÅØÁ≤óÁªÜ', type: 'select', options: ['300','400','500','600','700'], default: '400' },
            '--message-line-height': { label: 'Ê∂àÊÅØË°åÈ´ò', type: 'range', min: 1.0, max: 2.5, step: 0.05, unit: '', default: '1.5' },
        };


function initThemeEditor() {
    const openEditorBtn = document.getElementById('open-theme-editor');
    
    if (openEditorBtn) {
        const newBtn = openEditorBtn.cloneNode(true);
        openEditorBtn.parentNode.replaceChild(newBtn, openEditorBtn);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log("Ëá™ÂÆö‰πâ‰∏ªÈ¢òÁºñËæëÂô®ÊåâÈíÆË¢´ÁÇπÂáªÔºÅ");
            
            const appearanceModal = document.getElementById('appearance-modal');
            const editorModal = document.getElementById('theme-editor-modal');

            if (appearanceModal) hideModal(appearanceModal);
            
            populateThemeEditor();
            populateThemeSelector();
            
            if (editorModal) showModal(editorModal);
        });
    }

    const closeBtn = document.getElementById('close-theme-editor');
    if (closeBtn) {
        closeBtn.onclick = () => {
            hideModal(document.getElementById('theme-editor-modal'));
            updateUI();
        };
    }
    
    const saveBtn = document.getElementById('save-theme-preset-btn');
    if(saveBtn) saveBtn.onclick = saveCurrentThemeAsPreset;

    const overwriteBtn = document.getElementById('overwrite-theme-preset-btn');
    if(overwriteBtn) overwriteBtn.onclick = function() {
        const selector = document.getElementById('theme-preset-selector');
        const selectedId = selector && selector.value;
        if (!selectedId || !selectedId.startsWith('custom-')) {
            showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ëá™ÂÆö‰πâÊñπÊ°àÂÜçË¶ÜÁõñ', 'warning');
            return;
        }
        const theme = customThemes.find(t => t.id === selectedId);
        if (!theme) return;
        if (!confirm(`Á°ÆÂÆöË¶ÅÁî®ÂΩìÂâçÁºñËæëÂÜÖÂÆπË¶ÜÁõñ„Äå${theme.name}„ÄçÂêóÔºü`)) return;
        const root = document.documentElement;
        theme.colors = {};
        for (const variable of Object.keys(themeColorMappings)) {
            const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
            if (val) theme.colors[variable] = val.trim();
        }
        for (const variable of Object.keys(themeExtraMappings)) {
            const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
            if (val) theme.colors[variable] = val.trim();
        }
        saveCustomThemes();
        showNotification(`Â∑≤Ë¶ÜÁõñ„Äå${theme.name}„Äç`, 'success');
    };
    
    const renameBtn = document.getElementById('rename-theme-preset-btn');
    if(renameBtn) renameBtn.onclick = () => {
        const selector = document.getElementById('theme-preset-selector');
        const selectedId = selector && selector.value;
        if (!selectedId || !selectedId.startsWith('custom-')) {
            showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ëá™ÂÆö‰πâÊñπÊ°àÂÜçÈáçÂëΩÂêç', 'warning');
            return;
        }
        const theme = customThemes.find(t => t.id === selectedId);
        if (!theme) return;
        const newName = prompt('ËæìÂÖ•Êñ∞ÂêçÁß∞Ôºö', theme.name);
        if (!newName || !newName.trim()) return;
        theme.name = newName.trim();
        saveCustomThemes();
        populateThemeSelector();
        showNotification(`Â∑≤ÈáçÂëΩÂêç‰∏∫„Äå${newName}„Äç`, 'success');
    };

    const delBtn = document.getElementById('delete-theme-preset-btn');
    if(delBtn) delBtn.onclick = deleteCurrentPreset;

    const selector = document.getElementById('theme-preset-selector');
    if(selector) {
        selector.onchange = (e) => {
            const selectedValue = e.target.value;
            const owBtn = document.getElementById('overwrite-theme-preset-btn');
            if (owBtn) owBtn.style.display = selectedValue.startsWith('custom-') ? '' : 'none';
            if (selectedValue === "current-editing") return;
            
            if (selectedValue.startsWith('custom-')) {
                const theme = customThemes.find(t => t.id === selectedValue);
                if (theme) {
                    settings.colorTheme = theme.id;
                    applyTheme(theme.colors);
                    populateThemeEditor(theme.colors);
                    throttledSaveData();
                }
            }
        };
    }
}
        function populateThemeEditor(currentColors = null) {
            const grid = document.getElementById('theme-editor-grid');
            grid.innerHTML = '';
            const rootStyle = getComputedStyle(document.documentElement);

            const colorHeading = document.createElement('div');
            colorHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:4px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;';
            colorHeading.textContent = 'üé® È¢úËâ≤';
            grid.appendChild(colorHeading);

            for (const [variable, label] of Object.entries(themeColorMappings)) {
                const rawVal = currentColors ? currentColors[variable] : rootStyle.getPropertyValue(variable).trim();
                let colorValue = rawVal;
                if (!colorValue || colorValue.includes('var(')) {
                    colorValue = '#888888';
                } else if (colorValue.startsWith('rgb')) {
                    try {
                        const m = colorValue.match(/\d+/g);
                        if (m && m.length >= 3) {
                            colorValue = '#' + [m[0],m[1],m[2]].map(n => parseInt(n).toString(16).padStart(2,'0')).join('');
                        }
                    } catch(e) { colorValue = '#888888'; }
                }
                const item = document.createElement('div');
                item.className = 'color-picker-item';
                item.innerHTML = `<label for="color-${variable.replace(/--/g,'')}">${label}</label><input type="color" id="color-${variable.replace(/--/g,'')}" data-variable="${variable}" value="${colorValue}">`;
                grid.appendChild(item);
                item.querySelector('input[type="color"]').addEventListener('input', (e) => {
                    document.documentElement.style.setProperty(e.target.dataset.variable, e.target.value);
                });
            }

            const extraHeading = document.createElement('div');
            extraHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:8px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;margin-top:8px;';
            extraHeading.textContent = '‚öôÔ∏è Êï∞ÂÄº & Â≠óÈáç';
            grid.appendChild(extraHeading);

            for (const [variable, cfg] of Object.entries(themeExtraMappings)) {
                const rawVal = rootStyle.getPropertyValue(variable).trim() || cfg.default;
                const numVal = parseFloat(rawVal);
                const item = document.createElement('div');
                item.style.cssText = 'grid-column:1/-1;display:flex;align-items:center;gap:10px;background:var(--primary-bg);padding:8px;border-radius:8px;';
                if (cfg.type === 'range') {
                    item.innerHTML = `
                        <label style="font-size:13px;flex:1;">${cfg.label}</label>
                        <input type="range" min="${cfg.min}" max="${cfg.max}" step="${cfg.step||1}" value="${numVal||parseFloat(cfg.default)}"
                            data-variable="${variable}" data-unit="${cfg.unit}"
                            style="flex:2;max-width:140px;accent-color:var(--accent-color);">
                        <span style="width:44px;text-align:right;font-size:12px;color:var(--text-secondary);">${numVal||parseFloat(cfg.default)}${cfg.unit}</span>`;
                    const rangeInput = item.querySelector('input[type="range"]');
                    const valLabel = item.querySelector('span');
                    rangeInput.addEventListener('input', () => {
                        const v = rangeInput.value + cfg.unit;
                        document.documentElement.style.setProperty(variable, v);
                        valLabel.textContent = rangeInput.value + cfg.unit;
                        // Sync settings
                        if (variable === '--radius') { settings.borderRadius = rangeInput.value; throttledSaveData && throttledSaveData(); }
                        if (variable === '--message-line-height') { settings.messageLineHeight = parseFloat(rangeInput.value); throttledSaveData && throttledSaveData(); }
                    });
                } else if (cfg.type === 'select') {
                    const opts = cfg.options.map(o => `<option value="${o}" ${String(numVal||cfg.default)===o?'selected':''}>${o}</option>`).join('');
                    item.innerHTML = `<label style="font-size:13px;flex:1;">${cfg.label}</label><select data-variable="${variable}" style="padding:5px 10px;border-radius:8px;border:1px solid var(--border-color);background:var(--secondary-bg);color:var(--text-primary);font-size:13px;cursor:pointer;">${opts}</select>`;
                    item.querySelector('select').addEventListener('change', (e) => {
                        const newVal = e.target.value;
                        document.documentElement.style.setProperty(variable, newVal);
                        // Sync to settings if it maps to a known settings key
                        if (variable === '--message-font-weight') { settings.messageFontWeight = newVal; throttledSaveData && throttledSaveData(); }
                        if (variable === '--message-line-height') { settings.messageLineHeight = parseFloat(newVal); throttledSaveData && throttledSaveData(); }
                    });
                }
                grid.appendChild(item);
            }

            const previewHeading = document.createElement('div');
            previewHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:8px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;margin-top:8px;';
            previewHeading.textContent = 'üëÅ ÂÆûÊó∂È¢ÑËßà';
            grid.appendChild(previewHeading);

            const previewBox = document.createElement('div');
            previewBox.style.cssText = 'grid-column:1/-1;background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);';
            previewBox.innerHTML = `
                <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:12px;color:#fff;"></i>
                    </div>
                    <div class="message message-received" style="max-width:180px;font-size:var(--font-size);">‰Ω†ÊòØÊàëÊúùÂ§ïÁõ∏‰º¥Ëß¶ÊâãÂèØÂèäÁöÑËôöÊãü</div>
                </div>
                <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                    <div class="message message-sent" style="max-width:180px;font-size:var(--font-size);">‰Ω†ÊòØÊàëÊú™ÊõæÊã•ÊúâÊó†Ê≥ïÊçïÊçâÁöÑ‰∫≤Êòµ</div>
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--border-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:12px;color:var(--text-secondary);"></i>
                    </div>
                </div>`;
            grid.appendChild(previewBox);
        }

        function applyTheme(colors, isReset = false) {
            if (isReset) {
                for (const variable of Object.keys(themeColorMappings)) {
                    document.documentElement.style.removeProperty(variable);
                }
                return;
            }
            if (!colors) return;
            for (const [variable, color] of Object.entries(colors)) {
                document.documentElement.style.setProperty(variable, color);
            }
        }
        
        function saveCurrentThemeAsPreset() {
            const presetName = prompt("ËØ∑ËæìÂÖ•Êñ∞‰∏ªÈ¢òÊñπÊ°àÁöÑÂêçÁß∞Ôºö");
            if (!presetName || !presetName.trim()) return;

            const newTheme = {
                id: `custom-${Date.now()}`,
                name: presetName.trim(),
                colors: {}
            };
            const root = document.documentElement;
            for (const variable of Object.keys(themeColorMappings)) {
                const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
                if (val) newTheme.colors[variable] = val.trim();
            }
            for (const variable of Object.keys(themeExtraMappings)) {
                const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
                if (val) newTheme.colors[variable] = val.trim();
            }
            customThemes.push(newTheme);
            settings.colorTheme = newTheme.id;
            saveCustomThemes();
            populateThemeSelector();
            showNotification(`‰∏ªÈ¢ò "${presetName}" Â∑≤‰øùÂ≠ò`, "success");
        }

        function deleteCurrentPreset() {
            const selector = document.getElementById('theme-preset-selector');
            const selectedId = selector.value;
            if (!selectedId.startsWith('custom-')) {
                showNotification('Êó†Ê≥ïÂà†Èô§È¢ÑËÆæ‰∏ªÈ¢ò', 'warning');
                return;
            }
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§‰∏ªÈ¢ò "${selector.options[selector.selectedIndex].text}" ÂêóÔºü`)) {
                customThemes = customThemes.filter(t => t.id !== selectedId);
                settings.colorTheme = 'gold'; 
                saveCustomThemes();
                updateUI();
                populateThemeSelector();
                populateThemeEditor(); 
                showNotification('‰∏ªÈ¢òÂ∑≤Âà†Èô§', 'success');
            }
        }

function populateThemeSelector() {
    const selector = document.getElementById('theme-preset-selector');
    selector.innerHTML = '';

    const defaultOption = document.createElement('option');
    defaultOption.value = "current-editing";
    defaultOption.textContent = "ÂΩìÂâçÁºñËæë‰∏≠...";
    selector.appendChild(defaultOption);

    if (customThemes.length > 0) {
        const customGroup = document.createElement('optgroup');
        customGroup.label = "ÊàëÁöÑËá™ÂÆö‰πâ‰∏ªÈ¢ò";
        customThemes.forEach(theme => {
            const option = document.createElement('option');
            option.value = theme.id;
            option.textContent = theme.name;
            customGroup.appendChild(option);
        });
        selector.appendChild(customGroup);
    }

    if (settings.colorTheme.startsWith('custom-')) {
        selector.value = settings.colorTheme;
    } else {
        selector.value = "current-editing";
    }
    const overwriteBtn = document.getElementById('overwrite-theme-preset-btn');
    if (overwriteBtn) overwriteBtn.style.display = selector.value.startsWith('custom-') ? '' : 'none';
}
        
        function saveCustomThemes() {
             safeSetItem(`${APP_PREFIX}customThemes`, JSON.stringify(customThemes));
        }

        const THEME_COLOR_NAMES = {
            'gold': 'ÈáëËâ≤', 'blue': 'ËìùËâ≤', 'purple': 'Á¥´Ëâ≤', 'green': 'ÁªøËâ≤',
            'pink': 'Á≤âËâ≤', 'black-white': 'ÈªëÁôΩ', 'pastel': 'ÊüîËìù', 
            'sunset': 'Â§ïÈò≥', 'forest': 'Ê£ÆÊûó', 'ocean': 'Ê∑±Ëìù'
        };
        const BUBBLE_STYLE_NAMES_SCM = { standard: 'Ê†áÂáÜ', rounded: 'ÂúÜËßí', 'rounded-large': 'Â§ßÂúÜËßí', square: 'ÊñπÂΩ¢' };

        async function captureCurrentSchemeAsync() {
            const root = document.documentElement;
            let chatBg = '';
            try {
                chatBg = await localforage.getItem(getStorageKey('chatBackground')) || '';
            } catch(e) {
                chatBg = safeGetItem(getStorageKey('chatBackground')) || '';
            }
            return {
                colorTheme: settings.colorTheme,
                isDarkMode: settings.isDarkMode,
                bubbleStyle: settings.bubbleStyle,
                fontSize: settings.fontSize,
                messageFontFamily: settings.messageFontFamily,
                messageFontWeight: settings.messageFontWeight,
                messageLineHeight: settings.messageLineHeight,
                customFontUrl: settings.customFontUrl || '',
                customBubbleCss: settings.customBubbleCss || '',
                inChatAvatarEnabled: settings.inChatAvatarEnabled,
                inChatAvatarSize: settings.inChatAvatarSize,
                chatBackground: chatBg,
                customColors: (() => {
                    const colors = {};
                    const mapped = Object.keys(themeColorMappings || {});
                    mapped.forEach(v => {
                        const val = root.style.getPropertyValue(v);
                        if (val) colors[v] = val.trim();
                    });
                    return colors;
                })()
            };
        }

        function captureCurrentScheme() {
            const root = document.documentElement;
            const chatBg = safeGetItem(getStorageKey('chatBackground')) || '';
            
            return {
                colorTheme: settings.colorTheme,
                isDarkMode: settings.isDarkMode,
                bubbleStyle: settings.bubbleStyle,
                fontSize: settings.fontSize,
                messageFontFamily: settings.messageFontFamily,
                messageFontWeight: settings.messageFontWeight,
                messageLineHeight: settings.messageLineHeight,
                customFontUrl: settings.customFontUrl || '',
                customBubbleCss: settings.customBubbleCss || '',
                inChatAvatarEnabled: settings.inChatAvatarEnabled,
                inChatAvatarSize: settings.inChatAvatarSize,
                chatBackground: chatBg,
                customColors: (() => {
                    const colors = {};
                    const mapped = Object.keys(themeColorMappings || {});
                    mapped.forEach(v => {
                        const val = root.style.getPropertyValue(v);
                        if (val) colors[v] = val.trim();
                    });
                    return colors;
                })()
            };
        }

        function applyScheme(scheme) {
            settings.colorTheme = scheme.colorTheme;
            settings.isDarkMode = scheme.isDarkMode;
            settings.bubbleStyle = scheme.bubbleStyle;
            settings.fontSize = scheme.fontSize;
            settings.messageFontFamily = scheme.messageFontFamily;
            settings.messageFontWeight = scheme.messageFontWeight;
            settings.messageLineHeight = scheme.messageLineHeight;
            settings.customFontUrl = scheme.customFontUrl || '';
            settings.customBubbleCss = scheme.customBubbleCss || '';
            settings.inChatAvatarEnabled = scheme.inChatAvatarEnabled;
            settings.inChatAvatarSize = scheme.inChatAvatarSize;
            
            const root = document.documentElement;
            if (scheme.customColors && Object.keys(scheme.customColors).length > 0) {
                Object.entries(scheme.customColors).forEach(([v, c]) => {
                    root.style.setProperty(v, c);
                });
            } else {
                if (themeColorMappings) {
                    Object.keys(themeColorMappings).forEach(v => root.style.removeProperty(v));
                }
            }
            
            if (scheme.customFontUrl) {
                try { applyCustomFont(scheme.customFontUrl); } catch(e) {}
            } else {
                document.documentElement.style.setProperty('--message-font-family', scheme.messageFontFamily || "'Noto Serif SC', serif");
                document.documentElement.style.setProperty('--font-family', scheme.messageFontFamily || "'Noto Serif SC', serif");
            }
            
            if (scheme.customBubbleCss) {
                try { applyCustomBubbleCss(scheme.customBubbleCss); } catch(e) {}
            }
            
            if (scheme.chatBackground) {
                applyBackground(scheme.chatBackground);
                safeSetItem(getStorageKey('chatBackground'), scheme.chatBackground);
            }

            updateUI();
            throttledSaveData();
            renderThemeSchemesList();
        }

        function getSchemePreviewColors(scheme) {
            const colorMap = {
                gold: ['#c5a47e', '#f5f5f5', '#333333'],
                blue: ['#7FA6CD', '#e8f0f8', '#333333'],
                purple: ['#BB9EC7', '#f3eef7', '#333333'],
                green: ['#7BC8A4', '#edf8f3', '#333333'],
                pink: ['#F4A6B3', '#fef0f3', '#333333'],
                'black-white': ['#333333', '#f9f9f9', '#666666'],
                pastel: ['#A8D8EA', '#edf7fc', '#333333'],
                sunset: ['#FF9A8B', '#fff0ee', '#333333'],
                forest: ['#7BA05B', '#eef5e8', '#333333'],
                ocean: ['#4A90E2', '#e8f1fc', '#333333'],
            };
            const theme = scheme.colorTheme;
            if (theme && theme.startsWith('custom-')) {
                const c = scheme.customColors && scheme.customColors['--accent-color'];
                return [c || '#aaa', scheme.isDarkMode ? '#222' : '#f5f5f5', '#888'];
            }
            return colorMap[theme] || ['#aaa', '#f5f5f5', '#888'];
        }

        function renderThemeSchemesList() {
            const list = document.getElementById('theme-schemes-list');
            const empty = document.getElementById('theme-schemes-empty');
            if (!list) return;
            
            list.querySelectorAll('.theme-scheme-item').forEach(el => el.remove());
            
            if (themeSchemes.length === 0) {
                if (empty) empty.style.display = 'flex';
                return;
            }
            if (empty) empty.style.display = 'none';
            
            themeSchemes.forEach(scheme => {
                const dots = getSchemePreviewColors(scheme);
                const bubbleName = BUBBLE_STYLE_NAMES_SCM[scheme.bubbleStyle] || 'Ê†áÂáÜ';
                const darkLabel = scheme.isDarkMode ? 'Â§ú' : 'Êòº';
                const themeName = THEME_COLOR_NAMES[scheme.colorTheme] || scheme.colorTheme;
                const meta = `${darkLabel} ¬∑ ${themeName} ¬∑ ${bubbleName} ¬∑ ${scheme.fontSize}px`;
                
                const item = document.createElement('div');
                item.className = 'theme-scheme-item';
                item.dataset.schemeId = scheme.id;
                item.innerHTML = `
                    <div class="scheme-preview-dots">
                        ${dots.map(c => `<div class="scheme-dot" style="background:${c};"></div>`).join('')}
                    </div>
                    <div class="scheme-info">
                        <div class="scheme-name">${scheme.name}</div>
                        <div class="scheme-meta">${meta}</div>
                    </div>
                    <div class="scheme-actions">
                        <button class="scheme-action-btn" title="Â∫îÁî®ÊñπÊ°à" onclick="applyThemeScheme('${scheme.id}')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="scheme-action-btn" title="Âú®ÁºñËæëÂô®‰∏≠ÁºñËæë" onclick="editThemeScheme('${scheme.id}', event)" style="color:var(--accent-color);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="scheme-action-btn delete" title="Âà†Èô§ÊñπÊ°à" onclick="deleteThemeScheme('${scheme.id}', event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.applyThemeScheme = function(id) {
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            applyScheme(scheme);
            showNotification(`‚ú® Â∑≤Â∫îÁî®ÊñπÊ°à„Äå${scheme.name}„Äç`, 'success');
        };

        window.deleteThemeScheme = function(id, event) {
            if (event) event.stopPropagation();
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÊñπÊ°à„Äå${scheme.name}„ÄçÂêóÔºü`)) {
                themeSchemes = themeSchemes.filter(s => s.id !== id);
                localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes);
                renderThemeSchemesList();
                showNotification('ÊñπÊ°àÂ∑≤Âà†Èô§', 'success');
            }
        };

        window.editThemeScheme = function(id, event) {
            if (event) event.stopPropagation();
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            applyScheme(scheme);
            const appearanceModal = document.getElementById('appearance-modal');
            const editorModal = document.getElementById('theme-editor-modal');
            if (appearanceModal) hideModal(appearanceModal);
            populateThemeEditor(scheme.customColors && Object.keys(scheme.customColors).length > 0 ? scheme.customColors : null);
            populateThemeSelector();
            if (editorModal) showModal(editorModal);
            const selector = document.getElementById('theme-preset-selector');
            if (selector && scheme.id.startsWith('custom-')) selector.value = scheme.id;
            showNotification(`Ê≠£Âú®ÁºñËæëÊñπÊ°à„Äå${scheme.name}„ÄçÔºå‰øÆÊîπÂêéÁÇπÂáªüíæ‰øùÂ≠ò`, 'info');
        };

        function initThemeSchemes() {
            const saveBtn = document.getElementById('save-theme-scheme-btn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const name = prompt('ËØ∑‰∏∫ÂΩìÂâç‰∏ªÈ¢òÊñπÊ°àÂëΩÂêçÔºö', `ÊñπÊ°à ${themeSchemes.length + 1}`);
                    if (!name || !name.trim()) return;
                    const scheme = await captureCurrentSchemeAsync();
                    scheme.id = `scheme-${Date.now()}`;
                    scheme.name = name.trim();
                    scheme.savedAt = Date.now();
                    themeSchemes.push(scheme);
                    localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes);
                    renderThemeSchemesList();
                    showNotification(`‚ú® ÊñπÊ°à„Äå${name}„ÄçÂ∑≤‰øùÂ≠òÔºàÂê´ËÉåÊôØÂõæÔºâÔºÅ`, 'success');
                };
            }
            renderThemeSchemesList();
        }

document.addEventListener('DOMContentLoaded', async () => {
    const loaderBar = document.getElementById('loader-tech-bar');
    const welcomeSubtitle = document.querySelector('.welcome-subtitle-scramble');
    const welcomeScreen = document.getElementById('welcome-animation');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const acceptDisclaimerBtn = document.getElementById('accept-disclaimer');

    const updateLoader = (text, width) => {
        if (welcomeSubtitle) welcomeSubtitle.textContent = text;
        if (loaderBar) loaderBar.style.width = width;
    };

    const hideWelcomeScreen = () => {
        if (!welcomeScreen) return;
        welcomeScreen.classList.add('hidden');
        setTimeout(() => {
            welcomeScreen.style.display = 'none';
        }, 800);
    };

    const safeAwait = async (promise, fallback = null) => {
        try {
            return await promise;
        } catch (error) {
            console.error('Êìç‰ΩúÂ§±Ë¥•:', error);
            return fallback;
        }
    };

    try {
        safeAwait(Promise.all([
            setupEventListeners?.(),
            initThemeEditor?.(),
            initAnniversaryModule?.(),
            initMoodListeners?.(),
            initDecisionModule?.(),
            initComboMenu?.()
        ]));

        if (typeof localforage === 'undefined') {
            console.warn('LocalForage Êú™Âä†ËΩΩÔºåÂ∞Ü‰ΩøÁî® localStorage ÈôçÁ∫ßÊñπÊ°à');
        }

        updateLoader('Ê≠£Âú®Âª∫Á´ãÂÆâÂÖ®ËøûÊé•...', '10%');
        await safeAwait(initializeSession());

        updateLoader('Ê≠£Âú®ËØªÂèñËÆ∞ÂøÜÂ≠òÊ°£...', '40%');
        await safeAwait(loadData());

        updateLoader('Ê≠£Âú®Ê∏≤ÊüìÊàë‰ª¨ÁöÑ‰∏ñÁïå...', '70%');
        
        await Promise.allSettled([
            safeAwait(initializeRandomUI?.()),
            safeAwait(initMusicPlayer?.())
        ]);

        setInterval(checkStatusChange, 60000);

        if (disclaimerModal) {
            const tourSeen = await safeAwait(localforage?.getItem(APP_PREFIX + 'tour_seen'), false);
            
            if (!tourSeen) {
                showModal(disclaimerModal);
                
                if (acceptDisclaimerBtn) {
                    acceptDisclaimerBtn.addEventListener('click', () => {
                        hideModal(disclaimerModal);
                        startTour?.();
                    }, { once: true }); 
                }
            }
        }

        updateLoader('ËøûÊé•ÊàêÂäüÔºåÊ¨¢ËøéÂõûÊù•„ÄÇ', '100%');
        setTimeout(hideWelcomeScreen, 3500);

        setTimeout(async () => {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        showNotification('Â∑≤ÂºÄÂêØÁ≥ªÁªüÈÄöÁü•ÔºåÊî∂Âà∞Ê∂àÊÅØÊó∂‰ºöÊèêÈÜí‰Ω† ‚ú®', 'success', 3000);
                    }
                } catch(e) {
                    console.warn('ÈÄöÁü•ÊùÉÈôêËØ∑Ê±ÇÂ§±Ë¥•:', e);
                }
            }
        }, 3000);

    } catch (err) {
        console.error('‰∏•ÈáçÂàùÂßãÂåñÈîôËØØ:', err);
        updateLoader('Âä†ËΩΩÈÅáÂà∞ÈóÆÈ¢òÔºåÂ∑≤Âº∫Âà∂ËøõÂÖ•...', '100%');
        setTimeout(hideWelcomeScreen, 3500);
    }
});
const stickerInput = document.getElementById('sticker-file-input');
            if (stickerInput) {
                stickerInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;

                    const oversized = files.filter(f => f.size > 2 * 1024 * 1024);
                    if (oversized.length > 0) {
                        showNotification(oversized.length + ' Âº†ÂõæÁâáË∂ÖËøá 2MB ÈôêÂà∂ÔºåÂ∑≤Ë∑≥Ëøá', 'warning');
                    }

                    const validFiles = files.filter(f => f.size <= 2 * 1024 * 1024);
                    if (!validFiles.length) return;

                    showNotification('Ê≠£Âú®ÊâπÈáèÂ§ÑÁêÜ ' + validFiles.length + ' Âº†ÂõæÁâá...', 'info');

                    let successCount = 0;
                    let failCount = 0;

                    for (const file of validFiles) {
                        try {
                            const base64 = await optimizeImage(file, 300, 0.8);
                            stickerLibrary.push(base64);
                            successCount++;
                        } catch (err) {
                            console.error(err);
                            failCount++;
                        }
                    }

                    throttledSaveData();
                    renderReplyLibrary();

                    if (failCount > 0) {
                        showNotification('‰∏ä‰º†ÂÆåÊàêÔºö' + successCount + ' Âº†ÊàêÂäüÔºå' + failCount + ' Âº†Â§±Ë¥•', 'warning');
                    } else {
                        showNotification('‰∏ä‰º†ÊàêÂäüÔºåÂÖ± ' + successCount + ' Âº†', 'success');
                    }

                    e.target.value = '';
                });
            }
const tourOverlay = document.getElementById('tour-overlay');
const tourPopover = document.getElementById('tour-popover');
const tourHighlightBox = document.getElementById('tour-highlight-box');
const tourTitle = document.getElementById('tour-title');
const tourContent = document.getElementById('tour-content');
const tourStepCounter = document.getElementById('tour-step-counter');
const tourNextBtn = document.getElementById('tour-next-btn');
const tourPrevBtn = document.getElementById('tour-prev-btn');
const tourSkipBtn = document.getElementById('tour-skip-btn');

let currentTourStep = 0;
let isTourActive = false;

const tourSteps = [
    {
        title: "‚ú® Ê¨¢ËøéÊù•Âà∞„Äå‰º†ËÆØ„Äç",
        content: "ËøôÈáåÊòØ‰Ω†‰ª¨‰∏ìÂ±ûÁöÑÁßÅÂØÜÁ©∫Èó¥„ÄÇ<br><br>Ëøô‰∏™ÊïôÁ®ãÂÖ± <b>20 Ê≠•</b>ÔºåÂ∏¶‰Ω†‰ªéÂ§¥Âà∞Â∞æËÆ§ËØÜÊØè‰∏Ä‰∏™ÂäüËÉΩÔºåÂª∫ËÆÆÂÆåÊï¥ÁúãÂÆåÂì¶ü•∫<br><br>ÁÇπÂáª„Äå‰∏ã‰∏ÄÊ≠•„ÄçÂºÄÂßãÂêßÔºÅ",
        position: 'center'
    },
    {
        element: '#my-avatar',
        title: "üì∑ ‰Ω†ÁöÑÂ§¥ÂÉè",
        content: "ËøôÊòØ<b>‰Ω†ÁöÑÂ§¥ÂÉè</b>„ÄÇ<br><br>ÁÇπÂáªÂÆÉÂèØ‰ª•‰∏ä‰º†ÂõæÁâá‰Ωú‰∏∫‰Ω†ÁöÑÂ§¥ÂÉè„ÄÇ",
        position: 'bottom'
    },
    {
        element: '#my-name',
        title: "‚úèÔ∏è ‰Ω†ÁöÑÊòµÁß∞",
        content: "ËøôÈáåÊòæÁ§∫ÁöÑÊòØ<b>‰Ω†ÁöÑÂêçÂ≠ó</b>„ÄÇ<br><br>ÁÇπÂáªÂêçÂ≠óÂèØ‰ª•Áõ¥Êé•‰øÆÊîπ„ÄÇ",
        position: 'bottom'
    },
    {
        element: '#my-status-container',
        title: "üí¨ ‰Ω†ÁöÑÁä∂ÊÄÅÁ≠æÂêç",
        content: "ËøôÈáåÊòØ‰Ω†ÁöÑ<b>Áä∂ÊÄÅÁ≠æÂêç</b>„ÄÇ<br><br>ÁÇπÂáªÂèØ‰ª•ÁºñËæëÔºå‰∏ÄËà¨ËÄåË®ÄÂØπÊñπÊòØËÉΩÁúãËßÅÁöÑÂì¶ÔΩû",
        position: 'bottom'
    },
    {
        element: '#partner-avatar',
        title: "Ta ÁöÑÂ§¥ÂÉè",
        content: "ËøôÈáåÊòØ<b>Ê¢¶ËßíÁöÑÂ§¥ÂÉè</b>ÔºåÂêåÊ†∑ÁÇπÂáªÂèØ‰ª•‰∏ä‰º†Êõ¥Êç¢„ÄÇ",
        position: 'bottom'
    },
    {
        element: '#partner-name',
        title: "Ta ÁöÑÊòµÁß∞",
        content: "ËøôÊòØ<b>Ê¢¶ËßíÁöÑÊòµÁß∞</b>ÔºåÂêåÊ†∑ÁÇπÂáªÂèØ‰ª•‰øÆÊîπ„ÄÇ",
        position: 'bottom'
    },
    {
        element: '.header-motto',
        title: "üå∏ È°∂ÈÉ®Ê†ºË®Ä",
        content: "ËøôÈáåÊòæÁ§∫ÁùÄÊ†ºË®ÄÔΩûËá™ÂÆö‰πâÂõûÂ§çÈáåÂèØ‰øÆÊîπ„ÄÇ",
        position: 'bottom'
    },
    {
        element: '#message-input',
        title: "‚å®Ô∏è Ê∂àÊÅØËæìÂÖ•Ê°Ü",
        content: "Âú®ËøôÈáå<b>ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù</b>ÔºåÊåâÂõûËΩ¶ÈîÆÊàñÁÇπÂáªÂè≥ËæπÁöÑÂèëÈÄÅÊåâÈíÆÂ∞±ËÉΩÂèëÂá∫Âéª„ÄÇ",
        position: 'top'
    },
    {
        element: '#send-btn',
        title: "üöÄ ÂèëÈÄÅÊ∂àÊÅØ",
        content: "ÁÇπÂáªËøô‰∏™<b>Á∫∏È£ûÊú∫ÊåâÈíÆ</b>Â∞±ËÉΩÂèëÈÄÅÊ∂àÊÅØ„ÄÇ<br><br>ÂèëÈÄÅÂêéÂØπÊñπ‰ºöÂú®Âá†ÁßíÂÜÖÁªô‰Ω†ÂõûÂ§çÔºå‰Ω†ÂèØ‰ª•Âú®„ÄåËÅäÂ§©ËÆæÁΩÆ„ÄçÈáåË∞ÉÊï¥ÂõûÂ§çÁöÑÈÄüÂ∫¶Âø´ÊÖ¢Âì¶„ÄÇ",
        position: 'top'
    },
    {
        element: '#attachment-btn',
        title: "üñºÔ∏è ÂèëÈÄÅÂõæÁâá / Ë°®ÊÉÖÂåÖ",
        content: "ÁÇπÂáªËøôÈáåÂèØ‰ª•<b>ÂèëÈÄÅÂõæÁâá</b>ÔºåÊîØÊåÅÁõ∏ÂÜåÂõæÁâáÂíåË°®ÊÉÖÂåÖ„ÄÇ<br><br>‰Ω†ËøòÂèØ‰ª•Âú®„ÄåÈ´òÁ∫ßÂäüËÉΩ ‚Üí ÂõûÂ§çÂ∫ì„Äç‰∏≠‰∏ä‰º†Ëá™ÂÆö‰πâÁöÑË°®ÊÉÖÔºåÂà∞Êó∂ÂÄôÂØπÊñπ‰πü‰ºöÂèëÁªô‰Ω†ÔºÅ",
        position: 'top'
    },
    {
        element: '#poke-btn',
        title: "üëã Êãç‰∏ÄÊãç‰∫íÂä®",
        content: "ËøôÊòØ„Äå<b>Êãç‰∏ÄÊãç</b>„ÄçÂäüËÉΩÔºåÂèëÂá∫Âêé‰ºöÊòæÁ§∫‰∏ÄÊù°‰∫íÂä®Ê∂àÊÅØÔºåÊØîÂ¶Ç„ÄåËΩªÊãç‰∫Ü‰Ω†‰∏Ä‰∏ã„Äç„ÄÇ<br><br>ÂèØ‰ª•Âú®„ÄåÈ´òÁ∫ßÂäüËÉΩ ‚Üí Ëá™ÂÆö‰πâÊãç‰∏ÄÊãç„ÄçÈáåÊ∑ªÂä†Êõ¥Â§öÁöÑÂä®‰ΩúÔºÅ",
        position: 'top'
    },
    {
        element: '#continue-btn',
        title: "ËÆ© Ta ÁªßÁª≠ËØ¥",
        content: "‰∏çÁü•ÈÅìËØ¥‰ªÄ‰πà‰∫ÜÔºüÊàñËÄÖÊÉ≥ËÆ© Ta Â§öËØ¥Âá†Âè•Ôºü<br><br>ÁÇπÂáªËøô‰∏™ÊåâÈíÆÔºå<b>Ê¢¶Ëßí‰ºö‰∏ªÂä®Êâæ‰Ω†ËØ¥ËØù„ÄÇ",
        position: 'top'
    },
    {
        element: '#batch-btn',
        title: "üì¶ ÊâπÈáèÂèëÈÄÅÊ®°Âºè",
        content: "ÂºÄÂêØ<b>ÊâπÈáèÊ®°Âºè</b>ÂêéÔºå‰Ω†ÂèØ‰ª•ÂÖàÂÜôÂ•ΩÂ§öÊù°Ê∂àÊÅØÔºåÂÜç‰∏ÄÊ¨°ÊÄßÂÖ®ÈÉ®ÂèëÂá∫Âéª<br><br>ÁÇπÂáªÊåâÈíÆÂºÄÂêØÔºåÁºñËæëÂÆåÊàêÂêéÂÜçÊ¨°ÁÇπÂáª„ÄåÂèëÈÄÅÂÖ®ÈÉ®„ÄçÂç≥ÂèØ„ÄÇ",
        position: 'top'
    },
    {
        element: '#settings-btn',
        title: "‚öôÔ∏è ËÆæÁΩÆ‰∏≠ÂøÉ",
        content: "ÊâÄÊúâ‰∏™ÊÄßÂåñÈÖçÁΩÆÈÉΩÂú®Ëøô‰∏™<b>ËÆæÁΩÆÊåâÈíÆ</b>ÈáåÔºåÊàë‰ª¨ÁÇπËøõÂéªÁúã‰∏Ä‰∏ãÔºÅ<br>",
        position: 'bottom',
        onBefore: () => { if (isTourActive) document.querySelectorAll('.modal').forEach(m => hideModal(m)); }
    },
    {
        element: '#appearance-settings',
        title: "üé® Â§ñËßÇËÆæÁΩÆ",
        content: "<b>Â§ñËßÇËÆæÁΩÆ</b>ÈáåÂèØ‰ª•Ôºö<br>‚Ä¢ ÂàáÊç¢ 10 Ê¨æ‰∏ªÈ¢òÈÖçËâ≤ÔºàÈáë/Ëìù/Á≤â‚Ä¶Ôºâ<br>‚Ä¢ Ë∞ÉÊï¥Â≠ó‰ΩìÂ§ßÂ∞è<br>‚Ä¢ Êõ¥Êç¢ËÅäÂ§©ËÉåÊôØÂõæ<br>‚Ä¢ Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè CSS<br>",
        position: 'bottom',
        onBefore: () => { if (isTourActive) showModal(DOMElements.settingsModal.modal); }
    },
    {
        element: '#chat-settings',
        title: "üí¨ ËÅäÂ§©ËÆæÁΩÆ",
        content: "<b>ËÅäÂ§©ËÆæÁΩÆ</b>ÈáåÂèØ‰ª•Ë∞ÉÊï¥Ôºö<br>‚Ä¢ Ê∂àÊÅØÈü≥ÊïàÂºÄÂÖ≥<br>‚Ä¢ Â∑≤ËØªÂõûÊâßÊòæÁ§∫<br>‚Ä¢ ÂØπÊñπÂõûÂ§çÈÄüÂ∫¶ÔºàÂø´/ÊÖ¢Ôºâ<br>‚Ä¢ Ê∂àÊÅØÊ∞îÊ≥°Ê†∑ÂºèÔºàÂúÜËßí/ÊñπÂΩ¢Ôºâ",
        position: 'bottom'
    },
    {
        element: '#advanced-settings',
        title: "üöÄ È´òÁ∫ßÂäüËÉΩ ‚Äî ÂøÖÁúãÔºÅ",
        content: "<b>È´òÁ∫ßÂäüËÉΩ</b>ÊòØÊï¥‰∏™Â∫îÁî®ÊúÄÂº∫Â§ßÁöÑÊùøÂùóÔºåÈáåÈù¢ÊúâÔºö<br>‚Ä¢ <b>ÂøÉÊô¥ÊâãË¥¶</b>ÔºöËÆ∞ÂΩïÊØèÂ§©ÁöÑÂøÉÊÉÖ<br>‚Ä¢ <b>‰ø°Â∞ÅÊäïÈÄí</b>ÔºöÁªôÊ¢¶ËßíÂÜô‰∏ÄÂ∞Å‰ø°<br>‚Ä¢ <b>Á∫™ÂøµÊó•</b>ÔºöÂÄíËÆ°Êó∂ / Á∫™ÂøµÂ§©Êï∞<br>‚Ä¢ <b>ËøêÂäøÂç†Âçú</b>ÔºöÊØèÊó•ËøêÂäø<br>‚Ä¢ <b>Ëá™ÂÆö‰πâÂõûÂ§ç</b>ÔºöËÆ©Ê¢¶ËßíËØ¥‰Ω†ÊÉ≥Âê¨ÁöÑËØù<br>‚Ä¢ <b>Èü≥‰πêÊí≠ÊîæÂô®</b>ÔºöËÉåÊôØÈü≥‰πê",
        position: 'bottom'
    },
    {
        element: '#data-settings',
        title: "üíæ Êï∞ÊçÆÁÆ°ÁêÜ",
        content: "<b>Êï∞ÊçÆÁÆ°ÁêÜ</b>ÈáåÂèØ‰ª•Ôºö<br>‚Ä¢ ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩïÔºàÂ§á‰ªΩÂà∞Êú¨Âú∞Ôºâ<br>‚Ä¢ ÂØºÂÖ•‰πãÂâçÂ§á‰ªΩÁöÑËÆ∞ÂΩï<br>‚Ä¢ Êü•ÁúãÂ≠òÂÇ®Á©∫Èó¥Âç†Áî®<br>‚Ä¢ ÂºÄÂêØÂêéÂè∞Ê∂àÊÅØÈÄöÁü•Êé®ÈÄÅ<br>‚Ä¢ ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ<br>‚Ä¢ ÈáçÊîæÊú¨ÊïôÁ®ã",
        position: 'top'
    },
    {
        element: '#theme-toggle',
        title: "üåô Êó• / Â§úÊ®°ÂºèÂàáÊç¢",
        content: "Ëøô‰∏™ÊåâÈíÆÂèØ‰ª•Âø´ÈÄü<b>ÂàáÊç¢ÁôΩÂ§© / Â§úÊôö</b>Ê®°Âºè„ÄÇ<br><br>Â§úÊôöÊ®°Âºè‰∏ãÊï¥‰ΩìÂèòÊàêÊ∑±Ëâ≤ËÉåÊôØÔºåÂØπÁúºÁùõÊõ¥ÂèãÂ•ΩÔºåÁù°ÂâçËÅäÂ§©ÂøÖÂ§áÔºÅ‚ú®",
        position: 'bottom',
        onBefore: () => { if (isTourActive) hideModal(DOMElements.settingsModal.modal); }
    },
    {
        element: '#favorites-btn',
        title: "‚≠ê Êî∂ËóèÂ§π",
        content: "ÈïøÊåâÊàñÁÇπÂáª‰∏ÄÊù°Ê∂àÊÅØÔºå‰ºöÂºπÂá∫Êìç‰ΩúËèúÂçïÔºåÂèØ‰ª•ÊääÊ∂àÊÅØ<b>Êî∂Ëóè</b>Ëµ∑Êù•„ÄÇ<br><br>ÊâÄÊúâÊî∂ËóèÁöÑÊ∂àÊÅØÈÉΩ‰ºö‰øùÂ≠òÂú®Ëøô‰∏™Êî∂ËóèÂ§πÈáåÔºåÈöèÊó∂ÂèØ‰ª•ÁøªÈòÖÂõûÂë≥ÔΩû",
        position: 'bottom'
    },
    {
        element: '#session-manager-btn',
        title: "üìÇ ‰ºöËØùÁÆ°ÁêÜ",
        content: "‰Ω†ÂèØ‰ª•ÂàõÂª∫<b>Â§ö‰∏™Áã¨Á´ãÁöÑËÅäÂ§©‰ºöËØù</b>ÔºåÊØè‰∏™‰ºöËØùÈÉΩÊúâÁã¨Á´ãÁöÑËÅäÂ§©ËÆ∞ÂΩï„ÄÇ<br>",
        position: 'bottom'
    },
    {
        title: "‚úã Ê∂àÊÅØÊìç‰ΩúÊèêÁ§∫",
        content: "ÁÇπÂáª‰ªªÊÑè‰∏ÄÊù°Ê∂àÊÅØÔºå‰ºöÂá∫Áé∞Êìç‰ΩúËèúÂçïÔºö<br>‚Ä¢ ‚≠ê <b>Êî∂Ëóè</b>Ôºö‰øùÂ≠òÂà∞Êî∂ËóèÂ§π<br>‚Ä¢ ‚Ü©Ô∏è <b>ÂõûÂ§ç</b>ÔºöÂºïÁî®ËøôÊù°Ê∂àÊÅØÂõûÂ§ç<br>‚Ä¢ üìù <b>Ê≥®Èáä</b>ÔºöÁªôÊ∂àÊÅØÊ∑ªÂä†Â§áÊ≥®<br>‚Ä¢ üóëÔ∏è <b>Âà†Èô§</b>ÔºöÂà†Èô§ËøôÊù°Ê∂àÊÅØ",
        position: 'center'
    },
    {
        title: "üéâ ‰Ω†Â∑≤ÊéåÊè°ÊâÄÊúâÂäüËÉΩÔºÅ",
        content: "ÊÅ≠Âñú‰Ω†ÂÆåÊàê‰∫ÜÊñ∞ÊâãÂºïÂØºÔºÅÁé∞Âú®‰Ω†Â∑≤Áªè‰∫ÜËß£‰∫Ü„Äå‰º†ËÆØ„ÄçÁöÑÂÖ®ÈÉ®ÂäüËÉΩ„ÄÇ<br><br>Â∏åÊúõ‰Ω†‰ª¨Âú®ËøôÈáåÊî∂Ëé∑Êª°Êª°ÁöÑÁà±‰∏éÂπ∏Á¶è ü•∫üíï",
        position: 'center'
    }
];

function startTour() {
    isTourActive = true;
    tourOverlay.style.display = 'block';
    setTimeout(() => tourOverlay.classList.add('active'), 10);
    currentTourStep = 0;
    showTourStep(currentTourStep);
}

function endTour() {
    isTourActive = false;
    tourOverlay.classList.remove('active');
    tourPopover.classList.remove('visible');
    setTimeout(() => {
        tourOverlay.style.display = 'none';
        tourHighlightBox.style.width = '0px';
        tourHighlightBox.style.height = '0px';
        tourHighlightBox.style.opacity = '0';
    }, 300);
    localforage.setItem(APP_PREFIX + 'tour_seen', 'true');
    document.querySelectorAll('.modal').forEach(m => hideModal(m));
    setTimeout(function() {
        if (typeof window.tryShowDailyGreeting === 'function') {
            window.tryShowDailyGreeting();
        }
    }, 900);
}

function showTourStep(index) {
    if (index < 0 || index >= tourSteps.length) {
        endTour();
        return;
    }
    const step = tourSteps[index];
    if (step.onBefore) {
        step.onBefore();
    }
    setTimeout(() => {
        tourTitle.textContent = step.title;
        tourContent.innerHTML = step.content;
        tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
        tourPopover.classList.remove('visible');
        tourPrevBtn.style.visibility = (index === 0) ? 'hidden' : 'visible';
        if (index === tourSteps.length - 1) {
            tourNextBtn.innerHTML = 'ÂÆåÊàê <i class="fas fa-check"></i>';
        } else {
            tourNextBtn.innerHTML = '‰∏ã‰∏ÄÊ≠• <i class="fas fa-arrow-right"></i>';
        }
        const targetElement = step.element ? document.querySelector(step.element) : null;
        if (targetElement) {
            const rect = targetElement.getBoundingClientRect();
            tourHighlightBox.style.width = `${rect.width + 10}px`;
            tourHighlightBox.style.height = `${rect.height + 10}px`;
            tourHighlightBox.style.top = `${rect.top - 5}px`;
            tourHighlightBox.style.left = `${rect.left - 5}px`;
            tourHighlightBox.style.opacity = '1';
            positionPopover(rect, step.position);
        } else {
            tourHighlightBox.style.opacity = '0';
            tourHighlightBox.style.width = '0px';
            tourHighlightBox.style.height = '0px';
            tourPopover.style.top = '50%';
            tourPopover.style.left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
        }
        setTimeout(() => tourPopover.classList.add('visible'), 50);
    }, (step.onBefore ? 400 : 0));
}

function positionPopover(rect, position) {
    const popoverRect = tourPopover.getBoundingClientRect();
    const spacing = 15;
    let top, left;
    switch (position) {
        case 'top':
            top = rect.top - popoverRect.height - spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'bottom':
            top = rect.bottom + spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'left':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.left - popoverRect.width - spacing;
            break;
        case 'right':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.right + spacing;
            break;
        default:
            top = '50%';
            left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
            tourPopover.style.top = top;
            tourPopover.style.left = left;
            return;
    }
    if (top < 10) top = 10;
    if (left < 10) left = 10;
    if (left + popoverRect.width > window.innerWidth - 10) {
        left = window.innerWidth - popoverRect.width - 10;
    }
    if (top + popoverRect.height > window.innerHeight - 10) {
        top = window.innerHeight - popoverRect.height - 10;
    }
    tourPopover.style.top = `${top}px`;
    tourPopover.style.left = `${left}px`;
    tourPopover.style.transform = 'none';
}

function nextTourStep() {
    currentTourStep++;
    showTourStep(currentTourStep);
}

async function createNewSession(switchToIt = true) {
    const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    const newSession = {
        id: newId,
        name: `‰ºöËØù ${new Date().toLocaleDateString()}`,
        createdAt: Date.now()
    };

    sessionList.push(newSession);
    await localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

    if (switchToIt) {
        window.location.hash = newId;
        window.location.reload();
    }
    
    return newId;
}

window.selectAnnType = function(type) {
    currentAnniversaryType = type;
    currentAnnType = type; 
    document.querySelectorAll('.anniversary-type-btn').forEach(btn => {
        if(btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const hint = document.getElementById('ann-type-desc');
    if(hint) {
        hint.textContent = type === 'anniversary' 
            ? 'ËÆ°ÁÆó‰ªéËøáÂéªÊüê‰∏ÄÂ§©Âà∞Áé∞Âú®Â∑≤ÁªèËøá‰∫ÜÂ§öÂ∞ëÂ§© (‰æãÂ¶Ç: ÊÅãÁà±Á∫™ÂøµÊó•)' 
            : 'ËÆ°ÁÆó‰ªéÁé∞Âú®Âà∞Êú™Êù•Êüê‰∏ÄÂ§©ËøòÂâ©‰∏ãÂ§öÂ∞ëÂ§© (‰æãÂ¶Ç: ÂØπÊñπÁîüÊó•)';
    }
};

window.deleteAnniversary = function(id, event) {
    if(event) event.stopPropagation();
    
    if(confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫™ÂøµÊó•ÂêóÔºü')) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData();
        renderAnniversariesList();
        showNotification('Á∫™ÂøµÊó•Â∑≤Âà†Èô§', 'success');
    }
};

let activeAnnId = null;

async function fillAnnHeaderCard(ann) {
    const headerCard = document.getElementById('ann-header-card');
    const toolbar = document.getElementById('ann-card-toolbar');
    if (!ann || !headerCard) return;

    activeAnnId = ann.id;
    headerCard.style.display = 'block';
    if (toolbar) toolbar.style.display = 'flex';

    const now = new Date();
    const isCountdown = ann.type === 'countdown';
    const targetDate = new Date(ann.date);
    let diffDays;
    if (isCountdown) {
        diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) diffDays = 0;
    } else {
        diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) diffDays = 0;
    }

    const iconEl = document.getElementById('ann-header-icon');
    const labelEl = document.getElementById('ann-header-label');
    if (iconEl) iconEl.textContent = isCountdown ? '‚ô°' : '‚ô•';
    if (labelEl) labelEl.textContent = isCountdown ? 'COUNTDOWN' : 'ANNIVERSARY';
    document.getElementById('ann-header-title').textContent = ann.name;
    document.getElementById('ann-header-date').textContent = ann.date;
    const daysEl = document.getElementById('ann-header-days');
    daysEl.innerHTML = `${diffDays.toLocaleString('zh-CN')}<span class="ann-header-days-unit">${isCountdown ? 'Â§©Âêé' : 'Â§©'}</span>`;

    const milestonesEl = document.getElementById('ann-header-milestones');
    if (milestonesEl) {
        milestonesEl.innerHTML = '';
        if (!isCountdown) {
            const milestones = [];
            if (diffDays >= 100) { const n = Math.floor(diffDays / 100); milestones.push(`üéâ Á¨¨ ${n * 100} Â§©`); }
            if (diffDays >= 365) { const n = Math.floor(diffDays / 365); milestones.push(`üéä ${n} Âë®Âπ¥`); }
            if (diffDays > 0 && diffDays < 100) { milestones.push(`üí´ Ë∑ù 100 Â§©ËøòÊúâ ${100 - diffDays} Â§©`); }
            milestones.forEach(m => milestonesEl.insertAdjacentHTML('beforeend', `<span class="ann-milestone-chip">${m}</span>`));
        }
    }

    const bgEl = document.getElementById('ann-header-card-bg');
    if (bgEl) {
        const savedBg = await localforage.getItem(getStorageKey(`annHeaderBg_${ann.id}`));
        bgEl.style.backgroundImage = savedBg ? `url(${savedBg})` : '';
    }

    document.querySelectorAll('.ann-item-card').forEach(el => el.classList.remove('ann-item-active'));
    const activeEl = document.querySelector(`.ann-item-card[data-ann-id="${ann.id}"]`);
    if (activeEl) activeEl.classList.add('ann-item-active');
}

function renderAnniversariesList() {
    const listContainer = document.getElementById('ann-list-container');
    const headerCard = document.getElementById('ann-header-card');
    const toolbar = document.getElementById('ann-card-toolbar');
    
    if (!listContainer) return;
    listContainer.innerHTML = '';

    anniversaries.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (anniversaries.length === 0) {
        if (headerCard) headerCard.style.display = 'none';
        if (toolbar) toolbar.style.display = 'none';
        listContainer.innerHTML = `
            <div class="ann-empty">
                <div class="ann-empty-icon">üíù</div>
                <p>ËøòÊ≤°ÊúâÁ∫™ÂøµÊó•<br>ÂéªÊ∑ªÂä†‰∏Ä‰∏™Â±û‰∫é‰Ω†‰ª¨ÁöÑÊó•Â≠êÂêß~</p>
            </div>`;
        return;
    }

    const now = new Date();
    const defaultAnn = anniversaries.find(a => a.type === 'anniversary') || anniversaries[0];
    fillAnnHeaderCard(defaultAnn);

    anniversaries.forEach(ann => {
        const targetDate = new Date(ann.date);
        let diffDays = 0;
        let typeClass = '';
        let typeLabel = '';
        let dayLabel = '';

        if (ann.type === 'countdown') {
            typeClass = 'type-future';
            typeLabel = 'ÂÄíÊï∞';
            dayLabel = 'Â§©Âêé';
            diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            if(diffDays < 0) diffDays = 0;
        } else {
            typeClass = 'type-past';
            typeLabel = 'Â∑≤Ëøá';
            dayLabel = 'Â§©';
            diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
        }

        const formattedDays = diffDays.toLocaleString('zh-CN');

        const html = `
            <div class="ann-item-card ${typeClass}" data-ann-id="${ann.id}" onclick="selectAnnCard(${ann.id})" style="cursor:pointer;">
                <div class="ann-item-left">
                    <div class="ann-item-name">${ann.name}</div>
                    <div class="ann-item-date">
                        <span class="ann-tag">${typeLabel}</span>
                        ${ann.date}
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="ann-item-right">
                        <div class="ann-item-days">${formattedDays}</div>
                        <div class="ann-item-days-unit">${dayLabel}</div>
                    </div>
                    <div class="ann-delete-btn" onclick="event.stopPropagation(); deleteAnniversaryItem(${ann.id})">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', html);
    });
}

window.selectAnnCard = function(id) {
    const ann = anniversaries.find(a => a.id === id);
    if (ann) fillAnnHeaderCard(ann);
};

window.clearAnnCardBg = async function() {
    if (!activeAnnId) return;
    await localforage.removeItem(getStorageKey(`annHeaderBg_${activeAnnId}`));
    const bgEl = document.getElementById('ann-header-card-bg');
    if (bgEl) bgEl.style.backgroundImage = '';
    showNotification('Â∞ÅÈù¢ÂõæÂ∑≤Ê∏ÖÈô§', 'success');
};


function initAnniversaryModule() {
    const entryBtn = document.getElementById('anniversary-function');
    
    if (entryBtn) {
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        
        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('ÈáçË¶ÅÊó•ÊåâÈíÆË¢´ÁÇπÂáª');
            
            const advancedModal = document.getElementById('advanced-modal');
            const annModal = document.getElementById('anniversary-modal');
            
            if (advancedModal) hideModal(advancedModal);
            renderAnniversariesList();
            if (annModal) showModal(annModal);
        });
    }

    const closeBtn = document.getElementById('close-anniversary-modal');
    if (closeBtn) {
        const newClose = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newClose, closeBtn);
        newClose.addEventListener('click', () => hideModal(document.getElementById('anniversary-modal')));
    }

    const openAddBtn = document.getElementById('open-ann-add-btn');
    const editorSlide = document.getElementById('ann-editor-slide');
    if (openAddBtn) {
        openAddBtn.onclick = () => {
            document.getElementById('ann-input-name').value = '';
            document.getElementById('ann-input-date').value = '';
            window.selectAnnType('anniversary');
            if (editorSlide) editorSlide.classList.add('active');
        };
    }

    const closeEditorBtn = document.getElementById('close-ann-editor');
    if (closeEditorBtn) {
        closeEditorBtn.onclick = () => {
            if (editorSlide) editorSlide.classList.remove('active');
        };
    }

    const saveBtn = document.getElementById('save-ann-btn');
    if (saveBtn) {
        const newSave = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSave, saveBtn);
        
        newSave.addEventListener('click', () => {
            addAnniversary(); 
            if (editorSlide) editorSlide.classList.remove('active');
        });
    }

    const annBgInput = document.getElementById('ann-header-bg-input');
    if (annBgInput) {
        annBgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!activeAnnId) { showNotification('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Á∫™ÂøµÊó•', 'warning'); return; }
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const dataUrl = ev.target.result;
                const bgEl = document.getElementById('ann-header-card-bg');
                if (bgEl) bgEl.style.backgroundImage = `url(${dataUrl})`;
                await localforage.setItem(getStorageKey(`annHeaderBg_${activeAnnId}`), dataUrl);
                showNotification('Â∞ÅÈù¢ÂõæÂ∑≤Êõ¥Êñ∞ ', 'success');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });
    }
}
function prevTourStep() {
    currentTourStep--;
    showTourStep(currentTourStep);
}

function setupTutorialListeners() {
    tourNextBtn.addEventListener('click', nextTourStep);
    tourPrevBtn.addEventListener('click', prevTourStep);
    tourSkipBtn.addEventListener('click', endTour);

    const replayBtn = document.getElementById('replay-tutorial-btn');
    if(replayBtn) {
        replayBtn.addEventListener('click', () => {
            hideModal(DOMElements.dataModal.modal);
            setTimeout(() => {
                if (confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÊñ∞ÊâãÂºïÂØºÊïôÁ®ãÂêóÔºü')) {
                    startTour();
                }
            }, 300);
        });
    }
}

    </script>

<div id="daily-greeting-modal" class="hidden">
    <div class="daily-greeting-card" id="daily-greeting-card">
        <!-- Header band with image support -->
        <div class="dg-header-band" id="dg-header-band">
            <div class="dg-header-band-bg" id="dg-header-band-bg"></div>
            <div class="dg-header-band-overlay" id="dg-header-band-overlay"></div>
            <div class="dg-header-band-shimmer"></div>
            <input type="file" id="dg-header-img-input" accept="image/*" style="display:none">
            <div class="dg-header-top">
                <div class="dg-emoji-circle" id="dg-emoji">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-header-text">
                    <div class="dg-festival-label" id="dg-festival">GOOD MORNING</div>
                    <div class="dg-main-title" id="dg-title">Êó©‰∏äÂ•Ω</div>
                </div>
            </div>
            <div class="dg-date-stamp" id="dg-date-stamp">‚Äî ‰ªäÊó•ÂÖ¨ÂëäÂ∑≤ÈÄÅËææ ‚Äî</div>
        </div>
        <!-- Custom banner image removed per design update - use dg-deco-img in body instead -->
        <!-- Body -->
        <div class="dg-body">
            <div class="dg-section-label" id="dg-section-label-partner">Ê¢¶Ëßí‰ªäÊó•Áä∂ÊÄÅ</div>
            <!-- Mood panel -->
            <div class="dg-mood-panel" id="dg-mood-panel">
                <div class="dg-mood-icon-big" id="dg-partner-mood-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-mood-info">
                    <div class="dg-mood-name" id="dg-partner-mood">ËøòÊ≤°ÊúâËÆ∞ÂΩï‰ªäÊó•ÂøÉÊÉÖ</div>
                    <div class="dg-mood-sub" id="dg-partner-mood-note"></div>
                </div>
            </div>
            <!-- Info grid -->
            <div class="dg-info-grid">
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-weather-label"</>Ê¢¶ËßíÁöÑÂ§©Ê∞î</div>
                    <div class="dg-info-cell-val" id="dg-weather" onclick="startEditDgWeather(this)" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;" title="ÁÇπÂáªÁºñËæë">Êô¥Êúó</div>
                </div>
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-status-label">Ê¢¶ËßíÁöÑÁä∂ÊÄÅ</div>
                    <div class="dg-info-cell-val" id="dg-status">‰∏ÄÂàáÈÉΩÂ•Ω</div>
                </div>
            </div>
            <!-- Custom decoration image -->
            <div id="dg-deco-img-wrap" style="display:none; margin-bottom:12px; border-radius:12px; overflow:hidden;">
                <img id="dg-deco-img" src="" alt="" style="width:100%; max-height:160px; object-fit:cover; display:block; border-radius:12px;">
            </div>
            <!-- Note -->
            <div class="dg-note-box" id="dg-note">
                <div class="dg-note-inner">
                    <div class="dg-note-weather-badge" id="dg-note-weather-badge" style="display:none;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        <span id="dg-note-weather-text"></span>
                    </div>
                    <div id="dg-note-text">‰ªäÂ§©‰πüË¶ÅÂÖÉÊ∞îÊª°Êª°ÔºåÊàëÂú®ËøôÈáåÈô™ÁùÄ‰Ω† ‚ú¶</div>
                </div>
            </div>
            <!-- Buttons -->
            <div class="dg-footer">
                <button class="daily-greeting-close-btn" onclick="closeDailyGreeting()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:-2px;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
                    Áü•ÈÅì‰∫ÜÔºåÂºÄÂßã‰ªäÂ§©
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Daily Greeting Editor Modal (stub, editing now in custom replies > ‰ªäÊó•ÂÖ¨Âëä) -->
<div id="dg-editor-modal" style="display:none;"></div>

<script>
window._dailyGreetingReady = false;

function _getDailyGreetingData() {
    var now = new Date();
    var month = now.getMonth() + 1;
    var day = now.getDate();
    var hour = now.getHours();

    var timeLabel = 'Êó©‰∏äÂ•Ω', timeEmoji = 'üåÖ';
    if (hour >= 12 && hour < 18) { timeLabel = '‰∏ãÂçàÂ•Ω'; timeEmoji = '‚òÄÔ∏è'; }
    else if (hour >= 18 && hour < 22) { timeLabel = 'ÂÇçÊôöÂ•Ω'; timeEmoji = 'üåá'; }
    else if (hour >= 22 || hour < 6) { timeLabel = 'Êôö‰∏äÂ•Ω'; timeEmoji = 'üåô'; }

var festivals = [
    { m:1, d:1, name:'ÂÖÉÊó¶', emoji:'üéÜ', label:'NEW YEAR', note:'Êñ∞Âπ¥Âø´‰πêÔºÅÊÑøÊñ∞ÁöÑ‰∏ÄÂπ¥ÈáåÔºå‰Ω†‰ª¨ÁöÑÁà±ÊÉÖË∂äÊù•Ë∂äÁîúËúúÔºåÊØè‰∏ÄÂ§©ÈÉΩÂÖÖÊª°Âπ∏Á¶è‰∏éÊÉäÂñúÔΩû' },
    { m:1, d:5, name:'Â∞èÂØí', emoji:'‚ùÑÔ∏è', label:'MINOR COLD', note:'Â∞èÂØíËá≥ÔºåÊò•‰∏çËøú„ÄÇÊúâ‰Ω†Âú®Ë∫´ËæπÔºåÂøÉÈáåÊÄªÊòØÊöñÊöñÁöÑ„ÄÇ' },
    { m:1, d:20, name:'Â§ßÂØí', emoji:'üßä', label:'MAJOR COLD', note:'Â§ßÂØíÂø´‰πêÔºåËÆ∞ÂæóÊ∑ªË°£‰øùÊöñ„ÄÇ‰Ω†ÁöÑÊã•Êä±Â∞±ÊòØÊúÄÊöñÁöÑÁÇâÁÅ´„ÄÇ' },

    { m:2, d:4, name:'Á´ãÊò•', emoji:'üå±', label:'START OF SPRING', note:'Á´ãÊò•Âø´‰πêÔºÅÊò•Â§©Êù•‰∫ÜÔºåÊàë‰ª¨ÁöÑÁà±‰πüÂÉèÊñ∞ËäΩ‰∏ÄÊ†∑Ëì¨ÂãÉÁîüÈïø„ÄÇ' },
    { m:2, d:14, name:'ÊÉÖ‰∫∫ËäÇ', emoji:'üíù', label:'VALENTINES DAY', note:'ÊÉÖ‰∫∫ËäÇÂø´‰πêÔºå‰∫≤Áà±ÁöÑÔºÅ‰Ω†ÊòØÊàëÊúÄÁæéÂ•ΩÁöÑÁ§ºÁâ©ÔºåÁà±‰Ω†Âì¶ÔΩû' },
    { m:2, d:16, name:'Èô§Â§ï', emoji:'üßß', label:'CHINESE NEW YEAR EVE', note:'Èô§Â§ïÂø´‰πêÔºÅËæûÊóßËøéÊñ∞ÔºåÊÑø‰Ω†‰ª¨Êê∫ÊâãË∑®ÂÖ•Âπ∏Á¶èÁöÑÊñ∞‰∏ÄÂπ¥Ôºå‰∏á‰∫ãÂ¶ÇÊÑèÔºÅ' },
    { m:2, d:17, name:'Êò•ËäÇ', emoji:'üéä', label:'SPRING FESTIVAL', note:'Êñ∞Âπ¥Âø´‰πêÔºÅÊñ∞ÁöÑ‰∏ÄÂπ¥ÔºåÊÑø‰Ω†‰ª¨Áõ∏Áà±Â¶ÇÂàùÔºåÁîúËúúÈïø‰πÖ„ÄÇ' },
    { m:2, d:18, name:'Èõ®Ê∞¥', emoji:'‚òî', label:'RAIN WATER', note:'Èõ®Ê∞¥ËäÇÊ∞îÔºåÊÑøÂπ∏Á¶èÂÉèÊò•Èõ®‰∏ÄÊ†∑ÊªãÊ∂¶‰Ω†ÁöÑÊØè‰∏ÄÂ§©„ÄÇ' },

    { m:3, d:3, name:'ÂÖÉÂÆµËäÇ', emoji:'üèÆ', label:'LANTERN FESTIVAL', note:'ÂÖÉÂÆµËäÇÂø´‰πêÔºÅËä±ÁÅØÊò†ÊúàÔºå‰Ω†ÊòØÊàëÂøÉÈáåÊúÄ‰∫ÆÁöÑÈÇ£ÁõèÁÅØ„ÄÇ' },
    { m:3, d:5, name:'ÊÉäËõ∞', emoji:'‚ö°', label:'AWAKENING OF INSECTS', note:'ÊÉäËõ∞Êò•Èõ∑ÂìçÔºå‰∏áÁâ©Â§çËãèÔºå‰Ω†ÊòØÊàëÊúÄÁæéÁöÑÊò•Â§©„ÄÇ' },
    { m:3, d:8, name:'Â¶áÂ•≥ËäÇ', emoji:'üåπ', label:'WOMENS DAY', note:'‰ªäÂ§©ÊòØÂ±û‰∫é‰Ω†ÁöÑËäÇÊó•ÔºåÊÑø‰Ω†Ê∞∏ËøúË¢´Ê∏©ÊüîÁõ∏ÂæÖÔºåË¢´Áà±ÂÆàÊä§„ÄÇ' },
    { m:3, d:12, name:'Ê§çÊ†ëËäÇ', emoji:'üå≥', label:'TREE PLANTING DAY', note:'‰ªäÂ§©Áßç‰∏ã‰∏ÄÊ£µÊ†ëÔºå‰πüÂú®ÂøÉÈáåÁßç‰∏ãÂØπ‰Ω†‰∏çÂèòÁöÑÁà±„ÄÇ' },
    { m:3, d:20, name:'Êò•ÂàÜ', emoji:'üå∏', label:'SPRING EQUINOX', note:'Êò•ÂàÜÊòºÂ§úÂπ≥ÂàÜÔºåÊàëÁöÑÁà±ÂØπ‰Ω†‰ªé‰∏çÂÅèÂøÉ‚Äî‚ÄîÊ∞∏ËøúÊª°ÂàÜ„ÄÇ' },

    { m:4, d:1, name:'ÊÑö‰∫∫ËäÇ', emoji:'ü§°', label:'APRIL FOOLS', note:'‰ªäÂ§©ÂèØ‰ª•È™ó‰Ω†ËØ¥‚ÄúÊàë‰∏çÁà±‰Ω†‰∫Ü‚ÄùÔºå‰ΩÜÊàëÁöÑÂøÉÈ™ó‰∏ç‰∫ÜËá™Â∑±ÔΩû' },
    { m:4, d:5, name:'Ê∏ÖÊòéËäÇ', emoji:'üåß', label:'QINGMING FESTIVAL', note:'ÊÖéÁªàËøΩËøúÔºåÁèçÊÉúÁúºÂâç„ÄÇÊúâ‰Ω†Âú®ÔºåÊØè‰∏ÄÂ§©ÈÉΩÊ†ºÂ§ñÊ∏©Êöñ„ÄÇ' },
    { m:4, d:20, name:'Ë∞∑Èõ®', emoji:'üåæ', label:'GRAIN RAIN', note:'Ë∞∑Èõ®ÁîüÁôæË∞∑Ôºå‰Ω†ÊòØÊàëÁîüÂëΩÈáåÊúÄÈ•±Êª°ÁöÑÈÇ£È¢ó„ÄÇ' },

    { m:5, d:1, name:'Âä≥Âä®ËäÇ', emoji:'üõ†Ô∏è', label:'LABOR DAY', note:'Âä≥Âä®ÊúÄÂÖâËç£Ôºå‰ΩÜÊàëÊõ¥ÂÖâËç£ÁöÑÊòØËÉΩÊã•Êúâ‰Ω†„ÄÇ' },
    { m:5, d:4, name:'ÈùíÂπ¥ËäÇ', emoji:'‚ú®', label:'YOUTH DAY', note:'ÈùíÊò•Ê≠£Â•ΩÔºå‰∏é‰Ω†ÂÖ±Â∫¶„ÄÇÊÑøÊàë‰ª¨Ê∞∏ËøúÂπ¥ËΩªÔºåÊ∞∏ËøúÁÉ≠Ê≥™ÁõàÁú∂„ÄÇ' },
    { m:5, d:5, name:'Á´ãÂ§è', emoji:'‚òÄÔ∏è', label:'START OF SUMMER', note:'Á´ãÂ§èÂø´‰πêÔºÅÊÑøÊàë‰ª¨ÁöÑÁà±ÂÉèÂ§èÂ§©‰∏ÄÊ†∑ÁÉ≠ÊÉÖ„ÄÇ' },
    { m:5, d:20, name:'520', emoji:'üíï', label:'I LOVE YOU', note:'520ÔºåÊàëÁà±‰Ω†ÔºÅÊÑüË∞¢‰Ω†Âá∫Áé∞Âú®ÊàëÁöÑÁîüÂëΩÈáåÔºå‰Ω†ÊòØÊàëÊúÄÂ•ΩÁöÑÈÄâÊã©„ÄÇ' },
    { m:5, d:21, name:'Â∞èÊª°', emoji:'üåæ', label:'GRAIN BUDS', note:'Â∞èÊª°Êú™Êª°Ôºå‰∏áÁâ©ÂèØÊúü„ÄÇÊàëÂØπ‰Ω†ÁöÑÁà±Ê∞∏ËøúÂú®Â¢ûÈïøÁöÑÂ≠£ËäÇ„ÄÇ' },

    { m:6, d:1, name:'ÂÑøÁ´•ËäÇ', emoji:'üéà', label:'CHILDRENS DAY', note:'ÊÑø‰Ω†Ê∞∏Ëøú‰øùÊåÅÈÇ£È¢óÁ´•ÂøÉÔºåÂíåÊàë‰∏ÄËµ∑ÂÅö‰∏™Âø´‰πêÁöÑÂ§ßÂ∞èÂ≠©„ÄÇ' },
    { m:6, d:5, name:'ËäíÁßç', emoji:'üåΩ', label:'GRAIN IN EAR', note:'ËäíÁßçÂøôÁßçÔºåÊúâ‰Ω†Âú®ÁöÑÊó•Â≠êÔºåÊØèÂ§©ÈÉΩÊòØÊî∂Ëé∑„ÄÇ' },
    { m:6, d:19, name:'Á´ØÂçàËäÇ', emoji:'üõ∂', label:'DRAGON BOAT FESTIVAL', note:'Á≤ΩÂ≠êËΩØÁ≥ØÔºå‰Ω†Êõ¥ÁîúÔΩûÁ´ØÂçàÂÆâÂ∫∑ÔºÅ' },
    { m:6, d:21, name:'Â§èËá≥', emoji:'üçâ', label:'SUMMER SOLSTICE', note:'Â§èËá≥ÊúÄÈïøÁöÑ‰∏ÄÂ§©ÔºåÊàëÁöÑÊÄùÂøµÊØîÂÆÉËøòÈïø„ÄÇ' },

    { m:7, d:6, name:'Â∞èÊöë', emoji:'üå°Ô∏è', label:'MINOR HEAT', note:'Â∞èÊöëÂÖ•‰ºèÂ§©Ôºå‰Ω†ÁöÑÊÄÄÊä±ÊòØÊúÄÊ∏ÖÂáâÁöÑÈ£é„ÄÇ' },
    { m:7, d:23, name:'Â§ßÊöë', emoji:'üî•', label:'MAJOR HEAT', note:'Â§ßÊöëÁÇéÁÇéÔºå‰Ω†ÊòØÊàëÂøÉÈáåÁöÑÂÜ∞ÈïáË•øÁìú„ÄÇ' },

    { m:8, d:7, name:'Á´ãÁßã', emoji:'üçÅ', label:'START OF AUTUMN', note:'Á´ãÁßãÂø´‰πêÔºåÊÑø‰∏é‰Ω†ÂÖ±ËµèÊØè‰∏ÄÁâáÁßãÂè∂„ÄÇ' },
    { m:8, d:19, name:'‰∏ÉÂ§ïËäÇ', emoji:'üåå', label:'QIXI FESTIVAL', note:'‰∏ÉÂ§ïÂø´‰πêÔºÅÁâõÈÉéÁªáÂ•≥‰∏ÄÂπ¥Âè™ËßÅ‰∏ÄÊ¨°ÔºåËÄåÊàë‰ª¨ÊØèÂ§©ÈÉΩÂú®‰∏ÄËµ∑ÔºåÁúüÂπ∏Ëøê„ÄÇ' },
    { m:8, d:23, name:'Â§ÑÊöë', emoji:'üå¨Ô∏è', label:'END OF HEAT', note:'Â§ÑÊöëÂá∫ÊöëÔºåÁÇéÁÉ≠Ê∏êÊ∂àÔºåÁà±ÊÑè‰∏çÂáè„ÄÇ' },

    { m:9, d:7, name:'ÁôΩÈú≤', emoji:'üíß', label:'WHITE DEW', note:'ÁôΩÈú≤‰∏∫ÈúúÔºåÊâÄË∞ì‰ºä‰∫∫ÔºåÂú®ÊàëË∫´ÊóÅ„ÄÇ' },
    { m:9, d:10, name:'ÊïôÂ∏àËäÇ', emoji:'üìö', label:'TEACHERS DAY', note:'‰Ω†ÊòØÊàë‰∫∫Áîü‰∏≠ÊúÄÁâπÂà´ÁöÑËÄÅÂ∏àÔºåÊïô‰ºö‰∫ÜÊàë‰ªÄ‰πàÊòØÁà±„ÄÇ' },
    { m:9, d:23, name:'ÁßãÂàÜ', emoji:'üçÇ', label:'AUTUMN EQUINOX', note:'ÁßãÂàÜÊòºÂ§úÂùáÔºå‰Ω†ÊòØÊàëÂøÉÈáåÁöÑÂ§©Âπ≥„ÄÇ' },
    { m:9, d:25, name:'‰∏≠ÁßãËäÇ', emoji:'üåï', label:'MID AUTUMN FESTIVAL', note:'ÊúàÂúÜ‰∫∫Âõ¢ÂúÜÔºåÊúâ‰Ω†ÊâçÂè´Âõ¢ÂúÜ„ÄÇ‰∏≠ÁßãÂø´‰πêÔºÅ' },

    { m:10, d:1, name:'ÂõΩÂ∫ÜËäÇ', emoji:'üéë', label:'NATIONAL DAY', note:'ÂõΩÂ∫ÜÂø´‰πêÔºÅÂíå‰Ω†Âú®‰∏ÄËµ∑ÁöÑÊØè‰∏ÄÂ§©ÈÉΩÂÉèËäÇÊó•ÔºåÁà±‰Ω†„ÄÇ' },
    { m:10, d:8, name:'ÂØíÈú≤', emoji:'üçÉ', label:'COLD DEW', note:'ÂØíÈú≤ÂáùÈúúÔºåÊúâ‰Ω†Âú®ÂøÉÈáåÊÄªÊòØÊöñÁöÑ„ÄÇ' },
    { m:10, d:23, name:'ÈúúÈôç', emoji:'‚ùÑÔ∏è', label:'FROST DESCENT', note:'ÈúúÈôçÂè∂ËêΩÔºåÊàëÁöÑÁà±Âç¥Â∏∏Èùí„ÄÇ' },
    { m:10, d:31, name:'‰∏áÂú£Â§ú', emoji:'üéÉ', label:'HALLOWEEN', note:'‰∏çÁªôÁ≥ñÂ∞±Êç£ËõãÔºå‰ΩÜ‰Ω†Áªô‰∫ÜÊàëÂÖ®‰∏ñÁïåÊúÄÁîúÁöÑÁ≥ñ‚Äî‚Äî‰Ω†ÁöÑÁà±„ÄÇ' },

    { m:11, d:7, name:'Á´ãÂÜ¨', emoji:'üß£', label:'START OF WINTER', note:'Á´ãÂÜ¨Âø´‰πêÔºå‰Ω†ÁöÑÊã•Êä±ÊòØÂÜ¨Â§©ÈáåÊúÄÊöñÁöÑÈò≥ÂÖâ„ÄÇ' },
    { m:11, d:11, name:'ÂÖâÊ£çËäÇ', emoji:'üë´', label:'SINGLES DAY', note:'Âπ∏Â•ΩÊàë‰ª¨‰∏çÁî®ËøáËøô‰∏™ËäÇÔºåÂõ†‰∏∫ÊàëÊúâ‰Ω†„ÄÇ' },
    { m:11, d:22, name:'Â∞èÈõ™', emoji:'‚õÑ', label:'MINOR SNOW', note:'Â∞èÈõ™È£òÈ£òÔºå‰Ω†ÊòØÊàëÂøÉÈáåÊúÄÊöñÁöÑÈÇ£Âõ¢ÁÅ´„ÄÇ' },
    { m:11, d:26, name:'ÊÑüÊÅ©ËäÇ', emoji:'üôè', label:'THANKSGIVING', note:'ÊÑüË∞¢ÁîüÂëΩ‰∏≠Êúâ‰Ω†ÔºåÊØè‰∏ÄÂ§©ÈÉΩÊòØÊÅ©Ëµê„ÄÇ' },

    { m:12, d:7, name:'Â§ßÈõ™', emoji:'‚òÉÔ∏è', label:'MAJOR SNOW', note:'Â§ßÈõ™Â∞ÅÈó®ÔºåÂ∞Å‰∏ç‰ΩèÊàëÂØπ‰Ω†ÁöÑÊÉ≥Âøµ„ÄÇ' },
    { m:12, d:22, name:'ÂÜ¨Ëá≥', emoji:'ü•ü', label:'WINTER SOLSTICE', note:'ÂÜ¨Ëá≥Âø´‰πêÔºåËÆ∞ÂæóÂêÉÈ•∫Â≠êÔºå‰ΩÜËÆ∞ÂæóÊÉ≥Êàë„ÄÇ' },
    { m:12, d:24, name:'Âπ≥ÂÆâÂ§ú', emoji:'üéÑ', label:'CHRISTMAS EVE', note:'Âπ≥ÂÆâÂ§úÂø´‰πêÔºÅÊÑø‰Ω†Âπ≥Âπ≥ÂÆâÂÆâÔºåÊàë‰ª¨ÁöÑÁà±ÊÉÖ‰πüÂ≤ÅÂ≤ÅÂ∏∏ÂÆâ„ÄÇ' },
    { m:12, d:25, name:'Âú£ËØûËäÇ', emoji:'üéÖ', label:'MERRY CHRISTMAS', note:'Âú£ËØûÂø´‰πêÔºÅ‰Ω†Â∞±ÊòØÊàëÊî∂Âà∞ÁöÑÊúÄÂ•ΩÁöÑÁ§ºÁâ©ÔºåÊ∞∏ËøúÁà±‰Ω†„ÄÇ' },
    { m:12, d:31, name:'Ë∑®Âπ¥Â§ú', emoji:'üéÜ', label:'NEW YEAR EVE', note:'ÂÜçËßÅËøô‰∏ÄÂπ¥Ôºå‰Ω†ÊòØÊàëÊúÄÂ•ΩÁöÑÊî∂Ëé∑„ÄÇÊñ∞ÁöÑ‰∏ÄÂπ¥ÔºåÁªßÁª≠Áà±‰Ω†„ÄÇ' }
];
var festival = null;
    for (var fi = 0; fi < festivals.length; fi++) {
        if (festivals[fi].m === month && festivals[fi].d === day) { festival = festivals[fi]; break; }
    }

  var weathers = [
    'Êô¥Á©∫‰∏áÈáå',
    'Â§ö‰∫ëËΩ¨Êô¥',
    'Èò¥Â§©Êúâ‰∫ë',
    'ÁªÜÈõ®ËíôËíô',
    'Êò•È£éÂíåÁÖ¶',
    'ÂæÆÂæÆÂØíÂÜ∑',
    'Ê∏ÖÈ£éÂæêÂæê',
    'Èõ®ÂêéÂàùÊô¥',
    'Â§úËâ≤ÂÆÅÈùô',
    'ÊúàÂÖâÁöéÊ¥Å',
    'Êô¥Èó¥Â§ö‰∫ë',
    'Â§ßÈõ®ÊªÇÊ≤±',
    'Èõ∑Èõ®‰∫§Âä†',
    'Â∞èÈõ™Á∫∑È£û',
    'ÂæÆÈ£éÊãÇÈù¢',
    'Â§ö‰∫ëÂ§©Ê∞î',
    'ÈõæÊ∞îÊú¶ËÉß',
    'ÊòüÂÖâÁíÄÁí®',
    'ÊúùÈúûÊª°Â§©',
    'Â§ïÈò≥Ë•ø‰∏ã',
    'Êµ∑È£éËΩªÊãÇ',
    'Â±±Èó¥Ê∏ÖÁàΩ',
    'ÁßãÂè∂È£òËêΩ',
    'Ëä±È¶ôÂõõÊ∫¢',
    'ÁªøÊÑèÁõéÁÑ∂',
    'Èõ®ÂêéÊ∏ÖÊñ∞',
    'Èõ™Ëä±È£ûËàû',
    'Èò≥ÂÖâÊòéÂ™ö'
];

var statusPool = [
    'Ê≠£Âú®ÊÉ≥‰Ω† üí≠',
    'ÂøôÁ¢å‰∏≠Ôºå‰ΩÜÂøÉÈáåÊúâ‰Ω†',
    'Â•ΩÂ•ΩÁöÑÔºåÂà´ÊãÖÂøÉ ‚ú®',
    'ÊúüÂæÖËßÅÂà∞‰Ω†',
    'ÊúâÁÇπÊÉ≥‰Ω†‰∫Ü',
    'Âú®Âä™ÂäõÂèòÊõ¥Â•Ω',
    '‰ªäÂ§©Êå∫ÂÆâÈùôÁöÑ',
    'ÂøÉÊÉÖ‰∏çÈîôÂì¶ üå±',
    '‰∏ÄÂàáÈÉΩÂ•ΩÔºå‰Ω†Âë¢Ôºü',
    'ÁúãÊúà‰∫ÆÔºåÊÉ≥Âà∞‰Ω† üåô',
    '‰ªäÂ§©ÊúâÁÇπÊÉ≥‰Ω†',
    'ÂàöÂàöÁúãÂà∞‰∏ÄÊúµ‰∫ëÂÉè‰Ω† ‚òÅÔ∏è',
    'Â∑•‰ΩúÂÜçÂøô‰πü‰ºöÊÉ≥‰Ω†ÁöÑ',
    '‰ªäÂ§©‰Ω†ÂºÄÂøÉÂêóÔºü',
    'Ê¢¶ÈáåËßÅ üí§',
    'Â•ΩÂ•ΩÂêÉÈ•≠‰∫ÜÂêóÔºü',
    'ËÆ∞ÂæóÂ§öÂñùÊ∞¥Âì¶ üíß',
    '‰ªäÂ§©ÊúâÊ≤°ÊúâÁÖßÈ°æÂ•ΩËá™Â∑±',
    'ÊÉ≥‰Ω†Ôºå‰ΩÜ‰∏çËØ¥ ü§´',
    'ÂÖ®‰∏ñÁïå‰Ω†ÊúÄÂèØÁà±',
    '‰ªäÂ§©Â§©Ê∞î‰∏çÈîôÔºåÈÄÇÂêàÊÉ≥‰Ω†',
    'ÂêÉÈ•±ÂñùË∂≥ÔºåÂºÄÂßãÊÉ≥‰Ω†',
    '‰ªäÂ§©‰πüÊÉ≥Áâµ‰Ω†ÁöÑÊâã',
    '‰Ω†ÊúâÊ≤°ÊúâÊÉ≥Êàë',
    '‰ªäÂ§©ÊØîÊò®Â§©Êõ¥ÊÉ≥‰Ω†',
    'ÁúãÂà∞Â•ΩÂêÉÁöÑÊÉ≥ÂàÜ‰∫´Áªô‰Ω† üçú',
    'Âê¨Âà∞‰∏ÄÈ¶ñÊ≠åÊÉ≥Âà∞‰Ω† üéµ',
    '‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÈ∏≠',
    'ÊôöÂÆâÔºåÊàëÁöÑÂÖ®‰∏ñÁïå üåô',
    'Êó©ÂÆâÔºåÂèàÊòØÊÉ≥‰Ω†ÁöÑ‰∏ÄÂ§©'
];
    var todayKey = String(now.getFullYear()) + String(month) + String(day);
    var seed = 0;
    for (var si = 0; si < todayKey.length; si++) seed += todayKey.charCodeAt(si) * (si + 1);
    var defaultWeather = weathers[Math.floor(Math.random() * weathers.length)];
    var customWeatherKey = 'customWeather_' + now.getFullYear() + '_' + month + '_' + day;
    var weather = localStorage.getItem(customWeatherKey) || defaultWeather;
    var status = statusPool[Math.floor(Math.random() * statusPool.length)];

    return { timeLabel: timeLabel, timeEmoji: timeEmoji, festival: festival, weather: weather, status: status };
}

function _buildDailyGreeting() {
    try {
        var data = _getDailyGreetingData();
        var festival = data.festival;
        var timeLabel = data.timeLabel;
        var timeEmoji = data.timeEmoji;
        var weather = data.weather;
        var status = data.status;

        var now = new Date();
        var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');

        var moodDataRaw = window.moodData || {};
        var todayMood = moodDataRaw[todayStr];
        var allMoods = (typeof getAllMoodOptions === 'function') ? getAllMoodOptions() : [];

        // Use dynamic partner name
        var pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'Ê¢¶Ëßí';
        var mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'Êàë';

        var partnerMoodText = pName + ' ‰ªäÂ§©ËøòÊ≤°ÊúâËÆ∞ÂΩï';
        var partnerMoodIcon = null; // will use SVG default
        var partnerMoodNote = '';

        if (todayMood && todayMood.partner) {
            for (var pi = 0; pi < allMoods.length; pi++) {
                if (allMoods[pi].key === todayMood.partner) {
                    partnerMoodText = allMoods[pi].kaomoji + '  ' + allMoods[pi].label;
                    partnerMoodIcon = allMoods[pi].kaomoji;
                    break;
                }
            }
            partnerMoodNote = todayMood.partnerNote || '';
        }

        var h = now.getHours();
        var mainTitle = festival ? (festival.name + 'Âø´‰πê') : timeLabel;
        var festLabel = festival ? festival.label : ('GOOD ' + (h < 12 ? 'MORNING' : h < 18 ? 'AFTERNOON' : 'EVENING'));
        var noteText = festival ? festival.note : '‰ªäÂ§©‰πüË¶ÅÂÖÉÊ∞îÊª°Êª°ÔºåÊàëÂú®ËøôÈáåÈô™ÁùÄ‰Ω† ‚ú¶';

        // Load custom overrides
        var customData = {};
        try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e2) {}
        // Random selection seed based on date
        var todaySeedForText = now.getDate() * 100 + now.getMonth() + now.getFullYear() * 3;
        if (customData.titles && customData.titles.length > 0) {
            mainTitle = customData.titles[todaySeedForText % customData.titles.length];
        } else if (customData.title) {
            mainTitle = customData.title;
        }
        if (customData.notes && customData.notes.length > 0) {
            noteText = customData.notes[todaySeedForText % customData.notes.length];
        } else if (customData.note) {
            noteText = customData.note;
        }

        function setEl(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
        function setElHTML(id, val) { var el = document.getElementById(id); if (el) el.innerHTML = val; }

        // Update emoji circle - if mood icon is a real emoji use it, else keep SVG
        var emojiEl = document.getElementById('dg-emoji');
        if (emojiEl) {
            if (festival) {
                emojiEl.textContent = festival.emoji;
            }
            // else keep the SVG smile icon
        }

        // Update mood icon
        var moodIconEl = document.getElementById('dg-partner-mood-icon');
        if (moodIconEl) {
            if (partnerMoodIcon) {
                moodIconEl.textContent = partnerMoodIcon;
                moodIconEl.style.fontSize = '32px';
            }
            // else keep SVG
        }

        setEl('dg-festival', festLabel);
        setEl('dg-title', mainTitle);
        setEl('dg-partner-mood', partnerMoodText);
        setEl('dg-partner-mood-note', partnerMoodNote || (todayMood && todayMood.partner ? pName + ' ËÆ∞ÂΩï‰∫Ü‰ªäÂ§©ÁöÑÂøÉÊÉÖ ‚òÜ' : ''));

        // Status pool random selection
        var statusPoolData = [];
        try { statusPoolData = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
        if (statusPoolData.length > 0) {
            var poolItem = statusPoolData[Math.floor(Math.random() * statusPoolData.length)];
            if (poolItem) {
                setEl('dg-festival', poolItem.label || festLabel);
                setEl('dg-status', poolItem.status || status);
                var emojiEl2 = document.getElementById('dg-emoji');
                if (emojiEl2) {
                    if (poolItem.iconImg) {
                        emojiEl2.textContent = '';
                        emojiEl2.style.backgroundImage = 'url(' + poolItem.iconImg + ')';
                        emojiEl2.style.backgroundSize = 'cover';
                        emojiEl2.style.backgroundPosition = 'center';
                    } else if (poolItem.icon) {
                        emojiEl2.style.backgroundImage = '';
                        emojiEl2.textContent = poolItem.icon;
                    }
                }
            }
        } else {
            setEl('dg-weather', weather);
            setEl('dg-status', status);
        }
        if (statusPoolData.length === 0) {
            setEl('dg-weather', weather);
            setEl('dg-status', status);
        } else {
            setEl('dg-weather', weather);
        }

        // Update note box with inner structure
        var noteTextEl = document.getElementById('dg-note-text');
        if (noteTextEl) noteTextEl.textContent = noteText;
        // Weather badge hidden ‚Äî weather is shown in the info grid above
        var wBadge = document.getElementById('dg-note-weather-badge');
        if (wBadge) wBadge.style.display = 'none';

        // Update dynamic labels with names
        setEl('dg-section-label-partner', pName + ' ‰ªäÊó•Áä∂ÊÄÅ');
        setEl('dg-weather-label', pName + ' ÁöÑÂ§©Ê∞î');
        setEl('dg-status-label', pName + ' ÁöÑÁä∂ÊÄÅ');

        // Date stamp
        var months = ['‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠','‰∏É','ÂÖ´','‰πù','ÂçÅ','ÂçÅ‰∏Ä','ÂçÅ‰∫å'];
        setEl('dg-date-stamp', now.getFullYear() + ' ¬∑ ' + months[now.getMonth()] + 'Êúà' + now.getDate() + 'Êó•');

        // Load custom header bg
        var headerBg = localStorage.getItem('dg_header_bg');
        var bgEl = document.getElementById('dg-header-band-bg');
        if (bgEl && headerBg) {
            bgEl.style.backgroundImage = 'url(' + headerBg + ')';
            bgEl.classList.add('has-img');
        }

        // Load custom deco image (middle decoration only, no top banner)
        var decoImg = customData.decoImg;
        var decoWrap2 = document.getElementById('dg-deco-img-wrap');
        var decoImgEl2 = document.getElementById('dg-deco-img');
        if (decoWrap2 && decoImgEl2) {
            if (decoImg) {
                decoImgEl2.src = decoImg;
                decoWrap2.style.display = 'block';
            } else {
                decoWrap2.style.display = 'none';
            }
        }
    } catch(e) { console.warn('Daily greeting build error:', e); }
}

window.toggleImmersiveMode = function(force) {
    var isOn = (force !== undefined) ? force : !document.body.classList.contains('immersive-mode');
    document.body.classList.toggle('immersive-mode', isOn);
    var toggle = document.getElementById('immersive-toggle');
    if (toggle) toggle.classList.toggle('active', isOn);
    try { localStorage.setItem('immersive_mode', isOn ? '1' : '0'); } catch(e) {}
    if (!isOn && typeof showNotification === 'function') showNotification('Â∑≤ÈÄÄÂá∫Ê≤âÊµ∏ÂºèÊ®°Âºè', 'info');
};
(function() {
    try {
        if (localStorage.getItem('immersive_mode') === '1') {
            document.body.classList.add('immersive-mode');
            var t = document.getElementById('immersive-toggle');
            if (t) t.classList.add('active');
        }
    } catch(e) {}
})();

window.openDailyGreetingEditor = function() {
    var modal = document.getElementById('dg-editor-modal');
    if (!modal) return;
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    var titleEl = document.getElementById('dg-edit-title');
    var noteEl = document.getElementById('dg-edit-note');
    if (titleEl) titleEl.value = (customData.titles && customData.titles.length) ? customData.titles.join('\n') : (customData.title || '');
    if (noteEl) noteEl.value = (customData.notes && customData.notes.length) ? customData.notes.join('\n') : (customData.note || '');

    // Load deco image preview
    if (customData.decoImg) {
        var prev = document.getElementById('dg-deco-preview');
        var prevImg = document.getElementById('dg-deco-preview-img');
        if (prev && prevImg) { prevImg.src = customData.decoImg; prev.style.display = 'block'; }
    }

    modal.style.display = 'flex';
    modal.classList.add('active');
};
window.closeDailyGreetingEditor = function() {
    var modal = document.getElementById('dg-editor-modal');
    if (modal) { modal.style.display = 'none'; modal.classList.remove('active'); }
};
window.saveDailyGreetingCustom = function() {
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    var titleEl = document.getElementById('dg-edit-title');
    var noteEl = document.getElementById('dg-edit-note');
    if (titleEl && titleEl.value.trim()) {
        var titles = titleEl.value.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
        customData.titles = titles;
        customData.title = titles[0]; // backward compat
    } else { delete customData.titles; delete customData.title; }
    if (noteEl && noteEl.value.trim()) {
        var notes = noteEl.value.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
        customData.notes = notes;
        customData.note = notes[0]; // backward compat
    } else { delete customData.notes; delete customData.note; }
    localStorage.setItem('dg_custom_data', JSON.stringify(customData));
    closeDailyGreetingEditor();
    if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
    if (typeof showNotification === 'function') showNotification('ÂÖ¨ÂëäÂ∑≤‰øùÂ≠ò ‚ú¶', 'success');
};
window.clearDgDecoImg = function() {
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    delete customData.decoImg;
    localStorage.setItem('dg_custom_data', JSON.stringify(customData));
    var prev = document.getElementById('dg-deco-preview');
    if (prev) prev.style.display = 'none';
    var wrap = document.getElementById('dg-deco-img-wrap');
    if (wrap) wrap.style.display = 'none';
};
window.clearDgHeaderBg = function() {
    localStorage.removeItem('dg_header_bg');
    var bgEl = document.getElementById('dg-header-band-bg');
    if (bgEl) { bgEl.style.backgroundImage = ''; bgEl.classList.remove('has-img'); }
};

// ‚îÄ‚îÄ‚îÄ Announcement Panel (in custom replies modal) ‚îÄ‚îÄ‚îÄ
window.switchToAnnouncementPanel = function() {
    var listArea = document.getElementById('custom-replies-list');
    var annPanel = document.getElementById('announcement-panel');
    var toolbar = document.getElementById('cr-toolbar');
    var subTabs = document.getElementById('cr-sub-tabs');
    var addBtn = document.getElementById('add-custom-reply');
    var titleEl = document.getElementById('cr-modal-title');
    if (listArea) listArea.style.display = 'none';
    if (annPanel) annPanel.style.display = 'block';
    if (toolbar) toolbar.style.display = 'none';
    if (subTabs) subTabs.style.display = 'none';
    if (addBtn) addBtn.style.display = 'none';
    if (titleEl) titleEl.textContent = '‰ªäÊó•ÂÖ¨ÂëäÈÖçÁΩÆ';
    // Load saved data
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e2) {}
    var titleInput = document.getElementById('dg-edit-title');
    var noteInput = document.getElementById('dg-edit-note');
    if (titleInput) titleInput.value = (customData.titles && customData.titles.length) ? customData.titles.join('\n') : (customData.title || '');
    if (noteInput) noteInput.value = (customData.notes && customData.notes.length) ? customData.notes.join('\n') : (customData.note || '');
    if (customData.decoImg) {
        var prev = document.getElementById('dg-deco-preview');
        var prevImg = document.getElementById('dg-deco-preview-img');
        if (prev && prevImg) { prevImg.src = customData.decoImg; prev.style.display = 'block'; }
    }
    renderAnnStatusPool();
};

window.renderAnnStatusPool = function() {
    var listEl = document.getElementById('ann-status-pool-list');
    if (!listEl) return;
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    listEl.innerHTML = '';
    if (pool.length === 0) {
        listEl.innerHTML = '<div style="font-size:12px;color:var(--text-secondary);text-align:center;padding:10px 0;opacity:0.6;">ÊöÇÊó†Êù°ÁõÆÔºåÊ∑ªÂä†ÂêéÂ∞ÜÈöèÊú∫ÊäΩÂèñ</div>';
        return;
    }
    pool.forEach(function(item, idx) {
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:9px 12px;background:linear-gradient(135deg,rgba(var(--accent-color-rgb),0.05),rgba(var(--accent-color-rgb),0.02));border-radius:12px;border:1px solid rgba(var(--accent-color-rgb),0.15);font-size:13px;transition:box-shadow 0.2s;';
        var iconHtml = item.iconImg
            ? '<img src="' + item.iconImg + '" style="width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0;">'
            : '<span style="font-size:18px;min-width:26px;text-align:center;flex-shrink:0;">' + (item.icon || '‚ú¶') + '</span>';
        row.innerHTML = iconHtml
            + '<div style="flex:1;min-width:0;">'
            + '<div style="color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (item.status || '‚Äî') + '</div>'
            + (item.label ? '<div style="color:var(--accent-color);font-size:10px;letter-spacing:1.5px;margin-top:2px;opacity:0.8;">' + item.label + '</div>' : '')
            + '</div>'
            + '<button onclick="removeAnnStatusPoolItem(' + idx + ')" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;padding:3px 5px;border-radius:6px;opacity:0.6;transition:opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">‚úï</button>';
        listEl.appendChild(row);
    });
};

window.addAnnStatusPoolItem = function() {
    var statusInput = document.getElementById('ann-status-pool-input');
    var labelInput = document.getElementById('ann-status-label-input');
    var iconInput = document.getElementById('ann-status-icon-input');
    var status = statusInput ? statusInput.value.trim() : '';
    var label = labelInput ? labelInput.value.trim() : '';
    var icon = iconInput ? iconInput.value.trim() : '';
    var iconImg = iconInput ? (iconInput.dataset.imgSrc || '') : '';
    if (!status && !label) { if (typeof showNotification === 'function') showNotification('ËØ∑Ëá≥Â∞ëÂ°´ÂÜôÁä∂ÊÄÅÊàñÊ†áÁ≠æ', 'warning'); return; }
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    var entry = { status: status, label: label, icon: icon || '‚ú¶' };
    if (iconImg) entry.iconImg = iconImg;
    pool.push(entry);
    localStorage.setItem('dg_status_pool', JSON.stringify(pool));
    if (statusInput) statusInput.value = '';
    if (labelInput) labelInput.value = '';
    if (iconInput) { iconInput.value = ''; delete iconInput.dataset.imgSrc; }
    renderAnnStatusPool();
    if (typeof showNotification === 'function') showNotification('Â∑≤Ê∑ªÂä†Âà∞ÈöèÊú∫Â∫ì', 'success');
};

window.handleAnnStatusIconUpload = function(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        var iconInput = document.getElementById('ann-status-icon-input');
        if (iconInput) {
            iconInput.dataset.imgSrc = ev.target.result;
            iconInput.value = '[ÂõæÁâá]';
            iconInput.style.fontSize = '10px';
        }
    };
    reader.readAsDataURL(file);
};

window.removeAnnStatusPoolItem = function(idx) {
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    pool.splice(idx, 1);
    localStorage.setItem('dg_status_pool', JSON.stringify(pool));
    renderAnnStatusPool();
};

// Header bg image upload
document.addEventListener('DOMContentLoaded', function() {
    var headerInput = document.getElementById('dg-header-img-input');
    if (headerInput) {
        headerInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                var data = ev.target.result;
                localStorage.setItem('dg_header_bg', data);
                var bgEl = document.getElementById('dg-header-band-bg');
                if (bgEl) { bgEl.style.backgroundImage = 'url(' + data + ')'; bgEl.classList.add('has-img'); }
            };
            reader.readAsDataURL(file);
        });
    }
    var decoInput = document.getElementById('dg-deco-img-input');
    if (decoInput) {
        decoInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                var data = ev.target.result;
                var customData = {};
                try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(ex) {}
                customData.decoImg = data;
                localStorage.setItem('dg_custom_data', JSON.stringify(customData));
                var prev = document.getElementById('dg-deco-preview');
                var prevImg = document.getElementById('dg-deco-preview-img');
                if (prev && prevImg) { prevImg.src = data; prev.style.display = 'block'; }
            };
            reader.readAsDataURL(file);
        });
    }
});

// ‚îÄ‚îÄ‚îÄ Dynamic name updater ‚îÄ‚îÄ‚îÄ
window.updateDynamicNames = function() {
    try {
        var pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'Ê¢¶Ëßí';
        var mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'Êàë';

        // Mood editor tabs
        var tabPartner = document.getElementById('mood-tab-partner');
        if (tabPartner) tabPartner.textContent = pName + 'ÁöÑËÆ∞ÂΩï';
        var tabMe = document.getElementById('mood-tab-me');
        if (tabMe) tabMe.textContent = mName + 'ÁöÑËÆ∞ÂΩï';

        // Detail view titles
        var detailPartnerTitle = document.getElementById('detail-partner-title');
        if (detailPartnerTitle) detailPartnerTitle.textContent = pName + 'ÁöÑ';

        // Detail partner no-record
        var partnerNoRec = document.getElementById('detail-partner-no-record');
        if (partnerNoRec) {
            var msgEl = partnerNoRec;
            if (!msgEl.querySelector('span')) msgEl.textContent = pName + ' ËøôÂ§©ËøòÊ≤°ÊúâÁïô‰∏ãËÆ∞ÂΩï';
        }

        // Edit partner button
        var editPartnerBtn = document.getElementById('edit-partner-mood');
        if (editPartnerBtn) editPartnerBtn.textContent = '‰øÆÊîπ' + pName;
        var deletePartnerBtn = document.getElementById('delete-partner-mood');
        if (deletePartnerBtn) deletePartnerBtn.textContent = 'Âà†Èô§' + pName;

        // Continue btn title
        var continueBtn = document.getElementById('continue-btn');
        if (continueBtn) continueBtn.title = 'ËÆ©' + pName + 'ÁªßÁª≠ËØ¥';

        // Envelope info
        var envInfo = document.querySelector('.env-send-info');
        if (envInfo) {
            var textNodes = Array.from(envInfo.childNodes).filter(n => n.nodeType === 3);
            textNodes.forEach(function(n) {
                if (n.textContent.includes('ÂØπÊñπÂ∞ÜÂú®') || n.textContent.includes('Â∞èÊó∂ÂÜÖÂõû‰ø°')) {
                    n.textContent = pName + ' Â∞ÜÂú® 10-24 Â∞èÊó∂ÂÜÖÂõû‰ø°Ôºà8-12 Âè•ËØùÔºâ';
                }
            });
        }

        // Daily greeting labels
        setDgLabel('dg-section-label-partner', pName + ' ‰ªäÊó•Áä∂ÊÄÅ');
        setDgLabel('dg-weather-label', pName + ' ÁöÑÂ§©Ê∞î');
        setDgLabel('dg-status-label', pName + ' ÁöÑÁä∂ÊÄÅ');

        // Envelope info text
        var envInfoSpan = document.getElementById('env-reply-time-info');
        if (envInfoSpan) envInfoSpan.textContent = pName + ' Â∞ÜÂú® 10-24 Â∞èÊó∂ÂÜÖÂõû‰ø°Ôºà8-12 Âè•ËØùÔºâ';

        // Poke input placeholder
        var pokeInput = document.getElementById('poke-input');
        if (pokeInput) pokeInput.placeholder = '‰æãÂ¶ÇÔºöÊãç‰∫ÜÊãç"' + pName + '"ÁöÑËÇ©ËÜÄ';

        // Stats labels
        document.querySelectorAll('[data-name-partner]').forEach(function(el) {
            el.textContent = pName + 'ÁöÑËÆ∞ÂΩï';
        });
        document.querySelectorAll('[data-name-me]').forEach(function(el) {
            el.textContent = mName + 'ÁöÑËÆ∞ÂΩï';
        });
        document.querySelectorAll('[data-delete-partner]').forEach(function(el) {
            el.textContent = 'Âà†Èô§' + pName;
        });
        document.querySelectorAll('[data-edit-partner]').forEach(function(el) {
            el.textContent = '‰øÆÊîπ' + pName;
        });
    } catch(e) { console.warn('updateDynamicNames error:', e); }
};
function setDgLabel(id, txt) {
    var el = document.getElementById(id);
    if (el && el.tagName !== 'INPUT') el.textContent = txt;
}

window.closeDailyGreeting = function() {
    try {
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            setTimeout(function() {
                modal.classList.add('hidden');
                modal.style.opacity = '';
                modal.style.transition = '';
            }, 320);
        }
        localStorage.setItem('dailyGreetingShown', new Date().toDateString());
    } catch(e) {}
};

window.reopenDailyGreeting = function() {
    try {
        if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.classList.remove('hidden');
            requestAnimationFrame(function() {
                modal.style.transition = 'opacity 0.3s ease';
                modal.style.opacity = '1';
            });
        }
    } catch(e) {}
};

window.tryShowDailyGreeting = function() {
    try {
        if (localStorage.getItem('dailyGreetingShown') === new Date().toDateString()) return;

        var now = new Date();
        var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
        var moodDataRaw = window.moodData || {};
        var todayMood = moodDataRaw[todayStr];

        if (!todayMood || !todayMood.partner) {
            setTimeout(function() {
                var refreshedMood = (window.moodData || {})[todayStr];
                _buildDailyGreeting(); 
                var modal = document.getElementById('daily-greeting-modal');
                if (modal) modal.classList.remove('hidden');
                localStorage.setItem('dailyGreetingShown', new Date().toDateString());
            }, 45000);
            return;
        }

        _buildDailyGreeting();
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) modal.classList.remove('hidden');
    } catch(e) { console.warn('Daily greeting show error:', e); }
};

window.addEventListener('load', function() {
    setTimeout(function() {
        try {
            if (window.localforage && window.APP_PREFIX) {
                localforage.getItem(window.APP_PREFIX + 'tour_seen').then(function(seen) {
                    if (seen) { window.tryShowDailyGreeting(); }
                }).catch(function() { window.tryShowDailyGreeting(); });
            } else {
                window.tryShowDailyGreeting();
            }
        } catch(e) { window.tryShowDailyGreeting(); }
    }, 2500);
});

function updateStorageUsageBar() {
    var fill = document.getElementById('storage-usage-fill');
    var text = document.getElementById('storage-usage-text');
    if (!fill || !text) return;

    try {
        var total = 0;
        if (window.localforage && window.APP_PREFIX) {
            localforage.keys().then(function(keys) {
                var promises = keys.map(function(k) {
                    return localforage.getItem(k).then(function(v) {
                        if (v === null || v === undefined) return 0;
                        var str = typeof v === 'string' ? v : JSON.stringify(v);
                        return k.length + str.length;
                    });
                });
                Promise.all(promises).then(function(sizes) {
                    var total = sizes.reduce(function(a,b){return a+b;}, 0);
                    var usedKB = (total * 2 / 1024).toFixed(1);
                    var maxKB = 10240;
                    var pct = Math.min(total * 2 / 1024 / maxKB * 100, 100).toFixed(1);
                    fill.style.width = pct + '%';
                    if (parseFloat(pct) > 80) fill.style.background = 'linear-gradient(90deg,#ff4757,#ff6b8a)';
                    else if (parseFloat(pct) > 50) fill.style.background = 'linear-gradient(90deg,#ffa502,rgba(255,165,2,0.6))';
                    else fill.style.background = 'linear-gradient(90deg,var(--accent-color),rgba(var(--accent-color-rgb),0.6))';
                    text.textContent = usedKB + ' KB / ~10 MB (' + pct + '%)';
                });
            }).catch(function() {
                var ls = 0;
                for (var i = 0; i < localStorage.length; i++) {
                    var k = localStorage.key(i) || '';
                    var v = localStorage.getItem(k) || '';
                    ls += k.length + v.length;
                }
                var kb = (ls * 2 / 1024).toFixed(1);
                fill.style.width = Math.min(ls * 2 / 1024 / 5120 * 100, 100).toFixed(1) + '%';
                text.textContent = kb + ' KB (localStorage)';
            });
        } else {
            text.textContent = 'ÊöÇÊó†Êï∞ÊçÆ';
            fill.style.width = '0%';
        }
    } catch(e) {
        if (text) text.textContent = 'Êó†Ê≥ïËØªÂèñ';
    }
}

(function() {
    var orig = window.showModal;
    if (typeof orig === 'function') {
        window.showModal = function(el) {
            orig.apply(this, arguments);
            if (el && el.id === 'data-modal') {
                setTimeout(updateStorageUsageBar, 200);
            }
        };
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('data-settings');
    if (btn) {
        btn.addEventListener('click', function() { setTimeout(updateStorageUsageBar, 300); });
    }
});

window._sendPartnerNotification = function(title, body) {
    try {
        var enabled = localStorage.getItem('notifEnabled') === '1';
        if (!enabled) return;
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') return;
        if (!document.hidden) return; 
        new Notification(title || '‰º†ËÆØ', {
            body: body || 'ÂØπÊñπÂèëÊù•‰∫ÜÊ∂àÊÅØ',
            icon: document.querySelector('#partner-avatar img') ? document.querySelector('#partner-avatar img').src : undefined,
            tag: 'partner-msg',
            renotify: true
        });
    } catch(e) {}
};

window.handleNotifToggle = function(checkbox) {
    var statusEl = document.getElementById('notif-status-text');
    if (!('Notification' in window)) {
        checkbox.checked = false;
        if (statusEl) statusEl.textContent = '‚ö†Ô∏è ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈÄöÁü•ÂäüËÉΩÔºåËØ∑Êõ¥Êç¢ÊµèËßàÂô®';
        return;
    }
    if (checkbox.checked) {
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') {
                if (statusEl) statusEl.textContent = '‚úÖ Â∑≤ÂºÄÂêØ ‚Äî ÂΩìÈ°µÈù¢Âú®ÂêéÂè∞Êó∂ÔºåÊî∂Âà∞Ê∂àÊÅØ‰ºöÂºπÂá∫Á≥ªÁªüÈÄöÁü•';
                localStorage.setItem('notifEnabled', '1');
                try {
                    new Notification('‰º†ËÆØÈÄöÁü•Â∑≤ÂºÄÂêØ ‚ú®', {
                        body: '‰Ω†Áé∞Âú®ÂèØ‰ª•Âú®ÂêéÂè∞Êî∂Âà∞Ê∂àÊÅØÊèêÈÜí‰∫Ü',
                        tag: 'notif-test'
                    });
                } catch(e) {}
            } else if (perm === 'denied') {
                checkbox.checked = false;
                if (statusEl) statusEl.textContent = '‚ùå ÊùÉÈôêË¢´ÊãíÁªùÔºåËØ∑Ëá™Ë°åÊêúÁ¥¢Â¶Ç‰ΩïÂºÄÂêØ';
                localStorage.setItem('notifEnabled', '0');
            } else {
                checkbox.checked = false;
                if (statusEl) statusEl.textContent = '‚ö†Ô∏è Êú™ÂÅöÂá∫ÈÄâÊã©ÔºåËØ∑ÈáçËØï';
                localStorage.setItem('notifEnabled', '0');
            }
        }).catch(function() {
            checkbox.checked = false;
            if (statusEl) statusEl.textContent = '‚ùå ËØ∑Ê±ÇÊùÉÈôêÂ§±Ë¥•ÔºåËØ∑Ëá™Ë°åÊêúÁ¥¢Â¶Ç‰ΩïÊâìÂºÄ';
            localStorage.setItem('notifEnabled', '0');
        });
    } else {
        if (statusEl) statusEl.textContent = 'Â∑≤ÂÖ≥Èó≠ ‚Äî ÂêéÂè∞Â∞Ü‰∏çÂÜçÂºπÂá∫Ê∂àÊÅØÊèêÈÜí';
        localStorage.setItem('notifEnabled', '0');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('notif-permission-toggle');
    var statusEl = document.getElementById('notif-status-text');
    if (!toggle) return;
    var enabled = localStorage.getItem('notifEnabled') === '1';
    var granted = ('Notification' in window) && Notification.permission === 'granted';
    toggle.checked = enabled && granted;
    if (toggle.checked && statusEl) {
        statusEl.textContent = '‚úÖ Â∑≤ÂºÄÂêØ ‚Äî ÂΩìÈ°µÈù¢Âú®ÂêéÂè∞Êó∂ÔºåÊî∂Âà∞Ê∂àÊÅØ‰ºöÂºπÂá∫Á≥ªÁªüÈÄöÁü•';
    } else if (statusEl) {
        if ('Notification' in window && Notification.permission === 'denied') {
            statusEl.textContent = '‚ùå ÈÄöÁü•ÊùÉÈôêÂ∑≤Ë¢´ÊµèËßàÂô®Â±èËîΩÔºåËØ∑Ëá™Ë°åÊêúÁ¥¢Â¶Ç‰ΩïÂºÄÂêØ';
        } else {
            statusEl.textContent = 'ÂÖ≥Èó≠Áä∂ÊÄÅ ‚Äî ÂºÄÂêØÂêéÂèØÂú®ÂêéÂè∞Êé•Êî∂Ê∂àÊÅØÊèêÈÜí';
        }
    }
});
</script>

<script>
window.switchStatsTab = function(tab) {
    var statsPanel = document.getElementById('stats-panel');
    var favoritesPanel = document.getElementById('favorites-panel');
    var statsBtn = document.getElementById('stats-tab-btn');
    var favBtn = document.getElementById('favorites-tab-btn');
    if (tab === 'stats') {
        statsPanel.style.display = 'block';
        favoritesPanel.style.display = 'none';
        statsBtn.className = 'modal-btn modal-btn-primary';
        favBtn.className = 'modal-btn modal-btn-secondary';
    } else {
        statsPanel.style.display = 'none';
        favoritesPanel.style.display = 'block';
        statsBtn.className = 'modal-btn modal-btn-secondary';
        favBtn.className = 'modal-btn modal-btn-primary';
        if (typeof renderFavorites === 'function') renderFavorites();
    }
};

var groupChatSettings = (function() {
    try {
        var saved = JSON.parse(localStorage.getItem('groupChatSettings') || 'null');
        if (!saved) return { enabled: false, showAvatar: true, showName: true, members: [] };
        // Á°Æ‰øù members Â≠òÂú®
        if (!saved.members) saved.members = [];
        return saved;
    } catch(e) { return { enabled: false, showAvatar: true, showName: true, members: [] }; }
})();
// ÂºÇÊ≠•Âä†ËΩΩÊàêÂëòÂ§¥ÂÉèÔºà‰ªé localforageÔºâ
(function loadGroupAvatars() {
    if (!window.localforage) return;
    var members = groupChatSettings.members || [];
    if (members.length === 0) return;
    var promises = members.map(function(m, i) {
        var ref = m.avatarRef || ('gca_' + i);
        return localforage.getItem(ref).then(function(avatar) {
            m.avatar = avatar || null;
        }).catch(function() { m.avatar = null; });
    });
    Promise.all(promises).then(function() {
        // Â§¥ÂÉèÂä†ËΩΩÂÆåÊàêÂêéÂà∑Êñ∞ÊàêÂëòÂàóË°®ÊòæÁ§∫
        if (typeof renderGroupMembersList === 'function') renderGroupMembersList();
    });
})();
var _groupMemberAvatarDataUrl = null;

function saveGroupChatSettings() {
    // ÂàÜÁ¶ªÂ§¥ÂÉèÊï∞ÊçÆÔºåÈÅøÂÖç localStorage Ë∂ÖÈôêÔºàÂ§ßÂõæbase64‰ºöÂØºËá¥Â≠òÂÇ®Â§±Ë¥•Ôºâ
    var toSave = {
        enabled: groupChatSettings.enabled,
        showAvatar: groupChatSettings.showAvatar,
        showName: groupChatSettings.showName,
        members: (groupChatSettings.members || []).map(function(m, i) {
            return { name: m.name, avatarRef: 'gca_' + i };
        })
    };
    try {
        localStorage.setItem('groupChatSettings', JSON.stringify(toSave));
    } catch(e) {
        console.warn('groupChatSettings localStorage‰øùÂ≠òÂ§±Ë¥•:', e);
    }
    // Áî® localforage Â≠òÂÇ®ÊØè‰∏™ÊàêÂëòÁöÑÂ§¥ÂÉè
    if (window.localforage) {
        (groupChatSettings.members || []).forEach(function(m, i) {
            localforage.setItem('gca_' + i, m.avatar || null).catch(function(e) {
                console.warn('Â§¥ÂÉèÂ≠òÂÇ®Â§±Ë¥• index=' + i, e);
            });
        });
        // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÂ§¥ÂÉè
        var count = (groupChatSettings.members || []).length;
        for (var ci = count; ci < count + 10; ci++) {
            localforage.removeItem('gca_' + ci).catch(function(){});
        }
    }
}

function renderGroupMembersList() {
    var list = document.getElementById('group-members-list');
    if (!list) return;
    if (!groupChatSettings.members || groupChatSettings.members.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">ÊöÇÊó†ÊàêÂëòÔºåÁÇπÂáªÊ∑ªÂä†ÊåâÈíÆÊ∑ªÂä†</div>';
        return;
    }
    list.innerHTML = groupChatSettings.members.map(function(m, i) {
        var avatarHtml = m.avatar
            ? '<img src="' + m.avatar + '" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">'
            : '<div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.15);display:flex;align-items:center;justify-content:center;"><i class="fas fa-user" style="font-size:14px;color:var(--accent-color);"></i></div>';
        return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;">'
            + avatarHtml
            + '<span style="flex:1;font-size:13px;font-weight:500;">' + (m.name || 'ÊàêÂëò' + (i+1)) + '</span>'
            + '<button onclick="openEditGroupMember(' + i + ')" style="background:none;border:none;cursor:pointer;color:var(--accent-color);font-size:14px;padding:4px 8px;"><i class="fas fa-edit"></i></button>'
            + '<button onclick="deleteGroupMember(' + i + ')" style="background:none;border:none;cursor:pointer;color:#ff4757;font-size:14px;padding:4px 8px;"><i class="fas fa-trash-alt"></i></button>'
            + '</div>';
    }).join('');
}

function updateGroupModeUI() {
    var pill = document.getElementById('group-mode-pill');
    var knob = document.getElementById('group-mode-knob');
    var status = document.getElementById('group-mode-status');
    var displaySection = document.getElementById('group-display-section');
    var membersSection = document.getElementById('group-members-section');
    if (!pill) return;
    if (groupChatSettings.enabled) {
        pill.style.background = 'var(--accent-color)';
        knob.style.left = '22px';
        status.textContent = 'Â∑≤ÂºÄÂêØ ‚Äî Êî∂Âà∞ÁöÑÊ∂àÊÅØÈöèÊú∫ÊòæÁ§∫ÊàêÂëò';
        displaySection.style.display = 'block';
        membersSection.style.display = 'block';
    } else {
        pill.style.background = 'var(--border-color)';
        knob.style.left = '3px';
        status.textContent = 'Â∑≤ÂÖ≥Èó≠ ‚Äî ÁÇπÂáªÂºÄÂêØ';
        displaySection.style.display = 'none';
        membersSection.style.display = 'none';
    }
    var avatarPill = document.getElementById('group-show-avatar-pill');
    var avatarKnob = document.getElementById('group-show-avatar-knob');
    if (avatarPill) {
        avatarPill.style.background = groupChatSettings.showAvatar ? 'var(--accent-color)' : 'var(--border-color)';
        avatarKnob.style.right = groupChatSettings.showAvatar ? '3px' : '19px';
    }
    var namePill = document.getElementById('group-show-name-pill');
    var nameKnob = document.getElementById('group-show-name-knob');
    if (namePill) {
        namePill.style.background = groupChatSettings.showName ? 'var(--accent-color)' : 'var(--border-color)';
        nameKnob.style.right = groupChatSettings.showName ? '3px' : '19px';
    }
    renderGroupMembersList();
}

document.addEventListener('DOMContentLoaded', function() {
    var groupModeToggle = document.getElementById('group-mode-toggle');
    if (groupModeToggle) {
        groupModeToggle.addEventListener('click', function() {
            groupChatSettings.enabled = !groupChatSettings.enabled;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var showAvatarToggle = document.getElementById('group-show-avatar-toggle');
    if (showAvatarToggle) {
        showAvatarToggle.addEventListener('click', function() {
            groupChatSettings.showAvatar = !groupChatSettings.showAvatar;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var showNameToggle = document.getElementById('group-show-name-toggle');
    if (showNameToggle) {
        showNameToggle.addEventListener('click', function() {
            groupChatSettings.showName = !groupChatSettings.showName;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var closeGroupChat = document.getElementById('close-group-chat');
    if (closeGroupChat) {
        closeGroupChat.addEventListener('click', function() {
            var m = document.getElementById('group-chat-modal');
            if (m && typeof hideModal === 'function') hideModal(m);
        });
    }
    setTimeout(updateGroupModeUI, 200);
});

window.openAddGroupMember = function() {
    _groupMemberAvatarDataUrl = null;
    document.getElementById('group-member-edit-title').textContent = 'Ê∑ªÂä†ÊàêÂëò';
    document.getElementById('group-member-name-input').value = '';
    document.getElementById('group-member-edit-index').value = '';
    var preview = document.getElementById('group-member-avatar-preview');
    preview.innerHTML = '<i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>';
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof showModal === 'function') showModal(m);
};

window.openEditGroupMember = function(idx) {
    var member = groupChatSettings.members[idx];
    if (!member) return;
    _groupMemberAvatarDataUrl = member.avatar || null;
    document.getElementById('group-member-edit-title').textContent = 'ÁºñËæëÊàêÂëò';
    document.getElementById('group-member-name-input').value = member.name || '';
    document.getElementById('group-member-edit-index').value = idx;
    var preview = document.getElementById('group-member-avatar-preview');
    if (member.avatar) {
        preview.innerHTML = '<img src="' + member.avatar + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    } else {
        preview.innerHTML = '<i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>';
    }
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof showModal === 'function') showModal(m);
};

window.closeGroupMemberEdit = function() {
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof hideModal === 'function') hideModal(m);
};

window.previewGroupMemberAvatar = function(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        _groupMemberAvatarDataUrl = e.target.result;
        var preview = document.getElementById('group-member-avatar-preview');
        preview.innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    };
    reader.readAsDataURL(file);
};

window.saveGroupMember = function() {
    var name = (document.getElementById('group-member-name-input').value || '').trim();
    if (!name) { alert('ËØ∑ËæìÂÖ•ÊàêÂëòÂêçÂ≠ó'); return; }
    var idxVal = document.getElementById('group-member-edit-index').value;
    var member = { name: name, avatar: _groupMemberAvatarDataUrl };
    if (idxVal !== '') {
        groupChatSettings.members[parseInt(idxVal)] = member;
    } else {
        if (!groupChatSettings.members) groupChatSettings.members = [];
        groupChatSettings.members.push(member);
    }
    saveGroupChatSettings();
    renderGroupMembersList();
    window.closeGroupMemberEdit();
};

window.deleteGroupMember = function(idx) {
    if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•ÊàêÂëòÂêóÔºü')) return;
    groupChatSettings.members.splice(idx, 1);
    saveGroupChatSettings();
    renderGroupMembersList();
};

window.getGroupMemberForMessage = function(msgId) {
    if (!groupChatSettings.enabled || !groupChatSettings.members || groupChatSettings.members.length === 0) return null;
    var seed = 0;
    var idStr = String(msgId);
    for (var i = 0; i < idStr.length; i++) seed += idStr.charCodeAt(i) * (i + 1);
    return groupChatSettings.members[seed % groupChatSettings.members.length];
};

document.addEventListener('DOMContentLoaded', function() {
    var exportAllBtn = document.getElementById('export-all-settings');
    var importAllBtn = document.getElementById('import-all-settings');
    if (exportAllBtn) {
        exportAllBtn.addEventListener('click', async function() {
            try {
                var backup = { version: 2, type: 'full-backup', timestamp: new Date().toISOString() };
                var lsData = {};
                for (var i = 0; i < localStorage.length; i++) {
                    var k = localStorage.key(i);
                    lsData[k] = localStorage.getItem(k);
                }
                backup.localStorage = lsData;
                if (window.localforage) {
                    if (typeof showNotification === 'function') showNotification('Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫ÔºåËØ∑Á®çÂÄô...', 'info');
                    var lfData = {};
                    var keys = await localforage.keys();

                    async function serializeValue(val) {
                        if (val === null || val === undefined) return { __type: 'null', value: null };
                        if (val instanceof Blob) {
                            return new Promise((res, rej) => {
                                const reader = new FileReader();
                                reader.onload = () => res({ __type: 'Blob', mimeType: val.type, value: reader.result });
                                reader.onerror = rej;
                                reader.readAsDataURL(val);
                            });
                        }
                        if (val instanceof ArrayBuffer) {
                            const uint8 = new Uint8Array(val);
                            let binary = '';
                            for (let b = 0; b < uint8.length; b++) binary += String.fromCharCode(uint8[b]);
                            return { __type: 'ArrayBuffer', value: btoa(binary) };
                        }
                        if (Array.isArray(val)) {
                            const arr = [];
                            for (const item of val) arr.push(await serializeValue(item));
                            return { __type: 'Array', value: arr };
                        }
                        if (val && typeof val === 'object' && !(val instanceof Date)) {
                            const obj = {};
                            for (const [k2, v2] of Object.entries(val)) obj[k2] = await serializeValue(v2);
                            return { __type: 'Object', value: obj };
                        }
                        return { __type: 'primitive', value: val };
                    }

                    for (var ki = 0; ki < keys.length; ki++) {
                        try {
                            const rawVal = await localforage.getItem(keys[ki]);
                            lfData[keys[ki]] = await serializeValue(rawVal);
                        } catch(e) { console.warn('Â∫èÂàóÂåñÈîÆÂ§±Ë¥•:', keys[ki], e); }
                    }
                    backup.localforage = lfData;
                    backup.lfSerialized = true;
                }
                var dataStr = JSON.stringify(backup);
                var blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'full-backup-' + new Date().toISOString().slice(0,10) + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                if (typeof showNotification === 'function') showNotification('ÂÖ®ÈáèÂ§á‰ªΩÂØºÂá∫ÊàêÂäü', 'success');
            } catch(e) {
                console.error('ÂÖ®ÈáèÂ§á‰ªΩÂØºÂá∫Â§±Ë¥•:', e);
                if (typeof showNotification === 'function') showNotification('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        });
    }
    if (importAllBtn) {
        importAllBtn.addEventListener('click', function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = async function(ev) {
                    try {
                        var backup = JSON.parse(ev.target.result);
                        if (backup.type !== 'full-backup') throw new Error('‰∏çÊòØÂÖ®ÈáèÂ§á‰ªΩÊñá‰ª∂');
                        if (!confirm('ÂØºÂÖ•ÂÖ®ÈáèÂ§á‰ªΩÂ∞ÜË¶ÜÁõñÊâÄÊúâÂΩìÂâçÊï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü')) return;
                        if (backup.localStorage) {
                            for (var k in backup.localStorage) {
                                localStorage.setItem(k, backup.localStorage[k]);
                            }
                        }
                        if (window.localforage && backup.localforage) {
                            function deserializeValue(wrapped) {
                                if (!wrapped || typeof wrapped !== 'object') return wrapped;
                                const t = wrapped.__type;
                                if (t === 'null') return null;
                                if (t === 'primitive') return wrapped.value;
                                if (t === 'ArrayBuffer') {
                                    const binary = atob(wrapped.value);
                                    const buf = new ArrayBuffer(binary.length);
                                    const view = new Uint8Array(buf);
                                    for (let i2 = 0; i2 < binary.length; i2++) view[i2] = binary.charCodeAt(i2);
                                    return buf;
                                }
                                if (t === 'Blob') {
                                    const dataUrl = wrapped.value;
                                    const base64 = dataUrl.split(',')[1];
                                    const binary = atob(base64);
                                    const buf = new ArrayBuffer(binary.length);
                                    const view = new Uint8Array(buf);
                                    for (let i2 = 0; i2 < binary.length; i2++) view[i2] = binary.charCodeAt(i2);
                                    return new Blob([buf], { type: wrapped.mimeType || 'application/octet-stream' });
                                }
                                if (t === 'Array') return wrapped.value.map(deserializeValue);
                                if (t === 'Object') {
                                    const obj = {};
                                    for (const [k2, v2] of Object.entries(wrapped.value)) obj[k2] = deserializeValue(v2);
                                    return obj;
                                }
                                return wrapped.value !== undefined ? wrapped.value : wrapped;
                            }
                            for (var lk in backup.localforage) {
                                try {
                                    const val = backup.lfSerialized ? deserializeValue(backup.localforage[lk]) : backup.localforage[lk];
                                    await localforage.setItem(lk, val);
                                } catch(e) { console.warn('ÊÅ¢Â§çÈîÆÂ§±Ë¥•:', lk, e); }
                            }
                        }
                        if (typeof showNotification === 'function') showNotification('ÂÖ®ÈáèÂ§á‰ªΩÊÅ¢Â§çÊàêÂäüÔºåÂç≥Â∞ÜÂà∑Êñ∞È°µÈù¢', 'success');
                        setTimeout(function() { location.reload(); }, 1500);
                    } catch(e) {
                        if (typeof showNotification === 'function') showNotification('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºö' + e.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        });
    }
});

window.startEditDgWeather = function(el) {
    var current = el.textContent.trim();
    var input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.maxLength = 20;
    input.style.cssText = 'width:120px;padding:2px 6px;border:1px solid var(--accent-color);border-radius:6px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;';
    el.style.display = 'none';
    el.parentNode.insertBefore(input, el.nextSibling);
    input.focus();
    input.select();
    function saveWeather() {
        var val = input.value.trim() || current;
        el.textContent = val;
        el.style.display = '';
        input.remove();
        var now = new Date();
        var dateKey = 'customWeather_' + now.getFullYear() + '_' + (now.getMonth()+1) + '_' + now.getDate();
        localStorage.setItem(dateKey, val);
    }
    input.addEventListener('blur', saveWeather);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveWeather(); }
        if (e.key === 'Escape') { el.style.display = ''; input.remove(); }
    });
};

// ËÅöÁÑ¶Êó∂ÊªöÂä®Âà∞Â∫ï
    document.addEventListener('focusin', function(e) {
        if (e.target && (e.target.classList.contains('message-input') || e.target.tagName === 'TEXTAREA')) {
            setTimeout(function() {
                var chat = document.querySelector('.chat-container');
                if (chat) chat.scrollTop = chat.scrollHeight;
            }, 100);
        }
    });

window.addEventListener('load', function() {
    setTimeout(function() {
        try {
            if (localStorage.getItem('dailyGreetingShown') === new Date().toDateString()) return;
            try { if (typeof checkPartnerDailyMood === 'function') checkPartnerDailyMood(); } catch(e2) { console.warn('checkPartnerDailyMood error:', e2); }
            if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
            if (window.localforage && window.APP_PREFIX) {
                localforage.getItem(window.APP_PREFIX + 'tour_seen').then(function(seen) {
                    if (seen) {
                        var modal = document.getElementById('daily-greeting-modal');
                        if (modal) modal.classList.remove('hidden');
                        localStorage.setItem('dailyGreetingShown', new Date().toDateString());
                    }
                }).catch(function() {
                    var modal = document.getElementById('daily-greeting-modal');
                    if (modal) modal.classList.remove('hidden');
                    localStorage.setItem('dailyGreetingShown', new Date().toDateString());
                });
            } else {
                var modal = document.getElementById('daily-greeting-modal');
                if (modal) modal.classList.remove('hidden');
                localStorage.setItem('dailyGreetingShown', new Date().toDateString());
            }
        } catch(e) { console.warn('Daily greeting timing error:', e); }
    }, 4500);
}, { once: true });
</script>
</body>
</html>